<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="drivenotepad.css">
    <script type="text/javascript">
    "use strict";
    // Auth stuff gets top priority as it can take a while....
    var window_location_to_params_object = function(){
        // http://stackoverflow.com/a/2880929/2399799
        var match;
        var pl = /\+/g;  // Regex for replacing addition symbol with a space
        var search = /([^&=]+)=?([^&]*)/g;
        var decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); };
        var query  = window.location.search.substring(1);
        var url_params = {};
        while((match = search.exec(query)) !== null)
           url_params[decode(match[1])] = decode(match[2]);
        return url_params;
    }
    var dn = dn || {};
    dn.client_id = '591525900269-94ok9krafau8qa24666btvccmsfnq5fp.apps.googleusercontent.com';
    dn.scopes = [
      'https://www.googleapis.com/auth/drive.file',
      'https://www.googleapis.com/auth/userinfo.profile',
      'https://www.googleapis.com/auth/userinfo.email',
      'https://www.googleapis.com/auth/drive.appdata'
    ];
    dn.url_user_id = (function(){
        try{
            var params = window_location_to_params_object();
            return JSON.parse(params['state'])['userId'];
        }catch(e){return undefined}
    })();
    dn.auth_map = function(immeditate){
        var m = {
        'client_id': dn.client_id, 
        'scope': dn.scopes.join(' '),
        'immediate': immeditate};
        if (dn.url_user_id !== undefined){
            m['login_hint'] = dn.url_user_id;
            m['authuser'] = -1
        }
        return m;
    }

    // this is a promise-like object which can be resolved by calling
    // .resolve at any point after construction, with the 'then' callback
    // called as soon as both resolution and callback registration have
    // both occured.
    dn.pr_auth = (function(){
        var success_callback = null;
        var has_resolved = false;
        var value;
        return {
        then: function(succ){
                if(has_resolved)
                    succ(value);
                else
                    success_callback = succ;
              },
        resolve: function(val){
                if(success_callback){
                    success_callback(val);
                }else{
                    has_resolved = true;
                    value = val;
                }
              }
        }
    })();

    function gapi_loaded() {
        Promise.resolve(gapi.auth.authorize(dn.auth_map(true)))
            .then(dn.pr_auth.resolve);
    } 
    </script>
    <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=gapi_loaded"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/keymaster/1.6.1/keymaster.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ext-modelist.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ext-themelist.js"></script>
    <script type="text/javascript" src="utils.js"></script>    
    <script type="text/javascript" src="drop_down.js"></script>    
    <script type="text/javascript" src="info.js"></script>
    <script type="text/javascript" src="app.js"></script>
    <title>Drive Notepad</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">
</head>

<body class="noselect">
    <div id="the_widget" class="noselect" style="display:none;"> 
        <div id="widget_text">ex nihilo omnia</div>

        <div id='widget_menu'>
            <div class='widget_menu_wrapper' id='menu_file'></div>
            <div class='widget_menu_wrapper' id='menu_find'></div>
            <div class='widget_menu_wrapper' id='menu_open'></div>
            <div class='widget_menu_wrapper' id='menu_general_settings'></div>
            <div class='widget_menu_wrapper' id='menu_help'></div>
        </div>

        <div id="widget_content"> 
            <div class='widget_pane' style='display:none;' id='pane_???'></div>

            <div class='widget_pane' style='display:none;' id='pane_file'>
                <div class='pane_item details_file_title clickable'>
                    <div class='details_file_title_text' data-info='title' id='details_file_title_text'></div>
                    <input type='text' placeholder='title' class='details_file_title_input' id='details_file_title_input' style='display:none;'/>
                </div>
                <div class='pane_item details_file_description clickable'>
                    <div class='details_file_description_text' data-info='description' id='details_file_description_text'></div>
                    <textarea placeholder='description' class='details_file_description_input' id='details_file_description_input' style='display:none;'></textarea>
                </div>
                <div class='pane_spacer'></div>
                <div class='pane_item details_file_ace_mode'>
                    Syntax:
                    <div class='button inline_button' id='file_ace_mode_detect'>detect</div>
                    <div class='button inline_button dropdown_button' id='file_ace_mode_choose'></div>
                    <div class='file_info' id='file_ace_mode_info'></div>
                </div>
                <div class='pane_spacer'></div>
                <div class='pane_item details_file_newline'>
                    Newline:
                    <div class='button inline_button' id='file_newline_detect'>detect</div>
                    <div class='button inline_button' id='file_newline_windows'>windows</div>
                    <div class='button inline_button' id='file_newline_unix'>unix</div>
                    <div class='file_info' id='file_newline_info'></div>
                </div>
                <div class='pane_spacer'></div>
                <div class='pane_item details_file_tab'>
                    Tabs:
                    <div class='button inline_button' id='file_tab_detect'>detect</div>
                    <div class='button inline_button' id='file_tab_hard'>hard</div>
                    <div class='button inline_button' id='file_tab_soft'>
                        <span id='file_tab_soft_text'>??</span> spaces
                        <div class='button_up_down_wrapper'>
                            <div class='button_up' id='file_tab_soft_inc'>&nbsp;</div>
                            <div class='button_down' id='file_tab_soft_dec'>&nbsp;</div>
                        </div>
                    </div>
                    <div class='file_info' id='file_tab_info'></div>
                </div>
                <div class='widget_pane_bottom_before'></div>
                <div class='widget_pane_bottom'>
                    <div class='button icon' id='button_save'>
                        <div class='tooltip button_tooltip'>save file</div>
                    </div>
                    <div class='button icon' id='button_print'>
                        <div class='tooltip button_tooltip'>print...</div>
                    </div>
                    <div class='button icon' id='button_share'>
                        <div class='tooltip button_tooltip'>file share settings...</div>
                    </div>
                    <div class='button icon' id='button_history'>
                        <div class='tooltip button_tooltip'>history of changes...</div>
                    </div>           
                </div>
            </div>

            <div class='widget_pane' style='display:none;' id='pane_general_settings'>
                <div class='pane_item'>
                    Recent changes: 
                    <div class='button inline_button' id='gutter_history_hide'>hide</div>
                    <div class='button inline_button' id='gutter_history_show'>show</div>
                </div>
                <div class='pane_item'>
                    Word wrap:
                    <div class='button inline_button' id='word_wrap_off'>none</div>
                    <div class='button inline_button' id='word_wrap_at'>
                        at <span id='word_wrap_at_text'>??</span>
                        <div class='button_up_down_wrapper'>
                            <div class='button_up' id='word_wrap_at_inc'>&nbsp;</div>
                            <div class='button_down' id='word_wrap_at_dec'>&nbsp;</div>
                        </div>
                    </div>
                    <div class='button inline_button' id='word_wrap_edge'>edge</div>
                </div>
                <div class='pane_item'>
                    Tab default:
                    <div class='button inline_button' id='tab_hard'>hard</div>
                    <div class='button inline_button' id='tab_soft'>
                        <span id='tab_soft_text'>??</span> spaces
                        <div class='button_up_down_wrapper'>
                            <div class='button_up' id='tab_soft_inc'>&nbsp;</div>
                            <div class='button_down' id='tab_soft_dec'>&nbsp;</div>
                        </div>
                    </div>
                </div>  
                <div class='pane_item'>
                    Newline default:
                    <div class='button inline_button' id='newline_menu_windows'>windows</div>
                    <div class='button inline_button' id='newline_menu_unix'>unix</div>
                </div>
                <div class='pane_item'>
                    Font size:
                    <div class='button_like'><span id='font_size_text'>??</span> em
                        <div class='button_up_down_wrapper'>
                            <div class='button_up' id='font_size_increment'></div>
                            <div class='button_down' id='font_size_decrement'></div>
                        </div>
                    </div>
                </div>
                <div class='pane_item'>
                    Theme:
                    <div class='button inline_button dropdown_button no_select' id='theme_chooser'></div>
                </div>
                <div class='widget_pane_bottom_before'></div>
                <div class='widget_pane_bottom'>
                    <div class='button icon' id='button_clear_clipboard'>
                        <div class='tooltip button_tooltip'>clear clipboard history</div>
                    </div>
                    <div class='button icon' id='button_clear_find_replace'>
                        <div class='tooltip button_tooltip'>clear find/replace history</div>
                    </div>
                </div>
            </div>

            <div class='widget_pane' style='display:none;' id='pane_find'>
                <div class='pane_item'>
                    <input class='find_input' tabindex='1' placeholder='find text' id='find_input'></input>
                    <div class='replace_form' id='replace_form'>
                        <input tabindex='2' class='replace_input' id='replace_input' placeholder='replace with'></input>
                        <div class='find_replace_info' id='find_replace_info'></div>
                    </div>
                </div><br><br>
                <div class='pane_item'>
                    Go to: <input class='gotoline_input' id='goto_input' placeholder='line number'></input>
                </div>
            </div>

            <div class='widget_pane' style='display:none;' id='pane_help'>
                <div class='widget_box_title'>Drive Notepad 2016a, by DM.</div>
                <div class='pane_item clickable link_google'>google+ - for bug reports, questions, etc.*</div>
                <div class='pane_item clickable link_youtube'>youtube - quick demo</div>
                <div class='pane_item clickable link_about'>about - more information.</div><br><br>

                <div class='widget_box_title'>Logged in as <span id='user_name'>???</span></div>
                <div class='pane_item clickable link_drive'>Google Drive - open your Drive</div>
                <div class='widget_pane_bottom_before'></div>
                <div class='widget_pane_bottom'>*positive feedback is always appriciated!</div>
            </div>

            <div class='widget_pane' style='display:none;' id='pane_open'>
                <div class='pane_item'>Open an existing file in:<br><br>
                    <div class='button_wrapper'>
                        <div class='button'id='opener_button_a'>this tab</div>
                        <div class='button' id='opener_button_b'>a new tab</div></div><br>
                    </div><br>
                <div class='pane_item'>Create a new file in:<br><br>
                    <div class='button_wrapper'>
                        <div class='button' id='opener_button_c'>this tab</div>
                        <div class='button' id='opener_button_d'>a new tab</div>
                    </div><br>
                </div>
            </div>

            <div class='widget_pane' style='display:none;' id='pane_first_time_info'>
                <div class='widget_box_title widget_firsttime_title'>First-time usage tips</div>
                You can move this thing by dragging the top part.<br><br>
                To access the menu click the status text above or use the shortcut key, Esc<br><br>
                Changes are not saved as you type, you have to press save in the menu or use the shortcut key,
                <span class='ctrl_key'>ctrl</span>-s.
                <br><br><div class='button_wrapper'><div class='button' id='first_time_dissmiss'>Dismiss</div></div>
            </div>

            <div class='widget_pane' style='display:none;' id='pane_permissions'>
                <br><div class='button_wrapper'>
                    <div class='button' id='button_auth'>Autherize...</div>
                </div><br><br>
                Click the button above to launch a popup window and login to your Google account and/or grant permisions to this app.<br><br>
                This step will not normally be required when you use the app.<br><br>If you do not see a popup window when you click the button you may
                need to disable your popup blocker and reload the page.
            </div>

            <div class='widget_pane' style='display:none;' id='pane_clipboard'>
                When you paste with <span class='ctrl_key'>ctrl</span>-v you can cycle through your Drive Notepad clipboard
                by pressing 'left' or 'right' before releaing the <span class='ctrl_key'>ctrl</span> key. <br><br>
                You can clear your clipboard history by clicking the relevant button in the settings menu.
            </div>

        </div>

        <div id="widget_error">
            <div id="widget_error_mark">&#x2718;</div><div id="widget_error_text"></div>
        </div>

    </div>

    <div id="the_editor"> </div>
</body>
</html>