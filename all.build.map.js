{"version":3,"sources":["node_modules/keymaster/keymaster.js","js/utils.js","js/drop_down.js","js/info.js","js/file_model.js","js/settings_pane.js","js/using_apis.js","js/save.js","js/print.js","js/file_pane.js","js/revisions_main_thread.js","js/find_pane.js","js/keyboard.js","js/app.js"],"names":["global","k","_handlers","_mods",16,18,17,91,"_scope","_MODIFIERS","⇧","shift","⌥","alt","option","⌃","ctrl","control","⌘","command","_MAP","backspace","tab","clear","enter","return","esc","escape","space","left","up","right","down","del","delete","home","end","pageup","pagedown",",",".","/","`","-","=",";","'","[","]","\\","code","x","toUpperCase","charCodeAt","_downKeys","index","array","item","i","length","compareArray","a1","a2","modifierMap","updateModifierKey","event","dispatch","key","handler","modifiersMatch","scope","keyCode","push","assignKey","filter","call","this","getScope","mods","method","preventDefault","returnValue","stopPropagation","cancelBubble","clearModifier","splice","resetModifiers","keys","getKeys","undefined","split","getMods","shortcut","unbindKey","multipleKeys","j","obj","isPressed","getPressedKeyCodes","slice","tagName","target","srcElement","setScope","deleteScope","handlers","replace","mi","addEvent","object","addEventListener","attachEvent","window","document","previousKey","noConflict","unbind","module","exports","oxford_comma","arr","rotate","el","deg","style","transform","webkitTansform","mozTransform","translate","y","str","webkitTransform","text_multi","text","truncate_long_words","textContent","innerHTML","escape_str","css_animation","timers","els","cls","callback","delay","classList","remove","offsetTop","old_idx","indexOf","clearTimeout","setTimeout","add","stop_propagation","e","prevent_default","until_success","executor","on_error","Promise","success","rejection_handler","err","then","DropDown","val_array","map","val","join","el_list","createElement","className","tabindex","display","el_collapsed","appendChild","ind","event_callbacks","open","dd","document_mousedown","trigger","removeEventListener","parentNode","focus","scrollTop","children","on_click","SetInd","getAttribute","ii","setAttribute","FakeEvent","is_stopped","prototype","stopImmediatePropagation","evt","func","args","fe","IndexOf","GetVal","no_trigger","parseInt","title","isOpen","SetSelected","v","dn","menu_id_to_caption","menu_print","menu_sharing","menu_save","menu_history","menu_file","menu_new","menu_open","menu_find","menu_goto","menu_general_settings","menu_shortcuts","menu_drive","menu_help","shortcuts_list","ext_to_mime_type","html","htm","js","pl","xml","c","cpp","h","json","php","svg","css","java","py","scala","textile","tex","bib","rtf","rtx","sh","sql","as","tooltip_info","save","print","sharing","file history","drive","about","shortcuts","new","settings_file","settings_general","description","WHICH","ENTER","ESC","UP","DOWN","default_settings","ext","wordWrap","wordWrapAt","fontSize","widget_anchor","showGutterHistory","lastDNVersionUsed","newLineDefault","historyRemovedIsExpanded","softTabN","tabIsHard","widgetSub","theme","pane","pane_open","find_regex","find_whole_words","find_case_sensitive","help_inner","find_goto","find_replace","impersonal_settings_keys","const","drag_delay_ms","drag_shift_px","min_font_size","max_font_size","max_wrap_at","min_wrap_at","wrap_at_increment","max_soft_tab_n","min_soft_tab_n","detect_tabs_spaces_frac","detect_tabs_tabs_frac","detect_tabs_n_spaces_frac","detect_tabs_n_spaces_frac_for_default","font_size_increment","error_delay_ms","find_history_add_delay","clipboard_info_delay","clipboard_max_length","find_max_results_half","find_max_prefix_chars","find_max_suffix_chars","FileModel","is_loaded","file_id","folder_id","loaded_body","is_read_only","is_shared","properties_chosen","properties","properties_detected_info","change_callbacks","kind","ob","set","syntax","compute_syntax","newline","compute_newline","tabs","n","compute_tabs","property","first_n","g_settings","get","has_rn","has_solo_n","match","all_modes","require","modes","caption","detected","getModeForPath","re_whitepace","prop","JSON","parse","indents","n_only_tabs","n_only_space","space_hist","n_with_mixture","n_samp","Math","min","indents_ii","without_tabs","space_mod_hist","ss","m","settings_pane","theme_drop_down","on_document_ready","theme_chooser","getElementById","button_clear_clipboard","button_clear_find_replace","gutter_history_show","gutter_history_hide","word_wrap_off","word_wrap_at","word_wrap_edge","font_size_dec","font_size_inc","font_size_text","tab_hard","tab_soft","newline_windows","newline_unix","tab_soft_text","tab_soft_dec","tab_soft_inc","word_wrap_at_text","word_wrap_at_dec","word_wrap_at_inc","on_change","themes","Object","themesByName","focus_editor","at","font_size_dec_click","font_size_inc_click","g_clipboard","g_find_history","font_size","new_value","newValue","s","editor","getSession","scrollLine","get_scroll_line","toFixed","is_auth_error","type","status","result","error","console","log","dir","handle_auth_error","authorization","popup_active","show_status","err_type","message","show_error","reauth_auto","toggle_permission","reauth_auto_delay_chain",0,1,500,1000,2500,5000,10000,60000,"reauth_auto_timer","reauth_auto_delay","gapi","auth","authorize","auth_map","pr_auth","resolve","bind","reject","reauth_manual","request_user_info","client","request","path","request_file_meta","the_file","params","fields","request_file_body","make_multipart_boundary","Date","getTime","random","request_new","folderId","meta","name","body","stringify","request_save","parts","has_body","has_meta","is_multipart","headers","boundary","request_body","request_app_data_document","succ","fail","app_data_realtime_error","realtime_settings","realtime","loadAppDataDocument","request_screw_up_auth_counter","request_screw_up_auth","setToken","save_pending_requests","SaveTracker","local","remote","save_local_version_counter","save_server_state","save_local_state","idx","save_body","save_title","save_other","SaveRequest","_parts","displaced_requests","hasOwnProperty","_is_settled","desired","_desired","_tracker","_error","self","_pr","all","pr_file_loaded","_throw_if_not_desired","_on_completion","catch","_on_error","_on_finally","res","version","pop","correction","correction_need","do_print","line_to_html","printLayer","create","ace","Text","tokens","getTokens","screenColumn","token","value","$renderToken","content","session","doc","getAllLines","Array","printWindow","writeln","cssText","file_pane","do_save","getValue","read_only_bail","on_title_begin_edit","title_text","title_input","select","on_title_keydown","which","on_description_begin_edit","description_text","description_input","on_description_keydown","ctrlKey","shiftKey","do_share","pr_the_file_loaded","file_sharing","share_dialog","do_share_sub","load","share","ShareClient","client_id","setItemIds","setOAuthToken","getToken","access_token","showSettingsDialog","on_description_end_edit","new_val","on_title_end_edit","on_newline_click","currentTarget","on_syntax_detect_click","on_syntax_dropdown_click","syntax_drop_down","on_tab_click","render_title","title_text_inner","render_description","description_text_inner","render_newline","newline_detect","newline_info","render_syntax","ace_mode_detect","ace_mode_info","render_tabs","user_tabs","tab_detect","tab_info","ace_mode_choose","button_save","button_print","button_share","button_history","on_save_shorcut","on_print_shortcut","close_history","file_history","$revisions_display","revisions_window_resize","resize","is_showing_history","canShowResizeError","start_revisions_worker","is_brand_new","widget_content","widget_file_history","getElementsByClassName","$","$view","$new_li","$new_tick","needToRefindViewChildren","$rev_lines_","needToFixHeights","$timeline","$d","find","$revisions_status","$revision_caption_from","$revision_caption_at","$expand_removed","$collapse_removed","revisions","revisionFromEtag","from","worker","Worker","revision_setis_expaned","w","onmessage","revision_worker_delivery","postMessage","fileId","init","appendTo","on","empty","revision_set_at","r","fromChangeEvent","fromTimelineCreation","$at_range","modifiedDate","toLocaleDateString","month","day","year","toLocaleTimeString","hour","minute","showEtag","etag","fromEtag","revision_set_from","$from_range","display_revision_timeline","newRevisions","rs","$tick_box","attr","t","downloaded","isDownloaded","apply","$ticks","insertClonedChildren","eq","append","data","debug","forEach","revisionDownloaded","revsionDiffed","isDiffed","newStuff","newStuffForDom","lines","vals_ui8buffer","$rl_","fixHeightFromAuto","vals","Uint8Array","digits","find_pane","const_","goto_input_has_focus","AceSearch","AceRange","search_inputs_have_focus","search_results","search_current_match_idx","search_markers","search_marker_current","search_str","focus_on_input","goto_input","find_input","Search","Range","button_case_sensitive","button_whole_words","button_regex","replace_input","info","info_overflow","button_goto","button_replace","goto_wrapper","find_wrapper","replace_wrapper","button_find_replace_all","settings_changed","on_replace_toggled","on_goto_toggled","goto_input_keydown","goto_input_keyup","goto_input_blur","goto_input_focus","find_input_keyup","find_input_keydown","search_inputs_blur","search_inputs_focus","replace_input_keydown","replace_all","find_shortcut_used","sel","getTextRange","getSelectionRange","goto_shortcut_used","replace_shortcut_used","select_search_result_idx","perform_goto","relatedTarget","validated_str","num","gotoLine","navigateLineEnd","tabIndex","setHighlightSelectedWord","perform_search","removeMarker","setSelectionRange","selectionEnd","build_search_options","use_reg_exp","sensitive","re","RegExp","needle","wrap","caseSensitive","wholeWord","regExp","search_options","selection","clearSelection","search","setOptions","findAll","selected_range","getSelection","getRange","row","start","column","current_match_idx","addMarker","range","new_idx","search_results_sub","replace_is_showing","max_search_results","n_pre","n_post","concat","show_replace_buttons","col","prefix_range","max","pre_ellipses","suffix_range","search_result_click","search_replace_result_click","renderer","scrollSelectionIntoView","replace_result_idx","options","replaceAll","$search","$tryReplace","on_find_shortcut","on_replace_shortcut","on_goto_shortcut","platform","navigator","create_pane_shortcuts","arry","dict","action","pane_help_shortcuts","esc_pressed","make_keyboard_shortcuts","commands","removeCommands","do_print_shorcut","do_open","do_new","HashHandler","extraKeyEvents","bindKey","win","mac","descr","exec","document_clipboard_left","document_clipboard_right","keyBinding","addKeyboardHandler","ctrl_key","version_str","can_show_drag_drop_error","file_body","file_meta","file_new","authentication","local_settings","unsaved_changes","change_line_history","last_change","change_line_classes","rootStr","trueN","factor","change_line_classes_rm","show_user_info","a","user_info","user_name","set_editor_newline","setNewLineMode","open_button_click","view","google","picker","View","ViewId","DOCS","open_picker","PickerBuilder","enableFeature","Feature","NAV_HIDDEN","setAppId","addView","setCallback","picker_callback","build","setVisible","Action","PICKED","docs","id","url","userId","url_user_id","ids","location","open_new_tab","close","show_help_inner","inner_pane","pane_help_tips","pane_help_main","button_shortcuts","button_tips","state","pane_permissions","permissions_showing","the_widget","show_pane","el_icon","menu_icon_from_pane_id","widget_mouse_down","widget_mouse_down_info","off_left","clientX","off_top","clientY","start_time","now","is_dragging","button","document_mouse_move_widget","document_mouse_up_widget","pos","getBoundingClientRect","widget_w","offsetWidth","widget_h","offsetHeight","window_w","innerWidth","window_h","innerHeight","anchor","top","widget_apply_anchor","isArray","widget_menu","bottom","toggle_widget","extra","widget_text","widget_pending","widget_error_text","widget_error","set_drive_link_to_folder","href","show_app_data_document","old_temp_g_settings","getModel","getRoot","transfer_all_listeners","existing_cloud_keys","get_keeps","createList","keeps","change_listeners","keep","flag","real_model","EventType","VALUE_CHANGED","load_default_settings","localStorage","setTheme","setFontSize","scrollToLine","setUseWrapMode","setWrapLimitRange","curWrap","setPrintMarginColumn","removeGutterDecoration","screenToDocumentPosition","getScrollTopRow","clipboard_active","clipboard_index","undo","insert","document_clipboard_keyup","off","pane_clipboard","clipboard_info_timer","on_paste","lastIndexOf","on_copy","show_file_meta","resp","Error","capabilities","canEdit","shared","aceMode","parents","history","replaceState","host","pathname","show_file_body","setting_session_value","setValue","render_document_title","nClasses","start_row","end_row","addGutterDecoration","newLineCount","query_unload","set_editor_tabs","setUseSoftTabs","setTabSize","set_editor_syntax","mode_str","modes_array","setMode","mode","document_drag_over","originalEvent","dataTransfer","dropEffect","document_drop_file","files","file","create_file","isReading_file_object","FileReader","onload","dropped_file_read","readAsText","document_ready","getElementsByTagName","editor_el","edit","ace_content","setAnimatedScroll","$blockScrolling","Infinity","substr","pane_file","pane_general_settings","pane_help","pane_find","opener_button_a","onbeforeunload","window_location_to_params_object","new_in_folder","SpecialPromise","on_success","pr_meta","pr_body","pr_realtime_loaded","readyState"],"mappings":"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","file":"all.build.js","sourcesContent":["//     keymaster.js\n//     (c) 2011-2013 Thomas Fuchs\n//     keymaster.js may be freely distributed under the MIT license.\n\n;(function(global){\n  var k,\n    _handlers = {},\n    _mods = { 16: false, 18: false, 17: false, 91: false },\n    _scope = 'all',\n    // modifier keys\n    _MODIFIERS = {\n      '⇧': 16, shift: 16,\n      '⌥': 18, alt: 18, option: 18,\n      '⌃': 17, ctrl: 17, control: 17,\n      '⌘': 91, command: 91\n    },\n    // special keys\n    _MAP = {\n      backspace: 8, tab: 9, clear: 12,\n      enter: 13, 'return': 13,\n      esc: 27, escape: 27, space: 32,\n      left: 37, up: 38,\n      right: 39, down: 40,\n      del: 46, 'delete': 46,\n      home: 36, end: 35,\n      pageup: 33, pagedown: 34,\n      ',': 188, '.': 190, '/': 191,\n      '`': 192, '-': 189, '=': 187,\n      ';': 186, '\\'': 222,\n      '[': 219, ']': 221, '\\\\': 220\n    },\n    code = function(x){\n      return _MAP[x] || x.toUpperCase().charCodeAt(0);\n    },\n    _downKeys = [];\n\n  for(k=1;k<20;k++) _MAP['f'+k] = 111+k;\n\n  // IE doesn't support Array#indexOf, so have a simple replacement\n  function index(array, item){\n    var i = array.length;\n    while(i--) if(array[i]===item) return i;\n    return -1;\n  }\n\n  // for comparing mods before unassignment\n  function compareArray(a1, a2) {\n    if (a1.length != a2.length) return false;\n    for (var i = 0; i < a1.length; i++) {\n        if (a1[i] !== a2[i]) return false;\n    }\n    return true;\n  }\n\n  var modifierMap = {\n      16:'shiftKey',\n      18:'altKey',\n      17:'ctrlKey',\n      91:'metaKey'\n  };\n  function updateModifierKey(event) {\n      for(k in _mods) _mods[k] = event[modifierMap[k]];\n  };\n\n  // handle keydown event\n  function dispatch(event) {\n    var key, handler, k, i, modifiersMatch, scope;\n    key = event.keyCode;\n\n    if (index(_downKeys, key) == -1) {\n        _downKeys.push(key);\n    }\n\n    // if a modifier key, set the key.<modifierkeyname> property to true and return\n    if(key == 93 || key == 224) key = 91; // right command on webkit, command on Gecko\n    if(key in _mods) {\n      _mods[key] = true;\n      // 'assignKey' from inside this closure is exported to window.key\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = true;\n      return;\n    }\n    updateModifierKey(event);\n\n    // see if we need to ignore the keypress (filter() can can be overridden)\n    // by default ignore key presses if a select, textarea, or input is focused\n    if(!assignKey.filter.call(this, event)) return;\n\n    // abort if no potentially matching shortcuts found\n    if (!(key in _handlers)) return;\n\n    scope = getScope();\n\n    // for each potential shortcut\n    for (i = 0; i < _handlers[key].length; i++) {\n      handler = _handlers[key][i];\n\n      // see if it's in the current scope\n      if(handler.scope == scope || handler.scope == 'all'){\n        // check if modifiers match if any\n        modifiersMatch = handler.mods.length > 0;\n        for(k in _mods)\n          if((!_mods[k] && index(handler.mods, +k) > -1) ||\n            (_mods[k] && index(handler.mods, +k) == -1)) modifiersMatch = false;\n        // call the handler and stop the event if neccessary\n        if((handler.mods.length == 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91]) || modifiersMatch){\n          if(handler.method(event, handler)===false){\n            if(event.preventDefault) event.preventDefault();\n              else event.returnValue = false;\n            if(event.stopPropagation) event.stopPropagation();\n            if(event.cancelBubble) event.cancelBubble = true;\n          }\n        }\n      }\n    }\n  };\n\n  // unset modifier keys on keyup\n  function clearModifier(event){\n    var key = event.keyCode, k,\n        i = index(_downKeys, key);\n\n    // remove key from _downKeys\n    if (i >= 0) {\n        _downKeys.splice(i, 1);\n    }\n\n    if(key == 93 || key == 224) key = 91;\n    if(key in _mods) {\n      _mods[key] = false;\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = false;\n    }\n  };\n\n  function resetModifiers() {\n    for(k in _mods) _mods[k] = false;\n    for(k in _MODIFIERS) assignKey[k] = false;\n  };\n\n  // parse and assign shortcut\n  function assignKey(key, scope, method){\n    var keys, mods;\n    keys = getKeys(key);\n    if (method === undefined) {\n      method = scope;\n      scope = 'all';\n    }\n\n    // for each shortcut\n    for (var i = 0; i < keys.length; i++) {\n      // set modifier keys if any\n      mods = [];\n      key = keys[i].split('+');\n      if (key.length > 1){\n        mods = getMods(key);\n        key = [key[key.length-1]];\n      }\n      // convert to keycode and...\n      key = key[0]\n      key = code(key);\n      // ...store handler\n      if (!(key in _handlers)) _handlers[key] = [];\n      _handlers[key].push({ shortcut: keys[i], scope: scope, method: method, key: keys[i], mods: mods });\n    }\n  };\n\n  // unbind all handlers for given key in current scope\n  function unbindKey(key, scope) {\n    var multipleKeys, keys,\n      mods = [],\n      i, j, obj;\n\n    multipleKeys = getKeys(key);\n\n    for (j = 0; j < multipleKeys.length; j++) {\n      keys = multipleKeys[j].split('+');\n\n      if (keys.length > 1) {\n        mods = getMods(keys);\n        key = keys[keys.length - 1];\n      }\n\n      key = code(key);\n\n      if (scope === undefined) {\n        scope = getScope();\n      }\n      if (!_handlers[key]) {\n        return;\n      }\n      for (i = 0; i < _handlers[key].length; i++) {\n        obj = _handlers[key][i];\n        // only clear handlers if correct scope and mods match\n        if (obj.scope === scope && compareArray(obj.mods, mods)) {\n          _handlers[key][i] = {};\n        }\n      }\n    }\n  };\n\n  // Returns true if the key with code 'keyCode' is currently down\n  // Converts strings into key codes.\n  function isPressed(keyCode) {\n      if (typeof(keyCode)=='string') {\n        keyCode = code(keyCode);\n      }\n      return index(_downKeys, keyCode) != -1;\n  }\n\n  function getPressedKeyCodes() {\n      return _downKeys.slice(0);\n  }\n\n  function filter(event){\n    var tagName = (event.target || event.srcElement).tagName;\n    // ignore keypressed in any elements that support keyboard data input\n    return !(tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA');\n  }\n\n  // initialize key.<modifier> to false\n  for(k in _MODIFIERS) assignKey[k] = false;\n\n  // set current scope (default 'all')\n  function setScope(scope){ _scope = scope || 'all' };\n  function getScope(){ return _scope || 'all' };\n\n  // delete all handlers for a given scope\n  function deleteScope(scope){\n    var key, handlers, i;\n\n    for (key in _handlers) {\n      handlers = _handlers[key];\n      for (i = 0; i < handlers.length; ) {\n        if (handlers[i].scope === scope) handlers.splice(i, 1);\n        else i++;\n      }\n    }\n  };\n\n  // abstract key logic for assign and unassign\n  function getKeys(key) {\n    var keys;\n    key = key.replace(/\\s/g, '');\n    keys = key.split(',');\n    if ((keys[keys.length - 1]) == '') {\n      keys[keys.length - 2] += ',';\n    }\n    return keys;\n  }\n\n  // abstract mods logic for assign and unassign\n  function getMods(key) {\n    var mods = key.slice(0, key.length - 1);\n    for (var mi = 0; mi < mods.length; mi++)\n    mods[mi] = _MODIFIERS[mods[mi]];\n    return mods;\n  }\n\n  // cross-browser events\n  function addEvent(object, event, method) {\n    if (object.addEventListener)\n      object.addEventListener(event, method, false);\n    else if(object.attachEvent)\n      object.attachEvent('on'+event, function(){ method(window.event) });\n  };\n\n  // set the handlers globally on document\n  addEvent(document, 'keydown', function(event) { dispatch(event) }); // Passing _scope to a callback to ensure it remains the same by execution. Fixes #48\n  addEvent(document, 'keyup', clearModifier);\n\n  // reset modifiers to false whenever the window is (re)focused.\n  addEvent(window, 'focus', resetModifiers);\n\n  // store previously defined key\n  var previousKey = global.key;\n\n  // restore previously defined key and return reference to our key object\n  function noConflict() {\n    var k = global.key;\n    global.key = previousKey;\n    return k;\n  }\n\n  // set window.key and window.key.set/get/deleteScope, and the default filter\n  global.key = assignKey;\n  global.key.setScope = setScope;\n  global.key.getScope = getScope;\n  global.key.deleteScope = deleteScope;\n  global.key.filter = filter;\n  global.key.isPressed = isPressed;\n  global.key.getPressedKeyCodes = getPressedKeyCodes;\n  global.key.noConflict = noConflict;\n  global.key.unbind = unbindKey;\n\n  if(typeof module !== 'undefined') module.exports = assignKey;\n\n})(this);\n","\"use strict\";\r\n\r\nvar oxford_comma = function(arr){\r\n    switch (arr.length){\r\n        case 1:\r\n            return arr[0];\r\n        case 2:\r\n            return arr[0] + \" and \" + arr[1];\r\n        case 3:\r\n            return arr[0] + \", \" + arr[1] + \", and \" + arr[2];\r\n    }\r\n}\r\n\r\nvar rotate = function(el, deg){\r\n    el.style.transform = \"rotate(\" + deg + 'deg)';\r\n    el.style.webkitTansform = \"rotate(\" + deg + 'deg)';\r\n    el.style.mozTransform = \"rotate(\" + deg + 'deg)';\r\n}\r\n\r\nvar translate = function(el, x, y){\r\n    var str = x==null ? \"\" : \"translate(\" + x + \"px,\" + y + \"px)\";\r\n    el.style.transform = str;\r\n    el.style.webkitTransform = str;\r\n    el.style.mozTransform = str;\r\n}\r\n\r\nvar text_multi = function(el, text, truncate_long_words){\r\n    if(truncate_long_words){\r\n        text = text.replace(/(\\S{25})\\S*/g,'$1...'); \r\n    }\r\n    el.textContent = text;  \r\n    el.innerHTML = el.innerHTML.replace(/\\n/g,'<br/>').replace(/\\t/g,'&nbsp;&nbsp;&nbsp; ');\r\n}\r\n\r\nvar escape_str = function(str){\r\n    // http://stackoverflow.com/a/18750001/2399799\r\n    return str.replace(/[\\u00A0-\\u9999<>\\&]/g, function(i) {\r\n        return '&#' + i.charCodeAt(0) + ';';\r\n    });\r\n}\r\n\r\nvar css_animation = (function(){\r\n    var timers = []; // we store timers and matching els so we can cancel if needed\r\n    var els = [];\r\n\r\n    return function(el, cls, callback, delay){\r\n        el.classList.remove(cls);\r\n        el.offsetTop; //forces class to be removed, so we can actually re-add it.\r\n        var old_idx = els.indexOf(el);\r\n        if(old_idx != -1){\r\n            clearTimeout(timers[old_idx]);\r\n            timers.splice(old_idx, 1);\r\n            els.splice(old_idx, 1);\r\n        }\r\n        els.push(el);\r\n        timers.push(setTimeout(callback, delay)); //this is better than trying to use the endtransition event\r\n        el.classList.add(cls);\r\n    }\r\n})();\r\n\r\nvar stop_propagation = function(e){\r\n    e.stopPropagation();\r\n}\r\n\r\nvar prevent_default = function(e){\r\n    e.preventDefault();  \r\n}\r\n\r\nfunction until_success(executor, on_error){\r\n    // This was confusing to write, so when I finished I turned it into a S.O. answer:\r\n    //      http://stackoverflow.com/a/35782428/2399799\r\n    return new Promise(function(success){\r\n        var rejection_handler = function(err){\r\n            on_error(err);\r\n            return new Promise(executor).then(success, rejection_handler);\r\n        }\r\n        return new Promise(executor).then(success, rejection_handler);\r\n    });\r\n}\r\n\r\n\r\n\r\n/* TODO: ...............................................................\r\n\r\n$.fn.fixHeightFromAuto = function(){\r\n    var heights = [];\r\n    var d = this.get();\r\n    for(var i=0;i<d.length;i++)\r\n        heights.push(getComputedStyle(d[i]).height);\r\n    \r\n    this.each(function(ind){this.style.height = heights[ind];});\r\n\r\n    return this;\r\n}\r\n\r\n$.fn.insertClonedChildren = function(index,$src,textArray,attrObjArrays){\r\n    //inserts new nodes before this.children(index)\r\n    //the new nodes are based on $src, with text set according to the elements of textArray\r\n    //attrObjArrays is an optional arrays of objects giving key names and values\r\n    \r\n    var src = $src.get(0);\r\n    var frag = document.createDocumentFragment();\r\n    \r\n    textArray.map(function(str,ind){\r\n                    var a = src.cloneNode(false); \r\n                    a.textContent = str;\r\n                    if(attrObjArrays)for(var attr in attrObjArrays[ind])\r\n                        a.setAttribute(attr,attrObjArrays[ind][attr]);\r\n                    frag.appendChild(a);\r\n                });\r\n    \r\n    var parent = this.get(0);\r\n    var new_$els = $(Array.prototype.slice.call(frag.children,0));\r\n    parent.insertBefore(frag,parent.children[index]);\r\n    \r\n    return new_$els;\r\n}\r\n\r\n*/","\"use strict\";\r\n\r\nvar DropDown = function(val_array){\r\n    //constructor, must use <new>\r\n    \r\n    var str = val_array.map(function(val){\r\n                    return \"<div class='dropdown_item' title='\" + escape_str(val) + \"'>\" + escape_str(val) + \"</div>\";\r\n                 }).join(\"\");\r\n    \r\n    this.val_array = val_array.slice(0); \r\n    this.el_list = document.createElement('div');\r\n    this.el_list.className ='dropdown_item_list';\r\n    this.el_list.tabindex =-1\r\n    this.el_list.style.display = 'none';\r\n    this.el_list.innerHTML = str;\r\n\r\n    this.el_collapsed = document.createElement('div');\r\n    this.el_collapsed.className = 'dropdown_collapsed';\r\n    \r\n    this.el = document.createElement('div');\r\n    this.el.className = 'dropdown';\r\n    this.el.appendChild(this.el_list)\r\n    this.el.appendChild(this.el_collapsed);\r\n    this.ind = 0;\r\n    this.el_collapsed.textContent = val_array[0];\r\n    this.event_callbacks = {}; //map of callback lists\r\n    this.open = false;\r\n    \r\n    var dd = this;\r\n\r\n    this.document_mousedown = function(e){\r\n        dd.el_list.style.display = 'none';\r\n        dd.open = false;\r\n        dd.trigger(\"blur\");\r\n        document.removeEventListener('mousedown', dd.document_mousedown);\r\n    }\r\n\r\n    this.el_collapsed.addEventListener('mousedown',function(){\r\n        if(!dd.trigger(\"click\"))\r\n            return;\r\n        dd.el.parentNode.classList.add(\"selected\");\r\n        dd.el_list.style.display = '';\r\n        this.open = true;\r\n        setTimeout(function(){\r\n            dd.el_list.focus();\r\n            dd.el_list.scrollTop = dd.el_list.children[dd.ind].offsetTop;\r\n            document.addEventListener('mousedown', dd.document_mousedown)\r\n        },1);\r\n    });\r\n    var on_click = function(e){\r\n            dd.SetInd(this.getAttribute('data-ind'));\r\n            dd.el_list.style.display = 'none';\r\n            dd.open = false;\r\n            e.stopPropagation();\r\n            document.removeEventListener('mousedown', dd.document_mousedown);\r\n    };\r\n    for(var ii=0; ii<this.el_list.children.length; ii++){\r\n        this.el_list.children[ii].setAttribute('data-ind', ii);\r\n        this.el_list.children[ii].addEventListener(\"click\", on_click); \r\n    }\r\n\r\n    return this;\r\n}\r\n\r\nDropDown.FakeEvent = function(){//static subclass\r\n    this.is_stopped = false;\r\n}\r\nDropDown.FakeEvent.prototype.stopImmediatePropagation = function(){\r\n    this.is_stopped = true;\r\n}\r\n\r\nDropDown.prototype.addEventListener = function(evt, func){\r\n    if(!(evt in this.event_callbacks))\r\n        this.event_callbacks[evt] = [];\r\n    this.event_callbacks[evt].push(func);\r\n}\r\n\r\nDropDown.prototype.trigger = function(evt, args){\r\n    var fe = new DropDown.FakeEvent();\r\n    if(evt in this.event_callbacks){\r\n        for(var ii = 0; ii<this.event_callbacks[evt].length; ii++)\r\n            this.event_callbacks[evt][ii].call(this, fe);\r\n        if(fe.is_stopped)\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\nDropDown.prototype.IndexOf = function(val){\r\n    return this.val_array.indexOf(val);\r\n}\r\n\r\nDropDown.prototype.GetVal = function(){\r\n    return this.val_array[this.ind];\r\n}\r\n\r\nDropDown.prototype.SetInd = function(ind,no_trigger){\r\n    ind = parseInt(ind)\r\n    if(ind === this.ind)\r\n        return;\r\n    this.el_list.children[this.ind].classList.remove(\"selected\");\r\n    this.el_collapsed.textContent = this.val_array[ind];\r\n    this.el_collapsed.title = escape_str(this.val_array[ind]);\r\n    this.ind = ind;\r\n    this.el_list.children[ind].classList.add(\"selected\");\r\n    if(!no_trigger)\r\n        this.trigger(\"change\",{ind:ind,str:this.val_array[ind],isOpen: this.open});\r\n}\r\n\r\nDropDown.prototype.SetSelected = function(v){\r\n    if(v)\r\n        this.el.parentNode.classList.add(\"selected\");\r\n    else\r\n        this.el.parentNode.classList.remove(\"selected\");\r\n}\r\n","\"use strict\";\r\n\r\ndn.menu_id_to_caption = {\r\n'menu_print': 'print',\r\n'menu_sharing': 'sharing',\r\n'menu_save': 'save',\r\n'menu_history': 'history',\r\n'menu_file': 'current file',\r\n'menu_new': 'new',\r\n'menu_open': 'new/open',\r\n'menu_find': 'find/replace',\r\n'menu_goto': 'goto line',\r\n'menu_general_settings': 'general settings',\r\n'menu_shortcuts': 'shortcuts',\r\n'menu_drive': 'drive',\r\n'menu_help': 'about/help'};\r\n\r\n\r\ndn.shortcuts_list = [\r\n\"cut|Ctrl-X|Cmd-X\",    \r\n\"copy|Ctrl-C|Cmd-C\",\r\n\"paste|Ctrl-V|Command-V\",\r\n\"cycle clipboard|Cltr-[V then left or right arrow]|Command-[V then left or right arrow]\",\r\n\"select all|Ctrl-A|Command-A\",\r\n\"find|Ctrl(-Alt)-F\",\r\n\"replace|Ctrl-R\",\r\n\"go to line|Ctrl(-Alt)-L\",\r\n\"undo|Ctrl-Z|Command-Z\",\r\n\"redo|Ctrl-Shift-Z,Ctrl-Y|Command-Shift-Z,Command-Y\",\r\n\" | \",\r\n\"toggle widget|Esc\",\r\n\"save|Ctrl-S|Command-S\",\r\n\"print|Ctrl(-Alt)-P|Command-P\",\r\n\"file history|Ctrl-H|Command-H\",\r\n\"new|Ctrl(-Alt)-N\",\r\n\"open|Ctrl(-Alt)-O\",\r\n\"  | \",\r\n\"to upper case|Ctrl-U\",\r\n\"to lower case|Ctr-Shift-U\",\r\n\"modify selection|Shift-(Ctrl-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown, PageUp, End}|Shift-(Command-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown,End}\",\r\n\"copy lines down|Ctrl-Alt-Down|Command-Option-Down\",\r\n\"copy lines up|Ctrl-Alt-Up|Command-Option-Up\",\r\n\"center selection||Ctrl-L\",\r\n\"fold all|Alt-0|Option-0\",\r\n\"unfold all|Alt-Shift-0|Option-Shift-0\",\r\n\"go to end|Ctrl-End,Ctrl-Down|Command-End,Command-Down\",\r\n\"go to line end|Alt-Right,End|Command-Right,End,Ctrl-E\",\r\n\"go to line start|Alt-Left,Home|Command-Left,Home,Ctrl-A\",\r\n\"go to page down|PageDown|Option-PageDown,Ctrl-V\",\r\n\"go to page up|PageUp|Option-PageUp\",\r\n\"go to start|Ctrl-Home,Ctrl-Up|Command-Home,Command-Up\",\r\n\"go to word left|Ctrl-Left|Option-Left\",\r\n\"go to word right|Ctrl-Right|Option-Right\",\r\n\"indent|Tab\",\r\n\"outdent|Shift-Tab\",\r\n\"overwrite|Insert\",\r\n\"remove line|Ctrl-D|Command-D\",\r\n\"remove to line end||Ctrl-K\",\r\n\"remove to linestart||Option-Backspace\",\r\n\"remove word left||Alt-Backspace,Ctrl-Alt-Backspace\",\r\n\"remove word right||Alt-Delete\",\r\n\"split line||Ctrl-O\",\r\n\"toggle comment|Ctrl-7|Command-7\",\r\n\"transpose letters|Ctrl-T\"\r\n]\r\n\r\ndn.ext_to_mime_type = {\r\nhtml:\"text/html\",\r\nhtm:\"text/html\",\r\njs:\"text/javascript\",\r\npl:\"application/x-perl\",\r\nxml:\"text/xml\",\r\nc:\"text/x-csrc\",\r\ncpp:\"text/x-c++src\",\r\nh:\"text/x-chdr\",\r\njson:\"application/json\",\r\nphp:\"application/x-php\",\r\nsvg:\"text/html\",\r\ncss:\"text/css\",\r\njava:\"text/x-java\",\r\npy:\"text/x-python\",\r\nscala:\"scala\",\r\ntextile:\"textile\",\r\ntex:\"application/x-tex\",\r\nbib:\"application/x-tex\",\r\nrtf:\"application/rtf\",\r\nrtx:\"application/rtf\",\r\nsh:\"application/x-sh\",\r\nsql:\"text/x-sql\",\r\nas:\"text/x-actionscript\"\r\n//everything else is hopefully ok to be text/plain.\r\n}\r\n\r\ndn.tooltip_info = { //keys correspond to icon data-info attr, which will be the same as keys in SHORTCUTS_LIST\r\n    \"save\" : \"Save file contents.  \",\r\n    \"print\": \"Open print view in a new tab.  \",\r\n    \"sharing\": \"View and modify file's sharing status.\",\r\n    \"file history\": \"Explore the file history.  \",\r\n    \"drive\": \"Show this file in Google Drive.  \",\r\n    \"about\": \"Drive Notepad website.\",\r\n    \"shortcuts\": \"Keyboard shortcuts.\",\r\n    \"new\": \"Create new file in a new tab.  \",\r\n    \"open\": \"Launch open dialoag.  \",\r\n    \"settings_file\": \"Properties of the current file.\",\r\n    \"settings_general\": \"Your general Drive Notepad preferences.\",\r\n    \"title\": \"Click to edit the file's title.\",\r\n    \"description\": \"Click to edit the file's description.\"\r\n}\r\n\r\n// TODO: use keymaster rather than relying on this\r\nvar WHICH = {\r\nENTER: 13,\r\nESC: 27,\r\nUP: 38,\r\nDOWN: 40\r\n};\r\n\r\ndn.default_settings = {\r\next: 'txt',\r\nwordWrap: [true,null,null],\r\nwordWrapAt: 80,\r\nfontSize: 1,\r\nwidget_anchor: ['l',50,'t',10],\r\nshowGutterHistory: 1,\r\nlastDNVersionUsed: '',\r\nnewLineDefault: 'windows',\r\nhistoryRemovedIsExpanded: true,\r\nsoftTabN: 4,\r\ntabIsHard: 0,\r\nwidgetSub: 'general',\r\ntheme: \"chrome\",\r\npane: '',\r\npane_open: true,\r\nfind_regex: false,\r\nfind_whole_words: false,\r\nfind_case_sensitive: false,\r\nhelp_inner: 'main',\r\nfind_goto: false,\r\nfind_replace: false\r\n}\r\n\r\ndn.impersonal_settings_keys = [\r\n\"wordWrap\",\r\n\"wordWrapAt\",\r\n\"fontSize\",\r\n\"widget_anchor\",\r\n\"showGutterHistory\",\r\n\"historyRemovedIsExpanded\",\r\n\"tabIsHard\",\r\n\"softTabN\",\r\n\"newLineDefault\",\r\n\"widgetSub\",\r\n\"theme\",\r\n\"pane\",\r\n\"pane_open\",\r\n\"find_regex\",\r\n\"find_whole_words\",\r\n\"find_case_sensitive\",\r\n\"help_inner\",\r\n\"find_goto\",\r\n\"find_replace\"\r\n];\r\n\r\ndn.const = {\r\ndrag_delay_ms: 400,\r\ndrag_shift_px: 40,\r\nmin_font_size: 0.3,\r\nmax_font_size: 5, \r\nmax_wrap_at: 200,\r\nmin_wrap_at: 20,\r\nwrap_at_increment: 10,\r\nmax_soft_tab_n: 10,\r\nmin_soft_tab_n: 2,\r\ndetect_tabs_spaces_frac: 0.9,\r\ndetect_tabs_tabs_frac: 0.9,\r\ndetect_tabs_n_spaces_frac: 0.99,\r\ndetect_tabs_n_spaces_frac_for_default: 0.6, //check\r\nfont_size_increment: 0.15, //check\r\nerror_delay_ms: 5000,//5 seconds\r\nfind_history_add_delay: 2000, //ms\r\nclipboard_info_delay: 500, //ms\r\nclipboard_max_length: 20, //TODO: decide whether a large clipboard slows page loads and whether we can do anything about it.\r\nfind_max_results_half: 3, \r\nfind_max_prefix_chars: 10,\r\nfind_max_suffix_chars: 60\r\n};","\"use strict\"\r\n\r\ndn.FileModel = function(){\r\n    this.is_loaded = false; // when this is set to true we compute tabs, newlines etc, and continue to do so whenver set() is called.\r\n    this.file_id = null;\r\n    this.folder_id = null;\r\n    this.title = null;\r\n    this.description = '';\r\n    this.ext = '';\r\n    this.loaded_body = '';\r\n    this.is_read_only = false;\r\n    this.is_shared = false;\r\n    this.properties_chosen = {}, // combines detection, settings, and file properties\r\n    this.properties = {}, // values stored in the file's meta data, defines which button is currently selected\r\n    this.properties_detected_info = {} // caption for detection \r\n    this.change_callbacks = [];\r\n    return this;\r\n}\r\n\r\n// basic events system for a single event called \"change\"\r\ndn.FileModel.prototype.addEventListener = function(kind, c){\r\n    if(kind !== \"change\") throw \"only change listeners please!\";\r\n    this.change_callbacks.push(c);\r\n}\r\ndn.FileModel.prototype.trigger = function(kind, ob){\r\n    if(kind !== \"change\") throw \"only change events please!\";\r\n    for(var ii=0; ii<this.change_callbacks.length; ii++)\r\n        this.change_callbacks[ii](ob);\r\n}\r\n\r\ndn.FileModel.prototype.set = function(obj){\r\n    if(obj.syntax && obj.syntax !== this.properties.syntax){\r\n        this.properties.syntax = obj.syntax;\r\n        if(this.is_loaded)\r\n            this.compute_syntax(); // will trigger \r\n    }\r\n    if(obj.newline && obj.newline !== this.properties.newline){\r\n        this.properties.newline = obj.newline;\r\n        if(this.is_loaded)\r\n            this.compute_newline(); // will trigger \r\n    }\r\n    if(obj.tabs && !(obj.tabs.val === this.properties.tabs.val && obj.tabs.n === this.properties.tabs.n)){\r\n        this.properties.tabs = obj.tabs;\r\n        if(this.is_loaded)\r\n            this.compute_tabs(); // will trigger \r\n    }\r\n    if(obj.title && obj.title !== this.title){\r\n        this.title = obj.title;\r\n        this.trigger(\"change\",{property: 'title'})\r\n        if(this.is_loaded)\r\n            this.compute_syntax(); // will trigger \r\n    }\r\n    if(obj.description && obj.description !== this.description){\r\n        this.description = obj.description;\r\n        this.trigger(\"change\",{property: 'description'})\r\n    }\r\n    if(obj.is_read_only && obj.is_read_only !== this.is_read_only){\r\n        this.is_read_only = obj.is_read_only;\r\n        this.trigger(\"change\",{property: 'is_read_only'});\r\n    }\r\n    if(obj.is_shared && obj.is_shared !== this.is_shared){\r\n        this.is_shared = obj.is_shared;\r\n        this.trigger(\"change\",{property: 'is_shared'});\r\n    }\r\n    if(obj.is_loaded){\r\n        this.is_loaded = true;\r\n        this.compute_newline(); // these trigger when they are done\r\n        this.compute_tabs();\r\n        this.compute_syntax();\r\n    }\r\n}\r\n\r\n\r\ndn.FileModel.prototype.compute_newline = function(){\r\n    // populates properties _chosen, _detected and _detect_info\r\n    // uses this.loaded_body, file's current properties, and dn.g_settings\r\n\r\n    var str = this.loaded_body;\r\n\r\n    if(this.properties.newline === \"windows\")\r\n        this.properties_chosen.newline = \"windows\";\r\n    else if(this.properties.newline === \"unix\")\r\n        this.properties_chosen.newline = \"unix\";\r\n    else\r\n        this.properties.newline = \"detect\"; // force it to be the only possible alternative, we set choice below...\r\n    \r\n    // get dection info string, and if detection mode is active then chose the value...\r\n    var first_n = str.indexOf(\"\\n\");\r\n    if(first_n === -1){\r\n        var val = dn.g_settings.get(\"newLineDefault\");\r\n        this.properties_detected_info.newline = \"no newlines detected, default is \" + val + \"-like\";\r\n        if(this.properties.newline === \"detect\")\r\n            this.properties_chosen.newline = val;\r\n    } else {\r\n        var has_rn = str.indexOf(\"\\r\\n\") != -1;\r\n        var has_solo_n = str.match(/[^\\r]\\n/) ? true : false;\r\n        if(has_rn && !has_solo_n){\r\n            this.properties_detected_info.newline = \"detected windows-like newlines\";\r\n            if(this.properties.newline === \"detect\")\r\n                this.properties_chosen.newline = \"windows\";\r\n        }else if(has_solo_n && !has_rn){\r\n            this.properties_detected_info.newline = \"detected unix-like newlines\";\r\n            if(this.properties.newline === \"detect\")\r\n                this.properties_chosen.newline = \"unix\";\r\n        } else {\r\n            var val = dn.g_settings.get(\"newLineDefault\");\r\n            this.properties_detected_info.newline = \"mixture of newlines detected, default is \" + val + \"-like\";\r\n            this.properties_chosen.newline = val;\r\n        }\r\n    }\r\n\r\n    this.trigger(\"change\", {property: 'newline'});\r\n}\r\n\r\ndn.FileModel.prototype.compute_syntax = function(){\r\n    // populates properties _chosen, _detected and _detect_info\r\n    // uses this.title, and current file's properties\r\n\r\n    var title = this.title;\r\n\r\n    // validate specified syntax\r\n    this.properties_chosen.syntax = undefined;\r\n    if(this.properties.syntax && this.properties.syntax !== \"detect\"){\r\n        var all_modes = require(\"ace/ext/modelist\").modes;\r\n        for(var ii=0; ii<all_modes.length; ii++)\r\n            if(all_modes[ii].caption == this.properties.syntax){\r\n                this.properties_chosen.syntax = this.properties.syntax; //valid\r\n                break;\r\n            }\r\n        if(this.properties_chosen.syntax === undefined) // not found\r\n            this.properties.syntax = \"detect\"; \r\n    }else{\r\n        this.properties.syntax = \"detect\"; //force it to be valid\r\n    }\r\n\r\n    var detected = require(\"ace/ext/modelist\").getModeForPath(title).caption;\r\n    this.properties_detected_info.syntax = \"detected \" + detected + \" from file extension\";\r\n    if(this.properties_chosen.syntax === undefined)\r\n        this.properties_chosen.syntax = detected;\r\n\r\n    this.trigger(\"change\", {property: 'syntax'});\r\n}\r\n\r\ndn.FileModel.prototype.re_whitepace = /^([^\\S\\n\\r]+)/mg;\r\n\r\ndn.FileModel.prototype.compute_tabs = function(){\r\n    // populates properties _chosen, _detected and _detect_info\r\n    // uses this.loaded_body, file's current properties, and dn.g_settings\r\n    // tabs have two subproperties, .val and .n, .val can be \"detect\", \"tabs\" or \"spaces\"\r\n    // and n is an integer in the valid range, although if .properties.tabs.val != \"spaces\",\r\n    // then .properties.tabs.n, may be undefiend, in which case display _chosen.n\r\n\r\n    var str = this.loaded_body;\r\n\r\n    // firstly, parse the stored tabs property, getting a valid .val and valid .n value.\r\n    var prop = this.properties.tabs;\r\n    try{\r\n        prop = JSON.parse(prop)\r\n        prop = {val: prop.val, n: prop.n}; // drop any other nonsense\r\n        prop.n = parseInt(prop.n) = 10;\r\n        if(!(prop.val === \"tab\" || prop.val === \"spaces\")) throw 0\r\n        if(!(prop.n > dn.const.min_soft_tab_n && prop.n < dn.const.max_soft_tab_n))\r\n            prop.n = undefined; \r\n        if(prop.val === \"spaces\" && prop.n === undefined) throw 0\r\n    }catch(e){\r\n        this.properties.tabs = {val: \"detect\"}; //force it to be valid alternative\r\n        prop = {val: \"detect\"};\r\n    }\r\n\r\n    if(prop.val === \"tab\")\r\n        this.properties_chosen.tabs = prop; // may need to chose n still\r\n    else if(prop.val === \"spaces\")\r\n        this.properties_chosen.tabs = prop; // n is definitely valid\r\n    else\r\n        this.properties_chosen.tabs = undefined; // we need to chose val and n \r\n    \r\n\r\n    // Now do detection....\r\n\r\n    // find non-zero-length whitespace at start of all lines\r\n    var indents = str.match(this.re_whitepace) || []; \r\n\r\n    //  build the stats for those lines...\r\n    var n_only_tabs = 0;\r\n    var n_only_space; // we compute this after the loop\r\n    var space_hist = [];\r\n    var n_with_mixture = 0;\r\n    var n_samp = Math.min(indents.length, 1000);\r\n    for(var ii=0; ii<n_samp; ii++){\r\n        var indents_ii = indents[ii]\r\n        var without_tabs = indents_ii.replace(\"\\t\", \"\");\r\n        if(without_tabs.length === 0)\r\n            n_only_tabs++;\r\n        else if(without_tabs.length !== indents_ii.length)\r\n            n_with_mixture++;\r\n        else\r\n            space_hist[indents_ii.length] = (space_hist[indents_ii.length] || 0) + 1;\r\n    }\r\n    n_only_space = n_samp - n_with_mixture - n_only_tabs;\r\n\r\n\r\n    if(n_only_tabs/n_samp >= dn.const.detect_tabs_tabs_frac){\r\n        // detected tab...\r\n        this.properties_detected_info.tabs = \"hard tab indentation detected\";\r\n        if(this.properties_chosen.tabs === undefined)\r\n            this.properties_chosen.tabs = {val: 'tabs'}\r\n        if(this.properties_chosen.tabs.n === undefined)\r\n            this.properties_chosen.tabs.n = dn.g_settings.get('softTabN'); // we have to show something for n\r\n\r\n    } else if(n_samp === 0 || n_only_space/n_samp < dn.const.detect_tabs_spaces_frac){\r\n        // no detection possible, use default....\r\n\r\n        if(this.properties_chosen.tabs === undefined){\r\n            this.properties_chosen.tabs = {\r\n                val: dn.g_settings.get('tabIsHard') ? 'tabs' : 'spaces',\r\n                n: dn.g_settings.get('softTabN')};\r\n        }\r\n        this.properties_detected_info.tabs =\r\n            (n_samp === 0 ?\r\n                   \"no indentations detected\" \r\n                 : \"detected mixture of tabs\")\r\n            + \", default is \" + (this.properties_chosen.tabs.val == 'tabs' ?\r\n                   \"hard tabs\"\r\n                 : this.properties_chosen.tabs.n + \" spaces\");\r\n        \r\n    } else {\r\n        // detected spaces, but exxactly how many? \r\n\r\n        //Build a second space hist, using all \"harmonics\"....\r\n        var space_mod_hist = [];\r\n        for(var ss=dn.const.min_soft_tab_n; ss<=dn.const.max_soft_tab_n; ss++){\r\n            for(var ii=ss, m=0; ii<space_hist.length; ii+=ss)\r\n                m += space_hist[ii] === undefined ? 0 : space_hist[ii];\r\n            space_mod_hist[ii] = m;\r\n        }\r\n        \r\n        // and find the largest indent that passes threshold...\r\n        var ss;\r\n        for(ss=dn.const.max_soft_tab_n; ss>=dn.const.min_soft_tab_n; ss--)\r\n            if(space_mod_hist[ss]/n_only_space > dn.const.detect_tabs_n_spaces_frac){\r\n                this.properties_detected_info.tabs = \"detected soft-tabs of \" + ss + \" spaces\"\r\n                break;\r\n            }\r\n\r\n        // if nothing was over threshold, use default space count\r\n        if(ss < dn.const.min_soft_tab_n){\r\n            ss = dn.g_settings.get('softTabN');    \r\n            if(space_mod_hist[ss]/n_only_space > dn.const.detect_tabs_n_spaces_frac_for_default)\r\n                this.properties_detected_info.tabs = \"detected close match to default of \" + ss + \" spaces\";\r\n            else \r\n                this.properties_detected_info.tabs = \"detected soft-tabs, assuming default \" + ss + \" spaces\";\r\n        }\r\n\r\n        // if we need to specify a space count use the ss value we ended up with...\r\n        if(this.properties_chosen.tabs === undefined)\r\n            this.properties_chosen.tabs = {val: 'spaces'};\r\n        if(this.properties_chosen.tabs.n === undefined)\r\n            this.properties_chosen.tabs.n = ss;\r\n    }\r\n    \r\n    this.trigger(\"change\", {property: 'tabs'});\r\n}\r\n\r\n","\"use strict\";\r\n\r\ndn.settings_pane = (function(){\r\n\r\nvar el = {};\r\n\r\nvar theme_drop_down;\r\n\r\nvar on_document_ready = function(){\r\n    el.theme_chooser = document.getElementById('theme_chooser')\r\n    el.button_clear_clipboard = document.getElementById(\"button_clear_clipboard\");\r\n    el.button_clear_find_replace = document.getElementById(\"button_clear_find_replace\");\r\n    el.gutter_history_show = document.getElementById('gutter_history_show');\r\n    el.gutter_history_hide = document.getElementById('gutter_history_hide');\r\n    el.word_wrap_off = document.getElementById('word_wrap_off');\r\n    el.word_wrap_at = document.getElementById('word_wrap_at');\r\n    el.word_wrap_edge = document.getElementById('word_wrap_edge');\r\n    el.font_size_dec = document.getElementById('font_size_dec');\r\n    el.font_size_inc = document.getElementById('font_size_inc');\r\n    el.font_size_text = document.getElementById('font_size_text');\r\n    el.tab_hard = document.getElementById('tab_hard');\r\n    el.tab_soft = document.getElementById('tab_soft');\r\n    el.newline_windows = document.getElementById('newline_menu_windows');\r\n    el.newline_unix = document.getElementById('newline_menu_unix');\r\n    el.tab_soft_text = document.getElementById('tab_soft_text');\r\n    el.tab_soft_dec = document.getElementById('tab_soft_dec');\r\n    el.tab_soft_inc = document.getElementById('tab_soft_inc');\r\n    el.word_wrap_at_text = document.getElementById('word_wrap_at_text');\r\n    el.word_wrap_at_dec = document.getElementById('word_wrap_at_dec');\r\n    el.word_wrap_at_inc = document.getElementById('word_wrap_at_inc');\r\n\r\n    dn.g_settings.addEventListener(\"VALUE_CHANGED\", on_change); // this does all the view rendering\r\n\r\n    var themes = require('ace/ext/themelist');\r\n    theme_drop_down = new DropDown(Object.keys(themes.themesByName));\r\n\r\n    // annonymous controler functions....\r\n    theme_drop_down.addEventListener(\"change\",function(){\r\n        dn.g_settings.set(\"theme\",theme_drop_down.GetVal());\r\n    })\r\n    theme_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    el.theme_chooser.appendChild(theme_drop_down.el);\r\n    el.newline_windows.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'windows');\r\n    });\r\n    el.newline_unix.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'unix');\r\n    });\r\n    el.tab_hard.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 1)\r\n    });\r\n    el.tab_soft.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 0);\r\n    });\r\n    el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') - 1;\r\n        at = at < dn.const.min_soft_tab_n ? dn.const.min_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    el.tab_soft_inc.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') + 1;\r\n        at = at > dn.const.max_soft_tab_n ? dn.const.max_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    el.font_size_dec.addEventListener('click', font_size_dec_click);\r\n    el.font_size_inc.addEventListener('click', font_size_inc_click);    \r\n    el.word_wrap_off.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[0,0,0])\r\n    });\r\n    el.word_wrap_at.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt');\r\n        dn.g_settings.set('wordWrap',[1,at,at]);\r\n    });\r\n    el.word_wrap_at_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') - dn.const.wrap_at_increment;\r\n        at = at < dn.const.min_wrap_at ? dn.const.min_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    el.word_wrap_at_inc.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') + dn.const.wrap_at_increment;\r\n        at = at > dn.const.max_wrap_at ? dn.const.max_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    el.word_wrap_edge.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[1,null,null])\r\n    });\r\n    el.gutter_history_show.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',1);\r\n    });\r\n    el.gutter_history_hide.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',0);\r\n    });\r\n\r\n    // non-view interactivity...\r\n    el.button_clear_clipboard.addEventListener('click', function(){\r\n        dn.g_clipboard.clear();\r\n    });\r\n    el.button_clear_find_replace.addEventListener('click', function(){\r\n        dn.g_find_history.clear();\r\n    });\r\n\r\n}\r\n\r\n// additional controler functions ::::::::::::::::::::::::::::::::::\r\n\r\nvar font_size_dec_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size -= dn.const.font_size_increment;\r\n    font_size = font_size  < dn.const.min_font_size ? dn.const.min_font_size: font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\nvar font_size_inc_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size += dn.const.font_size_increment;\r\n    font_size = font_size  > dn.const.max_font_size ? dn.const.max_font_size:font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\n\r\n// view function ::::::::::::::::::::::::::::::::::\r\n\r\nvar on_change = function(e){\r\n    var new_value = e.newValue;\r\n\r\n    switch(e.property){\r\n\r\n        case \"showGutterHistory\":\r\n        var s = dn.editor.getSession(); \r\n        if(new_value){\r\n            el.gutter_history_show.classList.add('selected')\r\n            el.gutter_history_hide.classList.remove('selected');\r\n        }else{\r\n            el.gutter_history_hide.classList.add('selected')\r\n            el.gutter_history_show.classList.remove('selected');\r\n        }\r\n        break;\r\n\r\n        case \"wordWrapAt\":\r\n        el.word_wrap_at_text.textContent = new_value;\r\n        break;\r\n\r\n        case \"wordWrap\":\r\n        if(!new_value[0])\r\n            el.word_wrap_off.classList.add('selected');\r\n        else\r\n            el.word_wrap_off.classList.remove('selected');\r\n        if(new_value[0] && !new_value[1])\r\n            el.word_wrap_edge.classList.add('selected');\r\n        else\r\n            el.word_wrap_edge.classList.remove('selected');\r\n        if(new_value[0] && new_value[1])\r\n            el.word_wrap_at.classList.add('selected');\r\n        else\r\n            el.word_wrap_at.classList.remove('selected');\r\n        break;\r\n\r\n        case \"softTabN\":\r\n        el.tab_soft_text.textContent = new_value;\r\n        break;\r\n\r\n        case \"tabIsHard\":        \r\n        if(new_value){\r\n            el.tab_soft.classList.remove('selected');\r\n            el.tab_hard.classList.add('selected');\r\n        }else{\r\n            el.tab_soft.classList.add('selected');\r\n            el.tab_hard.classList.remove('selected');\r\n        }\r\n        break;\r\n        \r\n        case \"newLineDefault\":\r\n        if(new_value == \"windows\"){\r\n            el.newline_unix.classList.remove('selected');\r\n            el.newline_windows.classList.add('selected');\r\n        }else{\r\n            el.newline_unix.classList.add('selected');\r\n            el.newline_windows.classList.remove('selected');\r\n        }\r\n        break;\r\n        \r\n        case \"fontSize\":\r\n        var scrollLine = dn.get_scroll_line();\r\n        el.font_size_text.textContent = new_value.toFixed(1);\r\n        break;\r\n\r\n        case \"theme\":\r\n        theme_drop_down.SetInd(theme_drop_down.IndexOf(new_value), true);\r\n        break;\r\n  \r\n    }\r\n}\r\n\r\nreturn {\r\n    on_document_ready: on_document_ready\r\n};\r\n\r\n\r\n\r\n})();\r\n","\"use strict\";\r\n\r\n/*\r\n    Working with oauth2 APIs has its complexities, some of which\r\n    are dealt with by the google client library, but some of which\r\n    are exposed for us to deal with.\r\n\r\n    These functions do the majority of the fiddly stuff.  In particular,\r\n    the dn.request_* functions are designed to be used in a promise chain\r\n    within a until_success call. See the readme for additional explanation.\r\n\r\n    You can insert the request_screw_up_auth into a promise chain to check \r\n    how the chain handles unexpected invalidation.\r\n\r\n*/\r\n\r\ndn.is_auth_error = function(err){\r\n    // returns 0 for non-auth errors, 1 for auto refresh and 2 for manual refresh\r\n    if(!err)\r\n        return 2;\r\n    if(err.type && err.type === \"token_refresh_required\")\r\n        return 1;\r\n    if(err.status === 403 || err.status === 401)\r\n        return 1;\r\n    if(err.status === 404)\r\n        return 0;\r\n    if(err.result && err.result.error && err.result.error.code === -1)//network error\r\n        return 1;\r\n    console.log(\"WHAT IS THIS ERROR?....\")\r\n    console.dir(err);\r\n    return 0;\r\n}\r\n\r\ndn.handle_auth_error = function(err){\r\n    // this is the error handler for dn.pr_auth\r\n\r\n    dn.status.authorization = -1;\r\n    dn.status.popup_active = 0;\r\n    dn.show_status();\r\n    var err_type = dn.is_auth_error(err);\r\n\r\n    if(err_type === 0){\r\n        if(err.result && err.result.error && err.result.error.message !== undefined){\r\n            dn.show_error(err.result.error.message);\r\n        } else {\r\n            dn.show_error(\"Error. See developer console for details.\")\r\n            console.dir(err);\r\n        }\r\n    }else if(err_type == 1){\r\n        dn.reauth_auto();\r\n    }else{\r\n        // user has to click button to trigger reauth-manual\r\n        dn.toggle_permission(true);\r\n    }\r\n}\r\n\r\n\r\ndn.reauth_auto_delay_chain = {0: 1, 1:500, 500: 1000, 1000: 2500, 2500: 5000, 5000: 10000, 10000: 60000, 60000: 60000}\r\ndn.reauth_auto = function(){ \r\n    // with roughly-exponetial backoff...\r\n    if (!dn.reauth_auto_timer){\r\n        // 1ms, 500ms, 1s, 2s, 5s, 10s, 60s.\r\n        if(!dn.reauth_auto_delay)\r\n            dn.reauth_auto_delay = dn.reauth_auto_delay_chain[0];\r\n        else\r\n            dn.reauth_auto_delay = dn.reauth_auto_delay_chain[dn.reauth_auto_delay];\r\n        dn.status.authorization = 0;\r\n        dn.show_status();\r\n        console.log(\"issuing auto reauth with delay \" + dn.reauth_auto_delay + \"ms.\")\r\n        dn.reauth_auto_timer = setTimeout(function(){\r\n            dn.reauth_auto_timer = undefined;\r\n            console.log(\"and now running the auto reauth...\")\r\n            gapi.auth.authorize(dn.auth_map(true))\r\n                .then(dn.pr_auth.resolve.bind(dn.pr_auth),\r\n                      dn.pr_auth.reject.bind(dn.pr_auth));\r\n        }, dn.reauth_auto_delay)\r\n    } else {\r\n        console.log(\"auto reauth already due to be sent\")\r\n    }\r\n}\r\n\r\ndn.reauth_manual = function(){\r\n    // if this succeeds it will trigger dn.pr_auth.resolve, which will call \r\n    // any pending (and future) success callbacks.\r\n    dn.status.popup_active = 1;\r\n    dn.status.authorization = 0;\r\n    dn.show_status();    \r\n    gapi.auth.authorize(dn.auth_map(false))\r\n        .then(dn.pr_auth.resolve.bind(dn.pr_auth),\r\n              dn.pr_auth.reject.bind(dn.pr_auth));\r\n}\r\n\r\ndn.request_user_info = function(){\r\n    // returns thenable\r\n    return gapi.client.request({'path' : 'userinfo/v2/me?fields=name'})\r\n}\r\n\r\ndn.request_file_meta = function(){\r\n    // returns thenable\r\n    return gapi.client.request({\r\n        'path': '/drive/v3/files/' + dn.the_file.file_id,\r\n        'params':{'fields': 'id,name,mimeType,description,parents,capabilities,fileExtension,shared,properties'}});\r\n}\r\n\r\ndn.request_file_body = function(){\r\n    // returns thenable\r\n    return gapi.client.request({\r\n        'path': '/drive/v3/files/' + dn.the_file.file_id,\r\n        'params':{'alt': 'media'}});\r\n}\r\n\r\ndn.make_multipart_boundary = function(){\r\n    //for MIME protocol, require a boundary that doesn't exist in the message content.\r\n    //we could check explicitly, but this is essentially guaranteed to be fine:\r\n    // e.g. \"13860126288389.206091766245663\"\r\n    return (new Date).getTime() + \"\" + Math.random()*10;\r\n}\r\n\r\ndn.request_new = function(folderId){\r\n    // this is a factory function for building a function-of-no-args-that-returns-a-thenable\r\n    var meta = {name: 'untitled.txt'};\r\n    if(folderId !== undefined)\r\n        meta['parents'] = [folderId];\r\n    return function(){\r\n       return gapi.client.request({\r\n                'path': '/drive/v3/files/',\r\n                'method': 'POST',\r\n                'params' : {'fields': 'id,name,mimeType,description,parents,capabilities,fileExtension,shared'},\r\n                'body' : JSON.stringify(meta)\r\n        });\r\n    };\r\n}\r\n\r\ndn.request_save = function(parts){\r\n    // this is a factory function for building a function-of-no-args-that-returns-a-thenable\r\n    // note the save process is complicated and should only be done via dn.save in save.js\r\n    var has_body = parts.body !== undefined;\r\n    var meta = {properties: {}};\r\n    var has_meta = false;\r\n    if(parts.title !== undefined){\r\n        has_meta = true;\r\n        meta['name'] = parts.title;\r\n    }\r\n    if(parts.description !== undefined){\r\n        has_meta = true;\r\n        meta['description'] = parts.description;\r\n    }\r\n    if(parts.syntax !== undefined){\r\n        has_meta = true;\r\n        meta.properties['aceMode'] = parts.syntax;\r\n    }\r\n    if(parts.newline !== undefined){\r\n        has_meta = true;\r\n        meta.properties['newline'] = parts.newline;\r\n    }\r\n    if(parts.tabs !== undefined){\r\n        has_meta = true;\r\n        meta.properties['tabs'] = parts.tabs;\r\n    }\r\n    var is_multipart = has_body && has_meta;\r\n    var params = {'fields': 'version'};\r\n    if(has_body)\r\n        params['uploadType'] = is_multipart ? 'multipart' : 'media';\r\n\r\n    var headers = {}\r\n    if(is_multipart){\r\n        var boundary = dn.make_multipart_boundary();\r\n        request_body = \"--\" + boundary\r\n                      + \"\\nContent-Type: application/json; charset=UTF-8\\n\" \r\n                      + JSON.stringify(meta) \r\n                      + \"\\n--\" + boundary\r\n                      + \"\\nContent-Type: text/plain\" // TODO: see if this matters, and if so get it right \r\n                      + parts.body\r\n                      + \"\\n--\" + boundary + \"--\" ;\r\n        headers['Content-Type'] = 'multipart/related; boundary=\"' + boundary+'\"';\r\n        // TODO: check if we need to add the content length ourselves\r\n        // Content-Length: number_of_bytes_in_entire_request_body\r\n    }else if(has_body){\r\n        request_body = parts.body;\r\n    } else {\r\n        request_body = JSON.stringify(meta);\r\n    }\r\n\r\n    return function(){\r\n        return gapi.client.request({\r\n                'path': (has_body ? '/upload' : '') + '/drive/v3/files/' + dn.the_file.file_id,\r\n                'method': 'PATCH',\r\n                'params' : params,\r\n                'headers' : headers,\r\n                'body' : request_body\r\n        });\r\n    }\r\n\r\n}\r\n\r\ndn.request_app_data_document = function(){\r\n    return new Promise(function(succ, fail){\r\n\r\n        // we want one error handler for loading, and one for subsequent errors, but the API doesn't\r\n        // distinguish between the two, so it's up to us to do so....\r\n        dn.app_data_realtime_error = function(err){\r\n            if(dn.status.realtime_settings < 1){\r\n                fail(err);\r\n            }else{\r\n                if(err.type === \"token_refresh_required\"){\r\n                    dn.pr_auth.reject(err);\r\n                } else {\r\n                    console.dir(err);\r\n                    dn.show_error(\"\" + err);\r\n                }\r\n            }\r\n        }\r\n\r\n        gapi.drive.realtime.loadAppDataDocument(succ, null, dn.app_data_realtime_error);\r\n        // the null argument is an omptional function for handling the initialization\r\n        // the first time the document is loaded;\r\n    });\r\n}\r\n\r\n\r\n//*\r\ndn.request_screw_up_auth_counter = 0;\r\ndn.request_screw_up_auth = function(){\r\n    if(++dn.request_screw_up_auth_counter < 10){\r\n        console.log(\"INVALIDATING TOKEN\")\r\n        gapi.auth.setToken(\"this_is_no_longer_valid\");\r\n    }\r\n    return true;\r\n}\r\n//*/","\"use strict\";\r\n\r\ndn.save_pending_requests = [];\r\n\r\ndn.SaveTracker = function(){\r\n    this.local = undefined;\r\n    this.remote = undefined;\r\n    return this;\r\n}\r\n\r\ndn.save_local_version_counter = 0;\r\n\r\n// this list tracks the state of the server, to the best of our knowledge,\r\n// i.e. based on all the respones we have recieved to date (we use the \r\n// server's \"version\" number to ensure we maintain the same chronology as the server).\r\ndn.save_server_state = {};\r\n\r\n// this is similar to the above but holds SaveRequest instances. Every time\r\n// we construct a new SaveRequest, we update this list.\r\ndn.save_local_state = { };\r\n\r\ndn.save = function(parts){\r\n    // this is the only method that should be called by other bits of the program\r\n\r\n    // update the status....\r\n    var keys = Object.keys(parts);\r\n    var idx = keys.indexOf('body');\r\n    if(idx >= 0){\r\n        dn.status.save_body = 0;\r\n        keys.splice(idx, 1);\r\n    }\r\n    idx = keys.indexOf('title');\r\n    if(idx >= 0){\r\n        dn.status.save_title = 0;\r\n        keys.splice(idx, 1);\r\n    }\r\n    if(keys.length > 0)\r\n        dn.status.save_other = 0;\r\n    dn.show_status();\r\n\r\n    // and construct the (complicated) request..\r\n    dn.save_pending_requests.push(new dn.SaveRequest(parts));\r\n}\r\n\r\ndn.SaveRequest = function(parts){\r\n    this._parts = parts\r\n\r\n    // update save_local_state \r\n    var displaced_requests = [];\r\n    for(var k in this._parts) if(this._parts.hasOwnProperty(k)){\r\n        if(dn.save_local_state[k] && !dn.save_local_state[k]._is_settled)\r\n            displaced_requests.push(dn.save_local_state[k]);\r\n        dn.save_local_state[k] = this;\r\n    }\r\n\r\n    // see if any of the displaced requests that are still pending, are no longer desired.\r\n    // We can't competely cancel pending requests, but we can make it known that they\r\n    // should stop trying so hard to complete.\r\n    for(var ii=0; ii< displaced_requests.length; ii++){\r\n        var desired = false; // if displaced_requests[ii] is responsible for any of save_local_state, then it is desired still \r\n        for(var k in dn.save_local_state) if(dn.save_local_state.hasOwnProperty(k))\r\n            if(dn.save_local_state[k] == displaced_requests[ii]){\r\n                desired = true;\r\n                break;\r\n            }\r\n        if(!desired)\r\n            displaced_requests[ii]._desired = false;\r\n    }\r\n\r\n\r\n    this._desired = true; // see above description and _throw_if_not_desired, to see how this is used\r\n    this._tracker = new dn.SaveTracker(); // hold local and remote version numbers\r\n    this._tracker.local = ++dn.save_local_version_counter;\r\n    this._is_settled = false;\r\n    this._error = undefined;\r\n\r\n    var self = this;\r\n    this._pr = until_success(function(succ, fail){\r\n        return Promise.all([dn.pr_auth, dn.pr_file_loaded])\r\n                      .then(self._throw_if_not_desired.bind(self))\r\n                      .then(dn.request_save(self._parts))\r\n                      .then(self._on_completion.bind(self))\r\n                      .catch(self._on_error.bind(self))\r\n                      .then(succ, fail);\r\n    }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n    .then(self._on_finally.bind(self));\r\n    \r\n    return this;\r\n}\r\n\r\ndn.SaveRequest.prototype._throw_if_not_desired = function(){\r\n    if(!this._desired)\r\n        throw \"not desired\"; //caught by on_error, and turned into success\r\n    return true;\r\n}\r\n\r\ndn.SaveRequest.prototype._on_error = function(err){\r\n    if(dn.is_auth_error(err)) throw err; // will cause until_success to try again\r\n    if(err !== \"not desired\")\r\n        this._error = err; // an actual error, record it\r\n    return \"error\"; //convert to success, and stop trying\r\n}\r\n\r\ndn.SaveRequest.prototype._on_completion = function(res){\r\n    this._tracker.remote = parseInt(res.result.version);\r\n    // update 0 or more entries in dn.save_server_state (see description above)\r\n    for(var k in this._parts) if(this._parts.hasOwnProperty(k)){\r\n        if(dn.save_server_state[k] === undefined)\r\n            dn.save_server_state[k] = new dn.SaveTracker();\r\n        if(dn.save_server_state[k].remote === undefined || this._tracker.remote > dn.save_server_state[k].remote){\r\n            dn.save_server_state[k].remote = this._tracker.remote;\r\n            dn.save_server_state[k].local = this._tracker.local;\r\n        }\r\n    }  \r\n    return true;    \r\n}\r\n\r\ndn.SaveRequest.prototype._on_finally = function(){\r\n    // called when the until_success deems that success has occured\r\n    // but that means the request was a legitimate failure, or canaceled,\r\n    // though at this point we don't care what happened exactly.\r\n\r\n    if(this._error !== undefined){\r\n        dn.show_error(\"Saving failed. File in unknown state on server. See developer console.\");\r\n        console.dir(this._error);\r\n        // abandon all requests, but note they may still continue executing\r\n        while(dn.save_pending_requests.length)\r\n            dn.save_pending_requests.pop()._desired = false;\r\n        // and reset out records to be totally \"naive\"\r\n        dn.save_server_state = {};\r\n        dn.save_local_state = {};\r\n        \r\n        // show that we're no longer trying to save...\r\n        dn.status.save_body = 1;\r\n        dn.status.save_title = 1;\r\n        dn.status.save_other = 1;\r\n        dn.show_status();\r\n        return;\r\n    }\r\n\r\n    // remove from the list of pending requests\r\n    this._is_settled = true;\r\n    dn.save_pending_requests.splice(dn.save_pending_requests.indexOf(this), 1);\r\n\r\n    // if other requests are still pending, let them clean up any mess when they're done..\r\n    if(dn.save_pending_requests.length > 0)\r\n        return;\r\n\r\n    // dn.save_local_state holds the state we want the server to have, and \r\n    // dn.save_server_state holds the state the server ended up with \r\n    // (and remember there are no pending requests), so lets build a list\r\n    // of corrections to make to the server\r\n    var correction = {};\r\n    var correction_need = false;\r\n    for(var k in dn.save_local_state) if(dn.save_local_state.hasOwnProperty(k))\r\n        if(dn.save_server_state[k].local != dn.save_local_state[k]._tracker.local){\r\n            correction[k] = dn.save_local_state[k]._parts[k];\r\n            correction_need = true;\r\n        }\r\n\r\n    // and now we can make the request, if we need to..\r\n    dn.status.save_body = 1; // TODO: we could have set these to 1 at an earlier point\r\n    dn.status.save_title = 1;\r\n    dn.status.save_other = 1;\r\n    if (correction_need)\r\n        dn.save(correction); // this will set some of the status's to 0 and call show_status\r\n    else\r\n        dn.show_status();\r\n\r\n}\r\n\r\n\r\n\r\n\r\n","\"use strict\";\r\n\r\ndn.do_print = (function(){\r\n\r\n\r\n var line_to_html = function (n){\r\n    var printLayer = Object.create(ace.require('ace/layer/text').Text.prototype); \r\n    var tokens  = dn.editor.getSession().getTokens(n);\r\n    var html = [];\r\n    var screenColumn = 0;\r\n    for (var i = 0; i < tokens.length; i++) {\r\n       var token = tokens[i];\r\n       var value = token.value.replace(/\\t/g,'   ');//TODO:deal with tabs properly\r\n       if(value)\r\n           printLayer.$renderToken(html, 0, token, value);\r\n    }\r\n    return html.join('').replace(/&#160;/g,' ');\r\n}\r\n\r\nreturn function(){\r\n    var content = dn.editor.session.doc.getAllLines();\r\n    var html = Array(content.length);\r\n\r\n    for(var i=0; i<content.length;i++)\r\n        html[i] = \"<li><div class='printline'>\" + dn.line_to_html(i) + '</div></li>';\r\n\r\n    var printWindow = window.open('','');\r\n    printWindow.document.writeln(\r\n            \"<html><head><title>\" + dn.the_file.title \r\n            + \"</title></head><style>\"\r\n            + ace.require('ace/theme/' + dn.g_settings.get('theme')).cssText + \"\\nbody{font-size:\"\r\n            + dn.g_settings.get('fontSize') *14 +\"px; white-space:pre-wrap;\" + \r\n            \"font-family:'Monaco','Menlo','Ubuntu Mono','Droid Sans Mono','Consolas',monospace;}\"\r\n            + \"\\nli{color:gray;}\\n.printline{color:black;}</style>\" + \r\n            \"<body class='ace-\"+ dn.g_settings.get('theme').replace('_','-') +\"'><ol id='content'>\" + \r\n            html.join(\"\") +\r\n            \"</ol></body></html>\");\r\n    printWindow.print();\r\n    return false;\r\n}\r\n\r\n\r\n})()\r\n","\"use strict\";\r\ndn.file_pane = (function(){\r\n\r\n// this uses an MVC paradigm, with the model described in file_model.js\r\n\r\nvar el = {};\r\n\r\n\r\n// non-MVC functions ::::::::::::::::::::::::::::::::::\r\n\r\nvar do_save = function (e){\r\n    e.preventDefault(); //needed for when called as shortcut\r\n    if(dn.the_file.is_read_only)\r\n        return dn.show_error(\"Cannot save read-only file.\");\r\n    dn.save({body: dn.editor.getSession().getValue()});\r\n}\r\n\r\nvar read_only_bail = function(e){\r\n    dn.show_error(\"The file is read-only, so you cannot change its properties.\");\r\n    e.preventDefault(); // probably redundant here\r\n}\r\n\r\nvar on_title_begin_edit = function(e){  \r\n    if(dn.the_file.is_read_only)\r\n        return dn.read_only_bail(e);  \r\n    el.title_text.style.display = 'none';\r\n    el.title_input.style.display = '';\r\n    el.title_input.focus();\r\n    el.title_input.select();\r\n}\r\n\r\nvar on_title_keydown = function(e){\r\n    if(e.which == WHICH.ESC){\r\n        el.title_input.value = dn.the_file.title;\r\n        e.stopPropagation();\r\n        dn.focus_editor();\r\n    }else if(e.which === WHICH.ENTER){\r\n        e.preventDefault();\r\n        dn.focus_editor(); // calls blur\r\n    }\r\n}\r\n\r\nvar on_description_begin_edit =function(e){  \r\n    if(dn.the_file.is_read_only)\r\n        return dn.read_only_bail(e);  \r\n    el.description_text.style.display = 'none';\r\n    el.description_input.style.display = '';\r\n    el.description_input.focus();\r\n    el.description_input.select();\r\n}\r\n\r\nvar on_description_keydown = function(e){\r\n    if(e.which == WHICH.ESC){\r\n        el.description_input.value = dn.the_file.description;\r\n        e.stopPropagation();\r\n        dn.focus_editor();\r\n    } else if(e.which === WHICH.ENTER  && !e.ctrlKey && !e.shiftKey){\r\n        e.preventDefault();\r\n        dn.focus_editor(); // calls blur\r\n    }\r\n}\r\n\r\nvar do_share = function(){\r\n    Promise.resolve(dn.pr_the_file_loaded)\r\n           .then(function(){\r\n        dn.status.file_sharing = -1; //TODO: see SO question about no callback for share dialog...how are we supposed to know when it's closed and what happened?\r\n        dn.the_file.is_shared = 0;\r\n        dn.show_status();\r\n\r\n        if(el.share_dialog){\r\n            do_share_sub();\r\n        } else {\r\n            gapi.load('drive-share', function(){\r\n                el.share_dialog = new gapi.drive.share.ShareClient(dn.client_id);\r\n                do_share_sub();\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\nvar do_share_sub = function(){\r\n    el.share_dialog.setItemIds([dn.the_file.file_id]);\r\n    el.share_dialog.setOAuthToken(gapi.auth.getToken().access_token);\r\n    el.share_dialog.showSettingsDialog();\r\n}\r\n\r\nvar do_print = dn.do_print;\r\n\r\n\r\n// controler functions ::::::::::::::::::::::::::::::::::\r\n\r\nvar on_description_end_edit = function(){\r\n    el.description_input.style.display = 'none';\r\n    el.description_text.style.display = '';\r\n    var new_val = el.description_input.value;\r\n    dn.the_file.set({description: new_val});    \r\n    dn.save({description: new_val});\r\n    dn.focus_editor();\r\n}\r\n\r\nvar on_title_end_edit = function(){\r\n    el.title_input.style.display = 'none';\r\n    el.title_text.style.display = '';\r\n    var new_val = el.title_input.value;\r\n    dn.the_file.set({title: new_val});\r\n    dn.save({title: new_val});\r\n    dn.focus_editor();\r\n}\r\n\r\nvar on_newline_click = function(e){\r\n    var val = \"detect\";\r\n    if(e.currentTarget === el.newline_unix)\r\n        val = \"unix\";\r\n    else if (e.currentTarget === el.newline_windows)\r\n        val = \"windows\";\r\n    dn.the_file.set({newline: val});\r\n    dn.save({newline: val});\r\n}\r\n\r\nvar on_syntax_detect_click = function(e){\r\n    dn.the_file.set({syntax: \"detect\"});\r\n    dn.save({syntax: \"detect\"});\r\n}\r\n\r\nvar on_syntax_dropdown_click = function(e){\r\n    var val =  syntax_drop_down.GetVal();\r\n    dn.save({syntax: val}); \r\n    dn.the_file.set({syntax: val});\r\n}\r\n\r\nvar on_tab_click = function(e){\r\n    var val = \"detect\";\r\n\r\n    if (e.currentTarget === el.tab_soft_inc){\r\n        e.stopPropagation();\r\n        //val = ??\r\n    } else if (e.currentTarget === el.tab_soft_dec){\r\n        e.stopPropagation();\r\n        //val = ??\r\n    }else if(e.currentTarget === el.tab_soft)\r\n        ;//val = ???\r\n    else if(e.currentTarget === el.tab_hard)\r\n        val = 0;\r\n\r\n    dn.the_file.set({tabs: val});\r\n    dn.save({tabs: val});\r\n}\r\n\r\n// view functions ::::::::::::::::::::::::::::::::::\r\n\r\nvar render_title = function(){\r\n    el.title_text_inner.textContent = dn.the_file.title;\r\n    el.title_input.value = dn.the_file.title;\r\n}\r\n\r\nvar render_description = function(){\r\n    text_multi(el.description_text_inner, dn.the_file.description, true);\r\n    el.description_input.value = dn.the_file.description;\r\n}\r\n\r\nvar render_newline = function(){\r\n    el.newline_detect.classList.remove('selected');\r\n    el.newline_windows.classList.remove('selected');\r\n    el.newline_unix.classList.remove('selected');\r\n    var val =  dn.the_file.properties.newline;\r\n    if(val === \"detect\")\r\n        el.newline_detect.classList.add('selected');\r\n    else if(val === \"windows\")\r\n        el.newline_windows.classList.add('selected');\r\n    else\r\n        el.newline_unix.classList.add('selected');   \r\n    el.newline_info.textContent = dn.the_file.properties_detected_info.newline; \r\n}\r\n\r\nvar render_syntax = function(){\r\n    syntax_drop_down.SetInd(syntax_drop_down.IndexOf(dn.the_file.properties_chosen.syntax), true);\r\n    if(dn.the_file.properties.syntax === \"detect\"){\r\n        el.ace_mode_detect.classList.add('selected');\r\n        syntax_drop_down.SetSelected(false);\r\n    }else{\r\n        el.ace_mode_detect.classList.remove('selected');\r\n        syntax_drop_down.SetSelected(true);\r\n    }\r\n    el.ace_mode_info.textContent = dn.the_file.properties_detected_info.syntax;\r\n}\r\n\r\nvar render_tabs = function(){\r\n    var user_tabs = dn.the_file.properties.tabs;\r\n\r\n    el.tab_soft.classList.remove('selected');\r\n    el.tab_hard.classList.remove('selected');\r\n    el.tab_detect.classList.remove('selected');\r\n\r\n    if(user_tabs.val === \"tabs\")\r\n        el.tab_hard.classList.add('selected');\r\n    else if(user_tabs.val === \"spaces\")\r\n        el.tab_hard.classList.add('selected');\r\n    else\r\n        el.tab_detect.classList.add('selected');\r\n    \r\n    el.tab_soft_text.textContent = dn.the_file.properties_chosen.tabs.n;\r\n    el.tab_info.textContent = dn.the_file.properties_detected_info.tabs;\r\n}\r\n\r\nvar syntax_drop_down;\r\n\r\nvar on_document_ready = function(){\r\n    el.title_input  = document.getElementById('details_file_title_input');\r\n    el.title_text = document.getElementById('details_file_title_text');\r\n    el.title_text_inner = document.getElementById('details_file_title_text_inner');\r\n    el.description_input  = document.getElementById('details_file_description_input');\r\n    el.description_text = document.getElementById('details_file_description_text');    \r\n    el.description_text_inner = document.getElementById('details_file_description_text_inner');    \r\n    el.ace_mode_choose = document.getElementById('file_ace_mode_choose')\r\n    el.ace_mode_detect = document.getElementById('file_ace_mode_detect');\r\n    el.ace_mode_info = document.getElementById('file_ace_mode_info');\r\n    el.newline_detect = document.getElementById('file_newline_detect');\r\n    el.newline_windows = document.getElementById('file_newline_windows');\r\n    el.newline_unix = document.getElementById('file_newline_unix');\r\n    el.newline_info = document.getElementById('file_newline_info');\r\n    el.tab_detect = document.getElementById('file_tab_detect');\r\n    el.tab_soft_inc = document.getElementById('file_tab_soft_inc');\r\n    el.tab_soft_dec = document.getElementById('file_tab_soft_dec');\r\n    el.tab_hard = document.getElementById('file_tab_hard');\r\n    el.tab_soft = document.getElementById('file_tab_soft');\r\n    el.tab_soft_text = document.getElementById('file_tab_soft_text');\r\n    el.tab_info = document.getElementById('file_tab_info');\r\n    el.button_save = document.getElementById('button_save');\r\n    el.button_print = document.getElementById('button_print');\r\n    el.button_share = document.getElementById('button_share');\r\n    el.button_history = document.getElementById('button_history');     \r\n        \r\n    // title and description\r\n\r\n    el.title_text.addEventListener('click', on_title_begin_edit) \r\n    el.title_input.addEventListener(\"blur\", on_title_end_edit); \r\n    el.title_input.addEventListener('keydown', on_title_keydown);\r\n\r\n    el.description_text.addEventListener('click', on_description_begin_edit) \r\n    el.description_input.addEventListener(\"blur\", on_description_end_edit); \r\n    el.description_input.addEventListener('keydown', on_description_keydown);\r\n\r\n    // File custom props stuff, make use of currentTarget to identify src\r\n\r\n    el.newline_detect.addEventListener('click', on_newline_click);\r\n    el.newline_windows.addEventListener('click', on_newline_click);\r\n    el.newline_unix.addEventListener('click', on_newline_click);\r\n\r\n    el.tab_detect.addEventListener('click', on_tab_click);\r\n    el.tab_hard.addEventListener('click', on_tab_click);\r\n    el.tab_soft_inc.addEventListener('click', on_tab_click);\r\n    el.tab_soft_dec.addEventListener('click', on_tab_click);\r\n    el.tab_soft.addEventListener('click', on_tab_click); // propagation is stopped if inc or dec are clicked rather than the base button\r\n\r\n    el.ace_mode_detect.addEventListener('click', on_syntax_detect_click);    \r\n    var modes = require(\"ace/ext/modelist\").modes;    \r\n    syntax_drop_down = new DropDown(modes.map(function(m){return m.caption;}));\r\n    el.ace_mode_choose.appendChild(syntax_drop_down.el);  \r\n    syntax_drop_down.addEventListener(\"click\", on_syntax_dropdown_click);\r\n    syntax_drop_down.addEventListener(\"change\", on_syntax_dropdown_click);\r\n\r\n    // File action buttons stuff\r\n    el.button_save.addEventListener('click', do_save);\r\n    el.button_print.addEventListener('click', do_print);\r\n    el.button_share.addEventListener('click', do_share);\r\n    //el.button_history.addEventListener('click', dn.start_revisions_worker);\r\n\r\n    dn.the_file.addEventListener('change', function(e){\r\n        switch(e.property){\r\n            case \"syntax\":\r\n            render_syntax();\r\n            break;\r\n\r\n            case \"newline\":\r\n            render_newline();\r\n            break;\r\n\r\n            case \"tabs\":\r\n            render_tabs();\r\n            break;\r\n\r\n            case \"title\":\r\n            render_title();\r\n            break;\r\n\r\n            case \"description\":\r\n            render_description();\r\n            break;\r\n        }\r\n    })\r\n\r\n}\r\n\r\n\r\n\r\nreturn {\r\n    on_save_shorcut: do_save,\r\n    on_print_shortcut: do_print,\r\n    on_document_ready: on_document_ready\r\n}\r\n\r\n\r\n\r\n})();","\"use strict\";\r\n\r\ndn.close_history = function(){\r\n    dn.file_history.$revisions_display.remove();\r\n    window.removeEventListener(\"resize\", dn.revisions_window_resize);\r\n    document.getElementById('the_editor').style.display = '';\r\n    dn.editor.resize();\r\n    dn.is_showing_history = false;\r\n}\r\ndn.revisions_window_resize = function(){\r\n    if(dn.file_history.canShowResizeError){\r\n        dn.show_error(\"The history explorer displays poorly if you resize the window while it is open. (This is a bug.)\");\r\n        dn.file_history.canShowResizeError = false; //wait at least dn.const.error_delay_ms until displaying the error again\r\n        setTimeout(function(){dn.file_history.canShowResizeError = true;},dn.const.error_delay_ms);\r\n    }    \r\n}\r\n\r\ndn.start_revisions_worker = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.show_error(\"This is a new file.  It doesn't have any history to explore.\")\r\n        return;\r\n    }\r\n    dn.is_showing_history = true;\r\n    \r\n    if(!dn.file_history){\r\n        dn.el.widget_content.innerHTML('afterend', \r\n            \"<div class='widget_box widget_revisions'>\" + \r\n            \"<div class='widget_box_title widget_revisions_title'>File History</div>\" +\r\n            \"<div class='revision_caption_at'></div>\" +\r\n            \"<div class='revision_timeline'></div>\" +\r\n            \"<div class='revision_caption_from'></div>\" +\r\n            \"<div>Removed lines: <div class='button inline_button ' id='expand_removed'>expand</div>\" + \r\n                    \"<div class='button inline_button ' id='collapse_removed'>collapse</div></div>\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"<div id='revisions_status'>Initialising...</div>\" + \r\n            \"Press Esc to return to editing.\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"Please note that the history viewing tool is missing some important features and those that have been implemented may include the odd bug.</div>\");\r\n        dn.el.widget_file_history = dn.el.widget_content.parentNode.getElementsByClassName('widget_revisions')[0];\r\n        dn.el.widget_file_history.style.display = 'none';\r\n        dn.file_history = {\r\n            $revisions_display: $(\"<div class='revisions_view'><ol></ol></div>\"),\r\n            $view: null, \r\n            $new_li: $(\"<li class='rev_line' v='-1'/>\"),\r\n            $new_tick:  $(\"<div class='revision_tick'/>\"),\r\n            needToRefindViewChildren: false, //this flag tracks when the $rev_lines_ is out of date relative to children of $view\r\n            $rev_lines_: [], // this is a single jQuery collection\r\n            needToFixHeights: $([]),            \r\n            $timeline: $d.find('.revision_timeline'),\r\n            $revisions_status: $d.find('#revisions_status'),\r\n            $revision_caption_from: $d.find('.revision_caption_from'),\r\n            $revision_caption_at: $d.find('.revision_caption_at'),\r\n            $expand_removed: $d.find('#expand_removed'),\r\n            $collapse_removed: $d.find('#collapse_removed'),\r\n            revisions: [], //array of objects with etag, isDownloaded, modifiedDate, $tick\r\n            revisionFromEtag: {},\r\n            at: null, //revision object\r\n            from: null, //revision object,\r\n            canShowResizeError: true, //used by Revisions_WindowResize\r\n            worker: new Worker(\"js/revisions_worker.js\")\r\n        };\r\n    \r\n        dn.file_history.$view = dn.file_history.$revisions_display.find('ol'); \r\n        dn.file_history.$expand_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',true)});\r\n        dn.file_history.$collapse_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',false)});\r\n        dn.revision_setis_expaned(dn.g_settings.get('historyRemovedIsExpanded'))\r\n\r\n        var w = dn.file_history.worker;\r\n        w.onmessage = dn.revision_worker_delivery;\r\n    }\r\n    dn.file_history.worker.postMessage({ fileId: dn.the_file.file_id, \r\n                                        token: gapi.auth.getToken().access_token,\r\n                                        init: true});\r\n    dn.file_history.$revisions_display.appendTo($('body'));\r\n    $(window).on(\"resize\",dn.revisions_window_resize);\r\n    dn.el.widget_file_history.style.display = '';\r\n    dn.file_history.$view.empty();\r\n    $('#the_editor').style.display = 'none';\r\n    return false;\r\n}\r\n\r\ndn.revision_setis_expaned = function(v){\r\n    var h = dn.file_history;\r\n    if(!h) return; //if we haven't yet initialised fileHistory stuff then ignore this for now, when we do initialise we will read and apply the g_settings value\r\n    \r\n    if(v){\r\n        h.$expand_removed.classList.add('selected')\r\n        h.$collapse_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"expanded\");\r\n    }else{\r\n        h.$collapse_removed.classList.add('selected')\r\n        h.$expand_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"collapsed\")\r\n    }\r\n}\r\ndn.revision_set_at = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.at = r;\r\n    if(!fromChangeEvent)\r\n        h.$at_range.value = r.ind;    \r\n    text_multi(h.$revision_caption_at,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.from && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                      fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.revision_set_from = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.from = r;\r\n    if(!fromChangeEvent)\r\n        h.$from_range.value = r.ind;\r\n    text_multi(h.$revision_caption_from,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.at && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                          fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.display_revision_timeline = function(newRevisions){\r\n    var h = dn.file_history;\r\n    var rs = h.revisions;\r\n    //TODO: update display based on newRevisions rather than starting from scratch\r\n    \r\n    h.$at_range = $(\"<input class='revision_at_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    h.$tick_box = $(\"<div class='revision_tick_box'/>\");\r\n    h.$from_range = $(\"<input class='revision_from_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    \r\n        \r\n    var attr = rs.map(function(t){ return { downloaded: t.isDownloaded || false }; });\r\n    var text = Array.apply(null, Array(attr.length)).map(function () { return \"\" });\r\n    var $ticks = h.$tick_box.insertClonedChildren(0,h.$new_tick,text,attr);\r\n    \r\n    for(var i=0;i<rs.length;i++){\r\n        rs[i].ind = i;\r\n        rs[i].$ = $ticks.eq(i);\r\n    }\r\n    \r\n    h.$timeline.empty().append(h.$at_range).append(h.$tick_box).append(h.$from_range);\r\n\r\n    h.$at_range.on(\"change\",function(){\r\n            dn.revision_set_at(dn.file_history.revisions[this.value],true);\r\n        })\r\n    h.$from_range.on(\"change\",function(){\r\n            dn.revision_set_from(dn.file_history.revisions[this.value],true);\r\n        })\r\n\r\n    dn.revision_set_from(rs.length > 1 ? rs[1] : rs[0],false,true);\r\n    dn.revision_set_at(rs[0],false,true);\r\n}\r\n\r\ndn.revision_worker_delivery = function(e){\r\n    if(!e.data)\r\n        return; //not sure if this is possible\r\n\r\n    if(e.data.debug)\r\n        console.log(e.data);\r\n        \r\n    var h = dn.file_history;\r\n    //TODO: probably ought to use a more sensivle message system with a string command switching thign...but this is ok for now\r\n    \r\n    if(e.data.status)\r\n        text_multi(h.$revisions_status, e.data.status);\r\n        \r\n    if(e.data.revisions){    \r\n        h.revisions = e.data.revisions;\r\n        e.data.revisions.forEach(function(r){ h.revisionFromEtag[r.etag] = r;});\r\n        dn.display_revision_timeline(e.data.revisions);\r\n        h.worker.postMessage({ showEtag: h.at.etag,\r\n                               fromEtag: h.from.etag }); \r\n    }\r\n    \r\n    if(e.data.revisionDownloaded){\r\n        var r = h.revisionFromEtag[e.data.revisionDownloaded];\r\n        r.$.attr('downloaded',true);\r\n        r.isDownloaded = true;\r\n    }\r\n    \r\n    if(e.data.revsionDiffed){\r\n        h.needToRefindViewChildren = true;\r\n        var r = h.revisionFromEtag[e.data.revsionDiffed];\r\n        r.$.attr('diffed',true);\r\n        r.isDiffed = true;\r\n        \r\n        var newStuff = e.data.newStuffForDom;\r\n        for(var i=0;i<newStuff.length;i++){\r\n            var lines = newStuff[i].lines.map(function(str){return str || \" \"});  \r\n                                            // \"|| space\" thing is a hack for auto height stuff\r\n            h.needToFixHeights = h.needToFixHeights.add(\r\n                            h.$view.insertClonedChildren(newStuff[i].at,h.$new_li,lines)    );            \r\n        }\r\n    }\r\n\r\n    \r\n    if(e.data.vals_ui8buffer){\r\n        \r\n        if(h.needToRefindViewChildren){\r\n            h.$rev_lines_ = h.$view.children();\r\n            h.needToRefindViewChildren = false;\r\n        }\r\n        var $rl_ = h.$rev_lines_;\r\n        \r\n        if(h.needToFixHeights.length){\r\n            text_multi(h.$revisions_status, \"Obtaining line height data...\");\r\n            h.needToFixHeights.fixHeightFromAuto();\r\n            h.needToFixHeights = $([]);\r\n            text_multi(h.$revisions_status, \"Selecting lines...\");\r\n        }\r\n        \r\n        var vals = new Uint8Array(e.data.vals_ui8buffer)\r\n        $rl_.setAttribute('v',function(i){return vals[i]});\r\n            \r\n        // We have to manually set the width of the numbers (our version of ace's gutter)\r\n        switch(e.data.digits){\r\n            case 0:\r\n            case 1:\r\n            case 2:\r\n                h.$view.setAttribute('digits','');\r\n                break;\r\n            case 3:\r\n                h.$view.setAttribute('digits','###');\r\n                break;\r\n            case 4:\r\n                h.$view.setAttribute('digits','####');\r\n                break;\r\n            default:\r\n                h.$view.setAttribute('digits','#####');\r\n        }\r\n    }\r\n    \r\n        \r\n}\r\n","\"use strict\";\r\ndn.find_pane = (function(const_){\r\n\r\nvar el = {};\r\nvar goto_input_has_focus = false; // we don't actually need this, but we keep it for analogy with search\r\nvar AceSearch;\r\nvar AceRange;\r\nvar search_inputs_have_focus = false; // either find itself or replace\r\nvar search_results = [];\r\nvar search_current_match_idx = -1;\r\nvar search_markers = [];\r\nvar search_marker_current = undefined;\r\nvar search_str = \"\";\r\n\r\n\r\n\r\nvar focus_on_input = function(){\r\n    if(dn.g_settings.get('find_goto'))\r\n        el.goto_input.focus();\r\n    else\r\n        el.find_input.focus();\r\n}\r\n\r\nvar on_document_ready = function(){\r\n    AceSearch = ace.require(\"./search\").Search;\r\n    AceRange = ace.require(\"./range\").Range;\r\n\r\n    el.button_case_sensitive = document.getElementById('button_find_case_sensitive');\r\n    el.button_whole_words = document.getElementById('button_find_whole_words');\r\n    el.button_regex = document.getElementById('button_find_regex');\r\n    el.find_input = document.getElementById('find_input');\r\n    el.goto_input = document.getElementById('goto_input');\r\n    el.replace_input = document.getElementById('find_replace_input');\r\n    el.info = document.getElementById('find_info');\r\n    el.search_results = document.getElementById('find_results');\r\n    el.info_overflow = document.getElementById('find_info_overflow');\r\n    el.button_goto = document.getElementById('button_goto');\r\n    el.button_replace = document.getElementById('button_replace');\r\n    el.goto_wrapper = document.getElementById('find_goto_wrapper');\r\n    el.find_wrapper = document.getElementById('find_find_wrapper');\r\n    el.replace_wrapper = document.getElementById('find_replace_wrapper');\r\n    el.button_find_replace_all = document.getElementById('button_find_replace_all');\r\n\r\n    dn.g_settings.addEventListener('VALUE_CHANGED', function(e){\r\n        var new_value = e.newValue;\r\n        switch(e.property){\r\n            case 'find_regex':\r\n            if(new_value)\r\n                el.button_regex.classList.add('selected');\r\n            else\r\n                el.button_regex.classList.remove('selected');\r\n            settings_changed();\r\n            break;\r\n\r\n            case 'find_whole_words':\r\n            if(new_value)\r\n                el.button_whole_words.classList.add('selected');\r\n            else\r\n                el.button_whole_words.classList.remove('selected');\r\n            settings_changed();\r\n            break;\r\n\r\n            case 'find_case_sensitive':\r\n            if(new_value)\r\n                el.button_case_sensitive.classList.add('selected');\r\n            else\r\n                el.button_case_sensitive.classList.remove('selected');\r\n            settings_changed();\r\n            break;\r\n\r\n            case 'find_replace':\r\n            on_replace_toggled(new_value);\r\n            break;\r\n\r\n            case 'find_goto':\r\n            on_goto_toggled(new_value);\r\n            break;\r\n        }\r\n    })\r\n\r\n    el.button_case_sensitive.addEventListener('click', function(){\r\n        dn.g_settings.set('find_case_sensitive', !dn.g_settings.get('find_case_sensitive'));\r\n    })\r\n    el.button_whole_words.addEventListener('click', function(){\r\n        dn.g_settings.set('find_whole_words', !dn.g_settings.get('find_whole_words'));\r\n    })\r\n    el.button_regex.addEventListener('click', function(){\r\n        dn.g_settings.set('find_regex', !dn.g_settings.get('find_regex'));\r\n    })\r\n    el.goto_input.addEventListener('keydown', goto_input_keydown);\r\n    el.goto_input.addEventListener('keyup', goto_input_keyup);\r\n    el.goto_input.addEventListener('blur', goto_input_blur);\r\n    el.goto_input.addEventListener('focus', goto_input_focus);\r\n    el.find_input.addEventListener('keyup', find_input_keyup);\r\n    el.find_input.addEventListener('keydown', find_input_keydown);\r\n    el.find_input.addEventListener('blur', search_inputs_blur);\r\n    el.find_input.addEventListener('focus', search_inputs_focus);\r\n    el.replace_input.addEventListener('blur', search_inputs_blur);\r\n    el.replace_input.addEventListener('focus', search_inputs_focus);\r\n    el.replace_input.addEventListener('keydown', replace_input_keydown);\r\n    el.button_find_replace_all.addEventListener('click', replace_all);\r\n    el.button_replace.addEventListener('click', function(){\r\n        dn.g_settings.set('find_replace', !dn.g_settings.get('find_replace'));\r\n        dn.g_settings.set('find_goto', false);\r\n        el.find_input.focus();\r\n    })\r\n    el.button_goto.addEventListener('click', function(){\r\n        dn.g_settings.set('find_goto', !dn.g_settings.get('find_goto'));\r\n        if(dn.g_settings.get('find_goto'))\r\n            el.goto_input.focus();\r\n        else\r\n            el.find_input.focus();\r\n    })\r\n}\r\n\r\nvar find_shortcut_used = function(e){\r\n    var sel = dn.editor.session.getTextRange(dn.editor.getSelectionRange());\r\n    dn.g_settings.set('find_goto', false);\r\n    dn.g_settings.set('pane', 'pane_find');\r\n    dn.g_settings.set('pane_open', true);\r\n    if(sel){\r\n        el.find_input.value = sel;\r\n        el.find_input.select();\r\n    }\r\n    el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\nvar goto_shortcut_used = function(e){\r\n    dn.g_settings.set('find_goto', true);\r\n    dn.g_settings.set('pane', 'pane_find'); // doing this after the find_active=true, tells the change handler not to put focus back to editor\r\n    dn.g_settings.set('pane_open', true);\r\n    el.goto_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\nvar replace_shortcut_used = function(e){\r\n    dn.g_settings.set('find_replace', true);\r\n    find_shortcut_used(e);   \r\n}\r\n\r\nvar on_goto_toggled = function(new_value){\r\n    // This just toggles the display, it does not deal with focus/blur, which may happen afterwards\r\n    // as a consequence if the relevant inputs previously had the focus.\r\n\r\n    if(new_value){\r\n        el.goto_wrapper.style.display = '';\r\n        el.find_wrapper.style.display = 'none';\r\n        el.button_goto.classList.add('selected');\r\n        el.info.textContent = 'goto line inactive';\r\n        el.replace_wrapper.style.display = 'none';\r\n    }else{\r\n        el.goto_wrapper.style.display = 'none';\r\n        el.find_wrapper.style.display = '';\r\n        el.button_goto.classList.remove('selected');\r\n        el.info.textContent = 'search inactive';\r\n        if (dn.g_settings.get('find_replace'))\r\n            el.replace_wrapper.style.display = '';\r\n    }\r\n}\r\n\r\nvar on_replace_toggled = function(new_value){\r\n    if(new_value){\r\n        el.button_replace.classList.add('selected');\r\n        if(!dn.g_settings.get('find_goto'))\r\n            el.replace_wrapper.style.display = '';\r\n    }else{\r\n        el.replace_wrapper.style.display = 'none';\r\n        el.button_replace.classList.remove('selected');\r\n    }\r\n    if(search_inputs_have_focus)\r\n        select_search_result_idx(search_current_match_idx);\r\n}\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// goto :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// the implementation of goto is simpler than for search, so we start with it...\r\n\r\nvar goto_input_focus = function(){\r\n    goto_input_has_focus = true;\r\n    el.info.textContent = \"type to goto line\";\r\n    perform_goto();\r\n}\r\n\r\nvar goto_input_blur = function(e){\r\n    goto_input_has_focus = false;\r\n    el.info.textContent = \"goto line inactive\"; \r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\nvar perform_goto = function(){\r\n    // called by find_goto_input_focus and find_goto_keyup\r\n    var validated_str = el.goto_input.value.replace(/[^\\d]/,'');\r\n    if (validated_str !== el.goto_input.value)\r\n        el.goto_input.value = validated_str;\r\n    if(validated_str === \"\")\r\n        return;\r\n    var num = parseInt(validated_str);\r\n    dn.editor.gotoLine(num);\r\n    dn.editor.navigateLineEnd();\r\n}\r\n\r\nvar goto_input_keyup = perform_goto; //alias\r\n\r\nvar goto_input_keydown = function(e){\r\n    // keydown is fired repeatedly when key remains down\r\n    if(e.which == WHICH.DOWN){\r\n        el.goto_input.value = parseInt(el.goto_input.value.replace(/[^\\d]/,''))+1;\r\n        perform_goto();\r\n        e.preventDefault();\r\n    }else if(e.which == WHICH.UP){\r\n        el.goto_input.value = parseInt(el.goto_input.value.replace(/[^\\d]/,''))-1;\r\n        perform_goto();\r\n        e.preventDefault();\r\n    } else if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false);\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    }\r\n}\r\n\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// search :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n\r\n    \r\n\r\nvar search_inputs_focus = function(e){\r\n    if(e.currentTarget == el.find_input){\r\n        el.find_input.tabIndex = 101;\r\n        el.replace_input.tabIndex = 102;   \r\n    } else {\r\n        el.find_input.tabIndex = 102;\r\n        el.replace_input.tabIndex = 101;   \r\n    }\r\n    if(search_inputs_have_focus)\r\n        return; // focus was transfered between replace/find inputs\r\n\r\n    search_inputs_have_focus = true;\r\n    dn.editor.setHighlightSelectedWord(false);  \r\n    perform_search();\r\n}\r\n\r\nvar search_inputs_blur = function(e){\r\n    if(e.relatedTarget == el.replace_input  || e.relatedTarget == el.find_input)\r\n        return; // focus is transfering between replace/find inputs\r\n\r\n    search_inputs_have_focus = false;\r\n\r\n    // remove all search_markers\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<search_markers.length; ii++)\r\n        session.removeMarker(search_markers[ii]);\r\n    if (search_marker_current !== undefined){\r\n        session.removeMarker(search_marker_current);\r\n        search_marker_current = undefined;\r\n    }\r\n\r\n    // reset widget display\r\n    el.info.textContent = \"search inactive\";\r\n    el.search_results.innerHTML = \"\";\r\n    el.info_overflow.textContent = \"\";\r\n\r\n    // forget last search\r\n    search_markers = [];\r\n    search_results = [];\r\n    search_current_match_idx = -1;\r\n\r\n    // forget last selection in input (in preparation for next time it gets focus)\r\n    el.find_input.setSelectionRange(el.find_input.selectionEnd, el.find_input.selectionEnd);\r\n\r\n     // we had this on false during find\r\n    dn.editor.setHighlightSelectedWord(true);\r\n\r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\nvar build_search_options = function(){\r\n    var str = el.find_input.value;\r\n    var use_reg_exp = dn.g_settings.get('find_regex');\r\n    var sensitive = dn.g_settings.get('find_case_sensitive');\r\n    if(use_reg_exp){\r\n        var re = undefined;\r\n        re = new RegExp(str, sensitive ? \"g\" : \"gi\"); //cam throw error\r\n    }\r\n    return {\r\n    needle: use_reg_exp ? re : str,\r\n    wrap: true,\r\n    caseSensitive: sensitive,\r\n    wholeWord: dn.g_settings.get('find_whole_words'),\r\n    regExp: use_reg_exp };\r\n}\r\n\r\nvar perform_search = function(){\r\n    // called by find_input_focus, find_settings_changed, and on keyup in the input, when text has changed\r\n\r\n    // clear previous find (but leave selection for now)\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<search_markers.length; ii++)\r\n        session.removeMarker(search_markers[ii]);\r\n    if(search_marker_current !== undefined){\r\n        session.removeMarker(search_marker_current)\r\n        search_marker_current = undefined;\r\n    }\r\n    search_markers = [];\r\n    search_results = [];\r\n    search_current_match_idx = -1;\r\n    el.search_results.innerHTML = \"\";  \r\n    el.info_overflow.textContent = \"\";\r\n    el.info.textContent = \"\";\r\n    search_str = el.find_input.value; // we only store it to make it easier for key_down to check for true changes\r\n\r\n    var search_options = undefined;\r\n    try{\r\n        search_options = build_search_options();\r\n    } catch (e){\r\n        el.info.textContent = escape_str(e.message); //TODO: could force first letter to lower case\r\n    }\r\n\r\n    if(search_options === undefined){\r\n        // failed regex, don't show any search_results\r\n        dn.editor.selection.clearSelection();\r\n\r\n    } else if(search_str == \"\"){\r\n        // empty string (including empty regex), dont show any search_results\r\n        el.info.textContent = \"type to search. \" /*+ dn.ctrl_key + \"-up/down for history.\"*/;\r\n        dn.editor.selection.clearSelection();\r\n        \r\n    } else {\r\n        // valid regex or pure search_str search..\r\n\r\n        // This is the actual search\r\n        var search = new AceSearch();\r\n        search.setOptions(search_options);\r\n        search_results = search.findAll(session);\r\n\r\n        if(search_results.length === 0){\r\n            // No search_results to display, life is easy...\r\n            el.info.textContent = \"no matches found.\";\r\n            el.info_overflow.textContent = \"\";\r\n            dn.editor.selection.clearSelection();\r\n\r\n        }else{\r\n            // Right, we got some search_results ....\r\n\r\n            // Work out which result we should consider the current match.\r\n            var selected_range = session.getSelection().getRange();\r\n            for(var ii=0; ii<search_results.length; ii++) \r\n                if(search_results[ii].end.row > selected_range.start.row  || \r\n                    (search_results[ii].end.row == selected_range.start.row &&\r\n                     search_results[ii].end.column >= selected_range.start.column))\r\n                break;\r\n            var current_match_idx = (ii == search_results.length ? search_results.length-1 : ii);\r\n\r\n            // Add search_markers into the editor to show *all* the search_results\r\n            for(var ii=0; ii<search_results.length; ii++)\r\n                search_markers.push(session.addMarker(search_results[ii], \"find_match_marker\", \"find_match_marker\", false));\r\n\r\n            // augment the search_results with their idx, this is useful for the subselection stuff\r\n            for(var ii=0; ii<search_results.length; ii++)\r\n                search_results[ii] = {range: search_results[ii], idx: ii};\r\n\r\n            // Render a subset of the search_results into the widget and mark & select the current match\r\n            select_search_result_idx(current_match_idx);\r\n        }\r\n    }\r\n\r\n}\r\n\r\nvar select_search_result_idx = function(new_idx){\r\n    // This is called within find_perform_search when a new search returns some search_results\r\n    // it's also called when we move through the search_results without changing the search and\r\n    // when replace_changed is called when find input already has the focus.   */\r\n\r\n    // Get a small sub set of search_results to show in the widget.\r\n    // We carefully implement some wrapping logic, which is a bit fiddly.\r\n    search_current_match_idx = new_idx;\r\n\r\n    var session = dn.editor.getSession();\r\n    if (search_marker_current !== undefined){\r\n        session.removeMarker(search_marker_current);\r\n        search_marker_current = undefined;\r\n    }\r\n\r\n    var search_results_sub = [];\r\n    \r\n    var replace_is_showing = dn.g_settings.get('find_replace');\r\n\r\n    var max_search_results = const_.find_max_results_half*2 + (replace_is_showing ? 0 : 1);\r\n\r\n    if(search_results.length <= max_search_results){\r\n        search_results_sub = search_results;\r\n    }else{\r\n        var n_pre = const_.find_max_results_half - (replace_is_showing ? 1 : 0);\r\n        var n_post = const_.find_max_results_half;\r\n        if(search_current_match_idx < n_pre){\r\n            search_results_sub = search_results_sub.concat(search_results.slice(search_current_match_idx - n_pre));\r\n            search_results_sub = search_results_sub.concat(search_results.slice(0, search_current_match_idx));\r\n        } else {\r\n            search_results_sub = search_results_sub.concat(search_results.slice(search_current_match_idx - n_pre, search_current_match_idx));\r\n        }\r\n        search_results_sub.push(search_results[search_current_match_idx]); \r\n        if(search_current_match_idx + n_post >= search_results.length){\r\n            search_results_sub = search_results_sub.concat(search_results.slice(search_current_match_idx + 1));\r\n            search_results_sub = search_results_sub.concat(search_results.slice(0, n_post + 1 - (search_results.length - search_current_match_idx)));\r\n        } else {\r\n            search_results_sub = search_results_sub.concat(search_results.slice(search_current_match_idx + 1, search_current_match_idx + n_post + 1));\r\n        }\r\n    }\r\n\r\n    // Now lets build the html to show the subset of search_results in the widget\r\n    var show_replace_buttons = dn.g_settings.get('find_replace');\r\n    var html = \"\";\r\n    for(var ii=0; ii<search_results_sub.length; ii++){\r\n        var row = search_results_sub[ii].range.start.row;\r\n        var col = search_results_sub[ii].range.start.column;\r\n        var prefix_range = new AceRange(row, Math.max(0, col-const_.find_max_prefix_chars), row, col);\r\n        var pre_ellipses = col > const_.find_max_prefix_chars; //TODO: deal with indent better\r\n        row = search_results_sub[ii].range.end.row;\r\n        col = search_results_sub[ii].range.end.column;\r\n        var suffix_range = new AceRange(row, col, row, col+const_.find_max_suffix_chars);\r\n        html += \"<div class='find_result_item\" + (search_results_sub[ii].idx==search_current_match_idx? \" find_result_current\" : \"\") + \"'>\" +\r\n                    \"<div class='find_result_line_num'>\" + (row+1) + \"</div>\" +\r\n                    \"<div class='find_result_text'>\" +\r\n                        \"<div class='find_result_text_inner'>\" +\r\n                            (pre_ellipses ? \"&#8230;\" : \"\") + escape_str(session.getTextRange(prefix_range)) +\r\n                            \"<span class='find_result_match'>\" + escape_str(session.getTextRange(search_results_sub[ii].range)) + \"</span>\" +\r\n                            escape_str(session.getTextRange(suffix_range)) +\r\n                        \"</div>\" +\r\n                    \"</div>\" +\r\n                    (show_replace_buttons ? \"<div class='button inline_button replace_single_result' title='replace'>r</div>\" : \"\") + \r\n                \"</div>\";\r\n    }\r\n    el.search_results.innerHTML = html;\r\n    var els = el.search_results.getElementsByClassName('find_result_item');\r\n    for(var ii=0; ii<els.length; ii++) if(search_results_sub[ii].idx !== search_current_match_idx)\r\n        els[ii].addEventListener('click', search_result_click(search_results_sub[ii].idx));\r\n    if(show_replace_buttons){\r\n        var els = el.search_results.getElementsByClassName('replace_single_result')\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].addEventListener('click', search_replace_result_click(search_results_sub[ii].idx));\r\n    }\r\n\r\n    if(search_results.length > max_search_results)\r\n        el.info_overflow.textContent = \"... and \" + (search_results.length - max_search_results) + \" more matches\";\r\n    else\r\n        el.info_overflow.textContent = \"\";\r\n\r\n    // do the special marker for the current selection and actually select it\r\n    search_marker_current = session.addMarker(search_results[search_current_match_idx].range, \"find_current_match_marker\", \"find_current_match_marker\", false);\r\n    dn.editor.selection.setSelectionRange(search_results[search_current_match_idx].range, false);\r\n    dn.editor.renderer.scrollSelectionIntoView();\r\n}\r\n\r\nvar settings_changed = function(){\r\n    if(search_inputs_have_focus || \r\n       (dn.g_settings.get('pane') === 'pane_find' && dn.g_settings.get('pane_open') &&  el.find_input.value))\r\n        perform_search();\r\n}\r\n\r\nvar search_result_click = function(ii){\r\n    // this can only be called while find input has the focus\r\n    return function(e){select_search_result_idx(ii);};\r\n}\r\n\r\nvar search_replace_result_click = function(ii){\r\n    return function(e){\r\n        replace_result_idx(ii);\r\n        e.stopPropagation(); // prevent selecting item\r\n    }\r\n}\r\n\r\nvar find_input_keyup = function(e){ \r\n    //we need keyup here in order that the val has the new character or new backspace\r\n    if(e.which == WHICH.ENTER || e.which == WHICH.ESC || e.which == WHICH.UP || e.which == WHICH.DOWN)\r\n        return; \r\n    if(search_str == el.find_input.value)\r\n        return;\r\n    perform_search()\r\n}\r\n\r\nvar find_input_keydown = function(e){ \r\n    // we want keydown here so that we can get repeated firing with keydown (i think on most browsers)\r\n\r\n    if ((e.which == WHICH.ENTER && !e.shiftKey) || (!e.ctrlKey && e.which == WHICH.DOWN)){\r\n        //find next\r\n        select_search_result_idx(search_current_match_idx + 1 < search_results.length ? \r\n                                    search_current_match_idx + 1 \r\n                                  : 0);\r\n        e.preventDefault();\r\n        return;\r\n    }else if((e.which == WHICH.ENTER && e.shiftKey) || (!e.ctrlKey && e.which == WHICH.UP)){\r\n        //find previous\r\n        select_search_result_idx(search_current_match_idx - 1 < 0 ? \r\n                                    search_results.length -1 \r\n                                  : search_current_match_idx - 1);\r\n        e.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false); // this focuses on the editor, and blurs the find_input\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        return;   \r\n    }\r\n\r\n}\r\n\r\nvar replace_input_keydown = function(e){\r\n    if(e.which == WHICH.ENTER){\r\n        if(e.ctrlKey || e.shiftKey)\r\n            replace_all();\r\n        else\r\n            replace_result_idx(search_current_match_idx);\r\n        e.preventDefault();\r\n    }else{\r\n        find_input_keydown(e); // up, down search_results and esc\r\n    }\r\n}\r\n\r\nvar replace_all = function(e){\r\n    try{\r\n        var options = build_search_options();\r\n    } catch (e) {\r\n        dn.show_error(e.message);\r\n        return;\r\n    }\r\n    dn.editor.replaceAll(el.replace_input.value, options);\r\n    dn.focus_editor();\r\n}\r\n\r\nvar replace_result_idx = function(idx){\r\n    var range = search_results[idx].range;\r\n    // we use undocumented ACE API to avoid messing around tryinng to force it to use the exact range we wanted\r\n    dn.editor.$search.set(build_search_options()); //this is needed so that $tryReplace knows what to do with regex'es\r\n    dn.editor.$tryReplace(range, el.replace_input.value) // returns true on success, but do we care?\r\n    perform_search();\r\n}\r\n\r\n\r\nreturn {\r\n    focus_on_input: focus_on_input,\r\n    on_document_ready: on_document_ready,\r\n    on_find_shortcut: find_shortcut_used,\r\n    on_replace_shortcut: replace_shortcut_used,\r\n    on_goto_shortcut: goto_shortcut_used\r\n}\r\n\r\n})(dn.const);","\"use strict\";\r\n\r\ndn.platform = (function(){\r\n    if(navigator.platform.indexOf(\"Win\") >-1)\r\n        return \"Windows\";\r\n    else if(navigator.platform.indexOf(\"Linux\") >-1)\r\n        return \"Linux\";\r\n    else if(navigator.platform.indexOf(\"Mac\")>-1)\r\n        return \"Mac\";\r\n        \r\n    return null;\r\n})();\r\n\r\ndn.create_pane_shortcuts = function(){\r\n//This is hardly the world's most efficient way of doing this....(but it probably doesn't matter)...\r\n\r\n    var arry = dn.shortcuts_list;\r\n    var dict = {};\r\n    var platform = dn.platform;\r\n\r\n    if(platform == \"Windows\" || platform == \"Linux\"){\r\n       for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts[1];\r\n        }\r\n    }else if(platform == \"Mac\"){\r\n        for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts.length > 2? parts[2] : parts[1];\r\n        }\r\n    }else{\r\n        //TODO: show something here, maybe let user switch, maybe have touch info for ipad & android.\r\n    }\r\n    \r\n    var html = [];\r\n    for(var action in dict)\r\n        html.push(\"<div class='shortcut_item'><div class='shortcut_action'>\" + \r\n                   action + \"</div><div class='shortcut_key'>\" + dict[action].replace(\",\",\"<br>\") +\r\n                   \"</div></div>\");\r\n    for(var action in dn.tooltip_info)if(action in dict)\r\n        dn.tooltip_info[action] += dict[action];\r\n\r\n    dn.el.pane_help_shortcuts.innerHTML =  [\r\n        \"<div class='widget_box_title shortcuts_title'>Keyboard Shortcuts \",\r\n             platform ? \"(\" + platform + \")\" : \"\" ,\r\n        \"</div>\",\r\n        \"<div class='shortcuts_header_action'>action</div><div class='shortcuts_header_key'>key</div>\",\r\n        \"<div class='shortcuts_list'>\",\r\n        html.join(''),\r\n        \"</div>\"].join('');\r\n\r\n};\r\n\r\ndn.esc_pressed = function(e){\r\n    dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n\r\n    if(dn.g_settings.get('pane_open') && dn.g_settings.get('pane') == 'pane_find')\r\n        dn.find_pane.focus_on_input();\r\n    e.preventDefault();\r\n}\r\n\r\n\r\n\r\ndn.make_keyboard_shortcuts = function(){\r\n    //perviously was using ace for handling these shorcuts because it neater (and efficient?) but it was\r\n    //annoying trying to ensure the editor always had focus, and not clear what to do when the editor wasn't showing.\r\n    \r\n    //we have to delete the default ace commands linked to the keys we care about\r\n    dn.editor.commands.removeCommands([\r\n        \"find\",\"findprevious\",\"findnext\",\"replace\",\"jumptomatching\",\"sortlines\",\"selecttomatching\",\"gotoline\"]);\r\n\r\n    //then add new commands on to the document using keymaster.js...\r\n    key('command+s, ctrl+s,  ctrl+alt+s,  command+alt+s', dn.file_pane.on_save_shorcut);\r\n    key('command+p, ctrl+p,  ctrl+alt+p,  command+alt+p', dn.file_pane.do_print_shorcut);\r\n    key('command+o, ctrl+o,  ctrl+alt+o,  command+alt+o', dn.do_open);\r\n    key('command+n, ctrl+n,  ctrl+alt+n,  command+alt+n', dn.do_new);\r\n    key('command+l, ctrl+l,  ctrl+alt+l,  command+alt+l', dn.find_pane.on_goto_shortcut);\r\n    key('command+f, ctrl+f,  ctrl+alt+f,  command+alt+f', dn.find_pane.on_find_shortcut); \r\n    key('command+r, ctrl+r,  ctrl+alt+r,  command+alt+r' + \r\n       ', command+g, ctrl+g,  ctrl+alt+g,  command+alt+g', dn.find_pane.on_replace_shortcut);\r\n    key('command+h, ctrl+h,  ctrl+alt+h,  command+alt+h', dn.file_pane.start_revisions_worker);\r\n    key('esc', dn.esc_pressed);\r\n    key.filter = function(){return 1;}\r\n\r\n    // it seems like the clipboard history cycling only works the old way, i.e. using ace....\r\n    var HashHandler = require(\"ace/keyboard/hash_handler\").HashHandler\r\n    var extraKeyEvents = new HashHandler([\r\n        {bindKey: {win: \"Ctrl-Left\",mac: \"Command-Left\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Down\",mac: \"Command-Down\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Right\",mac:\"Command-Right\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right},\r\n        {bindKey: {win: \"Ctrl-Up\",mac:\"Command-Up\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right}\r\n    ]);\r\n    dn.editor.keyBinding.addKeyboardHandler(extraKeyEvents);\r\n\r\n    // Change \"ctrl\" to \"cmd\" if on Mac\r\n    dn.ctrl_key = \"crtl\"\r\n    if(dn.platform == 'Mac'){\r\n        dn.ctrl_key = 'cmd';\r\n        var els = dn.getElementsByClassName('ctrl_key');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].textContent = 'cmd'\r\n    }\r\n}\r\n","\"use strict\";\r\n// DRIVE NOTEPAD 2016\r\n// by DM\r\n\r\ndn.version_str = '2016a';\r\n\r\n// ############################\r\n// Constants and defaults, see alsp info.js\r\n// ############################\r\n\r\ndn.can_show_drag_drop_error = true;\r\ndn.is_showing_history = false;\r\n\r\ndn.status = {\r\n\r\n    file_body: 1, // 0 while getting, 1 when done or irrelevant, -1 if failed\r\n    file_meta: 1, // 0 while getting, 1 when done or irrelevant, -1 if failed\r\n    file_new: 1, // 0 while creating a new file, 1 when done or irrelevant, -1 if failed\r\n\r\n    file_sharing: 0, // after launching the sharing dialog this is set to -1 for everafter\r\n\r\n    authentication: 0, // 0 while authenticating, 1 when done\r\n\r\n    popup_active: 0, // 0 or 1, i.e. true or false\r\n    local_settings: 0, // 1 when local settings have been loaded\r\n    realtime_settings: 0, // 1 when realtime settings have been loaded\r\n\r\n    // 1: success/no save active, \r\n    // 0: in progress\r\n    // -1: failure, and abandonded further attempts (never used)\r\n    save_body: 1, \r\n    save_title: 1,\r\n    save_other: 1,\r\n\r\n    unsaved_changes: 0 // 1 true, 0 false\r\n}\r\n\r\ndn.the_file = new dn.FileModel();\r\n\r\ndn.change_line_history = [];\r\ndn.last_change = null;\r\ndn.change_line_classes =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_',8,5)\r\ndn.change_line_classes_rm =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_rm',8,5)\r\n\r\n\r\ndn.el = dn.el || {};\r\n\r\ndn.show_user_info = function(a){\r\n    dn.user_info = a.result;\r\n    dn.el.user_name.textContent = a.result.name;\r\n}\r\n\r\n\r\ndn.set_editor_newline = function(){\r\n    // view for dn.the_file model\r\n    dn.editor.session.setNewLineMode(dn.the_file.properties_chosen.newline);\r\n}\r\n\r\n\r\n// ############################\r\n// Open stuff\r\n// ############################\r\n\r\ndn.open_button_click = function(){\r\n    gapi.load('picker', function(){\r\n        var view = new google.picker.View(google.picker.ViewId.DOCS);\r\n        try{\r\n            if(!dn.open_picker){\r\n                dn.open_picker = new google.picker.PickerBuilder()\r\n                .enableFeature(google.picker.Feature.NAV_HIDDEN)\r\n                .setAppId(dn.client_id) /* the drive scope requires explicit permission to open each file, and by providing the client_id here you get it for the chosen file */\r\n                .setOAuthToken(gapi.auth.getToken().access_token) /* this gives permission to open the picker..you can do it wtihout a user-specific access_token, but we have one so lets use it */\r\n                .addView(view)\r\n                .setCallback(dn.picker_callback)\r\n                .build();        \r\n                if(!dn.open_picker)\r\n                    throw \"could not build picker\";\r\n            }\r\n            dn.open_picker.setVisible(true);\r\n        } catch (e){\r\n            dn.show_error(\"\" + e);\r\n        }\r\n    });\r\n\r\n}\r\n\r\ndn.picker_callback = function(data) {\r\n    if (data.action == google.picker.Action.PICKED) {\r\n        var file_id = data.docs[0].id;\r\n        var url = \"?state=\" + JSON.stringify({\r\n            action: \"open\",\r\n            userId: dn.url_user_id,\r\n            ids: [file_id]\r\n        });\r\n        window.location = url;\r\n    }else if(data.action == \"cancel\"){\r\n        if(dn.open_new_tab)\r\n            dn.open_new_tab.close();\r\n        dn.focus_editor();\r\n    }\r\n    dn.open_new_tab = undefined;\r\n}\r\n\r\n\r\n// ############################\r\n// Widget stuff\r\n// ############################\r\n\r\ndn.show_help_inner = function(inner_pane){\r\n    // expects string 'shorcuts' or 'tips',  any other values shows main\r\n\r\n    dn.el.pane_help_shortcuts.style.display = 'none';\r\n    dn.el.pane_help_tips.style.display = 'none';\r\n    dn.el.pane_help_main.style.display = 'none';\r\n\r\n    dn.el.button_shortcuts.classList.remove('selected');\r\n    dn.el.button_tips.classList.remove('selected');\r\n    \r\n    if(inner_pane == 'tips'){\r\n        dn.el.pane_help_tips.style.display = '';\r\n        dn.el.button_tips.classList.add('selected');\r\n    } else if(inner_pane == 'shortcuts'){\r\n        dn.el.pane_help_shortcuts.style.display = '';\r\n        dn.el.button_shortcuts.classList.add('selected');\r\n    } else {\r\n        dn.el.pane_help_main.style.display = '';\r\n    }\r\n}\r\n\r\ndn.toggle_permission = function(state){\r\n    var el = dn.el.pane_permissions;\r\n    if(state){\r\n        if(!dn.status.permissions_showing){\r\n            dn.status.permissions_showing = 1;\r\n            el.style.display = '';\r\n            dn.g_settings.set('pane', 'pane_help');\r\n            dn.g_settings.set('pane_open', true);\r\n            css_animation(dn.el.the_widget, 'shake', function(){}, dn.const.error_delay_ms);\r\n        }\r\n    } else {\r\n        dn.status.permissions_showing = 0;\r\n        el.style.display = 'none';\r\n    }\r\n}\r\n\r\ndn.show_pane = function(id){\r\n    if(id === \"pane_permissions\")\r\n        return dn.toggle_permission(true);\r\n\r\n    var el = document.getElementById(id);\r\n\r\n    // el can be undefined/null to hide everything\r\n    for(var ii=0; ii < dn.el.widget_content.children.length; ii++)\r\n        if(dn.el.widget_content.children[ii] !== el && dn.el.widget_content.children[ii] !== dn.el.pane_permissions){\r\n            dn.el.widget_content.children[ii].style.display = 'none';\r\n            var el_icon = dn.menu_icon_from_pane_id[dn.el.widget_content.children[ii].id];\r\n            if(el_icon)\r\n                el_icon.classList.remove('icon_selected');\r\n    }\r\n\r\n    if(el){\r\n        el.style.display = '';\r\n        var el_icon = dn.menu_icon_from_pane_id[el.id];\r\n        if(el_icon)\r\n            el_icon.classList.add('icon_selected')\r\n    }else{\r\n        dn.g_settings.set('pane_open', false);\r\n    }\r\n}\r\n\r\ndn.widget_mouse_down = function(e){\r\n    dn.widget_mouse_down_info = {\r\n            off_left: -e.clientX,\r\n            off_top: -e.clientY,\r\n            start_time: Date.now(),\r\n            is_dragging: e.button !== 0};\r\n    document.addEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.addEventListener('mouseup', dn.document_mouse_up_widget);\r\n}\r\n\r\ndn.document_mouse_move_widget = function(e){\r\n    var x = e.clientX+dn.widget_mouse_down_info.off_left;\r\n    var y = e.clientY+dn.widget_mouse_down_info.off_top;\r\n    if(!dn.widget_mouse_down_info.is_dragging){\r\n        dn.widget_mouse_down_info.is_dragging = (Date.now() - dn.widget_mouse_down_info.start_time > dn.const.drag_delay_ms)\r\n                                              || (x*x + y*y > dn.const.drag_shift_px * dn.const.drag_shift_px);\r\n    }\r\n    if(dn.widget_mouse_down_info.is_dragging)\r\n        translate(dn.el.the_widget, x, y);\r\n    e.stopPropagation();\r\n\r\n};\r\n\r\ndn.document_mouse_up_widget = function(e){\r\n    document.removeEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.removeEventListener('mouseup', dn.document_mouse_up_widget);\r\n\r\n    if(dn.widget_mouse_down_info.is_dragging){\r\n        var pos = dn.el.the_widget.getBoundingClientRect();\r\n        translate(dn.el.the_widget, 0, 0);\r\n    \r\n        //work out what widget_anchor should be\r\n        var widget_w = dn.el.the_widget.offsetWidth;\r\n        var widget_h = dn.el.the_widget.offsetHeight;\r\n        var window_w = window.innerWidth;\r\n        var window_h = window.innerHeight;\r\n        var anchor = []\r\n        if(pos.left < window_w - (pos.left + widget_w)){\r\n            anchor[0] = 'l'; //anchor left side by window width percentage\r\n            anchor[1] = Math.max(0,pos.left/window_w * 100);\r\n        }else{\r\n            anchor[0] = 'r'; //anchor right side by window width percentage\r\n            anchor[1] = Math.max(0,(window_w - (pos.left + widget_w))/window_w * 100);\r\n        }\r\n        if(pos.top < window_h - (pos.top+ widget_h)){\r\n            anchor[2] = 't'; //anchor top side by window height percentage\r\n            anchor[3] = Math.max(0,pos.top/window_h * 100);\r\n        }else{\r\n            anchor[2] = 'b'; //anchor bottom side by window height percentage\r\n            anchor[3] = Math.max(0,(window_h - (pos.top + widget_h))/window_h * 100);\r\n        }\r\n\r\n        if(dn.g_settings)\r\n            dn.g_settings.set(\"widget_anchor\",anchor); \r\n\r\n    }else{\r\n        dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n    }\r\n    dn.widget_mouse_down_info = undefined;\r\n};\r\n\r\ndn.widget_apply_anchor = function(anchor){\r\n    anchor = Array.isArray(anchor) ? anchor : dn.g_settings.get('widget_anchor');\r\n    var widget_w = dn.el.the_widget.offsetWidth;\r\n    var widget_h = dn.el.the_widget.offsetHeight;\r\n    var window_w = window.innerWidth;\r\n    var window_h = window.innerHeight;\r\n\r\n    if(anchor[0] == 'l'){\r\n        // horizontal position is anchored to a fixed percentage of window width on left of widget\r\n        if(window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = '0px'; //if the widget would overlap the right edge, then instead put it precisely on the right edge\r\n        }else{\r\n            dn.el.the_widget.style.left = anchor[1] + '%';\r\n            dn.el.the_widget.style.right = ''; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.add('flipped');\r\n        dn.el.widget_content.classList.add('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.add('flipped');\r\n\r\n    }else{\r\n        // horizontal position is anchored to a fixed percentage of window width on right of widget\r\n        if( window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = '0px';\r\n            dn.el.the_widget.style.right = ''; //if the widget would overlap the left edge, then instead put it precisely on the left edge\r\n        }else{\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = anchor[1] + '%'; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.remove('flipped');\r\n        dn.el.widget_content.classList.remove('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.remove('flipped');\r\n    }\r\n\r\n    if(anchor[2] == 't'){\r\n        // vertical position is anchored to a fixed percentage of window height on top of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = '0px';  \r\n        }else{\r\n            dn.el.the_widget.style.top = anchor[3] + '%';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }\r\n    }else{\r\n        // vertical position is anchored to a fixed percentage of window height on bottom of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = '0px';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }else{\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = anchor[3] + '%'; \r\n        }\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\ndn.toggle_widget = function(state){\r\n    // provide argument \"true\" to open widget, \"false\" to close\r\n    if(state){\r\n        dn.el.widget_menu.style.display = '';\r\n        dn.el.widget_content.style.display = '';\r\n    }else{\r\n        dn.el.widget_menu.style.display = 'none';\r\n        dn.el.widget_content.style.display = 'none';\r\n    }\r\n}\r\n\r\ndn.show_status = function(){\r\n    // TODO: drag-drop from disk\r\n    var s = ''\r\n\r\n    if (dn.status.file_new === 1 && dn.status.file_meta === 1 && dn.status.file_body === 1){\r\n        s = dn.the_file.title;\r\n        var extra = [];\r\n        if(dn.the_file.is_brand_new)\r\n            extra.push(\"ex nihilo omnia...\");\r\n        if(dn.the_file.is_read_only)\r\n            extra.push(\"read-only\");\r\n        if(dn.the_file.is_shared)\r\n            extra.push(\"shared\");\r\n        if(dn.status.file_sharing == -1)\r\n            extra.push(\"sharing status unknown\");\r\n        if(dn.status.unsaved_changes)\r\n            extra.push(\"unsaved changes\");\r\n        if(dn.status.save_body == 0){\r\n            extra.push(\"saving document\"); // this means that *at least* the body is being saved, possibly more\r\n        } else {\r\n            if(dn.status.save_title == 0)\r\n                extra.push(\"updating title\");\r\n            if(dn.status.save_other == 0)\r\n                extra.push(\"updating file properties\")\r\n        } \r\n        if(extra.length)\r\n            s += \"\\n[\" + extra.join(', ') + \"]\"; \r\n    }else if(dn.status.file_new === 0)\r\n        s = \"Creating new file\";\r\n    else if(dn.status.file_new === -1)\r\n        s = \"Failed to create new file\";\r\n    else if(dn.status.file_meta === 0 && dn.status.file_body === 0)\r\n        s = \"Loading file:\\n\" + dn.the_file.file_id;\r\n    else if(dn.status.file_meta === 1 && dn.status.file_body === 0)\r\n        s = \"Loading \" + (dn.the_file.is_read_only? 'read-only ' : '' ) + \r\n                \"file:\\n\" + dn.the_file.title;\r\n    else if(dn.status.file_meta === 0 && dn.status.file_body === 1)\r\n        s = \"Loading metadata for file:\\n\" + dn.the_file.file_id;\r\n    else if(dn.status.file_meta === 1) // and -1\r\n        s = \"Failed to download \" + (dn.the_file.is_read_only? 'read-only ' : '' )\r\n                +  \"file:\\n\" + dn.the_file.title;\r\n    else if(dn.status.file_body === 1) // and -1\r\n        s = \"Failed to download metadata for file:\\n\" + dn.the_file.file_id;\r\n    else // file_body and file_meta both -1\r\n        s = \"Failed to load file:\\n\" + dn.the_file.file_id;\r\n    \r\n\r\n    if(dn.status.authentication != 1){\r\n        // auth in progress or failed\r\n        if (s)\r\n            s += \"\\n\";\r\n        if(dn.status.authorization == -1)\r\n            s += \"Authorization required...\";\r\n        else if(dn.status.popup_active)\r\n            s += \"Login/authenticate with popup...\";\r\n        else\r\n            s += \"Authenticating...\";\r\n    }\r\n\r\n    text_multi(dn.el.widget_text, s, true);\r\n\r\n    if(dn.status.save_body == 0 || dn.status.save_title == 0 || dn.status.save_other == 0)\r\n        dn.el.widget_pending.style.display = '';\r\n    else\r\n        dn.el.widget_pending.style.display = 'none';\r\n}\r\n\r\ndn.show_error = function(message){\r\n    console.log(message); //it's just useful to do this too\r\n    text_multi(dn.el.widget_error_text, message,true);\r\n    dn.el.widget_error.style.display = '';\r\n    css_animation(dn.el.the_widget, 'shake', function(){\r\n        dn.el.widget_error.style.display = 'none';\r\n    }, dn.const.error_delay_ms);\r\n};\r\n\r\ndn.set_drive_link_to_folder = function(){\r\n    var els = document.getElementsByClassName('link_drive');\r\n    var href = dn.the_file.folder_id ? \r\n                'https://drive.google.com/#folders/' + dn.the_file.folder_id \r\n                : 'https://drive.google.com';\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].href = href;\r\n    // TODO: set new links to have this folder too\r\n}\r\n\r\n\r\n// ############################\r\n// Settings stuff\r\n// ############################\r\n\r\n\r\ndn.show_app_data_document = function(doc){\r\n\r\n    var old_temp_g_settings = dn.g_settings;\r\n    dn.g_settings = doc.getModel().getRoot();\r\n\r\n    // some settings we want to override the cloud values with changes we made locally,\r\n    // other settings may have been missing in the cloud entirely.\r\n    console.log(\"Transfering to realtime model for settings.\")\r\n    old_temp_g_settings.transfer_all_listeners(dn.g_settings);\r\n    var existing_cloud_keys = dn.g_settings.keys();\r\n    for(var s in dn.default_settings)\r\n        if(s in old_temp_g_settings.get_keeps() || existing_cloud_keys.indexOf(s) == -1)\r\n            dn.g_settings.set(s, old_temp_g_settings.get(s));\r\n\r\n    // TODO: check these history things are right\r\n    dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    if(!dn.g_clipboard){\r\n        dn.g_settings.set('clipboard', doc.getModel().createList());\r\n        dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    }\r\n    dn.g_find_history = dn.g_settings.get('findHistory');\r\n    if(!dn.g_find_history){\r\n        dn.g_settings.set('findHistory', doc.getModel().createList());\r\n        dn.g_find_history = dn.g_settings.get('findHistory');\r\n    }\r\n    \r\n    //Check lastDNVersionUsed at this point - by default it's blank, but could also have an out-of-date value\r\n    if(dn.g_settings.get('lastDNVersionUsed') != dn.version_str){\r\n        dn.g_settings.set('help_inner', 'tips');\r\n        dn.g_settings.set('pane', 'pane_help');\r\n        dn.g_settings.set('pane_open', 'true');\r\n        dn.g_settings.set('lastDNVersionUsed', dn.version_str);\r\n    }\r\n\r\n    dn.status.realtime_settings = 1;\r\n}\r\n\r\n\r\n\r\ndn.g_settings = (function(){ //mock realtime model to be used until the real model is initialised\r\n    var ob = {};\r\n    var keeps = {};\r\n    var change_listeners = [];\r\n    return {\r\n           get: function(k){\r\n            return ob[k]\r\n        }, set: function(k,v){\r\n            if(ob[k] === v) return;\r\n            ob[k] = v;\r\n            for(var ii=0;ii<change_listeners.length;ii++)\r\n                change_listeners[ii]({property: k, newValue: v});\r\n        }, keep: function(k){\r\n            keeps[k] = true\r\n        }, get_keeps: function(){\r\n            return keeps;\r\n        }, addEventListener: function(flag, callback){\r\n            if(flag !== \"VALUE_CHANGED\") throw \"only VALUE_CHANGED\"\r\n                change_listeners.push(callback);\r\n        }, transfer_all_listeners: function(real_model){\r\n            // issue changes due to differences in the real and mock models\r\n            for(var k in ob)if(ob.hasOwnProperty(k) && !keeps[k])\r\n                if(JSON.stringify(ob[k]) !== JSON.stringify(real_model.get(k)))\r\n                    this.set(k, real_model.get(k)); // will call listeners\r\n            // and then register the listeners on the new model\r\n            while(change_listeners.length)\r\n                real_model.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED, change_listeners.shift());\r\n        }\r\n    };                          \r\n})();\r\n\r\ndn.load_default_settings = function(){\r\n  //Lets show the user either the defualt settings or the \r\n  //ones last used on this browser (restricted to impersonal settings only)\r\n\r\n  dn.status.local_settings = 0;\r\n  try{\r\n    console.log('Loading default/localStorage settings...');\r\n    for(var s in dn.default_settings)\r\n        if(dn.impersonal_settings_keys.indexOf(s) == -1 || !localStorage || !localStorage[\"g_settings_\" +s])\r\n            dn.g_settings.set(s, dn.default_settings[s]);\r\n        else\r\n            dn.g_settings.set(s, JSON.parse(localStorage[\"g_settings_\" + s]));\r\n  }catch(err){\r\n      if(localStorage) \r\n        localStorage.clear();\r\n      console.log(\"Failed to load defaults/localStorage settings.  Have cleared localStorage cache.\")\r\n  }\r\n  dn.status.local_settings = 1;\r\n}\r\n\r\ndn.settings_changed = function(e){\r\n    var new_value = e.newValue;\r\n    console.log(\"[user settings] \" + e.property +\": \" + new_value);\r\n    if(dn.impersonal_settings_keys.indexOf(e.property)>-1 && localStorage){\r\n        localStorage[\"g_settings_\" + e.property] = JSON.stringify(new_value);\r\n    }\r\n    try{\r\n        switch(e.property){\r\n            case \"widget_anchor\":\r\n                dn.widget_apply_anchor(new_value);\r\n                    break;\r\n            case \"theme\":\r\n                dn.editor.setTheme('ace/theme/' + new_value);\r\n                break;\r\n            case \"fontSize\":\r\n                var scrollLine = dn.get_scroll_line();\r\n                dn.editor.setFontSize(new_value + 'em')    \r\n                dn.editor.scrollToLine(scrollLine);\r\n                break;\r\n            case \"wordWrap\":\r\n                var s = dn.editor.getSession();\r\n                var scrollLine = dn.get_scroll_line();\r\n                s.setUseWrapMode(new_value[0]);\r\n                s.setWrapLimitRange(new_value[1],new_value[2]);\r\n                dn.editor.scrollToLine(scrollLine);\r\n                break;\r\n            case \"wordWrapAt\":\r\n                var curWrap = dn.g_settings.get('wordWrap');\r\n                if(curWrap[1] && curWrap[1] != new_value)\r\n                    dn.g_settings.set('wordWrap',[1,new_value,new_value]);\r\n                dn.editor.setPrintMarginColumn(new_value);\r\n                break;\r\n            case \"showGutterHistory\":\r\n                var s = dn.editor.getSession(); \r\n                if(!new_value){\r\n                    var h = dn.change_line_history;\r\n                    for(var i=0;i<h.length;i++)if(h[i])\r\n                        s.removeGutterDecoration(i,h[i]<0 ? dn.change_line_classes_rm[-h[i]] : dn.change_line_classes[h[i]]);\r\n                    dn.change_line_history = []; \r\n                }\r\n                break;\r\n            case \"newLineDefault\":\r\n                if(dn.the_file.loaded_body)\r\n                    dn.the_file.compute_newline();\r\n                break;\r\n            case \"historyRemovedIsExpanded\":\r\n                dn.revision_setis_expaned(new_value);\r\n                break;\r\n            case \"softTabN\":\r\n            case \"tabIsHard\":        \r\n                if(dn.the_file.loaded_body)\r\n                    dn.the_file.compute_newline();\r\n                break;\r\n            case 'pane_open':\r\n                dn.toggle_widget(new_value)\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane_open');\r\n                break;\r\n            case 'pane':\r\n                dn.show_pane(new_value);\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane');\r\n                if(new_value !== 'pane_help')\r\n                    dn.g_settings.set('help_inner', 'main');\r\n                break; \r\n            case 'help_inner':\r\n                dn.show_help_inner(new_value);\r\n                break;\r\n            \r\n        }\r\n    }catch(err){\r\n        console.log(\"Error while uptating new settings value.\")\r\n        console.dir(e);\r\n        console.dir(err);\r\n    }\r\n}\r\n\r\ndn.get_scroll_line = function(){\r\n    return  dn.editor.getSession().screenToDocumentPosition(dn.editor.renderer.getScrollTopRow(),0).row;\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Clipboard stuff\r\n// ############################\r\n\r\ndn.document_clipboard_left = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index <= 0)\r\n            return true;\r\n        dn.clipboard_index--;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_right = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index >= dn.g_clipboard.length-1)\r\n            return true;\r\n\r\n        dn.clipboard_index++;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_keyup = function(e){\r\n    if(e.which == 17 || e.which == 91 || !e.ctrlKey){\r\n        $(document).off('keyup',dn.document_clipboard_keyup);\r\n        dn.clipboard_active = false;\r\n        dn.el.pane_clipboard.style.display = 'none';\r\n        if(dn.clipboard_info_timer){\r\n            clearTimeout(dn.clipboard_info_timer);\r\n            dn.clipboard_info_timer = null;\r\n        }\r\n    }\r\n}\r\n\r\ndn.on_paste = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    $(document).on('keyup',dn.document_clipboard_keyup);\r\n    dn.clipboard_active = true;\r\n        \r\n    dn.clipboard_index = dn.g_clipboard.lastIndexOf(text); \r\n    if(dn.clipboard_index == -1){ //it's possible the user copied some text from outside the DN, in which case we will add it to the clipboard now\r\n       dn.clipboard_index = dn.g_clipboard.push(text);\r\n       while(dn.g_clipboard.length > dn.const.clipboard_max_length) //same as on copy\r\n         dn.g_clipboard.remove(0);\r\n    }\r\n    if(dn.clipboard_info_timer)\r\n        clearTimeout(dn.clipboard_info_timer);\r\n\r\n    dn.clipboard_info_timer = setTimeout(function(){\r\n        dn.clipboard_info_timer = null;\r\n        dn.el.pane_clipboard.style.display = '';\r\n    },dn.const.clipboard_info_delay);\r\n}\r\n\r\ndn.on_copy = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    dn.g_clipboard.push(text);\r\n    while(dn.g_clipboard.length >dn.const.clipboard_max_length)\r\n        dn.g_clipboard.remove(0);\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Load stuff\r\n// ############################\r\n\r\n\r\n\r\ndn.show_file_meta = function(resp) {\r\n    // this is called both by file loading and by creation of new file\r\n    if (resp.error)\r\n        throw Error(resp.error);\r\n    dn.the_file.file_id = resp.result.id;\r\n    dn.the_file.set({title: resp.result.name,\r\n                     description: resp.result.description || '',\r\n                     is_read_only: !resp.result.capabilities.canEdit,\r\n                     is_shared: resp.result.shared});\r\n    if(resp.result.properties){\r\n        if(resp.result.properties.aceMode !== undefined)\r\n            dn.the_file.set({syntax: resp.result.properties.aceMode})\r\n        if(resp.result.properties.newline !== undefined)\r\n            dn.the_file.set({newline: resp.result.properties.newline})\r\n        // TODO: set tabs\r\n    }\r\n    if(resp.result.parents && resp.result.parents.length){\r\n        dn.the_file.folder_id = resp.result.parents[0];\r\n        dn.set_drive_link_to_folder();\r\n    }\r\n\r\n    // set the url to match the file\r\n    history.replaceState({}, dn.the_file.title, '//' + location.host + location.pathname + \"?\"\r\n             + \"state=\" + JSON.stringify({action: \"open\", ids: [dn.the_file.file_id]}));\r\n\r\n    //whether we were creating a new file or loading meta for existing, neither is still in progress \r\n    dn.status.file_meta = 1; \r\n    dn.status.file_new = 1;\r\n    dn.show_status();\r\n} \r\n\r\ndn.show_file_body = function(resp){\r\n    dn.setting_session_value = true;\r\n    dn.the_file.loaded_body = resp.body; //this gets used for newline and tab detection, i.e. we don't want the editor to mangle it in any way\r\n    dn.editor.session.setValue(resp.body);\r\n    dn.setting_session_value = false;\r\n    dn.status.file_body = 1;\r\n    dn.show_status();\r\n}\r\n\r\n\r\n// ############################\r\n// Change/history stuff\r\n// ############################\r\n\r\ndn.on_change = function(e){\r\n    //console.dir(e);\r\n\r\n    if(!e.start || !e.end || dn.setting_session_value)\r\n        return;\r\n        \r\n    if(!dn.status.unsaved_changes){\r\n        dn.status.unsaved_changes = true;\r\n        dn.render_document_title();\r\n        dn.show_status();\r\n    }\r\n\r\n    if(!dn.g_settings.get('showGutterHistory'))\r\n        return;\r\n\r\n    var nClasses = dn.change_line_classes.length-1;\r\n    var h = dn.change_line_history;\r\n    var s = dn.editor.getSession(); \r\n\r\n    var start_row = e.start.row;\r\n    var end_row = e.end.row;\r\n\r\n    if(dn.last_change && dn.last_change.start_row == start_row && dn.last_change.end_row == end_row && start_row == end_row\r\n        && dn.last_change.action.indexOf(\"Text\") != -1 && e.action.indexOf(\"Text\") != -1){\r\n            //if this change and the last change were both on the same single lines with action (insert|remove)Text...\r\n\r\n            if(dn.last_change.action == e.action){\r\n                return; //same action as last time\r\n            }else if(e.action == \"removeText\"){ // new action is removeText, old action was insertText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                h[start_row] = -nClasses;\r\n                dn.last_change.action = \"removeText\";\r\n                return;\r\n            }else{// new action is isnertText, old action was removeText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                h[start_row] = nClasses;\r\n                dn.last_change.action = \"insertText\";\r\n                return;\r\n            }\r\n\r\n    }else{\r\n        //otherwise we have an acutal new change\r\n        dn.last_change = {start_row: start_row, end_row: end_row, action: e.action};\r\n    }\r\n\r\n    //remove all visible decorations and update the changeLineHistory values (we'll add in the new classes at the end)\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.removeGutterDecoration(i,h[i] < 0 ? \r\n                    dn.change_line_classes_rm[-h[i]++] : \r\n                    dn.change_line_classes[h[i]--]);\r\n\r\n    //Update the changeLineHistory relating to the current changed lines\r\n    if(e.action == \"removeLines\"){\r\n        h.splice(start_row, end_row - start_row + 1);        \r\n        h[start_row] = h[start_row+1] = -nClasses;\r\n    }else if(e.action === \"removeText\"){\r\n        h[start_row] = -nClasses;\r\n    }else{\r\n        var newLineCount = 0;\r\n        if(e.action == \"insertText\")\r\n            newLineCount = (e.text.match(/\\n/g) || []).length;\r\n        if(e.action == \"insertLines\")\r\n            newLineCount = e.lines.length;\r\n        h.splice.apply(h,[start_row,0].concat(Array(newLineCount)));\r\n\r\n        for(var i=start_row;i<=end_row;i++)\r\n            h[i] = nClasses;\r\n\r\n    }\r\n\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.addGutterDecoration(i,h[i]<0 ?\r\n                dn.change_line_classes_rm[-h[i]] :\r\n                dn.change_line_classes[h[i]]);\r\n} \r\n\r\ndn.query_unload = function(){\r\n    if(dn.status.unsaved_changes)\r\n        return \"If you leave the page now you will loose the unsaved \" + (dn.the_file.is_brand_new ? \"new \" : \"changes to \") + \"file '\" + dn.the_file.title + \"'.\"\r\n}\r\n\r\ndn.set_editor_tabs = function(){\r\n    // view for dn.the_file model\r\n    var val = dn.the_file.properties_chosen.tabs;\r\n\r\n    if(val.val === \"hard\"){\r\n        dn.editor.session.setUseSoftTabs(false);\r\n    }else{\r\n        dn.editor.session.setUseSoftTabs(true);\r\n        dn.editor.session.setTabSize(val.n);\r\n    }\r\n}\r\n\r\ndn.set_editor_syntax = function(){\r\n    // view for dn.the_file model\r\n    var mode_str = dn.the_file.properties_chosen.syntax;\r\n    var modes_array = require(\"ace/ext/modelist\").modes;\r\n\r\n    for(var ii=0; ii<modes_array.length;ii++)if(modes_array[ii].caption === mode_str){\r\n        dn.editor.getSession().setMode(modes_array[ii].mode);\r\n        return;\r\n    }    \r\n    dn.show_error(\"unrecognised syntax mode requested\");\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Drag-drop stuff\r\n// ############################\r\n//TODO: this may have a few bugs since it's not been tested for a while\r\n\r\ndn.document_drag_over = function (evt) {\r\n    evt = evt.originalEvent;\r\n    evt.stopPropagation();\r\n    evt.preventDefault();\r\n    if(!(dn.the_file.is_brand_new && !dn.status.unsaved_changes)){\r\n        evt.dataTransfer.dropEffect = 'none';\r\n        if(dn.can_show_drag_drop_error){\r\n            dn.show_error(\"File drag-drop is only permitted when the Drive Notpad page is displaying a new and unmodified file.\")\r\n            dn.can_show_drag_drop_error = false; //wait at least dn.const.error_delay_ms until displaying the error again\r\n            setTimeout(function(){dn.can_show_drag_drop_error = true;},dn.const.error_delay_ms);\r\n        }\r\n        return;\r\n    }\r\n    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.\r\n}\r\n    \r\ndn.document_drop_file = function(evt){\r\n     if(!(dn.the_file.is_brand_new && !dn.status.unsaved_changes))\r\n        return;\r\n        \r\n   evt = evt.originalEvent;\r\n   evt.stopPropagation();\r\n   evt.preventDefault();\r\n   \r\n   var files = evt.dataTransfer.files;\r\n   if(files.length > 1){\r\n       dn.show_error(\"You cannot drag-drop multiple files onto the Drive Notepad page, only individual files.\")\r\n   }\r\n   var file = files[0];\r\n   dn.the_file.title = file.name;\r\n   dn.create_file();\r\n   dn.the_file.isReading_file_object = true;   \r\n   dn.show_status();\r\n   var r = new FileReader();\r\n   r.onload = dn.dropped_file_read;\r\n   r.readAsText(file);      \r\n}\r\n\r\ndn.dropped_file_read = function(e){\r\n    dn.the_file.isReading_file_object = false;\r\n    dn.editor.getSession().setValue(e.target.result);\r\n    // Note we don't encolse the above in a dn.setting_session_value = true block so the change event will fire and set pristine to false and ShowStatus etc.\r\n}\r\n\r\n// ############################\r\n// Page ready stuff\r\n// ############################\r\n\r\n\r\ndn.render_document_title = function(){\r\n    document.title = (dn.status.unsaved_changes ? \"*\" : \"\") + dn.the_file.title;\r\n};\r\n\r\ndn.document_ready = function(e){\r\n\r\n    // widget :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.the_widget = document.getElementById('the_widget');\r\n    dn.el.widget_text = document.getElementById('widget_text');\r\n    dn.el.widget_error_text = document.getElementById('widget_error_text');\r\n    dn.el.widget_error = document.getElementById('widget_error');\r\n    dn.el.widget_content = document.getElementById('widget_content');\r\n    dn.el.widget_pending = document.getElementById('widget_pending');\r\n    dn.el.the_widget.addEventListener('mousedown', dn.widget_mouse_down);\r\n    translate(dn.el.the_widget, 0, 0);\r\n    dn.el.the_widget.style.display = '';\r\n    dn.el.widget_error.style.display = 'none';\r\n    dn.el.widget_content.addEventListener('mousedown', function(e){\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    });\r\n    var els = dn.el.widget_content.getElementsByTagName('input');\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].addEventListener('mousedown', stop_propagation); // prevents propagation to preventDefault, installed above.\r\n    var els = dn.el.widget_content.getElementsByTagName('textarea');\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].addEventListener('mousedown', stop_propagation); // prevents propagation to preventDefault, installed above.\r\n\r\n    // editor :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    var editor_el = document.getElementById('the_editor');\r\n    editor_el.innerHTML = '';\r\n    editor_el.addEventListener('contextmenu', function(e){\r\n        dn.show_error(\"See the list of keyboard shortcuts for copy/paste, select-all, and undo/redo.\")\r\n    });\r\n    dn.editor = ace.edit(\"the_editor\");\r\n    dn.editor.setHighlightSelectedWord(true);\r\n    dn.el.ace_content = document.getElementsByClassName('ace_content')[0];\r\n    dn.editor.getSession().addEventListener(\"change\", dn.on_change);\r\n    dn.focus_editor = dn.editor.focus.bind(dn.editor);\r\n    dn.focus_editor();\r\n    dn.editor.on(\"paste\", dn.on_paste);\r\n    dn.editor.on(\"copy\", dn.on_copy);\r\n    dn.editor.setAnimatedScroll(true);\r\n    dn.editor.$blockScrolling = Infinity; // disables scrolling message\r\n    \r\n    // widget menu ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.widget_menu = document.getElementById('widget_menu');\r\n    dn.el.menu_open = document.getElementById('menu_open');\r\n    dn.el.menu_find = document.getElementById('menu_find');\r\n    dn.el.menu_help = document.getElementById('menu_help');\r\n    dn.el.menu_file = document.getElementById('menu_file');\r\n    dn.el.menu_general_settings = document.getElementById('menu_general_settings');\r\n    dn.el.widget_menu.addEventListener('mousedown', stop_propagation);\r\n    dn.menu_icon_from_pane_id = {}\r\n    var els = dn.el.widget_menu.getElementsByClassName('widget_menu_icon');\r\n    for(var ii=0; ii<els.length; ii++){\r\n        els[ii].addEventListener(\"mousedown\", prevent_default);\r\n        els[ii].title = dn.menu_id_to_caption[els[ii].id];\r\n        dn.menu_icon_from_pane_id['pane_' + els[ii].id.substr(5)] = els[ii];\r\n    }\r\n\r\n    dn.el.pane_clipboard = document.getElementById('pane_clipboard');\r\n\r\n     // pane file ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_file = document.getElementById('pane_file');\r\n    dn.file_pane.on_document_ready();\r\n    dn.el.menu_file.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_file');\r\n    })\r\n\r\n     // pane general settings :::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_general_settings = document.getElementById('pane_general_settings');\r\n    dn.settings_pane.on_document_ready();\r\n    dn.el.menu_general_settings.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_general_settings');\r\n    })\r\n\r\n    // pane permissions :::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_permissions = document.getElementById('pane_permissions');\r\n    document.getElementById('button_auth').addEventListener('click', dn.reauth_manual);\r\n\r\n    // pane help ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_help = document.getElementById('pane_help');\r\n    dn.el.user_name = document.getElementById('user_name');\r\n    dn.el.pane_help_shortcuts = document.getElementById('pane_help_shortcuts');\r\n    dn.el.pane_help_tips = document.getElementById('pane_help_tips');\r\n    dn.el.pane_help_main = document.getElementById('pane_help_main');\r\n    dn.el.button_shortcuts = document.getElementById('button_view_shortcuts');\r\n    dn.el.button_tips = document.getElementById('button_view_tips');\r\n    dn.el.button_shortcuts.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'shortcuts')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'shortcuts');\r\n    })\r\n    dn.el.button_tips.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'tips')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'tips');\r\n    })\r\n    dn.el.menu_help.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_help');\r\n    })\r\n    dn.create_pane_shortcuts();\r\n\r\n    // pane find ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::    \r\n    dn.el.pane_find = document.getElementById('pane_find');\r\n    dn.find_pane.on_document_ready();\r\n    dn.el.menu_find.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_find');\r\n        dn.find_pane.focus_on_input();\r\n    });\r\n\r\n    // pane open ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_open = document.getElementById('pane_open');\r\n    dn.el.opener_button_a = document.getElementById('opener_button_a');\r\n    dn.el.menu_open.addEventListener('click', function(){    \r\n        dn.g_settings.set('pane', 'pane_open');\r\n    });\r\n    dn.el.opener_button_a.addEventListener('click', dn.open_button_click);\r\n\r\n\r\n    dn.g_settings.addEventListener(\"VALUE_CHANGED\", dn.settings_changed);\r\n    \r\n    // :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.make_keyboard_shortcuts();\r\n    dn.load_default_settings();\r\n    document.addEventListener('contextmenu', prevent_default);\r\n    document.addEventListener('dragover', dn.document_drag_over);\r\n    document.addEventListener('drop', dn.document_drop_file);\r\n    window.addEventListener('resize', dn.widget_apply_anchor);\r\n    window.onbeforeunload = dn.query_unload;\r\n\r\n    //work out whether a fileid was specified in page load, and if not, whether a folderid was.\r\n    var params = window_location_to_params_object(); \r\n    var new_in_folder = undefined;\r\n    if(params['state']){\r\n        try{\r\n            var state = JSON.parse(params['state']); \r\n            if(state.action && state.action == \"open\" && state.ids && state.ids.length > 0)\r\n               dn.the_file.file_id = state.ids[0];\r\n            else\r\n               new_in_folder = state.folderId; //could be undefiend\r\n        }catch(e){\r\n            dn.show_error(\"Bad URL params, creating a new file.\");\r\n        }\r\n    }\r\n\r\n    dn.pr_file_loaded = new SpecialPromise();\r\n\r\n    dn.the_file.addEventListener(\"change\", function(e){\r\n        switch(e.property){\r\n            case \"title\":\r\n            dn.render_document_title();\r\n            break;\r\n\r\n            case \"syntax\":\r\n            dn.set_editor_syntax();\r\n            break;\r\n\r\n            case \"newline\":\r\n            dn.set_editor_newline();\r\n            break;\r\n\r\n            case \"tabs\":\r\n            dn.set_editor_tabs();\r\n            break;\r\n        }            \r\n    });\r\n\r\n    // The auth promise can be rejected and resolved multiple times during the lifetime of the app.\r\n    // These two handlers will always be called for those events.\r\n    dn.pr_auth.on_error(dn.handle_auth_error); \r\n    dn.pr_auth.on_success(function(){\r\n        // reset some things, could be no-ops...\r\n        dn.reauth_auto_delay = 0;\r\n        dn.toggle_permission(false);\r\n        dn.status.popup_active = 0;\r\n\r\n        // and show the good news...\r\n        dn.status.authentication = 1;\r\n        dn.show_status(); \r\n    })\r\n\r\n    // get user info...\r\n    until_success(function(succ, fail){\r\n        Promise.resolve(dn.pr_auth)\r\n               .then(dn.request_user_info)\r\n               .then(dn.show_user_info)\r\n               .then(succ, fail);\r\n    }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n    .then(function(){\r\n        console.log('succeeded getting user info.')\r\n    })\r\n    \r\n    if(dn.the_file.file_id){\r\n        // load existing file :::::::::::::::::::::::::::::::::::::::::::::::::::\r\n        dn.status.file_meta = 0;\r\n        dn.status.file_body = 0;\r\n        dn.show_status();\r\n\r\n        // meta data...\r\n        var pr_meta = until_success(function(succ, fail){\r\n            Promise.resolve(dn.pr_auth)\r\n                   .then(dn.request_file_meta)\r\n                   .then(dn.show_file_meta)\r\n                   .catch(function(err){\r\n                        if(dn.is_auth_error(err)) throw err; // until_success will handle these errors and retry\r\n                        dn.show_error(err.result.error.message);\r\n                        dn.status.file_meta = -1;\r\n                        dn.show_status();\r\n                        return 'bad' // a form of success\r\n                   }).then(succ, fail);\r\n        }, dn.pr_auth.reject.bind(dn.pr_auth));\r\n\r\n        // body...\r\n        var pr_body = until_success(function(succ, fail){\r\n            Promise.resolve(dn.pr_auth)\r\n                   .then(dn.request_file_body)\r\n                   .then(dn.show_file_body)\r\n                   .catch(function(err){\r\n                        if(dn.is_auth_error(err)) throw err;  // until_success will handle these errors and retry\r\n                        dn.show_error(err.result.error.message);\r\n                        dn.status.file_body = -1;\r\n                        dn.show_status();\r\n                        return 'bad' // a form of success\r\n                   }).then(succ, fail);\r\n        }, dn.pr_auth.reject.bind(dn.pr_auth));\r\n\r\n        // load meta data and body...\r\n        Promise.all([pr_meta, pr_body])\r\n            .then(function(vals){\r\n                if(vals[0] === 'bad' || vals[1] === 'bad') throw \"bad\"\r\n                console.log(\"succeeded loading file body and metadata.\");\r\n                dn.the_file.set({is_loaded: true});\r\n                dn.pr_file_loaded.resolve();    \r\n                dn.show_status();\r\n            }).catch(function(err){\r\n                document.title = \"Drive Notepad\";\r\n                dn.g_settings.set('pane', 'pane_help');\r\n                dn.g_settings.set('pane_open', true);\r\n                console.dir(err);\r\n            });\r\n\r\n    } else {\r\n        // create new file :::::::::::::::::::::::::::::::::::::::::::::::::::\r\n        dn.status.file_new = 0;\r\n        dn.show_status();\r\n        dn.the_file.set({title: \"untitled.txt\", is_loaded: true}); // there's nothing to load for this model\r\n\r\n        until_success(function(succ, fail){\r\n            Promise.resolve(dn.pr_auth)\r\n                   .then(dn.request_new(new_in_folder))\r\n                   .then(dn.show_file_meta)\r\n                   .catch(function(err){\r\n                    if(dn.is_auth_error(err)) throw err; // auth error, until_success will handle it\r\n                    dn.show_error(err.result.error.message);\r\n                    dn.status.file_new = -1;\r\n                    dn.show_status();\r\n                    return \"bad\"\r\n                    }).then(succ, fail);\r\n            }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n            .then(function(result){\r\n                if(result === \"bad\") throw \"bad\";\r\n                console.log(\"suceeded creating file\")\r\n                dn.g_settings.set('pane', 'pane_file');\r\n                dn.pr_file_loaded.resolve();\r\n            }).catch(function(err){\r\n                document.title = \"Drive Notepad\";\r\n                dn.g_settings.set('pane', 'pane_help');\r\n                dn.g_settings.set('pane_open', true);\r\n                console.dir(err);\r\n            });\r\n    }\r\n    \r\n    // load cloud settings ::::::::::::::::::::::::::::::::::::::::::::::::\r\n    until_success(function(succ, fail){ \r\n        Promise.all([dn.pr_auth, dn.pr_realtime_loaded])\r\n               .then(dn.request_app_data_document)\r\n               .then(dn.show_app_data_document)\r\n               .then(succ, fail)\r\n    }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n    .then(function(){\r\n        console.log('succeeded loading settings');\r\n    });\r\n    \r\n    \r\n}\r\n\r\n\r\nif (document.readyState != 'loading')\r\n    dn.document_ready();\r\nelse\r\n    document.addEventListener('DOMContentLoaded', dn.document_ready);\r\n"]}