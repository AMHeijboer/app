{"version":3,"sources":["node_modules/keymaster/keymaster.js","js/utils.js","js/drop_down.js","js/info.js","js/revisions_main_thread.js","js/find_replace.js","js/print.js","js/keyboard.js","js/app.js"],"names":["global","k","_handlers","_mods",16,18,17,91,"_scope","_MODIFIERS","⇧","shift","⌥","alt","option","⌃","ctrl","control","⌘","command","_MAP","backspace","tab","clear","enter","return","esc","escape","space","left","up","right","down","del","delete","home","end","pageup","pagedown",",",".","/","`","-","=",";","'","[","]","\\","code","x","toUpperCase","charCodeAt","_downKeys","index","array","item","i","length","compareArray","a1","a2","modifierMap","updateModifierKey","event","dispatch","key","handler","modifiersMatch","scope","keyCode","push","assignKey","filter","call","this","getScope","mods","method","preventDefault","returnValue","stopPropagation","cancelBubble","clearModifier","splice","resetModifiers","keys","getKeys","undefined","split","getMods","shortcut","unbindKey","multipleKeys","j","obj","isPressed","getPressedKeyCodes","slice","tagName","target","srcElement","setScope","deleteScope","handlers","replace","mi","addEvent","object","addEventListener","attachEvent","window","document","previousKey","noConflict","unbind","module","exports","oxford_comma","arr","rotate","el","deg","style","transform","webkitTansform","mozTransform","translate","y","str","webkitTransform","text_multi","text","truncate_long_words","textContent","innerHTML","escape_str","css_animation","timers","els","cls","callback","delay","classList","remove","offsetTop","old_idx","indexOf","clearTimeout","setTimeout","add","stop_propagation","e","prevent_default","until_success","executor","on_error","Promise","success","rejection_handler","err","then","DropDown","val_array","map","val","join","el_list","createElement","className","tabindex","display","el_collapsed","appendChild","ind","event_callbacks","open","dd","document_mousedown","trigger","removeEventListener","parentNode","focus","scrollTop","children","on_click","SetInd","getAttribute","ii","setAttribute","FakeEvent","is_stopped","prototype","stopImmediatePropagation","evt","func","args","fe","IndexOf","GetVal","no_trigger","parseInt","title","isOpen","SetSelected","v","dn","menu_id_to_caption","menu_print","menu_sharing","menu_save","menu_history","menu_file","menu_new","menu_open","menu_find","menu_goto","menu_general_settings","menu_shortcuts","menu_drive","menu_help","shortcuts_list","ext_to_mime_type","html","htm","js","pl","xml","c","cpp","h","json","php","svg","css","java","py","scala","textile","tex","bib","rtf","rtx","sh","sql","as","tooltip_info","save","print","sharing","file history","drive","about","shortcuts","new","settings_file","settings_general","description","WHICH","ENTER","ESC","UP","DOWN","default_settings","ext","wordWrap","wordWrapAt","fontSize","widget_anchor","showGutterHistory","lastDNVersionUsed","newLineDefault","historyRemovedIsExpanded","softTabN","tabIsHard","widgetSub","theme","pane","pane_open","find_regex","find_whole_words","find_case_sensitive","help_inner","find_goto","find_replace","default_custom_props","newline","tabs","aceMode","impersonal_settings_keys","drag_delay_ms","drag_shift_px","min_font_size","max_font_size","max_wrap_at","min_wrap_at","wrap_at_increment","max_soft_tab_n","min_soft_tab_n","detect_tabs_spaces_frac","detect_tabs_tabs_frac","detect_tabs_n_spaces_frac","detect_tabs_n_spaces_frac_for_default","font_size_increment","icon_mouse_over_ms","editor_refocus_time_ms","error_delay_ms","find_history_add_delay","clipboard_info_delay","clipboard_max_length","find_max_results_half","find_max_prefix_chars","find_max_suffix_chars","close_history","file_history","$revisions_display","revisions_window_resize","getElementById","editor","resize","is_showing_history","canShowResizeError","show_error","start_revisions_worker","the_file","is_brand_new","widget_content","widget_file_history","getElementsByClassName","$","$view","$new_li","$new_tick","needToRefindViewChildren","$rev_lines_","needToFixHeights","$timeline","$d","find","$revisions_status","$revision_caption_from","$revision_caption_at","$expand_removed","$collapse_removed","revisions","revisionFromEtag","at","from","worker","Worker","g_settings","set","revision_setis_expaned","get","w","onmessage","revision_worker_delivery","postMessage","fileId","file_id","token","gapi","auth","getToken","access_token","init","appendTo","on","empty","revision_set_at","r","fromChangeEvent","fromTimelineCreation","$at_range","value","modifiedDate","toLocaleDateString","month","day","year","toLocaleTimeString","hour","minute","showEtag","etag","fromEtag","revision_set_from","$from_range","display_revision_timeline","newRevisions","rs","$tick_box","attr","t","downloaded","isDownloaded","Array","apply","$ticks","insertClonedChildren","eq","append","data","debug","console","log","status","forEach","revisionDownloaded","revsionDiffed","isDiffed","newStuff","newStuffForDom","lines","vals_ui8buffer","$rl_","fixHeightFromAuto","vals","Uint8Array","digits","find_goto_changed","new_value","find_goto_wrapper","find_find_wrapper","button_goto","find_info","find_replace_wrapper","find_replace_changed","button_replace","find_inputs_have_focus","find_select_result_idx","find_current_match_idx","find_goto_input_has_focus","find_goto_input_focus","find_perform_goto","find_goto_input_blur","relatedTarget","focus_editor","validated_str","find_goto_input","num","gotoLine","navigateLineEnd","find_goto_input_keyup","find_goto_input_keydown","which","find_results","find_markers","find_marker_current","find_str","find_inputs_focus","currentTarget","find_input","tabIndex","find_replace_input","AceSearch","ace","require","Search","AceRange","Range","setHighlightSelectedWord","find_perform_search","find_inputs_blur","session","getSession","removeMarker","find_info_overflow","setSelectionRange","selectionEnd","find_build_options","use_reg_exp","sensitive","re","RegExp","needle","wrap","caseSensitive","wholeWord","regExp","search_options","message","selection","clearSelection","search","setOptions","results","findAll","selected_range","getSelection","getRange","row","start","column","current_match_idx","addMarker","range","idx","results_sub","replace_is_showing","max_results","n_pre","n_post","concat","show_replace_buttons","col","prefix_range","Math","max","pre_ellipses","suffix_range","getTextRange","find_result_click","find_replace_result_click","renderer","scrollSelectionIntoView","find_settings_changed","find_replace_result_idx","find_input_keyup","find_input_keydown","shiftKey","ctrlKey","find_replace_input_keydown","find_replace_all","options","replaceAll","find_replace_click","$search","$tryReplace","do_print","content","doc","getAllLines","line_to_html","printWindow","writeln","cssText","n","printLayer","Object","create","Text","tokens","getTokens","screenColumn","$renderToken","platform","navigator","create_pane_shortcuts","arry","dict","parts","action","pane_help_shortcuts","esc_pressed","find_shortcut_used","sel","getSelectionRange","select","find_goto_shortcut_used","show_replace_shortcut_used","make_keyboard_shortcuts","commands","removeCommands","save_content","do_open","do_new","HashHandler","extraKeyEvents","bindKey","win","mac","descr","exec","document_clipboard_left","document_clipboard_right","keyBinding","addKeyboardHandler","ctrl_key","version_str","can_show_drag_drop_error","file_body","file_meta","file_sharing","authentication","popup_active","local_settings","realtime_settings","folder_id","loaded_mime_type","new_line_detected","tab_detected","is_pristine","mime_type","is_saving","data_to_save","body","generation_to_save","is_read_only","is_shared","is_reading_file_object","custom_props","custom_prop_exists","saving_title_count","change_line_history","last_change","change_line_classes","rootStr","trueN","factor","change_line_classes_rm","handle_auth_error","authorization","show_status","type","reauth_auto","result","error","the_widget","authorize","auth_map","pr_auth","resolve","bind","reject","reauth_manual","show_user_info","a","user_info","user_name","name","do_share","share_dialog","do_share_sub","load","share","ShareClient","client_id","setItemIds","setOAuthToken","showSettingsDialog","detect_new_line","first_n","show_newline_status","has_rn","has_solo_n","match","apply_newline_choice","newlineDefault","newline_menu_windows","newline_menu_unix","file_newline_detect","file_newline_windows","file_newline_unix","setNewLineMode","statusStr","file_newline_info","open_button_click","view","google","picker","View","ViewId","DOCS","open_picker","PickerBuilder","enableFeature","Feature","NAV_HIDDEN","setAppId","addView","setCallback","picker_callback","build","setVisible","Action","PICKED","docs","id","url","JSON","stringify","userId","url_user_id","ids","location","open_new_tab","close","show_help_inner","inner_pane","pane_help_tips","pane_help_main","button_shortcuts","button_tips","show_pane","el_icon","menu_icon_from_pane_id","widget_mouse_down","widget_mouse_down_info","off_left","clientX","off_top","clientY","start_time","Date","now","is_dragging","button","document_mouse_move_widget","document_mouse_up_widget","pos","getBoundingClientRect","widget_w","offsetWidth","widget_h","offsetHeight","window_w","innerWidth","window_h","innerHeight","anchor","top","widget_apply_anchor","isArray","widget_menu","bottom","toggle_widget","state","s","extra","widget_text","widget_error_text","widget_error","set_drive_link_to_folder","href","show_app_data_document","old_temp_g_settings","getModel","getRoot","g_clipboard","createList","g_find_history","existingKeys","realtime","EventType","VALUE_CHANGED","settings_changed","getKeeps","property","newValue","load_default_settings","ob","keeps","keep","localStorage","parse","setTheme","theme_drop_down","scrollLine","get_scroll_line","font_size_text","toFixed","setFontSize","scrollToLine","setUseWrapMode","setWrapLimitRange","word_wrap_off","word_wrap_edge","word_wrap_at","word_wrap_at_text","curWrap","setPrintMarginColumn","gutter_history_show","gutter_history_hide","removeGutterDecoration","apply_tab_choice","find_button_regex","find_button_whole_words","find_button_case_sensitive","dir","font_size_decrement_click","font_size","font_size_increment_click","detect_tab","getLines","indents","show_tab_status","stats","reduce","nWithMixture","nWithOnlyTabs","spaceHist","nSamp","nWithOnlySpaces","spaceModHist","m","defaultNSpaces","isDefault","threshold","d","defaultStr","file_tab_info","defaultTabIsHard","defaultSoftTabN","isHard","nSpaces","isDetected","setUseSoftTabs","setTabSize","tab_soft_text","tab_hard","tab_soft","file_tab_detect","file_tab_hard","file_tab_soft","file_tab_soft_text","set_file_tabs_to_soft_or_hard","delta","f","current","newT","set_property","show_syntax_status","syntax","file_ace_mode_info","detect_syntax","mode","getModeForPath","syntax_detected","caption","apply_syntax_choice","set_syntax","file_ace_mode_detect","syntax_drop_down","modesArray","modes","setMode","create_theme_menu","themes","themesByName","create_syntax_menu","read_only_bail","create_file_details_tool","details_title_text","details_description_text","details_title_input","new_val","show_file_title","save_file_title","ignore_escape","button_save","button_print","button_share","button_history","details_description_input","show_description","save_file_description","save_new_file","save_file","proxy","save_done","getValue","widget_pending","do_save","gens","meta","resp","failures","fileExtension","saved_new_file","fileMetadata","fileText","boundary","make_boundary","delimiter","close_delim","messageBody","btoa","unescape","encodeURIComponent","request","client","path","params","uploadType","headers","Content-Type","execute","getTime","random","clipboard_active","clipboard_index","undo","insert","document_clipboard_keyup","off","pane_clipboard","clipboard_info_timer","on_paste","lastIndexOf","on_copy","create_clipboard_tool","button_clear_clipboard","button_clear_find_replace","base","folderId","create_new_tool","create_file","guess_mime_type","plain","substr","mimeType","parentId","parentNodes","shared","history","replaceState","save_all_file_properties","save_scroll_line","patch_property","screenToDocumentPosition","getScrollTopRow","show_file_meta","Error","capabilities","canEdit","parents","show_file_body","setting_session_value","setValue","on_change","nClasses","start_row","end_row","addGutterDecoration","newLineCount","query_unload","property_updated","propKey","load_default_properties","get_properties_from_cloud","got_all_file_properties","items","prop_name","oldVal","dummyCallback","properties","propertyKey","visibility","patch","resource","document_drag_over","originalEvent","dataTransfer","dropEffect","document_drop_file","files","file","isReading_file_object","FileReader","onload","dropped_file_read","readAsText","debug_screw_up_auth","setToken","request_user_info","request_file_meta","fields","request_file_body","request_app_data_document","succ","fail","app_data_realtime_error","loadAppDataDocument","document_ready","getElementsByTagName","editor_el","edit","ace_content","setAnimatedScroll","$blockScrolling","Infinity","pane_file","file_ace_mode_choose","pane_general_settings","theme_chooser","widget_sub_general_box","font_size_decrement","tab_soft_dec","tab_soft_inc","word_wrap_at_dec","word_wrap_at_inc","pane_permissions","pane_help","pane_find","button_find_replace_all","opener_button_a","onbeforeunload","window_location_to_params_object","on_success","pr_meta","catch","pr_body","all","pr_realtime_loaded","readyState"],"mappings":"CAIC,SAAUA,QACT,GAAIC,GACFC,aACAC,OAAUC,GAAI,MAAOC,GAAI,MAAOC,GAAI,MAAOC,GAAI,OAC/CC,OAAS,MAETC,YACEC,IAAK,GAAIC,MAAO,GAChBC,IAAK,GAAIC,IAAK,GAAIC,OAAQ,GAC1BC,IAAK,GAAIC,KAAM,GAAIC,QAAS,GAC5BC,IAAK,GAAIC,QAAS,IAGpBC,MACEC,UAAW,EAAGC,IAAK,EAAGC,MAAO,GAC7BC,MAAO,GAAIC,SAAU,GACrBC,IAAK,GAAIC,OAAQ,GAAIC,MAAO,GAC5BC,KAAM,GAAIC,GAAI,GACdC,MAAO,GAAIC,KAAM,GACjBC,IAAK,GAAIC,SAAU,GACnBC,KAAM,GAAIC,IAAK,GACfC,OAAQ,GAAIC,SAAU,GACtBC,IAAK,IAAKC,IAAK,IAAKC,IAAK,IACzBC,IAAK,IAAKC,IAAK,IAAKC,IAAK,IACzBC,IAAK,IAAKC,IAAM,IAChBC,IAAK,IAAKC,IAAK,IAAKC,KAAM,KAE5BC,KAAO,SAASC,GACd,MAAO/B,MAAK+B,IAAMA,EAAEC,cAAcC,WAAW,IAE/CC,YAEF,KAAIrD,EAAE,EAAEA,EAAE,GAAGA,IAAKmB,KAAK,IAAInB,GAAK,IAAIA,CAGpC,SAASsD,OAAMC,MAAOC,MACpB,GAAIC,GAAIF,MAAMG,MACd,OAAMD,IAAK,GAAGF,MAAME,KAAKD,KAAM,MAAOC,EACtC,QAAQ,EAIV,QAASE,cAAaC,GAAIC,IACxB,GAAID,GAAGF,QAAUG,GAAGH,OAAQ,MAAO,MACnC,KAAK,GAAID,GAAI,EAAGA,EAAIG,GAAGF,OAAQD,IAAK,CAChC,GAAIG,GAAGH,KAAOI,GAAGJ,GAAI,MAAO,OAEhC,MAAO,MAGT,GAAIK,cACA3D,GAAG,WACHC,GAAG,SACHC,GAAG,UACHC,GAAG,UAEP,SAASyD,mBAAkBC,OACvB,IAAIhE,IAAKE,OAAOA,MAAMF,GAAKgE,MAAMF,YAAY9D,IAIjD,QAASiE,UAASD,OAChB,GAAIE,KAAKC,QAASnE,EAAGyD,EAAGW,eAAgBC,KACxCH,KAAMF,MAAMM,OAEZ,IAAIhB,MAAMD,UAAWa,OAAS,EAAG,CAC7Bb,UAAUkB,KAAKL,KAInB,GAAGA,KAAO,IAAMA,KAAO,IAAKA,IAAM,EAClC,IAAGA,MAAOhE,OAAO,CACfA,MAAMgE,KAAO,IAEb,KAAIlE,IAAKQ,YAAY,GAAGA,WAAWR,IAAMkE,IAAKM,UAAUxE,GAAK,IAC7D,QAEF+D,kBAAkBC,MAIlB,KAAIQ,UAAUC,OAAOC,KAAKC,KAAMX,OAAQ,MAGxC,MAAME,MAAOjE,YAAY,MAEzBoE,OAAQO,UAGR,KAAKnB,EAAI,EAAGA,EAAIxD,UAAUiE,KAAKR,OAAQD,IAAK,CAC1CU,QAAUlE,UAAUiE,KAAKT,EAGzB,IAAGU,QAAQE,OAASA,OAASF,QAAQE,OAAS,MAAM,CAElDD,eAAiBD,QAAQU,KAAKnB,OAAS,CACvC,KAAI1D,IAAKE,OACP,IAAKA,MAAMF,IAAMsD,MAAMa,QAAQU,MAAO7E,IAAM,GACzCE,MAAMF,IAAMsD,MAAMa,QAAQU,MAAO7E,KAAO,EAAIoE,eAAiB,KAElE,IAAID,QAAQU,KAAKnB,QAAU,IAAMxD,MAAM,MAAQA,MAAM,MAAQA,MAAM,MAAQA,MAAM,KAAQkE,eAAe,CACtG,GAAGD,QAAQW,OAAOd,MAAOG,WAAW,MAAM,CACxC,GAAGH,MAAMe,eAAgBf,MAAMe,qBACxBf,OAAMgB,YAAc,KAC3B,IAAGhB,MAAMiB,gBAAiBjB,MAAMiB,iBAChC,IAAGjB,MAAMkB,aAAclB,MAAMkB,aAAe,SAQtD,QAASC,eAAcnB,OACrB,GAAIE,KAAMF,MAAMM,QAAStE,EACrByD,EAAIH,MAAMD,UAAWa,IAGzB,IAAIT,GAAK,EAAG,CACRJ,UAAU+B,OAAO3B,EAAG,GAGxB,GAAGS,KAAO,IAAMA,KAAO,IAAKA,IAAM,EAClC,IAAGA,MAAOhE,OAAO,CACfA,MAAMgE,KAAO,KACb,KAAIlE,IAAKQ,YAAY,GAAGA,WAAWR,IAAMkE,IAAKM,UAAUxE,GAAK,OAIjE,QAASqF,kBACP,IAAIrF,IAAKE,OAAOA,MAAMF,GAAK,KAC3B,KAAIA,IAAKQ,YAAYgE,UAAUxE,GAAK,MAItC,QAASwE,WAAUN,IAAKG,MAAOS,QAC7B,GAAIQ,MAAMT,IACVS,MAAOC,QAAQrB,IACf,IAAIY,SAAWU,UAAW,CACxBV,OAAST,KACTA,OAAQ,MAIV,IAAK,GAAIZ,GAAI,EAAGA,EAAI6B,KAAK5B,OAAQD,IAAK,CAEpCoB,OACAX,KAAMoB,KAAK7B,GAAGgC,MAAM,IACpB,IAAIvB,IAAIR,OAAS,EAAE,CACjBmB,KAAOa,QAAQxB,IACfA,MAAOA,IAAIA,IAAIR,OAAO,IAGxBQ,IAAMA,IAAI,EACVA,KAAMjB,KAAKiB,IAEX,MAAMA,MAAOjE,YAAYA,UAAUiE,OACnCjE,WAAUiE,KAAKK,MAAOoB,SAAUL,KAAK7B,GAAIY,MAAOA,MAAOS,OAAQA,OAAQZ,IAAKoB,KAAK7B,GAAIoB,KAAMA,QAK/F,QAASe,WAAU1B,IAAKG,OACtB,GAAIwB,cAAcP,KAChBT,QACApB,EAAGqC,EAAGC,GAERF,cAAeN,QAAQrB,IAEvB,KAAK4B,EAAI,EAAGA,EAAID,aAAanC,OAAQoC,IAAK,CACxCR,KAAOO,aAAaC,GAAGL,MAAM,IAE7B,IAAIH,KAAK5B,OAAS,EAAG,CACnBmB,KAAOa,QAAQJ,KACfpB,KAAMoB,KAAKA,KAAK5B,OAAS,GAG3BQ,IAAMjB,KAAKiB,IAEX,IAAIG,QAAUmB,UAAW,CACvBnB,MAAQO,WAEV,IAAK3E,UAAUiE,KAAM,CACnB,OAEF,IAAKT,EAAI,EAAGA,EAAIxD,UAAUiE,KAAKR,OAAQD,IAAK,CAC1CsC,IAAM9F,UAAUiE,KAAKT,EAErB,IAAIsC,IAAI1B,QAAUA,OAASV,aAAaoC,IAAIlB,KAAMA,MAAO,CACvD5E,UAAUiE,KAAKT,SAQvB,QAASuC,WAAU1B,SACf,SAAU,UAAW,SAAU,CAC7BA,QAAUrB,KAAKqB,SAEjB,MAAOhB,OAAMD,UAAWiB,WAAa,EAGzC,QAAS2B,sBACL,MAAO5C,WAAU6C,MAAM,GAG3B,QAASzB,QAAOT,OACd,GAAImC,UAAWnC,MAAMoC,QAAUpC,MAAMqC,YAAYF,OAEjD,SAASA,SAAW,SAAWA,SAAW,UAAYA,SAAW,YAInE,IAAInG,IAAKQ,YAAYgE,UAAUxE,GAAK,KAGpC,SAASsG,UAASjC,OAAQ9D,OAAS8D,OAAS,MAC5C,QAASO,YAAY,MAAOrE,SAAU,MAGtC,QAASgG,aAAYlC,OACnB,GAAIH,KAAKsC,SAAU/C,CAEnB,KAAKS,MAAOjE,WAAW,CACrBuG,SAAWvG,UAAUiE,IACrB,KAAKT,EAAI,EAAGA,EAAI+C,SAAS9C,QAAU,CACjC,GAAI8C,SAAS/C,GAAGY,QAAUA,MAAOmC,SAASpB,OAAO3B,EAAG,OAC/CA,OAMX,QAAS8B,SAAQrB,KACf,GAAIoB,KACJpB,KAAMA,IAAIuC,QAAQ,MAAO,GACzBnB,MAAOpB,IAAIuB,MAAM,IACjB,IAAKH,KAAKA,KAAK5B,OAAS,IAAO,GAAI,CACjC4B,KAAKA,KAAK5B,OAAS,IAAM,IAE3B,MAAO4B,MAIT,QAASI,SAAQxB,KACf,GAAIW,MAAOX,IAAIgC,MAAM,EAAGhC,IAAIR,OAAS,EACrC,KAAK,GAAIgD,IAAK,EAAGA,GAAK7B,KAAKnB,OAAQgD,KACnC7B,KAAK6B,IAAMlG,WAAWqE,KAAK6B,IAC3B,OAAO7B,MAIT,QAAS8B,UAASC,OAAQ5C,MAAOc,QAC/B,GAAI8B,OAAOC,iBACTD,OAAOC,iBAAiB7C,MAAOc,OAAQ,WACpC,IAAG8B,OAAOE,YACbF,OAAOE,YAAY,KAAK9C,MAAO,WAAYc,OAAOiC,OAAO/C,SAI7D2C,SAASK,SAAU,UAAW,SAAShD,OAASC,SAASD,QACzD2C,UAASK,SAAU,QAAS7B,cAG5BwB,UAASI,OAAQ,QAAS1B,eAG1B,IAAI4B,aAAclH,OAAOmE,GAGzB,SAASgD,cACP,GAAIlH,GAAID,OAAOmE,GACfnE,QAAOmE,IAAM+C,WACb,OAAOjH,GAITD,OAAOmE,IAAMM,SACbzE,QAAOmE,IAAIoC,SAAWA,QACtBvG,QAAOmE,IAAIU,SAAWA,QACtB7E,QAAOmE,IAAIqC,YAAcA,WACzBxG,QAAOmE,IAAIO,OAASA,MACpB1E,QAAOmE,IAAI8B,UAAYA,SACvBjG,QAAOmE,IAAI+B,mBAAqBA,kBAChClG,QAAOmE,IAAIgD,WAAaA,UACxBnH,QAAOmE,IAAIiD,OAASvB,SAEpB,UAAUwB,UAAW,YAAaA,OAAOC,QAAU7C,YAElDG,KCvSH,aAEA,IAAI2C,cAAe,SAASC,KACxB,OAAQA,IAAI7D,QACR,IAAK,GACD,MAAO6D,KAAI,EACf,KAAK,GACD,MAAOA,KAAI,GAAK,QAAUA,IAAI,EAClC,KAAK,GACD,MAAOA,KAAI,GAAK,KAAOA,IAAI,GAAK,SAAWA,IAAI,IAI3D,IAAIC,QAAS,SAASC,GAAIC,KACtBD,GAAGE,MAAMC,UAAY,UAAYF,IAAM,MACvCD,IAAGE,MAAME,eAAiB,UAAYH,IAAM,MAC5CD,IAAGE,MAAMG,aAAe,UAAYJ,IAAM,OAG9C,IAAIK,WAAY,SAASN,GAAIvE,EAAG8E,GAC5B,GAAIC,KAAM/E,GAAG,KAAO,GAAK,aAAeA,EAAI,MAAQ8E,EAAI,KACxDP,IAAGE,MAAMC,UAAYK,GACrBR,IAAGE,MAAMO,gBAAkBD,GAC3BR,IAAGE,MAAMG,aAAeG,IAG5B,IAAIE,YAAa,SAASV,GAAIW,KAAMC,qBAChC,GAAGA,oBAAoB,CACnBD,KAAOA,KAAK3B,QAAQ,eAAe,SAEvCgB,GAAGa,YAAcF,IACjBX,IAAGc,UAAYd,GAAGc,UAAU9B,QAAQ,MAAM,SAASA,QAAQ,MAAM,uBAGrE,IAAI+B,YAAa,SAASP,KAEtB,MAAOA,KAAIxB,QAAQ,uBAAwB,SAAShD,GAChD,MAAO,KAAOA,EAAEL,WAAW,GAAK,MAIxC,IAAIqF,eAAgB,WAChB,GAAIC,UACJ,IAAIC,OAEJ,OAAO,UAASlB,GAAImB,IAAKC,SAAUC,OAC/BrB,GAAGsB,UAAUC,OAAOJ,IACpBnB,IAAGwB,SACH,IAAIC,SAAUP,IAAIQ,QAAQ1B,GAC1B,IAAGyB,UAAY,EAAE,CACbE,aAAaV,OAAOQ,SACpBR,QAAOtD,OAAO8D,QAAS,EACvBP,KAAIvD,OAAO8D,QAAS,GAExBP,IAAIpE,KAAKkD,GACTiB,QAAOnE,KAAK8E,WAAWR,SAAUC,OACjCrB,IAAGsB,UAAUO,IAAIV,QAIzB,IAAIW,kBAAmB,SAASC,GAC5BA,EAAEvE,kBAGN,IAAIwE,iBAAkB,SAASD,GAC3BA,EAAEzE,iBAGN,SAAS2E,eAAcC,SAAUC,UAG7B,MAAO,IAAIC,SAAQ,SAASC,SACxB,GAAIC,mBAAoB,SAASC,KAC7BJ,SAASI,IACT,OAAO,IAAIH,SAAQF,UAAUM,KAAKH,QAASC,mBAE/C,OAAO,IAAIF,SAAQF,UAAUM,KAAKH,QAASC,qBC5EnD,YAEA,IAAIG,UAAW,SAASC,WAGpB,GAAIlC,KAAMkC,UAAUC,IAAI,SAASC,KACjB,MAAO,qCAAuC7B,WAAW6B,KAAO,KAAO7B,WAAW6B,KAAO,WACzFC,KAAK,GAErB3F,MAAKwF,UAAYA,UAAUjE,MAAM,EACjCvB,MAAK4F,QAAUvD,SAASwD,cAAc,MACtC7F,MAAK4F,QAAQE,UAAW,oBACxB9F,MAAK4F,QAAQG,UAAW,CACxB/F,MAAK4F,QAAQ5C,MAAMgD,QAAU,MAC7BhG,MAAK4F,QAAQhC,UAAYN,GAEzBtD,MAAKiG,aAAe5D,SAASwD,cAAc,MAC3C7F,MAAKiG,aAAaH,UAAY,oBAE9B9F,MAAK8C,GAAKT,SAASwD,cAAc,MACjC7F,MAAK8C,GAAGgD,UAAY,UACpB9F,MAAK8C,GAAGoD,YAAYlG,KAAK4F,QACzB5F,MAAK8C,GAAGoD,YAAYlG,KAAKiG,aACzBjG,MAAKmG,IAAM,CACXnG,MAAKiG,aAAatC,YAAc6B,UAAU,EAC1CxF,MAAKoG,kBACLpG,MAAKqG,KAAO,KAEZ,IAAIC,IAAKtG,IAETA,MAAKuG,mBAAqB,SAAS1B,GAC/ByB,GAAGV,QAAQ5C,MAAMgD,QAAU,MAC3BM,IAAGD,KAAO,KACVC,IAAGE,QAAQ,OACXnE,UAASoE,oBAAoB,YAAaH,GAAGC,oBAGjDvG,MAAKiG,aAAa/D,iBAAiB,YAAY,WAC3C,IAAIoE,GAAGE,QAAQ,SACX,MACJF,IAAGxD,GAAG4D,WAAWtC,UAAUO,IAAI,WAC/B2B,IAAGV,QAAQ5C,MAAMgD,QAAU,EAC3BhG,MAAKqG,KAAO,IACZ3B,YAAW,WACP4B,GAAGV,QAAQe,OACXL,IAAGV,QAAQgB,UAAYN,GAAGV,QAAQiB,SAASP,GAAGH,KAAK7B,SACnDjC,UAASH,iBAAiB,YAAaoE,GAAGC,qBAC5C,IAEN,IAAIO,UAAW,SAASjC,GAChByB,GAAGS,OAAO/G,KAAKgH,aAAa,YAC5BV,IAAGV,QAAQ5C,MAAMgD,QAAU,MAC3BM,IAAGD,KAAO,KACVxB,GAAEvE,iBACF+B,UAASoE,oBAAoB,YAAaH,GAAGC,oBAErD,KAAI,GAAIU,IAAG,EAAGA,GAAGjH,KAAK4F,QAAQiB,SAAS9H,OAAQkI,KAAK,CAChDjH,KAAK4F,QAAQiB,SAASI,IAAIC,aAAa,WAAYD,GACnDjH,MAAK4F,QAAQiB,SAASI,IAAI/E,iBAAiB,QAAS4E,UAGxD,MAAO9G,MAGXuF,UAAS4B,UAAY,WACjBnH,KAAKoH,WAAa,MAEtB7B,UAAS4B,UAAUE,UAAUC,yBAA2B,WACpDtH,KAAKoH,WAAa,KAGtB7B,UAAS8B,UAAUnF,iBAAmB,SAASqF,IAAKC,MAChD,KAAKD,MAAOvH,MAAKoG,iBACbpG,KAAKoG,gBAAgBmB,OACzBvH,MAAKoG,gBAAgBmB,KAAK3H,KAAK4H,MAGnCjC,UAAS8B,UAAUb,QAAU,SAASe,IAAKE,MACvC,GAAIC,IAAK,GAAInC,UAAS4B,SACtB,IAAGI,MAAOvH,MAAKoG,gBAAgB,CAC3B,IAAI,GAAIa,IAAK,EAAGA,GAAGjH,KAAKoG,gBAAgBmB,KAAKxI,OAAQkI,KACjDjH,KAAKoG,gBAAgBmB,KAAKN,IAAIlH,KAAKC,KAAM0H,GAC7C,IAAGA,GAAGN,WACF,MAAO,OAEf,MAAO,MAEX7B,UAAS8B,UAAUM,QAAU,SAASjC,KAClC,MAAO1F,MAAKwF,UAAUhB,QAAQkB,KAGlCH,UAAS8B,UAAUO,OAAS,WACxB,MAAO5H,MAAKwF,UAAUxF,KAAKmG,KAG/BZ,UAAS8B,UAAUN,OAAS,SAASZ,IAAI0B,YACrC1B,IAAM2B,SAAS3B,IACf,IAAGA,MAAQnG,KAAKmG,IACZ,MACJnG,MAAK4F,QAAQiB,SAAS7G,KAAKmG,KAAK/B,UAAUC,OAAO,WACjDrE,MAAKiG,aAAatC,YAAc3D,KAAKwF,UAAUW,IAC/CnG,MAAKiG,aAAa8B,MAAQlE,WAAW7D,KAAKwF,UAAUW,KACpDnG,MAAKmG,IAAMA,GACXnG,MAAK4F,QAAQiB,SAASV,KAAK/B,UAAUO,IAAI,WACzC,KAAIkD,WACA7H,KAAKwG,QAAQ,UAAUL,IAAIA,IAAI7C,IAAItD,KAAKwF,UAAUW,KAAK6B,OAAQhI,KAAKqG,OAG5Ed,UAAS8B,UAAUY,YAAc,SAASC,GACtC,GAAGA,EACClI,KAAK8C,GAAG4D,WAAWtC,UAAUO,IAAI,gBAEjC3E,MAAK8C,GAAG4D,WAAWtC,UAAUC,OAAO,YChH5C,aAEA8D,IAAGC,oBACHC,WAAc,QACdC,aAAgB,UAChBC,UAAa,OACbC,aAAgB,UAChBC,UAAa,eACbC,SAAY,MACZC,UAAa,WACbC,UAAa,eACbC,UAAa,YACbC,sBAAyB,mBACzBC,eAAkB,YAClBC,WAAc,QACdC,UAAa,aAGbd,IAAGe,gBACH,mBACA,oBACA,yBACA,yFACA,8BACA,oBACA,iBACA,0BACA,wBACA,qDACA,MACA,oBACA,wBACA,+BACA,gCACA,mBACA,oBACA,OACA,uBACA,4BACA,yKACA,oDACA,8CACA,2BACA,0BACA,wCACA,wDACA,wDACA,0DACA,kDACA,qCACA,wDACA,wCACA,2CACA,aACA,oBACA,mBACA,+BACA,6BACA,wCACA,qDACA,gCACA,qBACA,kCACA,2BAGAf,IAAGgB,kBACHC,KAAK,YACLC,IAAI,YACJC,GAAG,kBACHC,GAAG,qBACHC,IAAI,WACJC,EAAE,cACFC,IAAI,gBACJC,EAAE,cACFC,KAAK,mBACLC,IAAI,oBACJC,IAAI,YACJC,IAAI,WACJC,KAAK,cACLC,GAAG,gBACHC,MAAM,QACNC,QAAQ,UACRC,IAAI,oBACJC,IAAI,oBACJC,IAAI,kBACJC,IAAI,kBACJC,GAAG,mBACHC,IAAI,aACJC,GAAG,sBAIHvC,IAAGwC,cACCC,KAAS,wBACTC,MAAS,kCACTC,QAAW,yCACXC,eAAgB,8BAChBC,MAAS,oCACTC,MAAS,yBACTC,UAAa,sBACbC,MAAO,kCACP9E,KAAQ,yBACR+E,cAAiB,kCACjBC,iBAAoB,0CACpBtD,MAAS,kCACTuD,YAAe,wCAInB,IAAIC,QACJC,MAAO,GACPC,IAAK,GACLC,GAAI,GACJC,KAAM,GAGNxD,IAAGyD,kBACHC,IAAK,MACLC,UAAW,KAAK,KAAK,MACrBC,WAAY,GACZC,SAAU,EACVC,eAAgB,IAAI,GAAG,IAAI,IAC3BC,kBAAmB,EACnBC,kBAAmB,GACnBC,eAAgB,UAChBC,yBAA0B,KAC1BC,SAAU,EACVC,UAAW,EACXC,UAAW,UACXC,MAAO,SACPC,KAAM,GACNC,UAAW,KACXC,WAAY,MACZC,iBAAkB,MAClBC,oBAAqB,MACrBC,WAAY,OACZC,UAAW,MACXC,aAAc,MAGd9E,IAAG+E,sBACHC,QAAS,SACTC,KAAM,SACNC,QAAS,SAGTlF,IAAGmF,0BACH,WACA,aACA,WACA,gBACA,oBACA,2BACA,YACA,WACA,YACA,QACA,OACA,YACA,aACA,mBACA,sBACA,aACA,YACA,eAGAnF,IAAGoF,cAAgB,GACnBpF,IAAGqF,cAAgB,EACnBrF,IAAGsF,cAAgB,EACnBtF,IAAGuF,cAAgB,CACnBvF,IAAGwF,YAAc,GACjBxF,IAAGyF,YAAc,EACjBzF,IAAG0F,kBAAoB,EACvB1F,IAAG2F,eAAiB,EACpB3F,IAAG4F,eAAiB,CACpB5F,IAAG6F,wBAA0B,EAC7B7F,IAAG8F,sBAAwB,EAC3B9F,IAAG+F,0BAA4B,GAC/B/F,IAAGgG,sCAAwC,EAC3ChG,IAAGiG,oBAAsB,GACzBjG,IAAGkG,mBAAqB,GACxBlG,IAAGmG,uBAAyB,GAC5BnG,IAAGoG,eAAiB,GACpBpG,IAAGqG,uBAAyB,GAC5BrG,IAAGsG,qBAAuB,GAC1BtG,IAAGuG,qBAAuB,EAC1BvG,IAAGwG,sBAAwB,CAC3BxG,IAAGyG,sBAAwB,EAC3BzG,IAAG0G,sBAAwB,EC9L3B,aAEA1G,IAAG2G,cAAgB,WACf3G,GAAG4G,aAAaC,mBAAmB3K,QACnCjC,QAAOqE,oBAAoB,SAAU0B,GAAG8G,wBACxC5M,UAAS6M,eAAe,cAAclM,MAAMgD,QAAU,EACtDmC,IAAGgH,OAAOC,QACVjH,IAAGkH,mBAAqB,MAE5BlH,IAAG8G,wBAA0B,WACzB,GAAG9G,GAAG4G,aAAaO,mBAAmB,CAClCnH,GAAGoH,WAAW,mGACdpH,IAAG4G,aAAaO,mBAAqB,KACrC5K,YAAW,WAAWyD,GAAG4G,aAAaO,mBAAqB,MAAOnH,GAAGoG,iBAI7EpG,IAAGqH,uBAAyB,WACxB,GAAGrH,GAAGsH,SAASC,aAAa,CACxBvH,GAAGoH,WAAW,+DACd,QAEJpH,GAAGkH,mBAAqB,IAExB,KAAIlH,GAAG4G,aAAa,CAChB5G,GAAGrF,GAAG6M,eAAe/L,UAAU,WAC3B,4CACA,0EACA,0CACA,wCACA,4CACA,0FACQ,gFACR,yCACA,mDACA,kCACA,yCACA,mJACJuE,IAAGrF,GAAG8M,oBAAsBzH,GAAGrF,GAAG6M,eAAejJ,WAAWmJ,uBAAuB,oBAAoB,EACvG1H,IAAGrF,GAAG8M,oBAAoB5M,MAAMgD,QAAU,MAC1CmC,IAAG4G,cACCC,mBAAoBc,EAAE,+CACtBC,MAAO,KACPC,QAASF,EAAE,iCACXG,UAAYH,EAAE,gCACdI,yBAA0B,MAC1BC,eACAC,iBAAkBN,MAClBO,UAAWC,GAAGC,KAAK,sBACnBC,kBAAmBF,GAAGC,KAAK,qBAC3BE,uBAAwBH,GAAGC,KAAK,0BAChCG,qBAAsBJ,GAAGC,KAAK,wBAC9BI,gBAAiBL,GAAGC,KAAK,mBACzBK,kBAAmBN,GAAGC,KAAK,qBAC3BM,aACAC,oBACAC,GAAI,KACJC,KAAM,KACN1B,mBAAoB,KACpB2B,OAAQ,GAAIC,QAAO,0BAGvB/I,IAAG4G,aAAagB,MAAQ5H,GAAG4G,aAAaC,mBAAmBuB,KAAK,KAChEpI,IAAG4G,aAAa4B,gBAAgBzO,iBAAiB,QAAS,WAAWiG,GAAGgJ,WAAWC,IAAI,2BAA2B,OAClHjJ,IAAG4G,aAAa6B,kBAAkB1O,iBAAiB,QAAS,WAAWiG,GAAGgJ,WAAWC,IAAI,2BAA2B,QACpHjJ,IAAGkJ,uBAAuBlJ,GAAGgJ,WAAWG,IAAI,4BAE5C,IAAIC,GAAIpJ,GAAG4G,aAAakC,MACxBM,GAAEC,UAAYrJ,GAAGsJ,yBAErBtJ,GAAG4G,aAAakC,OAAOS,aAAcC,OAAQxJ,GAAGsH,SAASmC,QACrBC,MAAOC,KAAKC,KAAKC,WAAWC,aAC5BC,KAAM,MAC1C/J,IAAG4G,aAAaC,mBAAmBmD,SAASrC,EAAE,QAC9CA,GAAE1N,QAAQgQ,GAAG,SAASjK,GAAG8G,wBACzB9G,IAAGrF,GAAG8M,oBAAoB5M,MAAMgD,QAAU,EAC1CmC,IAAG4G,aAAagB,MAAMsC,OACtBvC,GAAE,eAAe9M,MAAMgD,QAAU,MACjC,OAAO,OAGXmC,IAAGkJ,uBAAyB,SAASnJ,GACjC,GAAIyB,GAAIxB,GAAG4G,YACX,KAAIpF,EAAG,MAEP,IAAGzB,EAAE,CACDyB,EAAEgH,gBAAgBvM,UAAUO,IAAI,WAChCgF,GAAEiH,kBAAkBxM,UAAUC,OAAO,WACrCsF,GAAEoG,MAAM7I,aAAa,UAAU,gBAC9B,CACDyC,EAAEiH,kBAAkBxM,UAAUO,IAAI,WAClCgF,GAAEgH,gBAAgBvM,UAAUC,OAAO,WACnCsF,GAAEoG,MAAM7I,aAAa,UAAU,cAGvCiB,IAAGmK,gBAAkB,SAASC,EAAEC,gBAAgBC,sBAC5C,GAAI9I,GAAIxB,GAAG4G,YACXpF,GAAEoH,GAAKwB,CACP,KAAIC,gBACA7I,EAAE+I,UAAUC,MAAQJ,EAAEpM,GAC1B3C,YAAWmG,EAAE+G,qBACL6B,EAAEK,aAAaC,uBAAuBC,MAAM,QAAQC,IAAI,UAAUC,KAAM,YAAc,KACtFT,EAAEK,aAAaK,uBAAuBC,KAAM,UAAUC,OAAQ,YAGtE,IAAGxJ,EAAEqH,OAASyB,qBACV9I,EAAEsH,OAAOS,aAAa0B,SAAUzJ,EAAEoH,GAAGsC,KACvBC,SAAU3J,EAAEqH,KAAKqC,OAGvClL,IAAGoL,kBAAoB,SAAShB,EAAEC,gBAAgBC,sBAC9C,GAAI9I,GAAIxB,GAAG4G,YACXpF,GAAEqH,KAAOuB,CACT,KAAIC,gBACA7I,EAAE6J,YAAYb,MAAQJ,EAAEpM,GAC5B3C,YAAWmG,EAAE8G,uBACL8B,EAAEK,aAAaC,uBAAuBC,MAAM,QAAQC,IAAI,UAAUC,KAAM,YAAc,KACtFT,EAAEK,aAAaK,uBAAuBC,KAAM,UAAUC,OAAQ,YAGtE,IAAGxJ,EAAEoH,KAAO0B,qBACR9I,EAAEsH,OAAOS,aAAa0B,SAAUzJ,EAAEoH,GAAGsC,KACnBC,SAAU3J,EAAEqH,KAAKqC,OAG3ClL,IAAGsL,0BAA4B,SAASC,cACpC,GAAI/J,GAAIxB,GAAG4G,YACX,IAAI4E,IAAKhK,EAAEkH,SAGXlH,GAAE+I,UAAY5C,EAAE,+DAAiE6D,GAAG5U,OAAO,GAAK,MAChG4K,GAAEiK,UAAY9D,EAAE,mCAChBnG,GAAE6J,YAAc1D,EAAE,iEAAmE6D,GAAG5U,OAAO,GAAK,MAGpG,IAAI8U,MAAOF,GAAGlO,IAAI,SAASqO,GAAI,OAASC,WAAYD,EAAEE,cAAgB,QACtE,IAAIvQ,MAAOwQ,MAAMC,MAAM,KAAMD,MAAMJ,KAAK9U,SAAS0G,IAAI,WAAc,MAAO,IAC1E,IAAI0O,QAASxK,EAAEiK,UAAUQ,qBAAqB,EAAEzK,EAAEsG,UAAUxM,KAAKoQ,KAEjE,KAAI,GAAI/U,GAAE,EAAEA,EAAE6U,GAAG5U,OAAOD,IAAI,CACxB6U,GAAG7U,GAAGqH,IAAMrH,CACZ6U,IAAG7U,GAAGgR,EAAIqE,OAAOE,GAAGvV,GAGxB6K,EAAE0G,UAAUgC,QAAQiC,OAAO3K,EAAE+I,WAAW4B,OAAO3K,EAAEiK,WAAWU,OAAO3K,EAAE6J,YAErE7J,GAAE+I,UAAUN,GAAG,SAAS,WAChBjK,GAAGmK,gBAAgBnK,GAAG4G,aAAa8B,UAAU7Q,KAAK2S,OAAO,OAEjEhJ,GAAE6J,YAAYpB,GAAG,SAAS,WAClBjK,GAAGoL,kBAAkBpL,GAAG4G,aAAa8B,UAAU7Q,KAAK2S,OAAO,OAGnExK,IAAGoL,kBAAkBI,GAAG5U,OAAS,EAAI4U,GAAG,GAAKA,GAAG,GAAG,MAAM,KACzDxL,IAAGmK,gBAAgBqB,GAAG,GAAG,MAAM,MAGnCxL,IAAGsJ,yBAA2B,SAAS5M,GACnC,IAAIA,EAAE0P,KACF,MAEJ,IAAG1P,EAAE0P,KAAKC,MACNC,QAAQC,IAAI7P,EAAE0P,KAElB,IAAI5K,GAAIxB,GAAG4G,YAGX,IAAGlK,EAAE0P,KAAKI,OACNnR,WAAWmG,EAAE6G,kBAAmB3L,EAAE0P,KAAKI,OAE3C,IAAG9P,EAAE0P,KAAK1D,UAAU,CAChBlH,EAAEkH,UAAYhM,EAAE0P,KAAK1D,SACrBhM,GAAE0P,KAAK1D,UAAU+D,QAAQ,SAASrC,GAAI5I,EAAEmH,iBAAiByB,EAAEc,MAAQd,GACnEpK,IAAGsL,0BAA0B5O,EAAE0P,KAAK1D,UACpClH,GAAEsH,OAAOS,aAAc0B,SAAUzJ,EAAEoH,GAAGsC,KACfC,SAAU3J,EAAEqH,KAAKqC,OAG5C,GAAGxO,EAAE0P,KAAKM,mBAAmB,CACzB,GAAItC,GAAI5I,EAAEmH,iBAAiBjM,EAAE0P,KAAKM,mBAClCtC,GAAEzC,EAAE+D,KAAK,aAAa,KACtBtB,GAAEyB,aAAe,KAGrB,GAAGnP,EAAE0P,KAAKO,cAAc,CACpBnL,EAAEuG,yBAA2B,IAC7B,IAAIqC,GAAI5I,EAAEmH,iBAAiBjM,EAAE0P,KAAKO,cAClCvC,GAAEzC,EAAE+D,KAAK,SAAS,KAClBtB,GAAEwC,SAAW,IAEb,IAAIC,UAAWnQ,EAAE0P,KAAKU,cACtB,KAAI,GAAInW,GAAE,EAAEA,EAAEkW,SAASjW,OAAOD,IAAI,CAC9B,GAAIoW,OAAQF,SAASlW,GAAGoW,MAAMzP,IAAI,SAASnC,KAAK,MAAOA,MAAO,KAE9DqG,GAAEyG,iBAAmBzG,EAAEyG,iBAAiBzL,IACxBgF,EAAEoG,MAAMqE,qBAAqBY,SAASlW,GAAGiS,GAAGpH,EAAEqG,QAAQkF,SAK9E,GAAGrQ,EAAE0P,KAAKY,eAAe,CAErB,GAAGxL,EAAEuG,yBAAyB,CAC1BvG,EAAEwG,YAAcxG,EAAEoG,MAAMlJ,UACxB8C,GAAEuG,yBAA2B,MAEjC,GAAIkF,MAAOzL,EAAEwG,WAEb,IAAGxG,EAAEyG,iBAAiBrR,OAAO,CACzByE,WAAWmG,EAAE6G,kBAAmB,gCAChC7G,GAAEyG,iBAAiBiF,mBACnB1L,GAAEyG,iBAAmBN,KACrBtM,YAAWmG,EAAE6G,kBAAmB,sBAGpC,GAAI8E,MAAO,GAAIC,YAAW1Q,EAAE0P,KAAKY,eACjCC,MAAKlO,aAAa,IAAI,SAASpI,GAAG,MAAOwW,MAAKxW,IAG9C,QAAO+F,EAAE0P,KAAKiB,QACV,IAAK,GACL,IAAK,GACL,IAAK,GACD7L,EAAEoG,MAAM7I,aAAa,SAAS,GAC9B,MACJ,KAAK,GACDyC,EAAEoG,MAAM7I,aAAa,SAAS,MAC9B,MACJ,KAAK,GACDyC,EAAEoG,MAAM7I,aAAa,SAAS,OAC9B,MACJ,SACIyC,EAAEoG,MAAM7I,aAAa,SAAS,WCxO9C,aA+BAiB,IAAGsN,kBAAoB,SAASC,WAI5B,GAAGA,UAAU,CACTvN,GAAGrF,GAAG6S,kBAAkB3S,MAAMgD,QAAU,EACxCmC,IAAGrF,GAAG8S,kBAAkB5S,MAAMgD,QAAU,MACxCmC,IAAGrF,GAAG+S,YAAYzR,UAAUO,IAAI,WAChCwD,IAAGrF,GAAGgT,UAAUnS,YAAc,oBAC9BwE,IAAGrF,GAAGiT,qBAAqB/S,MAAMgD,QAAU,WAC1C,CACDmC,GAAGrF,GAAG6S,kBAAkB3S,MAAMgD,QAAU,MACxCmC,IAAGrF,GAAG8S,kBAAkB5S,MAAMgD,QAAU,EACxCmC,IAAGrF,GAAG+S,YAAYzR,UAAUC,OAAO,WACnC8D,IAAGrF,GAAGgT,UAAUnS,YAAc,iBAC9B,IAAIwE,GAAGgJ,WAAWG,IAAI,gBAClBnJ,GAAGrF,GAAGiT,qBAAqB/S,MAAMgD,QAAU,IAIvDmC,IAAG6N,qBAAuB,SAASN,WAC/B,GAAGA,UAAU,CACTvN,GAAGrF,GAAGmT,eAAe7R,UAAUO,IAAI,WACnC,KAAIwD,GAAGgJ,WAAWG,IAAI,aAClBnJ,GAAGrF,GAAGiT,qBAAqB/S,MAAMgD,QAAU,OAC9C,CACDmC,GAAGrF,GAAGiT,qBAAqB/S,MAAMgD,QAAU,MAC3CmC,IAAGrF,GAAGmT,eAAe7R,UAAUC,OAAO,YAE1C,GAAG8D,GAAG+N,uBACF/N,GAAGgO,uBAAuBhO,GAAGiO,wBAQrCjO,IAAGkO,0BAA4B,KAE/BlO,IAAGmO,sBAAwB,WACvBnO,GAAGkO,0BAA4B,IAC/BlO,IAAGrF,GAAGgT,UAAUnS,YAAc,mBAC9BwE,IAAGoO,oBAGPpO,IAAGqO,qBAAuB,SAAS3R,GAC/BsD,GAAGkO,0BAA4B,KAC/BlO,IAAGrF,GAAGgT,UAAUnS,YAAc,oBAC9B,KAAIkB,EAAE4R,cACFtO,GAAGuO,eAGXvO,IAAGoO,kBAAoB,WAEnB,GAAII,eAAgBxO,GAAGrF,GAAG8T,gBAAgBjE,MAAM7Q,QAAQ,QAAQ,GAChE,IAAI6U,gBAAkBxO,GAAGrF,GAAG8T,gBAAgBjE,MACxCxK,GAAGrF,GAAG8T,gBAAgBjE,MAAQgE,aAClC,IAAGA,gBAAkB,GACjB,MACJ,IAAIE,KAAM/O,SAAS6O,cACnBxO,IAAGgH,OAAO2H,SAASD,IACnB1O,IAAGgH,OAAO4H,kBAGd5O,IAAG6O,sBAAwB7O,GAAGoO,iBAE9BpO,IAAG8O,wBAA0B,SAASpS,GAElC,GAAGA,EAAEqS,OAAS3L,MAAMI,KAAK,CACrBxD,GAAGrF,GAAG8T,gBAAgBjE,MAAQ7K,SAASK,GAAGrF,GAAG8T,gBAAgBjE,MAAM7Q,QAAQ,QAAQ,KAAK,CACxFqG,IAAGoO,mBACH1R,GAAEzE,qBACA,IAAGyE,EAAEqS,OAAS3L,MAAMG,GAAG,CACzBvD,GAAGrF,GAAG8T,gBAAgBjE,MAAQ7K,SAASK,GAAGrF,GAAG8T,gBAAgBjE,MAAM7Q,QAAQ,QAAQ,KAAK,CACxFqG,IAAGoO,mBACH1R,GAAEzE,qBACC,IAAGyE,EAAEqS,OAAS3L,MAAME,IAAI,CAC3BtD,GAAGgJ,WAAWC,IAAI,YAAa,MAC/BvM,GAAEzE,gBACFyE,GAAEvE,mBASV6H,IAAG+N,uBAAyB,KAC5B/N,IAAGgP,eACHhP,IAAGiO,wBAA0B,CAC7BjO,IAAGiP,eACHjP,IAAGkP,oBAAsBxW,SACzBsH,IAAGmP,SAAW,EAEdnP,IAAGoP,kBAAoB,SAAS1S,GAC5B,GAAGA,EAAE2S,eAAiBrP,GAAGrF,GAAG2U,WAAW,CACnCtP,GAAGrF,GAAG2U,WAAWC,SAAW,GAC5BvP,IAAGrF,GAAG6U,mBAAmBD,SAAW,QACjC,CACHvP,GAAGrF,GAAG2U,WAAWC,SAAW,GAC5BvP,IAAGrF,GAAG6U,mBAAmBD,SAAW,IAExC,GAAGvP,GAAG+N,uBACF,MAEJ/N,IAAG+N,uBAAyB,IAC5B/N,IAAGyP,UAAYzP,GAAGyP,WAAaC,IAAIC,QAAQ,YAAYC,MACvD5P,IAAG6P,SAAW7P,GAAG6P,UAAYH,IAAIC,QAAQ,WAAWG,KACpD9P,IAAGgH,OAAO+I,yBAAyB,MACnC/P,IAAGgQ,sBAGPhQ,IAAGiQ,iBAAmB,SAASvT,GAC3B,GAAGA,EAAE4R,eAAiBtO,GAAGrF,GAAG6U,oBAAuB9S,EAAE4R,eAAiBtO,GAAGrF,GAAG2U,WACxE,MAEJtP,IAAG+N,uBAAyB,KAG5B,IAAImC,SAAUlQ,GAAGgH,OAAOmJ,YACxB,KAAI,GAAIrR,IAAG,EAAGA,GAAGkB,GAAGiP,aAAarY,OAAQkI,KACrCoR,QAAQE,aAAapQ,GAAGiP,aAAanQ,IACzC,IAAIkB,GAAGkP,sBAAwBxW,UAAU,CACrCwX,QAAQE,aAAapQ,GAAGkP,oBACxBlP,IAAGkP,oBAAsBxW,UAI7BsH,GAAGrF,GAAGgT,UAAUnS,YAAc,iBAC9BwE,IAAGrF,GAAGqU,aAAavT,UAAY,EAC/BuE,IAAGrF,GAAG0V,mBAAmB7U,YAAc,EAGvCwE,IAAGiP,eACHjP,IAAGgP,eACHhP,IAAGiO,wBAA0B,CAG7BjO,IAAGrF,GAAG2U,WAAWgB,kBAAkBtQ,GAAGrF,GAAG2U,WAAWiB,aAAcvQ,GAAGrF,GAAG2U,WAAWiB,aAGnFvQ,IAAGgH,OAAO+I,yBAAyB,KAEnC,KAAIrT,EAAE4R,cACFtO,GAAGuO,eAGXvO,IAAGwQ,mBAAqB,WACpB,GAAIrV,KAAM6E,GAAGrF,GAAG2U,WAAW9E,KAC3B,IAAIiG,aAAczQ,GAAGgJ,WAAWG,IAAI,aACpC,IAAIuH,WAAY1Q,GAAGgJ,WAAWG,IAAI,sBAClC,IAAGsH,YAAY,CACX,GAAIE,IAAKjY,SACTiY,IAAK,GAAIC,QAAOzV,IAAKuV,UAAY,IAAM,MAE3C,OACAG,OAAQJ,YAAcE,GAAKxV,IAC3B2V,KAAM,KACNC,cAAeL,UACfM,UAAWhR,GAAGgJ,WAAWG,IAAI,oBAC7B8H,OAAQR,aAGZzQ,IAAGgQ,oBAAsB,WAIrB,GAAIE,SAAUlQ,GAAGgH,OAAOmJ,YACxB,KAAI,GAAIrR,IAAG,EAAGA,GAAGkB,GAAGiP,aAAarY,OAAQkI,KACrCoR,QAAQE,aAAapQ,GAAGiP,aAAanQ,IACzC,IAAGkB,GAAGkP,sBAAwBxW,UAAU,CACpCwX,QAAQE,aAAapQ,GAAGkP,oBACxBlP,IAAGkP,oBAAsBxW,UAE7BsH,GAAGiP,eACHjP,IAAGgP,eACHhP,IAAGiO,wBAA0B,CAC7BjO,IAAGrF,GAAGqU,aAAavT,UAAY,EAC/BuE,IAAGrF,GAAG0V,mBAAmB7U,YAAc,EACvCwE,IAAGrF,GAAGgT,UAAUnS,YAAc,EAC9BwE,IAAGmP,SAAWnP,GAAGrF,GAAG2U,WAAW9E,KAE/B,IAAI0G,gBAAiBxY,SACrB,KACIwY,eAAiBlR,GAAGwQ,qBACtB,MAAO9T,GACLsD,GAAGrF,GAAGgT,UAAUnS,YAAcE,WAAWgB,EAAEyU,SAG/C,GAAGD,iBAAmBxY,UAAU,CAE5BsH,GAAGgH,OAAOoK,UAAUC,qBAEjB,IAAGrR,GAAGmP,UAAY,GAAG,CAExBnP,GAAGrF,GAAGgT,UAAUnS,YAAc,kBAC9BwE,IAAGgH,OAAOoK,UAAUC,qBAEjB,CAIH,GAAIC,QAAS,GAAItR,IAAGyP,SACpB6B,QAAOC,WAAWL,eAClB,IAAIM,SAAUxR,GAAGgP,aAAesC,OAAOG,QAAQvB,QAE/C,IAAGsB,QAAQ5a,SAAW,EAAE,CAEpBoJ,GAAGrF,GAAGgT,UAAUnS,YAAc,mBAC9BwE,IAAGrF,GAAG0V,mBAAmB7U,YAAc,EACvCwE,IAAGgH,OAAOoK,UAAUC,qBAEnB,CAID,GAAIK,gBAAiBxB,QAAQyB,eAAeC,UAC5C,KAAI,GAAI9S,IAAG,EAAGA,GAAG0S,QAAQ5a,OAAQkI,KAC7B,GAAG0S,QAAQ1S,IAAIzJ,IAAIwc,IAAMH,eAAeI,MAAMD,KACzCL,QAAQ1S,IAAIzJ,IAAIwc,KAAOH,eAAeI,MAAMD,KAC5CL,QAAQ1S,IAAIzJ,IAAI0c,QAAUL,eAAeI,MAAMC,OACpD,KACJ,IAAIC,mBAAqBlT,IAAM0S,QAAQ5a,OAAS4a,QAAQ5a,OAAO,EAAIkI,EAGnE,KAAI,GAAIA,IAAG,EAAGA,GAAG0S,QAAQ5a,OAAQkI,KAC7BkB,GAAGiP,aAAaxX,KAAKyY,QAAQ+B,UAAUT,QAAQ1S,IAAK,oBAAqB,oBAAqB,OAGlG,KAAI,GAAIA,IAAG,EAAGA,GAAG0S,QAAQ5a,OAAQkI,KAC7B0S,QAAQ1S,KAAOoT,MAAOV,QAAQ1S,IAAKqT,IAAKrT,GAG5CkB,IAAGgO,uBAAuBgE,qBAMtChS,IAAGgO,uBAAyB,SAASgE,mBAOjChS,GAAGiO,uBAAyB+D,iBAE5B,IAAI9B,SAAUlQ,GAAGgH,OAAOmJ,YACxB,IAAInQ,GAAGkP,sBAAwBxW,UAAU,CACrCwX,QAAQE,aAAapQ,GAAGkP,oBACxBlP,IAAGkP,oBAAsBxW,UAG7B,GAAI8Y,SAAUxR,GAAGgP,YACjB,IAAIoD,eAEJ,IAAIC,oBAAqBrS,GAAGgJ,WAAWG,IAAI,eAE3C,IAAImJ,aAActS,GAAGwG,sBAAsB,GAAK6L,mBAAqB,EAAI,EAEzE,IAAGb,QAAQ5a,QAAU0b,YAAY,CAC7BF,YAAcZ,YACb,CACD,GAAIe,OAAQvS,GAAGwG,uBAAyB6L,mBAAqB,EAAI,EACjE,IAAIG,QAASxS,GAAGwG,qBAChB,IAAGwL,kBAAoBO,MAAM,CACzBH,YAAcA,YAAYK,OAAOjB,QAAQpY,MAAM4Y,kBAAoBO,OACnEH,aAAcA,YAAYK,OAAOjB,QAAQpY,MAAM,EAAG4Y,wBAC/C,CACHI,YAAcA,YAAYK,OAAOjB,QAAQpY,MAAM4Y,kBAAoBO,MAAOP,oBAE9EI,YAAY3a,KAAK+Z,QAAQQ,mBACzB,IAAGA,kBAAoBQ,QAAUhB,QAAQ5a,OAAO,CAC5Cwb,YAAcA,YAAYK,OAAOjB,QAAQpY,MAAM4Y,kBAAoB,GACnEI,aAAcA,YAAYK,OAAOjB,QAAQpY,MAAM,EAAGoZ,OAAS,GAAKhB,QAAQ5a,OAASob,yBAC9E,CACHI,YAAcA,YAAYK,OAAOjB,QAAQpY,MAAM4Y,kBAAoB,EAAGA,kBAAoBQ,OAAS,KAK3G,GAAIE,sBAAuB1S,GAAGgJ,WAAWG,IAAI,eAC7C,IAAIlI,MAAO,EACX,KAAI,GAAInC,IAAG,EAAGA,GAAGsT,YAAYxb,OAAQkI,KAAK,CACtC,GAAI+S,KAAMO,YAAYtT,IAAIoT,MAAMJ,MAAMD,GACtC,IAAIc,KAAMP,YAAYtT,IAAIoT,MAAMJ,MAAMC,MACtC,IAAIa,cAAe,GAAI5S,IAAG6P,SAASgC,IAAKgB,KAAKC,IAAI,EAAGH,IAAI3S,GAAGyG,uBAAwBoL,IAAKc,IACxF,IAAII,cAAeJ,IAAM3S,GAAGyG,qBAC5BoL,KAAMO,YAAYtT,IAAIoT,MAAM7c,IAAIwc,GAChCc,KAAMP,YAAYtT,IAAIoT,MAAM7c,IAAI0c,MAChC,IAAIiB,cAAe,GAAIhT,IAAG6P,SAASgC,IAAKc,IAAKd,IAAKc,IAAI3S,GAAG0G,sBACzDzF,OAAQ,gCAAkCmR,YAAYtT,IAAIqT,KAAKH,kBAAmB,uBAAyB,IAAM,KACrG,sCAAwCH,IAAI,GAAK,SACjD,iCACI,wCACKkB,aAAe,UAAY,IAAMrX,WAAWwU,QAAQ+C,aAAaL,eAClE,mCAAqClX,WAAWwU,QAAQ+C,aAAab,YAAYtT,IAAIoT,QAAU,UAC/FxW,WAAWwU,QAAQ+C,aAAaD,eACpC,SACJ,UACCN,qBAAuB,kFAAoF,IAChH,SAEZ1S,GAAGrF,GAAGqU,aAAavT,UAAYwF,IAC/B,IAAIpF,KAAMmE,GAAGrF,GAAGqU,aAAatH,uBAAuB,mBACpD,KAAI,GAAI5I,IAAG,EAAGA,GAAGjD,IAAIjF,OAAQkI,KAAM,GAAGsT,YAAYtT,IAAIqT,MAAQH,kBAC1DnW,IAAIiD,IAAI/E,iBAAiB,QAASiG,GAAGkT,kBAAkBd,YAAYtT,IAAIqT,KAC3E,IAAGO,qBAAqB,CACpB,GAAI7W,KAAMmE,GAAGrF,GAAGqU,aAAatH,uBAAuB,wBACpD,KAAI,GAAI5I,IAAG,EAAGA,GAAGjD,IAAIjF,OAAQkI,KACzBjD,IAAIiD,IAAI/E,iBAAiB,QAASiG,GAAGmT,0BAA0Bf,YAAYtT,IAAIqT,MAGvF,GAAGX,QAAQ5a,OAAS0b,YAChBtS,GAAGrF,GAAG0V,mBAAmB7U,YAAc,YAAcgW,QAAQ5a,OAAS0b,aAAe,oBAErFtS,IAAGrF,GAAG0V,mBAAmB7U,YAAc,EAG3CwE,IAAGkP,oBAAsBgB,QAAQ+B,UAAUT,QAAQQ,mBAAmBE,MAAO,4BAA6B,4BAA6B,MACvIlS,IAAGgH,OAAOoK,UAAUd,kBAAkBkB,QAAQQ,mBAAmBE,MAAO,MACxElS,IAAGgH,OAAOoM,SAASC,0BAGvBrT,IAAGsT,sBAAwB,WACvB,GAAGtT,GAAG+N,wBACF/N,GAAGgJ,WAAWG,IAAI,UAAY,aAAenJ,GAAGgJ,WAAWG,IAAI,cAAiBnJ,GAAGrF,GAAG2U,WAAW9E,MACjGxK,GAAGgQ,sBAGXhQ,IAAGkT,kBAAoB,SAASpU,IAE5B,MAAO,UAASpC,GAAGsD,GAAGgO,uBAAuBlP,KAGjDkB,IAAGmT,0BAA4B,SAASrU,IACpC,MAAO,UAASpC,GACZsD,GAAGuT,wBAAwBzU,GAC3BpC,GAAEvE,mBAIV6H,IAAGwT,iBAAmB,SAAS9W,GAE3B,GAAGA,EAAEqS,OAAS3L,MAAMC,OAAS3G,EAAEqS,OAAS3L,MAAME,KAAO5G,EAAEqS,OAAS3L,MAAMG,IAAM7G,EAAEqS,OAAS3L,MAAMI,KACzF,MACJ,IAAGxD,GAAGmP,UAAYnP,GAAGrF,GAAG2U,WAAW9E,MAC/B,MACJxK,IAAGgQ,sBAGPhQ,IAAGyT,mBAAqB,SAAS/W,GAG7B,GAAKA,EAAEqS,OAAS3L,MAAMC,QAAU3G,EAAEgX,WAAehX,EAAEiX,SAAWjX,EAAEqS,OAAS3L,MAAMI,KAAM,CAEjFxD,GAAGgO,uBAAuBhO,GAAGiO,uBAAyB,EAAIjO,GAAGgP,aAAapY,OAC9CoJ,GAAGiO,uBAAyB,EAC5B,EAC5BvR,GAAEzE,gBACF,YACE,IAAIyE,EAAEqS,OAAS3L,MAAMC,OAAS3G,EAAEgX,WAAehX,EAAEiX,SAAWjX,EAAEqS,OAAS3L,MAAMG,GAAI,CAEnFvD,GAAGgO,uBAAuBhO,GAAGiO,uBAAyB,EAAI,EAC9BjO,GAAGgP,aAAapY,OAAQ,EACxBoJ,GAAGiO,uBAAyB,EACxDvR,GAAEzE,gBACF,QAGJ,GAAGyE,EAAEqS,OAAS3L,MAAME,IAAI,CACpBtD,GAAGgJ,WAAWC,IAAI,YAAa,MAC/BvM,GAAEzE,gBACFyE,GAAEvE,iBACF,SAKR6H,IAAG4T,2BAA6B,SAASlX,GACrC,GAAGA,EAAEqS,OAAS3L,MAAMC,MAAM,CACtB,GAAG3G,EAAEiX,SAAWjX,EAAEgX,SACd1T,GAAG6T,uBAEH7T,IAAGuT,wBAAwBvT,GAAGiO,uBAClCvR,GAAEzE,qBACD,CACD+H,GAAGyT,mBAAmB/W,IAI9BsD,IAAG6T,iBAAmB,SAASnX,GAC3B,IACI,GAAIoX,SAAU9T,GAAGwQ,qBACnB,MAAO9T,GACLsD,GAAGoH,WAAW1K,EAAEyU,QAChB,QAEJnR,GAAGgH,OAAO+M,WAAW/T,GAAGrF,GAAG6U,mBAAmBhF,MAAOsJ,QACrD9T,IAAGuO,eAGPvO,IAAGgU,mBAAqBhU,GAAG6T,gBAE3B7T,IAAGuT,wBAA0B,SAASpB,KAClC,GAAID,OAAQlS,GAAGgP,aAAamD,KAAKD,KAEjClS,IAAGgH,OAAOiN,QAAQhL,IAAIjJ,GAAGwQ,qBACzBxQ,IAAGgH,OAAOkN,YAAYhC,MAAOlS,GAAGrF,GAAG6U,mBAAmBhF,MACtDxK,IAAGgQ,sBC3bP,aAEAhQ,IAAGmU,SAAW,WACV,GAAIC,SAAUpU,GAAGgH,OAAOkJ,QAAQmE,IAAIC,aACpC,IAAIrT,MAAO6K,MAAMsI,QAAQxd,OAEzB,KAAI,GAAID,GAAE,EAAGA,EAAEyd,QAAQxd,OAAOD,IAC1BsK,KAAKtK,GAAK,8BAAgCqJ,GAAGuU,aAAa5d,GAAK,aAEnE,IAAI6d,aAAcva,OAAOiE,KAAK,GAAG,GACjCsW,aAAYta,SAASua,QACb,sBAAwBzU,GAAGsH,SAAS1H,MAClC,yBACA8P,IAAIC,QAAQ,aAAe3P,GAAGgJ,WAAWG,IAAI,UAAUuL,QAAU,oBACjE1U,GAAGgJ,WAAWG,IAAI,YAAa,GAAI,4BACrC,sFACE,sDACF,oBAAqBnJ,GAAGgJ,WAAWG,IAAI,SAASxP,QAAQ,IAAI,KAAM,sBAClEsH,KAAKzD,KAAK,IACV,sBACRgX,aAAY9R,OACZ,OAAO,OAGX1C,IAAGuU,aAAe,SAAUI,GACxB,GAAIC,YAAaC,OAAOC,OAAOpF,IAAIC,QAAQ,kBAAkBoF,KAAK7V,UAClE,IAAI8V,QAAUhV,GAAGgH,OAAOmJ,aAAa8E,UAAUN,EAC/C,IAAI1T,QACJ,IAAIiU,cAAe,CACnB,KAAK,GAAIve,GAAI,EAAGA,EAAIqe,OAAOpe,OAAQD,IAAK,CACrC,GAAI+S,OAAQsL,OAAOre,EACnB,IAAI6T,OAAQd,MAAMc,MAAM7Q,QAAQ,MAAM,MACtC,IAAG6Q,MACCoK,WAAWO,aAAalU,KAAM,EAAGyI,MAAOc,OAE/C,MAAOvJ,MAAKzD,KAAK,IAAI7D,QAAQ,UAAU;CCnC3C,aAEAqG,IAAGoV,SAAW,WACV,GAAGC,UAAUD,SAAS/Y,QAAQ,QAAS,EACnC,MAAO,cACN,IAAGgZ,UAAUD,SAAS/Y,QAAQ,UAAW,EAC1C,MAAO,YACN,IAAGgZ,UAAUD,SAAS/Y,QAAQ,QAAQ,EACvC,MAAO,KAEX,OAAO,QAGX2D,IAAGsV,sBAAwB,WAGvB,GAAIC,MAAOvV,GAAGe,cACd,IAAIyU,QACJ,IAAIJ,UAAWpV,GAAGoV,QAElB,IAAGA,UAAY,WAAaA,UAAY,QAAQ,CAC7C,IAAI,GAAIze,GAAE,EAAEA,EAAE4e,KAAK3e,OAAOD,IAAI,CACzB,GAAI8e,OAAQF,KAAK5e,GAAGgC,MAAM,IAC1B,IAAG8c,MAAM,GAAG7e,OACR4e,KAAKC,MAAM,IAAMA,MAAM,QAE7B,IAAGL,UAAY,MAAM,CACvB,IAAI,GAAIze,GAAE,EAAEA,EAAE4e,KAAK3e,OAAOD,IAAI,CAC1B,GAAI8e,OAAQF,KAAK5e,GAAGgC,MAAM,IAC1B,IAAG8c,MAAM,GAAG7e,OACR4e,KAAKC,MAAM,IAAMA,MAAM7e,OAAS,EAAG6e,MAAM,GAAKA,MAAM,QAE3D,EAIL,GAAIxU,QACJ,KAAI,GAAIyU,UAAUF,MACdvU,KAAKxJ,KAAK,2DACCie,OAAS,mCAAqCF,KAAKE,QAAQ/b,QAAQ,IAAI,QACvE,eACf,KAAI,GAAI+b,UAAU1V,IAAGwC,aAAa,GAAGkT,SAAUF,MAC3CxV,GAAGwC,aAAakT,SAAWF,KAAKE,OAEpC1V,IAAGrF,GAAGgb,oBAAoBla,WACtB,oEACK2Z,SAAW,IAAMA,SAAW,IAAM,GACvC,SACA,+FACA,+BACAnU,KAAKzD,KAAK,IACV,UAAUA,KAAK,IAIvBwC,IAAG4V,YAAc,SAASlZ,GACtBsD,GAAGgJ,WAAWC,IAAI,aAAcjJ,GAAGgJ,WAAWG,IAAI,aAElD,IAAGnJ,GAAGgJ,WAAWG,IAAI,cAAgBnJ,GAAGgJ,WAAWG,IAAI,SAAW,YAC9D,GAAGnJ,GAAGgJ,WAAWG,IAAI,aACjBnJ,GAAGrF,GAAG8T,gBAAgBjQ,YAEtBwB,IAAGrF,GAAG2U,WAAW9Q,OACzB9B,GAAEzE,iBAGN+H,IAAG6V,mBAAqB,SAASnZ,GAC7B,GAAIoZ,KAAM9V,GAAGgH,OAAOkJ,QAAQ+C,aAAajT,GAAGgH,OAAO+O,oBACnD/V,IAAGgJ,WAAWC,IAAI,YAAa,MAC/BjJ,IAAGgJ,WAAWC,IAAI,OAAQ,YAC1BjJ,IAAGgJ,WAAWC,IAAI,YAAa,KAC/B,IAAG6M,IAAI,CACH9V,GAAGrF,GAAG2U,WAAW9E,MAAQsL,GACzB9V,IAAGrF,GAAG2U,WAAW0G,SAErBhW,GAAGrF,GAAG2U,WAAW9Q,OACjB9B,GAAEzE,iBAGN+H,IAAGiW,wBAA0B,SAASvZ,GAClCsD,GAAGgJ,WAAWC,IAAI,YAAa,KAC/BjJ,IAAGgJ,WAAWC,IAAI,OAAQ,YAC1BjJ,IAAGgJ,WAAWC,IAAI,YAAa,KAC/BjJ,IAAGrF,GAAG8T,gBAAgBjQ,OACtB9B,GAAEzE,iBAGN+H,IAAGkW,2BAA6B,SAASxZ,GACrCsD,GAAGgJ,WAAWC,IAAI,eAAgB,KAClCjJ,IAAG6V,mBAAmBnZ,GAG1BsD,IAAGmW,wBAA0B,WAKzBnW,GAAGgH,OAAOoP,SAASC,gBACf,OAAO,eAAe,WAAW,UAAU,iBAAiB,YAAY,mBAAmB,YAG/Fjf,KAAI,iDAAkD4I,GAAGsW,aACzDlf,KAAI,iDAAkD4I,GAAGmU,SACzD/c,KAAI,iDAAkD4I,GAAGuW,QACzDnf,KAAI,iDAAkD4I,GAAGwW,OACzDpf,KAAI,iDAAkD4I,GAAGiW,wBACzD7e,KAAI,iDAAkD4I,GAAG6V,mBACzDze,KAAI,iDACD,mDAAoD4I,GAAGkW,2BAC1D9e,KAAI,iDAAkD4I,GAAGqH,uBACzDjQ,KAAI,MAAO4I,GAAG4V,YACdxe,KAAIO,OAAS,WAAW,MAAO,GAG/B,IAAI8e,aAAc9G,QAAQ,6BAA6B8G,WACvD,IAAIC,gBAAiB,GAAID,eACpBE,SAAUC,IAAK,YAAYC,IAAK,gBAAiBC,MAAO,+BAAgCC,KAAM/W,GAAGgX,0BACjGL,SAAUC,IAAK,YAAYC,IAAK,gBAAiBC,MAAO,+BAAgCC,KAAM/W,GAAGgX,0BACjGL,SAAUC,IAAK,aAAaC,IAAI,iBAAkBC,MAAO,kCAAmCC,KAAM/W,GAAGiX,2BACrGN,SAAUC,IAAK,UAAUC,IAAI,cAAeC,MAAO,kCAAmCC,KAAM/W,GAAGiX,2BAEpGjX,IAAGgH,OAAOkQ,WAAWC,mBAAmBT,eAGxC1W,IAAGoX,SAAW,MACd,IAAGpX,GAAGoV,UAAY,MAAM,CACpBpV,GAAGoX,SAAW,KACd,IAAIvb,KAAMmE,GAAG0H,uBAAuB,WACpC,KAAI,GAAI5I,IAAG,EAAGA,GAAGjD,IAAIjF,OAAQkI,KACzBjD,IAAIiD,IAAItD,YAAc,OCjIlC,aAIAwE,IAAGqX,YAAc,OAMjBrX,IAAGsX,yBAA2B,IAC9BtX,IAAGkH,mBAAqB,KAExBlH,IAAGwM,QAIC+K,UAAW,EACXC,UAAW,EACXC,aAAc,EACdC,eAAgB,EAChBC,aAAc,EACdC,eAAgB,EAChBC,kBAAmB,EAGvB7X,IAAGsH,UACCmC,QAAS,KACTqO,UAAW,KACXlY,MAAO,KACPuD,YAAa,GACbO,IAAK,GACLqU,iBAAkB,GAClBC,kBAAmB,OACnBC,cAAe1a,IAAK,QACpB2a,YAAa,KACbC,UAAW,GACXC,UAAW,MACXC,cAAeC,KAAM,KAAM1Y,MAAO,KAAMuD,YAAa,MACrDoV,oBAAqBD,KAAM,EAAG1Y,MAAO,EAAGuD,YAAa,GACrDqV,aAAc,MACdC,UAAW,MACXlR,aAAc,MACdmR,uBAAwB,MACxBC,gBACAC,sBACAC,mBAAoB,EAExB7Y,IAAG8Y,sBACH9Y,IAAG+Y,YAAc,IACjB/Y,IAAGgZ,oBAAqB,SAAUC,QAAQC,MAAMC,QAC5C,GAAI/iB,IAAK,GACT,KAAI,GAAIO,GAAEuiB,MAAMviB,EAAEA,IAAI,IAAI,GAAIzD,GAAE,EAAEA,EAAEimB,OAAOjmB,IACvCkD,EAAEqB,KAAKwhB,QAAUtiB,EACrB,OAAOP,IACR,eAAe,EAAE,EACpB4J,IAAGoZ,uBAAwB,SAAUH,QAAQC,MAAMC,QAC/C,GAAI/iB,IAAK,GACT,KAAI,GAAIO,GAAEuiB,MAAMviB,EAAEA,IAAI,IAAI,GAAIzD,GAAE,EAAEA,EAAEimB,OAAOjmB,IACvCkD,EAAEqB,KAAKwhB,QAAUtiB,EACrB,OAAOP,IACR,iBAAiB,EAAE,EACtB4J,IAAGrF,GAAKqF,GAAGrF,MA0CXqF,IAAGqZ,kBAAoB,SAASnc,KAG5B8C,GAAGwM,OAAO8M,eAAiB,CAC3BtZ,IAAGwM,OAAOmL,aAAe,CACzB3X,IAAGuZ,aACH,IAAGrc,KAAOA,IAAIsc,MAAQtc,IAAIsc,OAAS,yBAC/BxZ,GAAGyZ,kBACF,IAAGvc,IACJ8C,GAAGoH,WAAWlK,IAAIwc,OAAOC,MAAMxI,aAC/B,CAEAnR,GAAGgJ,WAAWC,IAAI,OAAQ,mBAC1BjJ,IAAGgJ,WAAWC,IAAI,YAAa,OAC/BtN,eAAcqE,GAAGrF,GAAGif,WAAY,QAAS,aAAc5Z,GAAGoG,iBAIlEpG,IAAGyZ,YAAc,WACbzZ,GAAGwM,OAAO8M,cAAgB,CAC1BtZ,IAAGuZ,aACH5P,MAAKC,KAAKiQ,UAAU7Z,GAAG8Z,SAAS,OAC3B3c,KAAK6C,GAAG+Z,QAAQC,QAAQC,KAAKja,GAAG+Z,SAC3B/Z,GAAG+Z,QAAQG,OAAOD,KAAKja,GAAG+Z,UAGxC/Z,IAAGma,cAAgB,WAGfna,GAAGwM,OAAOmL,aAAe,CACzB3X,IAAGwM,OAAO8M,cAAgB,CAC1BtZ,IAAGuZ,aACH5P,MAAKC,KAAKiQ,UAAU7Z,GAAG8Z,SAAS,QAC3B3c,KAAK6C,GAAG+Z,QAAQC,QAAQC,KAAKja,GAAG+Z,SAC3B/Z,GAAG+Z,QAAQG,OAAOD,KAAKja,GAAG+Z,UAIxC/Z,IAAGoa,eAAiB,SAASC,GACzBra,GAAGsa,UAAYD,EAAEX,MACjB1Z,IAAGrF,GAAG4f,UAAU/e,YAAc6e,EAAEX,OAAOc,KAO3Cxa,IAAGya,SAAW,WACV,IAAIza,GAAGsH,SAASmC,QAAQ,CACpBzJ,GAAGoH,WAAW,6EACd,OAAO,OAEXpH,GAAGwM,OAAOiL,cAAgB,CAC1BzX,IAAGsH,SAASmR,UAAY,CACxBzY,IAAGuZ,aAEH,IAAGvZ,GAAGrF,GAAG+f,aAAa,CAClB1a,GAAG2a,mBACA,CACHhR,KAAKiR,KAAK,cAAe,WACrB5a,GAAGrF,GAAG+f,aAAe,GAAI/Q,MAAK9G,MAAMgY,MAAMC,YAAY9a,GAAG+a,UACzD/a,IAAG2a,kBAMf3a,IAAG2a,aAAe,WACd3a,GAAGrF,GAAG+f,aAAaM,YAAYhb,GAAGsH,SAASmC,SAC3CzJ,IAAGrF,GAAG+f,aAAaO,cAActR,KAAKC,KAAKC,WAAWC,aACtD9J,IAAGrF,GAAG+f,aAAaQ,qBAOvBlb,IAAGmb,gBAAkB,SAAShgB,KAC1B,GAAIigB,SAAUjgB,IAAIkB,QAAQ,KAC1B,IAAG+e,UAAY,EACX,MAAOpb,IAAGqb,oBAAoB,OAElC,IAAIC,QAASngB,IAAIkB,QAAQ,UAAY,CACrC,IAAIkf,YAAapgB,IAAIqgB,MAAM,WAAa,KAAO,KAE/C,IAAGF,SAAWC,WACV,MAAQvb,IAAGsH,SAAS0Q,kBAAoBhY,GAAGqb,oBAAoB,UACnE,IAAGE,aAAeD,OACd,MAAQtb,IAAGsH,SAAS0Q,kBAAoBhY,GAAGqb,oBAAoB,OAEnE,OAAQrb,IAAGsH,SAAS0Q,kBAAoBhY,GAAGqb,oBAAoB,SAGnErb,IAAGyb,qBAAuB,SAAStgB,KAC/B,GAAIugB,gBAAiB1b,GAAGgJ,WAAWG,IAAI,iBAEvC,IAAGuS,gBAAkB,UAAU,CAC3B1b,GAAGrF,GAAGghB,qBAAqB1f,UAAUO,IAAI,WACzCwD,IAAGrF,GAAGihB,kBAAkB3f,UAAUC,OAAO,gBACxC,CACD8D,GAAGrF,GAAGihB,kBAAkB3f,UAAUO,IAAI,WACtCwD,IAAGrF,GAAGghB,qBAAqB1f,UAAUC,OAAO,YAGjD,SAAUf,MAAO,SACb6E,GAAGmb,gBAAgBhgB,IAEvB6E,IAAGqb,oBAAoBrb,GAAGsH,SAAS0Q,kBAElChY,IAAGrF,GAAGkhB,oBAAoB5f,UAAUC,OAAO,WAC3C8D,IAAGrF,GAAGmhB,qBAAqB7f,UAAUC,OAAO,WAC5C8D,IAAGrF,GAAGohB,kBAAkB9f,UAAUC,OAAO,WAC1C,IAAG8D,GAAGsH,SAASqR,aAAa3T,SAAW,SAAS,CAC3C,GAAGhF,GAAGsH,SAAS0Q,mBAAqB,WAAahY,GAAGsH,SAAS0Q,mBAAqB,OAC9EhY,GAAGgH,OAAOkJ,QAAQ8L,eAAehc,GAAGsH,SAAS0Q,uBAE7ChY,IAAGgH,OAAOkJ,QAAQ8L,eAAeN,eACrC1b,IAAGrF,GAAGkhB,oBAAoB5f,UAAUO,IAAI,gBACvC,CACDwD,GAAGgH,OAAOkJ,QAAQ8L,eAAehc,GAAGsH,SAASqR,aAAa3T,QACtD,IAAGhF,GAAGsH,SAASqR,aAAa3T,SAAW,UACnChF,GAAGrF,GAAGmhB,qBAAqB7f,UAAUO,IAAI,gBAEzCwD,IAAGrF,GAAGohB,kBAAkB9f,UAAUO,IAAI,aAItDwD,IAAGqb,oBAAsB,SAASY,WAC9B,GAAI9gB,IACJ,QAAO8gB,WACH,IAAK,OACD9gB,IAAO,oCAAsC6E,GAAGgJ,WAAWG,IAAI,kBAAoB,OACnF,MACJ,KAAK,QACDhO,IAAM,4CAA8C6E,GAAGgJ,WAAWG,IAAI,kBAAoB,OAC1F,MACJ,SACIhO,IAAM,YAAc8gB,UAAY,iBAGxCjc,GAAGrF,GAAGuhB,kBAAkB1gB,YAAc,IAAML,IAAK,GAEjD,OAAO8gB,WAQXjc,IAAGmc,kBAAoB,WACnBxS,KAAKiR,KAAK,SAAU,WAChB,GAAIwB,MAAO,GAAIC,QAAOC,OAAOC,KAAKF,OAAOC,OAAOE,OAAOC,KACvD,KACI,IAAIzc,GAAG0c,YAAY,CACf1c,GAAG0c,aAAc,GAAIL,QAAOC,OAAOK,eAClCC,cAAcP,OAAOC,OAAOO,QAAQC,YACpCC,SAAS/c,GAAG+a,WACZE,cAActR,KAAKC,KAAKC,WAAWC,cACnCkT,QAAQZ,MACRa,YAAYjd,GAAGkd,iBACfC,OACD,KAAInd,GAAG0c,YACH,KAAM,yBAEd1c,GAAG0c,YAAYU,WAAW,MAC5B,MAAO1gB,GACLsD,GAAGoH,WAAW,GAAK1K,MAM/BsD,IAAGkd,gBAAkB,SAAS9Q,MAC1B,GAAIA,KAAKsJ,QAAU2G,OAAOC,OAAOe,OAAOC,OAAQ,CAC5C,GAAI7T,SAAU2C,KAAKmR,KAAK,GAAGC,EAC3B,IAAIC,KAAM,UAAYC,KAAKC,WACvBjI,OAAQ,OACRkI,OAAQ5d,GAAG6d,YACXC,KAAMrU,UAEVxP,QAAO8jB,SAAWN,QAChB,IAAGrR,KAAKsJ,QAAU,SAAS,CAC7B,GAAG1V,GAAGge,aACFhe,GAAGge,aAAaC,OACpBje,IAAGuO,eAEPvO,GAAGge,aAAetlB,UAQtBsH,IAAGke,gBAAkB,SAASC,YAG1Bne,GAAGrF,GAAGgb,oBAAoB9a,MAAMgD,QAAU,MAC1CmC,IAAGrF,GAAGyjB,eAAevjB,MAAMgD,QAAU,MACrCmC,IAAGrF,GAAG0jB,eAAexjB,MAAMgD,QAAU,MAErCmC,IAAGrF,GAAG2jB,iBAAiBriB,UAAUC,OAAO,WACxC8D,IAAGrF,GAAG4jB,YAAYtiB,UAAUC,OAAO,WAEnC,IAAGiiB,YAAc,OAAO,CACpBne,GAAGrF,GAAGyjB,eAAevjB,MAAMgD,QAAU,EACrCmC,IAAGrF,GAAG4jB,YAAYtiB,UAAUO,IAAI,gBAC7B,IAAG2hB,YAAc,YAAY,CAChCne,GAAGrF,GAAGgb,oBAAoB9a,MAAMgD,QAAU,EAC1CmC,IAAGrF,GAAG2jB,iBAAiBriB,UAAUO,IAAI,gBAClC,CACHwD,GAAGrF,GAAG0jB,eAAexjB,MAAMgD,QAAU,IAI7CmC,IAAGwe,UAAY,SAAShB,IACpB,GAAI7iB,IAAKT,SAAS6M,eAAeyW,GAGjC,KAAI,GAAI1e,IAAG,EAAGA,GAAKkB,GAAGrF,GAAG6M,eAAe9I,SAAS9H,OAAQkI,KAAK,GAAGkB,GAAGrF,GAAG6M,eAAe9I,SAASI,MAAQnE,GAAG,CACtGqF,GAAGrF,GAAG6M,eAAe9I,SAASI,IAAIjE,MAAMgD,QAAU,MAClD,IAAI4gB,SAAUze,GAAG0e,uBAAuB1e,GAAGrF,GAAG6M,eAAe9I,SAASI,IAAI0e,GAC1E,IAAGiB,QACCA,QAAQxiB,UAAUC,OAAO,iBAGjC,GAAGvB,GAAG,CACFA,GAAGE,MAAMgD,QAAU,EACnB,IAAI4gB,SAAUze,GAAG0e,uBAAuB/jB,GAAG6iB,GAC3C,IAAGiB,QACCA,QAAQxiB,UAAUO,IAAI,qBACzB,CACDwD,GAAGgJ,WAAWC,IAAI,YAAa,QAIvCjJ,IAAG2e,kBAAoB,SAASjiB,GAC5BsD,GAAG4e,wBACKC,UAAWniB,EAAEoiB,QACbC,SAAUriB,EAAEsiB,QACZC,WAAYC,KAAKC,MACjBC,YAAa1iB,EAAE2iB,SAAW,EAClCnlB,UAASH,iBAAiB,YAAaiG,GAAGsf,2BAC1CplB,UAASH,iBAAiB,UAAWiG,GAAGuf,0BAG5Cvf,IAAGsf,2BAA6B,SAAS5iB,GACrC,GAAItG,GAAIsG,EAAEoiB,QAAQ9e,GAAG4e,uBAAuBC,QAC5C,IAAI3jB,GAAIwB,EAAEsiB,QAAQhf,GAAG4e,uBAAuBG,OAC5C,KAAI/e,GAAG4e,uBAAuBQ,YAAY,CACtCpf,GAAG4e,uBAAuBQ,YAAeF,KAAKC,MAAQnf,GAAG4e,uBAAuBK,WAAajf,GAAGoF,eACtDhP,EAAEA,EAAI8E,EAAEA,EAAI8E,GAAGqF,cAAgBrF,GAAGqF,cAEhF,GAAGrF,GAAG4e,uBAAuBQ,YACzBnkB,UAAU+E,GAAGrF,GAAGif,WAAYxjB,EAAG8E,EACnCwB,GAAEvE,kBAIN6H,IAAGuf,yBAA2B,SAAS7iB,GACnCxC,SAASoE,oBAAoB,YAAa0B,GAAGsf,2BAC7CplB,UAASoE,oBAAoB,UAAW0B,GAAGuf,yBAE3C,IAAGvf,GAAG4e,uBAAuBQ,YAAY,CACrC,GAAII,KAAMxf,GAAGrF,GAAGif,WAAW6F,uBAC3BxkB,WAAU+E,GAAGrF,GAAGif,WAAY,EAAG,EAG/B,IAAI8F,UAAW1f,GAAGrF,GAAGif,WAAW+F,WAChC,IAAIC,UAAW5f,GAAGrF,GAAGif,WAAWiG,YAChC,IAAIC,UAAW7lB,OAAO8lB,UACtB,IAAIC,UAAW/lB,OAAOgmB,WACtB,IAAIC,UACJ,IAAGV,IAAI1qB,KAAOgrB,UAAYN,IAAI1qB,KAAO4qB,UAAU,CAC3CQ,OAAO,GAAK,GACZA,QAAO,GAAKrN,KAAKC,IAAI,EAAE0M,IAAI1qB,KAAKgrB,SAAW,SAC1C,CACDI,OAAO,GAAK,GACZA,QAAO,GAAKrN,KAAKC,IAAI,GAAGgN,UAAYN,IAAI1qB,KAAO4qB,WAAWI,SAAW,KAEzE,GAAGN,IAAIW,IAAMH,UAAYR,IAAIW,IAAKP,UAAU,CACxCM,OAAO,GAAK,GACZA,QAAO,GAAKrN,KAAKC,IAAI,EAAE0M,IAAIW,IAAIH,SAAW,SACzC,CACDE,OAAO,GAAK,GACZA,QAAO,GAAKrN,KAAKC,IAAI,GAAGkN,UAAYR,IAAIW,IAAMP,WAAWI,SAAW,KAGxE,GAAGhgB,GAAGgJ,WACFhJ,GAAGgJ,WAAWC,IAAI,gBAAgBiX,YAErC,CACDlgB,GAAGgJ,WAAWC,IAAI,aAAcjJ,GAAGgJ,WAAWG,IAAI,cAEtDnJ,GAAG4e,uBAAyBlmB,UAGhCsH,IAAGogB,oBAAsB,SAASF,QAC9BA,OAASpU,MAAMuU,QAAQH,QAAUA,OAASlgB,GAAGgJ,WAAWG,IAAI,gBAC5D,IAAIuW,UAAW1f,GAAGrF,GAAGif,WAAW+F,WAChC,IAAIC,UAAW5f,GAAGrF,GAAGif,WAAWiG,YAChC,IAAIC,UAAW7lB,OAAO8lB,UACtB,IAAIC,UAAW/lB,OAAOgmB,WAEtB,IAAGC,OAAO,IAAM,IAAI,CAEhB,GAAGJ,SAAWI,OAAO,GAAG,IAAMR,SAAWI,SAAS,CAC9C9f,GAAGrF,GAAGif,WAAW/e,MAAM/F,KAAO,SAC9BkL,IAAGrF,GAAGif,WAAW/e,MAAM7F,MAAQ,UAC9B,CACDgL,GAAGrF,GAAGif,WAAW/e,MAAM/F,KAAOorB,OAAO,GAAK,GAC1ClgB,IAAGrF,GAAGif,WAAW/e,MAAM7F,MAAQ,GAInCgL,GAAGrF,GAAG2lB,YAAYrkB,UAAUO,IAAI,UAChCwD,IAAGrF,GAAG6M,eAAevL,UAAUO,IAAI,UACnC,IAAIX,KAAM3B,SAASwN,uBAAuB,mBAC1C,KAAI,GAAI5I,IAAG,EAAGA,GAAGjD,IAAIjF,OAAQkI,KACzBjD,IAAIiD,IAAI7C,UAAUO,IAAI,eAEzB,CAED,GAAIsjB,SAAWI,OAAO,GAAG,IAAMR,SAAWI,SAAS,CAC/C9f,GAAGrF,GAAGif,WAAW/e,MAAM/F,KAAO,KAC9BkL,IAAGrF,GAAGif,WAAW/e,MAAM7F,MAAQ,OAC9B,CACDgL,GAAGrF,GAAGif,WAAW/e,MAAM/F,KAAO,SAC9BkL,IAAGrF,GAAGif,WAAW/e,MAAM7F,MAAQkrB,OAAO,GAAK,IAI/ClgB,GAAGrF,GAAG2lB,YAAYrkB,UAAUC,OAAO,UACnC8D,IAAGrF,GAAG6M,eAAevL,UAAUC,OAAO,UACtC,IAAIL,KAAM3B,SAASwN,uBAAuB,mBAC1C,KAAI,GAAI5I,IAAG,EAAGA,GAAGjD,IAAIjF,OAAQkI,KACzBjD,IAAIiD,IAAI7C,UAAUC,OAAO,WAGjC,GAAGgkB,OAAO,IAAM,IAAI,CAEhB,GAAGF,SAAWE,OAAO,GAAG,IAAMN,SAAWI,SAAS,CAC9ChgB,GAAGrF,GAAGif,WAAW/e,MAAMslB,IAAM,SAC7BngB,IAAGrF,GAAGif,WAAW/e,MAAM0lB,OAAS,UAC/B,CACDvgB,GAAGrF,GAAGif,WAAW/e,MAAMslB,IAAMD,OAAO,GAAK,GACzClgB,IAAGrF,GAAGif,WAAW/e,MAAM0lB,OAAS,QAEnC,CAED,GAAGP,SAAWE,OAAO,GAAG,IAAMN,SAAWI,SAAS,CAC9ChgB,GAAGrF,GAAGif,WAAW/e,MAAMslB,IAAM,KAC7BngB,IAAGrF,GAAGif,WAAW/e,MAAM0lB,OAAS,OAC/B,CACDvgB,GAAGrF,GAAGif,WAAW/e,MAAMslB,IAAM,SAC7BngB,IAAGrF,GAAGif,WAAW/e,MAAM0lB,OAASL,OAAO,GAAK,MAQxDlgB,IAAGwgB,cAAgB,SAASC,OAExB,GAAGA,MAAM,CACLzgB,GAAGrF,GAAG2lB,YAAYzlB,MAAMgD,QAAU,EAClCmC,IAAGrF,GAAG6M,eAAe3M,MAAMgD,QAAU,OACpC,CACDmC,GAAGrF,GAAG2lB,YAAYzlB,MAAMgD,QAAU,MAClCmC,IAAGrF,GAAG6M,eAAe3M,MAAMgD,QAAU,QAI7CmC,IAAGuZ,YAAc,WAEb,GAAImH,GAAI,EACR,IAAG1gB,GAAGwM,OAAOkL,gBAAkB,EAAE,CAE7B,GAAG1X,GAAGwM,OAAO8M,gBAAkB,EAC3BoH,EAAI,gCACH,IAAG1gB,GAAGwM,OAAOmL,aACd+I,EAAI,uCAEJA,GAAI,wBACL,IAAI1gB,GAAGsH,SAASmC,QAAQ,CAE3B,GAAIzJ,GAAGwM,OAAOgL,YAAc,GAAKxX,GAAGwM,OAAO+K,YAAc,EAAE,CACvDmJ,EAAI1gB,GAAGsH,SAAS1H,KAChB,IAAI+gB,SACJ,IAAG3gB,GAAGsH,SAASkR,aACXmI,MAAMlpB,KAAK,YACf,IAAGuI,GAAGsH,SAASmR,UACXkI,MAAMlpB,KAAK,SACf,IAAGuI,GAAGwM,OAAOiL,eAAiB,EAC1BkJ,MAAMlpB,KAAK,yBACf,KAAIuI,GAAGsH,SAAS4Q,YACZyI,MAAMlpB,KAAK,kBACf,IAAGkpB,MAAM/pB,OACL8pB,GAAK,MAAQC,MAAMnjB,KAAK,MAAQ,QAClC,IAAGwC,GAAGwM,OAAOgL,YAAc,GAAKxX,GAAGwM,OAAO+K,YAAc,EAC1DmJ,EAAI,kBAAoB1gB,GAAGsH,SAASmC,YACnC,IAAGzJ,GAAGwM,OAAOgL,YAAc,GAAKxX,GAAGwM,OAAO+K,YAAc,EACzDmJ,EAAI,YAAc1gB,GAAGsH,SAASkR,aAAc,aAAe,IACnD,UAAYxY,GAAGsH,SAAS1H,UAC/B,IAAGI,GAAGwM,OAAOgL,YAAc,GAAKxX,GAAGwM,OAAO+K,YAAc,EACzDmJ,EAAI,+BAAiC1gB,GAAGsH,SAASmC,YAChD,IAAGzJ,GAAGwM,OAAOgL,YAAc,EAC5BkJ,EAAI,uBAAyB1gB,GAAGsH,SAASkR,aAAc,aAAe,IAC3D,UAAYxY,GAAGsH,SAAS1H,UAClC,IAAGI,GAAGwM,OAAO+K,YAAc,EAC5BmJ,EAAI,0CAA4C1gB,GAAGsH,SAASmC,YAE5DiX,GAAI,yBAA2B1gB,GAAGsH,SAASmC,YAC5C,CAEHiX,EAAI,qBAGRrlB,WAAW2E,GAAGrF,GAAGimB,YAAaF,EAAG,MAGrC1gB,IAAGoH,WAAa,SAAS+J,SACrB7E,QAAQC,IAAI4E,QACZ9V,YAAW2E,GAAGrF,GAAGkmB,kBAAmB1P,QAAQ,KAC5CnR,IAAGrF,GAAGmmB,aAAajmB,MAAMgD,QAAU,EACnClC,eAAcqE,GAAGrF,GAAGif,WAAY,QAAS,WACrC5Z,GAAGrF,GAAGmmB,aAAajmB,MAAMgD,QAAU,QACpCmC,GAAGoG,gBAGVpG,IAAG+gB,yBAA2B,WAC1B,GAAIllB,KAAM3B,SAASwN,uBAAuB,aAC1C,IAAIsZ,MAAOhhB,GAAGsH,SAASwQ,UACX,qCAAuC9X,GAAGsH,SAASwQ,UACjD,0BACd,KAAI,GAAIhZ,IAAG,EAAGA,GAAGjD,IAAIjF,OAAQkI,KACzBjD,IAAIiD,IAAIkiB,KAAOA,KASvBhhB,IAAGihB,uBAAyB,SAAS5M,KAEjC,GAAI6M,qBAAsBlhB,GAAGgJ,UAC7BhJ,IAAGgJ,WAAaqL,IAAI8M,WAAWC,SAC/BphB,IAAGqhB,YAAcrhB,GAAGgJ,WAAWG,IAAI,YACnC,KAAInJ,GAAGqhB,YAAY,CACfrhB,GAAGgJ,WAAWC,IAAI,YAAaoL,IAAI8M,WAAWG,aAC9CthB,IAAGqhB,YAAcrhB,GAAGgJ,WAAWG,IAAI,aAEvCnJ,GAAGuhB,eAAiBvhB,GAAGgJ,WAAWG,IAAI,cACtC,KAAInJ,GAAGuhB,eAAe,CAClBvhB,GAAGgJ,WAAWC,IAAI,cAAeoL,IAAI8M,WAAWG,aAChDthB,IAAGuhB,eAAiBvhB,GAAGgJ,WAAWG,IAAI,eAG1C,GAAIqY,cAAexhB,GAAGgJ,WAAWxQ,MACjCwH,IAAGgJ,WAAWjP,iBAAiB4P,KAAK9G,MAAM4e,SAASC,UAAUC,cAAe3hB,GAAG4hB,iBAC/EtV,SAAQC,IAAI,kCACZ,KAAI,GAAImU,KAAK1gB,IAAGyD,iBACZ,GAAGid,IAAKQ,qBAAoBW,WACxB7hB,GAAGgJ,WAAWC,IAAIyX,EAAEQ,oBAAoB/X,IAAIuX,QAC3C,IAAGc,aAAanlB,QAAQqkB,KAAO,EAChC1gB,GAAGgJ,WAAWC,IAAIyX,EAAE1gB,GAAGyD,iBAAiBid,QACvC,IAAGhD,KAAKC,UAAUuD,oBAAoB/X,IAAIuX,MAAQhD,KAAKC,UAAU3d,GAAGgJ,WAAWG,IAAIuX,IACpF1gB,GAAG4hB,kBAAkBE,SAASpB,EAAGqB,SAAS/hB,GAAGgJ,WAAWG,IAAIuX,IAGpE,IAAG1gB,GAAGgJ,WAAWG,IAAI,sBAAwBnJ,GAAGqX,YAAY,CACxDrX,GAAGgJ,WAAWC,IAAI,aAAc,OAChCjJ,IAAGgJ,WAAWC,IAAI,OAAQ,YAC1BjJ,IAAGgJ,WAAWC,IAAI,YAAa,OAC/BjJ,IAAGgJ,WAAWC,IAAI,oBAAqBjJ,GAAGqX,aAG9CrX,GAAGwM,OAAOqL,kBAAoB,EAMlC7X,IAAGgiB,sBAAwB,WAIzBhiB,GAAGgJ,WAAa,WACZ,GAAIiZ,MACJ,IAAIC,SACJ,QAAQ/Y,IAAK,SAASjW,GAAG,MAAO+uB,IAAG/uB,IAC3B+V,IAAK,SAAS/V,EAAE6M,GACd,GAAGkiB,GAAG/uB,KAAO6M,EACT,MACJkiB,IAAG/uB,GAAK6M,CACRC,IAAG4hB,kBAAkBE,SAAU5uB,EAAG6uB,SAAUhiB,KAE9CoiB,KAAM,SAASjvB,GAAGgvB,MAAMhvB,GAAK,MAC7B2uB,SAAU,WAAW,MAAOK,WAIxCliB,IAAGwM,OAAOoL,eAAiB,CAC3B,KACEtL,QAAQC,IAAI,2CACZ,KAAI,GAAImU,KAAK1gB,IAAGyD,iBAChB,GAAGzD,GAAGmF,yBAAyB9I,QAAQqkB,KAAO,IAAM0B,eAAiBA,aAAa,cAAe1B,GAC7F1gB,GAAGgJ,WAAWC,IAAIyX,EAAE1gB,GAAGyD,iBAAiBid,QAExC1gB,IAAGgJ,WAAWC,IAAIyX,EAAEhD,KAAK2E,MAAMD,aAAa,cAAgB1B,KACjE,MAAMxjB,KACH,GAAGklB,aACDA,aAAa5tB,OACf8X,SAAQC,IAAI,oFAEhBvM,GAAGwM,OAAOoL,eAAiB,EAG7B5X,IAAG4hB,iBAAmB,SAASllB,GAC3B,GAAI6Q,WAAY7Q,EAAEqlB,QAClBzV,SAAQC,IAAI,mBAAqB7P,EAAEolB,SAAU,KAAOvU,UACpD,IAAGvN,GAAGmF,yBAAyB9I,QAAQK,EAAEolB,WAAW,GAAKM,aAAa,CAClEA,aAAa,cAAgB1lB,EAAEolB,UAAYpE,KAAKC,UAAUpQ,WAE9D,IACI,OAAO7Q,EAAEolB,UACL,IAAK,gBACD9hB,GAAGogB,oBAAoB7S,UACnB,MACR,KAAK,QACDvN,GAAGgH,OAAOsb,SAAS,aAAe/U,UAClCvN,IAAGuiB,gBAAgB3jB,OAAOoB,GAAGuiB,gBAAgB/iB,QAAQ+N,WAAY,KACjE,MACJ,KAAK,WACD,GAAIiV,YAAaxiB,GAAGyiB,iBACpBziB,IAAGrF,GAAG+nB,eAAelnB,YAAc+R,UAAUoV,QAAQ,EACrD3iB,IAAGgH,OAAO4b,YAAYrV,UAAY,KAClCvN,IAAGgH,OAAO6b,aAAaL,WACvB,MACJ,KAAK,WACD,GAAI9B,GAAI1gB,GAAGgH,OAAOmJ,YAClB,IAAIqS,YAAaxiB,GAAGyiB,iBACpB/B,GAAEoC,eAAevV,UAAU,GAC3BmT,GAAEqC,kBAAkBxV,UAAU,GAAGA,UAAU,GAC1CvN,IAAGgH,OAAO6b,aAAaL,WACxB,KAAIjV,UAAU,GACVvN,GAAGrF,GAAGqoB,cAAc/mB,UAAUO,IAAI,gBAElCwD,IAAGrF,GAAGqoB,cAAc/mB,UAAUC,OAAO,WACzC,IAAGqR,UAAU,KAAOA,UAAU,GAC1BvN,GAAGrF,GAAGsoB,eAAehnB,UAAUO,IAAI,gBAEnCwD,IAAGrF,GAAGsoB,eAAehnB,UAAUC,OAAO,WAC1C,IAAGqR,UAAU,IAAMA,UAAU,GACzBvN,GAAGrF,GAAGuoB,aAAajnB,UAAUO,IAAI,gBAEjCwD,IAAGrF,GAAGuoB,aAAajnB,UAAUC,OAAO,WAExC,MACJ,KAAK,aACD8D,GAAGrF,GAAGwoB,kBAAkB3nB,YAAc+R,SACtC,IAAI6V,SAAUpjB,GAAGgJ,WAAWG,IAAI,WAChC,IAAGia,QAAQ,IAAMA,QAAQ,IAAM7V,UAC3BvN,GAAGgJ,WAAWC,IAAI,YAAY,EAAEsE,UAAUA,WAC9CvN,IAAGgH,OAAOqc,qBAAqB9V,UAC/B,MACJ,KAAK,oBACD,GAAImT,GAAI1gB,GAAGgH,OAAOmJ,YAClB,IAAG5C,UAAU,CACTvN,GAAGrF,GAAG2oB,oBAAoBrnB,UAAUO,IAAI,WACxCwD,IAAGrF,GAAG4oB,oBAAoBtnB,UAAUC,OAAO,gBAC1C,CACD,GAAIsF,GAAIxB,GAAG8Y,mBACX,KAAI,GAAIniB,GAAE,EAAEA,EAAE6K,EAAE5K,OAAOD,IAAI,GAAG6K,EAAE7K,GAC5B+pB,EAAE8C,uBAAuB7sB,EAAE6K,EAAE7K,GAAG,EAAIqJ,GAAGoZ,wBAAwB5X,EAAE7K,IAAMqJ,GAAGgZ,oBAAoBxX,EAAE7K,IACpGqJ,IAAG8Y,sBACH9Y,IAAGrF,GAAG4oB,oBAAoBtnB,UAAUO,IAAI,WACxCwD,IAAGrF,GAAG2oB,oBAAoBrnB,UAAUC,OAAO,YAE/C,KACJ,KAAK,iBACD8D,GAAGyb,sBACH,MACJ,KAAK,2BACDzb,GAAGkJ,uBAAuBqE,UAC1B,MACJ,KAAK,WACL,IAAK,YACDvN,GAAGyjB,kBACH,MACJ,KAAK,YACDzjB,GAAGwgB,cAAcjT,UACjB,IAAGvN,GAAGgJ,WAAWmZ,KACbniB,GAAGgJ,WAAWmZ,KAAK,YACvB,MACJ,KAAK,OACDniB,GAAGwe,UAAUjR,UACb,IAAGvN,GAAGgJ,WAAWmZ,KACbniB,GAAGgJ,WAAWmZ,KAAK,OACvB,IAAG5U,YAAc,YACbvN,GAAGgJ,WAAWC,IAAI,aAAc,OACpC,MACJ,KAAK,aACDjJ,GAAGke,gBAAgB3Q,UACnB,MACJ,KAAK,aACD,GAAGA,UACCvN,GAAGrF,GAAG+oB,kBAAkBznB,UAAUO,IAAI,gBAEtCwD,IAAGrF,GAAG+oB,kBAAkBznB,UAAUC,OAAO,WAC7C8D,IAAGsT,uBACH,MACJ,KAAK,mBACD,GAAG/F,UACCvN,GAAGrF,GAAGgpB,wBAAwB1nB,UAAUO,IAAI,gBAE5CwD,IAAGrF,GAAGgpB,wBAAwB1nB,UAAUC,OAAO,WACnD8D,IAAGsT,uBACH,MACJ,KAAK,sBACD,GAAG/F,UACCvN,GAAGrF,GAAGipB,2BAA2B3nB,UAAUO,IAAI,gBAE/CwD,IAAGrF,GAAGipB,2BAA2B3nB,UAAUC,OAAO,WACtD8D,IAAGsT,uBACH,MACJ,KAAK,eACDtT,GAAG6N,qBAAqBN,UACxB,MACJ,KAAK,YACDvN,GAAGsN,kBAAkBC,UACrB,QAEX,MAAMrQ,KACHoP,QAAQC,IAAI,2CACZD,SAAQuX,IAAInnB,EACZ4P,SAAQuX,IAAI3mB,MAUpB8C,IAAG8jB,0BAA4B,WAC3B,GAAIC,WAAY/jB,GAAGgJ,WAAWG,IAAI,WAClC4a,YAAa/jB,GAAGiG,mBAChB8d,WAAYA,UAAa/jB,GAAGsF,cAAgBtF,GAAGsF,cAAeye,SAC9D/jB,IAAGgJ,WAAWC,IAAI,WAAY8a,WAGlC/jB,IAAGgkB,0BAA4B,WAC3B,GAAID,WAAY/jB,GAAGgJ,WAAWG,IAAI,WAClC4a,YAAa/jB,GAAGiG,mBAChB8d,WAAYA,UAAa/jB,GAAGuF,cAAgBvF,GAAGuF,cAAcwe,SAC7D/jB,IAAGgJ,WAAWC,IAAI,WAAY8a,WAUlC/jB,IAAGikB,WAAa,SAAS9oB,KACrB6E,GAAGsH,SAAS2Q,aAAe,WAavB,GAAIlL,OAAQ/M,GAAGgH,OAAOkJ,QAAQgU,SAAS,EAAG,IAC1C,IAAIC,SAAUpX,MAAMzP,IAAI,SAASnC,KACjB,MAAOA,KAAIqgB,MAAM,QAAQ,IAEzC2I,SAAUA,QAAQxsB,OAAO,SAASwD,KAAK,MAAOA,OAAQ,IAEtD,KAAIgpB,QAAQvtB,OACR,MAAOoJ,IAAGokB,iBAAiB7mB,IAAK,QAIpC,IAAI8mB,OAAQF,QAAQG,OAAO,SAASD,MAAMlpB,KACvC,GAAGA,IAAIkB,QAAQ,MAAS,EACrB,GAAGlB,IAAIkB,QAAQ,MAAQ,EACrBgoB,MAAME,mBAENF,OAAMG,oBAEPH,OAAMI,UAAUtpB,IAAIvE,SAAWytB,MAAMI,UAAUtpB,IAAIvE,SAAW,GAAK,CACtE,OAAOytB,SACRG,cAAe,EAAEC,aAAcF,aAAc,GAEhDF,OAAMK,MAAQP,QAAQvtB,MACtBytB,OAAMM,gBAAkBN,MAAMK,MAAQL,MAAME,aAAeF,MAAMG,aAEjElY,SAAQuX,IAAIQ,MAEZ,IAAGA,MAAMG,cAAcH,MAAMK,OAAS1kB,GAAG8F,sBACrC,MAAO9F,IAAGokB,iBAAiB7mB,IAAK,OAEpC,IAAG8mB,MAAMM,gBAAgBN,MAAMK,MAAQ1kB,GAAG6F,wBACtC,MAAO7F,IAAGokB,iBAAiB7mB,IAAK,WAEpC8mB,OAAMO,eACN,IAAIlE,EACJ,KAAIA,EAAE1gB,GAAG4F,eAAe8a,GAAG1gB,GAAG2F,eAAe+a,IAAI,CAC7C,GAAImE,GAAI,CACR,KAAI,GAAIluB,GAAE+pB,EAAE/pB,EAAE0tB,MAAMI,UAAU7tB,OAAOD,GAAG+pB,EACpCmE,GAAKR,MAAMI,UAAU9tB,KAAO+B,UAAY2rB,MAAMI,UAAU9tB,GAAK,CACjE0tB,OAAMO,aAAalE,GAAKmE,EAG5B,IAAInE,EAAE1gB,GAAG2F,eAAe+a,GAAG1gB,GAAG4F,eAAe8a,IACzC,GAAG2D,MAAMO,aAAalE,GAAG2D,MAAMM,gBAAkB3kB,GAAG+F,0BAChD,KAER,IAAG2a,EAAI1gB,GAAG4F,eAAe,CAErB,GAAIkf,gBAAiB9kB,GAAGgJ,WAAWG,IAAI,WACvC,IAAGkb,MAAMO,aAAaE,gBAAgBT,MAAMM,gBAAkB3kB,GAAGgG,sCAC7D,MAAOhG,IAAGokB,iBAAiB7mB,IAAK,SAAUoX,EAAGmQ,eAAgBC,UAAW,KAAMC,UAAW,aAEzF,OAAOhlB,IAAGokB,iBAAiB7mB,IAAK,SAAUoX,EAAGmQ,eAAgBC,UAAW,KAAMC,UAAW,eAC5F,CAEG,MAAOhlB,IAAGokB,iBAAiB7mB,IAAK,SAAUoX,EAAG+L,EAAGqE,UAAW,MAAOC,UAAW,eAM7FhlB,IAAGokB,gBAAkB,SAASa,GAC1B,GAAI9pB,IACJ,IAAI+pB,YAAa,EACjB,IAAGllB,GAAGgJ,WAAWG,IAAI,aACjB+b,WAAa,gBAEbA,YAAallB,GAAGgJ,WAAWG,IAAI,YAAc,SAEjD,QAAO8b,EAAE1nB,KACL,IAAK,OACDpC,IAAM,wCAA0C+pB,UAChD,MACJ,KAAK,UACD/pB,IAAM,wCAA0C+pB,UAChD,MACJ,KAAK,MACD/pB,IAAM,+BACN,MACJ,KAAK,SACD,OAAO8pB,EAAED,WACL,IAAK,SACD7pB,IAAM,yBAA2B8pB,EAAEtQ,EAAI,SACvC,MACJ,KAAK,OACDxZ,IAAM,sCAAwC8pB,EAAEtQ,EAAI,SACpD,MACJ,KAAK,SACDxZ,IAAM,wCAA0C8pB,EAAEtQ,EAAI,SACtD,QAIhB3U,GAAGrF,GAAGwqB,cAAc3pB,YAAc,IAAML,IAAK,GAC7C,OAAO8pB,GAGXjlB,IAAGyjB,iBAAmB,WAClB,GAAI2B,kBAAmBplB,GAAGgJ,WAAWG,IAAI,YACzC,IAAIkc,iBAAkBrlB,GAAGgJ,WAAWG,IAAI,WAExC,IAAI8b,EACJ,IAAIK,OACJ,IAAIC,QACJ,IAAIC,WAEJxlB,IAAGikB,YACH,IAAGjkB,GAAGsH,SAASqR,aAAa1T,MAAQ,SAAS,CACzCggB,EAAIjlB,GAAGsH,SAAS2Q,YAChBuN,YAAa,SACZ,CACD,IACIP,EAAIvH,KAAK2E,MAAMriB,GAAGsH,SAASqR,aAAa1T,MAC3C,MAAM/H,KACH+nB,GAAK1nB,IAAK,SAGlB,OAAO0nB,EAAE1nB,KACL,IAAK,OACL,IAAK,UACD+nB,OAASF,gBACTG,SAAUF,eACV,MACJ,KAAK,MACDC,OAAS,IACTC,SAAUN,EAAEtQ,GAAK0Q,eACjB,MACJ,KAAK,SACDC,OAAS,KACTC,SAAUN,EAAEtQ,EAIpB,GAAG2Q,OAAO,CACNtlB,GAAGgH,OAAOkJ,QAAQuV,eAAe,WAChC,CACDzlB,GAAGgH,OAAOkJ,QAAQuV,eAAe,KACjCzlB,IAAGgH,OAAOkJ,QAAQwV,WAAWH,SAGjCvlB,GAAGrF,GAAGgrB,cAAcnqB,YAAc6pB,eAClC,IAAGD,iBAAiB,CAChBplB,GAAGrF,GAAGirB,SAAS3pB,UAAUO,IAAI,WAC7BwD,IAAGrF,GAAGkrB,SAAS5pB,UAAUC,OAAO,gBAC/B,CACD8D,GAAGrF,GAAGkrB,SAAS5pB,UAAUO,IAAI,WAC7BwD,IAAGrF,GAAGirB,SAAS3pB,UAAUC,OAAO,YAIpC8D,GAAGrF,GAAGmrB,gBAAgB7pB,UAAUC,OAAO,WACvC8D,IAAGrF,GAAGorB,cAAc9pB,UAAUC,OAAO,WACrC8D,IAAGrF,GAAGqrB,cAAc/pB,UAAUC,OAAO,WACrC,IAAGspB,WAAW,CACVxlB,GAAGrF,GAAGmrB,gBAAgB7pB,UAAUO,IAAI,WACpCwD,IAAGrF,GAAGsrB,mBAAmBzqB,YAAc+pB,YACtC,CACD,GAAGN,EAAE1nB,KAAO,MACRyC,GAAGrF,GAAGorB,cAAc9pB,UAAUO,IAAI,gBAElCwD,IAAGrF,GAAGqrB,cAAc/pB,UAAUO,IAAI,WACtCwD,IAAGrF,GAAGsrB,mBAAmBzqB,YAAc+pB,SAM/CvlB,IAAGkmB,8BAAgC,SAAS3oB,IAAI4oB,OAC5C,GAAIC,GAAIpmB,GAAGsH,QACX,IAAI+e,SAAUD,EAAEzN,aAAa1T,IAC7B,IAAGohB,SAAW,SAAS,CACnBA,QAAUD,EAAEnO,YACZ,IAAGoO,QAAQ9oB,KAAO,QAAU8oB,QAAQ9oB,KAAO,UACvC8oB,SAAY9oB,IAAKyC,GAAGgJ,WAAWG,IAAI,aAAe,MAAQ,SAC9CwL,EAAG3U,GAAGgJ,WAAWG,IAAI,iBACpC,CACD,IACIkd,QAAU3I,KAAK2E,MAAMgE,SACxB,MAAMnpB,KACHoP,QAAQC,IAAI,6DAA+D8Z,QAC3E,SAGR,GAAIC,OAAQ/oB,IAAKA,IAAKoX,EAAG0R,QAAQ1R,EAAIwR,MACrCnmB,IAAGumB,aAAa,OAAO7I,KAAKC,UAAU2I,OAM1CtmB,IAAGwmB,mBAAqB,SAASvB,GAC7B,GAAI9pB,KAAM,YAAc8pB,EAAEwB,OAAS,sBAEnCzmB,IAAGrF,GAAG+rB,mBAAmBlrB,YAAc,IAAML,IAAM,GACnD,OAAO8pB,GAAEwB,OAEbzmB,IAAG2mB,cAAgB,WAEf,GAAI/mB,OAAQI,GAAGsH,SAAS1H,OAAS,cACjC,IAAIgnB,MAAQjX,QAAQ,oBAAoBkX,eAAejnB,MACvDI,IAAGsH,SAASwf,gBAAkBF,KAAKG,OACnC/mB,IAAGwmB,oBAAoBC,OAAQzmB,GAAGsH,SAASwf,iBAC3C9mB,IAAGsH,SAASwf,gBAAkBF,KAGlC5mB,IAAGgnB,oBAAsB,WACrBhnB,GAAG2mB,eACH,IAAG3mB,GAAGsH,SAASqR,aAAa,YAAc,SAAS,CAC/C3Y,GAAGinB,WAAWjnB,GAAGsH,SAASwf,gBAC1B9mB,IAAGrF,GAAGusB,qBAAqBjrB,UAAUO,IAAI,WACzCwD,IAAGmnB,iBAAiBrnB,YAAY,WAC/B,CACDE,GAAGinB,WAAWjnB,GAAGsH,SAASqR,aAAa,WACvC3Y,IAAGrF,GAAGusB,qBAAqBjrB,UAAUC,OAAO,WAC5C8D,IAAGmnB,iBAAiBrnB,YAAY,OAIxCE,IAAGinB,WAAa,SAAS1pB,KACrB,GAAI6pB,YAAazX,QAAQ,oBAAoB0X,KAC7C,IAAIT,KACJ,IAAI5oB,IAEJ,UAAUT,MAAO,SAAS,CAEtBqpB,KAAOQ,WAAW7pB,KAAKqpB,IACvB5oB,KAAMT,QACJ,IAAG6pB,WAAW/qB,QAAQkB,MAAQ,EAAE,CAElCqpB,KAAOrpB,IAAIqpB,IACX5oB,KAAMopB,WAAW/qB,QAAQkB,SACxB,CAED,IAAIS,IAAI,EAAEA,IAAIopB,WAAWxwB,OAAOoH,MAAM,GAAGopB,WAAWppB,KAAK+oB,SAAWxpB,IAAI,CACpEqpB,KAAOQ,WAAWppB,KAAK4oB,IACvB,QAIR,GAAG5mB,GAAGmnB,iBACFnnB,GAAGmnB,iBAAiBvoB,OAAOZ,IAAI,KACnCgC,IAAGgH,OAAOmJ,aAAamX,QAAQV,MAGnC5mB,IAAGunB,kBAAoB,WACnB,GAAIC,QAAS7X,QAAQ,oBACrB,IAAI4S,iBAAkB,GAAInlB,UAASyX,OAAOrc,KAAKgvB,OAAOC,cACtDlF,iBAAgBxoB,iBAAiB,SAAS,WACtCiG,GAAGgJ,WAAWC,IAAI,QAAQsZ,gBAAgB9iB,WAE9C8iB,iBAAgBxoB,iBAAiB,OAAO,WACrCiG,GAAGuO,gBAEN,OAAOgU,iBAGXviB,IAAG0nB,mBAAqB,WACpB,GAAIL,OAAQ1X,QAAQ,oBAAoB0X,KAExC,IAAIF,kBAAmB,GAAI/pB,UAASiqB,MAAM/pB,IAAI,SAASunB,GAAG,MAAOA,GAAEkC,UAEnEI,kBAAiBptB,iBAAiB,QAASiG,GAAG2nB,eAE9CR,kBAAiBptB,iBAAiB,QAAQ,WACtCiG,GAAGumB,aAAa,UAAUY,iBAAiB1nB,WAE/C0nB,kBAAiBptB,iBAAiB,SAAS,WACvCiG,GAAGumB,aAAa,UAAUY,iBAAiB1nB,WAE/C0nB,kBAAiBptB,iBAAiB,OAAO,WACtCiG,GAAGuO,gBAEN,OAAO4Y,kBAMXnnB,IAAG2nB,eAAiB,SAASjrB,GACzB,GAAGsD,GAAGsH,SAASkR,aAAa,CACxBxY,GAAGoH,WAAW,8DACd1K,GAAEyC,0BACHa,IAAGuO,gBAGVvO,IAAG4nB,yBAA2B,WAC1B,GAAI/rB,MAAOmE,GAAGrF,GAAGktB,mBACN7nB,GAAGrF,GAAGmtB,yBACN9nB,GAAGrF,GAAGkhB,oBACN7b,GAAGrF,GAAGmhB,qBACN9b,GAAGrF,GAAGohB,kBACN/b,GAAGrF,GAAGmrB,gBACN9lB,GAAGrF,GAAGqrB,cACNhmB,GAAGrF,GAAGorB,cACN/lB,GAAGrF,GAAGusB,qBACjB,KAAI,GAAIpoB,IAAG,EAAGA,GAAIjD,IAAIjF,OAAQkI,KAC1BjD,IAAIiD,IAAI/E,iBAAiB,QAAQiG,GAAG2nB,eAGxC3nB,IAAGrF,GAAGktB,mBAAmB9tB,iBAAiB,QAAS,WAC3CiG,GAAGrF,GAAGktB,mBAAmBhtB,MAAMgD,QAAU,MACzCmC,IAAGrF,GAAGotB,oBAAoBltB,MAAMgD,QAAU,EAC1CmC,IAAGrF,GAAGotB,oBAAoBvpB,OAC1BwB,IAAGrF,GAAGotB,oBAAoB/R,UAElChW,IAAGrF,GAAGotB,oBAAoBhuB,iBAAiB,OAAQ,WAC3CiG,GAAGrF,GAAGotB,oBAAoBltB,MAAMgD,QAAU,MAC1CmC,IAAGrF,GAAGktB,mBAAmBhtB,MAAMgD,QAAU,EACzC,IAAImqB,SAAUhoB,GAAGrF,GAAGotB,oBAAoBvd,KACxC,IAAGwd,SAAWhoB,GAAGsH,SAAS1H,MACtB,MACJI,IAAGsH,SAAS1H,MAAQooB,OACpBhoB,IAAGioB,iBACHjoB,IAAGgnB,qBACHhnB,IAAGkoB,iBACJloB,IAAGuO,gBAEVvO,IAAGrF,GAAGotB,oBAAoBhuB,iBAAiB,QAAS,SAAS2C,GACrD,GAAGA,EAAEqS,OAAS3L,MAAMC,MAChBrD,GAAGrF,GAAGotB,oBAAoB1pB,QAAQ,SAE9C2B,IAAGrF,GAAGotB,oBAAoBhuB,iBAAiB,UAAW,SAAS2C,GAC3D,GAAGA,EAAEqS,OAAS3L,MAAME,IAAI,CACpBtD,GAAGrF,GAAGotB,oBAAoBvd,MAAQxK,GAAGsH,SAAS1H,KAC9CI,IAAGrF,GAAGotB,oBAAoB1pB,QAAQ,OAClC2B,IAAGmoB,cAAgB,OAK3BnoB,IAAGrF,GAAGytB,YAAYruB,iBAAiB,QAASiG,GAAGsW,aAC/CtW,IAAGrF,GAAG0tB,aAAatuB,iBAAiB,QAASiG,GAAGmU,SAChDnU,IAAGrF,GAAG2tB,aAAavuB,iBAAiB,QAASiG,GAAGya,SAChDza,IAAGrF,GAAG4tB,eAAexuB,iBAAiB,QAASiG,GAAGqH,uBAGlDrH,IAAGrF,GAAGmtB,yBAAyB/tB,iBAAiB,QAAS,WACjDiG,GAAGrF,GAAGmtB,yBAAyBjtB,MAAMgD,QAAU,MAC/CmC,IAAGrF,GAAG6tB,0BAA0B3tB,MAAMgD,QAAU,EAChDmC,IAAGrF,GAAG6tB,0BAA0BhqB,SAExCwB,IAAGrF,GAAG6tB,0BAA0BzuB,iBAAiB,OAAQ,WACjDiG,GAAGrF,GAAG6tB,0BAA0B3tB,MAAMgD,QAAU,MAChDmC,IAAGrF,GAAGmtB,yBAAyBjtB,MAAMgD,QAAU,EAC/C,IAAImqB,SAAUhoB,GAAGrF,GAAG6tB,0BAA0Bhe,KAC9C,IAAGxK,GAAGsH,SAASnE,cAAgB6kB,QAC3B,MACJhoB,IAAGsH,SAASnE,YAAc6kB,OAC1BhoB,IAAGyoB,kBACHzoB,IAAG0oB,uBACJ1oB,IAAGuO,gBAEVvO,IAAGrF,GAAG6tB,0BAA0BzuB,iBAAiB,UAAU,SAAS2C,GAC5D,GAAGA,EAAEqS,OAAS3L,MAAME,IAAI,CACpBtD,GAAGrF,GAAG6tB,0BAA0Bhe,MAAQxK,GAAGsH,SAASnE,WACpDnD,IAAGrF,GAAG6tB,0BAA0BnqB,QAAQ,OACxC2B,IAAGmoB,cAAgB,OAK/BnoB,IAAGrF,GAAGkhB,oBAAoB9hB,iBAAiB,QAAS,WAC/CiG,GAAGumB,aAAa,UAAU,SAC3BvmB,IAAGuO,gBAEPvO,IAAGrF,GAAGmhB,qBAAqB/hB,iBAAiB,QAAS,WAChDiG,GAAGumB,aAAa,UAAU,UAC3BvmB,IAAGuO,gBAEPvO,IAAGrF,GAAGohB,kBAAkBhiB,iBAAiB,QAAS,WAC7CiG,GAAGumB,aAAa,UAAU,OAC3BvmB,IAAGuO,gBAEPvO,IAAGrF,GAAGmrB,gBAAgB7pB,UAAUO,IAAI,WACpCwD,IAAGrF,GAAGmrB,gBAAgB/rB,iBAAiB,QAAS,WAC5CiG,GAAGumB,aAAa,OAAO,SACxBvmB,IAAGuO,gBAENvO,IAAGrF,GAAGqrB,cAAcjsB,iBAAiB,QAAS,WAC1CiG,GAAGkmB,8BAA8B,SAAS,EAC3ClmB,IAAGuO,gBAENrU,UAAS6M,eAAe,qBAAqBhN,iBAAiB,QAAS,WACnEiG,GAAGkmB,8BAA8B,UAAU,EAC5ClmB,IAAGuO,gBAENrU,UAAS6M,eAAe,qBAAqBhN,iBAAiB,QAAS,WACnEiG,GAAGkmB,8BAA8B,UAAU,EAC5ClmB,IAAGuO,gBAENvO,IAAGrF,GAAGorB,cAAchsB,iBAAiB,QAAS,WAC1CiG,GAAGkmB,8BAA8B,MAAM,EACxClmB,IAAGuO,gBAENvO,IAAGrF,GAAGusB,qBAAqBntB,iBAAiB,QAAS,WAClDiG,GAAGumB,aAAa,UAAU,YAIjCvmB,IAAG0oB,sBAAwB,WACvB,GAAG1oB,GAAGsH,SAASC,aAAa,CACxBvH,GAAG2oB,eACH,QAGJ3oB,GAAG4oB,UAAU5oB,GAAGsH,SAASmC,SAAUtG,YAAanD,GAAGsH,SAASnE,aAAczK,UAC9DiP,EAAEkhB,MAAM7oB,GAAG8oB,WAAW3lB,cAAenD,GAAGsH,SAASiR,mBAAmBpV,cAChFnD,IAAGuZ,aACH,QAIJvZ,IAAGkoB,gBAAkB,WACjB,GAAGloB,GAAGsH,SAASC,aAAa,CACxBvH,GAAG2oB,eACH,QAIJ3oB,GAAG4oB,UAAU5oB,GAAGsH,SAASmC,SAAU7J,MAAOI,GAAGsH,SAAS1H,OAAQlH,UAClDiP,EAAEkhB,MAAM7oB,GAAG8oB,WAAWlpB,QAASI,GAAGsH,SAASiR,mBAAmB3Y,QAC1EI,IAAGuZ,cAGPvZ,IAAGioB,gBAAkB,WACjBjoB,GAAGrF,GAAGktB,mBAAmBrsB,YAAc,UAAYwE,GAAGsH,SAAS1H,KAC/DI,IAAGrF,GAAGotB,oBAAoBvd,MAAQxK,GAAGsH,SAAS1H,KAC9C1F,UAAS0F,OAASI,GAAGsH,SAAS4Q,YAAc,GAAK,KAAOlY,GAAGsH,SAAS1H,KACpEI,IAAGuZ,cAGPvZ,IAAGyoB,iBAAmB,WAClBptB,WAAW2E,GAAGrF,GAAGmtB,yBAA0B,gBAAkB9nB,GAAGsH,SAASnE,YAAY,KACrFnD,IAAGrF,GAAG6tB,0BAA0Bhe,MAAQxK,GAAGsH,SAASnE;CAOxDnD,IAAGsW,aAAe,WACd,GAAGtW,GAAGsH,SAASC,aAAa,CACxBvH,GAAG2oB,eACH,OAAO,OAGX,IAAI3oB,GAAGsH,SAAS4Q,YAAY,CACxBlY,GAAGsH,SAAS+Q,aAAaC,KAAOtY,GAAGgH,OAAOmJ,aAAa4Y,UACvD/oB,IAAGsH,SAASiR,mBAAmBD,MAC/BtY,IAAGrF,GAAGquB,eAAenuB,MAAMgD,QAAU,EACrCmC,IAAGsH,SAAS8Q,UAAY,IACxBpY,IAAGsH,SAAS4Q,YAAc,KAG9BlY,GAAGioB,iBACHjoB,IAAGipB,SACH,OAAO,OAGXjpB,IAAGipB,QAAU,WAET,GAAGjpB,GAAGsH,SAASkR,aAAa,CACxBxY,GAAGoH,WAAW,8BACd,OAAO,OAGX,KAAKpH,GAAGsH,SAAS+Q,aAAaC,MAAQtY,GAAGsH,SAAS+Q,aAAazY,OAASI,GAAGsH,SAAS+Q,aAAalV,aAAa,CAC1GnD,GAAGoH,WAAW,8BACd,OAAO,OAGX,GAAI8hB,QACJ,IAAI5Q,MAAM6Q,IACV,IAAGnpB,GAAGsH,SAAS+Q,aAAaC,KAAK,CAC7BA,KAAOtY,GAAGsH,SAAS+Q,aAAaC,IAChC4Q,MAAK5Q,KAAOtY,GAAGsH,SAASiR,mBAAmBD,KAE/C,GAAGtY,GAAGsH,SAAS+Q,aAAazY,OAASI,GAAGsH,SAAS+Q,aAAalV,YAAY,CACtEgmB,OACA,IAAGnpB,GAAGsH,SAAS+Q,aAAazY,MAAM,CAC9BupB,KAAKvpB,MAAQI,GAAGsH,SAAS+Q,aAAazY,KACtCspB,MAAKtpB,MAAQI,GAAGsH,SAASiR,mBAAmB3Y,MAEhD,GAAGI,GAAGsH,SAAS+Q,aAAalV,YAAY,CACpCgmB,KAAKhmB,YAAcnD,GAAGsH,SAAS+Q,aAAalV,WAC5C+lB,MAAK/lB,YAAcnD,GAAGsH,SAASiR,mBAAmBpV,aAG1DnD,GAAG4oB,UAAU5oB,GAAGsH,SAASmC,QAAS0f,KAAM7Q,KAAM3Q,EAAEkhB,MAAM7oB,GAAG8oB,UAAUI,MACnE,OAAO,OAGXlpB,IAAG8oB,UAAY,SAASM,MACpB,GAAGA,KAAKzP,MAAM,CACV,GAAGyP,KAAKzP,MAAMxjB,MAAQ,IAAI,CACtB6J,GAAGyZ,YAAYzZ,GAAGipB,aACjB,CACD,GAAII,YACJ,IAAGxxB,KAAKygB,MAAQzgB,KAAKygB,MAAQtY,GAAGsH,SAASiR,mBAAmBD,KAAK,CAC7D+Q,SAAS5xB,KAAK,OACduI,IAAGsH,SAAS8Q,UAAY,KACxBpY,IAAGsH,SAAS4Q,YAAc,KAC1BlY,IAAGioB,iBACHjoB,IAAGrF,GAAGquB,eAAenuB,MAAMgD,QAAU,MACrCmC,IAAGsH,SAAS+Q,aAAaC,KAAO,KAEpC,GAAGzgB,KAAK+H,OAAS/H,KAAK+H,OAASI,GAAGsH,SAASiR,mBAAmB3Y,MAC1DypB,SAAS5xB,KAAK,QAClB,IAAGI,KAAKsL,aAAetL,KAAKsL,aAAenD,GAAGsH,SAASiR,mBAAmBpV,YACtEkmB,SAAS5xB,KAAK,cAElB,IAAG4xB,SAASzyB,OAAO,CACfoJ,GAAGoH,WAAW,kBAAqB5M,aAAa6uB,UAAY,YAAcD,KAAKzP,MAAMxjB,MAAQizB,KAAKzP,MAAMxI,QAAS,KAAOiY,KAAKzP,MAAMxI,QAAU,IAC7I7E,SAAQuX,IAAIuF,YAGnB,CACD,GAAGvxB,KAAKygB,MAAQzgB,KAAKygB,MAAQtY,GAAGsH,SAASiR,mBAAmBD,KAAK,CAC7DtY,GAAGsH,SAAS8Q,UAAY,KACxBpY,IAAGrF,GAAGquB,eAAenuB,MAAMgD,QAAU,MACrCmC,IAAGsH,SAAS5D,IAAM0lB,KAAKE,aACvBtpB,IAAGgJ,WAAWC,IAAI,MAAMmgB,KAAKE,cAC7BtpB,IAAGsH,SAAS+Q,aAAaC,KAAO,IAEhC,IAAGtY,GAAGsH,SAASC,aACXvH,GAAGupB,eAAeH,MAE1B,GAAGvxB,KAAK+H,OAAS/H,KAAK+H,OAASI,GAAGsH,SAASiR,mBAAmB3Y,MAAM,CAChEI,GAAGsH,SAAS+Q,aAAazY,MAAQ,KAErC,GAAG/H,KAAKsL,aAAetL,KAAKsL,aAAenD,GAAGsH,SAASiR,mBAAmBpV,YAAY,CAClFnD,GAAGsH,SAAS+Q,aAAalV,YAAc,MAI/CnD,GAAGuZ,cAGPvZ,IAAG4oB,UAAY,SAAUpf,OAAQggB,aAAcC,SAAU1tB,UAMrD,GAAI2tB,UAAW1pB,GAAG2pB,eAClB,IAAIC,WAAY,SAAWF,SAAW,MACtC,IAAIG,aAAc,SAAWH,SAAW,IAExC,IAAII,aAAcF,UACN,qCACA,OAASlM,KAAKC,UAAU6L,aAAeA,gBAEnD,IAAGC,SAAS,CACRK,aAAeF,UACP,6CACA,wCACA,OAASG,KAAKC,SAASC,mBAAmBR,YAEtDK,aAAeD,WAEf,IAAIK,SAAUvgB,KAAKwgB,OAAOD,SACtBE,KAAM,2BAA6B5gB,OAASA,OAAS,IACrDxR,OAASwR,OAAQ,MAAQ,OACzB6gB,QAASC,WAAc,aACvBC,SAAUC,eAAgB,8BAAgCd,SAAW,KACrEpR,KAAQwR,aAGZI,SAAQO,QAAQ1uB,UAGpBiE,IAAG2pB,cAAgB,WAIf,OAAO,GAAKzK,OAAMwL,UAAY,GAAK7X,KAAK8X,SAAS,GAOrD3qB,IAAGgX,wBAA0B,WACrB,IAAIhX,GAAG4qB,iBACH,MAAO,MAEX,IAAI5qB,GAAG6qB,iBAAmB,EACtB,MAAO,KACX7qB,IAAG6qB,iBACH7qB,IAAGgH,OAAO8jB,MACV9qB,IAAGgH,OAAO+jB,OAAO/qB,GAAGqhB,YAAYlY,IAAInJ,GAAG6qB,iBACvC,OAAO,MAGf7qB,IAAGiX,yBAA2B,WACtB,IAAIjX,GAAG4qB,iBACH,MAAO,MAEX,IAAI5qB,GAAG6qB,iBAAmB7qB,GAAGqhB,YAAYzqB,OAAO,EAC5C,MAAO,KAEXoJ,IAAG6qB,iBACH7qB,IAAGgH,OAAO8jB,MACV9qB,IAAGgH,OAAO+jB,OAAO/qB,GAAGqhB,YAAYlY,IAAInJ,GAAG6qB,iBACvC,OAAO,MAGf7qB,IAAGgrB,yBAA2B,SAAStuB,GACnC,GAAGA,EAAEqS,OAAS,IAAMrS,EAAEqS,OAAS,KAAOrS,EAAEiX,QAAQ,CAC5ChM,EAAEzN,UAAU+wB,IAAI,QAAQjrB,GAAGgrB,yBAC3BhrB,IAAG4qB,iBAAmB,KACtB5qB,IAAGrF,GAAGuwB,eAAerwB,MAAMgD,QAAU,MACrC,IAAGmC,GAAGmrB,qBAAqB,CACvB7uB,aAAa0D,GAAGmrB,qBAChBnrB,IAAGmrB,qBAAuB,OAKtCnrB,IAAGorB,SAAW,SAAS9vB,MACnB,GAAI0E,GAAGqhB,cAAgB3oB,UACnB,MAEJiP,GAAEzN,UAAU+P,GAAG,QAAQjK,GAAGgrB,yBAC1BhrB,IAAG4qB,iBAAmB,IAEtB5qB,IAAG6qB,gBAAkB7qB,GAAGqhB,YAAYgK,YAAY/vB,KAChD,IAAG0E,GAAG6qB,kBAAoB,EAAE,CACzB7qB,GAAG6qB,gBAAkB7qB,GAAGqhB,YAAY5pB,KAAK6D,KACzC,OAAM0E,GAAGqhB,YAAYzqB,OAAQoJ,GAAGuG,qBAC9BvG,GAAGqhB,YAAYnlB,OAAO,GAE3B,GAAG8D,GAAGmrB,qBACF7uB,aAAa0D,GAAGmrB,qBAEpBnrB,IAAGmrB,qBAAuB5uB,WAAW,WACjCyD,GAAGmrB,qBAAuB,IAC1BnrB,IAAGrF,GAAGuwB,eAAerwB,MAAMgD,QAAU,IACvCmC,GAAGsG,sBAGTtG,IAAGsrB,QAAU,SAAShwB,MAClB,GAAI0E,GAAGqhB,cAAgB3oB,UACnB,MAEJsH,IAAGqhB,YAAY5pB,KAAK6D,KACpB,OAAM0E,GAAGqhB,YAAYzqB,OAAQoJ,GAAGuG,qBAC5BvG,GAAGqhB,YAAYnlB,OAAO,GAG9B8D,IAAGurB,sBAAwB,WACvBvrB,GAAGrF,GAAGuwB,eAAiBhxB,SAAS6M,eAAe,iBAC/C/G,IAAGrF,GAAG6wB,uBAAuBzxB,iBAAiB,QAAS,WAC/CiG,GAAGqhB,YAAY7sB,SAEvBwL,IAAGrF,GAAG8wB,0BAA0B1xB,iBAAiB,QAAS,WAClDiG,GAAGuhB,eAAe/sB,UAS9BwL,IAAGwW,OAAS,WAER,GAAIkV,MAAOzxB,OAAO8jB,SAASiD,KAAKxF,MAAM,4BAA4B,EAClEvhB,QAAOiE,KAAKwtB,KAAO,UAAYhO,KAAKC,WACxBjI,OAAQ,SACRiW,SAAU3rB,GAAGsH,SAASwQ,UAAY9X,GAAGsH,SAASwQ,UAAY,GAC1DpU,IAAK1D,GAAGgJ,WAAWG,IAAI,SAAS,SAC5C,OAAO,OAGXnJ,IAAG4rB,gBAAkB,WACjB5rB,GAAGrF,GAAG4F,SAASxG,iBAAiB,QAASiG,GAAGwW,QAGhDxW,IAAG6rB,YAAc,WACb7rB,GAAGgnB,qBACHhnB,IAAGsH,SAASC,aAAe,IAC3BvH,IAAGioB,iBACHjoB,IAAGyoB,kBACHzoB,IAAGyb,sBACHzb,IAAGyjB,kBACHzjB,IAAGgJ,WAAWC,IAAI,OAAO,aAG7BjJ,IAAG8rB,gBAAkB,WAEjB,GAAG9rB,GAAGsH,SAASyQ,iBACX,MAAO/X,IAAGsH,SAASyQ,gBACvB,IAAIgU,OAAQ,YACZ,IAAIroB,KAAM1D,GAAGsH,SAAS1H,MAAM4b,MAAM,gBAElC,KAAI9X,IACA,MAAOqoB,WAEProB,KAAMA,IAAI,GAAGsoB,OAAO,EAExB,OAAQtoB,OAAO1D,IAAGgB,iBAAmBhB,GAAGgB,iBAAiB0C,KAAOqoB,MAIpE/rB,IAAG2oB,cAAgB,WACf,GAAIvC,GAAIpmB,GAAGsH,QACX,IAAG8e,EAAEhO,UAAU,CACXpY,GAAGoH,WAAW,sCACd,OAAO,OAEX,GAAI+hB,OAAQvpB,MAAOwmB,EAAExmB,MACTuD,YAAaijB,EAAEjjB,YACf8oB,SAAUjsB,GAAG8rB,kBACzB,IAAII,UAAW9F,EAAEuF,QACjB,IAAGO,SACC/C,KAAKgD,cAAe3O,IAAI0O,WAC5B9F,GAAE/N,aAAaC,KAAOtY,GAAGgH,OAAOmJ,aAAa4Y,UAC7C3C,GAAE/N,aAAazY,MAAQupB,KAAKvpB,KAC5BwmB,GAAE/N,aAAalV,YAAcgmB,KAAKhmB,WAClC,IAAI+lB,OAAQtpB,QAASwmB,EAAE7N,mBAAmB3Y,MAAOuD,cAAeijB,EAAE7N,mBAAmBpV,YAAYmV,OAAQ8N,EAAE7N,mBAAmBD,KAC9H8N,GAAEhO,UAAY,IACdgO,GAAElO,YAAc,IAChBlY,IAAGioB,iBACHjoB,IAAGrF,GAAGquB,eAAenuB,MAAMgD,QAAU,EACrCmC,IAAGuZ,aACHvZ,IAAG4oB,UAAU,KAAMO,KAAM/C,EAAE/N,aAAaC,KAAM3Q,EAAEkhB,MAAM7oB,GAAG8oB,UAAUI,OAGvElpB,IAAGupB,eAAiB,SAASH,MACzBppB,GAAGsH,SAASC,aAAe,KAC3BvH,IAAGsH,SAASmC,QAAU2f,KAAK5L,EAC3Bxd,IAAGsH,SAASmR,UAAY2Q,KAAKgD,MAC7BpsB,IAAGwM,OAAOiL,aAAe,CACzBzX,IAAGsH,SAAS5D,IAAM0lB,KAAKE,aACvB+C,SAAQC,gBAAgBtsB,GAAGsH,SAAS1H,MAC5B3F,OAAO8jB,SAASiD,KAAKxF,MAAM,4BAA4B,GACnD,mCAA4Cxb,GAAGsH,SAASmC,QAAU,MAC9EzJ,IAAG+gB,0BACH/gB,IAAGusB,2BAOPvsB,IAAGwsB,iBAAmB,WAClBxsB,GAAGysB,eAAezsB,GAAGsH,SAASmC,QACd,eACAzJ,GAAGyiB,kBACH,SAAS,MAG7BziB,IAAGyiB,gBAAkB,WACjB,MAAQziB,IAAGgH,OAAOmJ,aAAauc,yBAAyB1sB,GAAGgH,OAAOoM,SAASuZ,kBAAkB,GAAG9a,IASpG7R,IAAG4sB,eAAiB,SAASxD,MACzB,GAAIA,KAAKzP,MACL,KAAMkT,OAAMzD,KAAKzP,MACrB3Z,IAAGsH,SAAS1H,MAAQwpB,KAAK1P,OAAOc,IAChCxa,IAAGsH,SAASnE,YAAcimB,KAAK1P,OAAOvW,aAAe,EACrDnD,IAAGyoB,kBACHzoB,IAAGsH,SAAS5D,IAAM0lB,KAAK1P,OAAO4P,aAC9BtpB,IAAGsH,SAASkR,cAAgB4Q,KAAK1P,OAAOoT,aAAaC,OACrD/sB,IAAGsH,SAASmR,UAAY2Q,KAAK1P,OAAO0S,MACpCpsB,IAAGsH,SAASyQ,iBAAmBqR,KAAK1P,OAAOuS,QAC3C,IAAG7C,KAAK1P,OAAOsT,SAAW5D,KAAK1P,OAAOsT,QAAQp2B,OAAO,CACjDoJ,GAAGsH,SAASwQ,UAAYsR,KAAK1P,OAAOsT,QAAQ,EAC5ChtB,IAAG+gB,2BAEP/gB,GAAGioB,iBACHjoB,IAAGwM,OAAOgL,UAAY,CACtBxX,IAAGuZ,cAGPvZ,IAAGitB,eAAiB,SAAS7D,MACzBppB,GAAGktB,sBAAwB,IAC3BltB,IAAGgH,OAAOkJ,QAAQid,SAAS/D,KAAK9Q,KAChCtY,IAAGktB,sBAAwB,KAC3BltB,IAAGyb,qBAAqB2N,KAAK9Q,KAC7BtY,IAAGgnB,qBACHhnB,IAAGyjB,kBACHzjB,IAAGwM,OAAO+K,UAAY,CACtBvX,IAAGuZ,cAQPvZ,IAAGotB,UAAY,SAAS1wB,GAGpB,IAAIA,EAAEoV,QAAUpV,EAAErH,KAAO2K,GAAGktB,sBACxB,MAEJ,IAAGltB,GAAGsH,SAAS4Q,YAAY,CACvBlY,GAAGsH,SAAS4Q,YAAc,KAC1BlY,IAAGioB,iBACHjoB,IAAGuZ,cAGP,IAAIvZ,GAAGgJ,WAAWG,IAAI,qBAClB,MAEJ,IAAIkkB,UAAWrtB,GAAGgZ,oBAAoBpiB,OAAO,CAC7C,IAAI4K,GAAIxB,GAAG8Y,mBACX,IAAI4H,GAAI1gB,GAAGgH,OAAOmJ,YAElB,IAAImd,WAAY5wB,EAAEoV,MAAMD,GACxB,IAAI0b,SAAU7wB,EAAErH,IAAIwc,GAEpB,IAAG7R,GAAG+Y,aAAe/Y,GAAG+Y,YAAYuU,WAAaA,WAAattB,GAAG+Y,YAAYwU,SAAWA,SAAWD,WAAaC,SACzGvtB,GAAG+Y,YAAYrD,OAAOrZ,QAAQ,UAAY,GAAKK,EAAEgZ,OAAOrZ,QAAQ,UAAY,EAAE,CAG7E,GAAG2D,GAAG+Y,YAAYrD,QAAUhZ,EAAEgZ,OAAO,CACjC,WACE,IAAGhZ,EAAEgZ,QAAU,aAAa,CAC9BgL,EAAE8C,uBAAuB8J,UAAUttB,GAAGgZ,oBAAoBqU,UAC1D3M,GAAE8M,oBAAoBF,UAAUttB,GAAGoZ,uBAAuBiU,UAC1D7rB,GAAE8rB,YAAcD,QAChBrtB,IAAG+Y,YAAYrD,OAAS,YACxB,YACC,CACDgL,EAAE8C,uBAAuB8J,UAAUttB,GAAGoZ,uBAAuBiU,UAC7D3M,GAAE8M,oBAAoBF,UAAUttB,GAAGgZ,oBAAoBqU,UACvD7rB,GAAE8rB,WAAaD,QACfrtB,IAAG+Y,YAAYrD,OAAS,YACxB,aAGP,CAED1V,GAAG+Y,aAAeuU,UAAWA,UAAWC,QAASA,QAAS7X,OAAQhZ,EAAEgZ,QAIxE,IAAI,GAAI/e,GAAE,EAAEA,EAAE6K,EAAE5K,OAAOD,IAAI,GAAG6K,EAAE7K,GAC5B+pB,EAAE8C,uBAAuB7sB,EAAE6K,EAAE7K,GAAK,EACtBqJ,GAAGoZ,wBAAwB5X,EAAE7K,MAC7BqJ,GAAGgZ,oBAAoBxX,EAAE7K,MAGzC,IAAG+F,EAAEgZ,QAAU,cAAc,CACzBlU,EAAElJ,OAAOg1B,UAAWC,QAAUD,UAAY,EAC1C9rB,GAAE8rB,WAAa9rB,EAAE8rB,UAAU,IAAMD,aAC/B,IAAG3wB,EAAEgZ,SAAW,aAAa,CAC/BlU,EAAE8rB,YAAcD,aACf,CACD,GAAII,cAAe,CACnB,IAAG/wB,EAAEgZ,QAAU,aACX+X,cAAgB/wB,EAAEpB,KAAKkgB,MAAM,YAAc5kB,MAC/C,IAAG8F,EAAEgZ,QAAU,cACX+X,aAAe/wB,EAAEqQ,MAAMnW,MAC3B4K,GAAElJ,OAAOyT,MAAMvK,GAAG8rB,UAAU,GAAG7a,OAAO3G,MAAM2hB,eAE5C,KAAI,GAAI92B,GAAE22B,UAAU32B,GAAG42B,QAAQ52B,IAC3B6K,EAAE7K,GAAK02B,SAIf,IAAI,GAAI12B,GAAE,EAAEA,EAAE6K,EAAE5K,OAAOD,IAAI,GAAG6K,EAAE7K,GAC5B+pB,EAAE8M,oBAAoB72B,EAAE6K,EAAE7K,GAAG,EACrBqJ,GAAGoZ,wBAAwB5X,EAAE7K,IAC7BqJ,GAAGgZ,oBAAoBxX,EAAE7K,KAGzCqJ,IAAG0tB,aAAe,WACd,IAAI1tB,GAAGsH,SAAS4Q,YACZ,MAAO,yDAA2DlY,GAAGsH,SAASC,aAAe,OAAS,eAAiB,SAAWvH,GAAGsH,SAAS1H,MAAQ,KAO9JI,IAAG2tB,iBAAmB,SAASC,QAAQ5F,SACnC1b,QAAQC,IAAI,2BAA6BqhB,QAAU,KAAO5F,QAC1D,QAAO4F,SACH,IAAK,UACD5tB,GAAGyb,sBACH,MACJ,KAAK,OACDzb,GAAGyjB,kBACH,MACJ,KAAK,UACDzjB,GAAGgnB,qBACH,QAKZhnB,IAAG6tB,wBAA0B,WACzB,IAAI,GAAI36B,KAAK8M,IAAG+E,qBACZ/E,GAAGumB,aAAarzB,EAAE8M,GAAG+E,qBAAqB7R,IAGlD8M,IAAG8tB,0BAA4B,YAQ/B9tB,IAAG+tB,wBAA0B,SAAS3E,MAClC,GAAGA,KAAK4E,MAAM,CACVhuB,GAAGsH,SAASsR,qBACZ,KAAI,GAAIjiB,GAAE,EAAEA,EAAEyyB,KAAK4E,MAAMp3B,OAAOD,IAAI,CAChCqJ,GAAGsH,SAASqR,aAAayQ,KAAK4E,MAAMr3B,GAAGS,KAAOgyB,KAAK4E,MAAMr3B,GAAG6T,KAC5DxK,IAAGsH,SAASsR,mBAAmBwQ,KAAK4E,MAAMr3B,GAAGS,KAAO,IACpD4I,IAAG2tB,iBAAiBvE,KAAK4E,MAAMr3B,GAAGS,IAAIgyB,KAAK4E,MAAMr3B,GAAG6T,SAKhExK,IAAGusB,yBAA2B,WAE1B,IAAI,GAAIr5B,KAAK8M,IAAGsH,SAASqR,aACrB3Y,GAAGumB,aAAarzB,EAAE8M,GAAGsH,SAASqR,aAAazlB,IAGnD8M,IAAGumB,aAAe,SAAS0H,UAAUjG,SAEjC,GAAIkG,QAASluB,GAAGsH,SAASqR,aAAasV,UACtCjuB,IAAGsH,SAASqR,aAAasV,WAAajG,OACtC,IAAGkG,SAAWlG,QACVhoB,GAAG2tB,iBAAiBM,UAAUjG,QAElC,MAAKre,MAAQA,KAAK9G,OAAS7C,GAAGsH,SAASmC,SACnC,MAEJ,IAAI0kB,eAAgB,YAEpB,IAAGnuB,GAAG+E,qBAAqBkpB,YAAcjG,QAAQ,CAC7C,GAAGhoB,GAAGsH,SAASsR,mBAAmBqV,WAAW,CACxCjuB,GAAGsH,SAASsR,mBAAmBqV,WAAa,KAC5CtkB,MAAKwgB,OAAOtnB,MAAMurB,WAAWj5B,QAC1BqU,OAAQxJ,GAAGsH,SAASmC,QAAS4kB,YAAaJ,UAAWK,WAAY,WAC9D7D,QAAQ0D,oBAGlB,CACD,GAAGnuB,GAAGsH,SAASsR,mBAAmBqV,YAAcC,SAAWlG,QAAQ,CAC/Dre,KAAKwgB,OAAOtnB,MAAMurB,WAAWG,OAC7B/kB,OAAQxJ,GAAGsH,SAASmC,QAAS4kB,YAAaJ,UAAWK,WAAY,SAAUE,UAAWhkB,MAASwd,WAC5FyC,QAAQ0D,mBACV,CACDnuB,GAAGsH,SAASsR,mBAAmBqV,WAAa,IAC5CtkB,MAAKwgB,OAAOtnB,MAAMurB,WAAWrD,QAC7BvhB,OAAUxJ,GAAGsH,SAASmC,QAAS+kB,UAAap3B,IAAK62B,UAAWzjB,MAAOwd,QAASsG,WAAY,YACrF7D,QAAQ0D,iBAWvBnuB,IAAGyuB,mBAAqB,SAAUrvB,KAC9BA,IAAMA,IAAIsvB,aACVtvB,KAAIjH,iBACJiH,KAAInH,gBACJ,MAAK+H,GAAGsH,SAASC,cAAgBvH,GAAGsH,SAAS4Q,aAAa,CACtD9Y,IAAIuvB,aAAaC,WAAa,MAC9B,IAAG5uB,GAAGsX,yBAAyB,CAC3BtX,GAAGoH,WAAW,uGACdpH,IAAGsX,yBAA2B,KAC9B/a,YAAW,WAAWyD,GAAGsX,yBAA2B,MAAOtX,GAAGoG,gBAElE,OAEJhH,IAAIuvB,aAAaC,WAAa,OAGlC5uB,IAAG6uB,mBAAqB,SAASzvB,KAC5B,KAAKY,GAAGsH,SAASC,cAAgBvH,GAAGsH,SAAS4Q,aAC1C,MAEL9Y,KAAMA,IAAIsvB,aACVtvB,KAAIjH,iBACJiH,KAAInH,gBAEJ,IAAI62B,OAAQ1vB,IAAIuvB,aAAaG,KAC7B,IAAGA,MAAMl4B,OAAS,EAAE,CAChBoJ,GAAGoH,WAAW,2FAElB,GAAI2nB,MAAOD,MAAM,EACjB9uB,IAAGsH,SAAS1H,MAAQmvB,KAAKvU,IACzBxa,IAAG6rB,aACH7rB,IAAGsH,SAAS0nB,sBAAwB,IACpChvB,IAAGuZ,aACH,IAAInP,GAAI,GAAI6kB,WACZ7kB,GAAE8kB,OAASlvB,GAAGmvB,iBACd/kB,GAAEglB,WAAWL,MAGhB/uB,IAAGmvB,kBAAoB,SAASzyB,GAC5BsD,GAAGsH,SAAS0nB,sBAAwB,KACpChvB,IAAGgH,OAAOmJ,aAAagd,SAASzwB,EAAEpD,OAAOogB,QAQ7C1Z,IAAGqvB,oBAAsB,WACrB1lB,KAAKC,KAAK0lB,SAAS,GACnB,OAAO,MAGXtvB,IAAGuvB,kBAAoB,WAEnB,MAAO5lB,MAAKwgB,OAAOD,SAASE,KAAS,+BAGzCpqB,IAAGwvB,kBAAoB,WAEnBxvB,GAAGwM,OAAOgL,UAAY,CACtBxX,IAAGuZ,aACH,OAAO5P,MAAKwgB,OAAOD,SACfE,KAAQ,mBAAqBpqB,GAAGsH,SAASmC,QACzC4gB,QAAUoF,OAAU,yEAG5BzvB,IAAG0vB,kBAAoB,WAEnB1vB,GAAGwM,OAAO+K,UAAY,CACtBvX,IAAGuZ,aACH,OAAO5P,MAAKwgB,OAAOD,SACfE,KAAQ,mBAAqBpqB,GAAGsH,SAASmC,QACzC4gB,QAAUv2B,IAAO,WAGzBkM,IAAG2vB,0BAA4B,WAC3B,MAAO,IAAI5yB,SAAQ,SAAS6yB,KAAMC,MAI9B7vB,GAAG8vB,wBAA0B,SAAS5yB,KAClC,GAAG8C,GAAGwM,OAAOqL,kBAAoB,EAAE,CAC/BgY,KAAK3yB,SACJ,CACD,GAAGA,IAAIsc,OAAS,yBAAyB,CACrCxZ,GAAG+Z,QAAQG,OAAOhd,SACf,CACHoP,QAAQuX,IAAI3mB,IACZ8C,IAAGoH,WAAW,GAAKlK,OAK/ByM,MAAK9G,MAAM4e,SAASsO,oBAAoBH,KAAM,KAAM5vB,GAAG8vB,2BAM/D9vB,IAAGgwB,eAAiB,SAAStzB,GAGzBsD,GAAGrF,GAAGif,WAAa1f,SAAS6M,eAAe,aAC3C/G,IAAGrF,GAAGimB,YAAc1mB,SAAS6M,eAAe,cAC5C/G,IAAGrF,GAAGkmB,kBAAoB3mB,SAAS6M,eAAe,oBAClD/G,IAAGrF,GAAGmmB,aAAe5mB,SAAS6M,eAAe,eAC7C/G,IAAGrF,GAAG6M,eAAiBtN,SAAS6M,eAAe,iBAC/C/G,IAAGrF,GAAGquB,eAAiB9uB,SAAS6M,eAAe,iBAC/C/G,IAAGrF,GAAGif,WAAW7f,iBAAiB,YAAaiG,GAAG2e,kBAClD1jB,WAAU+E,GAAGrF,GAAGif,WAAY,EAAG,EAC/B5Z,IAAGrF,GAAGif,WAAW/e,MAAMgD,QAAU,EACjCmC,IAAGrF,GAAGmmB,aAAajmB,MAAMgD,QAAU,MACnCmC,IAAGrF,GAAG6M,eAAezN,iBAAiB,YAAa,SAAS2C,GACxDA,EAAEzE,gBACFyE,GAAEvE,mBAEN,IAAI0D,KAAMmE,GAAGrF,GAAG6M,eAAeyoB,qBAAqB,QACpD,KAAI,GAAInxB,IAAG,EAAGA,GAAGjD,IAAIjF,OAAQkI,KACzBjD,IAAIiD,IAAI/E,iBAAiB,YAAa0C,iBAG1C,IAAIyzB,WAAYh2B,SAAS6M,eAAe,aACxCmpB,WAAUz0B,UAAY,EACtBy0B,WAAUn2B,iBAAiB,cAAe,SAAS2C,GAC/CsD,GAAGoH,WAAW,kFAElBpH,IAAGgH,OAAS0I,IAAIygB,KAAK,aACrBnwB,IAAGgH,OAAO+I,yBAAyB,KACnC/P,IAAGrF,GAAGy1B,YAAcl2B,SAASwN,uBAAuB,eAAe,EACnE1H,IAAGgH,OAAOmJ,aAAapW,iBAAiB,SAAUiG,GAAGotB,UACrDptB,IAAGuO,aAAevO,GAAGgH,OAAOxI,MAAMyb,KAAKja,GAAGgH,OAC1ChH,IAAGuO,cACHvO,IAAGgH,OAAOiD,GAAG,QAASjK,GAAGorB,SACzBprB,IAAGgH,OAAOiD,GAAG,OAAQjK,GAAGsrB,QACxBtrB,IAAGgH,OAAOqpB,kBAAkB,KAC5BrwB,IAAGgH,OAAOspB,gBAAkBC,QAG5BvwB,IAAGrF,GAAG2lB,YAAcpmB,SAAS6M,eAAe,cAC5C/G,IAAGrF,GAAG6F,UAAYtG,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAG8F,UAAYvG,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAGmG,UAAY5G,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAG2F,UAAYpG,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAGgG,sBAAwBzG,SAAS6M,eAAe,wBACtD/G,IAAGrF,GAAG2lB,YAAYvmB,iBAAiB,YAAa0C,iBAChDuD,IAAG0e,yBACH,IAAI7iB,KAAMmE,GAAGrF,GAAG2lB,YAAY5Y,uBAAuB,mBACnD,KAAI,GAAI5I,IAAG,EAAGA,GAAGjD,IAAIjF,OAAQkI,KAAK,CAC9BjD,IAAIiD,IAAI/E,iBAAiB,YAAa4C,gBACtCd,KAAIiD,IAAIc,MAAQI,GAAGC,mBAAmBpE,IAAIiD,IAAI0e,GAC9Cxd,IAAG0e,uBAAuB,QAAU7iB,IAAIiD,IAAI0e,GAAGwO,OAAO,IAAMnwB,IAAIiD,IAIpEkB,GAAGrF,GAAG61B,UAAYt2B,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAGotB,oBAAuB7tB,SAAS6M,eAAe,2BACrD/G,IAAGrF,GAAGktB,mBAAqB3tB,SAAS6M,eAAe,0BACnD/G,IAAGrF,GAAG6tB,0BAA6BtuB,SAAS6M,eAAe,iCAC3D/G,IAAGrF,GAAGmtB,yBAA2B5tB,SAAS6M,eAAe,gCACzD/G,IAAGrF,GAAG81B,qBAAuBv2B,SAAS6M,eAAe,uBACrD/G,IAAGrF,GAAGusB,qBAAuBhtB,SAAS6M,eAAe,uBACrD/G,IAAGrF,GAAG+rB,mBAAqBxsB,SAAS6M,eAAe,qBACnD/G,IAAGrF,GAAGkhB,oBAAsB3hB,SAAS6M,eAAe,sBACpD/G,IAAGrF,GAAGmhB,qBAAuB5hB,SAAS6M,eAAe,uBACrD/G,IAAGrF,GAAGohB,kBAAoB7hB,SAAS6M,eAAe,oBAClD/G,IAAGrF,GAAGuhB,kBAAoBhiB,SAAS6M,eAAe,oBAClD/G,IAAGrF,GAAGmrB,gBAAkB5rB,SAAS6M,eAAe,kBAChD/G,IAAGrF,GAAGorB,cAAgB7rB,SAAS6M,eAAe,gBAC9C/G,IAAGrF,GAAGqrB,cAAgB9rB,SAAS6M,eAAe,gBAC9C/G,IAAGrF,GAAGsrB,mBAAqB/rB,SAAS6M,eAAe,qBACnD/G,IAAGrF,GAAGwqB,cAAgBjrB,SAAS6M,eAAe,gBAC9C/G,IAAGrF,GAAGytB,YAAcluB,SAAS6M,eAAe,cAC5C/G,IAAGrF,GAAG0tB,aAAenuB,SAAS6M,eAAe,eAC7C/G,IAAGrF,GAAG2tB,aAAepuB,SAAS6M,eAAe,eAC7C/G,IAAGrF,GAAG4tB,eAAiBruB,SAAS6M,eAAe,iBAC/C/G,IAAGmnB,iBAAmBnnB,GAAG0nB,oBACzB1nB,IAAGrF,GAAG81B,qBAAqB1yB,YAAYiC,GAAGmnB,iBAAiBxsB,GAC3DqF,IAAG4nB,0BACH5nB,IAAGrF,GAAG2F,UAAUvG,iBAAiB,QAAS,WACtCiG,GAAGgJ,WAAWC,IAAI,OAAQ,cAI9BjJ,IAAGrF,GAAG+1B,sBAAwBx2B,SAAS6M,eAAe,wBACtD/G,IAAGrF,GAAGg2B,cAAgBz2B,SAAS6M,eAAe,gBAC9C/G,IAAGrF,GAAGi2B,uBAAyB12B,SAAS6M,eAAe,kBACvD/G,IAAGrF,GAAG6wB,uBAAyBtxB,SAAS6M,eAAe,yBACvD/G,IAAGrF,GAAG8wB,0BAA4BvxB,SAAS6M,eAAe,4BAC1D/G,IAAGrF,GAAG2oB,oBAAsBppB,SAAS6M,eAAe,sBACpD/G,IAAGrF,GAAG4oB,oBAAsBrpB,SAAS6M,eAAe,sBACpD/G,IAAGrF,GAAGqoB,cAAgB9oB,SAAS6M,eAAe,gBAC9C/G,IAAGrF,GAAGuoB,aAAehpB,SAAS6M,eAAe,eAC7C/G,IAAGrF,GAAGsoB,eAAiB/oB,SAAS6M,eAAe,iBAC/C/G,IAAGrF,GAAGk2B,oBAAsB32B,SAAS6M,eAAe,sBACpD/G,IAAGrF,GAAGsL,oBAAsB/L,SAAS6M,eAAe,sBACpD/G,IAAGrF,GAAG+nB,eAAiBxoB,SAAS6M,eAAe,iBAC/C/G,IAAGrF,GAAGirB,SAAW1rB,SAAS6M,eAAe,WACzC/G,IAAGrF,GAAGkrB,SAAW3rB,SAAS6M,eAAe,WACzC/G,IAAGrF,GAAGghB,qBAAuBzhB,SAAS6M,eAAe,uBACrD/G,IAAGrF,GAAGihB,kBAAoB1hB,SAAS6M,eAAe,oBAClD/G,IAAGrF,GAAGgrB,cAAgBzrB,SAAS6M,eAAe,gBAC9C/G,IAAGrF,GAAGm2B,aAAe52B,SAAS6M,eAAe,eAC7C/G,IAAGrF,GAAGo2B,aAAe72B,SAAS6M,eAAe,eAC7C/G,IAAGrF,GAAGwoB,kBAAoBjpB,SAAS6M,eAAe,oBAClD/G,IAAGrF,GAAGq2B,iBAAmB92B,SAAS6M,eAAe,mBACjD/G,IAAGrF,GAAGs2B,iBAAmB/2B,SAAS6M,eAAe,mBACjD/G,IAAGuiB,gBAAkBviB,GAAGunB,mBACxBvnB,IAAGrF,GAAGg2B,cAAc5yB,YAAYiC,GAAGuiB,gBAAgB5nB,GACnDqF,IAAGrF,GAAGghB,qBAAqB5hB,iBAAiB,QAAS,WACjDiG,GAAGgJ,WAAWC,IAAI,iBAAkB,YAExCjJ,IAAGrF,GAAGihB,kBAAkB7hB,iBAAiB,QAAS,WAC9CiG,GAAGgJ,WAAWC,IAAI,iBAAkB,SAExCjJ,IAAGrF,GAAGirB,SAAS7rB,iBAAiB,QAAS,WACrCiG,GAAGgJ,WAAWC,IAAI,YAAa,IAEnCjJ,IAAGrF,GAAGkrB,SAAS9rB,iBAAiB,QAAS,WACrCiG,GAAGgJ,WAAWC,IAAI,YAAa,IAEnCjJ,IAAGrF,GAAGm2B,aAAa/2B,iBAAiB,QAAS,WACzC,GAAI6O,IAAK5I,GAAGgJ,WAAWG,IAAI,YAAc,CACzCP,IAAKA,GAAK5I,GAAG4F,eAAiB5F,GAAG4F,eAAiBgD,EAClD5I,IAAGgJ,WAAWC,IAAI,WAAWL,KAEjC5I,IAAGrF,GAAGm2B,aAAa/2B,iBAAiB,QAAS,WACzC,GAAI6O,IAAK5I,GAAGgJ,WAAWG,IAAI,YAAc,CACzCP,IAAKA,GAAK5I,GAAG2F,eAAiB3F,GAAG2F,eAAiBiD,EAClD5I,IAAGgJ,WAAWC,IAAI,WAAWL,KAEjC5I,IAAGrF,GAAGk2B,oBAAoB92B,iBAAiB,QAASiG,GAAG8jB,0BACvD9jB,IAAGrF,GAAGsL,oBAAoBlM,iBAAiB,QAASiG,GAAGgkB,0BACvDhkB,IAAGrF,GAAGqoB,cAAcjpB,iBAAiB,QAAS,WAC1CiG,GAAGgJ,WAAWC,IAAI,YAAY,EAAE,EAAE,KAEtCjJ,IAAGrF,GAAGuoB,aAAanpB,iBAAiB,QAAS,WACzC,GAAI6O,IAAK5I,GAAGgJ,WAAWG,IAAI,aAC3BnJ,IAAGgJ,WAAWC,IAAI,YAAY,EAAEL,GAAGA,MAEvC5I,IAAGrF,GAAGq2B,iBAAiBj3B,iBAAiB,QAAS,WAC7C,GAAI6O,IAAK5I,GAAGgJ,WAAWG,IAAI,cAAgBnJ,GAAG0F,iBAC9CkD,IAAKA,GAAK5I,GAAGyF,YAAczF,GAAGyF,YAAcmD,EAC5C5I,IAAGgJ,WAAWC,IAAI,aAAaL,KAEnC5I,IAAGrF,GAAGs2B,iBAAiBl3B,iBAAiB,QAAS,WAC7C,GAAI6O,IAAK5I,GAAGgJ,WAAWG,IAAI,cAAgBnJ,GAAG0F,iBAC9CkD,IAAKA,GAAK5I,GAAGwF,YAAcxF,GAAGwF,YAAcoD,EAC5C5I,IAAGgJ,WAAWC,IAAI,aAAaL,KAEnC5I,IAAGrF,GAAGsoB,eAAelpB,iBAAiB,QAAS,WAC3CiG,GAAGgJ,WAAWC,IAAI,YAAY,EAAE,KAAK,QAEzCjJ,IAAGrF,GAAG2oB,oBAAoBvpB,iBAAiB,QAAS,WAChDiG,GAAGgJ,WAAWC,IAAI,oBAAoB,IAE1CjJ,IAAGrF,GAAG4oB,oBAAoBxpB,iBAAiB,QAAS,WAChDiG,GAAGgJ,WAAWC,IAAI,oBAAoB,IAE1CjJ,IAAGurB,uBACHvrB,IAAGrF,GAAGgG,sBAAsB5G,iBAAiB,QAAS,WAClDiG,GAAGgJ,WAAWC,IAAI,OAAQ,0BAI9BjJ,IAAGrF,GAAGu2B,iBAAmBh3B,SAAS6M,eAAe,mBACjD7M,UAAS6M,eAAe,eAAehN,iBAAiB,QAASiG,GAAGma,cAGpEna,IAAGrF,GAAGw2B,UAAYj3B,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAG4f,UAAYrgB,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAGgb,oBAAsBzb,SAAS6M,eAAe,sBACpD/G,IAAGrF,GAAGyjB,eAAiBlkB,SAAS6M,eAAe,iBAC/C/G,IAAGrF,GAAG0jB,eAAiBnkB,SAAS6M,eAAe,iBAC/C/G,IAAGrF,GAAG2jB,iBAAmBpkB,SAAS6M,eAAe,wBACjD/G,IAAGrF,GAAG4jB,YAAcrkB,SAAS6M,eAAe,mBAC5C/G,IAAGrF,GAAG2jB,iBAAiBvkB,iBAAiB,QAAS,WAC7C,GAAGiG,GAAGgJ,WAAWG,IAAI,gBAAkB,YACnCnJ,GAAGgJ,WAAWC,IAAI,aAAc,YAEhCjJ,IAAGgJ,WAAWC,IAAI,aAAc,cAExCjJ,IAAGrF,GAAG4jB,YAAYxkB,iBAAiB,QAAS,WACxC,GAAGiG,GAAGgJ,WAAWG,IAAI,gBAAkB,OACnCnJ,GAAGgJ,WAAWC,IAAI,aAAc,YAEhCjJ,IAAGgJ,WAAWC,IAAI,aAAc,SAExCjJ,IAAGrF,GAAGmG,UAAU/G,iBAAiB,QAAS,WACtCiG,GAAGgJ,WAAWC,IAAI,OAAQ,cAE9BjJ,IAAGsV,uBAGHtV,IAAGrF,GAAGy2B,UAAYl3B,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAGipB,2BAA6B1pB,SAAS6M,eAAe,6BAC3D/G,IAAGrF,GAAGgpB,wBAA0BzpB,SAAS6M,eAAe,0BACxD/G,IAAGrF,GAAG+oB,kBAAoBxpB,SAAS6M,eAAe,oBAClD/G,IAAGrF,GAAG2U,WAAapV,SAAS6M,eAAe,aAC3C/G,IAAGrF,GAAG8T,gBAAkBvU,SAAS6M,eAAe,aAChD/G,IAAGrF,GAAG6U,mBAAqBtV,SAAS6M,eAAe,qBACnD/G,IAAGrF,GAAGgT,UAAYzT,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAGqU,aAAe9U,SAAS6M,eAAe,eAC7C/G,IAAGrF,GAAG0V,mBAAqBnW,SAAS6M,eAAe,qBACnD/G,IAAGrF,GAAG+S,YAAcxT,SAAS6M,eAAe,cAC5C/G,IAAGrF,GAAGmT,eAAiB5T,SAAS6M,eAAe,iBAC/C/G,IAAGrF,GAAG6S,kBAAoBtT,SAAS6M,eAAe,oBAClD/G,IAAGrF,GAAG8S,kBAAoBvT,SAAS6M,eAAe,oBAClD/G,IAAGrF,GAAGiT,qBAAuB1T,SAAS6M,eAAe,uBACrD/G,IAAGrF,GAAG02B,wBAA0Bn3B,SAAS6M,eAAe,0BACxD/G,IAAGrF,GAAGipB,2BAA2B7pB,iBAAiB,QAAS,WACvDiG,GAAGgJ,WAAWC,IAAI,uBAAwBjJ,GAAGgJ,WAAWG,IAAI,yBAEhEnJ,IAAGrF,GAAGgpB,wBAAwB5pB,iBAAiB,QAAS,WACpDiG,GAAGgJ,WAAWC,IAAI,oBAAqBjJ,GAAGgJ,WAAWG,IAAI,sBAE7DnJ,IAAGrF,GAAG+oB,kBAAkB3pB,iBAAiB,QAAS,WAC9CiG,GAAGgJ,WAAWC,IAAI,cAAejJ,GAAGgJ,WAAWG,IAAI,gBAEvDnJ,IAAGrF,GAAG8F,UAAU1G,iBAAiB,QAAS,WACtCiG,GAAGgJ,WAAWC,IAAI,OAAQ,YAC1B,IAAGjJ,GAAGgJ,WAAWG,IAAI,aACjBnJ,GAAGrF,GAAG8T,gBAAgBjQ,YAEtBwB,IAAGrF,GAAG2U,WAAW9Q,SAEzBwB,IAAGrF,GAAG8T,gBAAgB1U,iBAAiB,UAAWiG,GAAG8O,wBACrD9O,IAAGrF,GAAG8T,gBAAgB1U,iBAAiB,QAASiG,GAAG6O,sBACnD7O,IAAGrF,GAAG8T,gBAAgB1U,iBAAiB,OAAQiG,GAAGqO,qBAClDrO,IAAGrF,GAAG8T,gBAAgB1U,iBAAiB,QAASiG,GAAGmO,sBACnDnO,IAAGrF,GAAG2U,WAAWvV,iBAAiB,QAASiG,GAAGwT,iBAC9CxT,IAAGrF,GAAG2U,WAAWvV,iBAAiB,UAAWiG,GAAGyT,mBAChDzT,IAAGrF,GAAG2U,WAAWvV,iBAAiB,OAAQiG,GAAGiQ,iBAC7CjQ,IAAGrF,GAAG2U,WAAWvV,iBAAiB,QAASiG,GAAGoP,kBAC9CpP,IAAGrF,GAAG6U,mBAAmBzV,iBAAiB,OAAQiG,GAAGiQ,iBACrDjQ,IAAGrF,GAAG6U,mBAAmBzV,iBAAiB,QAASiG,GAAGoP,kBACtDpP,IAAGrF,GAAG6U,mBAAmBzV,iBAAiB,UAAWiG,GAAG4T,2BACxD5T,IAAGrF,GAAG02B,wBAAwBt3B,iBAAiB,QAASiG,GAAGgU,mBAC3DhU,IAAGrF,GAAGmT,eAAe/T,iBAAiB,QAAS,WAC3CiG,GAAGgJ,WAAWC,IAAI,gBAAiBjJ,GAAGgJ,WAAWG,IAAI,gBACrDnJ,IAAGgJ,WAAWC,IAAI,YAAa,MAC/BjJ,IAAGrF,GAAG2U,WAAW9Q,SAErBwB,IAAGrF,GAAG+S,YAAY3T,iBAAiB,QAAS,WACxCiG,GAAGgJ,WAAWC,IAAI,aAAcjJ,GAAGgJ,WAAWG,IAAI,aAClD,IAAGnJ,GAAGgJ,WAAWG,IAAI,aACjBnJ,GAAGrF,GAAG8T,gBAAgBjQ,YAEtBwB,IAAGrF,GAAG2U,WAAW9Q,SAIzBwB,IAAGrF,GAAG6J,UAAYtK,SAAS6M,eAAe,YAC1C/G,IAAGrF,GAAG22B,gBAAkBp3B,SAAS6M,eAAe,kBAChD/G,IAAGrF,GAAG6F,UAAUzG,iBAAiB,QAAS,WACtCiG,GAAGgJ,WAAWC,IAAI,OAAQ,cAE9BjJ,IAAGrF,GAAG22B,gBAAgBv3B,iBAAiB,QAASiG,GAAGmc,kBAGnDnc,IAAGmW,yBACHnW,IAAGgiB,uBACHhiB,IAAG6tB,yBACH3zB,UAASH,iBAAiB,cAAe4C,gBACzCzC,UAASH,iBAAiB,WAAYiG,GAAGyuB,mBACzCv0B,UAASH,iBAAiB,OAAQiG,GAAG6uB,mBACrC50B,QAAOF,iBAAiB,SAAUiG,GAAGogB,oBACrCnmB,QAAOs3B,eAAiBvxB,GAAG0tB,YAG3B,IAAIrD,QAASmH,kCACb,IAAGnH,OAAO,SAAS,CACf,GAAI5J,SACJ,KACIA,MAAQ/C,KAAK2E,MAAMgI,OAAO,UAC7B,MAAM3tB,GACHsD,GAAGoH,WAAW,oBAAsBijB,OAAO,UAE/C,GAAG5J,MAAM/K,QAAU+K,MAAM/K,QAAU,QAAU+K,MAAM3C,KAAO2C,MAAM3C,IAAIlnB,OAAS,EAAE,CAC3EoJ,GAAGsH,SAASmC,QAAUgX,MAAM3C,IAAI,OAC9B,IAAG2C,MAAM/K,QAAU+K,MAAM/K,QAAU,SAAS,CAC9C1V,GAAGsH,SAAS1H,MAAQ,aAAe6gB,MAAM/c,IAAM+c,MAAM/c,IAAM1D,GAAGgJ,WAAWG,IAAI,OAC7E,IAAGsX,MAAMkL,SACL3rB,GAAGsH,SAASwQ,UAAY2I,MAAMkL,QAClC3rB,IAAG6rB,mBAEN,CACD7rB,GAAGsH,SAAS1H,MAAQ,YAAcI,GAAGgJ,WAAWG,IAAI,MACpDnJ,IAAG6rB,cAGP7rB,GAAGuZ,aAIHvZ,IAAG+Z,QAAQjd,SAASkD,GAAGqZ,kBACvBrZ,IAAG+Z,QAAQ0X,WAAW,WAClB,GAAGzxB,GAAGgJ,WAAWG,IAAI,OAAQ,oBACzBnJ,GAAGgJ,WAAWC,IAAI,OAAQ,YAC9BjJ,IAAGwM,OAAOmL,aAAe,CACzB3X,IAAGwM,OAAOkL,eAAiB,CAC3B1X,IAAGuZ,eAIP3c,eAAc,SAASgzB,KAAMC,MACzB9yB,QAAQid,QAAQha,GAAG+Z,SACX5c,KAAK6C,GAAGuvB,mBACRpyB,KAAK6C,GAAGoa,gBACRjd,KAAKyyB,KAAMC,OACpB7vB,GAAG+Z,QAAQG,OAAOD,KAAKja,GAAG+Z,UAC5B5c,KAAK,WACFmP,QAAQC,IAAI,iCAGhB,IAAGvM,GAAGsH,SAASmC,QAAQ,CAGnB,GAAIioB,SAAU90B,cAAc,SAASgzB,KAAMC,MACvC9yB,QAAQid,QAAQha,GAAG+Z,SACX5c,KAAK6C,GAAGwvB,mBACRryB,KAAK6C,GAAG4sB,gBACR+E,MAAM,SAASz0B,KACX,IAAIA,IAAK,KAAMA,IAEf8C,IAAGoH,WAAWlK,IAAIwc,OAAOC,MAAMxI,QAC/BnR,IAAGwM,OAAOgL,WAAa,CACvBxX,IAAGuZ,aACH,OAAO,aACTpc,KAAKyyB,KAAMC,OACtB7vB,GAAG+Z,QAAQG,OAAOD,KAAKja,GAAG+Z,SAG7B,IAAI6X,SAAUh1B,cAAc,SAASgzB,KAAMC,MACvC9yB,QAAQid,QAAQha,GAAG+Z,SAEX5c,KAAK6C,GAAG0vB,mBACRvyB,KAAK6C,GAAGitB,gBACP0E,MAAM,SAASz0B,KACZ,IAAIA,IAAK,KAAMA,IAEf8C,IAAGoH,WAAWlK,IAAIwc,OAAOC,MAAMxI,QAC/BnR,IAAGwM,OAAO+K,WAAa,CACvBvX,IAAGuZ,aACH,OAAO,aACTpc,KAAKyyB,KAAMC,OACtB7vB,GAAG+Z,QAAQG,OAAOD,KAAKja,GAAG+Z,SAG7Bhd,SAAQ80B,KAAKH,QAASE,UACjBz0B,KAAK,SAASgQ,MACX,GAAGA,KAAK,IAAM,YAAcA,KAAK,IAAM,WACnC,KAAM,mBACV,OAAO,QACRhQ,KAAK,WACJmP,QAAQC,IAAI,8CACb,WACCrS,SAAS0F,MAAQ,eACjBI,IAAGgJ,WAAWC,IAAI,OAAQ,YAC1BjJ,IAAGgJ,WAAWC,IAAI,YAAa,QAK3CrM,cAAc,SAASgzB,KAAMC,MACzB9yB,QAAQ80B,KAAK7xB,GAAG+Z,QAAS/Z,GAAG8xB,qBACpB30B,KAAK6C,GAAG2vB,2BACRxyB,KAAK6C,GAAGihB,wBACR9jB,KAAKyyB,KAAMC,OACpB7vB,GAAG+Z,QAAQG,OAAOD,KAAKja,GAAG+Z,UAC5B5c,KAAK,WACFmP,QAAQC,IAAI,gCAOpB,IAAIrS,SAAS63B,YAAc,UACvB/xB,GAAGgwB,qBAEH91B,UAASH,iBAAiB,mBAAoBiG,GAAGgwB","file":"all.build.js","sourcesContent":["//     keymaster.js\n//     (c) 2011-2013 Thomas Fuchs\n//     keymaster.js may be freely distributed under the MIT license.\n\n;(function(global){\n  var k,\n    _handlers = {},\n    _mods = { 16: false, 18: false, 17: false, 91: false },\n    _scope = 'all',\n    // modifier keys\n    _MODIFIERS = {\n      '⇧': 16, shift: 16,\n      '⌥': 18, alt: 18, option: 18,\n      '⌃': 17, ctrl: 17, control: 17,\n      '⌘': 91, command: 91\n    },\n    // special keys\n    _MAP = {\n      backspace: 8, tab: 9, clear: 12,\n      enter: 13, 'return': 13,\n      esc: 27, escape: 27, space: 32,\n      left: 37, up: 38,\n      right: 39, down: 40,\n      del: 46, 'delete': 46,\n      home: 36, end: 35,\n      pageup: 33, pagedown: 34,\n      ',': 188, '.': 190, '/': 191,\n      '`': 192, '-': 189, '=': 187,\n      ';': 186, '\\'': 222,\n      '[': 219, ']': 221, '\\\\': 220\n    },\n    code = function(x){\n      return _MAP[x] || x.toUpperCase().charCodeAt(0);\n    },\n    _downKeys = [];\n\n  for(k=1;k<20;k++) _MAP['f'+k] = 111+k;\n\n  // IE doesn't support Array#indexOf, so have a simple replacement\n  function index(array, item){\n    var i = array.length;\n    while(i--) if(array[i]===item) return i;\n    return -1;\n  }\n\n  // for comparing mods before unassignment\n  function compareArray(a1, a2) {\n    if (a1.length != a2.length) return false;\n    for (var i = 0; i < a1.length; i++) {\n        if (a1[i] !== a2[i]) return false;\n    }\n    return true;\n  }\n\n  var modifierMap = {\n      16:'shiftKey',\n      18:'altKey',\n      17:'ctrlKey',\n      91:'metaKey'\n  };\n  function updateModifierKey(event) {\n      for(k in _mods) _mods[k] = event[modifierMap[k]];\n  };\n\n  // handle keydown event\n  function dispatch(event) {\n    var key, handler, k, i, modifiersMatch, scope;\n    key = event.keyCode;\n\n    if (index(_downKeys, key) == -1) {\n        _downKeys.push(key);\n    }\n\n    // if a modifier key, set the key.<modifierkeyname> property to true and return\n    if(key == 93 || key == 224) key = 91; // right command on webkit, command on Gecko\n    if(key in _mods) {\n      _mods[key] = true;\n      // 'assignKey' from inside this closure is exported to window.key\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = true;\n      return;\n    }\n    updateModifierKey(event);\n\n    // see if we need to ignore the keypress (filter() can can be overridden)\n    // by default ignore key presses if a select, textarea, or input is focused\n    if(!assignKey.filter.call(this, event)) return;\n\n    // abort if no potentially matching shortcuts found\n    if (!(key in _handlers)) return;\n\n    scope = getScope();\n\n    // for each potential shortcut\n    for (i = 0; i < _handlers[key].length; i++) {\n      handler = _handlers[key][i];\n\n      // see if it's in the current scope\n      if(handler.scope == scope || handler.scope == 'all'){\n        // check if modifiers match if any\n        modifiersMatch = handler.mods.length > 0;\n        for(k in _mods)\n          if((!_mods[k] && index(handler.mods, +k) > -1) ||\n            (_mods[k] && index(handler.mods, +k) == -1)) modifiersMatch = false;\n        // call the handler and stop the event if neccessary\n        if((handler.mods.length == 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91]) || modifiersMatch){\n          if(handler.method(event, handler)===false){\n            if(event.preventDefault) event.preventDefault();\n              else event.returnValue = false;\n            if(event.stopPropagation) event.stopPropagation();\n            if(event.cancelBubble) event.cancelBubble = true;\n          }\n        }\n      }\n    }\n  };\n\n  // unset modifier keys on keyup\n  function clearModifier(event){\n    var key = event.keyCode, k,\n        i = index(_downKeys, key);\n\n    // remove key from _downKeys\n    if (i >= 0) {\n        _downKeys.splice(i, 1);\n    }\n\n    if(key == 93 || key == 224) key = 91;\n    if(key in _mods) {\n      _mods[key] = false;\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = false;\n    }\n  };\n\n  function resetModifiers() {\n    for(k in _mods) _mods[k] = false;\n    for(k in _MODIFIERS) assignKey[k] = false;\n  };\n\n  // parse and assign shortcut\n  function assignKey(key, scope, method){\n    var keys, mods;\n    keys = getKeys(key);\n    if (method === undefined) {\n      method = scope;\n      scope = 'all';\n    }\n\n    // for each shortcut\n    for (var i = 0; i < keys.length; i++) {\n      // set modifier keys if any\n      mods = [];\n      key = keys[i].split('+');\n      if (key.length > 1){\n        mods = getMods(key);\n        key = [key[key.length-1]];\n      }\n      // convert to keycode and...\n      key = key[0]\n      key = code(key);\n      // ...store handler\n      if (!(key in _handlers)) _handlers[key] = [];\n      _handlers[key].push({ shortcut: keys[i], scope: scope, method: method, key: keys[i], mods: mods });\n    }\n  };\n\n  // unbind all handlers for given key in current scope\n  function unbindKey(key, scope) {\n    var multipleKeys, keys,\n      mods = [],\n      i, j, obj;\n\n    multipleKeys = getKeys(key);\n\n    for (j = 0; j < multipleKeys.length; j++) {\n      keys = multipleKeys[j].split('+');\n\n      if (keys.length > 1) {\n        mods = getMods(keys);\n        key = keys[keys.length - 1];\n      }\n\n      key = code(key);\n\n      if (scope === undefined) {\n        scope = getScope();\n      }\n      if (!_handlers[key]) {\n        return;\n      }\n      for (i = 0; i < _handlers[key].length; i++) {\n        obj = _handlers[key][i];\n        // only clear handlers if correct scope and mods match\n        if (obj.scope === scope && compareArray(obj.mods, mods)) {\n          _handlers[key][i] = {};\n        }\n      }\n    }\n  };\n\n  // Returns true if the key with code 'keyCode' is currently down\n  // Converts strings into key codes.\n  function isPressed(keyCode) {\n      if (typeof(keyCode)=='string') {\n        keyCode = code(keyCode);\n      }\n      return index(_downKeys, keyCode) != -1;\n  }\n\n  function getPressedKeyCodes() {\n      return _downKeys.slice(0);\n  }\n\n  function filter(event){\n    var tagName = (event.target || event.srcElement).tagName;\n    // ignore keypressed in any elements that support keyboard data input\n    return !(tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA');\n  }\n\n  // initialize key.<modifier> to false\n  for(k in _MODIFIERS) assignKey[k] = false;\n\n  // set current scope (default 'all')\n  function setScope(scope){ _scope = scope || 'all' };\n  function getScope(){ return _scope || 'all' };\n\n  // delete all handlers for a given scope\n  function deleteScope(scope){\n    var key, handlers, i;\n\n    for (key in _handlers) {\n      handlers = _handlers[key];\n      for (i = 0; i < handlers.length; ) {\n        if (handlers[i].scope === scope) handlers.splice(i, 1);\n        else i++;\n      }\n    }\n  };\n\n  // abstract key logic for assign and unassign\n  function getKeys(key) {\n    var keys;\n    key = key.replace(/\\s/g, '');\n    keys = key.split(',');\n    if ((keys[keys.length - 1]) == '') {\n      keys[keys.length - 2] += ',';\n    }\n    return keys;\n  }\n\n  // abstract mods logic for assign and unassign\n  function getMods(key) {\n    var mods = key.slice(0, key.length - 1);\n    for (var mi = 0; mi < mods.length; mi++)\n    mods[mi] = _MODIFIERS[mods[mi]];\n    return mods;\n  }\n\n  // cross-browser events\n  function addEvent(object, event, method) {\n    if (object.addEventListener)\n      object.addEventListener(event, method, false);\n    else if(object.attachEvent)\n      object.attachEvent('on'+event, function(){ method(window.event) });\n  };\n\n  // set the handlers globally on document\n  addEvent(document, 'keydown', function(event) { dispatch(event) }); // Passing _scope to a callback to ensure it remains the same by execution. Fixes #48\n  addEvent(document, 'keyup', clearModifier);\n\n  // reset modifiers to false whenever the window is (re)focused.\n  addEvent(window, 'focus', resetModifiers);\n\n  // store previously defined key\n  var previousKey = global.key;\n\n  // restore previously defined key and return reference to our key object\n  function noConflict() {\n    var k = global.key;\n    global.key = previousKey;\n    return k;\n  }\n\n  // set window.key and window.key.set/get/deleteScope, and the default filter\n  global.key = assignKey;\n  global.key.setScope = setScope;\n  global.key.getScope = getScope;\n  global.key.deleteScope = deleteScope;\n  global.key.filter = filter;\n  global.key.isPressed = isPressed;\n  global.key.getPressedKeyCodes = getPressedKeyCodes;\n  global.key.noConflict = noConflict;\n  global.key.unbind = unbindKey;\n\n  if(typeof module !== 'undefined') module.exports = assignKey;\n\n})(this);\n","\"use strict\";\r\n\r\nvar oxford_comma = function(arr){\r\n    switch (arr.length){\r\n        case 1:\r\n            return arr[0];\r\n        case 2:\r\n            return arr[0] + \" and \" + arr[1];\r\n        case 3:\r\n            return arr[0] + \", \" + arr[1] + \", and \" + arr[2];\r\n    }\r\n}\r\n\r\nvar rotate = function(el, deg){\r\n    el.style.transform = \"rotate(\" + deg + 'deg)';\r\n    el.style.webkitTansform = \"rotate(\" + deg + 'deg)';\r\n    el.style.mozTransform = \"rotate(\" + deg + 'deg)';\r\n}\r\n\r\nvar translate = function(el, x, y){\r\n    var str = x==null ? \"\" : \"translate(\" + x + \"px,\" + y + \"px)\";\r\n    el.style.transform = str;\r\n    el.style.webkitTransform = str;\r\n    el.style.mozTransform = str;\r\n}\r\n\r\nvar text_multi = function(el, text, truncate_long_words){\r\n    if(truncate_long_words){\r\n        text = text.replace(/(\\S{25})\\S*/g,'$1...'); \r\n    }\r\n    el.textContent = text;  \r\n    el.innerHTML = el.innerHTML.replace(/\\n/g,'<br/>').replace(/\\t/g,'&nbsp;&nbsp;&nbsp; ');\r\n}\r\n\r\nvar escape_str = function(str){\r\n    // http://stackoverflow.com/a/18750001/2399799\r\n    return str.replace(/[\\u00A0-\\u9999<>\\&]/g, function(i) {\r\n        return '&#' + i.charCodeAt(0) + ';';\r\n    });\r\n}\r\n\r\nvar css_animation = (function(){\r\n    var timers = []; // we store timers and matching els so we can cancel if needed\r\n    var els = [];\r\n\r\n    return function(el, cls, callback, delay){\r\n        el.classList.remove(cls);\r\n        el.offsetTop; //forces class to be removed, so we can actually re-add it.\r\n        var old_idx = els.indexOf(el);\r\n        if(old_idx != -1){\r\n            clearTimeout(timers[old_idx]);\r\n            timers.splice(old_idx, 1);\r\n            els.splice(old_idx, 1);\r\n        }\r\n        els.push(el);\r\n        timers.push(setTimeout(callback, delay)); //this is better than trying to use the endtransition event\r\n        el.classList.add(cls);\r\n    }\r\n})();\r\n\r\nvar stop_propagation = function(e){\r\n    e.stopPropagation();\r\n}\r\n\r\nvar prevent_default = function(e){\r\n    e.preventDefault();  \r\n}\r\n\r\nfunction until_success(executor, on_error){\r\n    // This was confusing to write, so when I finished I turned it into a S.O. answer:\r\n    //      http://stackoverflow.com/a/35782428/2399799\r\n    return new Promise(function(success){\r\n        var rejection_handler = function(err){\r\n            on_error(err);\r\n            return new Promise(executor).then(success, rejection_handler);\r\n        }\r\n        return new Promise(executor).then(success, rejection_handler);\r\n    });\r\n}\r\n\r\n\r\n\r\n/* TODO: ...............................................................\r\n\r\n$.fn.fixHeightFromAuto = function(){\r\n    var heights = [];\r\n    var d = this.get();\r\n    for(var i=0;i<d.length;i++)\r\n        heights.push(getComputedStyle(d[i]).height);\r\n    \r\n    this.each(function(ind){this.style.height = heights[ind];});\r\n\r\n    return this;\r\n}\r\n\r\n$.fn.insertClonedChildren = function(index,$src,textArray,attrObjArrays){\r\n    //inserts new nodes before this.children(index)\r\n    //the new nodes are based on $src, with text set according to the elements of textArray\r\n    //attrObjArrays is an optional arrays of objects giving key names and values\r\n    \r\n    var src = $src.get(0);\r\n    var frag = document.createDocumentFragment();\r\n    \r\n    textArray.map(function(str,ind){\r\n                    var a = src.cloneNode(false); \r\n                    a.textContent = str;\r\n                    if(attrObjArrays)for(var attr in attrObjArrays[ind])\r\n                        a.setAttribute(attr,attrObjArrays[ind][attr]);\r\n                    frag.appendChild(a);\r\n                });\r\n    \r\n    var parent = this.get(0);\r\n    var new_$els = $(Array.prototype.slice.call(frag.children,0));\r\n    parent.insertBefore(frag,parent.children[index]);\r\n    \r\n    return new_$els;\r\n}\r\n\r\n*/","\"use strict\";\r\n\r\nvar DropDown = function(val_array){\r\n    //constructor, must use <new>\r\n    \r\n    var str = val_array.map(function(val){\r\n                    return \"<div class='dropdown_item' title='\" + escape_str(val) + \"'>\" + escape_str(val) + \"</div>\";\r\n                 }).join(\"\");\r\n    \r\n    this.val_array = val_array.slice(0); \r\n    this.el_list = document.createElement('div');\r\n    this.el_list.className ='dropdown_item_list';\r\n    this.el_list.tabindex =-1\r\n    this.el_list.style.display = 'none';\r\n    this.el_list.innerHTML = str;\r\n\r\n    this.el_collapsed = document.createElement('div');\r\n    this.el_collapsed.className = 'dropdown_collapsed';\r\n    \r\n    this.el = document.createElement('div');\r\n    this.el.className = 'dropdown';\r\n    this.el.appendChild(this.el_list)\r\n    this.el.appendChild(this.el_collapsed);\r\n    this.ind = 0;\r\n    this.el_collapsed.textContent = val_array[0];\r\n    this.event_callbacks = {}; //map of callback lists\r\n    this.open = false;\r\n    \r\n    var dd = this;\r\n\r\n    this.document_mousedown = function(e){\r\n        dd.el_list.style.display = 'none';\r\n        dd.open = false;\r\n        dd.trigger(\"blur\");\r\n        document.removeEventListener('mousedown', dd.document_mousedown);\r\n    }\r\n\r\n    this.el_collapsed.addEventListener('mousedown',function(){\r\n        if(!dd.trigger(\"click\"))\r\n            return;\r\n        dd.el.parentNode.classList.add(\"selected\");\r\n        dd.el_list.style.display = '';\r\n        this.open = true;\r\n        setTimeout(function(){\r\n            dd.el_list.focus();\r\n            dd.el_list.scrollTop = dd.el_list.children[dd.ind].offsetTop;\r\n            document.addEventListener('mousedown', dd.document_mousedown)\r\n        },1);\r\n    });\r\n    var on_click = function(e){\r\n            dd.SetInd(this.getAttribute('data-ind'));\r\n            dd.el_list.style.display = 'none';\r\n            dd.open = false;\r\n            e.stopPropagation();\r\n            document.removeEventListener('mousedown', dd.document_mousedown);\r\n    };\r\n    for(var ii=0; ii<this.el_list.children.length; ii++){\r\n        this.el_list.children[ii].setAttribute('data-ind', ii);\r\n        this.el_list.children[ii].addEventListener(\"click\", on_click); \r\n    }\r\n\r\n    return this;\r\n}\r\n\r\nDropDown.FakeEvent = function(){//static subclass\r\n    this.is_stopped = false;\r\n}\r\nDropDown.FakeEvent.prototype.stopImmediatePropagation = function(){\r\n    this.is_stopped = true;\r\n}\r\n\r\nDropDown.prototype.addEventListener = function(evt, func){\r\n    if(!(evt in this.event_callbacks))\r\n        this.event_callbacks[evt] = [];\r\n    this.event_callbacks[evt].push(func);\r\n}\r\n\r\nDropDown.prototype.trigger = function(evt, args){\r\n    var fe = new DropDown.FakeEvent();\r\n    if(evt in this.event_callbacks){\r\n        for(var ii = 0; ii<this.event_callbacks[evt].length; ii++)\r\n            this.event_callbacks[evt][ii].call(this, fe);\r\n        if(fe.is_stopped)\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\nDropDown.prototype.IndexOf = function(val){\r\n    return this.val_array.indexOf(val);\r\n}\r\n\r\nDropDown.prototype.GetVal = function(){\r\n    return this.val_array[this.ind];\r\n}\r\n\r\nDropDown.prototype.SetInd = function(ind,no_trigger){\r\n    ind = parseInt(ind)\r\n    if(ind === this.ind)\r\n        return;\r\n    this.el_list.children[this.ind].classList.remove(\"selected\");\r\n    this.el_collapsed.textContent = this.val_array[ind];\r\n    this.el_collapsed.title = escape_str(this.val_array[ind]);\r\n    this.ind = ind;\r\n    this.el_list.children[ind].classList.add(\"selected\");\r\n    if(!no_trigger)\r\n        this.trigger(\"change\",{ind:ind,str:this.val_array[ind],isOpen: this.open});\r\n}\r\n\r\nDropDown.prototype.SetSelected = function(v){\r\n    if(v)\r\n        this.el.parentNode.classList.add(\"selected\");\r\n    else\r\n        this.el.parentNode.classList.remove(\"selected\");\r\n}\r\n","\"use strict\";\r\n\r\ndn.menu_id_to_caption = {\r\n'menu_print': 'print',\r\n'menu_sharing': 'sharing',\r\n'menu_save': 'save',\r\n'menu_history': 'history',\r\n'menu_file': 'current file',\r\n'menu_new': 'new',\r\n'menu_open': 'new/open',\r\n'menu_find': 'find/replace',\r\n'menu_goto': 'goto line',\r\n'menu_general_settings': 'general settings',\r\n'menu_shortcuts': 'shortcuts',\r\n'menu_drive': 'drive',\r\n'menu_help': 'about/help'};\r\n\r\n\r\ndn.shortcuts_list = [\r\n\"cut|Ctrl-X|Cmd-X\",    \r\n\"copy|Ctrl-C|Cmd-C\",\r\n\"paste|Ctrl-V|Command-V\",\r\n\"cycle clipboard|Cltr-[V then left or right arrow]|Command-[V then left or right arrow]\",\r\n\"select all|Ctrl-A|Command-A\",\r\n\"find|Ctrl(-Alt)-F\",\r\n\"replace|Ctrl-R\",\r\n\"go to line|Ctrl(-Alt)-L\",\r\n\"undo|Ctrl-Z|Command-Z\",\r\n\"redo|Ctrl-Shift-Z,Ctrl-Y|Command-Shift-Z,Command-Y\",\r\n\" | \",\r\n\"toggle widget|Esc\",\r\n\"save|Ctrl-S|Command-S\",\r\n\"print|Ctrl(-Alt)-P|Command-P\",\r\n\"file history|Ctrl-H|Command-H\",\r\n\"new|Ctrl(-Alt)-N\",\r\n\"open|Ctrl(-Alt)-O\",\r\n\"  | \",\r\n\"to upper case|Ctrl-U\",\r\n\"to lower case|Ctr-Shift-U\",\r\n\"modify selection|Shift-(Ctrl-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown, PageUp, End}|Shift-(Command-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown,End}\",\r\n\"copy lines down|Ctrl-Alt-Down|Command-Option-Down\",\r\n\"copy lines up|Ctrl-Alt-Up|Command-Option-Up\",\r\n\"center selection||Ctrl-L\",\r\n\"fold all|Alt-0|Option-0\",\r\n\"unfold all|Alt-Shift-0|Option-Shift-0\",\r\n\"go to end|Ctrl-End,Ctrl-Down|Command-End,Command-Down\",\r\n\"go to line end|Alt-Right,End|Command-Right,End,Ctrl-E\",\r\n\"go to line start|Alt-Left,Home|Command-Left,Home,Ctrl-A\",\r\n\"go to page down|PageDown|Option-PageDown,Ctrl-V\",\r\n\"go to page up|PageUp|Option-PageUp\",\r\n\"go to start|Ctrl-Home,Ctrl-Up|Command-Home,Command-Up\",\r\n\"go to word left|Ctrl-Left|Option-Left\",\r\n\"go to word right|Ctrl-Right|Option-Right\",\r\n\"indent|Tab\",\r\n\"outdent|Shift-Tab\",\r\n\"overwrite|Insert\",\r\n\"remove line|Ctrl-D|Command-D\",\r\n\"remove to line end||Ctrl-K\",\r\n\"remove to linestart||Option-Backspace\",\r\n\"remove word left||Alt-Backspace,Ctrl-Alt-Backspace\",\r\n\"remove word right||Alt-Delete\",\r\n\"split line||Ctrl-O\",\r\n\"toggle comment|Ctrl-7|Command-7\",\r\n\"transpose letters|Ctrl-T\"\r\n]\r\n\r\ndn.ext_to_mime_type = {\r\nhtml:\"text/html\",\r\nhtm:\"text/html\",\r\njs:\"text/javascript\",\r\npl:\"application/x-perl\",\r\nxml:\"text/xml\",\r\nc:\"text/x-csrc\",\r\ncpp:\"text/x-c++src\",\r\nh:\"text/x-chdr\",\r\njson:\"application/json\",\r\nphp:\"application/x-php\",\r\nsvg:\"text/html\",\r\ncss:\"text/css\",\r\njava:\"text/x-java\",\r\npy:\"text/x-python\",\r\nscala:\"scala\",\r\ntextile:\"textile\",\r\ntex:\"application/x-tex\",\r\nbib:\"application/x-tex\",\r\nrtf:\"application/rtf\",\r\nrtx:\"application/rtf\",\r\nsh:\"application/x-sh\",\r\nsql:\"text/x-sql\",\r\nas:\"text/x-actionscript\"\r\n//everything else is hopefully ok to be text/plain.\r\n}\r\n\r\ndn.tooltip_info = { //keys correspond to icon data-info attr, which will be the same as keys in SHORTCUTS_LIST\r\n    \"save\" : \"Save file contents.  \",\r\n    \"print\": \"Open print view in a new tab.  \",\r\n    \"sharing\": \"View and modify file's sharing status.\",\r\n    \"file history\": \"Explore the file history.  \",\r\n    \"drive\": \"Show this file in Google Drive.  \",\r\n    \"about\": \"Drive Notepad website.\",\r\n    \"shortcuts\": \"Keyboard shortcuts.\",\r\n    \"new\": \"Create new file in a new tab.  \",\r\n    \"open\": \"Launch open dialoag.  \",\r\n    \"settings_file\": \"Properties of the current file.\",\r\n    \"settings_general\": \"Your general Drive Notepad preferences.\",\r\n    \"title\": \"Click to edit the file's title.\",\r\n    \"description\": \"Click to edit the file's description.\"\r\n}\r\n\r\n// TODO: use keymaster rather than relying on this\r\nvar WHICH = {\r\nENTER: 13,\r\nESC: 27,\r\nUP: 38,\r\nDOWN: 40\r\n};\r\n\r\ndn.default_settings = {\r\next: 'txt',\r\nwordWrap: [true,null,null],\r\nwordWrapAt: 80,\r\nfontSize: 1,\r\nwidget_anchor: ['l',50,'t',10],\r\nshowGutterHistory: 1,\r\nlastDNVersionUsed: '',\r\nnewLineDefault: 'windows',\r\nhistoryRemovedIsExpanded: true,\r\nsoftTabN: 4,\r\ntabIsHard: 0,\r\nwidgetSub: 'general',\r\ntheme: \"chrome\",\r\npane: '',\r\npane_open: true,\r\nfind_regex: false,\r\nfind_whole_words: false,\r\nfind_case_sensitive: false,\r\nhelp_inner: 'main',\r\nfind_goto: false,\r\nfind_replace: false\r\n}\r\n\r\ndn.default_custom_props = {\r\nnewline: \"detect\",\r\ntabs: \"detect\",\r\naceMode: \"detect\"\r\n};\r\n\r\ndn.impersonal_settings_keys = [\r\n\"wordWrap\",\r\n\"wordWrapAt\",\r\n\"fontSize\",\r\n\"widget_anchor\",\r\n\"showGutterHistory\",\r\n\"historyRemovedIsExpanded\",\r\n\"tabIsHard\",\r\n\"softTabN\",\r\n\"widgetSub\",\r\n\"theme\",\r\n\"pane\",\r\n\"pane_open\",\r\n\"find_regex\",\r\n\"find_whole_words\",\r\n\"find_case_sensitive\",\r\n\"help_inner\",\r\n\"find_goto\",\r\n\"find_replace\"\r\n];\r\n\r\ndn.drag_delay_ms = 400;\r\ndn.drag_shift_px = 40;\r\ndn.min_font_size = 0.3;\r\ndn.max_font_size = 5; \r\ndn.max_wrap_at = 200;\r\ndn.min_wrap_at = 20;\r\ndn.wrap_at_increment = 10;\r\ndn.max_soft_tab_n = 10;\r\ndn.min_soft_tab_n = 2;\r\ndn.detect_tabs_spaces_frac = 0.9;\r\ndn.detect_tabs_tabs_frac = 0.9;\r\ndn.detect_tabs_n_spaces_frac = 0.99;\r\ndn.detect_tabs_n_spaces_frac_for_default = 0.6;\r\ndn.font_size_increment = 0.15;\r\ndn.icon_mouse_over_ms = 300;\r\ndn.editor_refocus_time_ms = 500;\r\ndn.error_delay_ms = 5000;//5 seconds\r\ndn.find_history_add_delay = 2000; //ms\r\ndn.clipboard_info_delay = 500; //ms\r\ndn.clipboard_max_length = 20; //TODO: decide whether a large clipboard slows page loads and whether we can do anything about it.\r\ndn.find_max_results_half = 3; \r\ndn.find_max_prefix_chars = 10;\r\ndn.find_max_suffix_chars = 60;","\"use strict\";\r\n\r\ndn.close_history = function(){\r\n    dn.file_history.$revisions_display.remove();\r\n    window.removeEventListener(\"resize\", dn.revisions_window_resize);\r\n    document.getElementById('the_editor').style.display = '';\r\n    dn.editor.resize();\r\n    dn.is_showing_history = false;\r\n}\r\ndn.revisions_window_resize = function(){\r\n    if(dn.file_history.canShowResizeError){\r\n        dn.show_error(\"The history explorer displays poorly if you resize the window while it is open. (This is a bug.)\");\r\n        dn.file_history.canShowResizeError = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n        setTimeout(function(){dn.file_history.canShowResizeError = true;},dn.error_delay_ms);\r\n    }    \r\n}\r\n\r\ndn.start_revisions_worker = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.show_error(\"This is a new file.  It doesn't have any history to explore.\")\r\n        return;\r\n    }\r\n    dn.is_showing_history = true;\r\n    \r\n    if(!dn.file_history){\r\n        dn.el.widget_content.innerHTML('afterend', \r\n            \"<div class='widget_box widget_revisions'>\" + \r\n            \"<div class='widget_box_title widget_revisions_title'>File History</div>\" +\r\n            \"<div class='revision_caption_at'></div>\" +\r\n            \"<div class='revision_timeline'></div>\" +\r\n            \"<div class='revision_caption_from'></div>\" +\r\n            \"<div>Removed lines: <div class='button inline_button ' id='expand_removed'>expand</div>\" + \r\n                    \"<div class='button inline_button ' id='collapse_removed'>collapse</div></div>\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"<div id='revisions_status'>Initialising...</div>\" + \r\n            \"Press Esc to return to editing.\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"Please note that the history viewing tool is missing some important features and those that have been implemented may include the odd bug.</div>\");\r\n        dn.el.widget_file_history = dn.el.widget_content.parentNode.getElementsByClassName('widget_revisions')[0];\r\n        dn.el.widget_file_history.style.display = 'none';\r\n        dn.file_history = {\r\n            $revisions_display: $(\"<div class='revisions_view'><ol></ol></div>\"),\r\n            $view: null, \r\n            $new_li: $(\"<li class='rev_line' v='-1'/>\"),\r\n            $new_tick:  $(\"<div class='revision_tick'/>\"),\r\n            needToRefindViewChildren: false, //this flag tracks when the $rev_lines_ is out of date relative to children of $view\r\n            $rev_lines_: [], // this is a single jQuery collection\r\n            needToFixHeights: $([]),            \r\n            $timeline: $d.find('.revision_timeline'),\r\n            $revisions_status: $d.find('#revisions_status'),\r\n            $revision_caption_from: $d.find('.revision_caption_from'),\r\n            $revision_caption_at: $d.find('.revision_caption_at'),\r\n            $expand_removed: $d.find('#expand_removed'),\r\n            $collapse_removed: $d.find('#collapse_removed'),\r\n            revisions: [], //array of objects with etag, isDownloaded, modifiedDate, $tick\r\n            revisionFromEtag: {},\r\n            at: null, //revision object\r\n            from: null, //revision object,\r\n            canShowResizeError: true, //used by Revisions_WindowResize\r\n            worker: new Worker(\"js/revisions_worker.js\")\r\n        };\r\n    \r\n        dn.file_history.$view = dn.file_history.$revisions_display.find('ol'); \r\n        dn.file_history.$expand_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',true)});\r\n        dn.file_history.$collapse_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',false)});\r\n        dn.revision_setis_expaned(dn.g_settings.get('historyRemovedIsExpanded'))\r\n\r\n        var w = dn.file_history.worker;\r\n        w.onmessage = dn.revision_worker_delivery;\r\n    }\r\n    dn.file_history.worker.postMessage({ fileId: dn.the_file.file_id, \r\n                                        token: gapi.auth.getToken().access_token,\r\n                                        init: true});\r\n    dn.file_history.$revisions_display.appendTo($('body'));\r\n    $(window).on(\"resize\",dn.revisions_window_resize);\r\n    dn.el.widget_file_history.style.display = '';\r\n    dn.file_history.$view.empty();\r\n    $('#the_editor').style.display = 'none';\r\n    return false;\r\n}\r\n\r\ndn.revision_setis_expaned = function(v){\r\n    var h = dn.file_history;\r\n    if(!h) return; //if we haven't yet initialised fileHistory stuff then ignore this for now, when we do initialise we will read and apply the g_settings value\r\n    \r\n    if(v){\r\n        h.$expand_removed.classList.add('selected')\r\n        h.$collapse_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"expanded\");\r\n    }else{\r\n        h.$collapse_removed.classList.add('selected')\r\n        h.$expand_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"collapsed\")\r\n    }\r\n}\r\ndn.revision_set_at = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.at = r;\r\n    if(!fromChangeEvent)\r\n        h.$at_range.value = r.ind;    \r\n    text_multi(h.$revision_caption_at,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.from && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                      fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.revision_set_from = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.from = r;\r\n    if(!fromChangeEvent)\r\n        h.$from_range.value = r.ind;\r\n    text_multi(h.$revision_caption_from,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.at && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                          fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.display_revision_timeline = function(newRevisions){\r\n    var h = dn.file_history;\r\n    var rs = h.revisions;\r\n    //TODO: update display based on newRevisions rather than starting from scratch\r\n    \r\n    h.$at_range = $(\"<input class='revision_at_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    h.$tick_box = $(\"<div class='revision_tick_box'/>\");\r\n    h.$from_range = $(\"<input class='revision_from_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    \r\n        \r\n    var attr = rs.map(function(t){ return { downloaded: t.isDownloaded || false }; });\r\n    var text = Array.apply(null, Array(attr.length)).map(function () { return \"\" });\r\n    var $ticks = h.$tick_box.insertClonedChildren(0,h.$new_tick,text,attr);\r\n    \r\n    for(var i=0;i<rs.length;i++){\r\n        rs[i].ind = i;\r\n        rs[i].$ = $ticks.eq(i);\r\n    }\r\n    \r\n    h.$timeline.empty().append(h.$at_range).append(h.$tick_box).append(h.$from_range);\r\n\r\n    h.$at_range.on(\"change\",function(){\r\n            dn.revision_set_at(dn.file_history.revisions[this.value],true);\r\n        })\r\n    h.$from_range.on(\"change\",function(){\r\n            dn.revision_set_from(dn.file_history.revisions[this.value],true);\r\n        })\r\n\r\n    dn.revision_set_from(rs.length > 1 ? rs[1] : rs[0],false,true);\r\n    dn.revision_set_at(rs[0],false,true);\r\n}\r\n\r\ndn.revision_worker_delivery = function(e){\r\n    if(!e.data)\r\n        return; //not sure if this is possible\r\n\r\n    if(e.data.debug)\r\n        console.log(e.data);\r\n        \r\n    var h = dn.file_history;\r\n    //TODO: probably ought to use a more sensivle message system with a string command switching thign...but this is ok for now\r\n    \r\n    if(e.data.status)\r\n        text_multi(h.$revisions_status, e.data.status);\r\n        \r\n    if(e.data.revisions){    \r\n        h.revisions = e.data.revisions;\r\n        e.data.revisions.forEach(function(r){ h.revisionFromEtag[r.etag] = r;});\r\n        dn.display_revision_timeline(e.data.revisions);\r\n        h.worker.postMessage({ showEtag: h.at.etag,\r\n                               fromEtag: h.from.etag }); \r\n    }\r\n    \r\n    if(e.data.revisionDownloaded){\r\n        var r = h.revisionFromEtag[e.data.revisionDownloaded];\r\n        r.$.attr('downloaded',true);\r\n        r.isDownloaded = true;\r\n    }\r\n    \r\n    if(e.data.revsionDiffed){\r\n        h.needToRefindViewChildren = true;\r\n        var r = h.revisionFromEtag[e.data.revsionDiffed];\r\n        r.$.attr('diffed',true);\r\n        r.isDiffed = true;\r\n        \r\n        var newStuff = e.data.newStuffForDom;\r\n        for(var i=0;i<newStuff.length;i++){\r\n            var lines = newStuff[i].lines.map(function(str){return str || \" \"});  \r\n                                            // \"|| space\" thing is a hack for auto height stuff\r\n            h.needToFixHeights = h.needToFixHeights.add(\r\n                            h.$view.insertClonedChildren(newStuff[i].at,h.$new_li,lines)    );            \r\n        }\r\n    }\r\n\r\n    \r\n    if(e.data.vals_ui8buffer){\r\n        \r\n        if(h.needToRefindViewChildren){\r\n            h.$rev_lines_ = h.$view.children();\r\n            h.needToRefindViewChildren = false;\r\n        }\r\n        var $rl_ = h.$rev_lines_;\r\n        \r\n        if(h.needToFixHeights.length){\r\n            text_multi(h.$revisions_status, \"Obtaining line height data...\");\r\n            h.needToFixHeights.fixHeightFromAuto();\r\n            h.needToFixHeights = $([]);\r\n            text_multi(h.$revisions_status, \"Selecting lines...\");\r\n        }\r\n        \r\n        var vals = new Uint8Array(e.data.vals_ui8buffer)\r\n        $rl_.setAttribute('v',function(i){return vals[i]});\r\n            \r\n        // We have to manually set the width of the numbers (our version of ace's gutter)\r\n        switch(e.data.digits){\r\n            case 0:\r\n            case 1:\r\n            case 2:\r\n                h.$view.setAttribute('digits','');\r\n                break;\r\n            case 3:\r\n                h.$view.setAttribute('digits','###');\r\n                break;\r\n            case 4:\r\n                h.$view.setAttribute('digits','####');\r\n                break;\r\n            default:\r\n                h.$view.setAttribute('digits','#####');\r\n        }\r\n    }\r\n    \r\n        \r\n}\r\n","\"use strict\";\r\n\r\n/*\r\nThe find focus/blur problem.  This took some thinking to sort out!!!\r\n\r\nIn the end it is now relatively neat and simple to get your head around.\r\n\r\ndn.g_settings.set('pane', 'pane_find') and dn.g_settings.set('pane_open', true)\r\ndo not mess with the focus themselves. Any code that uses that must explicitly\r\ndecide whether or not it wants to focus on the input for search/goto (a choice\r\nwhich is made based on the flag dn.g_settings.get('find_goto')).\r\n\r\nCalling  dn.g_settings.set('find_goto', bool), also does not mess with the focus, it\r\njust renders the inactive version of goto/search.\r\n\r\nWe basically have the same setup for goto and for search, with goto having a less\r\nmeaty implementation, so it's easier to start by looking at that.\r\n\r\nWhen the input gets the focus, the goto/search operation is performed, when the\r\ninput is blurred it sets the info text to \"inactive\".  If the blur events is moving the\r\nfocus to null, then at the end of the blur event we redirect the focus to the editor.\r\n\r\nIn keyboard.js there are special functions for producing exactly the right\r\nfocus behaviour when pressing Esc (with focus on the editor) and pressing \r\nCtrl-F/Crtl-L.  \r\n============================\r\n\r\nEvetunally we may have to deal with the realtime document changes.\r\n\r\n*/\r\n\r\ndn.find_goto_changed = function(new_value){\r\n    // This just toggles the display, it does not deal with focus/blur, which may happen afterwards\r\n    // as a consequence if the relevant inputs previously had the focus.\r\n\r\n    if(new_value){\r\n        dn.el.find_goto_wrapper.style.display = '';\r\n        dn.el.find_find_wrapper.style.display = 'none';\r\n        dn.el.button_goto.classList.add('selected');\r\n        dn.el.find_info.textContent = 'goto line inactive';\r\n        dn.el.find_replace_wrapper.style.display = 'none';\r\n    }else{\r\n        dn.el.find_goto_wrapper.style.display = 'none';\r\n        dn.el.find_find_wrapper.style.display = '';\r\n        dn.el.button_goto.classList.remove('selected');\r\n        dn.el.find_info.textContent = 'search inactive';\r\n        if (dn.g_settings.get('find_replace'))\r\n            dn.el.find_replace_wrapper.style.display = '';\r\n    }\r\n}\r\n\r\ndn.find_replace_changed = function(new_value){\r\n    if(new_value){\r\n        dn.el.button_replace.classList.add('selected');\r\n        if(!dn.g_settings.get('find_goto'))\r\n            dn.el.find_replace_wrapper.style.display = '';\r\n    }else{\r\n        dn.el.find_replace_wrapper.style.display = 'none';\r\n        dn.el.button_replace.classList.remove('selected');\r\n    }\r\n    if(dn.find_inputs_have_focus)\r\n        dn.find_select_result_idx(dn.find_current_match_idx);\r\n}\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// goto :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// the implementation of goto is simpler than for search, so we start with it...\r\n\r\ndn.find_goto_input_has_focus = false; // we don't actually need this, but we keep it for analogy with search\r\n\r\ndn.find_goto_input_focus = function(){\r\n    dn.find_goto_input_has_focus = true;\r\n    dn.el.find_info.textContent = \"type to goto line\";\r\n    dn.find_perform_goto();\r\n}\r\n\r\ndn.find_goto_input_blur = function(e){\r\n    dn.find_goto_input_has_focus = false;\r\n    dn.el.find_info.textContent = \"goto line inactive\"; \r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\ndn.find_perform_goto = function(){\r\n    // called by find_goto_input_focus and find_goto_keyup\r\n    var validated_str = dn.el.find_goto_input.value.replace(/[^\\d]/,'');\r\n    if (validated_str !== dn.el.find_goto_input.value)\r\n        dn.el.find_goto_input.value = validated_str;\r\n    if(validated_str === \"\")\r\n        return;\r\n    var num = parseInt(validated_str);\r\n    dn.editor.gotoLine(num);\r\n    dn.editor.navigateLineEnd();\r\n}\r\n\r\ndn.find_goto_input_keyup = dn.find_perform_goto; //alias\r\n\r\ndn.find_goto_input_keydown = function(e){\r\n    // keydown is fired repeatedly when key remains down\r\n    if(e.which == WHICH.DOWN){\r\n        dn.el.find_goto_input.value = parseInt(dn.el.find_goto_input.value.replace(/[^\\d]/,''))+1;\r\n        dn.find_perform_goto();\r\n        e.preventDefault();\r\n    }else if(e.which == WHICH.UP){\r\n        dn.el.find_goto_input.value = parseInt(dn.el.find_goto_input.value.replace(/[^\\d]/,''))-1;\r\n        dn.find_perform_goto();\r\n        e.preventDefault();\r\n    } else if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false);\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    }\r\n}\r\n\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// search :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n\r\ndn.find_inputs_have_focus = false; // either find itself or replace\r\ndn.find_results = [];\r\ndn.find_current_match_idx = -1;\r\ndn.find_markers = [];\r\ndn.find_marker_current = undefined;\r\ndn.find_str = \"\";\r\n\r\ndn.find_inputs_focus = function(e){\r\n    if(e.currentTarget == dn.el.find_input){\r\n        dn.el.find_input.tabIndex = 101;\r\n        dn.el.find_replace_input.tabIndex = 102;   \r\n    } else {\r\n        dn.el.find_input.tabIndex = 102;\r\n        dn.el.find_replace_input.tabIndex = 101;   \r\n    }\r\n    if(dn.find_inputs_have_focus)\r\n        return; // focus was transfered between replace/find inputs\r\n\r\n    dn.find_inputs_have_focus = true;\r\n    dn.AceSearch = dn.AceSearch || ace.require(\"./search\").Search;\r\n    dn.AceRange = dn.AceRange || ace.require(\"./range\").Range;\r\n    dn.editor.setHighlightSelectedWord(false);  \r\n    dn.find_perform_search();\r\n}\r\n\r\ndn.find_inputs_blur = function(e){\r\n    if(e.relatedTarget == dn.el.find_replace_input  || e.relatedTarget == dn.el.find_input)\r\n        return; // focus is transfering between replace/find inputs\r\n\r\n    dn.find_inputs_have_focus = false;\r\n\r\n    // remove all markers\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    // reset widget display\r\n    dn.el.find_info.textContent = \"search inactive\";\r\n    dn.el.find_results.innerHTML = \"\";\r\n    dn.el.find_info_overflow.textContent = \"\";\r\n\r\n    // forget last search\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n\r\n    // forget last selection in input (in preparation for next time it gets focus)\r\n    dn.el.find_input.setSelectionRange(dn.el.find_input.selectionEnd, dn.el.find_input.selectionEnd);\r\n\r\n     // we had this on false during find\r\n    dn.editor.setHighlightSelectedWord(true);\r\n\r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\ndn.find_build_options = function(){\r\n    var str = dn.el.find_input.value;\r\n    var use_reg_exp = dn.g_settings.get('find_regex');\r\n    var sensitive = dn.g_settings.get('find_case_sensitive');\r\n    if(use_reg_exp){\r\n        var re = undefined;\r\n        re = new RegExp(str, sensitive ? \"g\" : \"gi\"); //cam throw error\r\n    }\r\n    return {\r\n    needle: use_reg_exp ? re : str,\r\n    wrap: true,\r\n    caseSensitive: sensitive,\r\n    wholeWord: dn.g_settings.get('find_whole_words'),\r\n    regExp: use_reg_exp };\r\n}\r\n\r\ndn.find_perform_search = function(){\r\n    // called by find_input_focus, find_settings_changed, and on keyup in the input, when text has changed\r\n\r\n    // clear previous find (but leave selection for now)\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if(dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current)\r\n        dn.find_marker_current = undefined;\r\n    }\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n    dn.el.find_results.innerHTML = \"\";  \r\n    dn.el.find_info_overflow.textContent = \"\";\r\n    dn.el.find_info.textContent = \"\";\r\n    dn.find_str = dn.el.find_input.value; // we only store it to make it easier for key_down to check for true changes\r\n\r\n    var search_options = undefined;\r\n    try{\r\n        search_options = dn.find_build_options();\r\n    } catch (e){\r\n        dn.el.find_info.textContent = escape_str(e.message); //TODO: could force first letter to lower case\r\n    }\r\n\r\n    if(search_options === undefined){\r\n        // failed regex, don't show any results\r\n        dn.editor.selection.clearSelection();\r\n\r\n    } else if(dn.find_str == \"\"){\r\n        // empty string (including empty regex), dont show any results\r\n        dn.el.find_info.textContent = \"type to search. \" /*+ dn.ctrl_key + \"-up/down for history.\"*/;\r\n        dn.editor.selection.clearSelection();\r\n        \r\n    } else {\r\n        // valid regex or pure str search..\r\n\r\n        // This is the actual search\r\n        var search = new dn.AceSearch();\r\n        search.setOptions(search_options);\r\n        var results = dn.find_results = search.findAll(session);\r\n\r\n        if(results.length === 0){\r\n            // No results to display, life is easy...\r\n            dn.el.find_info.textContent = \"no matches found.\";\r\n            dn.el.find_info_overflow.textContent = \"\";\r\n            dn.editor.selection.clearSelection();\r\n\r\n        }else{\r\n            // Right, we got some results ....\r\n\r\n            // Work out which result we should consider the current match.\r\n            var selected_range = session.getSelection().getRange();\r\n            for(var ii=0; ii<results.length; ii++) \r\n                if(results[ii].end.row > selected_range.start.row  || \r\n                    (results[ii].end.row == selected_range.start.row &&\r\n                     results[ii].end.column >= selected_range.start.column))\r\n                break;\r\n            var current_match_idx = (ii == results.length ? results.length-1 : ii);\r\n\r\n            // Add markers into the editor to show *all* the results\r\n            for(var ii=0; ii<results.length; ii++)\r\n                dn.find_markers.push(session.addMarker(results[ii], \"find_match_marker\", \"find_match_marker\", false));\r\n\r\n            // augment the results with their idx, this is useful for the subselection stuff\r\n            for(var ii=0; ii<results.length; ii++)\r\n                results[ii] = {range: results[ii], idx: ii};\r\n\r\n            // Render a subset of the results into the widget and mark & select the current match\r\n            dn.find_select_result_idx(current_match_idx);\r\n        }\r\n    }\r\n\r\n}\r\n\r\ndn.find_select_result_idx = function(current_match_idx){\r\n    // This is called within find_perform_search when a new search returns some results\r\n    // it's also called when we move through the results without changing the search and\r\n    // when replace_changed is called when find input already has the focus.   */\r\n\r\n    // Get a small sub set of results to show in the widget.\r\n    // We carefully implement some wrapping logic, which is a bit fiddly.\r\n    dn.find_current_match_idx = current_match_idx;\r\n\r\n    var session = dn.editor.getSession();\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    var results = dn.find_results;\r\n    var results_sub = [];\r\n    \r\n    var replace_is_showing = dn.g_settings.get('find_replace');\r\n\r\n    var max_results = dn.find_max_results_half*2 + (replace_is_showing ? 0 : 1);\r\n\r\n    if(results.length <= max_results){\r\n        results_sub = results;\r\n    }else{\r\n        var n_pre = dn.find_max_results_half - (replace_is_showing ? 1 : 0);\r\n        var n_post = dn.find_max_results_half;\r\n        if(current_match_idx < n_pre){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n_pre));\r\n            results_sub = results_sub.concat(results.slice(0, current_match_idx));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n_pre, current_match_idx));\r\n        }\r\n        results_sub.push(results[current_match_idx]); \r\n        if(current_match_idx + n_post >= results.length){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1));\r\n            results_sub = results_sub.concat(results.slice(0, n_post + 1 - (results.length - current_match_idx)));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1, current_match_idx + n_post + 1));\r\n        }\r\n    }\r\n\r\n    // Now lets build the html to show the subset of results in the widget\r\n    var show_replace_buttons = dn.g_settings.get('find_replace');\r\n    var html = \"\";\r\n    for(var ii=0; ii<results_sub.length; ii++){\r\n        var row = results_sub[ii].range.start.row;\r\n        var col = results_sub[ii].range.start.column;\r\n        var prefix_range = new dn.AceRange(row, Math.max(0, col-dn.find_max_prefix_chars), row, col);\r\n        var pre_ellipses = col > dn.find_max_prefix_chars; //TODO: deal with indent better\r\n        row = results_sub[ii].range.end.row;\r\n        col = results_sub[ii].range.end.column;\r\n        var suffix_range = new dn.AceRange(row, col, row, col+dn.find_max_suffix_chars);\r\n        html += \"<div class='find_result_item\" + (results_sub[ii].idx==current_match_idx? \" find_result_current\" : \"\") + \"'>\" +\r\n                    \"<div class='find_result_line_num'>\" + (row+1) + \"</div>\" +\r\n                    \"<div class='find_result_text'>\" +\r\n                        \"<div class='find_result_text_inner'>\" +\r\n                            (pre_ellipses ? \"&#8230;\" : \"\") + escape_str(session.getTextRange(prefix_range)) +\r\n                            \"<span class='find_result_match'>\" + escape_str(session.getTextRange(results_sub[ii].range)) + \"</span>\" +\r\n                            escape_str(session.getTextRange(suffix_range)) +\r\n                        \"</div>\" +\r\n                    \"</div>\" +\r\n                    (show_replace_buttons ? \"<div class='button inline_button replace_single_result' title='replace'>r</div>\" : \"\") + \r\n                \"</div>\";\r\n    }\r\n    dn.el.find_results.innerHTML = html;\r\n    var els = dn.el.find_results.getElementsByClassName('find_result_item');\r\n    for(var ii=0; ii<els.length; ii++) if(results_sub[ii].idx !== current_match_idx)\r\n        els[ii].addEventListener('click', dn.find_result_click(results_sub[ii].idx));\r\n    if(show_replace_buttons){\r\n        var els = dn.el.find_results.getElementsByClassName('replace_single_result')\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].addEventListener('click', dn.find_replace_result_click(results_sub[ii].idx));\r\n    }\r\n\r\n    if(results.length > max_results)\r\n        dn.el.find_info_overflow.textContent = \"... and \" + (results.length - max_results) + \" more matches\";\r\n    else\r\n        dn.el.find_info_overflow.textContent = \"\";\r\n\r\n    // do the special marker for the current selection and actually select it\r\n    dn.find_marker_current = session.addMarker(results[current_match_idx].range, \"find_current_match_marker\", \"find_current_match_marker\", false);\r\n    dn.editor.selection.setSelectionRange(results[current_match_idx].range, false);\r\n    dn.editor.renderer.scrollSelectionIntoView();\r\n}\r\n\r\ndn.find_settings_changed = function(){\r\n    if(dn.find_inputs_have_focus || \r\n       (dn.g_settings.get('pane') === 'pane_find' && dn.g_settings.get('pane_open') &&  dn.el.find_input.value))\r\n        dn.find_perform_search();\r\n}\r\n\r\ndn.find_result_click = function(ii){\r\n    // this can only be called while find input has the focus\r\n    return function(e){dn.find_select_result_idx(ii);};\r\n}\r\n\r\ndn.find_replace_result_click = function(ii){\r\n    return function(e){\r\n        dn.find_replace_result_idx(ii);\r\n        e.stopPropagation(); // prevent selecting item\r\n    }\r\n}\r\n\r\ndn.find_input_keyup = function(e){ \r\n    //we need keyup here in order that the val has the new character or new backspace\r\n    if(e.which == WHICH.ENTER || e.which == WHICH.ESC || e.which == WHICH.UP || e.which == WHICH.DOWN)\r\n        return; \r\n    if(dn.find_str == dn.el.find_input.value)\r\n        return;\r\n    dn.find_perform_search()\r\n}\r\n\r\ndn.find_input_keydown = function(e){ \r\n    // we want keydown here so that we can get repeated firing with keydown (i think on most browsers)\r\n\r\n    if ((e.which == WHICH.ENTER && !e.shiftKey) || (!e.ctrlKey && e.which == WHICH.DOWN)){\r\n        //find next\r\n        dn.find_select_result_idx(dn.find_current_match_idx + 1 < dn.find_results.length ? \r\n                                    dn.find_current_match_idx + 1 \r\n                                  : 0);\r\n        e.preventDefault();\r\n        return;\r\n    }else if((e.which == WHICH.ENTER && e.shiftKey) || (!e.ctrlKey && e.which == WHICH.UP)){\r\n        //find previous\r\n        dn.find_select_result_idx(dn.find_current_match_idx - 1 < 0 ? \r\n                                    dn.find_results.length -1 \r\n                                  : dn.find_current_match_idx - 1);\r\n        e.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false); // this focuses on the editor, and blurs the find_input\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        return;   \r\n    }\r\n\r\n}\r\n\r\ndn.find_replace_input_keydown = function(e){\r\n    if(e.which == WHICH.ENTER){\r\n        if(e.ctrlKey || e.shiftKey)\r\n            dn.find_replace_all();\r\n        else\r\n            dn.find_replace_result_idx(dn.find_current_match_idx);\r\n        e.preventDefault();\r\n    }else{\r\n        dn.find_input_keydown(e); // up, down results and esc\r\n    }\r\n}\r\n\r\ndn.find_replace_all = function(e){\r\n    try{\r\n        var options = dn.find_build_options();\r\n    } catch (e) {\r\n        dn.show_error(e.message);\r\n        return;\r\n    }\r\n    dn.editor.replaceAll(dn.el.find_replace_input.value, options);\r\n    dn.focus_editor();\r\n}\r\n\r\ndn.find_replace_click = dn.find_replace_all; //alias\r\n\r\ndn.find_replace_result_idx = function(idx){\r\n    var range = dn.find_results[idx].range;\r\n    // we use undocumented ACE API to avoid messing around tryinng to force it to use the exact range we wanted\r\n    dn.editor.$search.set(dn.find_build_options()); //this is needed so that $tryReplace knows what to do with regex'es\r\n    dn.editor.$tryReplace(range, dn.el.find_replace_input.value) // returns true on success, but do we care?\r\n    dn.find_perform_search();\r\n}","\"use strict\";\r\n\r\ndn.do_print = function(){\r\n    var content = dn.editor.session.doc.getAllLines();\r\n    var html = Array(content.length);\r\n\r\n    for(var i=0; i<content.length;i++)\r\n        html[i] = \"<li><div class='printline'>\" + dn.line_to_html(i) + '</div></li>';\r\n\r\n    var printWindow = window.open('','');\r\n    printWindow.document.writeln(\r\n            \"<html><head><title>\" + dn.the_file.title \r\n            + \"</title></head><style>\"\r\n            + ace.require('ace/theme/' + dn.g_settings.get('theme')).cssText + \"\\nbody{font-size:\"\r\n            + dn.g_settings.get('fontSize') *14 +\"px; white-space:pre-wrap;\" + \r\n            \"font-family:'Monaco','Menlo','Ubuntu Mono','Droid Sans Mono','Consolas',monospace;}\"\r\n            + \"\\nli{color:gray;}\\n.printline{color:black;}</style>\" + \r\n            \"<body class='ace-\"+ dn.g_settings.get('theme').replace('_','-') +\"'><ol id='content'>\" + \r\n            html.join(\"\") +\r\n            \"</ol></body></html>\");\r\n    printWindow.print();\r\n    return false;\r\n}\r\n\r\ndn.line_to_html = function (n){\r\n    var printLayer = Object.create(ace.require('ace/layer/text').Text.prototype); \r\n    var tokens  = dn.editor.getSession().getTokens(n);\r\n    var html = [];\r\n    var screenColumn = 0;\r\n    for (var i = 0; i < tokens.length; i++) {\r\n       var token = tokens[i];\r\n       var value = token.value.replace(/\\t/g,'   ');//TODO:deal with tabs properly\r\n       if(value)\r\n           printLayer.$renderToken(html, 0, token, value);\r\n    }\r\n    return html.join('').replace(/&#160;/g,' ');\r\n}","\"use strict\";\r\n\r\ndn.platform = (function(){\r\n    if(navigator.platform.indexOf(\"Win\") >-1)\r\n        return \"Windows\";\r\n    else if(navigator.platform.indexOf(\"Linux\") >-1)\r\n        return \"Linux\";\r\n    else if(navigator.platform.indexOf(\"Mac\")>-1)\r\n        return \"Mac\";\r\n        \r\n    return null;\r\n})();\r\n\r\ndn.create_pane_shortcuts = function(){\r\n//This is hardly the world's most efficient way of doing this....(but it probably doesn't matter)...\r\n\r\n    var arry = dn.shortcuts_list;\r\n    var dict = {};\r\n    var platform = dn.platform;\r\n\r\n    if(platform == \"Windows\" || platform == \"Linux\"){\r\n       for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts[1];\r\n        }\r\n    }else if(platform == \"Mac\"){\r\n        for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts.length > 2? parts[2] : parts[1];\r\n        }\r\n    }else{\r\n        //TODO: show something here, maybe let user switch, maybe have touch info for ipad & android.\r\n    }\r\n    \r\n    var html = [];\r\n    for(var action in dict)\r\n        html.push(\"<div class='shortcut_item'><div class='shortcut_action'>\" + \r\n                   action + \"</div><div class='shortcut_key'>\" + dict[action].replace(\",\",\"<br>\") +\r\n                   \"</div></div>\");\r\n    for(var action in dn.tooltip_info)if(action in dict)\r\n        dn.tooltip_info[action] += dict[action];\r\n\r\n    dn.el.pane_help_shortcuts.innerHTML =  [\r\n        \"<div class='widget_box_title shortcuts_title'>Keyboard Shortcuts \",\r\n             platform ? \"(\" + platform + \")\" : \"\" ,\r\n        \"</div>\",\r\n        \"<div class='shortcuts_header_action'>action</div><div class='shortcuts_header_key'>key</div>\",\r\n        \"<div class='shortcuts_list'>\",\r\n        html.join(''),\r\n        \"</div>\"].join('');\r\n\r\n};\r\n\r\ndn.esc_pressed = function(e){\r\n    dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n\r\n    if(dn.g_settings.get('pane_open') && dn.g_settings.get('pane') == 'pane_find')\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_shortcut_used = function(e){\r\n    var sel = dn.editor.session.getTextRange(dn.editor.getSelectionRange());\r\n    dn.g_settings.set('find_goto', false);\r\n    dn.g_settings.set('pane', 'pane_find');\r\n    dn.g_settings.set('pane_open', true);\r\n    if(sel){\r\n        dn.el.find_input.value = sel;\r\n        dn.el.find_input.select();\r\n    }\r\n    dn.el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_goto_shortcut_used = function(e){\r\n    dn.g_settings.set('find_goto', true);\r\n    dn.g_settings.set('pane', 'pane_find'); // doing this after the find_active=true, tells the change handler not to put focus back to editor\r\n    dn.g_settings.set('pane_open', true);\r\n    dn.el.find_goto_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.show_replace_shortcut_used = function(e){\r\n    dn.g_settings.set('find_replace', true);\r\n    dn.find_shortcut_used(e);   \r\n}\r\n\r\ndn.make_keyboard_shortcuts = function(){\r\n    //perviously was using ace for handling these shorcuts because it neater (and efficient?) but it was\r\n    //annoying trying to ensure the editor always had focus, and not clear what to do when the editor wasn't showing.\r\n    \r\n    //we have to delete the default ace commands linked to the keys we care about\r\n    dn.editor.commands.removeCommands([\r\n        \"find\",\"findprevious\",\"findnext\",\"replace\",\"jumptomatching\",\"sortlines\",\"selecttomatching\",\"gotoline\"]);\r\n\r\n    //then add new commands on to the document using keymaster.js...\r\n    key('command+s, ctrl+s,  ctrl+alt+s,  command+alt+s', dn.save_content);\r\n    key('command+p, ctrl+p,  ctrl+alt+p,  command+alt+p', dn.do_print);\r\n    key('command+o, ctrl+o,  ctrl+alt+o,  command+alt+o', dn.do_open);\r\n    key('command+n, ctrl+n,  ctrl+alt+n,  command+alt+n', dn.do_new);\r\n    key('command+l, ctrl+l,  ctrl+alt+l,  command+alt+l', dn.find_goto_shortcut_used);\r\n    key('command+f, ctrl+f,  ctrl+alt+f,  command+alt+f', dn.find_shortcut_used); \r\n    key('command+r, ctrl+r,  ctrl+alt+r,  command+alt+r' + \r\n       ', command+g, ctrl+g,  ctrl+alt+g,  command+alt+g', dn.show_replace_shortcut_used);\r\n    key('command+h, ctrl+h,  ctrl+alt+h,  command+alt+h', dn.start_revisions_worker);\r\n    key('esc', dn.esc_pressed);\r\n    key.filter = function(){return 1;}\r\n\r\n    // it seems like the clipboard history cycling only works the old way, i.e. using ace....\r\n    var HashHandler = require(\"ace/keyboard/hash_handler\").HashHandler\r\n    var extraKeyEvents = new HashHandler([\r\n        {bindKey: {win: \"Ctrl-Left\",mac: \"Command-Left\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Down\",mac: \"Command-Down\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Right\",mac:\"Command-Right\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right},\r\n        {bindKey: {win: \"Ctrl-Up\",mac:\"Command-Up\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right}\r\n    ]);\r\n    dn.editor.keyBinding.addKeyboardHandler(extraKeyEvents);\r\n\r\n    // Change \"ctrl\" to \"cmd\" if on Mac\r\n    dn.ctrl_key = \"crtl\"\r\n    if(dn.platform == 'Mac'){\r\n        dn.ctrl_key = 'cmd';\r\n        var els = dn.getElementsByClassName('ctrl_key');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].textContent = 'cmd'\r\n    }\r\n}\r\n","\"use strict\";\r\n// DRIVE NOTEPAD 2016\r\n// by DM\r\n\r\ndn.version_str = '2016a';\r\n\r\n// ############################\r\n// Constants and defaults, see alsp info.js\r\n// ############################\r\n\r\ndn.can_show_drag_drop_error = true;\r\ndn.is_showing_history = false;\r\n\r\ndn.status = {\r\n    // 0: get action in progress\r\n    // -1: failed\r\n    //  1: success\r\n    file_body: 0, \r\n    file_meta: 0, \r\n    file_sharing: 0, // after launching the sharing dialog this is set to -1\r\n    authentication: 0,\r\n    popup_active: 0, // 0 or 1, i.e. true or false\r\n    local_settings: 0,\r\n    realtime_settings: 0\r\n}\r\n\r\ndn.the_file = {\r\n    file_id: null,\r\n    folder_id: null,\r\n    title: null,\r\n    description: '',\r\n    ext: '',\r\n    loaded_mime_type: '',\r\n    new_line_detected: 'none', //'windows', 'unix','mixed', or 'none'\r\n    tab_detected: {val: 'none'},\r\n    is_pristine: true, //true while the document has no unsaved changes (set to true when we request the save not when we get confirmation, but if there is a save error it will be reverted to false).\r\n    mime_type: '',\r\n    is_saving: false,\r\n    data_to_save: {body: null, title: null, description: null}, //holds the values until confirmation of success for each\r\n    generation_to_save: {body: 0, title: 0, description: 0},//when saves return they check their this.description etc. against here and clear data_to_save if they match\r\n    is_read_only: false,\r\n    is_shared: false,\r\n    is_brand_new: false, // true from the point of creating a new document till the point we get confirmation of a successful save\r\n    is_reading_file_object: false, //this is used on drag and drop,\r\n    custom_props: {}, //these are the props potentially stored on the file using the custom properties API\r\n    custom_prop_exists: {}, //each of the custom props that actually exsits for the file will have an entry in this obj, with the key being the property and the value being true.\r\n    saving_title_count: 0 //tracks the number of active save request with just the title.  Whatever the resp, this number is decremented,\r\n};\r\ndn.change_line_history = [];\r\ndn.last_change = null;\r\ndn.change_line_classes =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_',8,5)\r\ndn.change_line_classes_rm =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_rm',8,5)\r\ndn.el = dn.el || {};\r\n\r\n/* ################################################################################################################\r\n\r\n    [Some Notes on settings in Drive Notepad]\r\n\r\n    There are two kinds of settings: per-user settings and per-file settings.\r\n    \r\n    The user settings are stored in dn.g_settings. When the page is loaded this is a fake Google Realtime model, \r\n    which uses a mixture of default values and values read from localStorage.  At some point after authenticating \r\n    the g_settings will become the true Google Realtime model. Whenever a value in g_settings is changed\r\n     dn.setting_changed is called with the appropriate paramaters, this is true right from when the page loads, \r\n     i.e. the first set of values trigger the SettingsChanged, but after that only modifications will trigger a change\r\n      (regardless of whether g_settings is the true model or not).  Use the .set() and .get() methods on the dn.g_settings.\r\n    \r\n    The per-file settings are stored in dn.the_file.custom_props.  When the page is loaded they are initialised with \r\n    default values.  Then, if we have opened an existing file, at some point they will be updated with the true values. \r\n     These settings are *not* a realtime model, rather they are Custom Properties (there's an API for it).  Again, as\r\n      with the per-user settings, whenever the file settings are changed they trigger a call to PropertyUpdated.  Note\r\n       that since this is not backed by a realtime model we won't get changes on the server push to the browser, only\r\n        local changes will be observed.  The per-file settings are shared across anyone who has read and/or write access \r\n        to the file in question. Note that if the default value is chosen the setting value is simply removed from the file.\r\n          Use the dn.set_property() function to set values and read values straight from the dn.the_file.custom_props object.\r\n    \r\n    For each key \"Something\" in customProps there is a function dn.apply_something_choice() which will read the per-user \r\n    and/or the per-file settings (as appropriate) and use the combined result to apply the chosen setting to the editor, \r\n    additionally the function will render the file settings tab and/or the general settings tab. As part of this function \r\n    there will likely be a call to dn.detect_something, which will run some fairly simple heuristic over the current file.\r\n      [TODO: may want to cache this, as it can end up getting called several times during loading and possibly elsewhere.] \r\n      [TODO: may want to have an ApplySomethingChoice for all settings not just those that are covered by customProps.]\r\n\r\n################################################################################################################## */\r\n\r\n\r\n\r\n\r\n\r\n// ############################\r\n// Auth stuff\r\n// ############################\r\n\r\n\r\ndn.handle_auth_error = function(err){\r\n    // this is the error handler for dn.pr_auth\r\n\r\n    dn.status.authorization = -1;\r\n    dn.status.popup_active = 0;\r\n    dn.show_status();\r\n    if(err && err.type && err.type === \"token_refresh_required\")\r\n        dn.reauth_auto();\r\n    else if(err)\r\n        dn.show_error(err.result.error.message);\r\n    else{\r\n        // user has to click button to trigger reauth-manual\r\n        dn.g_settings.set('pane', 'pane_permissions');\r\n        dn.g_settings.set('pane_open', 'true')\r\n        css_animation(dn.el.the_widget, 'shake', function(){}, dn.error_delay_ms);\r\n    }\r\n}\r\n\r\ndn.reauth_auto = function(){ \r\n    dn.status.authorization = 0;\r\n    dn.show_status();\r\n    gapi.auth.authorize(dn.auth_map(true))\r\n        .then(dn.pr_auth.resolve.bind(dn.pr_auth),\r\n              dn.pr_auth.reject.bind(dn.pr_auth));\r\n}\r\n\r\ndn.reauth_manual = function(){\r\n    // if this succeeds it will trigger dn.pr_auth.resolve, which will call \r\n    // any pending (and future) success callbacks.\r\n    dn.status.popup_active = 1;\r\n    dn.status.authorization = 0;\r\n    dn.show_status();    \r\n    gapi.auth.authorize(dn.auth_map(false))\r\n        .then(dn.pr_auth.resolve.bind(dn.pr_auth),\r\n              dn.pr_auth.reject.bind(dn.pr_auth));\r\n}\r\n\r\n\r\ndn.show_user_info = function(a){\r\n    dn.user_info = a.result;\r\n    dn.el.user_name.textContent = a.result.name;\r\n}\r\n\r\n// ############################\r\n// Sharing stuff\r\n// ############################\r\n\r\ndn.do_share = function(){\r\n    if(!dn.the_file.file_id){\r\n        dn.show_error(\"You cannot view/modify the sharing settings until you have saved the file.\")\r\n        return false;\r\n    }\r\n    dn.status.file_sharing = -1; //TODO: see SO question about no callback for share dialog...how are we supposed to know when it's closed and what happened?\r\n    dn.the_file.is_shared = 0;\r\n    dn.show_status();\r\n\r\n    if(dn.el.share_dialog){\r\n        dn.do_share_sub();\r\n    } else {\r\n        gapi.load('drive-share', function(){\r\n            dn.el.share_dialog = new gapi.drive.share.ShareClient(dn.client_id);\r\n            dn.do_share_sub();\r\n        });\r\n    }\r\n\r\n}\r\n\r\ndn.do_share_sub = function(){\r\n    dn.el.share_dialog.setItemIds([dn.the_file.file_id]);\r\n    dn.el.share_dialog.setOAuthToken(gapi.auth.getToken().access_token);\r\n    dn.el.share_dialog.showSettingsDialog();\r\n}\r\n\r\n// ############################\r\n// Newline stuff\r\n// ############################\r\n\r\ndn.detect_new_line = function(str){\r\n    var first_n = str.indexOf(\"\\n\");\r\n    if(first_n == -1)\r\n        return dn.show_newline_status(\"none\");\r\n\r\n    var has_rn = str.indexOf(\"\\r\\n\") != -1;\r\n    var has_solo_n = str.match(/[^\\r]\\n/) ? true : false;\r\n    \r\n    if(has_rn && !has_solo_n)\r\n        return  dn.the_file.new_line_detected = dn.show_newline_status(\"windows\");\r\n    if(has_solo_n && !has_rn)\r\n        return  dn.the_file.new_line_detected = dn.show_newline_status(\"unix\")\r\n    \r\n    return  dn.the_file.new_line_detected = dn.show_newline_status(\"mixed\");\r\n}\r\n\r\ndn.apply_newline_choice = function(str){\r\n    var newlineDefault = dn.g_settings.get('newLineDefault');\r\n    \r\n    if(newlineDefault == \"windows\"){\r\n        dn.el.newline_menu_windows.classList.add('selected')\r\n        dn.el.newline_menu_unix.classList.remove('selected');\r\n    }else{//newlineDefault should be unix\r\n        dn.el.newline_menu_unix.classList.add('selected')\r\n        dn.el.newline_menu_windows.classList.remove('selected');\r\n    }             \r\n                \r\n   if(typeof str == \"string\")\r\n       dn.detect_new_line(str); //Note that it only makes sense to detect new line on downloaded content\r\n   \r\n   dn.show_newline_status(dn.the_file.new_line_detected); //if default changes after load or we have a new file we need this.\r\n   \r\n    dn.el.file_newline_detect.classList.remove('selected');\r\n    dn.el.file_newline_windows.classList.remove('selected');\r\n    dn.el.file_newline_unix.classList.remove('selected');\r\n   if(dn.the_file.custom_props.newline == \"detect\"){\r\n        if(dn.the_file.new_line_detected == \"windows\" || dn.the_file.new_line_detected == \"unix\")\r\n            dn.editor.session.setNewLineMode(dn.the_file.new_line_detected);\r\n        else\r\n            dn.editor.session.setNewLineMode(newlineDefault);    \r\n        dn.el.file_newline_detect.classList.add('selected');\r\n    }else{\r\n        dn.editor.session.setNewLineMode(dn.the_file.custom_props.newline);\r\n            if(dn.the_file.custom_props.newline == \"windows\")\r\n                dn.el.file_newline_windows.classList.add('selected');\r\n            else\r\n                dn.el.file_newline_unix.classList.add('selected');            \r\n    }    \r\n}\r\n\r\ndn.show_newline_status = function(statusStr){\r\n    var str;\r\n    switch(statusStr){\r\n        case 'none':\r\n            str =  \"no newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        case 'mixed':\r\n            str = \"mixture of newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        default:\r\n            str = \"detected \" + statusStr + \"-like newlines\";\r\n    }\r\n    \r\n    dn.el.file_newline_info.textContent = \"(\" + str +\")\";\r\n    \r\n    return statusStr;\r\n}\r\n\r\n\r\n// ############################\r\n// Open stuff\r\n// ############################\r\n\r\ndn.open_button_click = function(){\r\n    gapi.load('picker', function(){\r\n        var view = new google.picker.View(google.picker.ViewId.DOCS);\r\n        try{\r\n            if(!dn.open_picker){\r\n                dn.open_picker = new google.picker.PickerBuilder()\r\n                .enableFeature(google.picker.Feature.NAV_HIDDEN)\r\n                .setAppId(dn.client_id) /* the drive scope requires explicit permission to open each file, and by providing the client_id here you get it for the chosen file */\r\n                .setOAuthToken(gapi.auth.getToken().access_token) /* this gives permission to open the picker..you can do it wtihout a user-specific access_token, but we have one so lets use it */\r\n                .addView(view)\r\n                .setCallback(dn.picker_callback)\r\n                .build();        \r\n                if(!dn.open_picker)\r\n                    throw \"could not build picker\";\r\n            }\r\n            dn.open_picker.setVisible(true);\r\n        } catch (e){\r\n            dn.show_error(\"\" + e);\r\n        }\r\n    });\r\n\r\n}\r\n\r\ndn.picker_callback = function(data) {\r\n    if (data.action == google.picker.Action.PICKED) {\r\n        var file_id = data.docs[0].id;\r\n        var url = \"?state=\" + JSON.stringify({\r\n            action: \"open\",\r\n            userId: dn.url_user_id,\r\n            ids: [file_id]\r\n        });\r\n        window.location = url;\r\n    }else if(data.action == \"cancel\"){\r\n        if(dn.open_new_tab)\r\n            dn.open_new_tab.close();\r\n        dn.focus_editor();\r\n    }\r\n    dn.open_new_tab = undefined;\r\n}\r\n\r\n\r\n// ############################\r\n// Widget stuff\r\n// ############################\r\n\r\ndn.show_help_inner = function(inner_pane){\r\n    // expects string 'shorcuts' or 'tips',  any other values shows main\r\n\r\n    dn.el.pane_help_shortcuts.style.display = 'none';\r\n    dn.el.pane_help_tips.style.display = 'none';\r\n    dn.el.pane_help_main.style.display = 'none';\r\n\r\n    dn.el.button_shortcuts.classList.remove('selected');\r\n    dn.el.button_tips.classList.remove('selected');\r\n    \r\n    if(inner_pane == 'tips'){\r\n        dn.el.pane_help_tips.style.display = '';\r\n        dn.el.button_tips.classList.add('selected');\r\n    } else if(inner_pane == 'shortcuts'){\r\n        dn.el.pane_help_shortcuts.style.display = '';\r\n        dn.el.button_shortcuts.classList.add('selected');\r\n    } else {\r\n        dn.el.pane_help_main.style.display = '';\r\n    }\r\n}\r\n\r\ndn.show_pane = function(id){\r\n    var el = document.getElementById(id);\r\n\r\n    // el can be undefined/null to hide everything\r\n    for(var ii=0; ii < dn.el.widget_content.children.length; ii++)if(dn.el.widget_content.children[ii] !== el){\r\n        dn.el.widget_content.children[ii].style.display = 'none';\r\n        var el_icon = dn.menu_icon_from_pane_id[dn.el.widget_content.children[ii].id];\r\n        if(el_icon)\r\n            el_icon.classList.remove('icon_selected');\r\n    }\r\n\r\n    if(el){\r\n        el.style.display = '';\r\n        var el_icon = dn.menu_icon_from_pane_id[el.id];\r\n        if(el_icon)\r\n            el_icon.classList.add('icon_selected')\r\n    }else{\r\n        dn.g_settings.set('pane_open', false);\r\n    }\r\n}\r\n\r\ndn.widget_mouse_down = function(e){\r\n    dn.widget_mouse_down_info = {\r\n            off_left: -e.clientX,\r\n            off_top: -e.clientY,\r\n            start_time: Date.now(),\r\n            is_dragging: e.button !== 0};\r\n    document.addEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.addEventListener('mouseup', dn.document_mouse_up_widget);\r\n}\r\n\r\ndn.document_mouse_move_widget = function(e){\r\n    var x = e.clientX+dn.widget_mouse_down_info.off_left;\r\n    var y = e.clientY+dn.widget_mouse_down_info.off_top;\r\n    if(!dn.widget_mouse_down_info.is_dragging){\r\n        dn.widget_mouse_down_info.is_dragging = (Date.now() - dn.widget_mouse_down_info.start_time > dn.drag_delay_ms)\r\n                                              || (x*x + y*y > dn.drag_shift_px * dn.drag_shift_px);\r\n    }\r\n    if(dn.widget_mouse_down_info.is_dragging)\r\n        translate(dn.el.the_widget, x, y);\r\n    e.stopPropagation();\r\n\r\n};\r\n\r\ndn.document_mouse_up_widget = function(e){\r\n    document.removeEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.removeEventListener('mouseup', dn.document_mouse_up_widget);\r\n\r\n    if(dn.widget_mouse_down_info.is_dragging){\r\n        var pos = dn.el.the_widget.getBoundingClientRect();\r\n        translate(dn.el.the_widget, 0, 0);\r\n    \r\n        //work out what widget_anchor should be\r\n        var widget_w = dn.el.the_widget.offsetWidth;\r\n        var widget_h = dn.el.the_widget.offsetHeight;\r\n        var window_w = window.innerWidth;\r\n        var window_h = window.innerHeight;\r\n        var anchor = []\r\n        if(pos.left < window_w - (pos.left + widget_w)){\r\n            anchor[0] = 'l'; //anchor left side by window width percentage\r\n            anchor[1] = Math.max(0,pos.left/window_w * 100);\r\n        }else{\r\n            anchor[0] = 'r'; //anchor right side by window width percentage\r\n            anchor[1] = Math.max(0,(window_w - (pos.left + widget_w))/window_w * 100);\r\n        }\r\n        if(pos.top < window_h - (pos.top+ widget_h)){\r\n            anchor[2] = 't'; //anchor top side by window height percentage\r\n            anchor[3] = Math.max(0,pos.top/window_h * 100);\r\n        }else{\r\n            anchor[2] = 'b'; //anchor bottom side by window height percentage\r\n            anchor[3] = Math.max(0,(window_h - (pos.top + widget_h))/window_h * 100);\r\n        }\r\n\r\n        if(dn.g_settings)\r\n            dn.g_settings.set(\"widget_anchor\",anchor); \r\n\r\n    }else{\r\n        dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n    }\r\n    dn.widget_mouse_down_info = undefined;\r\n};\r\n\r\ndn.widget_apply_anchor = function(anchor){\r\n    anchor = Array.isArray(anchor) ? anchor : dn.g_settings.get('widget_anchor');\r\n    var widget_w = dn.el.the_widget.offsetWidth;\r\n    var widget_h = dn.el.the_widget.offsetHeight;\r\n    var window_w = window.innerWidth;\r\n    var window_h = window.innerHeight;\r\n\r\n    if(anchor[0] == 'l'){\r\n        // horizontal position is anchored to a fixed percentage of window width on left of widget\r\n        if(window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = '0px'; //if the widget would overlap the right edge, then instead put it precisely on the right edge\r\n        }else{\r\n            dn.el.the_widget.style.left = anchor[1] + '%';\r\n            dn.el.the_widget.style.right = ''; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.add('flipped');\r\n        dn.el.widget_content.classList.add('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.add('flipped');\r\n\r\n    }else{\r\n        // horizontal position is anchored to a fixed percentage of window width on right of widget\r\n        if( window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = '0px';\r\n            dn.el.the_widget.style.right = ''; //if the widget would overlap the left edge, then instead put it precisely on the left edge\r\n        }else{\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = anchor[1] + '%'; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.remove('flipped');\r\n        dn.el.widget_content.classList.remove('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.remove('flipped');\r\n    }\r\n\r\n    if(anchor[2] == 't'){\r\n        // vertical position is anchored to a fixed percentage of window height on top of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = '0px';  \r\n        }else{\r\n            dn.el.the_widget.style.top = anchor[3] + '%';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }\r\n    }else{\r\n        // vertical position is anchored to a fixed percentage of window height on bottom of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = '0px';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }else{\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = anchor[3] + '%'; \r\n        }\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\ndn.toggle_widget = function(state){\r\n    // provide argument \"true\" to open widget, \"false\" to close\r\n    if(state){\r\n        dn.el.widget_menu.style.display = '';\r\n        dn.el.widget_content.style.display = '';\r\n    }else{\r\n        dn.el.widget_menu.style.display = 'none';\r\n        dn.el.widget_content.style.display = 'none';\r\n    }\r\n}\r\n\r\ndn.show_status = function(){\r\n    // TODO: new file, drag-drop from disk, pristing/saving, modify props, readonly/sharing info\r\n    var s = ''\r\n    if(dn.status.authentication != 1){\r\n        // auth in progress or failed\r\n        if(dn.status.authorization == -1)\r\n            s = \"Authorization required...\";\r\n        else if(dn.status.popup_active)\r\n            s = \"Login/authenticate with popup...\";\r\n        else\r\n            s = \"Authenticating...\";\r\n    } else if (dn.the_file.file_id){\r\n        // a file is/will be loaded...\r\n        if (dn.status.file_meta === 1 && dn.status.file_body === 1){\r\n            s = dn.the_file.title;\r\n            var extra = [];\r\n            if(dn.the_file.is_read_only)\r\n                extra.push(\"read-only\");\r\n            if(dn.the_file.is_shared)\r\n                extra.push(\"shared\");\r\n            if(dn.status.file_sharing == -1)\r\n                extra.push(\"sharing status unknown\");\r\n            if(!dn.the_file.is_pristine)\r\n                extra.push(\"unsaved changes\");\r\n            if(extra.length)\r\n                s += \"\\n[\" + extra.join(', ') + \"]\"; \r\n        }else if(dn.status.file_meta === 0 && dn.status.file_body === 0)\r\n            s = \"Loading file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1 && dn.status.file_body === 0)\r\n            s = \"Loading \" + (dn.the_file.is_read_only? 'read-only ' : '' ) + \r\n                    \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_meta === 0 && dn.status.file_body === 1)\r\n            s = \"Loading metadata for file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1) // and -1\r\n            s = \"Failed to download \" + (dn.the_file.is_read_only? 'read-only ' : '' )\r\n                    +  \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_body === 1) // and -1\r\n            s = \"Failed to download metadata for file:\\n\" + dn.the_file.file_id;\r\n        else // both -1\r\n            s = \"Failed to load file:\\n\" + dn.the_file.file_id;\r\n    } else {\r\n        // no file to load\r\n        s = \"ex nihilo omnia...\";\r\n    }\r\n\r\n    text_multi(dn.el.widget_text, s, true);\r\n}\r\n\r\ndn.show_error = function(message){\r\n    console.log(message); //it's just useful to do this too\r\n    text_multi(dn.el.widget_error_text, message,true);\r\n    dn.el.widget_error.style.display = '';\r\n    css_animation(dn.el.the_widget, 'shake', function(){\r\n        dn.el.widget_error.style.display = 'none';\r\n    }, dn.error_delay_ms);\r\n};\r\n\r\ndn.set_drive_link_to_folder = function(){\r\n    var els = document.getElementsByClassName('link_drive');\r\n    var href = dn.the_file.folder_id ? \r\n                'https://drive.google.com/#folders/' + dn.the_file.folder_id \r\n                : 'https://drive.google.com';\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].href = href;\r\n}\r\n\r\n\r\n// ############################\r\n// Settings stuff\r\n// ############################\r\n\r\n\r\ndn.show_app_data_document = function(doc){\r\n\r\n    var old_temp_g_settings = dn.g_settings;\r\n    dn.g_settings = doc.getModel().getRoot();\r\n    dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    if(!dn.g_clipboard){\r\n        dn.g_settings.set('clipboard', doc.getModel().createList());\r\n        dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    }\r\n    dn.g_find_history = dn.g_settings.get('findHistory');\r\n    if(!dn.g_find_history){\r\n        dn.g_settings.set('findHistory', doc.getModel().createList());\r\n        dn.g_find_history = dn.g_settings.get('findHistory');\r\n    }\r\n    \r\n    var existingKeys = dn.g_settings.keys();\r\n    dn.g_settings.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED, dn.settings_changed);\r\n    console.log('Applying settings from cloud...')\r\n    for(var s in dn.default_settings)\r\n        if(s in old_temp_g_settings.getKeeps())\r\n            dn.g_settings.set(s,old_temp_g_settings.get(s));\r\n        else if(existingKeys.indexOf(s) == -1)\r\n            dn.g_settings.set(s,dn.default_settings[s]);\r\n        else if(JSON.stringify(old_temp_g_settings.get(s)) !== JSON.stringify(dn.g_settings.get(s)))\r\n            dn.settings_changed({property:s, newValue:dn.g_settings.get(s)});// the gapi doesn't automatically trigger this on load\r\n    \r\n    //Check lastDNVersionUsed at this point - by default it's blank, but could also have an out-of-date value\r\n    if(dn.g_settings.get('lastDNVersionUsed') != dn.version_str){\r\n        dn.g_settings.set('help_inner', 'tips');\r\n        dn.g_settings.set('pane', 'pane_help');\r\n        dn.g_settings.set('pane_open', 'true');\r\n        dn.g_settings.set('lastDNVersionUsed', dn.version_str);\r\n    }\r\n\r\n    dn.status.realtime_settings = 1;\r\n}\r\n\r\n\r\n\r\n\r\ndn.load_default_settings = function(){\r\n  //Lets show the user either the defualt settings or the \r\n  //ones last used on this browser (restricted to impersonal settings only)\r\n\r\n  dn.g_settings = (function(){ //mock realtime model to be used until the real model is initialised\r\n      var ob = {};\r\n      var keeps = {}\r\n      return {get: function(k){return ob[k]}, \r\n              set: function(k,v){\r\n                if(ob[k] === v)\r\n                    return;\r\n                ob[k] = v;\r\n                dn.settings_changed({property: k, newValue: v});\r\n                },\r\n              keep: function(k){keeps[k] = true},\r\n              getKeeps: function(){return keeps;}};\r\n                                 \r\n  })();\r\n\r\n  dn.status.local_settings = 0;\r\n  try{\r\n    console.log('Loading default/localStorage settings...');\r\n    for(var s in dn.default_settings)\r\n    if(dn.impersonal_settings_keys.indexOf(s) == -1 || !localStorage || !localStorage[\"g_settings_\" +s])\r\n        dn.g_settings.set(s,dn.default_settings[s]);\r\n    else\r\n        dn.g_settings.set(s,JSON.parse(localStorage[\"g_settings_\" + s]));\r\n  }catch(err){\r\n      if(localStorage) \r\n        localStorage.clear();\r\n      console.log(\"Failed to load defaults/localStorage settings.  Have cleared localStorage cache.\")\r\n  }\r\n  dn.status.local_settings = 1;\r\n}\r\n\r\ndn.settings_changed = function(e){\r\n    var new_value = e.newValue;\r\n    console.log(\"[user settings] \" + e.property +\": \" + new_value);\r\n    if(dn.impersonal_settings_keys.indexOf(e.property)>-1 && localStorage){\r\n        localStorage[\"g_settings_\" + e.property] = JSON.stringify(new_value);\r\n    }\r\n    try{\r\n        switch(e.property){\r\n            case \"widget_anchor\":\r\n                dn.widget_apply_anchor(new_value);\r\n                    break;\r\n            case \"theme\":\r\n                dn.editor.setTheme('ace/theme/' + new_value);\r\n                dn.theme_drop_down.SetInd(dn.theme_drop_down.IndexOf(new_value), true);\r\n                break;\r\n            case \"fontSize\":\r\n                var scrollLine = dn.get_scroll_line();\r\n                dn.el.font_size_text.textContent = new_value.toFixed(1);\r\n                dn.editor.setFontSize(new_value + 'em')    \r\n                dn.editor.scrollToLine(scrollLine);\r\n                break;\r\n            case \"wordWrap\":\r\n                var s = dn.editor.getSession();\r\n                var scrollLine = dn.get_scroll_line();\r\n                s.setUseWrapMode(new_value[0]);\r\n                s.setWrapLimitRange(new_value[1],new_value[2]);\r\n                 dn.editor.scrollToLine(scrollLine);\r\n                if(!new_value[0])\r\n                    dn.el.word_wrap_off.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_off.classList.remove('selected');\r\n                if(new_value[0] && !new_value[1])\r\n                    dn.el.word_wrap_edge.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_edge.classList.remove('selected');\r\n                if(new_value[0] && new_value[1])\r\n                    dn.el.word_wrap_at.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_at.classList.remove('selected');\r\n\r\n                break;\r\n            case \"wordWrapAt\":\r\n                dn.el.word_wrap_at_text.textContent = new_value;\r\n                var curWrap = dn.g_settings.get('wordWrap');\r\n                if(curWrap[1] && curWrap[1] != new_value)\r\n                    dn.g_settings.set('wordWrap',[1,new_value,new_value]);\r\n                dn.editor.setPrintMarginColumn(new_value);\r\n                break;\r\n            case \"showGutterHistory\":\r\n                var s = dn.editor.getSession(); \r\n                if(new_value){\r\n                    dn.el.gutter_history_show.classList.add('selected')\r\n                    dn.el.gutter_history_hide.classList.remove('selected');\r\n                }else{\r\n                    var h = dn.change_line_history;\r\n                    for(var i=0;i<h.length;i++)if(h[i])\r\n                        s.removeGutterDecoration(i,h[i]<0 ? dn.change_line_classes_rm[-h[i]] : dn.change_line_classes[h[i]]);\r\n                    dn.change_line_history = []; \r\n                    dn.el.gutter_history_hide.classList.add('selected')\r\n                    dn.el.gutter_history_show.classList.remove('selected');\r\n                }\r\n                break;\r\n            case \"newLineDefault\":\r\n                dn.apply_newline_choice();\r\n                break;\r\n            case \"historyRemovedIsExpanded\":\r\n                dn.revision_setis_expaned(new_value);\r\n                break;\r\n            case \"softTabN\":\r\n            case \"tabIsHard\":          \r\n                dn.apply_tab_choice(); \r\n                break;\r\n            case 'pane_open':\r\n                dn.toggle_widget(new_value)\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane_open');\r\n                break;\r\n            case 'pane':\r\n                dn.show_pane(new_value);\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane');\r\n                if(new_value !== 'pane_help')\r\n                    dn.g_settings.set('help_inner', 'main');\r\n                break; \r\n            case 'help_inner':\r\n                dn.show_help_inner(new_value);\r\n                break;\r\n            case 'find_regex':\r\n                if(new_value)\r\n                    dn.el.find_button_regex.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_regex.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_whole_words':\r\n                if(new_value)\r\n                    dn.el.find_button_whole_words.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_whole_words.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_case_sensitive':\r\n                if(new_value)\r\n                    dn.el.find_button_case_sensitive.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_case_sensitive.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_replace':\r\n                dn.find_replace_changed(new_value);\r\n                break;\r\n            case 'find_goto':\r\n                dn.find_goto_changed(new_value);\r\n                break;\r\n        }\r\n    }catch(err){\r\n        console.log(\"Error while uptating new settings value.\")\r\n        console.dir(e);\r\n        console.dir(err);\r\n    }\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Font size stuff\r\n// ############################\r\n\r\ndn.font_size_decrement_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size -= dn.font_size_increment;\r\n    font_size = font_size  < dn.min_font_size ? dn.min_font_size: font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\ndn.font_size_increment_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size += dn.font_size_increment;\r\n    font_size = font_size  > dn.max_font_size ? dn.max_font_size:font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Tab stuff\r\n// ############################\r\n// Note that there is a whitespace extension for ace but it doesn't look that mature and we actually have slightly different requirements here.\r\n\r\ndn.detect_tab = function(str){    \r\n    dn.the_file.tab_detected = (function(){ //no need to use a self-executing function here, just lazy coding....\r\n        //This function returns an object with a field \"val\" that takes one of the folling values:\r\n        // none: no indents detected at all\r\n        // mixture: no strong bias in favour of spaces or tabs\r\n        // tab: defintely tabs\r\n        // spaces: definitely space. In this case extra fields are provied....\r\n        //   n: number of spaces\r\n        //   isDefault: true if the default nSpaces value was used as part of the decision making process\r\n        //   threshold: this takes one of three values:\r\n        //          strong: the largest n over threshold was used\r\n        //          weak: no n was over the strong threshold, but the default n was over the weak threshold\r\n        //          failed: no idea what n is, so just use default\r\n    \r\n        var lines = dn.editor.session.getLines(0, 1000);    \r\n        var indents = lines.map(function(str){\r\n                        return str.match(/^\\s*/)[0];\r\n                      });\r\n        indents = indents.filter(function(str){return str !== '';});\r\n        \r\n        if(!indents.length)\r\n            return dn.show_tab_status({val: \"none\"});\r\n            \r\n        //TODO: if first thousand lines happen to have few indents it may be worth checking further down.\r\n        \r\n        var stats = indents.reduce(function(stats,str){\r\n           if(str.indexOf('\\t') > -1)\r\n              if(str.indexOf(' ') > -1)\r\n                stats.nWithMixture++;\r\n              else\r\n                stats.nWithOnlyTabs++;\r\n           else\r\n               stats.spaceHist[str.length] = (stats.spaceHist[str.length] || 0) + 1;   \r\n            return stats;\r\n        },{nWithOnlyTabs: 0,spaceHist: [],nWithMixture: 0});\r\n            \r\n        stats.nSamp = indents.length;\r\n        stats.nWithOnlySpaces = stats.nSamp - stats.nWithMixture - stats.nWithOnlyTabs;\r\n        \r\n        console.dir(stats);\r\n            \r\n        if(stats.nWithOnlyTabs/stats.nSamp >= dn.detect_tabs_tabs_frac)\r\n            return dn.show_tab_status({val: \"tab\"});\r\n    \r\n        if(stats.nWithOnlySpaces/stats.nSamp < dn.detect_tabs_spaces_frac)\r\n            return dn.show_tab_status({val: \"mixture\"});\r\n    \r\n        stats.spaceModHist = [];\r\n        var s;\r\n        for(s=dn.min_soft_tab_n;s<=dn.max_soft_tab_n;s++){\r\n            var m = 0;    \r\n            for(var i=s;i<stats.spaceHist.length;i+=s)\r\n                m += stats.spaceHist[i] !== undefined ? stats.spaceHist[i] : 0;\r\n            stats.spaceModHist[s] = m;\r\n        }\r\n        \r\n        for(s=dn.max_soft_tab_n;s>=dn.min_soft_tab_n;s--)\r\n            if(stats.spaceModHist[s]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac)\r\n                break;\r\n                \r\n        if(s < dn.min_soft_tab_n){\r\n            // nothing was over threshold, but rather than give up lets use a weaker threshold on the default space count\r\n            var defaultNSpaces = dn.g_settings.get('softTabN');    \r\n            if(stats.spaceModHist[defaultNSpaces]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac_for_default)\r\n                return dn.show_tab_status({val: 'spaces', n: defaultNSpaces, isDefault: true, threshold: \"weak\"});\r\n            else\r\n                return dn.show_tab_status({val: \"spaces\", n: defaultNSpaces, isDefault: true, threshold: \"failed\"});\r\n        }else{\r\n            // s is the index of the last element in the spaceModHist array which is over threshold\r\n                return dn.show_tab_status({val: \"spaces\", n: s, isDefault: false, threshold: \"strong\"});\r\n        }\r\n    })();\r\n}\r\n\r\n\r\ndn.show_tab_status = function(d){\r\n    var str;\r\n    var defaultStr = \"\";\r\n    if(dn.g_settings.get(\"tabIsHard\"))\r\n        defaultStr = \"hard tabs\";\r\n    else\r\n        defaultStr = dn.g_settings.get(\"softTabN\") + \" spaces\";\r\n    \r\n    switch(d.val){\r\n        case 'none':\r\n            str = \"no indentations detected, default is \" + defaultStr;\r\n            break;\r\n        case 'mixture':\r\n            str = \"detected mixture of tabs, default is \" + defaultStr;\r\n            break;\r\n        case 'tab':\r\n            str = \"hard tab indentation detected\";\r\n            break;\r\n        case \"spaces\":\r\n            switch(d.threshold){\r\n                case 'strong':\r\n                    str = \"detected soft-tabs of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'weak':\r\n                    str = \"detected close match to default of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'failed':\r\n                    str = \"detected soft-tabs, assuming default \" + d.n + \" spaces\";\r\n                    break;\r\n            }\r\n    }\r\n    \r\n    dn.el.file_tab_info.textContent = \"(\" + str +\")\";\r\n    return d;\r\n}\r\n\r\ndn.apply_tab_choice = function(){\r\n    var defaultTabIsHard = dn.g_settings.get('tabIsHard');\r\n    var defaultSoftTabN = dn.g_settings.get('softTabN');               \r\n                \r\n    var d;\r\n    var isHard;\r\n    var nSpaces;\r\n    var isDetected;\r\n    \r\n    dn.detect_tab();   \r\n    if(dn.the_file.custom_props.tabs == \"detect\"){\r\n        d = dn.the_file.tab_detected;             \r\n        isDetected = true\r\n    }else{\r\n        try{\r\n            d = JSON.parse(dn.the_file.custom_props.tabs);\r\n        }catch(err){\r\n            d = {val: \"none\"};\r\n        }\r\n    }\r\n    switch(d.val){\r\n        case 'none':\r\n        case 'mixture':\r\n            isHard = defaultTabIsHard;\r\n            nSpaces = defaultSoftTabN;\r\n            break;\r\n        case 'tab':\r\n            isHard = true;\r\n            nSpaces = d.n || defaultSoftTabN;\r\n            break;\r\n        case 'spaces':\r\n            isHard = false;\r\n            nSpaces = d.n;\r\n    }\r\n    \r\n    \r\n    if(isHard){\r\n        dn.editor.session.setUseSoftTabs(false);\r\n    }else{\r\n        dn.editor.session.setUseSoftTabs(true);\r\n        dn.editor.session.setTabSize(nSpaces);\r\n    }\r\n    \r\n    dn.el.tab_soft_text.textContent = defaultSoftTabN;\r\n    if(defaultTabIsHard){\r\n        dn.el.tab_hard.classList.add('selected');\r\n        dn.el.tab_soft.classList.remove('selected');\r\n    }else{\r\n        dn.el.tab_soft.classList.add('selected');\r\n        dn.el.tab_hard.classList.remove('selected');\r\n    }\r\n    \r\n    \r\n    dn.el.file_tab_detect.classList.remove('selected');\r\n    dn.el.file_tab_hard.classList.remove('selected');\r\n    dn.el.file_tab_soft.classList.remove('selected');\r\n    if(isDetected){\r\n        dn.el.file_tab_detect.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }else{\r\n        if(d.val == \"tab\")\r\n            dn.el.file_tab_hard.classList.add('selected');\r\n        else\r\n            dn.el.file_tab_soft.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }     \r\n\r\n\r\n}\r\n\r\ndn.set_file_tabs_to_soft_or_hard = function(val,delta){\r\n    var f = dn.the_file;\r\n    var current = f.custom_props.tabs;\r\n    if(current == \"detect\"){\r\n        current = f.tab_detected;\r\n        if(current.val == 'none' || current.val == \"mixture\")\r\n            current = { val: dn.g_settings.get('tabIsHard') ? \"tab\" : \"spaces\",\r\n                        n: dn.g_settings.get('softTabN')};\r\n    }else{\r\n        try{\r\n            current = JSON.parse(current);\r\n        }catch(err){\r\n            console.log(\"JSON.parse failed in SetFileTabsToSoftOrHard with current=\" + current)\r\n            return;\r\n        }\r\n    }\r\n    var newT = {val: val, n: current.n + delta};\r\n    dn.set_property(\"tabs\",JSON.stringify(newT));\r\n}\r\n// ############################\r\n// Syntax stuff\r\n// ############################\r\n\r\ndn.show_syntax_status = function(d){\r\n    var str = \"detected \" + d.syntax + \" from file extension\";\r\n    //TODO: if we improve upon DetectSyntax will need to add stuff here\r\n    dn.el.file_ace_mode_info.textContent = \"(\" + str + \")\";\r\n    return d.syntax;\r\n}\r\ndn.detect_syntax = function(){\r\n    //TODO: improve upon this\r\n    var title = dn.the_file.title || \"untitled.txt\";\r\n    var mode  = require(\"ace/ext/modelist\").getModeForPath(title);\r\n    dn.the_file.syntax_detected = mode.caption;\r\n    dn.show_syntax_status({syntax: dn.the_file.syntax_detected});\r\n    dn.the_file.syntax_detected = mode;\r\n}\r\n\r\ndn.apply_syntax_choice = function(){\r\n    dn.detect_syntax();\r\n    if(dn.the_file.custom_props[\"aceMode\"] == \"detect\"){\r\n        dn.set_syntax(dn.the_file.syntax_detected);\r\n        dn.el.file_ace_mode_detect.classList.add('selected');\r\n        dn.syntax_drop_down.SetSelected(false);\r\n    }else{\r\n        dn.set_syntax(dn.the_file.custom_props[\"aceMode\"])\r\n        dn.el.file_ace_mode_detect.classList.remove('selected');\r\n        dn.syntax_drop_down.SetSelected(true);\r\n    }\r\n}\r\n\r\ndn.set_syntax = function(val){\r\n    var modesArray = require(\"ace/ext/modelist\").modes;\r\n    var mode;\r\n    var ind;\r\n    \r\n    if(typeof val == \"number\"){\r\n        //val is index into mdoes array\r\n        mode = modesArray[val].mode;\r\n        ind = val;\r\n    }else if(modesArray.indexOf(val) > -1){\r\n        //val is an element of the modelist array\r\n        mode = val.mode;\r\n        ind = modesArray.indexOf(val);\r\n    }else{\r\n        //val is caption of mode in modes array\r\n        for(ind=0;ind<modesArray.length;ind++)if(modesArray[ind].caption == val){\r\n            mode = modesArray[ind].mode;\r\n            break;\r\n        }    \r\n    }\r\n    \r\n    if(dn.syntax_drop_down)\r\n        dn.syntax_drop_down.SetInd(ind,true);\r\n    dn.editor.getSession().setMode(mode);\r\n}\r\n\r\ndn.create_theme_menu = function(){\r\n    var themes = require('ace/ext/themelist');\r\n    var theme_drop_down = new DropDown(Object.keys(themes.themesByName));\r\n    theme_drop_down.addEventListener(\"change\",function(){\r\n        dn.g_settings.set(\"theme\",theme_drop_down.GetVal());\r\n    })\r\n    theme_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return theme_drop_down;\r\n}\r\n\r\ndn.create_syntax_menu = function(){\r\n    var modes = require(\"ace/ext/modelist\").modes;\r\n    \r\n    var syntax_drop_down = new DropDown(modes.map(function(m){return m.caption;}));\r\n    \r\n    syntax_drop_down.addEventListener(\"click\", dn.read_only_bail);\r\n    \r\n    syntax_drop_down.addEventListener(\"click\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"change\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return syntax_drop_down;\r\n}\r\n\r\n// ############################\r\n// File details stuff\r\n// ############################\r\ndn.read_only_bail = function(e){\r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"The file is read-only, so you cannot change its properties.\");\r\n        e.stopImmediatePropagation();\r\n       dn.focus_editor();\r\n    }\r\n}\r\ndn.create_file_details_tool = function(){\r\n    var els = [dn.el.details_title_text,\r\n               dn.el.details_description_text,\r\n               dn.el.file_newline_detect,\r\n               dn.el.file_newline_windows,\r\n               dn.el.file_newline_unix,\r\n               dn.el.file_tab_detect,\r\n               dn.el.file_tab_soft,\r\n               dn.el.file_tab_hard,\r\n               dn.el.file_ace_mode_detect];\r\n    for(var ii=0; ii< els.length; ii++)\r\n        els[ii].addEventListener(\"click\",dn.read_only_bail); //If file is read only, ReadOnlyBail will prevent the click handlers below from running.\r\n        \r\n    //Title change stuff\r\n    dn.el.details_title_text.addEventListener('click', function(){                \r\n            dn.el.details_title_text.style.display = 'none';\r\n            dn.el.details_title_input.style.display = '';\r\n            dn.el.details_title_input.focus();\r\n            dn.el.details_title_input.select();\r\n    });\r\n    dn.el.details_title_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_title_input.style.display = 'none';\r\n            dn.el.details_title_text.style.display = '';\r\n            var new_val = dn.el.details_title_input.value;\r\n            if(new_val == dn.the_file.title)\r\n                return;\r\n            dn.the_file.title = new_val\r\n            dn.show_file_title(); //includes showStatus\r\n            dn.apply_syntax_choice();\r\n            dn.save_file_title();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_title_input.addEventListener('keyup', function(e){\r\n            if(e.which == WHICH.ENTER)\r\n                dn.el.details_title_input.trigger('blur');\r\n    });\r\n    dn.el.details_title_input.addEventListener('keydown', function(e){\r\n        if(e.which == WHICH.ESC){\r\n            dn.el.details_title_input.value = dn.the_file.title;\r\n            dn.el.details_title_input.trigger('blur');\r\n            dn.ignore_escape = true; //stops ToggleWidget\r\n        }\r\n    });\r\n\r\n    // File action buttons stuff\r\n    dn.el.button_save.addEventListener('click', dn.save_content);\r\n    dn.el.button_print.addEventListener('click', dn.do_print);\r\n    dn.el.button_share.addEventListener('click', dn.do_share);\r\n    dn.el.button_history.addEventListener('click', dn.start_revisions_worker);\r\n\r\n    // Description stuff\r\n    dn.el.details_description_text.addEventListener('click', function(){            \r\n            dn.el.details_description_text.style.display = 'none';\r\n            dn.el.details_description_input.style.display = '';\r\n            dn.el.details_description_input.focus();\r\n    });\r\n    dn.el.details_description_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_description_input.style.display = 'none';\r\n            dn.el.details_description_text.style.display = '';\r\n            var new_val = dn.el.details_description_input.value;\r\n            if(dn.the_file.description === new_val)\r\n                return;\r\n            dn.the_file.description = new_val;\r\n            dn.show_description();\r\n            dn.save_file_description();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_description_input.addEventListener('keydown',function(e){\r\n            if(e.which == WHICH.ESC){\r\n                dn.el.details_description_input.value = dn.the_file.description;\r\n                dn.el.details_description_input.trigger('blur');\r\n                dn.ignore_escape = true;\r\n            }\r\n    });\r\n        \r\n    // File custom props stuff\r\n    dn.el.file_newline_detect.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"detect\");\r\n        dn.focus_editor();      \r\n    });\r\n    dn.el.file_newline_windows.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"windows\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_newline_unix.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"unix\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_tab_detect.classList.add('selected');\r\n    dn.el.file_tab_detect.addEventListener('click', function(){\r\n        dn.set_property(\"tabs\",\"detect\");\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_tab_soft.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",0);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_dec').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",-1);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_inc').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",+1);\r\n       dn.focus_editor();\r\n    })\r\n    dn.el.file_tab_hard.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"tab\",0);\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_ace_mode_detect.addEventListener('click', function(){\r\n       dn.set_property(\"aceMode\",\"detect\"); \r\n    });\r\n}\r\n\r\ndn.save_file_description = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    \r\n    dn.save_file(dn.the_file.file_id, {description: dn.the_file.description}, undefined, \r\n                $.proxy(dn.save_done,{description: ++dn.the_file.generation_to_save.description}))\r\n    dn.show_status();\r\n    return;\r\n    \r\n}\r\n\r\ndn.save_file_title = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    //TODO: mime-type IMPORTANT!\r\n\r\n    dn.save_file(dn.the_file.file_id, {title: dn.the_file.title}, undefined, \r\n                $.proxy(dn.save_done,{title: ++dn.the_file.generation_to_save.title}))\r\n    dn.show_status();    \r\n}\r\n\r\ndn.show_file_title = function(){\r\n    dn.el.details_title_text.textContent = 'Title: ' + dn.the_file.title;\r\n    dn.el.details_title_input.value = dn.the_file.title;\r\n    document.title = (dn.the_file.is_pristine ? \"\" : \"*\") + dn.the_file.title;\r\n    dn.show_status();\r\n}\r\n\r\ndn.show_description = function(){\r\n    text_multi(dn.el.details_description_text, 'Description: ' + dn.the_file.description,true);\r\n    dn.el.details_description_input.value = dn.the_file.description;\r\n}\r\n\r\n// ############################\r\n// Save stuff\r\n// ############################\r\n\r\ndn.save_content = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return false;\r\n    }\r\n    \r\n    if(!dn.the_file.is_pristine){\r\n        dn.the_file.data_to_save.body = dn.editor.getSession().getValue();\r\n        dn.the_file.generation_to_save.body++;\r\n        dn.el.widget_pending.style.display = '';\r\n        dn.the_file.is_saving = true;\r\n        dn.the_file.is_pristine = true;\r\n    }\r\n    \r\n    dn.show_file_title(); //includes a showstatus calls\r\n    dn.do_save();\r\n    return false;\r\n}\r\n\r\ndn.do_save = function (){\r\n    \r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"Cannot save read-only file.\");\r\n        return false;\r\n    }\r\n    \r\n    if(!(dn.the_file.data_to_save.body || dn.the_file.data_to_save.title || dn.the_file.data_to_save.description)){\r\n        dn.show_error(\"No changes since last save.\");\r\n        return false;\r\n    }\r\n\r\n    var gens = {};\r\n    var body, meta;\r\n    if(dn.the_file.data_to_save.body){\r\n        body = dn.the_file.data_to_save.body;\r\n        gens.body = dn.the_file.generation_to_save.body;\r\n    }\r\n    if(dn.the_file.data_to_save.title || dn.the_file.data_to_save.description){\r\n        meta = {};\r\n        if(dn.the_file.data_to_save.title){\r\n            meta.title = dn.the_file.data_to_save.title;\r\n            gens.title = dn.the_file.generation_to_save.title;\r\n        }\r\n        if(dn.the_file.data_to_save.description){\r\n            meta.description = dn.the_file.data_to_save.description; \r\n            gens.description = dn.the_file.generation_to_save.description;\r\n        }\r\n    }\r\n    dn.save_file(dn.the_file.file_id, meta, body, $.proxy(dn.save_done,gens))\r\n    return false;\r\n}\r\n\r\ndn.save_done = function(resp){\r\n    if(resp.error){\r\n        if(resp.error.code == 401){\r\n            dn.reauth_auto(dn.do_save); //will make use of dn.the_file.data_to_save and generation_to_save once auth is done.\r\n        }else{\r\n            var failures = []\r\n            if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n                failures.push(\"body\");\r\n                dn.the_file.is_saving = false;\r\n                dn.the_file.is_pristine = false;\r\n                dn.show_file_title();\r\n                dn.el.widget_pending.style.display = 'none';\r\n                dn.the_file.data_to_save.body = null;\r\n            }\r\n            if(this.title && this.title == dn.the_file.generation_to_save.title)\r\n                failures.push(\"title\");\r\n            if(this.description && this.description == dn.the_file.generation_to_save.description)\r\n                failures.push(\"description\");\r\n            \r\n            if(failures.length){//it's possible that all parts of the save request have since been superceded, so we can ignore this failure\r\n                dn.show_error(\"Failed to save \" +  oxford_comma(failures) + \". Error #\" + resp.error.code + (resp.error.message? \"\\n\" + resp.error.message : \"\"));\r\n                console.dir(resp);\r\n            }            \r\n        }\r\n    }else{//success...\r\n        if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n            dn.the_file.is_saving = false;\r\n            dn.el.widget_pending.style.display = 'none';\r\n            dn.the_file.ext = resp.fileExtension;\r\n            dn.g_settings.set('ext',resp.fileExtension);\r\n            dn.the_file.data_to_save.body = null;\r\n            \r\n            if(dn.the_file.is_brand_new)\r\n                dn.saved_new_file(resp); \r\n        }\r\n        if(this.title && this.title == dn.the_file.generation_to_save.title){\r\n            dn.the_file.data_to_save.title = null;\r\n        }\r\n        if(this.description && this.description == dn.the_file.generation_to_save.description){\r\n            dn.the_file.data_to_save.description = null;\r\n        }\r\n\r\n    }\r\n    dn.show_status();\r\n}\r\n\r\ndn.save_file = function (fileId, fileMetadata, fileText, callback) {\r\n    //if fileId is null then a new file is created (can set fileMetadata.parentNodes = [parentFolderId])\r\n    //fileMetadata or fileText can be null.\r\n    //See https://developers.google.com/drive/v2/reference/files/insert - Request Body for valid metaData.\r\n\r\n    //build a multipart message body\r\n    var boundary = dn.make_boundary();\r\n    var delimiter = \"\\r\\n--\" + boundary + \"\\r\\n\";\r\n    var close_delim = \"\\r\\n--\" + boundary + \"--\";\r\n\r\n    var messageBody = delimiter +\r\n                'Content-Type: application/json\\r\\n' +\r\n                '\\r\\n' + JSON.stringify(fileMetadata ? fileMetadata : {}); //note than in the multipart message upload you must provide some json metadata, even if it's empty.\r\n\r\n    if(fileText){ \r\n        messageBody += delimiter +\r\n                'Content-Type: application/octet-stream\\r\\n' +\r\n                'Content-Transfer-Encoding: base64\\r\\n' +\r\n                '\\r\\n' + btoa(unescape(encodeURIComponent(fileText))); //javascript strings are utf16 encoded, but btoa only accespts ASCII, somehow the two extra functions here smooth over this problem and produce the expected result at the server end.\r\n    }\r\n    messageBody += close_delim;\r\n\r\n    var request = gapi.client.request({\r\n        path: '/upload/drive/v2/files/' + (fileId ? fileId : \"\"),\r\n        method: (fileId? 'PUT' : 'POST'),\r\n        params: {'uploadType': 'multipart'},\r\n        headers: {'Content-Type': 'multipart/mixed; boundary=\"' + boundary + '\"'} ,\r\n        body:   messageBody}\r\n        );\r\n\r\n    request.execute(callback);\r\n}\r\n\r\ndn.make_boundary = function(){\r\n    //for MIME protocol, require a boundary that doesn't exist in the message content.\r\n    //we could check explicitly, but this is essentially guaranteed to be fine:\r\n    // e.g. \"13860126288389.206091766245663\"\r\n    return (new Date).getTime() + \"\" + Math.random()*10;\r\n}\r\n\r\n// ############################\r\n// Clipboard stuff\r\n// ############################\r\n\r\ndn.document_clipboard_left = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index <= 0)\r\n            return true;\r\n        dn.clipboard_index--;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_right = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index >= dn.g_clipboard.length-1)\r\n            return true;\r\n\r\n        dn.clipboard_index++;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_keyup = function(e){\r\n    if(e.which == 17 || e.which == 91 || !e.ctrlKey){\r\n        $(document).off('keyup',dn.document_clipboard_keyup);\r\n        dn.clipboard_active = false;\r\n        dn.el.pane_clipboard.style.display = 'none';\r\n        if(dn.clipboard_info_timer){\r\n            clearTimeout(dn.clipboard_info_timer);\r\n            dn.clipboard_info_timer = null;\r\n        }\r\n    }\r\n}\r\n\r\ndn.on_paste = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    $(document).on('keyup',dn.document_clipboard_keyup);\r\n    dn.clipboard_active = true;\r\n        \r\n    dn.clipboard_index = dn.g_clipboard.lastIndexOf(text); \r\n    if(dn.clipboard_index == -1){ //it's possible the user copied some text from outside the DN, in which case we will add it to the clipboard now\r\n       dn.clipboard_index = dn.g_clipboard.push(text);\r\n       while(dn.g_clipboard.length >dn.clipboard_max_length) //same as on copy\r\n         dn.g_clipboard.remove(0);\r\n    }\r\n    if(dn.clipboard_info_timer)\r\n        clearTimeout(dn.clipboard_info_timer);\r\n\r\n    dn.clipboard_info_timer = setTimeout(function(){\r\n        dn.clipboard_info_timer = null;\r\n        dn.el.pane_clipboard.style.display = '';\r\n    },dn.clipboard_info_delay);\r\n}\r\n\r\ndn.on_copy = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    dn.g_clipboard.push(text);\r\n    while(dn.g_clipboard.length >dn.clipboard_max_length)\r\n        dn.g_clipboard.remove(0);\r\n}\r\n\r\ndn.create_clipboard_tool = function(){\r\n    dn.el.pane_clipboard = document.getElementById('pane_clipboard');\r\n    dn.el.button_clear_clipboard.addEventListener('click', function(){\r\n            dn.g_clipboard.clear();\r\n    });\r\n    dn.el.button_clear_find_replace.addEventListener('click', function(){\r\n            dn.g_find_history.clear();\r\n    });\r\n}\r\n\r\n\r\n// ############################\r\n// New file stuff\r\n// ############################\r\n\r\ndn.do_new = function(){\r\n    //TODO: this could actually just be a link, updated in settingschanged-ext\r\n    var base = window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0];\r\n    window.open(base + \"?state=\" + JSON.stringify({\r\n                action: \"create\",\r\n                folderId: dn.the_file.folder_id ? dn.the_file.folder_id : '',\r\n                ext: dn.g_settings.get('ext')}),\"_blank\");\r\n    return false;\r\n}\r\n\r\ndn.create_new_tool = function(){\r\n    dn.el.menu_new.addEventListener('click', dn.do_new);\r\n}\r\n\r\ndn.create_file = function(){\r\n    dn.apply_syntax_choice();\r\n    dn.the_file.is_brand_new = true;\r\n    dn.show_file_title();\r\n    dn.show_description();\r\n    dn.apply_newline_choice();\r\n    dn.apply_tab_choice();\r\n    dn.g_settings.set(\"pane\",\"pane_file\");  \r\n}\r\n\r\ndn.guess_mime_type = function(){\r\n    // we set the mimeType on new files, it's too complicated to try and guess it otherwise (at least for now)\r\n    if(dn.the_file.loaded_mime_type)\r\n        return dn.the_file.loaded_mime_type;\r\n    var plain = \"text/plain\";\r\n    var ext = dn.the_file.title.match(/\\.[0-9a-z]+$/i);\r\n\r\n    if(!ext)\r\n        return plain;\r\n    else\r\n        ext = ext[0].substr(1);\r\n    \r\n    return (ext in dn.ext_to_mime_type)? dn.ext_to_mime_type[ext] : plain;\r\n\r\n}\r\n\r\ndn.save_new_file = function(){\r\n    var f = dn.the_file;\r\n    if(f.is_saving){\r\n        dn.show_error(\"File is being created. Please wait.\");\r\n        return false;\r\n    }\r\n    var meta = {title: f.title, \r\n                description: f.description,\r\n                mimeType: dn.guess_mime_type()};\r\n    var parentId = f.folderId;\r\n    if(parentId) \r\n        meta.parentNodes =[{id:[parentId]}];\r\n    f.data_to_save.body = dn.editor.getSession().getValue();\r\n    f.data_to_save.title = meta.title;\r\n    f.data_to_save.description = meta.description;\r\n    var gens = {title: ++f.generation_to_save.title, description: ++f.generation_to_save.description,body: ++f.generation_to_save.body};\r\n    f.is_saving = true;\r\n    f.is_pristine = true;\r\n    dn.show_file_title();\r\n    dn.el.widget_pending.style.display = '';\r\n    dn.show_status();\r\n    dn.save_file(null, meta, f.data_to_save.body, $.proxy(dn.save_done,gens));\r\n}\r\n\r\ndn.saved_new_file = function(resp){\r\n    dn.the_file.is_brand_new = false;\r\n    dn.the_file.file_id = resp.id;\r\n    dn.the_file.is_shared = resp.shared;\r\n    dn.status.file_sharing = 1;\r\n    dn.the_file.ext = resp.fileExtension;\r\n    history.replaceState({},dn.the_file.title,\r\n            window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0] +\r\n                \"?state={\\\"action\\\":\\\"open\\\",\\\"ids\\\":[\\\"\" + dn.the_file.file_id + \"\\\"]}\");\r\n    dn.set_drive_link_to_folder();\r\n    dn.save_all_file_properties();\r\n}\r\n\r\n// ############################\r\n// Scrolling stuff\r\n// ############################\r\n\r\ndn.save_scroll_line = function(){\r\n    dn.patch_property(dn.the_file.file_id, \r\n                    \"ScrollToLine\",\r\n                    dn.get_scroll_line(),\r\n                    'PUBLIC',null);\r\n}\r\n\r\ndn.get_scroll_line = function(){\r\n    return  dn.editor.getSession().screenToDocumentPosition(dn.editor.renderer.getScrollTopRow(),0).row;\r\n}\r\n\r\n// ############################\r\n// Load stuff\r\n// ############################\r\n\r\n\r\n\r\ndn.show_file_meta = function(resp) {\r\n    if (resp.error)\r\n        throw Error(resp.error);\r\n    dn.the_file.title = resp.result.name;\r\n    dn.the_file.description = resp.result.description || '';\r\n    dn.show_description();\r\n    dn.the_file.ext = resp.result.fileExtension\r\n    dn.the_file.is_read_only = !resp.result.capabilities.canEdit;\r\n    dn.the_file.is_shared = resp.result.shared; \r\n    dn.the_file.loaded_mime_type = resp.result.mimeType;\r\n    if(resp.result.parents && resp.result.parents.length){\r\n        dn.the_file.folder_id = resp.result.parents[0];\r\n        dn.set_drive_link_to_folder();\r\n    }\r\n    dn.show_file_title(); //includes a showStatus call\r\n    dn.status.file_meta = 1;\r\n    dn.show_status();\r\n} \r\n\r\ndn.show_file_body = function(resp){\r\n    dn.setting_session_value = true;\r\n    dn.editor.session.setValue(resp.body);\r\n    dn.setting_session_value = false;\r\n    dn.apply_newline_choice(resp.body);\r\n    dn.apply_syntax_choice();\r\n    dn.apply_tab_choice(); \r\n    dn.status.file_body = 1;\r\n    dn.show_status();\r\n}\r\n\r\n\r\n// ############################\r\n// Change/history stuff\r\n// ############################\r\n\r\ndn.on_change = function(e){\r\n    //console.dir(e);\r\n\r\n    if(!e.start || !e.end || dn.setting_session_value)\r\n        return;\r\n        \r\n    if(dn.the_file.is_pristine){\r\n        dn.the_file.is_pristine = false;\r\n        dn.show_file_title();\r\n        dn.show_status();\r\n    }\r\n\r\n    if(!dn.g_settings.get('showGutterHistory'))\r\n        return;\r\n\r\n    var nClasses = dn.change_line_classes.length-1;\r\n    var h = dn.change_line_history;\r\n    var s = dn.editor.getSession(); \r\n\r\n    var start_row = e.start.row;\r\n    var end_row = e.end.row;\r\n\r\n    if(dn.last_change && dn.last_change.start_row == start_row && dn.last_change.end_row == end_row && start_row == end_row\r\n        && dn.last_change.action.indexOf(\"Text\") != -1 && e.action.indexOf(\"Text\") != -1){\r\n            //if this change and the last change were both on the same single lines with action (insert|remove)Text...\r\n\r\n            if(dn.last_change.action == e.action){\r\n                return; //same action as last time\r\n            }else if(e.action == \"removeText\"){ // new action is removeText, old action was insertText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                h[start_row] = -nClasses;\r\n                dn.last_change.action = \"removeText\";\r\n                return;\r\n            }else{// new action is isnertText, old action was removeText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                h[start_row] = nClasses;\r\n                dn.last_change.action = \"insertText\";\r\n                return;\r\n            }\r\n\r\n    }else{\r\n        //otherwise we have an acutal new change\r\n        dn.last_change = {start_row: start_row, end_row: end_row, action: e.action};\r\n    }\r\n\r\n    //remove all visible decorations and update the changeLineHistory values (we'll add in the new classes at the end)\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.removeGutterDecoration(i,h[i] < 0 ? \r\n                    dn.change_line_classes_rm[-h[i]++] : \r\n                    dn.change_line_classes[h[i]--]);\r\n\r\n    //Update the changeLineHistory relating to the current changed lines\r\n    if(e.action == \"removeLines\"){\r\n        h.splice(start_row, end_row - start_row + 1);        \r\n        h[start_row] = h[start_row+1] = -nClasses;\r\n    }else if(e.action === \"removeText\"){\r\n        h[start_row] = -nClasses;\r\n    }else{\r\n        var newLineCount = 0;\r\n        if(e.action == \"insertText\")\r\n            newLineCount = (e.text.match(/\\n/g) || []).length;\r\n        if(e.action == \"insertLines\")\r\n            newLineCount = e.lines.length;\r\n        h.splice.apply(h,[start_row,0].concat(Array(newLineCount)));\r\n\r\n        for(var i=start_row;i<=end_row;i++)\r\n            h[i] = nClasses;\r\n\r\n    }\r\n\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.addGutterDecoration(i,h[i]<0 ?\r\n                dn.change_line_classes_rm[-h[i]] :\r\n                dn.change_line_classes[h[i]]);\r\n} \r\n\r\ndn.query_unload = function(){\r\n    if(!dn.the_file.is_pristine)\r\n        return \"If you leave the page now you will loose the unsaved \" + (dn.the_file.is_brand_new ? \"new \" : \"changes to \") + \"file '\" + dn.the_file.title + \"'.\"\r\n}\r\n\r\n\r\n// ############################\r\n// Properties stuff\r\n// ############################\r\ndn.property_updated = function(propKey,new_val){\r\n    console.log(\"[file custom property]  \" + propKey + \": \" + new_val);\r\n    switch(propKey){\r\n        case \"newline\":\r\n            dn.apply_newline_choice();\r\n            break;\r\n        case \"tabs\":            \r\n            dn.apply_tab_choice();\r\n            break;\r\n        case \"aceMode\":\r\n            dn.apply_syntax_choice();\r\n            break;\r\n    }\r\n    \r\n}\r\n\r\ndn.load_default_properties = function(){\r\n    for(var k in dn.default_custom_props)\r\n        dn.set_property(k,dn.default_custom_props[k]);\r\n}\r\n\r\ndn.get_properties_from_cloud = function() {    \r\n    // TODO:\r\n    /*\r\n    gapi.client.drive.properties.list({\r\n    'fileId': dn.the_file.file_id\r\n    }).execute(dn.got_all_file_properties);*/\r\n}\r\n\r\ndn.got_all_file_properties = function(resp){\r\n    if(resp.items){\r\n        dn.the_file.custom_prop_exists = {};\r\n        for(var i=0;i<resp.items.length;i++){\r\n            dn.the_file.custom_props[resp.items[i].key] = resp.items[i].value;\r\n            dn.the_file.custom_prop_exists[resp.items[i].key] = true;\r\n            dn.property_updated(resp.items[i].key,resp.items[i].value);\r\n        }\r\n    }\r\n}\r\n\r\ndn.save_all_file_properties = function(){\r\n    //To be used after creating a file, in order to set any of the props which had been modified before saving it\r\n    for(var k in dn.the_file.custom_props)\r\n        dn.set_property(k,dn.the_file.custom_props[k]);    \r\n}\r\n\r\ndn.set_property = function(prop_name,new_val){\r\n\r\n    var oldVal = dn.the_file.custom_props[prop_name]; \r\n    dn.the_file.custom_props[prop_name] = new_val;\r\n    if(oldVal !== new_val)\r\n        dn.property_updated(prop_name,new_val);\r\n\r\n    if(!(gapi && gapi.drive && dn.the_file.file_id))\r\n        return;\r\n\r\n    var dummyCallback = function(){}; //TODO: may want to do some error handling or something\r\n    \r\n    if(dn.default_custom_props[prop_name] == new_val){ //note that this is true in particular when SetProperty is called within LoadDefaultProperties\r\n        if(dn.the_file.custom_prop_exists[prop_name]){\r\n             dn.the_file.custom_prop_exists[prop_name] = false;\r\n             gapi.client.drive.properties.delete({ //DELTE the property, which does exist, but is no longer required because the value has been set to the default\r\n                fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC'\r\n                }).execute(dummyCallback);\r\n        }\r\n        //if the property doesn't exist and it's just been set to the default then we don't need to do anything.\r\n    }else{            \r\n        if(dn.the_file.custom_prop_exists[prop_name] && oldVal !== new_val){\r\n            gapi.client.drive.properties.patch({ //PATCH the property, which already exists\r\n            fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC', resource: {'value': new_val}\r\n            }).execute(dummyCallback);\r\n        }else{\r\n            dn.the_file.custom_prop_exists[prop_name] = true; //INSERT the property, because it doesn't yet exist, we may be coming via dn.save_all_file_properties() above\r\n            gapi.client.drive.properties.insert({\r\n            'fileId': dn.the_file.file_id, 'resource': {key: prop_name, value: new_val, visibility: 'PUBLIC'}\r\n            }).execute(dummyCallback)\r\n        }\r\n    }\r\n}\r\n\r\n\r\n// ############################\r\n// Drag-drop stuff\r\n// ############################\r\n//TODO: this may have a few bugs since it's not been tested for a while\r\n\r\ndn.document_drag_over = function (evt) {\r\n    evt = evt.originalEvent;\r\n    evt.stopPropagation();\r\n    evt.preventDefault();\r\n    if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine)){\r\n        evt.dataTransfer.dropEffect = 'none';\r\n        if(dn.can_show_drag_drop_error){\r\n            dn.show_error(\"File drag-drop is only permitted when the Drive Notpad page is displaying a new and unmodified file.\")\r\n            dn.can_show_drag_drop_error = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n            setTimeout(function(){dn.can_show_drag_drop_error = true;},dn.error_delay_ms);\r\n        }\r\n        return;\r\n    }\r\n    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.\r\n}\r\n    \r\ndn.document_drop_file = function(evt){\r\n     if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine))\r\n        return;\r\n        \r\n   evt = evt.originalEvent;\r\n   evt.stopPropagation();\r\n   evt.preventDefault();\r\n   \r\n   var files = evt.dataTransfer.files;\r\n   if(files.length > 1){\r\n       dn.show_error(\"You cannot drag-drop multiple files onto the Drive Notepad page, only individual files.\")\r\n   }\r\n   var file = files[0];\r\n   dn.the_file.title = file.name;\r\n   dn.create_file();\r\n   dn.the_file.isReading_file_object = true;   \r\n   dn.show_status();\r\n   var r = new FileReader();\r\n   r.onload = dn.dropped_file_read;\r\n   r.readAsText(file);      \r\n}\r\n\r\ndn.dropped_file_read = function(e){\r\n    dn.the_file.isReading_file_object = false;\r\n    dn.editor.getSession().setValue(e.target.result);\r\n    // Note we don't encolse the above in a dn.setting_session_value = true block so the change event will fire and set pristine to false and ShowStatus etc.\r\n}\r\n\r\n// ############################\r\n// Page ready stuff\r\n// ############################\r\n\r\ndn.debug_screw_up_auth = function(){\r\n    gapi.auth.setToken(\"\");//this_is_no_longer_valid\");\r\n    return true;\r\n}\r\n\r\ndn.request_user_info = function(){\r\n    // returns thenable\r\n    return gapi.client.request({'path' : 'userinfo/v2/me?fields=name'})\r\n}\r\n\r\ndn.request_file_meta = function(){\r\n    // returns thenable\r\n    dn.status.file_meta = 0;\r\n    dn.show_status();\r\n    return gapi.client.request({\r\n        'path': '/drive/v3/files/' + dn.the_file.file_id,\r\n        'params':{'fields': 'name,mimeType,description,parents,capabilities,fileExtension,shared'}});\r\n}\r\n\r\ndn.request_file_body = function(){\r\n    // returns thenable\r\n    dn.status.file_body = 0;\r\n    dn.show_status();\r\n    return gapi.client.request({\r\n        'path': '/drive/v3/files/' + dn.the_file.file_id,\r\n        'params':{'alt': 'media'}});\r\n}\r\n\r\ndn.request_app_data_document = function(){\r\n    return new Promise(function(succ, fail){\r\n\r\n        // we want one error handler for loading, and one for subsequent errors, but the API doesn't\r\n        // distinguish between the two, so it's up to us to do so....\r\n        dn.app_data_realtime_error = function(err){\r\n            if(dn.status.realtime_settings < 1){\r\n                fail(err);\r\n            }else{\r\n                if(err.type === \"token_refresh_required\"){\r\n                    dn.pr_auth.reject(err);\r\n                } else {\r\n                    console.dir(err);\r\n                    dn.show_error(\"\" + err);\r\n                }\r\n            }\r\n        }\r\n\r\n        gapi.drive.realtime.loadAppDataDocument(succ, null, dn.app_data_realtime_error);\r\n        // the null argument is an omptional function for handling the initialization\r\n        // the first time the document is loaded;\r\n    });\r\n}\r\n\r\ndn.document_ready = function(e){\r\n\r\n    // widget :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.the_widget = document.getElementById('the_widget');\r\n    dn.el.widget_text = document.getElementById('widget_text');\r\n    dn.el.widget_error_text = document.getElementById('widget_error_text');\r\n    dn.el.widget_error = document.getElementById('widget_error');\r\n    dn.el.widget_content = document.getElementById('widget_content');\r\n    dn.el.widget_pending = document.getElementById('widget_pending');\r\n    dn.el.the_widget.addEventListener('mousedown', dn.widget_mouse_down);\r\n    translate(dn.el.the_widget, 0, 0);\r\n    dn.el.the_widget.style.display = '';\r\n    dn.el.widget_error.style.display = 'none';\r\n    dn.el.widget_content.addEventListener('mousedown', function(e){\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    });\r\n    var els = dn.el.widget_content.getElementsByTagName('input');\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].addEventListener('mousedown', stop_propagation); // prevents propagation to preventDefault, installed above.\r\n\r\n    // editor :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    var editor_el = document.getElementById('the_editor');\r\n    editor_el.innerHTML = '';\r\n    editor_el.addEventListener('contextmenu', function(e){\r\n        dn.show_error(\"See the list of keyboard shortcuts for copy/paste, select-all, and undo/redo.\")\r\n    });\r\n    dn.editor = ace.edit(\"the_editor\");\r\n    dn.editor.setHighlightSelectedWord(true);\r\n    dn.el.ace_content = document.getElementsByClassName('ace_content')[0];\r\n    dn.editor.getSession().addEventListener(\"change\", dn.on_change);\r\n    dn.focus_editor = dn.editor.focus.bind(dn.editor);\r\n    dn.focus_editor();\r\n    dn.editor.on(\"paste\", dn.on_paste);\r\n    dn.editor.on(\"copy\", dn.on_copy);\r\n    dn.editor.setAnimatedScroll(true);\r\n    dn.editor.$blockScrolling = Infinity; // disables scrolling message\r\n    \r\n    // widget menu ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.widget_menu = document.getElementById('widget_menu');\r\n    dn.el.menu_open = document.getElementById('menu_open');\r\n    dn.el.menu_find = document.getElementById('menu_find');\r\n    dn.el.menu_help = document.getElementById('menu_help');\r\n    dn.el.menu_file = document.getElementById('menu_file');\r\n    dn.el.menu_general_settings = document.getElementById('menu_general_settings');\r\n    dn.el.widget_menu.addEventListener('mousedown', stop_propagation);\r\n    dn.menu_icon_from_pane_id = {}\r\n    var els = dn.el.widget_menu.getElementsByClassName('widget_menu_icon');\r\n    for(var ii=0; ii<els.length; ii++){\r\n        els[ii].addEventListener(\"mousedown\", prevent_default);\r\n        els[ii].title = dn.menu_id_to_caption[els[ii].id];\r\n        dn.menu_icon_from_pane_id['pane_' + els[ii].id.substr(5)] = els[ii];\r\n    }\r\n\r\n     // pane file ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_file = document.getElementById('pane_file');\r\n    dn.el.details_title_input  = document.getElementById('details_file_title_input');\r\n    dn.el.details_title_text = document.getElementById('details_file_title_text');\r\n    dn.el.details_description_input  = document.getElementById('details_file_description_input');\r\n    dn.el.details_description_text = document.getElementById('details_file_description_text');    \r\n    dn.el.file_ace_mode_choose = document.getElementById('file_ace_mode_choose')\r\n    dn.el.file_ace_mode_detect = document.getElementById('file_ace_mode_detect');\r\n    dn.el.file_ace_mode_info = document.getElementById('file_ace_mode_info');\r\n    dn.el.file_newline_detect = document.getElementById('file_newline_detect');\r\n    dn.el.file_newline_windows = document.getElementById('file_newline_windows');\r\n    dn.el.file_newline_unix = document.getElementById('file_newline_unix');\r\n    dn.el.file_newline_info = document.getElementById('file_newline_info');\r\n    dn.el.file_tab_detect = document.getElementById('file_tab_detect');\r\n    dn.el.file_tab_hard = document.getElementById('file_tab_hard');\r\n    dn.el.file_tab_soft = document.getElementById('file_tab_soft');\r\n    dn.el.file_tab_soft_text = document.getElementById('file_tab_soft_text');\r\n    dn.el.file_tab_info = document.getElementById('file_tab_info');\r\n    dn.el.button_save = document.getElementById('button_save');\r\n    dn.el.button_print = document.getElementById('button_print');\r\n    dn.el.button_share = document.getElementById('button_share');\r\n    dn.el.button_history = document.getElementById('button_history');     \r\n    dn.syntax_drop_down = dn.create_syntax_menu();   // TODO: tidy up\r\n    dn.el.file_ace_mode_choose.appendChild(dn.syntax_drop_down.el);\r\n    dn.create_file_details_tool();\r\n    dn.el.menu_file.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_file');\r\n    })\r\n\r\n     // pane general settings :::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_general_settings = document.getElementById('pane_general_settings');\r\n    dn.el.theme_chooser = document.getElementById('theme_chooser')\r\n    dn.el.widget_sub_general_box = document.getElementById('sub_general_box')\r\n    dn.el.button_clear_clipboard = document.getElementById(\"button_clear_clipboard\");\r\n    dn.el.button_clear_find_replace = document.getElementById(\"button_clear_find_replace\");\r\n    dn.el.gutter_history_show = document.getElementById('gutter_history_show');\r\n    dn.el.gutter_history_hide = document.getElementById('gutter_history_hide');\r\n    dn.el.word_wrap_off = document.getElementById('word_wrap_off');\r\n    dn.el.word_wrap_at = document.getElementById('word_wrap_at');\r\n    dn.el.word_wrap_edge = document.getElementById('word_wrap_edge');\r\n    dn.el.font_size_decrement = document.getElementById('font_size_decrement');\r\n    dn.el.font_size_increment = document.getElementById('font_size_increment');\r\n    dn.el.font_size_text = document.getElementById('font_size_text');\r\n    dn.el.tab_hard = document.getElementById('tab_hard');\r\n    dn.el.tab_soft = document.getElementById('tab_soft');\r\n    dn.el.newline_menu_windows = document.getElementById('newline_menu_windows');\r\n    dn.el.newline_menu_unix = document.getElementById('newline_menu_unix');\r\n    dn.el.tab_soft_text = document.getElementById('tab_soft_text');\r\n    dn.el.tab_soft_dec = document.getElementById('tab_soft_dec');\r\n    dn.el.tab_soft_inc = document.getElementById('tab_soft_inc');\r\n    dn.el.word_wrap_at_text = document.getElementById('word_wrap_at_text');\r\n    dn.el.word_wrap_at_dec = document.getElementById('word_wrap_at_dec');\r\n    dn.el.word_wrap_at_inc = document.getElementById('word_wrap_at_inc');\r\n    dn.theme_drop_down = dn.create_theme_menu()  // TODO: tidy this up\r\n    dn.el.theme_chooser.appendChild(dn.theme_drop_down.el);\r\n    dn.el.newline_menu_windows.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'windows');\r\n    });\r\n    dn.el.newline_menu_unix.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'unix');\r\n    });\r\n    dn.el.tab_hard.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 1)\r\n    });\r\n    dn.el.tab_soft.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 0);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') - 1;\r\n        at = at < dn.min_soft_tab_n ? dn.min_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') + 1;\r\n        at = at > dn.max_soft_tab_n ? dn.max_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.font_size_decrement.addEventListener('click', dn.font_size_decrement_click);\r\n    dn.el.font_size_increment.addEventListener('click', dn.font_size_increment_click);    \r\n    dn.el.word_wrap_off.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[0,0,0])\r\n    });\r\n    dn.el.word_wrap_at.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt');\r\n        dn.g_settings.set('wordWrap',[1,at,at]);\r\n    });\r\n    dn.el.word_wrap_at_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') - dn.wrap_at_increment;\r\n        at = at < dn.min_wrap_at ? dn.min_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_at_inc.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') + dn.wrap_at_increment;\r\n        at = at > dn.max_wrap_at ? dn.max_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_edge.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[1,null,null])\r\n    });\r\n    dn.el.gutter_history_show.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',1);\r\n    });\r\n    dn.el.gutter_history_hide.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',0);\r\n    });\r\n    dn.create_clipboard_tool();\r\n    dn.el.menu_general_settings.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_general_settings');\r\n    })\r\n\r\n    // pane permissions :::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_permissions = document.getElementById('pane_permissions');\r\n    document.getElementById('button_auth').addEventListener('click', dn.reauth_manual);\r\n\r\n    // pane help ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_help = document.getElementById('pane_help');\r\n    dn.el.user_name = document.getElementById('user_name');\r\n    dn.el.pane_help_shortcuts = document.getElementById('pane_help_shortcuts');\r\n    dn.el.pane_help_tips = document.getElementById('pane_help_tips');\r\n    dn.el.pane_help_main = document.getElementById('pane_help_main');\r\n    dn.el.button_shortcuts = document.getElementById('button_view_shortcuts');\r\n    dn.el.button_tips = document.getElementById('button_view_tips');\r\n    dn.el.button_shortcuts.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'shortcuts')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'shortcuts');\r\n    })\r\n    dn.el.button_tips.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'tips')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'tips');\r\n    })\r\n    dn.el.menu_help.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_help');\r\n    })\r\n    dn.create_pane_shortcuts();\r\n\r\n    // pane find ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::    \r\n    dn.el.pane_find = document.getElementById('pane_find');\r\n    dn.el.find_button_case_sensitive = document.getElementById('button_find_case_sensitive');\r\n    dn.el.find_button_whole_words = document.getElementById('button_find_whole_words');\r\n    dn.el.find_button_regex = document.getElementById('button_find_regex');\r\n    dn.el.find_input = document.getElementById('find_input');\r\n    dn.el.find_goto_input = document.getElementById('goto_input');\r\n    dn.el.find_replace_input = document.getElementById('find_replace_input');\r\n    dn.el.find_info = document.getElementById('find_info');\r\n    dn.el.find_results = document.getElementById('find_results');\r\n    dn.el.find_info_overflow = document.getElementById('find_info_overflow');\r\n    dn.el.button_goto = document.getElementById('button_goto');\r\n    dn.el.button_replace = document.getElementById('button_replace');\r\n    dn.el.find_goto_wrapper = document.getElementById('find_goto_wrapper');\r\n    dn.el.find_find_wrapper = document.getElementById('find_find_wrapper');\r\n    dn.el.find_replace_wrapper = document.getElementById('find_replace_wrapper');\r\n    dn.el.button_find_replace_all = document.getElementById('button_find_replace_all');\r\n    dn.el.find_button_case_sensitive.addEventListener('click', function(){\r\n        dn.g_settings.set('find_case_sensitive', !dn.g_settings.get('find_case_sensitive'));\r\n    })\r\n    dn.el.find_button_whole_words.addEventListener('click', function(){\r\n        dn.g_settings.set('find_whole_words', !dn.g_settings.get('find_whole_words'));\r\n    })\r\n    dn.el.find_button_regex.addEventListener('click', function(){\r\n        dn.g_settings.set('find_regex', !dn.g_settings.get('find_regex'));\r\n    })\r\n    dn.el.menu_find.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_find');\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    });\r\n    dn.el.find_goto_input.addEventListener('keydown', dn.find_goto_input_keydown);\r\n    dn.el.find_goto_input.addEventListener('keyup', dn.find_goto_input_keyup);\r\n    dn.el.find_goto_input.addEventListener('blur', dn.find_goto_input_blur);\r\n    dn.el.find_goto_input.addEventListener('focus', dn.find_goto_input_focus);\r\n    dn.el.find_input.addEventListener('keyup', dn.find_input_keyup);\r\n    dn.el.find_input.addEventListener('keydown', dn.find_input_keydown);\r\n    dn.el.find_input.addEventListener('blur', dn.find_inputs_blur);\r\n    dn.el.find_input.addEventListener('focus', dn.find_inputs_focus);\r\n    dn.el.find_replace_input.addEventListener('blur', dn.find_inputs_blur);\r\n    dn.el.find_replace_input.addEventListener('focus', dn.find_inputs_focus);\r\n    dn.el.find_replace_input.addEventListener('keydown', dn.find_replace_input_keydown);\r\n    dn.el.button_find_replace_all.addEventListener('click', dn.find_replace_click);\r\n    dn.el.button_replace.addEventListener('click', function(){\r\n        dn.g_settings.set('find_replace', !dn.g_settings.get('find_replace'));\r\n        dn.g_settings.set('find_goto', false);\r\n        dn.el.find_input.focus();\r\n    })\r\n    dn.el.button_goto.addEventListener('click', function(){\r\n        dn.g_settings.set('find_goto', !dn.g_settings.get('find_goto'));\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    })\r\n\r\n    // pane open ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_open = document.getElementById('pane_open');\r\n    dn.el.opener_button_a = document.getElementById('opener_button_a');\r\n    dn.el.menu_open.addEventListener('click', function(){    \r\n        dn.g_settings.set('pane', 'pane_open');\r\n    });\r\n    dn.el.opener_button_a.addEventListener('click', dn.open_button_click);\r\n\r\n    // :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.make_keyboard_shortcuts();\r\n    dn.load_default_settings();\r\n    dn.load_default_properties();    \r\n    document.addEventListener('contextmenu', prevent_default);\r\n    document.addEventListener('dragover', dn.document_drag_over);\r\n    document.addEventListener('drop', dn.document_drop_file);\r\n    window.addEventListener('resize', dn.widget_apply_anchor);\r\n    window.onbeforeunload = dn.query_unload;\r\n\r\n    //work out what caused the page to load\r\n    var params = window_location_to_params_object(); \r\n    if(params['state']){\r\n        var state = {};\r\n        try{\r\n            state = JSON.parse(params['state']);    \r\n        }catch(e){\r\n            dn.show_error(\"Bad URL params:\\n\" + params['state']);\r\n        }\r\n        if(state.action && state.action == \"open\" && state.ids && state.ids.length > 0){\r\n            dn.the_file.file_id = state.ids[0];\r\n        }else if(state.action && state.action == \"create\"){\r\n            dn.the_file.title = \"untitled.\" + (state.ext ? state.ext : dn.g_settings.get('ext'));\r\n            if(state.folderId)\r\n                dn.the_file.folder_id = state.folderId;\r\n            dn.create_file(); //will use the specified title and folderId\r\n        }\r\n    }else{\r\n        dn.the_file.title = \"untitled.\" + dn.g_settings.get('ext');\r\n        dn.create_file();\r\n    }\r\n\r\n    dn.show_status(); \r\n\r\n    // The auth promise can be rejected and resolved multiple times during the lifetime of the app.\r\n    // These two handlers will always be called for those events.\r\n    dn.pr_auth.on_error(dn.handle_auth_error); \r\n    dn.pr_auth.on_success(function(){\r\n        if(dn.g_settings.get('pane', 'pane_permissions'))\r\n            dn.g_settings.set('pane', 'pane_help');\r\n        dn.status.popup_active = 0;\r\n        dn.status.authentication = 1;\r\n        dn.show_status(); \r\n    })\r\n\r\n    // get user info...\r\n    until_success(function(succ, fail){\r\n        Promise.resolve(dn.pr_auth)\r\n               .then(dn.request_user_info)\r\n               .then(dn.show_user_info)\r\n               .then(succ, fail);\r\n    }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n    .then(function(){\r\n        console.log('succeeded getting user info.')\r\n    })\r\n\r\n    if(dn.the_file.file_id){\r\n\r\n        // meta data...\r\n        var pr_meta = until_success(function(succ, fail){\r\n            Promise.resolve(dn.pr_auth)\r\n                   .then(dn.request_file_meta)\r\n                   .then(dn.show_file_meta)\r\n                   .catch(function(err){\r\n                        if(!err) throw err; // auth error, until_success will handle it, TODO: catch other flavours of auth error\r\n                        // meta-data specific error, which we will rebrand as a \"success\"\r\n                        dn.show_error(err.result.error.message);\r\n                        dn.status.file_meta = -1;\r\n                        dn.show_status();\r\n                        return 'bad_meta'\r\n                   }).then(succ, fail);\r\n        }, dn.pr_auth.reject.bind(dn.pr_auth));\r\n\r\n        // body...\r\n        var pr_body = until_success(function(succ, fail){\r\n            Promise.resolve(dn.pr_auth)\r\n                   /*.then(dn.debug_screw_up_auth)*/\r\n                   .then(dn.request_file_body)\r\n                   .then(dn.show_file_body)\r\n                    .catch(function(err){\r\n                        if(!err) throw err; // auth error, until_success will handle it, TODO: catch other flavours of auth error\r\n                        // body specific error, which we will rebrand as a \"success\"\r\n                        dn.show_error(err.result.error.message);\r\n                        dn.status.file_body = -1;\r\n                        dn.show_status();\r\n                        return 'bad_body'\r\n                   }).then(succ, fail);\r\n        }, dn.pr_auth.reject.bind(dn.pr_auth));\r\n\r\n        // load meta data and body...\r\n        Promise.all([pr_meta, pr_body])\r\n            .then(function(vals){\r\n                if(vals[0] == 'bad_meta' || vals[1] == 'bad_body')\r\n                    throw \"did not load file\"\r\n                return true;\r\n            }).then(function(){\r\n                console.log(\"succeeded loading file body and metadata.\")\r\n            }, function(){\r\n                document.title = \"Drive Notepad\";\r\n                dn.g_settings.set('pane', 'pane_help');\r\n                dn.g_settings.set('pane_open', true);\r\n            });\r\n    }\r\n    \r\n    // load settings...\r\n    until_success(function(succ, fail){ \r\n        Promise.all([dn.pr_auth, dn.pr_realtime_loaded])\r\n               .then(dn.request_app_data_document)\r\n               .then(dn.show_app_data_document)\r\n               .then(succ, fail)\r\n    }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n    .then(function(){\r\n        console.log('succeeded loading settings');\r\n    });\r\n    \r\n    \r\n}\r\n\r\n\r\nif (document.readyState != 'loading')\r\n    dn.document_ready();\r\nelse\r\n    document.addEventListener('DOMContentLoaded', dn.document_ready);\r\n\r\n\r\n    "]}