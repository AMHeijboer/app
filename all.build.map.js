{"version":3,"sources":["node_modules/keymaster/keymaster.js","js/utils.js","js/drop_down.js","js/info.js","js/revisions_main_thread.js","js/find_replace.js","js/keyboard.js","js/app.js"],"names":["global","k","_handlers","_mods",16,18,17,91,"_scope","_MODIFIERS","⇧","shift","⌥","alt","option","⌃","ctrl","control","⌘","command","_MAP","backspace","tab","clear","enter","return","esc","escape","space","left","up","right","down","del","delete","home","end","pageup","pagedown",",",".","/","`","-","=",";","'","[","]","\\","code","x","toUpperCase","charCodeAt","_downKeys","index","array","item","i","length","compareArray","a1","a2","modifierMap","updateModifierKey","event","dispatch","key","handler","modifiersMatch","scope","keyCode","push","assignKey","filter","call","this","getScope","mods","method","preventDefault","returnValue","stopPropagation","cancelBubble","clearModifier","splice","resetModifiers","keys","getKeys","undefined","split","getMods","shortcut","unbindKey","multipleKeys","j","obj","isPressed","getPressedKeyCodes","slice","tagName","target","srcElement","setScope","deleteScope","handlers","replace","mi","addEvent","object","addEventListener","attachEvent","window","document","previousKey","noConflict","unbind","module","exports","oxford_comma","arr","rotate","el","deg","style","transform","webkitTansform","mozTransform","translate","y","str","webkitTransform","text_multi","text","truncate_long_words","textContent","innerHTML","escape_str","css_animation","timers","els","cls","callback","delay","classList","remove","offsetTop","old_idx","indexOf","clearTimeout","setTimeout","add","stop_propagation","e","prevent_default","DropDown","val_array","map","val","join","el_list","createElement","className","tabindex","display","el_collapsed","appendChild","ind","event_callbacks","open","dd","trigger","parentNode","focus","scrollTop","children","on_click","SetInd","getAttribute","ii","setAttribute","FakeEvent","is_stopped","prototype","stopImmediatePropagation","evt","func","args","fe","IndexOf","GetVal","no_trigger","parseInt","isOpen","SetSelected","v","dn","menu_id_to_caption","menu_print","menu_sharing","menu_save","menu_history","menu_file","menu_new","menu_open","menu_find","menu_goto","menu_general_settings","menu_shortcuts","menu_drive","menu_help","shortcuts_list","ext_to_mime_type","html","htm","js","pl","xml","c","cpp","h","json","php","svg","css","java","py","scala","textile","tex","bib","rtf","rtx","sh","sql","as","tooltip_info","save","print","sharing","file history","drive","about","shortcuts","new","settings_file","settings_general","title","description","WHICH","ENTER","ESC","UP","DOWN","default_settings","ext","wordWrap","wordWrapAt","fontSize","widget_anchor","showGutterHistory","lastDNVersionUsed","newLineDefault","historyRemovedIsExpanded","softTabN","tabIsHard","widgetSub","theme","pane","pane_open","find_regex","find_whole_words","find_case_sensitive","help_inner","find_goto","find_replace","default_custom_props","newline","tabs","aceMode","impersonal_settings_keys","drag_delay_ms","drag_shift_px","min_font_size","max_font_size","max_wrap_at","min_wrap_at","wrap_at_increment","max_soft_tab_n","min_soft_tab_n","detect_tabs_spaces_frac","detect_tabs_tabs_frac","detect_tabs_n_spaces_frac","detect_tabs_n_spaces_frac_for_default","font_size_increment","icon_mouse_over_ms","editor_refocus_time_ms","error_delay_ms","find_history_add_delay","clipboard_info_delay","clipboard_max_length","find_max_results_half","find_max_prefix_chars","find_max_suffix_chars","close_history","file_history","$revisions_display","removeEventListener","revisions_window_resize","getElementById","editor","resize","is_showing_history","canShowResizeError","show_error","start_revisions_worker","the_file","is_brand_new","widget_content","widget_file_history","getElementsByClassName","$","$view","$new_li","$new_tick","needToRefindViewChildren","$rev_lines_","needToFixHeights","$timeline","$d","find","$revisions_status","$revision_caption_from","$revision_caption_at","$expand_removed","$collapse_removed","revisions","revisionFromEtag","at","from","worker","Worker","g_settings","set","revision_setis_expaned","get","w","onmessage","revision_worker_delivery","postMessage","fileId","file_id","token","gapi","auth","getToken","access_token","init","appendTo","on","empty","revision_set_at","r","fromChangeEvent","fromTimelineCreation","$at_range","value","modifiedDate","toLocaleDateString","month","day","year","toLocaleTimeString","hour","minute","showEtag","etag","fromEtag","revision_set_from","$from_range","display_revision_timeline","newRevisions","rs","$tick_box","attr","t","downloaded","isDownloaded","Array","apply","$ticks","insertClonedChildren","eq","append","data","debug","console","log","status","forEach","revisionDownloaded","revsionDiffed","isDiffed","newStuff","newStuffForDom","lines","vals_ui8buffer","$rl_","fixHeightFromAuto","vals","Uint8Array","digits","find_goto_changed","new_value","find_goto_wrapper","find_find_wrapper","button_goto","find_info","find_replace_wrapper","find_replace_changed","button_replace","find_inputs_have_focus","find_select_result_idx","find_current_match_idx","find_goto_input_has_focus","find_goto_input_focus","find_perform_goto","find_goto_input_blur","relatedTarget","focus_editor","validated_str","find_goto_input","num","gotoLine","navigateLineEnd","find_goto_input_keyup","find_goto_input_keydown","which","find_results","find_markers","find_marker_current","find_str","find_inputs_focus","currentTarget","find_input","tabIndex","find_replace_input","AceSearch","ace","require","Search","AceRange","Range","setHighlightSelectedWord","find_perform_search","find_inputs_blur","session","getSession","removeMarker","find_info_overflow","setSelectionRange","selectionEnd","find_build_options","use_reg_exp","sensitive","re","RegExp","needle","wrap","caseSensitive","wholeWord","regExp","search_options","message","selection","clearSelection","search","setOptions","results","findAll","selected_range","getSelection","getRange","row","start","column","current_match_idx","addMarker","range","idx","results_sub","replace_is_showing","max_results","n_pre","n_post","concat","show_replace_buttons","col","prefix_range","Math","max","pre_ellipses","suffix_range","getTextRange","find_result_click","find_replace_result_click","renderer","scrollSelectionIntoView","find_settings_changed","find_replace_result_idx","find_input_keyup","find_input_keydown","shiftKey","ctrlKey","find_replace_input_keydown","find_replace_all","options","replaceAll","find_replace_click","$search","$tryReplace","platform","navigator","create_pane_shortcuts","arry","dict","parts","action","pane_help_shortcuts","esc_pressed","find_shortcut_used","sel","getSelectionRange","select","find_goto_shortcut_used","show_replace_shortcut_used","make_keyboard_shortcuts","commands","removeCommands","save_content","do_print","do_open","do_new","HashHandler","extraKeyEvents","bindKey","win","mac","descr","exec","document_clipboard_left","document_clipboard_right","keyBinding","addKeyboardHandler","ctrl_key","version_str","can_show_drag_drop_error","file_body","file_meta","file_sharing","authentication","popup_active","local_settings","folder_id","loaded_mime_type","new_line_detected","tab_detected","is_pristine","mime_type","is_saving","data_to_save","body","generation_to_save","is_read_only","is_shared","is_reading_file_object","custom_props","custom_prop_exists","saving_title_count","change_line_history","last_change","change_line_classes","rootStr","trueN","factor","change_line_classes_rm","authentication_done","auth_result","authentication_failed","error","show_status","user_info","get_user_info","load_file","get_properties_from_cloud","load","get_settings_from_cloud","share_dialog","share","ShareClient","client_id","Promise","resolve","client","request","path","then","a","result","user_name","name","err","dir","authorization","show_pane_permissions","reauth","authorize","auth_map","launch_popup","the_widget","do_share","setItemIds","showSettingsDialog","detect_new_line","first_n","show_newline_status","has_rn","has_solo_n","match","apply_newline_choice","newlineDefault","newline_menu_windows","newline_menu_unix","file_newline_detect","file_newline_windows","file_newline_unix","setNewLineMode","statusStr","file_newline_info","open_picker","view","google","picker","View","ViewId","DOCS","PickerBuilder","enableFeature","Feature","NAV_HIDDEN","setAppId","setOAuthToken","addView","setCallback","picker_callback","build","setVisible","Action","PICKED","docs","id","opener_button_a","url","opener_button_b","opener_chooser","show_help_inner","inner_pane","pane_help_tips","pane_help_main","button_shortcuts","button_tips","show_pane","el_icon","menu_icon_from_pane_id","widget_mouse_down","widget_mouse_down_info","off_left","clientX","off_top","clientY","start_time","Date","now","is_dragging","button","document_mouse_move_widget","document_mouse_up_widget","pos","getBoundingClientRect","widget_w","offsetWidth","widget_h","offsetHeight","window_w","innerWidth","window_h","innerHeight","anchor","top","widget_apply_anchor","isArray","widget_menu","bottom","toggle_widget","state","s","extra","widget_text","widget_error_text","widget_error","set_drive_link_to_folder","href","realtime","loadAppDataDocument","doc","old_temp_g_settings","getModel","getRoot","g_clipboard","createList","g_find_history","existingKeys","EventType","VALUE_CHANGED","settings_changed","getKeeps","JSON","stringify","property","newValue","resp","arguments","type","load_default_settings","ob","keeps","keep","localStorage","parse","setTheme","theme_drop_down","scrollLine","get_scroll_line","font_size_text","toFixed","setFontSize","scrollToLine","setUseWrapMode","setWrapLimitRange","word_wrap_off","word_wrap_edge","word_wrap_at","word_wrap_at_text","curWrap","setPrintMarginColumn","gutter_history_show","gutter_history_hide","removeGutterDecoration","apply_tab_choice","find_button_regex","find_button_whole_words","find_button_case_sensitive","font_size_decrement_click","font_size","font_size_increment_click","detect_tab","getLines","indents","show_tab_status","stats","reduce","nWithMixture","nWithOnlyTabs","spaceHist","nSamp","nWithOnlySpaces","spaceModHist","m","defaultNSpaces","n","isDefault","threshold","d","defaultStr","file_tab_info","defaultTabIsHard","defaultSoftTabN","isHard","nSpaces","isDetected","setUseSoftTabs","setTabSize","tab_soft_text","tab_hard","tab_soft","file_tab_detect","file_tab_hard","file_tab_soft","file_tab_soft_text","set_file_tabs_to_soft_or_hard","delta","f","current","newT","set_property","show_syntax_status","syntax","file_ace_mode_info","detect_syntax","syntax_detected","mode","getModeForPath","caption","apply_syntax_choice","set_syntax","file_ace_mode_detect","syntax_drop_down","get_current_syntax_name","modesArray","modesByName","getMode","$id","pop","modes","setMode","create_theme_menu","themes","Object","themesByName","create_syntax_menu","read_only_bail","create_file_details_tool","details_title_text","details_description_text","details_title_input","new_val","show_file_title","save_file_title","ignore_escape","button_save","button_print","button_share","button_history","details_description_input","show_description","save_file_description","save_new_file","save_file","proxy","save_done","getValue","ace_content","do_save","gens","meta","failures","removeAttribute","fileExtension","saved_new_file","fileMetadata","fileText","boundary","make_boundary","delimiter","close_delim","messageBody","btoa","unescape","encodeURIComponent","params","uploadType","headers","Content-Type","execute","getTime","random","content","getAllLines","line_tohtml","printWindow","writeln","cssText","printLayer","create","Text","tokens","getTokens","screenColumn","$renderToken","clipboard_active","clipboard_index","undo","insert","document_clipboard_keyup","off","pane_clipboard","clipboard_info_timer","on_paste","lastIndexOf","on_copy","create_clipboard_tool","button_clear_clipboard","button_clear_find_replace","base","location","folderId","create_new_tool","create_file","guess_mime_type","plain","substr","mimeType","parentId","parentNodes","shared","history","replaceState","save_all_file_properties","save_scroll_line","patch_property","screenToDocumentPosition","getScrollTopRow","flag","promise_get_meta","fields","load_file_got_meta_data","promise_get_body","load_file_got_file_body","pr_the_file","all","Error","capabilities","canEdit","parents","setting_session_value","setValue","on_change","nClasses","start_row","end_row","addGutterDecoration","newLineCount","query_unload","property_updated","propKey","load_default_properties","got_all_file_properties","items","prop_name","oldVal","dummyCallback","properties","propertyKey","visibility","patch","resource","document_drag_over","originalEvent","dataTransfer","dropEffect","document_drop_file","files","file","isReading_file_object","FileReader","onload","dropped_file_read","readAsText","document_ready","getElementsByTagName","editor_el","edit","setAnimatedScroll","$blockScrolling","Infinity","pane_file","file_ace_mode_choose","pane_general_settings","theme_chooser","widget_sub_general_box","font_size_decrement","tab_soft_dec","tab_soft_inc","word_wrap_at_dec","word_wrap_at_inc","pane_permissions","pane_help","pane_find","button_find_replace_all","find_goto_focus","find_goto_blur","onbeforeunload","window_location_to_params_object","ids","pr_auth","readyState"],"mappings":"CAIC,SAAUA,QACT,GAAIC,GACFC,aACAC,OAAUC,GAAI,MAAOC,GAAI,MAAOC,GAAI,MAAOC,GAAI,OAC/CC,OAAS,MAETC,YACEC,IAAK,GAAIC,MAAO,GAChBC,IAAK,GAAIC,IAAK,GAAIC,OAAQ,GAC1BC,IAAK,GAAIC,KAAM,GAAIC,QAAS,GAC5BC,IAAK,GAAIC,QAAS,IAGpBC,MACEC,UAAW,EAAGC,IAAK,EAAGC,MAAO,GAC7BC,MAAO,GAAIC,SAAU,GACrBC,IAAK,GAAIC,OAAQ,GAAIC,MAAO,GAC5BC,KAAM,GAAIC,GAAI,GACdC,MAAO,GAAIC,KAAM,GACjBC,IAAK,GAAIC,SAAU,GACnBC,KAAM,GAAIC,IAAK,GACfC,OAAQ,GAAIC,SAAU,GACtBC,IAAK,IAAKC,IAAK,IAAKC,IAAK,IACzBC,IAAK,IAAKC,IAAK,IAAKC,IAAK,IACzBC,IAAK,IAAKC,IAAM,IAChBC,IAAK,IAAKC,IAAK,IAAKC,KAAM,KAE5BC,KAAO,SAASC,GACd,MAAO/B,MAAK+B,IAAMA,EAAEC,cAAcC,WAAW,IAE/CC,YAEF,KAAIrD,EAAE,EAAEA,EAAE,GAAGA,IAAKmB,KAAK,IAAInB,GAAK,IAAIA,CAGpC,SAASsD,OAAMC,MAAOC,MACpB,GAAIC,GAAIF,MAAMG,MACd,OAAMD,IAAK,GAAGF,MAAME,KAAKD,KAAM,MAAOC,EACtC,QAAQ,EAIV,QAASE,cAAaC,GAAIC,IACxB,GAAID,GAAGF,QAAUG,GAAGH,OAAQ,MAAO,MACnC,KAAK,GAAID,GAAI,EAAGA,EAAIG,GAAGF,OAAQD,IAAK,CAChC,GAAIG,GAAGH,KAAOI,GAAGJ,GAAI,MAAO,OAEhC,MAAO,MAGT,GAAIK,cACA3D,GAAG,WACHC,GAAG,SACHC,GAAG,UACHC,GAAG,UAEP,SAASyD,mBAAkBC,OACvB,IAAIhE,IAAKE,OAAOA,MAAMF,GAAKgE,MAAMF,YAAY9D,IAIjD,QAASiE,UAASD,OAChB,GAAIE,KAAKC,QAASnE,EAAGyD,EAAGW,eAAgBC,KACxCH,KAAMF,MAAMM,OAEZ,IAAIhB,MAAMD,UAAWa,OAAS,EAAG,CAC7Bb,UAAUkB,KAAKL,KAInB,GAAGA,KAAO,IAAMA,KAAO,IAAKA,IAAM,EAClC,IAAGA,MAAOhE,OAAO,CACfA,MAAMgE,KAAO,IAEb,KAAIlE,IAAKQ,YAAY,GAAGA,WAAWR,IAAMkE,IAAKM,UAAUxE,GAAK,IAC7D,QAEF+D,kBAAkBC,MAIlB,KAAIQ,UAAUC,OAAOC,KAAKC,KAAMX,OAAQ,MAGxC,MAAME,MAAOjE,YAAY,MAEzBoE,OAAQO,UAGR,KAAKnB,EAAI,EAAGA,EAAIxD,UAAUiE,KAAKR,OAAQD,IAAK,CAC1CU,QAAUlE,UAAUiE,KAAKT,EAGzB,IAAGU,QAAQE,OAASA,OAASF,QAAQE,OAAS,MAAM,CAElDD,eAAiBD,QAAQU,KAAKnB,OAAS,CACvC,KAAI1D,IAAKE,OACP,IAAKA,MAAMF,IAAMsD,MAAMa,QAAQU,MAAO7E,IAAM,GACzCE,MAAMF,IAAMsD,MAAMa,QAAQU,MAAO7E,KAAO,EAAIoE,eAAiB,KAElE,IAAID,QAAQU,KAAKnB,QAAU,IAAMxD,MAAM,MAAQA,MAAM,MAAQA,MAAM,MAAQA,MAAM,KAAQkE,eAAe,CACtG,GAAGD,QAAQW,OAAOd,MAAOG,WAAW,MAAM,CACxC,GAAGH,MAAMe,eAAgBf,MAAMe,qBACxBf,OAAMgB,YAAc,KAC3B,IAAGhB,MAAMiB,gBAAiBjB,MAAMiB,iBAChC,IAAGjB,MAAMkB,aAAclB,MAAMkB,aAAe,SAQtD,QAASC,eAAcnB,OACrB,GAAIE,KAAMF,MAAMM,QAAStE,EACrByD,EAAIH,MAAMD,UAAWa,IAGzB,IAAIT,GAAK,EAAG,CACRJ,UAAU+B,OAAO3B,EAAG,GAGxB,GAAGS,KAAO,IAAMA,KAAO,IAAKA,IAAM,EAClC,IAAGA,MAAOhE,OAAO,CACfA,MAAMgE,KAAO,KACb,KAAIlE,IAAKQ,YAAY,GAAGA,WAAWR,IAAMkE,IAAKM,UAAUxE,GAAK,OAIjE,QAASqF,kBACP,IAAIrF,IAAKE,OAAOA,MAAMF,GAAK,KAC3B,KAAIA,IAAKQ,YAAYgE,UAAUxE,GAAK,MAItC,QAASwE,WAAUN,IAAKG,MAAOS,QAC7B,GAAIQ,MAAMT,IACVS,MAAOC,QAAQrB,IACf,IAAIY,SAAWU,UAAW,CACxBV,OAAST,KACTA,OAAQ,MAIV,IAAK,GAAIZ,GAAI,EAAGA,EAAI6B,KAAK5B,OAAQD,IAAK,CAEpCoB,OACAX,KAAMoB,KAAK7B,GAAGgC,MAAM,IACpB,IAAIvB,IAAIR,OAAS,EAAE,CACjBmB,KAAOa,QAAQxB,IACfA,MAAOA,IAAIA,IAAIR,OAAO,IAGxBQ,IAAMA,IAAI,EACVA,KAAMjB,KAAKiB,IAEX,MAAMA,MAAOjE,YAAYA,UAAUiE,OACnCjE,WAAUiE,KAAKK,MAAOoB,SAAUL,KAAK7B,GAAIY,MAAOA,MAAOS,OAAQA,OAAQZ,IAAKoB,KAAK7B,GAAIoB,KAAMA,QAK/F,QAASe,WAAU1B,IAAKG,OACtB,GAAIwB,cAAcP,KAChBT,QACApB,EAAGqC,EAAGC,GAERF,cAAeN,QAAQrB,IAEvB,KAAK4B,EAAI,EAAGA,EAAID,aAAanC,OAAQoC,IAAK,CACxCR,KAAOO,aAAaC,GAAGL,MAAM,IAE7B,IAAIH,KAAK5B,OAAS,EAAG,CACnBmB,KAAOa,QAAQJ,KACfpB,KAAMoB,KAAKA,KAAK5B,OAAS,GAG3BQ,IAAMjB,KAAKiB,IAEX,IAAIG,QAAUmB,UAAW,CACvBnB,MAAQO,WAEV,IAAK3E,UAAUiE,KAAM,CACnB,OAEF,IAAKT,EAAI,EAAGA,EAAIxD,UAAUiE,KAAKR,OAAQD,IAAK,CAC1CsC,IAAM9F,UAAUiE,KAAKT,EAErB,IAAIsC,IAAI1B,QAAUA,OAASV,aAAaoC,IAAIlB,KAAMA,MAAO,CACvD5E,UAAUiE,KAAKT,SAQvB,QAASuC,WAAU1B,SACf,SAAU,UAAW,SAAU,CAC7BA,QAAUrB,KAAKqB,SAEjB,MAAOhB,OAAMD,UAAWiB,WAAa,EAGzC,QAAS2B,sBACL,MAAO5C,WAAU6C,MAAM,GAG3B,QAASzB,QAAOT,OACd,GAAImC,UAAWnC,MAAMoC,QAAUpC,MAAMqC,YAAYF,OAEjD,SAASA,SAAW,SAAWA,SAAW,UAAYA,SAAW,YAInE,IAAInG,IAAKQ,YAAYgE,UAAUxE,GAAK,KAGpC,SAASsG,UAASjC,OAAQ9D,OAAS8D,OAAS,MAC5C,QAASO,YAAY,MAAOrE,SAAU,MAGtC,QAASgG,aAAYlC,OACnB,GAAIH,KAAKsC,SAAU/C,CAEnB,KAAKS,MAAOjE,WAAW,CACrBuG,SAAWvG,UAAUiE,IACrB,KAAKT,EAAI,EAAGA,EAAI+C,SAAS9C,QAAU,CACjC,GAAI8C,SAAS/C,GAAGY,QAAUA,MAAOmC,SAASpB,OAAO3B,EAAG,OAC/CA,OAMX,QAAS8B,SAAQrB,KACf,GAAIoB,KACJpB,KAAMA,IAAIuC,QAAQ,MAAO,GACzBnB,MAAOpB,IAAIuB,MAAM,IACjB,IAAKH,KAAKA,KAAK5B,OAAS,IAAO,GAAI,CACjC4B,KAAKA,KAAK5B,OAAS,IAAM,IAE3B,MAAO4B,MAIT,QAASI,SAAQxB,KACf,GAAIW,MAAOX,IAAIgC,MAAM,EAAGhC,IAAIR,OAAS,EACrC,KAAK,GAAIgD,IAAK,EAAGA,GAAK7B,KAAKnB,OAAQgD,KACnC7B,KAAK6B,IAAMlG,WAAWqE,KAAK6B,IAC3B,OAAO7B,MAIT,QAAS8B,UAASC,OAAQ5C,MAAOc,QAC/B,GAAI8B,OAAOC,iBACTD,OAAOC,iBAAiB7C,MAAOc,OAAQ,WACpC,IAAG8B,OAAOE,YACbF,OAAOE,YAAY,KAAK9C,MAAO,WAAYc,OAAOiC,OAAO/C,SAI7D2C,SAASK,SAAU,UAAW,SAAShD,OAASC,SAASD,QACzD2C,UAASK,SAAU,QAAS7B,cAG5BwB,UAASI,OAAQ,QAAS1B,eAG1B,IAAI4B,aAAclH,OAAOmE,GAGzB,SAASgD,cACP,GAAIlH,GAAID,OAAOmE,GACfnE,QAAOmE,IAAM+C,WACb,OAAOjH,GAITD,OAAOmE,IAAMM,SACbzE,QAAOmE,IAAIoC,SAAWA,QACtBvG,QAAOmE,IAAIU,SAAWA,QACtB7E,QAAOmE,IAAIqC,YAAcA,WACzBxG,QAAOmE,IAAIO,OAASA,MACpB1E,QAAOmE,IAAI8B,UAAYA,SACvBjG,QAAOmE,IAAI+B,mBAAqBA,kBAChClG,QAAOmE,IAAIgD,WAAaA,UACxBnH,QAAOmE,IAAIiD,OAASvB,SAEpB,UAAUwB,UAAW,YAAaA,OAAOC,QAAU7C,YAElDG,KCvSH,aAEA,IAAI2C,cAAe,SAASC,KACxB,OAAQA,IAAI7D,QACR,IAAK,GACD,MAAO6D,KAAI,EACf,KAAK,GACD,MAAOA,KAAI,GAAK,QAAUA,IAAI,EAClC,KAAK,GACD,MAAOA,KAAI,GAAK,KAAOA,IAAI,GAAK,SAAWA,IAAI,IAI3D,IAAIC,QAAS,SAASC,GAAIC,KACtBD,GAAGE,MAAMC,UAAY,UAAYF,IAAM,MACvCD,IAAGE,MAAME,eAAiB,UAAYH,IAAM,MAC5CD,IAAGE,MAAMG,aAAe,UAAYJ,IAAM,OAG9C,IAAIK,WAAY,SAASN,GAAIvE,EAAG8E,GAC5B,GAAIC,KAAM/E,GAAG,KAAO,GAAK,aAAeA,EAAI,MAAQ8E,EAAI,KACxDP,IAAGE,MAAMC,UAAYK,GACrBR,IAAGE,MAAMO,gBAAkBD,GAC3BR,IAAGE,MAAMG,aAAeG,IAG5B,IAAIE,YAAa,SAASV,GAAIW,KAAMC,qBAChC,GAAGA,oBAAoB,CACnBD,KAAOA,KAAK3B,QAAQ,eAAe,SAEvCgB,GAAGa,YAAcF,IACjBX,IAAGc,UAAYd,GAAGc,UAAU9B,QAAQ,MAAM,SAASA,QAAQ,MAAM,uBAGrE,IAAI+B,YAAa,SAASP,KAEtB,MAAOA,KAAIxB,QAAQ,uBAAwB,SAAShD,GAChD,MAAO,KAAOA,EAAEL,WAAW,GAAK,MAIxC,IAAIqF,eAAgB,WAChB,GAAIC,UACJ,IAAIC,OAEJ,OAAO,UAASlB,GAAImB,IAAKC,SAAUC,OAC/BrB,GAAGsB,UAAUC,OAAOJ,IACpBnB,IAAGwB,SACH,IAAIC,SAAUP,IAAIQ,QAAQ1B,GAC1B,IAAGyB,UAAY,EAAE,CACbE,aAAaV,OAAOQ,SACpBR,QAAOtD,OAAO8D,QAAS,EACvBP,KAAIvD,OAAO8D,QAAS,GAExBP,IAAIpE,KAAKkD,GACTiB,QAAOnE,KAAK8E,WAAWR,SAAUC,OACjCrB,IAAGsB,UAAUO,IAAIV,QAIzB,IAAIW,kBAAmB,SAASC,GAC5BA,EAAEvE,kBAGN,IAAIwE,iBAAkB,SAASD,GAC3BA,EAAEzE,iBCjEN,aAEA,IAAI2E,UAAW,SAASC,WAGpB,GAAI1B,KAAM0B,UAAUC,IAAI,SAASC,KACjB,MAAO,8BAAgCA,IAAM,WAC7CC,KAAK,GAErBnF,MAAKgF,UAAYA,UAAUzD,MAAM,EACjCvB,MAAKoF,QAAU/C,SAASgD,cAAc,MACtCrF,MAAKoF,QAAQE,UAAW,oBACxBtF,MAAKoF,QAAQG,UAAW,CACxBvF,MAAKoF,QAAQpC,MAAMwC,QAAU,MAC7BxF,MAAKoF,QAAQxB,UAAYN,GAEzBtD,MAAKyF,aAAepD,SAASgD,cAAc,MAC3CrF,MAAKyF,aAAaH,UAAY,oBAE9BtF,MAAK8C,GAAKT,SAASgD,cAAc,MACjCrF,MAAK8C,GAAGwC,UAAY,UACpBtF,MAAK8C,GAAG4C,YAAY1F,KAAKoF,QACzBpF,MAAK8C,GAAG4C,YAAY1F,KAAKyF,aACzBzF,MAAK2F,IAAM,CACX3F,MAAKyF,aAAa9B,YAAcqB,UAAU,EAC1ChF,MAAK4F,kBACL5F,MAAK6F,KAAO,KAEZ,IAAIC,IAAK9F,IAETA,MAAKyF,aAAavD,iBAAiB,YAAY,WAC3C,IAAI4D,GAAGC,QAAQ,SACX,MACJD,IAAGhD,GAAGkD,WAAW5B,UAAUO,IAAI,WAC/BmB,IAAGV,QAAQpC,MAAMwC,QAAU,EAC3BxF,MAAK6F,KAAO,IACZnB,YAAW,WACPoB,GAAGV,QAAQa,OACXH,IAAGV,QAAQc,UAAYJ,GAAGV,QAAQe,SAASL,GAAGH,KAAKrB,WACrD,IAENtE,MAAKoF,QAAQlD,iBAAiB,OAAO,SAAS2C,GAC1CiB,GAAGV,QAAQpC,MAAMwC,QAAU,MAC3BM,IAAGD,KAAO,KACVC,IAAGC,QAAQ,SAEf,IAAIK,UAAW,SAASvB,GAChBiB,GAAGO,OAAOrG,KAAKsG,aAAa,YAC5BR,IAAGV,QAAQpC,MAAMwC,QAAU,MAC3BM,IAAGD,KAAO,MAElB,KAAI,GAAIU,IAAG,EAAGA,GAAGvG,KAAKoF,QAAQe,SAASpH,OAAQwH,KAAK,CAChDvG,KAAKoF,QAAQe,SAASI,IAAIC,aAAa,WAAYD,GACnDvG,MAAKoF,QAAQe,SAASI,IAAIrE,iBAAiB,QAASkE,UAGxD,MAAOpG,MAGX+E,UAAS0B,UAAY,WACjBzG,KAAK0G,WAAa,MAEtB3B,UAAS0B,UAAUE,UAAUC,yBAA2B,WACpD5G,KAAK0G,WAAa,KAGtB3B,UAAS4B,UAAUzE,iBAAmB,SAAS2E,IAAKC,MAChD,KAAKD,MAAO7G,MAAK4F,iBACb5F,KAAK4F,gBAAgBiB,OACzB7G,MAAK4F,gBAAgBiB,KAAKjH,KAAKkH,MAGnC/B,UAAS4B,UAAUZ,QAAU,SAASc,IAAKE,MACvC,GAAIC,IAAK,GAAIjC,UAAS0B,SACtB,IAAGI,MAAO7G,MAAK4F,gBAAgB,CAC3B,IAAI,GAAIW,IAAK,EAAGA,GAAGvG,KAAK4F,gBAAgBiB,KAAK9H,OAAQwH,KACjDvG,KAAK4F,gBAAgBiB,KAAKN,IAAIxG,KAAKC,KAAMgH,GAC7C,IAAGA,GAAGN,WACF,MAAO,OAEf,MAAO,MAEX3B,UAAS4B,UAAUM,QAAU,SAAS/B,KAClC,MAAOlF,MAAKgF,UAAUR,QAAQU,KAGlCH,UAAS4B,UAAUO,OAAS,WACxB,MAAOlH,MAAKgF,UAAUhF,KAAK2F,KAG/BZ,UAAS4B,UAAUN,OAAS,SAASV,IAAIwB,YACrCxB,IAAMyB,SAASzB,IACf,IAAGA,MAAQ3F,KAAK2F,IACZ,MACJ3F,MAAKoF,QAAQe,SAASnG,KAAK2F,KAAKvB,UAAUC,OAAO,WACjDrE,MAAKyF,aAAa9B,YAAc3D,KAAKgF,UAAUW,IAC/C3F,MAAK2F,IAAMA,GACX3F,MAAKoF,QAAQe,SAASR,KAAKvB,UAAUO,IAAI,WACzC,KAAIwC,WACAnH,KAAK+F,QAAQ,UAAUJ,IAAIA,IAAIrC,IAAItD,KAAKgF,UAAUW,KAAK0B,OAAQrH,KAAK6F,OAG5Ed,UAAS4B,UAAUW,YAAc,SAASC,GACtC,GAAGA,EACCvH,KAAK8C,GAAGkD,WAAW5B,UAAUO,IAAI,gBAEjC3E,MAAK8C,GAAGkD,WAAW5B,UAAUC,OAAO,YC1G5C,aAEAmD,IAAGC,oBACHC,WAAc,QACdC,aAAgB,UAChBC,UAAa,OACbC,aAAgB,UAChBC,UAAa,eACbC,SAAY,MACZC,UAAa,WACbC,UAAa,eACbC,UAAa,YACbC,sBAAyB,mBACzBC,eAAkB,YAClBC,WAAc,QACdC,UAAa,aAGbd,IAAGe,gBACH,mBACA,oBACA,yBACA,yFACA,8BACA,oBACA,iBACA,0BACA,wBACA,qDACA,MACA,oBACA,wBACA,+BACA,gCACA,mBACA,oBACA,OACA,uBACA,4BACA,yKACA,oDACA,8CACA,2BACA,0BACA,wCACA,wDACA,wDACA,0DACA,kDACA,qCACA,wDACA,wCACA,2CACA,aACA,oBACA,mBACA,+BACA,6BACA,wCACA,qDACA,gCACA,qBACA,kCACA,2BAGAf,IAAGgB,kBACHC,KAAK,YACLC,IAAI,YACJC,GAAG,kBACHC,GAAG,qBACHC,IAAI,WACJC,EAAE,cACFC,IAAI,gBACJC,EAAE,cACFC,KAAK,mBACLC,IAAI,oBACJC,IAAI,YACJC,IAAI,WACJC,KAAK,cACLC,GAAG,gBACHC,MAAM,QACNC,QAAQ,UACRC,IAAI,oBACJC,IAAI,oBACJC,IAAI,kBACJC,IAAI,kBACJC,GAAG,mBACHC,IAAI,aACJC,GAAG,sBAIHvC,IAAGwC,cACCC,KAAS,wBACTC,MAAS,kCACTC,QAAW,yCACXC,eAAgB,8BAChBC,MAAS,oCACTC,MAAS,yBACTC,UAAa,sBACbC,MAAO,kCACP3E,KAAQ,yBACR4E,cAAiB,kCACjBC,iBAAoB,0CACpBC,MAAS,kCACTC,YAAe,wCAInB,IAAIC,QACJC,MAAO,GACPC,IAAK,GACLC,GAAI,GACJC,KAAM,GAGNzD,IAAG0D,kBACHC,IAAK,MACLC,UAAW,KAAK,KAAK,MACrBC,WAAY,GACZC,SAAU,EACVC,eAAgB,IAAI,GAAG,IAAI,IAC3BC,kBAAmB,EACnBC,kBAAmB,GACnBC,eAAgB,UAChBC,yBAA0B,KAC1BC,SAAU,EACVC,UAAW,EACXC,UAAW,UACXC,MAAO,SACPC,KAAM,GACNC,UAAW,KACXC,WAAY,MACZC,iBAAkB,MAClBC,oBAAqB,MACrBC,WAAY,OACZC,UAAW,MACXC,aAAc,MAGd/E,IAAGgF,sBACHC,QAAS,SACTC,KAAM,SACNC,QAAS,SAGTnF,IAAGoF,0BACH,WACA,aACA,WACA,gBACA,oBACA,2BACA,YACA,WACA,YACA,QACA,OACA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","file":"all.build.js","sourcesContent":["//     keymaster.js\n//     (c) 2011-2013 Thomas Fuchs\n//     keymaster.js may be freely distributed under the MIT license.\n\n;(function(global){\n  var k,\n    _handlers = {},\n    _mods = { 16: false, 18: false, 17: false, 91: false },\n    _scope = 'all',\n    // modifier keys\n    _MODIFIERS = {\n      '⇧': 16, shift: 16,\n      '⌥': 18, alt: 18, option: 18,\n      '⌃': 17, ctrl: 17, control: 17,\n      '⌘': 91, command: 91\n    },\n    // special keys\n    _MAP = {\n      backspace: 8, tab: 9, clear: 12,\n      enter: 13, 'return': 13,\n      esc: 27, escape: 27, space: 32,\n      left: 37, up: 38,\n      right: 39, down: 40,\n      del: 46, 'delete': 46,\n      home: 36, end: 35,\n      pageup: 33, pagedown: 34,\n      ',': 188, '.': 190, '/': 191,\n      '`': 192, '-': 189, '=': 187,\n      ';': 186, '\\'': 222,\n      '[': 219, ']': 221, '\\\\': 220\n    },\n    code = function(x){\n      return _MAP[x] || x.toUpperCase().charCodeAt(0);\n    },\n    _downKeys = [];\n\n  for(k=1;k<20;k++) _MAP['f'+k] = 111+k;\n\n  // IE doesn't support Array#indexOf, so have a simple replacement\n  function index(array, item){\n    var i = array.length;\n    while(i--) if(array[i]===item) return i;\n    return -1;\n  }\n\n  // for comparing mods before unassignment\n  function compareArray(a1, a2) {\n    if (a1.length != a2.length) return false;\n    for (var i = 0; i < a1.length; i++) {\n        if (a1[i] !== a2[i]) return false;\n    }\n    return true;\n  }\n\n  var modifierMap = {\n      16:'shiftKey',\n      18:'altKey',\n      17:'ctrlKey',\n      91:'metaKey'\n  };\n  function updateModifierKey(event) {\n      for(k in _mods) _mods[k] = event[modifierMap[k]];\n  };\n\n  // handle keydown event\n  function dispatch(event) {\n    var key, handler, k, i, modifiersMatch, scope;\n    key = event.keyCode;\n\n    if (index(_downKeys, key) == -1) {\n        _downKeys.push(key);\n    }\n\n    // if a modifier key, set the key.<modifierkeyname> property to true and return\n    if(key == 93 || key == 224) key = 91; // right command on webkit, command on Gecko\n    if(key in _mods) {\n      _mods[key] = true;\n      // 'assignKey' from inside this closure is exported to window.key\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = true;\n      return;\n    }\n    updateModifierKey(event);\n\n    // see if we need to ignore the keypress (filter() can can be overridden)\n    // by default ignore key presses if a select, textarea, or input is focused\n    if(!assignKey.filter.call(this, event)) return;\n\n    // abort if no potentially matching shortcuts found\n    if (!(key in _handlers)) return;\n\n    scope = getScope();\n\n    // for each potential shortcut\n    for (i = 0; i < _handlers[key].length; i++) {\n      handler = _handlers[key][i];\n\n      // see if it's in the current scope\n      if(handler.scope == scope || handler.scope == 'all'){\n        // check if modifiers match if any\n        modifiersMatch = handler.mods.length > 0;\n        for(k in _mods)\n          if((!_mods[k] && index(handler.mods, +k) > -1) ||\n            (_mods[k] && index(handler.mods, +k) == -1)) modifiersMatch = false;\n        // call the handler and stop the event if neccessary\n        if((handler.mods.length == 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91]) || modifiersMatch){\n          if(handler.method(event, handler)===false){\n            if(event.preventDefault) event.preventDefault();\n              else event.returnValue = false;\n            if(event.stopPropagation) event.stopPropagation();\n            if(event.cancelBubble) event.cancelBubble = true;\n          }\n        }\n      }\n    }\n  };\n\n  // unset modifier keys on keyup\n  function clearModifier(event){\n    var key = event.keyCode, k,\n        i = index(_downKeys, key);\n\n    // remove key from _downKeys\n    if (i >= 0) {\n        _downKeys.splice(i, 1);\n    }\n\n    if(key == 93 || key == 224) key = 91;\n    if(key in _mods) {\n      _mods[key] = false;\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = false;\n    }\n  };\n\n  function resetModifiers() {\n    for(k in _mods) _mods[k] = false;\n    for(k in _MODIFIERS) assignKey[k] = false;\n  };\n\n  // parse and assign shortcut\n  function assignKey(key, scope, method){\n    var keys, mods;\n    keys = getKeys(key);\n    if (method === undefined) {\n      method = scope;\n      scope = 'all';\n    }\n\n    // for each shortcut\n    for (var i = 0; i < keys.length; i++) {\n      // set modifier keys if any\n      mods = [];\n      key = keys[i].split('+');\n      if (key.length > 1){\n        mods = getMods(key);\n        key = [key[key.length-1]];\n      }\n      // convert to keycode and...\n      key = key[0]\n      key = code(key);\n      // ...store handler\n      if (!(key in _handlers)) _handlers[key] = [];\n      _handlers[key].push({ shortcut: keys[i], scope: scope, method: method, key: keys[i], mods: mods });\n    }\n  };\n\n  // unbind all handlers for given key in current scope\n  function unbindKey(key, scope) {\n    var multipleKeys, keys,\n      mods = [],\n      i, j, obj;\n\n    multipleKeys = getKeys(key);\n\n    for (j = 0; j < multipleKeys.length; j++) {\n      keys = multipleKeys[j].split('+');\n\n      if (keys.length > 1) {\n        mods = getMods(keys);\n        key = keys[keys.length - 1];\n      }\n\n      key = code(key);\n\n      if (scope === undefined) {\n        scope = getScope();\n      }\n      if (!_handlers[key]) {\n        return;\n      }\n      for (i = 0; i < _handlers[key].length; i++) {\n        obj = _handlers[key][i];\n        // only clear handlers if correct scope and mods match\n        if (obj.scope === scope && compareArray(obj.mods, mods)) {\n          _handlers[key][i] = {};\n        }\n      }\n    }\n  };\n\n  // Returns true if the key with code 'keyCode' is currently down\n  // Converts strings into key codes.\n  function isPressed(keyCode) {\n      if (typeof(keyCode)=='string') {\n        keyCode = code(keyCode);\n      }\n      return index(_downKeys, keyCode) != -1;\n  }\n\n  function getPressedKeyCodes() {\n      return _downKeys.slice(0);\n  }\n\n  function filter(event){\n    var tagName = (event.target || event.srcElement).tagName;\n    // ignore keypressed in any elements that support keyboard data input\n    return !(tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA');\n  }\n\n  // initialize key.<modifier> to false\n  for(k in _MODIFIERS) assignKey[k] = false;\n\n  // set current scope (default 'all')\n  function setScope(scope){ _scope = scope || 'all' };\n  function getScope(){ return _scope || 'all' };\n\n  // delete all handlers for a given scope\n  function deleteScope(scope){\n    var key, handlers, i;\n\n    for (key in _handlers) {\n      handlers = _handlers[key];\n      for (i = 0; i < handlers.length; ) {\n        if (handlers[i].scope === scope) handlers.splice(i, 1);\n        else i++;\n      }\n    }\n  };\n\n  // abstract key logic for assign and unassign\n  function getKeys(key) {\n    var keys;\n    key = key.replace(/\\s/g, '');\n    keys = key.split(',');\n    if ((keys[keys.length - 1]) == '') {\n      keys[keys.length - 2] += ',';\n    }\n    return keys;\n  }\n\n  // abstract mods logic for assign and unassign\n  function getMods(key) {\n    var mods = key.slice(0, key.length - 1);\n    for (var mi = 0; mi < mods.length; mi++)\n    mods[mi] = _MODIFIERS[mods[mi]];\n    return mods;\n  }\n\n  // cross-browser events\n  function addEvent(object, event, method) {\n    if (object.addEventListener)\n      object.addEventListener(event, method, false);\n    else if(object.attachEvent)\n      object.attachEvent('on'+event, function(){ method(window.event) });\n  };\n\n  // set the handlers globally on document\n  addEvent(document, 'keydown', function(event) { dispatch(event) }); // Passing _scope to a callback to ensure it remains the same by execution. Fixes #48\n  addEvent(document, 'keyup', clearModifier);\n\n  // reset modifiers to false whenever the window is (re)focused.\n  addEvent(window, 'focus', resetModifiers);\n\n  // store previously defined key\n  var previousKey = global.key;\n\n  // restore previously defined key and return reference to our key object\n  function noConflict() {\n    var k = global.key;\n    global.key = previousKey;\n    return k;\n  }\n\n  // set window.key and window.key.set/get/deleteScope, and the default filter\n  global.key = assignKey;\n  global.key.setScope = setScope;\n  global.key.getScope = getScope;\n  global.key.deleteScope = deleteScope;\n  global.key.filter = filter;\n  global.key.isPressed = isPressed;\n  global.key.getPressedKeyCodes = getPressedKeyCodes;\n  global.key.noConflict = noConflict;\n  global.key.unbind = unbindKey;\n\n  if(typeof module !== 'undefined') module.exports = assignKey;\n\n})(this);\n","\"use strict\";\r\n\r\nvar oxford_comma = function(arr){\r\n    switch (arr.length){\r\n        case 1:\r\n            return arr[0];\r\n        case 2:\r\n            return arr[0] + \" and \" + arr[1];\r\n        case 3:\r\n            return arr[0] + \", \" + arr[1] + \", and \" + arr[2];\r\n    }\r\n}\r\n\r\nvar rotate = function(el, deg){\r\n    el.style.transform = \"rotate(\" + deg + 'deg)';\r\n    el.style.webkitTansform = \"rotate(\" + deg + 'deg)';\r\n    el.style.mozTransform = \"rotate(\" + deg + 'deg)';\r\n}\r\n\r\nvar translate = function(el, x, y){\r\n    var str = x==null ? \"\" : \"translate(\" + x + \"px,\" + y + \"px)\";\r\n    el.style.transform = str;\r\n    el.style.webkitTransform = str;\r\n    el.style.mozTransform = str;\r\n}\r\n\r\nvar text_multi = function(el, text, truncate_long_words){\r\n    if(truncate_long_words){\r\n        text = text.replace(/(\\S{25})\\S*/g,'$1...'); \r\n    }\r\n    el.textContent = text;  \r\n    el.innerHTML = el.innerHTML.replace(/\\n/g,'<br/>').replace(/\\t/g,'&nbsp;&nbsp;&nbsp; ');\r\n}\r\n\r\nvar escape_str = function(str){\r\n    // http://stackoverflow.com/a/18750001/2399799\r\n    return str.replace(/[\\u00A0-\\u9999<>\\&]/g, function(i) {\r\n        return '&#' + i.charCodeAt(0) + ';';\r\n    });\r\n}\r\n\r\nvar css_animation = (function(){\r\n    var timers = []; // we store timers and matching els so we can cancel if needed\r\n    var els = [];\r\n\r\n    return function(el, cls, callback, delay){\r\n        el.classList.remove(cls);\r\n        el.offsetTop; //forces class to be removed, so we can actually re-add it.\r\n        var old_idx = els.indexOf(el);\r\n        if(old_idx != -1){\r\n            clearTimeout(timers[old_idx]);\r\n            timers.splice(old_idx, 1);\r\n            els.splice(old_idx, 1);\r\n        }\r\n        els.push(el);\r\n        timers.push(setTimeout(callback, delay)); //this is better than trying to use the endtransition event\r\n        el.classList.add(cls);\r\n    }\r\n})();\r\n\r\nvar stop_propagation = function(e){\r\n    e.stopPropagation();\r\n}\r\n\r\nvar prevent_default = function(e){\r\n    e.preventDefault();  \r\n}\r\n\r\n/* TODO: ...............................................................\r\n\r\n$.fn.fixHeightFromAuto = function(){\r\n    var heights = [];\r\n    var d = this.get();\r\n    for(var i=0;i<d.length;i++)\r\n        heights.push(getComputedStyle(d[i]).height);\r\n    \r\n    this.each(function(ind){this.style.height = heights[ind];});\r\n\r\n    return this;\r\n}\r\n\r\n$.fn.insertClonedChildren = function(index,$src,textArray,attrObjArrays){\r\n    //inserts new nodes before this.children(index)\r\n    //the new nodes are based on $src, with text set according to the elements of textArray\r\n    //attrObjArrays is an optional arrays of objects giving key names and values\r\n    \r\n    var src = $src.get(0);\r\n    var frag = document.createDocumentFragment();\r\n    \r\n    textArray.map(function(str,ind){\r\n                    var a = src.cloneNode(false); \r\n                    a.textContent = str;\r\n                    if(attrObjArrays)for(var attr in attrObjArrays[ind])\r\n                        a.setAttribute(attr,attrObjArrays[ind][attr]);\r\n                    frag.appendChild(a);\r\n                });\r\n    \r\n    var parent = this.get(0);\r\n    var new_$els = $(Array.prototype.slice.call(frag.children,0));\r\n    parent.insertBefore(frag,parent.children[index]);\r\n    \r\n    return new_$els;\r\n}\r\n\r\n*/","\"use strict\";\r\n\r\nvar DropDown = function(val_array){\r\n    //constructor, must use <new>\r\n    \r\n    var str = val_array.map(function(val){\r\n                    return \"<div class='dropdown_item'>\" + val + \"</div>\";\r\n                 }).join(\"\");\r\n    \r\n    this.val_array = val_array.slice(0); \r\n    this.el_list = document.createElement('div');\r\n    this.el_list.className ='dropdown_item_list';\r\n    this.el_list.tabindex =-1\r\n    this.el_list.style.display = 'none';\r\n    this.el_list.innerHTML = str;\r\n\r\n    this.el_collapsed = document.createElement('div');\r\n    this.el_collapsed.className = 'dropdown_collapsed';\r\n    \r\n    this.el = document.createElement('div');\r\n    this.el.className = 'dropdown';\r\n    this.el.appendChild(this.el_list)\r\n    this.el.appendChild(this.el_collapsed);\r\n    this.ind = 0;\r\n    this.el_collapsed.textContent = val_array[0];\r\n    this.event_callbacks = {}; //map of callback lists\r\n    this.open = false;\r\n    \r\n    var dd = this;\r\n\r\n    this.el_collapsed.addEventListener('mousedown',function(){\r\n        if(!dd.trigger(\"click\"))\r\n            return;\r\n        dd.el.parentNode.classList.add(\"selected\");\r\n        dd.el_list.style.display = '';\r\n        this.open = true;\r\n        setTimeout(function(){\r\n            dd.el_list.focus();\r\n            dd.el_list.scrollTop = dd.el_list.children[dd.ind].offsetTop;\r\n        },1);\r\n    });\r\n    this.el_list.addEventListener('blur',function(e){\r\n        dd.el_list.style.display = 'none';\r\n        dd.open = false;\r\n        dd.trigger(\"blur\");\r\n    })\r\n    var on_click = function(e){\r\n            dd.SetInd(this.getAttribute('data-ind'));\r\n            dd.el_list.style.display = 'none';\r\n            dd.open = false;\r\n    };\r\n    for(var ii=0; ii<this.el_list.children.length; ii++){\r\n        this.el_list.children[ii].setAttribute('data-ind', ii);\r\n        this.el_list.children[ii].addEventListener(\"click\", on_click); \r\n    }\r\n\r\n    return this;\r\n}\r\n\r\nDropDown.FakeEvent = function(){//static subclass\r\n    this.is_stopped = false;\r\n}\r\nDropDown.FakeEvent.prototype.stopImmediatePropagation = function(){\r\n    this.is_stopped = true;\r\n}\r\n\r\nDropDown.prototype.addEventListener = function(evt, func){\r\n    if(!(evt in this.event_callbacks))\r\n        this.event_callbacks[evt] = [];\r\n    this.event_callbacks[evt].push(func);\r\n}\r\n\r\nDropDown.prototype.trigger = function(evt, args){\r\n    var fe = new DropDown.FakeEvent();\r\n    if(evt in this.event_callbacks){\r\n        for(var ii = 0; ii<this.event_callbacks[evt].length; ii++)\r\n            this.event_callbacks[evt][ii].call(this, fe);\r\n        if(fe.is_stopped)\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\nDropDown.prototype.IndexOf = function(val){\r\n    return this.val_array.indexOf(val);\r\n}\r\n\r\nDropDown.prototype.GetVal = function(){\r\n    return this.val_array[this.ind];\r\n}\r\n\r\nDropDown.prototype.SetInd = function(ind,no_trigger){\r\n    ind = parseInt(ind)\r\n    if(ind === this.ind)\r\n        return;\r\n    this.el_list.children[this.ind].classList.remove(\"selected\");\r\n    this.el_collapsed.textContent = this.val_array[ind];\r\n    this.ind = ind;\r\n    this.el_list.children[ind].classList.add(\"selected\");\r\n    if(!no_trigger)\r\n        this.trigger(\"change\",{ind:ind,str:this.val_array[ind],isOpen: this.open});\r\n}\r\n\r\nDropDown.prototype.SetSelected = function(v){\r\n    if(v)\r\n        this.el.parentNode.classList.add(\"selected\");\r\n    else\r\n        this.el.parentNode.classList.remove(\"selected\");\r\n}\r\n","\"use strict\";\r\n\r\ndn.menu_id_to_caption = {\r\n'menu_print': 'print',\r\n'menu_sharing': 'sharing',\r\n'menu_save': 'save',\r\n'menu_history': 'history',\r\n'menu_file': 'current file',\r\n'menu_new': 'new',\r\n'menu_open': 'new/open',\r\n'menu_find': 'find/replace',\r\n'menu_goto': 'goto line',\r\n'menu_general_settings': 'general settings',\r\n'menu_shortcuts': 'shortcuts',\r\n'menu_drive': 'drive',\r\n'menu_help': 'about/help'};\r\n\r\n\r\ndn.shortcuts_list = [\r\n\"cut|Ctrl-X|Cmd-X\",    \r\n\"copy|Ctrl-C|Cmd-C\",\r\n\"paste|Ctrl-V|Command-V\",\r\n\"cycle clipboard|Cltr-[V then left or right arrow]|Command-[V then left or right arrow]\",\r\n\"select all|Ctrl-A|Command-A\",\r\n\"find|Ctrl(-Alt)-F\",\r\n\"replace|Ctrl-R\",\r\n\"go to line|Ctrl(-Alt)-L\",\r\n\"undo|Ctrl-Z|Command-Z\",\r\n\"redo|Ctrl-Shift-Z,Ctrl-Y|Command-Shift-Z,Command-Y\",\r\n\" | \",\r\n\"toggle widget|Esc\",\r\n\"save|Ctrl-S|Command-S\",\r\n\"print|Ctrl(-Alt)-P|Command-P\",\r\n\"file history|Ctrl-H|Command-H\",\r\n\"new|Ctrl(-Alt)-N\",\r\n\"open|Ctrl(-Alt)-O\",\r\n\"  | \",\r\n\"to upper case|Ctrl-U\",\r\n\"to lower case|Ctr-Shift-U\",\r\n\"modify selection|Shift-(Ctrl-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown, PageUp, End}|Shift-(Command-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown,End}\",\r\n\"copy lines down|Ctrl-Alt-Down|Command-Option-Down\",\r\n\"copy lines up|Ctrl-Alt-Up|Command-Option-Up\",\r\n\"center selection||Ctrl-L\",\r\n\"fold all|Alt-0|Option-0\",\r\n\"unfold all|Alt-Shift-0|Option-Shift-0\",\r\n\"go to end|Ctrl-End,Ctrl-Down|Command-End,Command-Down\",\r\n\"go to line end|Alt-Right,End|Command-Right,End,Ctrl-E\",\r\n\"go to line start|Alt-Left,Home|Command-Left,Home,Ctrl-A\",\r\n\"go to page down|PageDown|Option-PageDown,Ctrl-V\",\r\n\"go to page up|PageUp|Option-PageUp\",\r\n\"go to start|Ctrl-Home,Ctrl-Up|Command-Home,Command-Up\",\r\n\"go to word left|Ctrl-Left|Option-Left\",\r\n\"go to word right|Ctrl-Right|Option-Right\",\r\n\"indent|Tab\",\r\n\"outdent|Shift-Tab\",\r\n\"overwrite|Insert\",\r\n\"remove line|Ctrl-D|Command-D\",\r\n\"remove to line end||Ctrl-K\",\r\n\"remove to linestart||Option-Backspace\",\r\n\"remove word left||Alt-Backspace,Ctrl-Alt-Backspace\",\r\n\"remove word right||Alt-Delete\",\r\n\"split line||Ctrl-O\",\r\n\"toggle comment|Ctrl-7|Command-7\",\r\n\"transpose letters|Ctrl-T\"\r\n]\r\n\r\ndn.ext_to_mime_type = {\r\nhtml:\"text/html\",\r\nhtm:\"text/html\",\r\njs:\"text/javascript\",\r\npl:\"application/x-perl\",\r\nxml:\"text/xml\",\r\nc:\"text/x-csrc\",\r\ncpp:\"text/x-c++src\",\r\nh:\"text/x-chdr\",\r\njson:\"application/json\",\r\nphp:\"application/x-php\",\r\nsvg:\"text/html\",\r\ncss:\"text/css\",\r\njava:\"text/x-java\",\r\npy:\"text/x-python\",\r\nscala:\"scala\",\r\ntextile:\"textile\",\r\ntex:\"application/x-tex\",\r\nbib:\"application/x-tex\",\r\nrtf:\"application/rtf\",\r\nrtx:\"application/rtf\",\r\nsh:\"application/x-sh\",\r\nsql:\"text/x-sql\",\r\nas:\"text/x-actionscript\"\r\n//everything else is hopefully ok to be text/plain.\r\n}\r\n\r\ndn.tooltip_info = { //keys correspond to icon data-info attr, which will be the same as keys in SHORTCUTS_LIST\r\n    \"save\" : \"Save file contents.  \",\r\n    \"print\": \"Open print view in a new tab.  \",\r\n    \"sharing\": \"View and modify file's sharing status.\",\r\n    \"file history\": \"Explore the file history.  \",\r\n    \"drive\": \"Show this file in Google Drive.  \",\r\n    \"about\": \"Drive Notepad website.\",\r\n    \"shortcuts\": \"Keyboard shortcuts.\",\r\n    \"new\": \"Create new file in a new tab.  \",\r\n    \"open\": \"Launch open dialoag.  \",\r\n    \"settings_file\": \"Properties of the current file.\",\r\n    \"settings_general\": \"Your general Drive Notepad preferences.\",\r\n    \"title\": \"Click to edit the file's title.\",\r\n    \"description\": \"Click to edit the file's description.\"\r\n}\r\n\r\n// TODO: use keymaster rather than relying on this\r\nvar WHICH = {\r\nENTER: 13,\r\nESC: 27,\r\nUP: 38,\r\nDOWN: 40\r\n};\r\n\r\ndn.default_settings = {\r\next: 'txt',\r\nwordWrap: [true,null,null],\r\nwordWrapAt: 80,\r\nfontSize: 1,\r\nwidget_anchor: ['l',50,'t',10],\r\nshowGutterHistory: 1,\r\nlastDNVersionUsed: '',\r\nnewLineDefault: 'windows',\r\nhistoryRemovedIsExpanded: true,\r\nsoftTabN: 4,\r\ntabIsHard: 0,\r\nwidgetSub: 'general',\r\ntheme: \"chrome\",\r\npane: '',\r\npane_open: true,\r\nfind_regex: false,\r\nfind_whole_words: false,\r\nfind_case_sensitive: false,\r\nhelp_inner: 'main',\r\nfind_goto: false,\r\nfind_replace: false\r\n}\r\n\r\ndn.default_custom_props = {\r\nnewline: \"detect\",\r\ntabs: \"detect\",\r\naceMode: \"detect\"\r\n};\r\n\r\ndn.impersonal_settings_keys = [\r\n\"wordWrap\",\r\n\"wordWrapAt\",\r\n\"fontSize\",\r\n\"widget_anchor\",\r\n\"showGutterHistory\",\r\n\"historyRemovedIsExpanded\",\r\n\"tabIsHard\",\r\n\"softTabN\",\r\n\"widgetSub\",\r\n\"theme\",\r\n\"pane\",\r\n\"pane_open\",\r\n\"find_regex\",\r\n\"find_whole_words\",\r\n\"find_case_sensitive\",\r\n\"help_inner\",\r\n\"find_goto\",\r\n\"find_replace\"\r\n];\r\n\r\ndn.drag_delay_ms = 400;\r\ndn.drag_shift_px = 40;\r\ndn.min_font_size = 0.3;\r\ndn.max_font_size = 5; \r\ndn.max_wrap_at = 200;\r\ndn.min_wrap_at = 20;\r\ndn.wrap_at_increment = 10;\r\ndn.max_soft_tab_n = 10;\r\ndn.min_soft_tab_n = 2;\r\ndn.detect_tabs_spaces_frac = 0.9;\r\ndn.detect_tabs_tabs_frac = 0.9;\r\ndn.detect_tabs_n_spaces_frac = 0.99;\r\ndn.detect_tabs_n_spaces_frac_for_default = 0.6;\r\ndn.font_size_increment = 0.15;\r\ndn.icon_mouse_over_ms = 300;\r\ndn.editor_refocus_time_ms = 500;\r\ndn.error_delay_ms = 5000;//5 seconds\r\ndn.find_history_add_delay = 2000; //ms\r\ndn.clipboard_info_delay = 500; //ms\r\ndn.clipboard_max_length = 20; //TODO: decide whether a large clipboard slows page loads and whether we can do anything about it.\r\ndn.find_max_results_half = 3; \r\ndn.find_max_prefix_chars = 10;\r\ndn.find_max_suffix_chars = 60;","\"use strict\";\r\n\r\ndn.close_history = function(){\r\n    dn.file_history.$revisions_display.remove();\r\n    window.removeEventListener(\"resize\", dn.revisions_window_resize);\r\n    document.getElementById('the_editor').style.display = '';\r\n    dn.editor.resize();\r\n    dn.is_showing_history = false;\r\n}\r\ndn.revisions_window_resize = function(){\r\n    if(dn.file_history.canShowResizeError){\r\n        dn.show_error(\"The history explorer displays poorly if you resize the window while it is open. (This is a bug.)\");\r\n        dn.file_history.canShowResizeError = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n        setTimeout(function(){dn.file_history.canShowResizeError = true;},dn.error_delay_ms);\r\n    }    \r\n}\r\n\r\ndn.start_revisions_worker = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.show_error(\"This is a new file.  It doesn't have any history to explore.\")\r\n        return;\r\n    }\r\n    dn.is_showing_history = true;\r\n    \r\n    if(!dn.file_history){\r\n        dn.el.widget_content.innerHTML('afterend', \r\n            \"<div class='widget_box widget_revisions'>\" + \r\n            \"<div class='widget_box_title widget_revisions_title'>File History</div>\" +\r\n            \"<div class='revision_caption_at'></div>\" +\r\n            \"<div class='revision_timeline'></div>\" +\r\n            \"<div class='revision_caption_from'></div>\" +\r\n            \"<div>Removed lines: <div class='button inline_button ' id='expand_removed'>expand</div>\" + \r\n                    \"<div class='button inline_button ' id='collapse_removed'>collapse</div></div>\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"<div id='revisions_status'>Initialising...</div>\" + \r\n            \"Press Esc to return to editing.\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"Please note that the history viewing tool is missing some important features and those that have been implemented may include the odd bug.</div>\");\r\n        dn.el.widget_file_history = dn.el.widget_content.parentNode.getElementsByClassName('widget_revisions')[0];\r\n        dn.el.widget_file_history.style.display = 'none';\r\n        dn.file_history = {\r\n            $revisions_display: $(\"<div class='revisions_view'><ol></ol></div>\"),\r\n            $view: null, \r\n            $new_li: $(\"<li class='rev_line' v='-1'/>\"),\r\n            $new_tick:  $(\"<div class='revision_tick'/>\"),\r\n            needToRefindViewChildren: false, //this flag tracks when the $rev_lines_ is out of date relative to children of $view\r\n            $rev_lines_: [], // this is a single jQuery collection\r\n            needToFixHeights: $([]),            \r\n            $timeline: $d.find('.revision_timeline'),\r\n            $revisions_status: $d.find('#revisions_status'),\r\n            $revision_caption_from: $d.find('.revision_caption_from'),\r\n            $revision_caption_at: $d.find('.revision_caption_at'),\r\n            $expand_removed: $d.find('#expand_removed'),\r\n            $collapse_removed: $d.find('#collapse_removed'),\r\n            revisions: [], //array of objects with etag, isDownloaded, modifiedDate, $tick\r\n            revisionFromEtag: {},\r\n            at: null, //revision object\r\n            from: null, //revision object,\r\n            canShowResizeError: true, //used by Revisions_WindowResize\r\n            worker: new Worker(\"js/revisions_worker.js\")\r\n        };\r\n    \r\n        dn.file_history.$view = dn.file_history.$revisions_display.find('ol'); \r\n        dn.file_history.$expand_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',true)});\r\n        dn.file_history.$collapse_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',false)});\r\n        dn.revision_setis_expaned(dn.g_settings.get('historyRemovedIsExpanded'))\r\n\r\n        var w = dn.file_history.worker;\r\n        w.onmessage = dn.revision_worker_delivery;\r\n    }\r\n    dn.file_history.worker.postMessage({ fileId: dn.the_file.file_id, \r\n                                        token: gapi.auth.getToken().access_token,\r\n                                        init: true});\r\n    dn.file_history.$revisions_display.appendTo($('body'));\r\n    $(window).on(\"resize\",dn.revisions_window_resize);\r\n    dn.el.widget_file_history.style.display = '';\r\n    dn.file_history.$view.empty();\r\n    $('#the_editor').style.display = 'none';\r\n    return false;\r\n}\r\n\r\ndn.revision_setis_expaned = function(v){\r\n    var h = dn.file_history;\r\n    if(!h) return; //if we haven't yet initialised fileHistory stuff then ignore this for now, when we do initialise we will read and apply the g_settings value\r\n    \r\n    if(v){\r\n        h.$expand_removed.classList.add('selected')\r\n        h.$collapse_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"expanded\");\r\n    }else{\r\n        h.$collapse_removed.classList.add('selected')\r\n        h.$expand_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"collapsed\")\r\n    }\r\n}\r\ndn.revision_set_at = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.at = r;\r\n    if(!fromChangeEvent)\r\n        h.$at_range.value = r.ind;    \r\n    text_multi(h.$revision_caption_at,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.from && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                      fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.revision_set_from = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.from = r;\r\n    if(!fromChangeEvent)\r\n        h.$from_range.value = r.ind;\r\n    text_multi(h.$revision_caption_from,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.at && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                          fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.display_revision_timeline = function(newRevisions){\r\n    var h = dn.file_history;\r\n    var rs = h.revisions;\r\n    //TODO: update display based on newRevisions rather than starting from scratch\r\n    \r\n    h.$at_range = $(\"<input class='revision_at_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    h.$tick_box = $(\"<div class='revision_tick_box'/>\");\r\n    h.$from_range = $(\"<input class='revision_from_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    \r\n        \r\n    var attr = rs.map(function(t){ return { downloaded: t.isDownloaded || false }; });\r\n    var text = Array.apply(null, Array(attr.length)).map(function () { return \"\" });\r\n    var $ticks = h.$tick_box.insertClonedChildren(0,h.$new_tick,text,attr);\r\n    \r\n    for(var i=0;i<rs.length;i++){\r\n        rs[i].ind = i;\r\n        rs[i].$ = $ticks.eq(i);\r\n    }\r\n    \r\n    h.$timeline.empty().append(h.$at_range).append(h.$tick_box).append(h.$from_range);\r\n\r\n    h.$at_range.on(\"change\",function(){\r\n            dn.revision_set_at(dn.file_history.revisions[this.value],true);\r\n        })\r\n    h.$from_range.on(\"change\",function(){\r\n            dn.revision_set_from(dn.file_history.revisions[this.value],true);\r\n        })\r\n\r\n    dn.revision_set_from(rs.length > 1 ? rs[1] : rs[0],false,true);\r\n    dn.revision_set_at(rs[0],false,true);\r\n}\r\n\r\ndn.revision_worker_delivery = function(e){\r\n    if(!e.data)\r\n        return; //not sure if this is possible\r\n\r\n    if(e.data.debug)\r\n        console.log(e.data);\r\n        \r\n    var h = dn.file_history;\r\n    //TODO: probably ought to use a more sensivle message system with a string command switching thign...but this is ok for now\r\n    \r\n    if(e.data.status)\r\n        text_multi(h.$revisions_status, e.data.status);\r\n        \r\n    if(e.data.revisions){    \r\n        h.revisions = e.data.revisions;\r\n        e.data.revisions.forEach(function(r){ h.revisionFromEtag[r.etag] = r;});\r\n        dn.display_revision_timeline(e.data.revisions);\r\n        h.worker.postMessage({ showEtag: h.at.etag,\r\n                               fromEtag: h.from.etag }); \r\n    }\r\n    \r\n    if(e.data.revisionDownloaded){\r\n        var r = h.revisionFromEtag[e.data.revisionDownloaded];\r\n        r.$.attr('downloaded',true);\r\n        r.isDownloaded = true;\r\n    }\r\n    \r\n    if(e.data.revsionDiffed){\r\n        h.needToRefindViewChildren = true;\r\n        var r = h.revisionFromEtag[e.data.revsionDiffed];\r\n        r.$.attr('diffed',true);\r\n        r.isDiffed = true;\r\n        \r\n        var newStuff = e.data.newStuffForDom;\r\n        for(var i=0;i<newStuff.length;i++){\r\n            var lines = newStuff[i].lines.map(function(str){return str || \" \"});  \r\n                                            // \"|| space\" thing is a hack for auto height stuff\r\n            h.needToFixHeights = h.needToFixHeights.add(\r\n                            h.$view.insertClonedChildren(newStuff[i].at,h.$new_li,lines)    );            \r\n        }\r\n    }\r\n\r\n    \r\n    if(e.data.vals_ui8buffer){\r\n        \r\n        if(h.needToRefindViewChildren){\r\n            h.$rev_lines_ = h.$view.children();\r\n            h.needToRefindViewChildren = false;\r\n        }\r\n        var $rl_ = h.$rev_lines_;\r\n        \r\n        if(h.needToFixHeights.length){\r\n            text_multi(h.$revisions_status, \"Obtaining line height data...\");\r\n            h.needToFixHeights.fixHeightFromAuto();\r\n            h.needToFixHeights = $([]);\r\n            text_multi(h.$revisions_status, \"Selecting lines...\");\r\n        }\r\n        \r\n        var vals = new Uint8Array(e.data.vals_ui8buffer)\r\n        $rl_.setAttribute('v',function(i){return vals[i]});\r\n            \r\n        // We have to manually set the width of the numbers (our version of ace's gutter)\r\n        switch(e.data.digits){\r\n            case 0:\r\n            case 1:\r\n            case 2:\r\n                h.$view.setAttribute('digits','');\r\n                break;\r\n            case 3:\r\n                h.$view.setAttribute('digits','###');\r\n                break;\r\n            case 4:\r\n                h.$view.setAttribute('digits','####');\r\n                break;\r\n            default:\r\n                h.$view.setAttribute('digits','#####');\r\n        }\r\n    }\r\n    \r\n        \r\n}\r\n","\"use strict\";\r\n\r\n/*\r\nThe find focus/blur problem.  This took some thinking to sort out!!!\r\n\r\nIn the end it is now relatively neat and simple to get your head around.\r\n\r\ndn.g_settings.set('pane', 'pane_find') and dn.g_settings.set('pane_open', true)\r\ndo not mess with the focus themselves. Any code that uses that must explicitly\r\ndecide whether or not it wants to focus on the input for search/goto (a choice\r\nwhich is made based on the flag dn.g_settings.get('find_goto')).\r\n\r\nCalling  dn.g_settings.set('find_goto', bool), also does not mess with the focus, it\r\njust renders the inactive version of goto/search.\r\n\r\nWe basically have the same setup for goto and for search, with goto having a less\r\nmeaty implementation, so it's easier to start by looking at that.\r\n\r\nWhen the input gets the focus, the goto/search operation is performed, when the\r\ninput is blurred it sets the info text to \"inactive\".  If the blur events is moving the\r\nfocus to null, then at the end of the blur event we redirect the focus to the editor.\r\n\r\nIn keyboard.js there are special functions for producing exactly the right\r\nfocus behaviour when pressing Esc (with focus on the editor) and pressing \r\nCtrl-F/Crtl-L.  \r\n============================\r\n\r\nEvetunally we may have to deal with the realtime document changes.\r\n\r\n*/\r\n\r\ndn.find_goto_changed = function(new_value){\r\n    // This just toggles the display, it does not deal with focus/blur, which may happen afterwards\r\n    // as a consequence if the relevant inputs previously had the focus.\r\n\r\n    if(new_value){\r\n        dn.el.find_goto_wrapper.style.display = '';\r\n        dn.el.find_find_wrapper.style.display = 'none';\r\n        dn.el.button_goto.classList.add('selected');\r\n        dn.el.find_info.textContent = 'goto line inactive';\r\n        dn.el.find_replace_wrapper.style.display = 'none';\r\n    }else{\r\n        dn.el.find_goto_wrapper.style.display = 'none';\r\n        dn.el.find_find_wrapper.style.display = '';\r\n        dn.el.button_goto.classList.remove('selected');\r\n        dn.el.find_info.textContent = 'search inactive';\r\n        if (dn.g_settings.get('find_replace'))\r\n            dn.el.find_replace_wrapper.style.display = '';\r\n    }\r\n}\r\n\r\ndn.find_replace_changed = function(new_value){\r\n    if(new_value){\r\n        dn.el.button_replace.classList.add('selected');\r\n        if(!dn.g_settings.get('find_goto'))\r\n            dn.el.find_replace_wrapper.style.display = '';\r\n    }else{\r\n        dn.el.find_replace_wrapper.style.display = 'none';\r\n        dn.el.button_replace.classList.remove('selected');\r\n    }\r\n    if(dn.find_inputs_have_focus)\r\n        dn.find_select_result_idx(dn.find_current_match_idx);\r\n}\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// goto :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// the implementation of goto is simpler than for search, so we start with it...\r\n\r\ndn.find_goto_input_has_focus = false; // we don't actually need this, but we keep it for analogy with search\r\n\r\ndn.find_goto_input_focus = function(){\r\n    dn.find_goto_input_has_focus = true;\r\n    dn.el.find_info.textContent = \"type to goto line\";\r\n    dn.find_perform_goto();\r\n}\r\n\r\ndn.find_goto_input_blur = function(e){\r\n    dn.find_goto_input_has_focus = false;\r\n    dn.el.find_info.textContent = \"goto line inactive\"; \r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\ndn.find_perform_goto = function(){\r\n    // called by find_goto_input_focus and find_goto_keyup\r\n    var validated_str = dn.el.find_goto_input.value.replace(/[^\\d]/,'');\r\n    if (validated_str !== dn.el.find_goto_input.value)\r\n        dn.el.find_goto_input.value = validated_str;\r\n    if(validated_str === \"\")\r\n        return;\r\n    var num = parseInt(validated_str);\r\n    dn.editor.gotoLine(num);\r\n    dn.editor.navigateLineEnd();\r\n}\r\n\r\ndn.find_goto_input_keyup = dn.find_perform_goto; //alias\r\n\r\ndn.find_goto_input_keydown = function(e){\r\n    // keydown is fired repeatedly when key remains down\r\n    if(e.which == WHICH.DOWN){\r\n        dn.el.find_goto_input.value = parseInt(dn.el.find_goto_input.value.replace(/[^\\d]/,''))+1;\r\n        dn.find_perform_goto();\r\n        e.preventDefault();\r\n    }else if(e.which == WHICH.UP){\r\n        dn.el.find_goto_input.value = parseInt(dn.el.find_goto_input.value.replace(/[^\\d]/,''))-1;\r\n        dn.find_perform_goto();\r\n        e.preventDefault();\r\n    } else if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false);\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    }\r\n}\r\n\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// search :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n\r\ndn.find_inputs_have_focus = false; // either find itself or replace\r\ndn.find_results = [];\r\ndn.find_current_match_idx = -1;\r\ndn.find_markers = [];\r\ndn.find_marker_current = undefined;\r\ndn.find_str = \"\";\r\n\r\ndn.find_inputs_focus = function(e){\r\n    if(e.currentTarget == dn.el.find_input){\r\n        dn.el.find_input.tabIndex = 101;\r\n        dn.el.find_replace_input.tabIndex = 102;   \r\n    } else {\r\n        dn.el.find_input.tabIndex = 102;\r\n        dn.el.find_replace_input.tabIndex = 101;   \r\n    }\r\n    if(dn.find_inputs_have_focus)\r\n        return; // focus was transfered between replace/find inputs\r\n\r\n    dn.find_inputs_have_focus = true;\r\n    dn.AceSearch = dn.AceSearch || ace.require(\"./search\").Search;\r\n    dn.AceRange = dn.AceRange || ace.require(\"./range\").Range;\r\n    dn.editor.setHighlightSelectedWord(false);  \r\n    dn.find_perform_search();\r\n}\r\n\r\ndn.find_inputs_blur = function(e){\r\n    if(e.relatedTarget == dn.el.find_replace_input  || e.relatedTarget == dn.el.find_input)\r\n        return; // focus is transfering between replace/find inputs\r\n\r\n    dn.find_inputs_have_focus = false;\r\n\r\n    // remove all markers\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    // reset widget display\r\n    dn.el.find_info.textContent = \"search inactive\";\r\n    dn.el.find_results.innerHTML = \"\";\r\n    dn.el.find_info_overflow.textContent = \"\";\r\n\r\n    // forget last search\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n\r\n    // forget last selection in input (in preparation for next time it gets focus)\r\n    dn.el.find_input.setSelectionRange(dn.el.find_input.selectionEnd, dn.el.find_input.selectionEnd);\r\n\r\n     // we had this on false during find\r\n    dn.editor.setHighlightSelectedWord(true);\r\n\r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\ndn.find_build_options = function(){\r\n    var str = dn.el.find_input.value;\r\n    var use_reg_exp = dn.g_settings.get('find_regex');\r\n    var sensitive = dn.g_settings.get('find_case_sensitive');\r\n    if(use_reg_exp){\r\n        var re = undefined;\r\n        re = new RegExp(str, sensitive ? \"g\" : \"gi\"); //cam throw error\r\n    }\r\n    return {\r\n    needle: use_reg_exp ? re : str,\r\n    wrap: true,\r\n    caseSensitive: sensitive,\r\n    wholeWord: dn.g_settings.get('find_whole_words'),\r\n    regExp: use_reg_exp };\r\n}\r\n\r\ndn.find_perform_search = function(){\r\n    // called by find_input_focus, find_settings_changed, and on keyup in the input, when text has changed\r\n\r\n    // clear previous find (but leave selection for now)\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if(dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current)\r\n        dn.find_marker_current = undefined;\r\n    }\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n    dn.el.find_results.innerHTML = \"\";  \r\n    dn.el.find_info_overflow.textContent = \"\";\r\n    dn.el.find_info.textContent = \"\";\r\n    dn.find_str = dn.el.find_input.value; // we only store it to make it easier for key_down to check for true changes\r\n\r\n    var search_options = undefined;\r\n    try{\r\n        search_options = dn.find_build_options();\r\n    } catch (e){\r\n        dn.el.find_info.textContent = escape_str(e.message); //TODO: could force first letter to lower case\r\n    }\r\n\r\n    if(search_options === undefined){\r\n        // failed regex, don't show any results\r\n        dn.editor.selection.clearSelection();\r\n\r\n    } else if(dn.find_str == \"\"){\r\n        // empty string (including empty regex), dont show any results\r\n        dn.el.find_info.textContent = \"type to search. \" /*+ dn.ctrl_key + \"-up/down for history.\"*/;\r\n        dn.editor.selection.clearSelection();\r\n        \r\n    } else {\r\n        // valid regex or pure str search..\r\n\r\n        // This is the actual search\r\n        var search = new dn.AceSearch();\r\n        search.setOptions(search_options);\r\n        var results = dn.find_results = search.findAll(session);\r\n\r\n        if(results.length === 0){\r\n            // No results to display, life is easy...\r\n            dn.el.find_info.textContent = \"no matches found.\";\r\n            dn.el.find_info_overflow.textContent = \"\";\r\n            dn.editor.selection.clearSelection();\r\n\r\n        }else{\r\n            // Right, we got some results ....\r\n\r\n            // Work out which result we should consider the current match.\r\n            var selected_range = session.getSelection().getRange();\r\n            for(var ii=0; ii<results.length; ii++) \r\n                if(results[ii].end.row > selected_range.start.row  || \r\n                    (results[ii].end.row == selected_range.start.row &&\r\n                     results[ii].end.column >= selected_range.start.column))\r\n                break;\r\n            var current_match_idx = (ii == results.length ? results.length-1 : ii);\r\n\r\n            // Add markers into the editor to show *all* the results\r\n            for(var ii=0; ii<results.length; ii++)\r\n                dn.find_markers.push(session.addMarker(results[ii], \"find_match_marker\", \"find_match_marker\", false));\r\n\r\n            // augment the results with their idx, this is useful for the subselection stuff\r\n            for(var ii=0; ii<results.length; ii++)\r\n                results[ii] = {range: results[ii], idx: ii};\r\n\r\n            // Render a subset of the results into the widget and mark & select the current match\r\n            dn.find_select_result_idx(current_match_idx);\r\n        }\r\n    }\r\n\r\n}\r\n\r\ndn.find_select_result_idx = function(current_match_idx){\r\n    // This is called within find_perform_search when a new search returns some results\r\n    // it's also called when we move through the results without changing the search and\r\n    // when replace_changed is called when find input already has the focus.   */\r\n\r\n    // Get a small sub set of results to show in the widget.\r\n    // We carefully implement some wrapping logic, which is a bit fiddly.\r\n    dn.find_current_match_idx = current_match_idx;\r\n\r\n    var session = dn.editor.getSession();\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    var results = dn.find_results;\r\n    var results_sub = [];\r\n    \r\n    var replace_is_showing = dn.g_settings.get('find_replace');\r\n\r\n    var max_results = dn.find_max_results_half*2 + (replace_is_showing ? 0 : 1);\r\n\r\n    if(results.length <= max_results){\r\n        results_sub = results;\r\n    }else{\r\n        var n_pre = dn.find_max_results_half - (replace_is_showing ? 1 : 0);\r\n        var n_post = dn.find_max_results_half;\r\n        if(current_match_idx < n_pre){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n_pre));\r\n            results_sub = results_sub.concat(results.slice(0, current_match_idx));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n_pre, current_match_idx));\r\n        }\r\n        results_sub.push(results[current_match_idx]); \r\n        if(current_match_idx + n_post >= results.length){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1));\r\n            results_sub = results_sub.concat(results.slice(0, n_post + 1 - (results.length - current_match_idx)));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1, current_match_idx + n_post + 1));\r\n        }\r\n    }\r\n\r\n    // Now lets build the html to show the subset of results in the widget\r\n    var show_replace_buttons = dn.g_settings.get('find_replace');\r\n    var html = \"\";\r\n    for(var ii=0; ii<results_sub.length; ii++){\r\n        var row = results_sub[ii].range.start.row;\r\n        var col = results_sub[ii].range.start.column;\r\n        var prefix_range = new dn.AceRange(row, Math.max(0, col-dn.find_max_prefix_chars), row, col);\r\n        var pre_ellipses = col > dn.find_max_prefix_chars; //TODO: deal with indent better\r\n        row = results_sub[ii].range.end.row;\r\n        col = results_sub[ii].range.end.column;\r\n        var suffix_range = new dn.AceRange(row, col, row, col+dn.find_max_suffix_chars);\r\n        html += \"<div class='find_result_item\" + (results_sub[ii].idx==current_match_idx? \" find_result_current\" : \"\") + \"'>\" +\r\n                    \"<div class='find_result_line_num'>\" + (row+1) + \"</div>\" +\r\n                    \"<div class='find_result_text'>\" +\r\n                        \"<div class='find_result_text_inner'>\" +\r\n                            (pre_ellipses ? \"&#8230;\" : \"\") + escape_str(session.getTextRange(prefix_range)) +\r\n                            \"<span class='find_result_match'>\" + escape_str(session.getTextRange(results_sub[ii].range)) + \"</span>\" +\r\n                            escape_str(session.getTextRange(suffix_range)) +\r\n                        \"</div>\" +\r\n                    \"</div>\" +\r\n                    (show_replace_buttons ? \"<div class='button inline_button replace_single_result' title='replace'>r</div>\" : \"\") + \r\n                \"</div>\";\r\n    }\r\n    dn.el.find_results.innerHTML = html;\r\n    var els = dn.el.find_results.getElementsByClassName('find_result_item');\r\n    for(var ii=0; ii<els.length; ii++) if(results_sub[ii].idx !== current_match_idx)\r\n        els[ii].addEventListener('click', dn.find_result_click(results_sub[ii].idx));\r\n    if(show_replace_buttons){\r\n        var els = dn.el.find_results.getElementsByClassName('replace_single_result')\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].addEventListener('click', dn.find_replace_result_click(results_sub[ii].idx));\r\n    }\r\n\r\n    if(results.length > max_results)\r\n        dn.el.find_info_overflow.textContent = \"... and \" + (results.length - max_results) + \" more matches\";\r\n    else\r\n        dn.el.find_info_overflow.textContent = \"\";\r\n\r\n    // do the special marker for the current selection and actually select it\r\n    dn.find_marker_current = session.addMarker(results[current_match_idx].range, \"find_current_match_marker\", \"find_current_match_marker\", false);\r\n    dn.editor.selection.setSelectionRange(results[current_match_idx].range, false);\r\n    dn.editor.renderer.scrollSelectionIntoView();\r\n}\r\n\r\ndn.find_settings_changed = function(){\r\n    if(dn.find_inputs_have_focus || \r\n       (dn.g_settings.get('pane') === 'pane_find' && dn.g_settings.get('pane_open') &&  dn.el.find_input.value))\r\n        dn.find_perform_search();\r\n}\r\n\r\ndn.find_result_click = function(ii){\r\n    // this can only be called while find input has the focus\r\n    return function(e){dn.find_select_result_idx(ii);};\r\n}\r\n\r\ndn.find_replace_result_click = function(ii){\r\n    return function(e){\r\n        dn.find_replace_result_idx(ii);\r\n        e.stopPropagation(); // prevent selecting item\r\n    }\r\n}\r\n\r\ndn.find_input_keyup = function(e){ \r\n    //we need keyup here in order that the val has the new character or new backspace\r\n    if(e.which == WHICH.ENTER || e.which == WHICH.ESC || e.which == WHICH.UP || e.which == WHICH.DOWN)\r\n        return; \r\n    if(dn.find_str == dn.el.find_input.value)\r\n        return;\r\n    dn.find_perform_search()\r\n}\r\n\r\ndn.find_input_keydown = function(e){ \r\n    // we want keydown here so that we can get repeated firing with keydown (i think on most browsers)\r\n\r\n    if ((e.which == WHICH.ENTER && !e.shiftKey) || (!e.ctrlKey && e.which == WHICH.DOWN)){\r\n        //find next\r\n        dn.find_select_result_idx(dn.find_current_match_idx + 1 < dn.find_results.length ? \r\n                                    dn.find_current_match_idx + 1 \r\n                                  : 0);\r\n        e.preventDefault();\r\n        return;\r\n    }else if((e.which == WHICH.ENTER && e.shiftKey) || (!e.ctrlKey && e.which == WHICH.UP)){\r\n        //find previous\r\n        dn.find_select_result_idx(dn.find_current_match_idx - 1 < 0 ? \r\n                                    dn.find_results.length -1 \r\n                                  : dn.find_current_match_idx - 1);\r\n        e.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false); // this focuses on the editor, and blurs the find_input\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        return;   \r\n    }\r\n\r\n}\r\n\r\ndn.find_replace_input_keydown = function(e){\r\n    if(e.which == WHICH.ENTER){\r\n        if(e.ctrlKey || e.shiftKey)\r\n            dn.find_replace_all();\r\n        else\r\n            dn.find_replace_result_idx(dn.find_current_match_idx);\r\n        e.preventDefault();\r\n    }else{\r\n        dn.find_input_keydown(e); // up, down results and esc\r\n    }\r\n}\r\n\r\ndn.find_replace_all = function(e){\r\n    try{\r\n        var options = dn.find_build_options();\r\n    } catch (e) {\r\n        dn.show_error(e.message);\r\n        return;\r\n    }\r\n    dn.editor.replaceAll(dn.el.find_replace_input.value, options);\r\n    dn.focus_editor();\r\n}\r\n\r\ndn.find_replace_click = dn.find_replace_all; //alias\r\n\r\ndn.find_replace_result_idx = function(idx){\r\n    var range = dn.find_results[idx].range;\r\n    // we use undocumented ACE API to avoid messing around tryinng to force it to use the exact range we wanted\r\n    dn.editor.$search.set(dn.find_build_options()); //this is needed so that $tryReplace knows what to do with regex'es\r\n    dn.editor.$tryReplace(range, dn.el.find_replace_input.value) // returns true on success, but do we care?\r\n    dn.find_perform_search();\r\n}","\"use strict\";\r\n\r\ndn.platform = (function(){\r\n    if(navigator.platform.indexOf(\"Win\") >-1)\r\n        return \"Windows\";\r\n    else if(navigator.platform.indexOf(\"Linux\") >-1)\r\n        return \"Linux\";\r\n    else if(navigator.platform.indexOf(\"Mac\")>-1)\r\n        return \"Mac\";\r\n        \r\n    return null;\r\n})();\r\n\r\ndn.create_pane_shortcuts = function(){\r\n//This is hardly the world's most efficient way of doing this....(but it probably doesn't matter)...\r\n\r\n    var arry = dn.shortcuts_list;\r\n    var dict = {};\r\n    var platform = dn.platform;\r\n\r\n    if(platform == \"Windows\" || platform == \"Linux\"){\r\n       for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts[1];\r\n        }\r\n    }else if(platform == \"Mac\"){\r\n        for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts.length > 2? parts[2] : parts[1];\r\n        }\r\n    }else{\r\n        //TODO: show something here, maybe let user switch, maybe have touch info for ipad & android.\r\n    }\r\n    \r\n    var html = [];\r\n    for(var action in dict)\r\n        html.push(\"<div class='shortcut_item'><div class='shortcut_action'>\" + \r\n                   action + \"</div><div class='shortcut_key'>\" + dict[action].replace(\",\",\"<br>\") +\r\n                   \"</div></div>\");\r\n    for(var action in dn.tooltip_info)if(action in dict)\r\n        dn.tooltip_info[action] += dict[action];\r\n\r\n    dn.el.pane_help_shortcuts.innerHTML =  [\r\n        \"<div class='widget_box_title shortcuts_title'>Keyboard Shortcuts \",\r\n             platform ? \"(\" + platform + \")\" : \"\" ,\r\n        \"</div>\",\r\n        \"<div class='shortcuts_header_action'>action</div><div class='shortcuts_header_key'>key</div>\",\r\n        \"<div class='shortcuts_list'>\",\r\n        html.join(''),\r\n        \"</div>\"].join('');\r\n\r\n};\r\n\r\ndn.esc_pressed = function(e){\r\n    dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n\r\n    if(dn.g_settings.get('pane_open') && dn.g_settings.get('pane') == 'pane_find')\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_shortcut_used = function(e){\r\n    var sel = dn.editor.session.getTextRange(dn.editor.getSelectionRange());\r\n    dn.g_settings.set('find_goto', false);\r\n    dn.g_settings.set('pane', 'pane_find');\r\n    dn.g_settings.set('pane_open', true);\r\n    if(sel){\r\n        dn.el.find_input.value = sel;\r\n        dn.el.find_input.select();\r\n    }\r\n    dn.el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_goto_shortcut_used = function(e){\r\n    dn.g_settings.set('find_goto', true);\r\n    dn.g_settings.set('pane', 'pane_find'); // doing this after the find_active=true, tells the change handler not to put focus back to editor\r\n    dn.g_settings.set('pane_open', true);\r\n    dn.el.find_goto_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.show_replace_shortcut_used = function(e){\r\n    dn.g_settings.set('find_replace', true);\r\n    dn.find_shortcut_used(e);   \r\n}\r\n\r\ndn.make_keyboard_shortcuts = function(){\r\n    //perviously was using ace for handling these shorcuts because it neater (and efficient?) but it was\r\n    //annoying trying to ensure the editor always had focus, and not clear what to do when the editor wasn't showing.\r\n    \r\n    //we have to delete the default ace commands linked to the keys we care about\r\n    dn.editor.commands.removeCommands([\r\n        \"find\",\"findprevious\",\"findnext\",\"replace\",\"jumptomatching\",\"sortlines\",\"selecttomatching\",\"gotoline\"]);\r\n\r\n    //then add new commands on to the document using keymaster.js...\r\n    key('command+s, ctrl+s,  ctrl+alt+s,  command+alt+s', dn.save_content);\r\n    key('command+p, ctrl+p,  ctrl+alt+p,  command+alt+p', dn.do_print);\r\n    key('command+o, ctrl+o,  ctrl+alt+o,  command+alt+o', dn.do_open);\r\n    key('command+n, ctrl+n,  ctrl+alt+n,  command+alt+n', dn.do_new);\r\n    key('command+l, ctrl+l,  ctrl+alt+l,  command+alt+l', dn.find_goto_shortcut_used);\r\n    key('command+f, ctrl+f,  ctrl+alt+f,  command+alt+f', dn.find_shortcut_used); \r\n    key('command+r, ctrl+r,  ctrl+alt+r,  command+alt+r' + \r\n       ', command+g, ctrl+g,  ctrl+alt+g,  command+alt+g', dn.show_replace_shortcut_used);\r\n    key('command+h, ctrl+h,  ctrl+alt+h,  command+alt+h', dn.start_revisions_worker);\r\n    key('esc', dn.esc_pressed);\r\n    key.filter = function(){return 1;}\r\n\r\n    // it seems like the clipboard history cycling only works the old way, i.e. using ace....\r\n    var HashHandler = require(\"ace/keyboard/hash_handler\").HashHandler\r\n    var extraKeyEvents = new HashHandler([\r\n        {bindKey: {win: \"Ctrl-Left\",mac: \"Command-Left\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Down\",mac: \"Command-Down\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Right\",mac:\"Command-Right\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right},\r\n        {bindKey: {win: \"Ctrl-Up\",mac:\"Command-Up\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right}\r\n    ]);\r\n    dn.editor.keyBinding.addKeyboardHandler(extraKeyEvents);\r\n\r\n    // Change \"ctrl\" to \"cmd\" if on Mac\r\n    dn.ctrl_key = \"crtl\"\r\n    if(dn.platform == 'Mac'){\r\n        dn.ctrl_key = 'cmd';\r\n        var els = dn.getElementsByClassName('ctrl_key');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].textContent = 'cmd'\r\n    }\r\n}\r\n","\"use strict\";\r\n// DRIVE NOTEPAD 2016\r\n// by DM\r\n\r\ndn.version_str = '2016a';\r\n\r\n// ############################\r\n// Constants and defaults, see alsp info.js\r\n// ############################\r\n\r\ndn.can_show_drag_drop_error = true;\r\ndn.is_showing_history = false;\r\n\r\ndn.status = {\r\n    // 0: get action in progress\r\n    // -1: failed\r\n    //  1: success\r\n    file_body: 0, \r\n    file_meta: 0, \r\n    file_sharing: 0, // after launching the sharing dialog this is set to -1\r\n    authentication: 0,\r\n    popup_active: 0, // 0 or 1, i.e. true or false\r\n    local_settings: 0,\r\n}\r\n\r\ndn.the_file = {\r\n    file_id: null,\r\n    folder_id: null,\r\n    title: null,\r\n    description: '',\r\n    ext: '',\r\n    loaded_mime_type: '',\r\n    new_line_detected: 'none', //'windows', 'unix','mixed', or 'none'\r\n    tab_detected: {val: 'none'},\r\n    is_pristine: true, //true while the document has no unsaved changes (set to true when we request the save not when we get confirmation, but if there is a save error it will be reverted to false).\r\n    mime_type: '',\r\n    is_saving: false,\r\n    data_to_save: {body: null, title: null, description: null}, //holds the values until confirmation of success for each\r\n    generation_to_save: {body: 0, title: 0, description: 0},//when saves return they check their this.description etc. against here and clear data_to_save if they match\r\n    is_read_only: false,\r\n    is_shared: false,\r\n    is_brand_new: false, // true from the point of creating a new document till the point we get confirmation of a successful save\r\n    is_reading_file_object: false, //this is used on drag and drop,\r\n    custom_props: {}, //these are the props potentially stored on the file using the custom properties API\r\n    custom_prop_exists: {}, //each of the custom props that actually exsits for the file will have an entry in this obj, with the key being the property and the value being true.\r\n    saving_title_count: 0 //tracks the number of active save request with just the title.  Whatever the resp, this number is decremented,\r\n};\r\ndn.change_line_history = [];\r\ndn.last_change = null;\r\ndn.change_line_classes =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_',8,5)\r\ndn.change_line_classes_rm =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_rm',8,5)\r\ndn.el = dn.el || {};\r\n\r\n/* ################################################################################################################\r\n\r\n    [Some Notes on settings in Drive Notepad]\r\n\r\n    There are two kinds of settings: per-user settings and per-file settings.\r\n    \r\n    The user settings are stored in dn.g_settings. When the page is loaded this is a fake Google Realtime model, \r\n    which uses a mixture of default values and values read from localStorage.  At some point after authenticating \r\n    the g_settings will become the true Google Realtime model. Whenever a value in g_settings is changed\r\n     dn.setting_changed is called with the appropriate paramaters, this is true right from when the page loads, \r\n     i.e. the first set of values trigger the SettingsChanged, but after that only modifications will trigger a change\r\n      (regardless of whether g_settings is the true model or not).  Use the .set() and .get() methods on the dn.g_settings.\r\n    \r\n    The per-file settings are stored in dn.the_file.custom_props.  When the page is loaded they are initialised with \r\n    default values.  Then, if we have opened an existing file, at some point they will be updated with the true values. \r\n     These settings are *not* a realtime model, rather they are Custom Properties (there's an API for it).  Again, as\r\n      with the per-user settings, whenever the file settings are changed they trigger a call to PropertyUpdated.  Note\r\n       that since this is not backed by a realtime model we won't get changes on the server push to the browser, only\r\n        local changes will be observed.  The per-file settings are shared across anyone who has read and/or write access \r\n        to the file in question. Note that if the default value is chosen the setting value is simply removed from the file.\r\n          Use the dn.set_property() function to set values and read values straight from the dn.the_file.custom_props object.\r\n    \r\n    For each key \"Something\" in customProps there is a function dn.apply_something_choice() which will read the per-user \r\n    and/or the per-file settings (as appropriate) and use the combined result to apply the chosen setting to the editor, \r\n    additionally the function will render the file settings tab and/or the general settings tab. As part of this function \r\n    there will likely be a call to dn.detect_something, which will run some fairly simple heuristic over the current file.\r\n      [TODO: may want to cache this, as it can end up getting called several times during loading and possibly elsewhere.] \r\n      [TODO: may want to have an ApplySomethingChoice for all settings not just those that are covered by customProps.]\r\n\r\n################################################################################################################## */\r\n\r\n\r\n// ############################\r\n// Auth stuff\r\n// ############################\r\n\r\ndn.authentication_done = function(auth_result){\r\n    dn.status.popup_active = 0;\r\n    if (!auth_result)\r\n        return dn.authentication_failed(null);\r\n    if(auth_result.error)\r\n        return dn.authentication_failed(auth_result.error);\r\n\r\n    dn.status.authentication = 1;\r\n    dn.show_status();\r\n\r\n    if(!dn.user_info)\r\n        dn.get_user_info();\r\n    if(dn.the_file.file_id &&  dn.status.file_meta != 1 || dn.status.file_body != 1)\r\n        dn.load_file();\r\n    dn.get_properties_from_cloud();\r\n\r\n    // Access token has been successfully retrieved, requests can be sent to the API\r\n    //TODO: make these redundant\r\n    gapi.load('drive-realtime', dn.get_settings_from_cloud());\r\n    gapi.load('drive-share', function(){\r\n        dn.el.share_dialog = new gapi.drive.share.ShareClient(dn.client_id);\r\n    });\r\n}\r\n\r\ndn.get_user_info = function(){\r\n   Promise.resolve(\r\n        gapi.client.request({\r\n            'path' : 'userinfo/v2/me?fields=name'\r\n        })).then(function(a){\r\n            dn.user_info = a.result;\r\n            dn.el.user_name.textContent = a.result.name;\r\n        }, function(err){\r\n            // TODO: could be auth problem\r\n            dn.show_error('Failed to get user info');\r\n            console.dir(err);\r\n        });\r\n}\r\n\r\ndn.authentication_failed = function(err){\r\n    dn.status.authorization = -1;\r\n    dn.status.popup_active = 0;\r\n    dn.show_status();\r\n    if(err)\r\n        dn.show_error(err.result.error.message);\r\n    else\r\n        dn.show_pane_permissions(); // No access token could be retrieved, force the authorization flow.\r\n}\r\n\r\ndn.reauth = function(callback){ \r\n    // TODO: as promise\r\n    dn.status.authentication = 0;\r\n    dn.show_status();\r\n    gapi.auth.authorize(dn.auth_map(true), function(){\r\n        dn.status.authentication = 1;\r\n        dn.show_status();\r\n        callback();\r\n    });\r\n}\r\n\r\ndn.launch_popup = function(){\r\n    dn.status.popup_active = 1;\r\n    dn.status.authorization = 0;\r\n    dn.show_status();    \r\n    Promise.resolve(\r\n        gapi.auth.authorize(dn.auth_map(false)))\r\n        .then(dn.authentication_done,\r\n              dn.authentication_failed);\r\n}\r\n\r\ndn.show_pane_permissions = function(){\r\n    dn.g_settings.set('pane', 'pane_permissions');\r\n    dn.g_settings.set('pane_open', 'true')\r\n    css_animation(dn.el.the_widget, 'shake', function(){}, dn.error_delay_ms);\r\n}\r\n\r\n\r\n// ############################\r\n// Sharing stuff\r\n// ############################\r\n\r\ndn.do_share = function(){\r\n    if(!dn.the_file.file_id){\r\n        dn.show_error(\"You cannot view/modify the sharing settings until you have saved the file.\")\r\n        return false;\r\n    }\r\n    dn.status.file_sharing = -1; //TODO: see SO question about no callback for share dialog...how are we supposed to know when it's closed and what happened?\r\n    dn.the_file.is_shared = 0;\r\n    dn.show_status();\r\n    dn.el.share_dialog.setItemIds([dn.the_file.file_id]);\r\n    dn.el.share_dialog.showSettingsDialog();\r\n    return false;\r\n}\r\n\r\n\r\n// ############################\r\n// Newline stuff\r\n// ############################\r\n\r\ndn.detect_new_line = function(str){\r\n    dn.the_file.new_line_detected = (function(){\r\n        //no special reason to use a self-executing function here, it's just lazy coding\r\n        var first_n = str.indexOf(\"\\n\");\r\n        if(first_n == -1)\r\n            return dn.show_newline_status(\"none\");\r\n    \r\n        var has_rn = str.indexOf(\"\\r\\n\") != -1;\r\n        var has_solo_n = str.match(/[^\\r]\\n/) ? true : false;\r\n        \r\n        if(has_rn && !has_solo_n)\r\n            return dn.show_newline_status(\"windows\");\r\n        if(has_solo_n && !has_rn)\r\n            return dn.show_newline_status(\"unix\")\r\n        \r\n        return dn.show_newline_status(\"mixed\");\r\n    })();    \r\n}\r\n\r\ndn.apply_newline_choice = function(str){\r\n        \r\n    var newlineDefault = dn.g_settings.get('newLineDefault');\r\n    \r\n    if(newlineDefault == \"windows\"){\r\n        dn.el.newline_menu_windows.classList.add('selected')\r\n        dn.el.newline_menu_unix.classList.remove('selected');\r\n    }else{//newlineDefault should be unix\r\n        dn.el.newline_menu_unix.classList.add('selected')\r\n        dn.el.newline_menu_windows.classList.remove('selected');\r\n    }             \r\n                \r\n   if(typeof str == \"string\")\r\n       dn.detect_new_line(str); //Note that it only makes sense to detect new line on downloaded content\r\n   \r\n   dn.show_newline_status(dn.the_file.new_line_detected); //if default changes after load or we have a new file we need this.\r\n   \r\n    dn.el.file_newline_detect.classList.remove('selected');\r\n    dn.el.file_newline_windows.classList.remove('selected');\r\n    dn.el.file_newline_unix.classList.remove('selected');\r\n   if(dn.the_file.custom_props.newline == \"detect\"){\r\n        if(dn.the_file.new_line_detected == \"windows\" || dn.the_file.new_line_detected == \"unix\")\r\n            dn.editor.session.setNewLineMode(dn.the_file.new_line_detected);\r\n        else\r\n            dn.editor.session.setNewLineMode(newlineDefault);    \r\n        dn.el.file_newline_detect.classList.add('selected');\r\n    }else{\r\n        dn.editor.session.setNewLineMode(dn.the_file.custom_props.newline);\r\n            if(dn.the_file.custom_props.newline == \"windows\")\r\n                dn.el.file_newline_windows.classList.add('selected');\r\n            else\r\n                dn.el.file_newline_unix.classList.add('selected');            \r\n    }    \r\n}\r\n\r\ndn.show_newline_status = function(statusStr){\r\n    var str;\r\n    switch(statusStr){\r\n        case 'none':\r\n            str =  \"no newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        case 'mixed':\r\n            str = \"mixture of newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        default:\r\n            str = \"detected \" + statusStr + \"-like newlines\";\r\n    }\r\n    \r\n    dn.el.file_newline_info.textContent = \"(\" + str +\")\";\r\n    \r\n    return statusStr;\r\n}\r\n\r\n\r\n// ############################\r\n// Open stuff\r\n// ############################\r\n\r\ndn.do_open = function(){\r\n    if(!dn.open_picker){\r\n        var view = new google.picker.View(google.picker.ViewId.DOCS);\r\n        dn.open_picker = new google.picker.PickerBuilder()\r\n        .enableFeature(google.picker.Feature.NAV_HIDDEN)\r\n        .setAppId(dn.client_id)\r\n        .setOAuthToken(gapi.auth.getToken().access_token)\r\n        .addView(view)\r\n        .setCallback(dn.picker_callback)\r\n        .build();\r\n    }\r\n    dn.open_picker.setVisible(true);\r\n    return false;\r\n}\r\n\r\ndn.picker_callback = function(data) {\r\n  if (data.action == google.picker.Action.PICKED) {\r\n    var fileId = data.docs[0].id;\r\n   dn.focus_editor();\r\n   // var url = window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0] + \"?state={\\\"action\\\":\\\"open\\\",\\\"ids\\\":[\\\"\" + fileId +\"\\\"]}\";\r\n    dn.el.opener_button_a.setAttribute('href', url);\r\n    dn.el.opener_button_b.setAttribute('href', url);\r\n    dn.g_settings.set('pane_open', false);\r\n    dn.el.opener_chooser.style.display = '';\r\n    css_animation(dn.el.the_widget, 'shake', function(){}, dn.error_delay_ms);\r\n  }else if(data.action == \"cancel\"){\r\n     dn.focus_editor();\r\n  } \r\n}\r\n\r\n\r\n// ############################\r\n// Widget stuff\r\n// ############################\r\n\r\ndn.show_help_inner = function(inner_pane){\r\n    // expects string 'shorcuts' or 'tips',  any other values shows main\r\n\r\n    dn.el.pane_help_shortcuts.style.display = 'none';\r\n    dn.el.pane_help_tips.style.display = 'none';\r\n    dn.el.pane_help_main.style.display = 'none';\r\n\r\n    dn.el.button_shortcuts.classList.remove('selected');\r\n    dn.el.button_tips.classList.remove('selected');\r\n    \r\n    if(inner_pane == 'tips'){\r\n        dn.el.pane_help_tips.style.display = '';\r\n        dn.el.button_tips.classList.add('selected');\r\n    } else if(inner_pane == 'shortcuts'){\r\n        dn.el.pane_help_shortcuts.style.display = '';\r\n        dn.el.button_shortcuts.classList.add('selected');\r\n    } else {\r\n        dn.el.pane_help_main.style.display = '';\r\n    }\r\n}\r\n\r\ndn.show_pane = function(id){\r\n    var el = document.getElementById(id);\r\n\r\n    // el can be undefined/null to hide everything\r\n    for(var ii=0; ii < dn.el.widget_content.children.length; ii++)if(dn.el.widget_content.children[ii] !== el){\r\n        dn.el.widget_content.children[ii].style.display = 'none';\r\n        var el_icon = dn.menu_icon_from_pane_id[dn.el.widget_content.children[ii].id];\r\n        if(el_icon)\r\n            el_icon.classList.remove('icon_selected');\r\n    }\r\n\r\n    if(el){\r\n        el.style.display = '';\r\n        var el_icon = dn.menu_icon_from_pane_id[el.id];\r\n        if(el_icon)\r\n            el_icon.classList.add('icon_selected')\r\n    }else{\r\n        dn.g_settings.set('pane_open', false);\r\n    }\r\n}\r\n\r\ndn.widget_mouse_down = function(e){\r\n    dn.widget_mouse_down_info = {\r\n            off_left: -e.clientX,\r\n            off_top: -e.clientY,\r\n            start_time: Date.now(),\r\n            is_dragging: e.button !== 0};\r\n    document.addEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.addEventListener('mouseup', dn.document_mouse_up_widget);\r\n}\r\n\r\ndn.document_mouse_move_widget = function(e){\r\n    var x = e.clientX+dn.widget_mouse_down_info.off_left;\r\n    var y = e.clientY+dn.widget_mouse_down_info.off_top;\r\n    if(!dn.widget_mouse_down_info.is_dragging){\r\n        dn.widget_mouse_down_info.is_dragging = (Date.now() - dn.widget_mouse_down_info.start_time > dn.drag_delay_ms)\r\n                                              || (x*x + y*y > dn.drag_shift_px * dn.drag_shift_px);\r\n    }\r\n    if(dn.widget_mouse_down_info.is_dragging)\r\n        translate(dn.el.the_widget, x, y);\r\n    e.stopPropagation();\r\n\r\n};\r\n\r\ndn.document_mouse_up_widget = function(e){\r\n    document.removeEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.removeEventListener('mouseup', dn.document_mouse_up_widget);\r\n\r\n    if(dn.widget_mouse_down_info.is_dragging){\r\n        var pos = dn.el.the_widget.getBoundingClientRect();\r\n        translate(dn.el.the_widget, 0, 0);\r\n    \r\n        //work out what widget_anchor should be\r\n        var widget_w = dn.el.the_widget.offsetWidth;\r\n        var widget_h = dn.el.the_widget.offsetHeight;\r\n        var window_w = window.innerWidth;\r\n        var window_h = window.innerHeight;\r\n        var anchor = []\r\n        if(pos.left < window_w - (pos.left + widget_w)){\r\n            anchor[0] = 'l'; //anchor left side by window width percentage\r\n            anchor[1] = Math.max(0,pos.left/window_w * 100);\r\n        }else{\r\n            anchor[0] = 'r'; //anchor right side by window width percentage\r\n            anchor[1] = Math.max(0,(window_w - (pos.left + widget_w))/window_w * 100);\r\n        }\r\n        if(pos.top < window_h - (pos.top+ widget_h)){\r\n            anchor[2] = 't'; //anchor top side by window height percentage\r\n            anchor[3] = Math.max(0,pos.top/window_h * 100);\r\n        }else{\r\n            anchor[2] = 'b'; //anchor bottom side by window height percentage\r\n            anchor[3] = Math.max(0,(window_h - (pos.top + widget_h))/window_h * 100);\r\n        }\r\n\r\n        if(dn.g_settings)\r\n            dn.g_settings.set(\"widget_anchor\",anchor); \r\n\r\n    }else{\r\n        dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n    }\r\n    dn.widget_mouse_down_info = undefined;\r\n};\r\n\r\ndn.widget_apply_anchor = function(anchor){\r\n    anchor = Array.isArray(anchor) ? anchor : dn.g_settings.get('widget_anchor');\r\n    var widget_w = dn.el.the_widget.offsetWidth;\r\n    var widget_h = dn.el.the_widget.offsetHeight;\r\n    var window_w = window.innerWidth;\r\n    var window_h = window.innerHeight;\r\n\r\n    if(anchor[0] == 'l'){\r\n        // horizontal position is anchored to a fixed percentage of window width on left of widget\r\n        if(window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = '0px'; //if the widget would overlap the right edge, then instead put it precisely on the right edge\r\n        }else{\r\n            dn.el.the_widget.style.left = anchor[1] + '%';\r\n            dn.el.the_widget.style.right = ''; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.add('flipped');\r\n        dn.el.widget_content.classList.add('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.add('flipped');\r\n\r\n    }else{\r\n        // horizontal position is anchored to a fixed percentage of window width on right of widget\r\n        if( window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = '0px';\r\n            dn.el.the_widget.style.right = ''; //if the widget would overlap the left edge, then instead put it precisely on the left edge\r\n        }else{\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = anchor[1] + '%'; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.remove('flipped');\r\n        dn.el.widget_content.classList.remove('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.remove('flipped');\r\n    }\r\n\r\n    if(anchor[2] == 't'){\r\n        // vertical position is anchored to a fixed percentage of window height on top of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = '0px';  \r\n        }else{\r\n            dn.el.the_widget.style.top = anchor[3] + '%';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }\r\n    }else{\r\n        // vertical position is anchored to a fixed percentage of window height on bottom of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = '0px';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }else{\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = anchor[3] + '%'; \r\n        }\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\ndn.toggle_widget = function(state){\r\n    // provide argument \"true\" to open widget, \"false\" to close\r\n    if(state){\r\n        dn.el.widget_menu.style.display = '';\r\n        dn.el.widget_content.style.display = '';\r\n    }else{\r\n        dn.el.widget_menu.style.display = 'none';\r\n        dn.el.widget_content.style.display = 'none';\r\n    }\r\n}\r\n\r\ndn.show_status = function(){\r\n    // TODO: new file, drag-drop from disk, pristing/saving, modify props, readonly/sharing info\r\n    var s = ''\r\n    if(dn.status.authentication != 1){\r\n        // auth in progress or failed\r\n        if(dn.status.authorization == -1)\r\n            s = \"Authorization required...\";\r\n        else if(dn.status.popup_active)\r\n            s = \"Login/authenticate with popup...\";\r\n        else\r\n            s = \"Authenticating...\";\r\n    } else if (dn.the_file.file_id){\r\n        // a file is/will be loaded...\r\n        if (dn.status.file_meta === 1 && dn.status.file_body === 1){\r\n            s = dn.the_file.title;\r\n            var extra = [];\r\n            if(dn.the_file.is_read_only)\r\n                extra.push(\"read-only\");\r\n            if(dn.the_file.is_shared)\r\n                extra.push(\"shared\");\r\n            if(dn.status.file_sharing == -1)\r\n                extra.push(\"sharing status unknown\");\r\n            if(!dn.the_file.is_pristine)\r\n                extra.push(\"unsaved changes\");\r\n            if(extra.length)\r\n                s += \"\\n[\" + extra.join(', ') + \"]\"; \r\n        }else if(dn.status.file_meta === 0 && dn.status.file_body === 0)\r\n            s = \"Loading file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1 && dn.status.file_body === 0)\r\n            s = \"Loading \" + (dn.the_file.is_read_only? 'read-only ' : '' ) + \r\n                    \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_meta === 0 && dn.status.file_body === 1)\r\n            s = \"Loading metadata for file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1) // and -1\r\n            s = \"Failed to download \" + (dn.the_file.is_read_only? 'read-only ' : '' )\r\n                    +  \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_body === 1) // and -1\r\n            s = \"Failed to download metadata for file:\\n\" + dn.the_file.file_id;\r\n        else // both -1\r\n            s = \"Failed to load file:\\n\" + dn.the_file.file_id;\r\n    } else {\r\n        // no file to load\r\n        s = \"ex nihilo omnia...\";\r\n    }\r\n\r\n    text_multi(dn.el.widget_text, s, true);\r\n}\r\n\r\ndn.show_error = function(message){\r\n    console.log(message); //it's just useful to do this too\r\n    text_multi(dn.el.widget_error_text, message,true);\r\n    dn.el.widget_error.style.display = '';\r\n    css_animation(dn.el.the_widget, 'shake', function(){\r\n        dn.el.widget_error.style.display = 'none';\r\n    }, dn.error_delay_ms);\r\n};\r\n\r\ndn.set_drive_link_to_folder = function(){\r\n    var els = document.getElementsByClassName('link_drive');\r\n    var href = dn.the_file.folder_id ? \r\n                'https://drive.google.com/#folders/' + dn.the_file.folder_id \r\n                : 'https://drive.google.com';\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].href = href;\r\n}\r\n\r\n\r\n// ############################\r\n// Settings stuff\r\n// ############################\r\n\r\ndn.get_settings_from_cloud = function() {\r\n    return;\r\n  gapi.drive.realtime.loadAppDataDocument(\r\n  function(doc) {\r\n    var old_temp_g_settings = dn.g_settings;\r\n    dn.g_settings = doc.getModel().getRoot();\r\n    dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    if(!dn.g_clipboard){\r\n        dn.g_settings.set('clipboard', doc.getModel().createList());\r\n        dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    }\r\n    dn.g_find_history = dn.g_settings.get('findHistory');\r\n    if(!dn.g_find_history){\r\n        dn.g_settings.set('findHistory', doc.getModel().createList());\r\n        dn.g_find_history = dn.g_settings.get('findHistory');\r\n    }\r\n    \r\n    var existingKeys = dn.g_settings.keys();\r\n    dn.g_settings.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED, dn.settings_changed);\r\n    console.log('Applying settings from cloud...')\r\n    for(var s in dn.default_settings)\r\n        if(s in old_temp_g_settings.getKeeps())\r\n            dn.g_settings.set(s,old_temp_g_settings.get(s));\r\n        else if(existingKeys.indexOf(s) == -1)\r\n            dn.g_settings.set(s,dn.default_settings[s]);\r\n        else if(JSON.stringify(old_temp_g_settings.get(s)) !== JSON.stringify(dn.g_settings.get(s)))\r\n            dn.settings_changed({property:s, newValue:dn.g_settings.get(s)});// the gapi doesn't automatically trigger this on load\r\n    \r\n    //Check lastDNVersionUsed at this point - by default it's blank, but could also have an out-of-date value\r\n    if(dn.g_settings.get('lastDNVersionUsed') != dn.version_str){\r\n        dn.g_settings.set('help_inner', 'tips');\r\n        dn.g_settings.set('pane', 'pane_help');\r\n        dn.g_settings.set('pane_open', 'true');\r\n        dn.g_settings.set('lastDNVersionUsed', dn.version_str);\r\n    }\r\n  },\r\n  null,\r\n  function(resp){\r\n        console.log(\"g_settings error\");\r\n        console.dir(arguments);\r\n        if ((resp.type && resp.type == \"token_refresh_required\") || resp.error.code == 401) //not sure if it has an error.code field but it does seem to have a type field\r\n            dn.reauth(function(){console.log(\"reauthed triggered by g_settings\")}); //no real callback here, I think the realtime api somehow disovers that we're back in buisiness\r\n    })\r\n\r\n}\r\n\r\ndn.load_default_settings = function(){\r\n  //Lets show the user either the defualt settings or the \r\n  //ones last used on this browser (restricted to impersonal settings only)\r\n\r\n  dn.g_settings = (function(){ //mock realtime model to be used until the real model is initialised\r\n      var ob = {};\r\n      var keeps = {}\r\n      return {get: function(k){return ob[k]}, \r\n              set: function(k,v){\r\n                if(ob[k] === v)\r\n                    return;\r\n                ob[k] = v;\r\n                dn.settings_changed({property: k, newValue: v});\r\n                },\r\n              keep: function(k){keeps[k] = true},\r\n              getKeeps: function(){return keeps;}};\r\n                                 \r\n  })();\r\n\r\n  dn.status.local_settings = 0;\r\n  try{\r\n    console.log('Loading default/localStorage settings...');\r\n    for(var s in dn.default_settings)\r\n    if(dn.impersonal_settings_keys.indexOf(s) == -1 || !localStorage || !localStorage[\"g_settings_\" +s])\r\n        dn.g_settings.set(s,dn.default_settings[s]);\r\n    else\r\n        dn.g_settings.set(s,JSON.parse(localStorage[\"g_settings_\" + s]));\r\n  }catch(err){\r\n      if(localStorage) \r\n        localStorage.clear();\r\n      console.log(\"Failed to load defaults/localStorage settings.  Have cleared localStorage cache.\")\r\n  }\r\n  dn.status.local_settings = 1;\r\n}\r\n\r\ndn.settings_changed = function(e){\r\n    var new_value = e.newValue;\r\n    console.log(\"[user settings] \" + e.property +\": \" + new_value);\r\n    if(dn.impersonal_settings_keys.indexOf(e.property)>-1 && localStorage){\r\n        localStorage[\"g_settings_\" + e.property] = JSON.stringify(new_value);\r\n    }\r\n    try{\r\n        switch(e.property){\r\n            case \"widget_anchor\":\r\n                dn.widget_apply_anchor(new_value);\r\n                    break;\r\n            case \"theme\":\r\n                dn.editor.setTheme('ace/theme/' + new_value);\r\n                dn.theme_drop_down.SetInd(dn.theme_drop_down.IndexOf(new_value), true);\r\n                break;\r\n            case \"fontSize\":\r\n                var scrollLine = dn.get_scroll_line();\r\n                dn.el.font_size_text.textContent = new_value.toFixed(1);\r\n                dn.editor.setFontSize(new_value + 'em')    \r\n                dn.editor.scrollToLine(scrollLine);\r\n                break;\r\n            case \"wordWrap\":\r\n                var s = dn.editor.getSession();\r\n                var scrollLine = dn.get_scroll_line();\r\n                s.setUseWrapMode(new_value[0]);\r\n                s.setWrapLimitRange(new_value[1],new_value[2]);\r\n                 dn.editor.scrollToLine(scrollLine);\r\n                if(!new_value[0])\r\n                    dn.el.word_wrap_off.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_off.classList.remove('selected');\r\n                if(new_value[0] && !new_value[1])\r\n                    dn.el.word_wrap_edge.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_edge.classList.remove('selected');\r\n                if(new_value[0] && new_value[1])\r\n                    dn.el.word_wrap_at.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_at.classList.remove('selected');\r\n\r\n                break;\r\n            case \"wordWrapAt\":\r\n                dn.el.word_wrap_at_text.textContent = new_value;\r\n                var curWrap = dn.g_settings.get('wordWrap');\r\n                if(curWrap[1] && curWrap[1] != new_value)\r\n                    dn.g_settings.set('wordWrap',[1,new_value,new_value]);\r\n                dn.editor.setPrintMarginColumn(new_value);\r\n                break;\r\n            case \"showGutterHistory\":\r\n                var s = dn.editor.getSession(); \r\n                if(new_value){\r\n                    dn.el.gutter_history_show.classList.add('selected')\r\n                    dn.el.gutter_history_hide.classList.remove('selected');\r\n                }else{\r\n                    var h = dn.change_line_history;\r\n                    for(var i=0;i<h.length;i++)if(h[i])\r\n                        s.removeGutterDecoration(i,h[i]<0 ? dn.change_line_classes_rm[-h[i]] : dn.change_line_classes[h[i]]);\r\n                    dn.change_line_history = []; \r\n                    dn.el.gutter_history_hide.classList.add('selected')\r\n                    dn.el.gutter_history_show.classList.remove('selected');\r\n                }\r\n                break;\r\n            case \"newLineDefault\":\r\n                dn.apply_newline_choice();\r\n                break;\r\n            case \"historyRemovedIsExpanded\":\r\n                dn.revision_setis_expaned(new_value);\r\n                break;\r\n            case \"softTabN\":\r\n            case \"tabIsHard\":          \r\n                dn.apply_tab_choice(); \r\n                break;\r\n            case 'pane_open':\r\n                dn.toggle_widget(new_value)\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane_open');\r\n                break;\r\n            case 'pane':\r\n                dn.show_pane(new_value);\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane');\r\n                if(new_value !== 'pane_help')\r\n                    dn.g_settings.set('help_inner', 'main');\r\n                break; \r\n            case 'help_inner':\r\n                dn.show_help_inner(new_value);\r\n                break;\r\n            case 'find_regex':\r\n                if(new_value)\r\n                    dn.el.find_button_regex.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_regex.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_whole_words':\r\n                if(new_value)\r\n                    dn.el.find_button_whole_words.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_whole_words.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_case_sensitive':\r\n                if(new_value)\r\n                    dn.el.find_button_case_sensitive.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_case_sensitive.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_replace':\r\n                dn.find_replace_changed(new_value);\r\n                break;\r\n            case 'find_goto':\r\n                dn.find_goto_changed(new_value);\r\n                break;\r\n        }\r\n    }catch(err){\r\n        console.log(\"Error while uptating new settings value.\")\r\n        console.dir(e);\r\n        console.dir(err);\r\n    }\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Font size stuff\r\n// ############################\r\n\r\ndn.font_size_decrement_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size -= dn.font_size_increment;\r\n    font_size = font_size  < dn.min_font_size ? dn.min_font_size: font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\ndn.font_size_increment_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size += dn.font_size_increment;\r\n    font_size = font_size  > dn.max_font_size ? dn.max_font_size:font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Tab stuff\r\n// ############################\r\n// Note that there is a whitespace extension for ace but it doesn't look that mature and we actually have slightly different requirements here.\r\n\r\ndn.detect_tab = function(str){    \r\n    dn.the_file.tab_detected = (function(){ //no need to use a self-executing function here, just lazy coding....\r\n        //This function returns an object with a field \"val\" that takes one of the folling values:\r\n        // none: no indents detected at all\r\n        // mixture: no strong bias in favour of spaces or tabs\r\n        // tab: defintely tabs\r\n        // spaces: definitely space. In this case extra fields are provied....\r\n        //   n: number of spaces\r\n        //   isDefault: true if the default nSpaces value was used as part of the decision making process\r\n        //   threshold: this takes one of three values:\r\n        //          strong: the largest n over threshold was used\r\n        //          weak: no n was over the strong threshold, but the default n was over the weak threshold\r\n        //          failed: no idea what n is, so just use default\r\n    \r\n        var lines = dn.editor.session.getLines(0, 1000);    \r\n        var indents = lines.map(function(str){\r\n                        return str.match(/^\\s*/)[0];\r\n                      });\r\n        indents = indents.filter(function(str){return str !== '';});\r\n        \r\n        if(!indents.length)\r\n            return dn.show_tab_status({val: \"none\"});\r\n            \r\n        //TODO: if first thousand lines happen to have few indents it may be worth checking further down.\r\n        \r\n        var stats = indents.reduce(function(stats,str){\r\n           if(str.indexOf('\\t') > -1)\r\n              if(str.indexOf(' ') > -1)\r\n                stats.nWithMixture++;\r\n              else\r\n                stats.nWithOnlyTabs++;\r\n           else\r\n               stats.spaceHist[str.length] = (stats.spaceHist[str.length] || 0) + 1;   \r\n            return stats;\r\n        },{nWithOnlyTabs: 0,spaceHist: [],nWithMixture: 0});\r\n            \r\n        stats.nSamp = indents.length;\r\n        stats.nWithOnlySpaces = stats.nSamp - stats.nWithMixture - stats.nWithOnlyTabs;\r\n        \r\n        console.dir(stats);\r\n            \r\n        if(stats.nWithOnlyTabs/stats.nSamp >= dn.detect_tabs_tabs_frac)\r\n            return dn.show_tab_status({val: \"tab\"});\r\n    \r\n        if(stats.nWithOnlySpaces/stats.nSamp < dn.detect_tabs_spaces_frac)\r\n            return dn.show_tab_status({val: \"mixture\"});\r\n    \r\n        stats.spaceModHist = [];\r\n        var s;\r\n        for(s=dn.min_soft_tab_n;s<=dn.max_soft_tab_n;s++){\r\n            var m = 0;    \r\n            for(var i=s;i<stats.spaceHist.length;i+=s)\r\n                m += stats.spaceHist[i] !== undefined ? stats.spaceHist[i] : 0;\r\n            stats.spaceModHist[s] = m;\r\n        }\r\n        \r\n        for(s=dn.max_soft_tab_n;s>=dn.min_soft_tab_n;s--)\r\n            if(stats.spaceModHist[s]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac)\r\n                break;\r\n                \r\n        if(s < dn.min_soft_tab_n){\r\n            // nothing was over threshold, but rather than give up lets use a weaker threshold on the default space count\r\n            var defaultNSpaces = dn.g_settings.get('softTabN');    \r\n            if(stats.spaceModHist[defaultNSpaces]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac_for_default)\r\n                return dn.show_tab_status({val: 'spaces', n: defaultNSpaces, isDefault: true, threshold: \"weak\"});\r\n            else\r\n                return dn.show_tab_status({val: \"spaces\", n: defaultNSpaces, isDefault: true, threshold: \"failed\"});\r\n        }else{\r\n            // s is the index of the last element in the spaceModHist array which is over threshold\r\n                return dn.show_tab_status({val: \"spaces\", n: s, isDefault: false, threshold: \"strong\"});\r\n        }\r\n    })();\r\n}\r\n\r\n\r\ndn.show_tab_status = function(d){\r\n    var str;\r\n    var defaultStr = \"\";\r\n    if(dn.g_settings.get(\"tabIsHard\"))\r\n        defaultStr = \"hard tabs\";\r\n    else\r\n        defaultStr = dn.g_settings.get(\"softTabN\") + \" spaces\";\r\n    \r\n    switch(d.val){\r\n        case 'none':\r\n            str = \"no indentations detected, default is \" + defaultStr;\r\n            break;\r\n        case 'mixture':\r\n            str = \"detected mixture of tabs, default is \" + defaultStr;\r\n            break;\r\n        case 'tab':\r\n            str = \"hard tab indentation detected\";\r\n            break;\r\n        case \"spaces\":\r\n            switch(d.threshold){\r\n                case 'strong':\r\n                    str = \"detected soft-tabs of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'weak':\r\n                    str = \"detected close match to default of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'failed':\r\n                    str = \"detected soft-tabs, assuming default \" + d.n + \" spaces\";\r\n                    break;\r\n            }\r\n    }\r\n    \r\n    dn.el.file_tab_info.textContent = \"(\" + str +\")\";\r\n    return d;\r\n}\r\n\r\ndn.apply_tab_choice = function(){\r\n    var defaultTabIsHard = dn.g_settings.get('tabIsHard');\r\n    var defaultSoftTabN = dn.g_settings.get('softTabN');               \r\n                \r\n    var d;\r\n    var isHard;\r\n    var nSpaces;\r\n    var isDetected;\r\n    \r\n    dn.detect_tab();   \r\n    if(dn.the_file.custom_props.tabs == \"detect\"){\r\n        d = dn.the_file.tab_detected;             \r\n        isDetected = true\r\n    }else{\r\n        try{\r\n            d = JSON.parse(dn.the_file.custom_props.tabs);\r\n        }catch(err){\r\n            d = {val: \"none\"};\r\n        }\r\n    }\r\n    switch(d.val){\r\n        case 'none':\r\n        case 'mixture':\r\n            isHard = defaultTabIsHard;\r\n            nSpaces = defaultSoftTabN;\r\n            break;\r\n        case 'tab':\r\n            isHard = true;\r\n            nSpaces = d.n || defaultSoftTabN;\r\n            break;\r\n        case 'spaces':\r\n            isHard = false;\r\n            nSpaces = d.n;\r\n    }\r\n    \r\n    \r\n    if(isHard){\r\n        dn.editor.session.setUseSoftTabs(false);\r\n    }else{\r\n        dn.editor.session.setUseSoftTabs(true);\r\n        dn.editor.session.setTabSize(nSpaces);\r\n    }\r\n    \r\n    dn.el.tab_soft_text.textContent = defaultSoftTabN;\r\n    if(defaultTabIsHard){\r\n        dn.el.tab_hard.classList.add('selected');\r\n        dn.el.tab_soft.classList.remove('selected');\r\n    }else{\r\n        dn.el.tab_soft.classList.add('selected');\r\n        dn.el.tab_hard.classList.remove('selected');\r\n    }\r\n    \r\n    \r\n    dn.el.file_tab_detect.classList.remove('selected');\r\n    dn.el.file_tab_hard.classList.remove('selected');\r\n    dn.el.file_tab_soft.classList.remove('selected');\r\n    if(isDetected){\r\n        dn.el.file_tab_detect.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }else{\r\n        if(d.val == \"tab\")\r\n            dn.el.file_tab_hard.classList.add('selected');\r\n        else\r\n            dn.el.file_tab_soft.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }     \r\n\r\n\r\n}\r\n\r\ndn.set_file_tabs_to_soft_or_hard = function(val,delta){\r\n    var f = dn.the_file;\r\n    var current = f.custom_props.tabs;\r\n    if(current == \"detect\"){\r\n        current = f.tab_detected;\r\n        if(current.val == 'none' || current.val == \"mixture\")\r\n            current = { val: dn.g_settings.get('tabIsHard') ? \"tab\" : \"spaces\",\r\n                        n: dn.g_settings.get('softTabN')};\r\n    }else{\r\n        try{\r\n            current = JSON.parse(current);\r\n        }catch(err){\r\n            console.log(\"JSON.parse failed in SetFileTabsToSoftOrHard with current=\" + current)\r\n            return;\r\n        }\r\n    }\r\n    var newT = {val: val, n: current.n + delta};\r\n    dn.set_property(\"tabs\",JSON.stringify(newT));\r\n}\r\n// ############################\r\n// Syntax stuff\r\n// ############################\r\n\r\ndn.show_syntax_status = function(d){\r\n    var str = \"detected \" + d.syntax + \" from file extension\";\r\n    //TODO: if we improve upon DetectSyntax will need to add stuff here\r\n    dn.el.file_ace_mode_info.textContent = \"(\" + str + \")\";\r\n    return d.syntax;\r\n}\r\ndn.detect_syntax = function(){\r\n    dn.the_file.syntax_detected = (function(){ //no need to use self-ex-func here, just laziness...\r\n        //TODO: improve upon this\r\n        var title = dn.the_file.title || \"untitled.txt\";\r\n        var mode  = require(\"ace/ext/modelist\").getModeForPath(title);\r\n        dn.the_file.syntax_detected = mode.caption;\r\n        dn.show_syntax_status({syntax: dn.the_file.syntax_detected});\r\n        return mode;\r\n    })();\r\n}\r\n\r\ndn.apply_syntax_choice = function(){\r\n    dn.detect_syntax();\r\n    if(dn.the_file.custom_props[\"aceMode\"] == \"detect\"){\r\n        dn.set_syntax(dn.the_file.syntax_detected);\r\n        dn.el.file_ace_mode_detect.classList.add('selected');\r\n        dn.syntax_drop_down.SetSelected(false);\r\n    }else{\r\n        dn.set_syntax(dn.the_file.custom_props[\"aceMode\"])\r\n        dn.el.file_ace_mode_detect.classList.remove('selected');\r\n        dn.syntax_drop_down.SetSelected(true);\r\n    }\r\n}\r\n\r\ndn.get_current_syntax_name = function(){\r\n    try{\r\n        var modesArray = require(\"ace/ext/modelist\").modesByName;\r\n        return modesArray[dn.editor.session.getMode().$id.split('/').pop()].caption\r\n    }catch(e){\r\n        console.log(\"ERROR in GetCurrentSyntaxName...\");\r\n        console.dir(e);\r\n        return \"Text\";\r\n    }  \r\n}\r\n\r\ndn.set_syntax = function(val){\r\n\r\n    var modesArray = require(\"ace/ext/modelist\").modes;\r\n    var mode;\r\n    var ind;\r\n    \r\n    if(typeof val == \"number\"){\r\n        //val is index into mdoes array\r\n        mode = modesArray[val].mode;\r\n        ind = val;\r\n    }else if(modesArray.indexOf(val) > -1){\r\n        //val is an element of the modelist array\r\n        mode = val.mode;\r\n        ind = modesArray.indexOf(val);\r\n    }else{\r\n        //val is caption of mode in modes array\r\n        for(ind=0;ind<modesArray.length;ind++)if(modesArray[ind].caption == val){\r\n            mode = modesArray[ind].mode;\r\n            break;\r\n        }    \r\n    }\r\n    \r\n    if(dn.syntax_drop_down)\r\n        dn.syntax_drop_down.SetInd(ind,true);\r\n    dn.editor.getSession().setMode(mode);\r\n}\r\n\r\ndn.create_theme_menu = function(){\r\n    var themes = require('ace/ext/themelist');\r\n    var theme_drop_down = new DropDown(Object.keys(themes.themesByName));\r\n    theme_drop_down.addEventListener(\"change\",function(){\r\n        dn.g_settings.set(\"theme\",theme_drop_down.GetVal());\r\n    })\r\n    theme_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return theme_drop_down;\r\n}\r\n\r\ndn.create_syntax_menu = function(){\r\n    var modes = require(\"ace/ext/modelist\").modes;\r\n    \r\n    var syntax_drop_down = new DropDown(modes.map(function(m){return m.caption;}));\r\n    \r\n    syntax_drop_down.addEventListener(\"click\", dn.read_only_bail);\r\n    \r\n    syntax_drop_down.addEventListener(\"click\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"change\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return syntax_drop_down;\r\n}\r\n\r\n// ############################\r\n// File details stuff\r\n// ############################\r\ndn.read_only_bail = function(e){\r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"The file is read-only, so you cannot change its properties.\");\r\n        e.stopImmediatePropagation();\r\n       dn.focus_editor();\r\n    }\r\n}\r\ndn.create_file_details_tool = function(){\r\n    var els = [dn.el.details_title_text,\r\n               dn.el.details_description_text,\r\n               dn.el.file_newline_detect,\r\n               dn.el.file_newline_windows,\r\n               dn.el.file_newline_unix,\r\n               dn.el.file_tab_detect,\r\n               dn.el.file_tab_soft,\r\n               dn.el.file_tab_hard,\r\n               dn.el.file_ace_mode_detect];\r\n    for(var ii=0; ii< els.length; ii++)\r\n        els[ii].addEventListener(\"click\",dn.read_only_bail); //If file is read only, ReadOnlyBail will prevent the click handlers below from running.\r\n        \r\n    //Title change stuff\r\n    dn.el.details_title_text.addEventListener('click', function(){                \r\n            dn.el.details_title_text.style.display = 'none';\r\n            dn.el.details_title_input.style.display = '';\r\n            dn.el.details_title_input.focus();\r\n            dn.el.details_title_input.select();\r\n    });\r\n    dn.el.details_title_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_title_input.style.display = 'none';\r\n            dn.el.details_title_text.style.display = '';\r\n            var new_val = dn.el.details_title_input.value;\r\n            if(new_val == dn.the_file.title)\r\n                return;\r\n            dn.the_file.title = new_val\r\n            dn.show_file_title(); //includes showStatus\r\n            dn.apply_syntax_choice();\r\n            dn.save_file_title();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_title_input.addEventListener('keyup', function(e){\r\n            if(e.which == WHICH.ENTER)\r\n                dn.el.details_title_input.trigger('blur');\r\n    });\r\n    dn.el.details_title_input.addEventListener('keydown', function(e){\r\n        if(e.which == WHICH.ESC){\r\n            dn.el.details_title_input.value = dn.the_file.title;\r\n            dn.el.details_title_input.trigger('blur');\r\n            dn.ignore_escape = true; //stops ToggleWidget\r\n        }\r\n    });\r\n\r\n    // File action buttons stuff\r\n    dn.el.button_save.addEventListener('click', dn.save_content);\r\n    dn.el.button_print.addEventListener('click', dn.do_print);\r\n    dn.el.button_share.addEventListener('click', dn.do_share);\r\n    dn.el.button_history.addEventListener('click', dn.start_revisions_worker);\r\n\r\n    // Description stuff\r\n    dn.el.details_description_text.addEventListener('click', function(){            \r\n            dn.el.details_description_text.style.display = 'none';\r\n            dn.el.details_description_input.style.display = '';\r\n            dn.el.details_description_input.focus();\r\n    });\r\n    dn.el.details_description_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_description_input.style.display = 'none';\r\n            dn.el.details_description_text.style.display = '';\r\n            var new_val = dn.el.details_description_input.value;\r\n            if(dn.the_file.description === new_val)\r\n                return;\r\n            dn.the_file.description = new_val;\r\n            dn.show_description();\r\n            dn.save_file_description();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_description_input.addEventListener('keydown',function(e){\r\n            if(e.which == WHICH.ESC){\r\n                dn.el.details_description_input.value = dn.the_file.description;\r\n                dn.el.details_description_input.trigger('blur');\r\n                dn.ignore_escape = true;\r\n            }\r\n    });\r\n        \r\n    // File custom props stuff\r\n    dn.el.file_newline_detect.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"detect\");\r\n        dn.focus_editor();      \r\n    });\r\n    dn.el.file_newline_windows.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"windows\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_newline_unix.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"unix\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_tab_detect.classList.add('selected');\r\n    dn.el.file_tab_detect.addEventListener('click', function(){\r\n        dn.set_property(\"tabs\",\"detect\");\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_tab_soft.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",0);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_dec').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",-1);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_inc').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",+1);\r\n       dn.focus_editor();\r\n    })\r\n    dn.el.file_tab_hard.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"tab\",0);\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_ace_mode_detect.addEventListener('click', function(){\r\n       dn.set_property(\"aceMode\",\"detect\"); \r\n    });\r\n}\r\n\r\ndn.save_file_description = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    \r\n    dn.save_file(dn.the_file.file_id, {description: dn.the_file.description}, undefined, \r\n                $.proxy(dn.save_done,{description: ++dn.the_file.generation_to_save.description}))\r\n    dn.show_status();\r\n    return;\r\n    \r\n}\r\n\r\ndn.save_file_title = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    //TODO: mime-type IMPORTANT!\r\n\r\n    dn.save_file(dn.the_file.file_id, {title: dn.the_file.title}, undefined, \r\n                $.proxy(dn.save_done,{title: ++dn.the_file.generation_to_save.title}))\r\n    dn.show_status();    \r\n}\r\n\r\ndn.show_file_title = function(){\r\n    dn.el.details_title_text.textContent = 'Title: ' + dn.the_file.title;\r\n    dn.el.details_title_input.value = dn.the_file.title;\r\n    document.title = (dn.the_file.is_pristine ? \"\" : \"*\") + dn.the_file.title;\r\n    dn.show_status();\r\n}\r\n\r\ndn.show_description = function(){\r\n    text_multi(dn.el.details_description_text, 'Description: ' + dn.the_file.description,true);\r\n    dn.el.details_description_input.value = dn.the_file.description;\r\n}\r\n\r\n// ############################\r\n// Save stuff\r\n// ############################\r\n\r\ndn.save_content = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return false;\r\n    }\r\n    \r\n    if(!dn.the_file.is_pristine){\r\n        dn.the_file.data_to_save.body = dn.editor.getSession().getValue();\r\n        dn.the_file.generation_to_save.body++;\r\n        dn.el.ace_content.setAttribute('saving',true);\r\n        dn.the_file.is_saving = true;\r\n        dn.the_file.is_pristine = true;\r\n    }\r\n    \r\n    dn.show_file_title(); //includes a showstatus calls\r\n    dn.do_save();\r\n    return false;\r\n}\r\n\r\ndn.do_save = function (){\r\n    \r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"Cannot save read-only file.\");\r\n        return false;\r\n    }\r\n    \r\n    if(!(dn.the_file.data_to_save.body || dn.the_file.data_to_save.title || dn.the_file.data_to_save.description)){\r\n        dn.show_error(\"No changes since last save.\");\r\n        return false;\r\n    }\r\n\r\n    var gens = {};\r\n    var body, meta;\r\n    if(dn.the_file.data_to_save.body){\r\n        body = dn.the_file.data_to_save.body;\r\n        gens.body = dn.the_file.generation_to_save.body;\r\n    }\r\n    if(dn.the_file.data_to_save.title || dn.the_file.data_to_save.description){\r\n        meta = {};\r\n        if(dn.the_file.data_to_save.title){\r\n            meta.title = dn.the_file.data_to_save.title;\r\n            gens.title = dn.the_file.generation_to_save.title;\r\n        }\r\n        if(dn.the_file.data_to_save.description){\r\n            meta.description = dn.the_file.data_to_save.description; \r\n            gens.description = dn.the_file.generation_to_save.description;\r\n        }\r\n    }\r\n    dn.save_file(dn.the_file.file_id, meta, body, $.proxy(dn.save_done,gens))\r\n    return false;\r\n}\r\n\r\ndn.save_done = function(resp){\r\n    if(resp.error){\r\n        if(resp.error.code == 401){\r\n            dn.reauth(dn.do_save); //will make use of dn.the_file.data_to_save and generation_to_save once auth is done.\r\n        }else{\r\n            var failures = []\r\n            if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n                failures.push(\"body\");\r\n                dn.the_file.is_saving = false;\r\n                dn.the_file.is_pristine = false;\r\n                dn.show_file_title();\r\n                dn.el.ace_content.removeAttribute('saving');\r\n                dn.the_file.data_to_save.body = null;\r\n            }\r\n            if(this.title && this.title == dn.the_file.generation_to_save.title)\r\n                failures.push(\"title\");\r\n            if(this.description && this.description == dn.the_file.generation_to_save.description)\r\n                failures.push(\"description\");\r\n            \r\n            if(failures.length){//it's possible that all parts of the save request have since been superceded, so we can ignore this failure\r\n                dn.show_error(\"Failed to save \" +  oxford_comma(failures) + \". Error #\" + resp.error.code + (resp.error.message? \"\\n\" + resp.error.message : \"\"));\r\n                console.dir(resp);\r\n            }            \r\n        }\r\n    }else{//success...\r\n        if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n            dn.the_file.is_saving = false;\r\n            dn.el.ace_content.removeAttribute('saving');\r\n            dn.the_file.ext = resp.fileExtension;\r\n            dn.g_settings.set('ext',resp.fileExtension);\r\n            dn.the_file.data_to_save.body = null;\r\n            \r\n            if(dn.the_file.is_brand_new)\r\n                dn.saved_new_file(resp); \r\n        }\r\n        if(this.title && this.title == dn.the_file.generation_to_save.title){\r\n            dn.the_file.data_to_save.title = null;\r\n        }\r\n        if(this.description && this.description == dn.the_file.generation_to_save.description){\r\n            dn.the_file.data_to_save.description = null;\r\n        }\r\n\r\n    }\r\n    dn.show_status();\r\n}\r\n\r\ndn.save_file = function (fileId, fileMetadata, fileText, callback) {\r\n    //if fileId is null then a new file is created (can set fileMetadata.parentNodes = [parentFolderId])\r\n    //fileMetadata or fileText can be null.\r\n    //See https://developers.google.com/drive/v2/reference/files/insert - Request Body for valid metaData.\r\n\r\n    //build a multipart message body\r\n    var boundary = dn.make_boundary();\r\n    var delimiter = \"\\r\\n--\" + boundary + \"\\r\\n\";\r\n    var close_delim = \"\\r\\n--\" + boundary + \"--\";\r\n\r\n    var messageBody = delimiter +\r\n                'Content-Type: application/json\\r\\n' +\r\n                '\\r\\n' + JSON.stringify(fileMetadata ? fileMetadata : {}); //note than in the multipart message upload you must provide some json metadata, even if it's empty.\r\n\r\n    if(fileText){ \r\n        messageBody += delimiter +\r\n                'Content-Type: application/octet-stream\\r\\n' +\r\n                'Content-Transfer-Encoding: base64\\r\\n' +\r\n                '\\r\\n' + btoa(unescape(encodeURIComponent(fileText))); //javascript strings are utf16 encoded, but btoa only accespts ASCII, somehow the two extra functions here smooth over this problem and produce the expected result at the server end.\r\n    }\r\n    messageBody += close_delim;\r\n\r\n    var request = gapi.client.request({\r\n        path: '/upload/drive/v2/files/' + (fileId ? fileId : \"\"),\r\n        method: (fileId? 'PUT' : 'POST'),\r\n        params: {'uploadType': 'multipart'},\r\n        headers: {'Content-Type': 'multipart/mixed; boundary=\"' + boundary + '\"'} ,\r\n        body:   messageBody}\r\n        );\r\n\r\n    request.execute(callback);\r\n}\r\n\r\ndn.make_boundary = function(){\r\n    //for MIME protocol, require a boundary that doesn't exist in the message content.\r\n    //we could check explicitly, but this is essentially guaranteed to be fine:\r\n    // e.g. \"13860126288389.206091766245663\"\r\n    return (new Date).getTime() + \"\" + Math.random()*10;\r\n}\r\n\r\n\r\n// ############################\r\n// Print stuff\r\n// ############################\r\n\r\ndn.do_print = function(){\r\n    var content = dn.editor.session.doc.getAllLines();\r\n    var html = Array(content.length);\r\n\r\n    for(var i=0; i<content.length;i++)\r\n        html[i] = \"<li><div class='printline'>\" + dn.line_tohtml(i) + '</div></li>';\r\n\r\n    var printWindow = window.open('','');\r\n    printWindow.document.writeln(\r\n            \"<html><head><title>\" + dn.the_file.title \r\n            + \"</title></head><style>\"\r\n            + ace.require('ace/theme/' + dn.g_settings.get('theme')).cssText + \"\\nbody{font-size:\"\r\n            + dn.g_settings.get('fontSize') *14 +\"px; white-space:pre-wrap;\" + \r\n            \"font-family:'Monaco','Menlo','Ubuntu Mono','Droid Sans Mono','Consolas',monospace;}\"\r\n            + \"\\nli{color:gray;}\\n.printline{color:black;}</style>\" + \r\n            \"<body class='ace-\"+ dn.g_settings.get('theme') +\"'><ol id='content'>\" + \r\n            html.join(\"\") +\r\n            \"</ol></body></html>\");\r\n    printWindow.print();\r\n    return false;\r\n}\r\n\r\ndn.line_tohtml = function (n){\r\n    var printLayer = Object.create(ace.require('ace/layer/text').Text.prototype); \r\n    var tokens  = dn.editor.getSession().getTokens(n);\r\n    var html = [];\r\n    var screenColumn = 0;\r\n    for (var i = 0; i < tokens.length; i++) {\r\n       var token = tokens[i];\r\n       var value = token.value.replace(/\\t/g,'   ');//TODO:deal with tabs properly\r\n       if(value)\r\n           printLayer.$renderToken(html, 0, token, value);\r\n    }\r\n    return html.join('').replace(/&#160;/g,' ');\r\n}\r\n\r\n\r\n// ############################\r\n// Clipboard stuff\r\n// ############################\r\n\r\ndn.document_clipboard_left = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index <= 0)\r\n            return true;\r\n        dn.clipboard_index--;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_right = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index >= dn.g_clipboard.length-1)\r\n            return true;\r\n\r\n        dn.clipboard_index++;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_keyup = function(e){\r\n    if(e.which == 17 || e.which == 91 || !e.ctrlKey){\r\n        $(document).off('keyup',dn.document_clipboard_keyup);\r\n        dn.clipboard_active = false;\r\n        dn.el.pane_clipboard.style.display = 'none';\r\n        if(dn.clipboard_info_timer){\r\n            clearTimeout(dn.clipboard_info_timer);\r\n            dn.clipboard_info_timer = null;\r\n        }\r\n    }\r\n}\r\n\r\ndn.on_paste = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    $(document).on('keyup',dn.document_clipboard_keyup);\r\n    dn.clipboard_active = true;\r\n        \r\n    dn.clipboard_index = dn.g_clipboard.lastIndexOf(text); \r\n    if(dn.clipboard_index == -1){ //it's possible the user copied some text from outside the DN, in which case we will add it to the clipboard now\r\n       dn.clipboard_index = dn.g_clipboard.push(text);\r\n       while(dn.g_clipboard.length >dn.clipboard_max_length) //same as on copy\r\n         dn.g_clipboard.remove(0);\r\n    }\r\n    if(dn.clipboard_info_timer)\r\n        clearTimeout(dn.clipboard_info_timer);\r\n\r\n    dn.clipboard_info_timer = setTimeout(function(){\r\n        dn.clipboard_info_timer = null;\r\n        dn.el.pane_clipboard.style.display = '';\r\n    },dn.clipboard_info_delay);\r\n}\r\n\r\ndn.on_copy = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    dn.g_clipboard.push(text);\r\n    while(dn.g_clipboard.length >dn.clipboard_max_length)\r\n        dn.g_clipboard.remove(0);\r\n}\r\n\r\ndn.create_clipboard_tool = function(){\r\n    dn.el.pane_clipboard = document.getElementById('pane_clipboard');\r\n    dn.el.button_clear_clipboard.addEventListener('click', function(){\r\n            dn.g_clipboard.clear();\r\n    });\r\n    dn.el.button_clear_find_replace.addEventListener('click', function(){\r\n            dn.g_find_history.clear();\r\n    });\r\n}\r\n\r\n\r\n// ############################\r\n// New file stuff\r\n// ############################\r\n\r\ndn.do_new = function(){\r\n    //TODO: this could actually just be a link, updated in settingschanged-ext\r\n    var base = window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0];\r\n    window.open(base + \"?state=\" + JSON.stringify({\r\n                action: \"create\",\r\n                folderId: dn.the_file.folder_id ? dn.the_file.folder_id : '',\r\n                ext: dn.g_settings.get('ext')}),\"_blank\");\r\n    return false;\r\n}\r\n\r\ndn.create_new_tool = function(){\r\n    dn.el.menu_new.addEventListener('click', dn.do_new);\r\n}\r\n\r\ndn.create_file = function(){\r\n    dn.apply_syntax_choice();\r\n    dn.the_file.is_brand_new = true;\r\n    dn.show_file_title();\r\n    dn.show_description();\r\n    dn.apply_newline_choice();\r\n    dn.apply_tab_choice();\r\n    dn.g_settings.set(\"pane\",\"pane_file\");  \r\n}\r\n\r\ndn.guess_mime_type = function(){\r\n    // we set the mimeType on new files, it's too complicated to try and guess it otherwise (at least for now)\r\n    if(dn.the_file.loaded_mime_type)\r\n        return dn.the_file.loaded_mime_type;\r\n    var plain = \"text/plain\";\r\n    var ext = dn.the_file.title.match(/\\.[0-9a-z]+$/i);\r\n\r\n    if(!ext)\r\n        return plain;\r\n    else\r\n        ext = ext[0].substr(1);\r\n    \r\n    return (ext in dn.ext_to_mime_type)? dn.ext_to_mime_type[ext] : plain;\r\n\r\n}\r\n\r\ndn.save_new_file = function(){\r\n    var f = dn.the_file;\r\n    if(f.is_saving){\r\n        dn.show_error(\"File is being created. Please wait.\");\r\n        return false;\r\n    }\r\n    var meta = {title: f.title, \r\n                description: f.description,\r\n                mimeType: dn.guess_mime_type()};\r\n    var parentId = f.folderId;\r\n    if(parentId) \r\n        meta.parentNodes =[{id:[parentId]}];\r\n    f.data_to_save.body = dn.editor.getSession().getValue();\r\n    f.data_to_save.title = meta.title;\r\n    f.data_to_save.description = meta.description;\r\n    var gens = {title: ++f.generation_to_save.title, description: ++f.generation_to_save.description,body: ++f.generation_to_save.body};\r\n    f.is_saving = true;\r\n    f.is_pristine = true;\r\n    dn.show_file_title();\r\n    dn.el.ace_content.setAttribute('saving', true);\r\n    dn.show_status();\r\n    dn.save_file(null, meta, f.data_to_save.body, $.proxy(dn.save_done,gens));\r\n}\r\n\r\ndn.saved_new_file = function(resp){\r\n    dn.the_file.is_brand_new = false;\r\n    dn.the_file.file_id = resp.id;\r\n    dn.the_file.is_shared = resp.shared;\r\n    dn.status.file_sharing = 1;\r\n    dn.the_file.ext = resp.fileExtension;\r\n    history.replaceState({},dn.the_file.title,\r\n            window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0] +\r\n                \"?state={\\\"action\\\":\\\"open\\\",\\\"ids\\\":[\\\"\" + dn.the_file.file_id + \"\\\"]}\");\r\n    dn.set_drive_link_to_folder();\r\n    dn.save_all_file_properties();\r\n}\r\n\r\n// ############################\r\n// Scrolling stuff\r\n// ############################\r\n\r\ndn.save_scroll_line = function(){\r\n    dn.patch_property(dn.the_file.file_id, \r\n                    \"ScrollToLine\",\r\n                    dn.get_scroll_line(),\r\n                    'PUBLIC',null);\r\n}\r\n\r\ndn.get_scroll_line = function(){\r\n    return  dn.editor.getSession().screenToDocumentPosition(dn.editor.renderer.getScrollTopRow(),0).row;\r\n}\r\n\r\n// ############################\r\n// Load stuff\r\n// ############################\r\n\r\n\r\ndn.load_file = function(flag){\r\n    //we assume that we only ever load one fileid per page load\r\n    var file_id = dn.the_file.file_id; \r\n\r\n    dn.show_status();\r\n\r\n    /*TODO dn.reauth */\r\n    \r\n    dn.status.file_meta = 0;\r\n    var promise_get_meta = Promise.resolve(\r\n        gapi.client.request({\r\n            'path': '/drive/v3/files/' + file_id,\r\n            'params':{'fields': 'name,mimeType,description,parents,capabilities,fileExtension,shared'}}))\r\n        .then(dn.load_file_got_meta_data, function(err){\r\n            dn.show_error(err.result.error.message);\r\n            dn.status.file_meta = -1;\r\n            dn.show_status();\r\n            throw err;\r\n        })\r\n\r\n    dn.status.file_body = 0;\r\n    var promise_get_body = Promise.resolve(\r\n        gapi.client.request({\r\n            'path': '/drive/v3/files/' + file_id,\r\n            'params':{'alt': 'media'}\r\n        }))            \r\n        .then(dn.load_file_got_file_body, function(err){\r\n            dn.show_error(err.result.error.message);\r\n            dn.status.file_body = -1;\r\n            dn.show_status();\r\n            throw err;\r\n        });\r\n\r\n    \r\n    dn.pr_the_file = Promise.all([promise_get_meta, promise_get_body])\r\n    .then(function(){ \r\n        //success\r\n    }, function(){\r\n        // failure\r\n        document.title = \"Drive Notepad\";\r\n        dn.g_settings.set('pane', 'pane_help');\r\n        dn.g_settings.set('pane_open', true);\r\n        \r\n    })\r\n    \r\n}\r\n\r\ndn.load_file_got_meta_data = function(resp) {\r\n    if (resp.error)\r\n        throw Error(resp.error);\r\n    dn.the_file.title = resp.result.name;\r\n    dn.the_file.description = resp.result.description || '';\r\n    dn.show_description();\r\n    dn.the_file.ext = resp.result.fileExtension\r\n    dn.the_file.is_read_only = !resp.result.capabilities.canEdit;\r\n    dn.the_file.is_shared = resp.result.shared; \r\n    dn.the_file.loaded_mime_type = resp.result.mimeType;\r\n    if(resp.result.parents && resp.result.parents.length){\r\n        dn.the_file.folder_id = resp.result.parents[0];\r\n        dn.set_drive_link_to_folder();\r\n    }\r\n    dn.show_file_title(); //includes a showStatus call\r\n    dn.status.file_meta = 1;\r\n    dn.show_status();\r\n} \r\n\r\ndn.load_file_got_file_body = function(resp){\r\n    dn.show_status();\r\n    dn.setting_session_value = true;\r\n    dn.editor.session.setValue(resp.body);\r\n    dn.setting_session_value = false;\r\n    dn.apply_newline_choice(resp.body);\r\n    dn.apply_syntax_choice();\r\n    dn.apply_tab_choice(); \r\n    dn.status.file_body = 1;\r\n    dn.show_status();\r\n}\r\n\r\n\r\n// ############################\r\n// Change/history stuff\r\n// ############################\r\n\r\ndn.on_change = function(e){\r\n    //console.dir(e);\r\n\r\n    if(!e.start || !e.end || dn.setting_session_value)\r\n        return;\r\n        \r\n    if(dn.the_file.is_pristine){\r\n        dn.the_file.is_pristine = false;\r\n        dn.show_file_title();\r\n        dn.show_status();\r\n    }\r\n\r\n    if(!dn.g_settings.get('showGutterHistory'))\r\n        return;\r\n\r\n    var nClasses = dn.change_line_classes.length-1;\r\n    var h = dn.change_line_history;\r\n    var s = dn.editor.getSession(); \r\n\r\n    var start_row = e.start.row;\r\n    var end_row = e.end.row;\r\n\r\n    if(dn.last_change && dn.last_change.start_row == start_row && dn.last_change.end_row == end_row && start_row == end_row\r\n        && dn.last_change.action.indexOf(\"Text\") != -1 && e.action.indexOf(\"Text\") != -1){\r\n            //if this change and the last change were both on the same single lines with action (insert|remove)Text...\r\n\r\n            if(dn.last_change.action == e.action){\r\n                return; //same action as last time\r\n            }else if(e.action == \"removeText\"){ // new action is removeText, old action was insertText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                h[start_row] = -nClasses;\r\n                dn.last_change.action = \"removeText\";\r\n                return;\r\n            }else{// new action is isnertText, old action was removeText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                h[start_row] = nClasses;\r\n                dn.last_change.action = \"insertText\";\r\n                return;\r\n            }\r\n\r\n    }else{\r\n        //otherwise we have an acutal new change\r\n        dn.last_change = {start_row: start_row, end_row: end_row, action: e.action};\r\n    }\r\n\r\n    //remove all visible decorations and update the changeLineHistory values (we'll add in the new classes at the end)\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.removeGutterDecoration(i,h[i] < 0 ? \r\n                    dn.change_line_classes_rm[-h[i]++] : \r\n                    dn.change_line_classes[h[i]--]);\r\n\r\n    //Update the changeLineHistory relating to the current changed lines\r\n    if(e.action == \"removeLines\"){\r\n        h.splice(start_row, end_row - start_row + 1);        \r\n        h[start_row] = h[start_row+1] = -nClasses;\r\n    }else if(e.action === \"removeText\"){\r\n        h[start_row] = -nClasses;\r\n    }else{\r\n        var newLineCount = 0;\r\n        if(e.action == \"insertText\")\r\n            newLineCount = (e.text.match(/\\n/g) || []).length;\r\n        if(e.action == \"insertLines\")\r\n            newLineCount = e.lines.length;\r\n        h.splice.apply(h,[start_row,0].concat(Array(newLineCount)));\r\n\r\n        for(var i=start_row;i<=end_row;i++)\r\n            h[i] = nClasses;\r\n\r\n    }\r\n\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.addGutterDecoration(i,h[i]<0 ?\r\n                dn.change_line_classes_rm[-h[i]] :\r\n                dn.change_line_classes[h[i]]);\r\n} \r\n\r\ndn.query_unload = function(){\r\n    if(!dn.the_file.is_pristine)\r\n        return \"If you leave the page now you will loose the unsaved \" + (dn.the_file.is_brand_new ? \"new \" : \"changes to \") + \"file '\" + dn.the_file.title + \"'.\"\r\n}\r\n\r\n\r\n// ############################\r\n// Properties stuff\r\n// ############################\r\ndn.property_updated = function(propKey,new_val){\r\n    console.log(\"[file custom property]  \" + propKey + \": \" + new_val);\r\n    switch(propKey){\r\n        case \"newline\":\r\n            dn.apply_newline_choice();\r\n            break;\r\n        case \"tabs\":            \r\n            dn.apply_tab_choice();\r\n            break;\r\n        case \"aceMode\":\r\n            dn.apply_syntax_choice();\r\n            break;\r\n    }\r\n    \r\n}\r\n\r\ndn.load_default_properties = function(){\r\n    for(var k in dn.default_custom_props)\r\n        dn.set_property(k,dn.default_custom_props[k]);\r\n}\r\n\r\ndn.get_properties_from_cloud = function() {    \r\n    // TODO:\r\n    /*\r\n    gapi.client.drive.properties.list({\r\n    'fileId': dn.the_file.file_id\r\n    }).execute(dn.got_all_file_properties);*/\r\n}\r\n\r\ndn.got_all_file_properties = function(resp){\r\n    if(resp.items){\r\n        dn.the_file.custom_prop_exists = {};\r\n        for(var i=0;i<resp.items.length;i++){\r\n            dn.the_file.custom_props[resp.items[i].key] = resp.items[i].value;\r\n            dn.the_file.custom_prop_exists[resp.items[i].key] = true;\r\n            dn.property_updated(resp.items[i].key,resp.items[i].value);\r\n        }\r\n    }\r\n}\r\n\r\ndn.save_all_file_properties = function(){\r\n    //To be used after creating a file, in order to set any of the props which had been modified before saving it\r\n    for(var k in dn.the_file.custom_props)\r\n        dn.set_property(k,dn.the_file.custom_props[k]);    \r\n}\r\n\r\ndn.set_property = function(prop_name,new_val){\r\n\r\n    var oldVal = dn.the_file.custom_props[prop_name]; \r\n    dn.the_file.custom_props[prop_name] = new_val;\r\n    if(oldVal !== new_val)\r\n        dn.property_updated(prop_name,new_val);\r\n\r\n    if(!(gapi && gapi.drive && dn.the_file.file_id))\r\n        return;\r\n\r\n    var dummyCallback = function(){}; //TODO: may want to do some error handling or something\r\n    \r\n    if(dn.default_custom_props[prop_name] == new_val){ //note that this is true in particular when SetProperty is called within LoadDefaultProperties\r\n        if(dn.the_file.custom_prop_exists[prop_name]){\r\n             dn.the_file.custom_prop_exists[prop_name] = false;\r\n             gapi.client.drive.properties.delete({ //DELTE the property, which does exist, but is no longer required because the value has been set to the default\r\n                fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC'\r\n                }).execute(dummyCallback);\r\n        }\r\n        //if the property doesn't exist and it's just been set to the default then we don't need to do anything.\r\n    }else{            \r\n        if(dn.the_file.custom_prop_exists[prop_name] && oldVal !== new_val){\r\n            gapi.client.drive.properties.patch({ //PATCH the property, which already exists\r\n            fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC', resource: {'value': new_val}\r\n            }).execute(dummyCallback);\r\n        }else{\r\n            dn.the_file.custom_prop_exists[prop_name] = true; //INSERT the property, because it doesn't yet exist, we may be coming via dn.save_all_file_properties() above\r\n            gapi.client.drive.properties.insert({\r\n            'fileId': dn.the_file.file_id, 'resource': {key: prop_name, value: new_val, visibility: 'PUBLIC'}\r\n            }).execute(dummyCallback)\r\n        }\r\n    }\r\n}\r\n\r\n\r\n// ############################\r\n// Drag-drop stuff\r\n// ############################\r\n//TODO: this may have a few bugs since it's not been tested for a while\r\n\r\ndn.document_drag_over = function (evt) {\r\n    evt = evt.originalEvent;\r\n    evt.stopPropagation();\r\n    evt.preventDefault();\r\n    if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine)){\r\n        evt.dataTransfer.dropEffect = 'none';\r\n        if(dn.can_show_drag_drop_error){\r\n            dn.show_error(\"File drag-drop is only permitted when the Drive Notpad page is displaying a new and unmodified file.\")\r\n            dn.can_show_drag_drop_error = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n            setTimeout(function(){dn.can_show_drag_drop_error = true;},dn.error_delay_ms);\r\n        }\r\n        return;\r\n    }\r\n    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.\r\n}\r\n    \r\ndn.document_drop_file = function(evt){\r\n     if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine))\r\n        return;\r\n        \r\n   evt = evt.originalEvent;\r\n   evt.stopPropagation();\r\n   evt.preventDefault();\r\n   \r\n   var files = evt.dataTransfer.files;\r\n   if(files.length > 1){\r\n       dn.show_error(\"You cannot drag-drop multiple files onto the Drive Notepad page, only individual files.\")\r\n   }\r\n   var file = files[0];\r\n   dn.the_file.title = file.name;\r\n   dn.create_file();\r\n   dn.the_file.isReading_file_object = true;   \r\n   dn.show_status();\r\n   var r = new FileReader();\r\n   r.onload = dn.dropped_file_read;\r\n   r.readAsText(file);      \r\n}\r\n\r\ndn.dropped_file_read = function(e){\r\n    dn.the_file.isReading_file_object = false;\r\n    dn.editor.getSession().setValue(e.target.result);\r\n    // Note we don't encolse the above in a dn.setting_session_value = true block so the change event will fire and set pristine to false and ShowStatus etc.\r\n}\r\n\r\ndn.focus_editor = function(){\r\n   dn.editor.focus();\r\n}\r\n// ############################\r\n// Page ready stuff\r\n// ############################\r\n\r\n\r\ndn.document_ready = function(e){\r\n\r\n    // widget :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.the_widget = document.getElementById('the_widget');\r\n    dn.el.widget_text = document.getElementById('widget_text');\r\n    dn.el.widget_error_text = document.getElementById('widget_error_text');\r\n    dn.el.widget_error = document.getElementById('widget_error');\r\n    dn.el.widget_content = document.getElementById('widget_content');\r\n    dn.el.the_widget.addEventListener('mousedown', dn.widget_mouse_down);\r\n    translate(dn.el.the_widget, 0, 0);\r\n    dn.el.the_widget.style.display = '';\r\n    dn.el.widget_error.style.display = 'none';\r\n    dn.el.widget_content.addEventListener('mousedown', function(e){\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    });\r\n    var els = dn.el.widget_content.getElementsByTagName('input');\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].addEventListener('mousedown', stop_propagation); // prevents propagation to preventDefault, installed above.\r\n\r\n    // editor :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    var editor_el = document.getElementById('the_editor');\r\n    editor_el.innerHTML = '';\r\n    editor_el.addEventListener('contextmenu', function(e){\r\n        dn.show_error(\"See the list of keyboard shortcuts for copy/paste, select-all, and undo/redo.\")\r\n    });\r\n    dn.editor = ace.edit(\"the_editor\");\r\n    dn.editor.setHighlightSelectedWord(true);\r\n    dn.el.ace_content = document.getElementsByClassName('ace_content')[0];\r\n    dn.editor.getSession().addEventListener(\"change\", dn.on_change);\r\n    dn.focus_editor();\r\n    dn.editor.on(\"paste\", dn.on_paste);\r\n    dn.editor.on(\"copy\", dn.on_copy);\r\n    dn.editor.setAnimatedScroll(true);\r\n    dn.editor.$blockScrolling = Infinity; // disables scrolling message\r\n    \r\n    // widget menu ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.widget_menu = document.getElementById('widget_menu');\r\n    dn.el.menu_open = document.getElementById('menu_open');\r\n    dn.el.menu_find = document.getElementById('menu_find');\r\n    dn.el.menu_help = document.getElementById('menu_help');\r\n    dn.el.menu_file = document.getElementById('menu_file');\r\n    dn.el.menu_general_settings = document.getElementById('menu_general_settings');\r\n    dn.el.widget_menu.addEventListener('mousedown', stop_propagation);\r\n    dn.menu_icon_from_pane_id = {}\r\n    var els = dn.el.widget_menu.getElementsByClassName('widget_menu_wrapper');\r\n    for(var ii=0; ii<els.length; ii++){\r\n        els[ii].addEventListener(\"mousedown\", prevent_default);\r\n        els[ii].title = dn.menu_id_to_caption[els[ii].id];\r\n        els[ii].innerHTML = \"<div class='widget_menu_icon' id='icon_\" + els[ii].id + \"'></div>\";\r\n        var el_icon = els[ii].getElementsByClassName('widget_menu_icon')[0];\r\n        dn.menu_icon_from_pane_id['pane_' + els[ii].id.substr(5)] = el_icon;\r\n    }\r\n\r\n     // pane file ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_file = document.getElementById('pane_file');\r\n    dn.el.details_title_input  = document.getElementById('details_file_title_input');\r\n    dn.el.details_title_text = document.getElementById('details_file_title_text');\r\n    dn.el.details_description_input  = document.getElementById('details_file_description_input');\r\n    dn.el.details_description_text = document.getElementById('details_file_description_text');    \r\n    dn.el.file_ace_mode_choose = document.getElementById('file_ace_mode_choose')\r\n    dn.el.file_ace_mode_detect = document.getElementById('file_ace_mode_detect');\r\n    dn.el.file_ace_mode_info = document.getElementById('file_ace_mode_info');\r\n    dn.el.file_newline_detect = document.getElementById('file_newline_detect');\r\n    dn.el.file_newline_windows = document.getElementById('file_newline_windows');\r\n    dn.el.file_newline_unix = document.getElementById('file_newline_unix');\r\n    dn.el.file_newline_info = document.getElementById('file_newline_info');\r\n    dn.el.file_tab_detect = document.getElementById('file_tab_detect');\r\n    dn.el.file_tab_hard = document.getElementById('file_tab_hard');\r\n    dn.el.file_tab_soft = document.getElementById('file_tab_soft');\r\n    dn.el.file_tab_soft_text = document.getElementById('file_tab_soft_text');\r\n    dn.el.file_tab_info = document.getElementById('file_tab_info');\r\n    dn.el.button_save = document.getElementById('button_save');\r\n    dn.el.button_print = document.getElementById('button_print');\r\n    dn.el.button_share = document.getElementById('button_share');\r\n    dn.el.button_history = document.getElementById('button_history');     \r\n    dn.syntax_drop_down = dn.create_syntax_menu();   // TODO: tidy up\r\n    dn.el.file_ace_mode_choose.appendChild(dn.syntax_drop_down.el);\r\n    dn.create_file_details_tool();\r\n    dn.el.menu_file.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_file');\r\n    })\r\n\r\n     // pane general settings :::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_general_settings = document.getElementById('pane_general_settings');\r\n    dn.el.theme_chooser = document.getElementById('theme_chooser')\r\n    dn.el.widget_sub_general_box = document.getElementById('sub_general_box')\r\n    dn.el.button_clear_clipboard = document.getElementById(\"button_clear_clipboard\");\r\n    dn.el.button_clear_find_replace = document.getElementById(\"button_clear_find_replace\");\r\n    dn.el.gutter_history_show = document.getElementById('gutter_history_show');\r\n    dn.el.gutter_history_hide = document.getElementById('gutter_history_hide');\r\n    dn.el.word_wrap_off = document.getElementById('word_wrap_off');\r\n    dn.el.word_wrap_at = document.getElementById('word_wrap_at');\r\n    dn.el.word_wrap_edge = document.getElementById('word_wrap_edge');\r\n    dn.el.font_size_decrement = document.getElementById('font_size_decrement');\r\n    dn.el.font_size_increment = document.getElementById('font_size_increment');\r\n    dn.el.font_size_text = document.getElementById('font_size_text');\r\n    dn.el.tab_hard = document.getElementById('tab_hard');\r\n    dn.el.tab_soft = document.getElementById('tab_soft');\r\n    dn.el.newline_menu_windows = document.getElementById('newline_menu_windows');\r\n    dn.el.newline_menu_unix = document.getElementById('newline_menu_unix');\r\n    dn.el.tab_soft_text = document.getElementById('tab_soft_text');\r\n    dn.el.tab_soft_dec = document.getElementById('tab_soft_dec');\r\n    dn.el.tab_soft_inc = document.getElementById('tab_soft_inc');\r\n    dn.el.word_wrap_at_text = document.getElementById('word_wrap_at_text');\r\n    dn.el.word_wrap_at_dec = document.getElementById('word_wrap_at_dec');\r\n    dn.el.word_wrap_at_inc = document.getElementById('word_wrap_at_inc');\r\n    dn.theme_drop_down = dn.create_theme_menu()  // TODO: tidy this up\r\n    dn.el.theme_chooser.appendChild(dn.theme_drop_down.el);\r\n    dn.el.newline_menu_windows.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'windows');\r\n    });\r\n    dn.el.newline_menu_unix.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'unix');\r\n    });\r\n    dn.el.tab_hard.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 1)\r\n    });\r\n    dn.el.tab_soft.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 0);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') - 1;\r\n        at = at < dn.min_soft_tab_n ? dn.min_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') + 1;\r\n        at = at > dn.max_soft_tab_n ? dn.max_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.font_size_decrement.addEventListener('click', dn.font_size_decrement_click);\r\n    dn.el.font_size_increment.addEventListener('click', dn.font_size_increment_click);    \r\n    dn.el.word_wrap_off.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[0,0,0])\r\n    });\r\n    dn.el.word_wrap_at.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt');\r\n        dn.g_settings.set('wordWrap',[1,at,at]);\r\n    });\r\n    dn.el.word_wrap_at_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') - dn.wrap_at_increment;\r\n        at = at < dn.min_wrap_at ? dn.min_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_at_inc.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') + dn.wrap_at_increment;\r\n        at = at > dn.max_wrap_at ? dn.max_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_edge.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[1,null,null])\r\n    });\r\n    dn.el.gutter_history_show.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',1);\r\n    });\r\n    dn.el.gutter_history_hide.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',0);\r\n    });\r\n    dn.create_clipboard_tool();\r\n    dn.el.menu_general_settings.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_general_settings');\r\n    })\r\n\r\n    // pane permissions :::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_permissions = document.getElementById('pane_permissions');\r\n    document.getElementById('button_auth').addEventListener('click', dn.launch_popup);\r\n\r\n    // pane help ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_help = document.getElementById('pane_help');\r\n    dn.el.user_name = document.getElementById('user_name');\r\n    dn.el.pane_help_shortcuts = document.getElementById('pane_help_shortcuts');\r\n    dn.el.pane_help_tips = document.getElementById('pane_help_tips');\r\n    dn.el.pane_help_main = document.getElementById('pane_help_main');\r\n    dn.el.button_shortcuts = document.getElementById('button_view_shortcuts');\r\n    dn.el.button_tips = document.getElementById('button_view_tips');\r\n    dn.el.button_shortcuts.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'shortcuts')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'shortcuts');\r\n    })\r\n    dn.el.button_tips.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'tips')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'tips');\r\n    })\r\n    dn.el.menu_help.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_help');\r\n    })\r\n    dn.create_pane_shortcuts();\r\n\r\n    // pane find ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::    \r\n    dn.el.pane_find = document.getElementById('pane_find');\r\n    dn.el.find_button_case_sensitive = document.getElementById('button_find_case_sensitive');\r\n    dn.el.find_button_whole_words = document.getElementById('button_find_whole_words');\r\n    dn.el.find_button_regex = document.getElementById('button_find_regex');\r\n    dn.el.find_input = document.getElementById('find_input');\r\n    dn.el.find_goto_input = document.getElementById('goto_input');\r\n    dn.el.find_replace_input = document.getElementById('find_replace_input');\r\n    dn.el.find_info = document.getElementById('find_info');\r\n    dn.el.find_results = document.getElementById('find_results');\r\n    dn.el.find_info_overflow = document.getElementById('find_info_overflow');\r\n    dn.el.button_goto = document.getElementById('button_goto');\r\n    dn.el.button_replace = document.getElementById('button_replace');\r\n    dn.el.find_goto_wrapper = document.getElementById('find_goto_wrapper');\r\n    dn.el.find_find_wrapper = document.getElementById('find_find_wrapper');\r\n    dn.el.find_replace_wrapper = document.getElementById('find_replace_wrapper');\r\n    dn.el.button_find_replace_all = document.getElementById('button_find_replace_all');\r\n    dn.el.find_button_case_sensitive.addEventListener('click', function(){\r\n        dn.g_settings.set('find_case_sensitive', !dn.g_settings.get('find_case_sensitive'));\r\n    })\r\n    dn.el.find_button_whole_words.addEventListener('click', function(){\r\n        dn.g_settings.set('find_whole_words', !dn.g_settings.get('find_whole_words'));\r\n    })\r\n    dn.el.find_button_regex.addEventListener('click', function(){\r\n        dn.g_settings.set('find_regex', !dn.g_settings.get('find_regex'));\r\n    })\r\n    dn.el.menu_find.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_find');\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    });\r\n    dn.el.find_goto_input.addEventListener('keydown', dn.find_goto_input_keydown);\r\n    dn.el.find_goto_input.addEventListener('keyup', dn.find_goto_input_keyup);\r\n    dn.el.find_goto_input.addEventListener('blur', dn.find_goto_input_blur);\r\n    dn.el.find_goto_input.addEventListener('focus', dn.find_goto_input_focus);\r\n    dn.el.find_input.addEventListener('keyup', dn.find_input_keyup);\r\n    dn.el.find_input.addEventListener('keydown', dn.find_input_keydown);\r\n    dn.el.find_input.addEventListener('blur', dn.find_inputs_blur);\r\n    dn.el.find_input.addEventListener('focus', dn.find_inputs_focus);\r\n    dn.el.find_replace_input.addEventListener('blur', dn.find_inputs_blur);\r\n    dn.el.find_replace_input.addEventListener('focus', dn.find_inputs_focus);\r\n    dn.el.find_replace_input.addEventListener('keydown', dn.find_replace_input_keydown);\r\n    dn.el.button_find_replace_all.addEventListener('click', dn.find_replace_click);\r\n    dn.el.button_replace.addEventListener('click', function(){\r\n        dn.g_settings.set('find_replace', !dn.g_settings.get('find_replace'));\r\n        dn.g_settings.set('find_goto', false);\r\n        dn.el.find_input.focus();\r\n    })\r\n    dn.el.button_goto.addEventListener('click', function(){\r\n        dn.g_settings.set('find_goto', !dn.g_settings.get('find_goto'));\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    })\r\n\r\n    // pane open ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_open = document.getElementById('pane_open');\r\n    dn.el.opener_button_a = document.getElementById('opener_button_a');\r\n    dn.el.opener_button_b = document.getElementById('opener_button_b');\r\n    dn.el.menu_open.addEventListener('click', function(){    \r\n        dn.g_settings.set('pane', 'pane_open');\r\n    });\r\n    dn.el.opener_button_a.addEventListener('click', dn.do_open);\r\n    dn.el.opener_button_b.addEventListener('click', dn.do_open);\r\n    dn.el.find_goto_input.addEventListener('focus', dn.find_goto_focus);\r\n    dn.el.find_goto_input.addEventListener('blur', dn.find_goto_blur);\r\n    // :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.make_keyboard_shortcuts();\r\n    dn.load_default_settings();\r\n    dn.load_default_properties();    \r\n    document.addEventListener('contextmenu', prevent_default);\r\n    document.addEventListener('dragover', dn.document_drag_over);\r\n    document.addEventListener('drop', dn.document_drop_file);\r\n    window.addEventListener('resize', dn.widget_apply_anchor);\r\n    window.onbeforeunload = dn.query_unload;\r\n\r\n    //work out what caused the page to load\r\n    var params = window_location_to_params_object(); \r\n    if(params['state']){\r\n        var state = {};\r\n        try{\r\n            state = JSON.parse(params['state']);    \r\n        }catch(e){\r\n            dn.show_error(\"Bad URL params:\\n\" + params['state']);\r\n        }\r\n        if(state.action && state.action == \"open\" && state.ids && state.ids.length > 0){\r\n            dn.the_file.file_id = state.ids[0];\r\n        }else if(state.action && state.action == \"create\"){\r\n            dn.the_file.title = \"untitled.\" + (state.ext ? state.ext : dn.g_settings.get('ext'));\r\n            if(state.folderId)\r\n                dn.the_file.folder_id = state.folderId;\r\n            dn.create_file(); //will use the specified title and folderId\r\n        }\r\n    }else{\r\n        dn.the_file.title = \"untitled.\" + dn.g_settings.get('ext');\r\n        dn.create_file();\r\n    }\r\n\r\n    dn.pr_auth.then(dn.authentication_done); // authentication Promise-like defined inline at top of html head\r\n    dn.show_status(); \r\n}\r\n\r\n\r\nif (document.readyState != 'loading')\r\n    dn.document_ready();\r\nelse\r\n    document.addEventListener('DOMContentLoaded', dn.document_ready);\r\n\r\n\r\n"]}