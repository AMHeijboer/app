{"version":3,"sources":["node_modules/keymaster/keymaster.js","js/utils.js","js/drop_down.js","js/info.js","js/revisions_main_thread.js","js/find_replace.js","js/keyboard.js","js/app.js"],"names":["global","k","_handlers","_mods",16,18,17,91,"_scope","_MODIFIERS","⇧","shift","⌥","alt","option","⌃","ctrl","control","⌘","command","_MAP","backspace","tab","clear","enter","return","esc","escape","space","left","up","right","down","del","delete","home","end","pageup","pagedown",",",".","/","`","-","=",";","'","[","]","\\","code","x","toUpperCase","charCodeAt","_downKeys","index","array","item","i","length","compareArray","a1","a2","modifierMap","updateModifierKey","event","dispatch","key","handler","modifiersMatch","scope","keyCode","push","assignKey","filter","call","this","getScope","mods","method","preventDefault","returnValue","stopPropagation","cancelBubble","clearModifier","splice","resetModifiers","keys","getKeys","undefined","split","getMods","shortcut","unbindKey","multipleKeys","j","obj","isPressed","getPressedKeyCodes","slice","tagName","target","srcElement","setScope","deleteScope","handlers","replace","mi","addEvent","object","addEventListener","attachEvent","window","document","previousKey","noConflict","unbind","module","exports","oxford_comma","arr","rotate","el","deg","style","transform","webkitTansform","mozTransform","translate","y","str","webkitTransform","text_multi","text","truncate_long_words","textContent","innerHTML","escape_str","css_animation","timers","els","cls","callback","delay","classList","remove","offsetTop","old_idx","indexOf","clearTimeout","setTimeout","add","stop_propagation","e","prevent_default","DropDown","val_array","map","val","join","el_list","createElement","className","tabindex","display","el_collapsed","appendChild","ind","event_callbacks","open","dd","trigger","parentNode","focus","scrollTop","children","on_click","SetInd","getAttribute","ii","setAttribute","FakeEvent","is_stopped","prototype","stopImmediatePropagation","evt","func","args","fe","IndexOf","GetVal","no_trigger","parseInt","isOpen","SetSelected","v","dn","menu_id_to_caption","menu_print","menu_sharing","menu_save","menu_history","menu_file","menu_new","menu_open","menu_find","menu_goto","menu_general_settings","menu_shortcuts","menu_drive","menu_help","shortcuts_list","ext_to_mime_type","html","htm","js","pl","xml","c","cpp","h","json","php","svg","css","java","py","scala","textile","tex","bib","rtf","rtx","sh","sql","as","tooltip_info","save","print","sharing","file history","drive","about","shortcuts","new","settings_file","settings_general","title","description","WHICH","ENTER","ESC","UP","DOWN","default_settings","ext","wordWrap","wordWrapAt","fontSize","widget_anchor","showGutterHistory","lastDNVersionUsed","newLineDefault","historyRemovedIsExpanded","softTabN","tabIsHard","widgetSub","theme","pane","pane_open","find_regex","find_whole_words","find_case_sensitive","help_inner","default_custom_props","newline","tabs","aceMode","impersonal_settings_keys","drag_delay_ms","drag_shift_px","min_font_size","max_font_size","max_wrap_at","min_wrap_at","wrap_at_increment","max_soft_tab_n","min_soft_tab_n","detect_tabs_spaces_frac","detect_tabs_tabs_frac","detect_tabs_n_spaces_frac","detect_tabs_n_spaces_frac_for_default","font_size_increment","icon_mouse_over_ms","editor_refocus_time_ms","error_delay_ms","find_history_add_delay","clipboard_info_delay","clipboard_max_length","find_max_results","find_max_prefix_chars","find_max_suffix_chars","close_history","file_history","$revisions_display","removeEventListener","revisions_window_resize","getElementById","editor","resize","is_showing_history","canShowResizeError","show_error","start_revisions_worker","the_file","is_brand_new","widget_content","widget_file_history","getElementsByClassName","$","$view","$new_li","$new_tick","needToRefindViewChildren","$rev_lines_","needToFixHeights","$timeline","$d","find","$revisions_status","$revision_caption_from","$revision_caption_at","$expand_removed","$collapse_removed","revisions","revisionFromEtag","at","from","worker","Worker","g_settings","set","revision_setis_expaned","get","w","onmessage","revision_worker_delivery","postMessage","fileId","file_id","token","gapi","auth","getToken","access_token","init","appendTo","on","empty","revision_set_at","r","fromChangeEvent","fromTimelineCreation","$at_range","value","modifiedDate","toLocaleDateString","month","day","year","toLocaleTimeString","hour","minute","showEtag","etag","fromEtag","revision_set_from","$from_range","display_revision_timeline","newRevisions","rs","$tick_box","attr","t","downloaded","isDownloaded","Array","apply","$ticks","insertClonedChildren","eq","append","data","debug","console","log","status","forEach","revisionDownloaded","revsionDiffed","isDiffed","newStuff","newStuffForDom","lines","vals_ui8buffer","$rl_","fixHeightFromAuto","vals","Uint8Array","digits","find_results","find_current_match_idx","find_markers","find_marker_current","find_str","find_active","find_set_find_active_false","session","getSession","removeMarker","find_info","find_input","setSelectionRange","selectionEnd","setHighlightSelectedWord","focus_editor","find_set_find_active_true","select_match_idx","AceSearch","ace","require","Search","AceRange","Range","find_perform_search","find_select_result_idx","use_reg_exp","re","RegExp","message","selection","clearSelection","ctrl_key","search","setOptions","needle","wrap","caseSensitive","wholeWord","regExp","results","findAll","selected_range","getSelection","getRange","row","start","column","current_match_idx","addMarker","range","idx","results_sub","n","Math","floor","concat","col","prefix_range","max","pre_ellipses","suffix_range","getTextRange","find_result_click","renderer","scrollSelectionIntoView","find_blur_input","find_settings_changed","find_input_focus","find_input_keydown","which","shiftKey","ctrlKey","find_input_keyup","platform","navigator","create_pane_shortcuts","arry","dict","parts","action","pane_help_shortcuts","esc_pressed","will_show_find","find_shortcut_used","sel","getSelectionRange","select","make_keyboard_shortcuts","commands","removeCommands","save_content","do_print","do_open","do_new","show_go_to","show_replace","HashHandler","extraKeyEvents","bindKey","win","mac","descr","exec","document_clipboard_left","document_clipboard_right","keyBinding","addKeyboardHandler","version_str","can_show_drag_drop_error","file_body","file_meta","file_sharing","authentication","popup_active","local_settings","folder_id","loaded_mime_type","new_line_detected","tab_detected","is_pristine","mime_type","is_saving","data_to_save","body","generation_to_save","is_read_only","is_shared","is_reading_file_object","custom_props","custom_prop_exists","saving_title_count","change_line_history","last_change","change_line_classes","rootStr","trueN","factor","change_line_classes_rm","authentication_done","auth_result","authentication_failed","error","show_status","user_info","get_user_info","load_file","get_properties_from_cloud","load","get_settings_from_cloud","share_dialog","share","ShareClient","client_id","Promise","resolve","client","request","path","then","a","result","user_name","name","err","dir","authorization","show_pane_permissions","reauth","authorize","auth_map","launch_popup","the_widget","do_share","setItemIds","showSettingsDialog","detect_new_line","first_n","show_newline_status","has_rn","has_solo_n","match","apply_newline_choice","newlineDefault","newline_menu_windows","newline_menu_unix","file_newline_detect","file_newline_windows","file_newline_unix","setNewLineMode","statusStr","file_newline_info","open_picker","view","google","picker","View","ViewId","DOCS","PickerBuilder","enableFeature","Feature","NAV_HIDDEN","setAppId","setOAuthToken","addView","setCallback","picker_callback","build","setVisible","Action","PICKED","docs","id","opener_button_a","url","opener_button_b","opener_chooser","show_help_inner","inner_pane","pane_help_tips","pane_help_main","button_shortcuts","button_tips","show_pane","el_icon","menu_icon_from_pane_id","widget_mouse_down","widget_mouse_down_info","off_left","clientX","off_top","clientY","start_time","Date","now","is_dragging","button","document_mouse_move_widget","document_mouse_up_widget","pos","getBoundingClientRect","widget_w","offsetWidth","widget_h","offsetHeight","window_w","innerWidth","window_h","innerHeight","anchor","top","widget_apply_anchor","isArray","widget_menu","bottom","open_close_widget","state","s","extra","widget_text","widget_error_text","widget_error","set_drive_link_to_folder","href","realtime","loadAppDataDocument","doc","old_temp_g_settings","getModel","getRoot","g_clipboard","createList","g_find_history","existingKeys","EventType","VALUE_CHANGED","settings_changed","getKeeps","JSON","stringify","property","newValue","resp","arguments","type","load_default_settings","ob","keeps","keep","localStorage","parse","new_value","setTheme","theme_drop_down","scrollLine","get_scroll_line","font_size_text","toFixed","setFontSize","scrollToLine","setUseWrapMode","setWrapLimitRange","word_wrap_off","word_wrap_edge","word_wrap_at","word_wrap_at_text","curWrap","setPrintMarginColumn","gutter_history_show","gutter_history_hide","removeGutterDecoration","apply_tab_choice","find_button_regex","find_button_whole_words","find_button_case_sensitive","font_size_decrement_click","font_size","font_size_increment_click","detect_tab","getLines","indents","show_tab_status","stats","reduce","nWithMixture","nWithOnlyTabs","spaceHist","nSamp","nWithOnlySpaces","spaceModHist","m","defaultNSpaces","isDefault","threshold","d","defaultStr","file_tab_info","defaultTabIsHard","defaultSoftTabN","isHard","nSpaces","isDetected","setUseSoftTabs","setTabSize","tab_soft_text","tab_hard","tab_soft","file_tab_detect","file_tab_hard","file_tab_soft","file_tab_soft_text","set_file_tabs_to_soft_or_hard","delta","f","current","newT","set_property","show_syntax_status","syntax","file_ace_mode_info","detect_syntax","syntax_detected","mode","getModeForPath","caption","apply_syntax_choice","set_syntax","file_ace_mode_detect","syntax_drop_down","get_current_syntax_name","modesArray","modesByName","getMode","$id","pop","modes","setMode","create_theme_menu","themes","Object","themesByName","create_syntax_menu","read_only_bail","create_file_details_tool","details_title_text","details_description_text","details_title_input","new_val","show_file_title","save_file_title","ignore_escape","button_save","button_print","button_share","button_history","details_description_input","show_description","save_file_description","save_new_file","save_file","proxy","save_done","getValue","ace_content","do_save","gens","meta","failures","removeAttribute","fileExtension","saved_new_file","fileMetadata","fileText","boundary","make_boundary","delimiter","close_delim","messageBody","btoa","unescape","encodeURIComponent","params","uploadType","headers","Content-Type","execute","getTime","random","content","getAllLines","line_tohtml","printWindow","writeln","cssText","printLayer","create","Text","tokens","getTokens","screenColumn","$renderToken","clipboard_active","clipboard_index","undo","insert","document_clipboard_keyup","off","pane_clipboard","clipboard_info_timer","on_paste","lastIndexOf","on_copy","create_clipboard_tool","button_clear_clipboard","button_clear_find_replace","base","location","folderId","create_new_tool","create_file","guess_mime_type","plain","substr","mimeType","parentId","parentNodes","shared","history","replaceState","save_all_file_properties","save_scroll_line","patch_property","screenToDocumentPosition","getScrollTopRow","flag","promise_get_meta","fields","load_file_got_meta_data","promise_get_body","load_file_got_file_body","pr_the_file","all","Error","capabilities","canEdit","parents","setting_session_value","setValue","on_change","nClasses","start_row","end_row","addGutterDecoration","newLineCount","query_unload","property_updated","propKey","load_default_properties","got_all_file_properties","items","prop_name","oldVal","dummyCallback","properties","propertyKey","visibility","patch","resource","document_drag_over","originalEvent","dataTransfer","dropEffect","document_drop_file","files","file","isReading_file_object","FileReader","onload","dropped_file_read","readAsText","document_ready","getElementsByTagName","editor_el","edit","setAnimatedScroll","$blockScrolling","Infinity","pane_file","file_ace_mode_choose","pane_general_settings","theme_chooser","widget_sub_general_box","font_size_decrement","tab_soft_dec","tab_soft_inc","word_wrap_at_dec","word_wrap_at_inc","pane_permissions","pane_help","pane_find","find_input_blur","onbeforeunload","window_location_to_params_object","ids","pr_auth","readyState"],"mappings":"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e,gBACH,mBACA,oBACA,yBACA,yFACA,8BACA,oBACA,iBACA,0BACA,wBACA,qDACA,MACA,oBACA,wBACA,+BACA,gCACA,mBACA,oBACA,OACA,uBACA,4BACA,yKACA,oDACA,8CACA,2BACA,0BACA,wCACA,wDACA,wDACA,0DACA,kDACA,qCACA,wDACA,wCACA,2CACA,aACA,oBACA,mBACA,+BACA,6BACA,wCACA,qDACA,gCACA,qBACA,kCACA,2BAGAf,IAAGgB,kBACHC,KAAK,YACLC,IAAI,YACJC,GAAG,kBACHC,GAAG,qBACHC,IAAI,WACJC,EAAE,cACFC,IAAI,gBACJC,EAAE,cACFC,KAAK,mBACLC,IAAI,oBACJC,IAAI,YACJC,IAAI,WACJC,KAAK,cACLC,GAAG,gBACHC,MAAM,QACNC,QAAQ,UACRC,IAAI,oBACJC,IAAI,oBACJC,IAAI,kBACJC,IAAI,kBACJC,GAAG,mBACHC,IAAI,aACJC,GAAG,sBAIHvC,IAAGwC,cACCC,KAAS,wBACTC,MAAS,kCACTC,QAAW,yCACXC,eAAgB,8BAChBC,MAAS,oCACTC,MAAS,yBACTC,UAAa,sBACbC,MAAO,kCACP3E,KAAQ,yBACR4E,cAAiB,kCACjBC,iBAAoB,0CACpBC,MAAS,kCACTC,YAAe,wCAInB,IAAIC,QACJC,MAAO,GACPC,IAAK,GACLC,GAAI,GACJC,KAAM,GAGNzD,IAAG0D,kBACHC,IAAK,MACLC,UAAW,KAAK,KAAK,MACrBC,WAAY,GACZC,SAAU,EACVC,eAAgB,IAAI,GAAG,IAAI,IAC3BC,kBAAmB,EACnBC,kBAAmB,GACnBC,eAAgB,UAChBC,yBAA0B,KAC1BC,SAAU,EACVC,UAAW,EACXC,UAAW,UACXC,MAAO,SACPC,KAAM,GACNC,UAAW,KACXC,WAAY,MACZC,iBAAkB,MAClBC,oBAAqB,MACrBC,WAAY,OAGZ7E,IAAG8E,sBACHC,QAAS,SACTC,KAAM,SACNC,QAAS,SAGTjF,IAAGkF,0BACH,WACA,aACA,WACA,gBACA,oBACA,2BACA,YACA,WACA,YACA,QACA,OACA,YACA,aACA,mBACA,sBACA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","file":"all.build.js","sourcesContent":["//     keymaster.js\n//     (c) 2011-2013 Thomas Fuchs\n//     keymaster.js may be freely distributed under the MIT license.\n\n;(function(global){\n  var k,\n    _handlers = {},\n    _mods = { 16: false, 18: false, 17: false, 91: false },\n    _scope = 'all',\n    // modifier keys\n    _MODIFIERS = {\n      '⇧': 16, shift: 16,\n      '⌥': 18, alt: 18, option: 18,\n      '⌃': 17, ctrl: 17, control: 17,\n      '⌘': 91, command: 91\n    },\n    // special keys\n    _MAP = {\n      backspace: 8, tab: 9, clear: 12,\n      enter: 13, 'return': 13,\n      esc: 27, escape: 27, space: 32,\n      left: 37, up: 38,\n      right: 39, down: 40,\n      del: 46, 'delete': 46,\n      home: 36, end: 35,\n      pageup: 33, pagedown: 34,\n      ',': 188, '.': 190, '/': 191,\n      '`': 192, '-': 189, '=': 187,\n      ';': 186, '\\'': 222,\n      '[': 219, ']': 221, '\\\\': 220\n    },\n    code = function(x){\n      return _MAP[x] || x.toUpperCase().charCodeAt(0);\n    },\n    _downKeys = [];\n\n  for(k=1;k<20;k++) _MAP['f'+k] = 111+k;\n\n  // IE doesn't support Array#indexOf, so have a simple replacement\n  function index(array, item){\n    var i = array.length;\n    while(i--) if(array[i]===item) return i;\n    return -1;\n  }\n\n  // for comparing mods before unassignment\n  function compareArray(a1, a2) {\n    if (a1.length != a2.length) return false;\n    for (var i = 0; i < a1.length; i++) {\n        if (a1[i] !== a2[i]) return false;\n    }\n    return true;\n  }\n\n  var modifierMap = {\n      16:'shiftKey',\n      18:'altKey',\n      17:'ctrlKey',\n      91:'metaKey'\n  };\n  function updateModifierKey(event) {\n      for(k in _mods) _mods[k] = event[modifierMap[k]];\n  };\n\n  // handle keydown event\n  function dispatch(event) {\n    var key, handler, k, i, modifiersMatch, scope;\n    key = event.keyCode;\n\n    if (index(_downKeys, key) == -1) {\n        _downKeys.push(key);\n    }\n\n    // if a modifier key, set the key.<modifierkeyname> property to true and return\n    if(key == 93 || key == 224) key = 91; // right command on webkit, command on Gecko\n    if(key in _mods) {\n      _mods[key] = true;\n      // 'assignKey' from inside this closure is exported to window.key\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = true;\n      return;\n    }\n    updateModifierKey(event);\n\n    // see if we need to ignore the keypress (filter() can can be overridden)\n    // by default ignore key presses if a select, textarea, or input is focused\n    if(!assignKey.filter.call(this, event)) return;\n\n    // abort if no potentially matching shortcuts found\n    if (!(key in _handlers)) return;\n\n    scope = getScope();\n\n    // for each potential shortcut\n    for (i = 0; i < _handlers[key].length; i++) {\n      handler = _handlers[key][i];\n\n      // see if it's in the current scope\n      if(handler.scope == scope || handler.scope == 'all'){\n        // check if modifiers match if any\n        modifiersMatch = handler.mods.length > 0;\n        for(k in _mods)\n          if((!_mods[k] && index(handler.mods, +k) > -1) ||\n            (_mods[k] && index(handler.mods, +k) == -1)) modifiersMatch = false;\n        // call the handler and stop the event if neccessary\n        if((handler.mods.length == 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91]) || modifiersMatch){\n          if(handler.method(event, handler)===false){\n            if(event.preventDefault) event.preventDefault();\n              else event.returnValue = false;\n            if(event.stopPropagation) event.stopPropagation();\n            if(event.cancelBubble) event.cancelBubble = true;\n          }\n        }\n      }\n    }\n  };\n\n  // unset modifier keys on keyup\n  function clearModifier(event){\n    var key = event.keyCode, k,\n        i = index(_downKeys, key);\n\n    // remove key from _downKeys\n    if (i >= 0) {\n        _downKeys.splice(i, 1);\n    }\n\n    if(key == 93 || key == 224) key = 91;\n    if(key in _mods) {\n      _mods[key] = false;\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = false;\n    }\n  };\n\n  function resetModifiers() {\n    for(k in _mods) _mods[k] = false;\n    for(k in _MODIFIERS) assignKey[k] = false;\n  };\n\n  // parse and assign shortcut\n  function assignKey(key, scope, method){\n    var keys, mods;\n    keys = getKeys(key);\n    if (method === undefined) {\n      method = scope;\n      scope = 'all';\n    }\n\n    // for each shortcut\n    for (var i = 0; i < keys.length; i++) {\n      // set modifier keys if any\n      mods = [];\n      key = keys[i].split('+');\n      if (key.length > 1){\n        mods = getMods(key);\n        key = [key[key.length-1]];\n      }\n      // convert to keycode and...\n      key = key[0]\n      key = code(key);\n      // ...store handler\n      if (!(key in _handlers)) _handlers[key] = [];\n      _handlers[key].push({ shortcut: keys[i], scope: scope, method: method, key: keys[i], mods: mods });\n    }\n  };\n\n  // unbind all handlers for given key in current scope\n  function unbindKey(key, scope) {\n    var multipleKeys, keys,\n      mods = [],\n      i, j, obj;\n\n    multipleKeys = getKeys(key);\n\n    for (j = 0; j < multipleKeys.length; j++) {\n      keys = multipleKeys[j].split('+');\n\n      if (keys.length > 1) {\n        mods = getMods(keys);\n        key = keys[keys.length - 1];\n      }\n\n      key = code(key);\n\n      if (scope === undefined) {\n        scope = getScope();\n      }\n      if (!_handlers[key]) {\n        return;\n      }\n      for (i = 0; i < _handlers[key].length; i++) {\n        obj = _handlers[key][i];\n        // only clear handlers if correct scope and mods match\n        if (obj.scope === scope && compareArray(obj.mods, mods)) {\n          _handlers[key][i] = {};\n        }\n      }\n    }\n  };\n\n  // Returns true if the key with code 'keyCode' is currently down\n  // Converts strings into key codes.\n  function isPressed(keyCode) {\n      if (typeof(keyCode)=='string') {\n        keyCode = code(keyCode);\n      }\n      return index(_downKeys, keyCode) != -1;\n  }\n\n  function getPressedKeyCodes() {\n      return _downKeys.slice(0);\n  }\n\n  function filter(event){\n    var tagName = (event.target || event.srcElement).tagName;\n    // ignore keypressed in any elements that support keyboard data input\n    return !(tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA');\n  }\n\n  // initialize key.<modifier> to false\n  for(k in _MODIFIERS) assignKey[k] = false;\n\n  // set current scope (default 'all')\n  function setScope(scope){ _scope = scope || 'all' };\n  function getScope(){ return _scope || 'all' };\n\n  // delete all handlers for a given scope\n  function deleteScope(scope){\n    var key, handlers, i;\n\n    for (key in _handlers) {\n      handlers = _handlers[key];\n      for (i = 0; i < handlers.length; ) {\n        if (handlers[i].scope === scope) handlers.splice(i, 1);\n        else i++;\n      }\n    }\n  };\n\n  // abstract key logic for assign and unassign\n  function getKeys(key) {\n    var keys;\n    key = key.replace(/\\s/g, '');\n    keys = key.split(',');\n    if ((keys[keys.length - 1]) == '') {\n      keys[keys.length - 2] += ',';\n    }\n    return keys;\n  }\n\n  // abstract mods logic for assign and unassign\n  function getMods(key) {\n    var mods = key.slice(0, key.length - 1);\n    for (var mi = 0; mi < mods.length; mi++)\n    mods[mi] = _MODIFIERS[mods[mi]];\n    return mods;\n  }\n\n  // cross-browser events\n  function addEvent(object, event, method) {\n    if (object.addEventListener)\n      object.addEventListener(event, method, false);\n    else if(object.attachEvent)\n      object.attachEvent('on'+event, function(){ method(window.event) });\n  };\n\n  // set the handlers globally on document\n  addEvent(document, 'keydown', function(event) { dispatch(event) }); // Passing _scope to a callback to ensure it remains the same by execution. Fixes #48\n  addEvent(document, 'keyup', clearModifier);\n\n  // reset modifiers to false whenever the window is (re)focused.\n  addEvent(window, 'focus', resetModifiers);\n\n  // store previously defined key\n  var previousKey = global.key;\n\n  // restore previously defined key and return reference to our key object\n  function noConflict() {\n    var k = global.key;\n    global.key = previousKey;\n    return k;\n  }\n\n  // set window.key and window.key.set/get/deleteScope, and the default filter\n  global.key = assignKey;\n  global.key.setScope = setScope;\n  global.key.getScope = getScope;\n  global.key.deleteScope = deleteScope;\n  global.key.filter = filter;\n  global.key.isPressed = isPressed;\n  global.key.getPressedKeyCodes = getPressedKeyCodes;\n  global.key.noConflict = noConflict;\n  global.key.unbind = unbindKey;\n\n  if(typeof module !== 'undefined') module.exports = assignKey;\n\n})(this);\n","\"use strict\";\r\n\r\nvar oxford_comma = function(arr){\r\n    switch (arr.length){\r\n        case 1:\r\n            return arr[0];\r\n        case 2:\r\n            return arr[0] + \" and \" + arr[1];\r\n        case 3:\r\n            return arr[0] + \", \" + arr[1] + \", and \" + arr[2];\r\n    }\r\n}\r\n\r\nvar rotate = function(el, deg){\r\n    el.style.transform = \"rotate(\" + deg + 'deg)';\r\n    el.style.webkitTansform = \"rotate(\" + deg + 'deg)';\r\n    el.style.mozTransform = \"rotate(\" + deg + 'deg)';\r\n}\r\n\r\nvar translate = function(el, x, y){\r\n    var str = x==null ? \"\" : \"translate(\" + x + \"px,\" + y + \"px)\";\r\n    el.style.transform = str;\r\n    el.style.webkitTransform = str;\r\n    el.style.mozTransform = str;\r\n}\r\n\r\nvar text_multi = function(el, text, truncate_long_words){\r\n    if(truncate_long_words){\r\n        text = text.replace(/(\\S{25})\\S*/g,'$1...'); \r\n    }\r\n    el.textContent = text;  \r\n    el.innerHTML = el.innerHTML.replace(/\\n/g,'<br/>').replace(/\\t/g,'&nbsp;&nbsp;&nbsp; ');\r\n}\r\n\r\nvar escape_str = function(str){\r\n    // http://stackoverflow.com/a/18750001/2399799\r\n    return str.replace(/[\\u00A0-\\u9999<>\\&]/g, function(i) {\r\n        return '&#' + i.charCodeAt(0) + ';';\r\n    });\r\n}\r\n\r\nvar css_animation = (function(){\r\n    var timers = []; // we store timers and matching els so we can cancel if needed\r\n    var els = [];\r\n\r\n    return function(el, cls, callback, delay){\r\n        el.classList.remove(cls);\r\n        el.offsetTop; //forces class to be removed, so we can actually re-add it.\r\n        var old_idx = els.indexOf(el);\r\n        if(old_idx != -1){\r\n            clearTimeout(timers[old_idx]);\r\n            timers.splice(old_idx, 1);\r\n            els.splice(old_idx, 1);\r\n        }\r\n        els.push(el);\r\n        timers.push(setTimeout(callback, delay)); //this is better than trying to use the endtransition event\r\n        el.classList.add(cls);\r\n    }\r\n})();\r\n\r\nvar stop_propagation = function(e){\r\n    e.stopPropagation();\r\n}\r\n\r\nvar prevent_default = function(e){\r\n    e.preventDefault();  \r\n}\r\n\r\n/* TODO: ...............................................................\r\n\r\n$.fn.fixHeightFromAuto = function(){\r\n    var heights = [];\r\n    var d = this.get();\r\n    for(var i=0;i<d.length;i++)\r\n        heights.push(getComputedStyle(d[i]).height);\r\n    \r\n    this.each(function(ind){this.style.height = heights[ind];});\r\n\r\n    return this;\r\n}\r\n\r\n$.fn.insertClonedChildren = function(index,$src,textArray,attrObjArrays){\r\n    //inserts new nodes before this.children(index)\r\n    //the new nodes are based on $src, with text set according to the elements of textArray\r\n    //attrObjArrays is an optional arrays of objects giving key names and values\r\n    \r\n    var src = $src.get(0);\r\n    var frag = document.createDocumentFragment();\r\n    \r\n    textArray.map(function(str,ind){\r\n                    var a = src.cloneNode(false); \r\n                    a.textContent = str;\r\n                    if(attrObjArrays)for(var attr in attrObjArrays[ind])\r\n                        a.setAttribute(attr,attrObjArrays[ind][attr]);\r\n                    frag.appendChild(a);\r\n                });\r\n    \r\n    var parent = this.get(0);\r\n    var new_$els = $(Array.prototype.slice.call(frag.children,0));\r\n    parent.insertBefore(frag,parent.children[index]);\r\n    \r\n    return new_$els;\r\n}\r\n\r\n*/","\"use strict\";\r\n\r\nvar DropDown = function(val_array){\r\n    //constructor, must use <new>\r\n    \r\n    var str = val_array.map(function(val){\r\n                    return \"<div class='dropdown_item'>\" + val + \"</div>\";\r\n                 }).join(\"\");\r\n    \r\n    this.val_array = val_array.slice(0); \r\n    this.el_list = document.createElement('div');\r\n    this.el_list.className ='dropdown_item_list';\r\n    this.el_list.tabindex =-1\r\n    this.el_list.style.display = 'none';\r\n    this.el_list.innerHTML = str;\r\n\r\n    this.el_collapsed = document.createElement('div');\r\n    this.el_collapsed.className = 'dropdown_collapsed';\r\n    \r\n    this.el = document.createElement('div');\r\n    this.el.className = 'dropdown';\r\n    this.el.appendChild(this.el_list)\r\n    this.el.appendChild(this.el_collapsed);\r\n    this.ind = 0;\r\n    this.el_collapsed.textContent = val_array[0];\r\n    this.event_callbacks = {}; //map of callback lists\r\n    this.open = false;\r\n    \r\n    var dd = this;\r\n\r\n    this.el_collapsed.addEventListener('mousedown',function(){\r\n        if(!dd.trigger(\"click\"))\r\n            return;\r\n        dd.el.parentNode.classList.add(\"selected\");\r\n        dd.el_list.style.display = '';\r\n        this.open = true;\r\n        setTimeout(function(){\r\n            dd.el_list.focus();\r\n            dd.el_list.scrollTop = dd.el_list.children[dd.ind].offsetTop;\r\n        },1);\r\n    });\r\n    this.el_list.addEventListener('blur',function(e){\r\n        dd.el_list.style.display = 'none';\r\n        dd.open = false;\r\n        dd.trigger(\"blur\");\r\n    })\r\n    var on_click = function(e){\r\n            dd.SetInd(this.getAttribute('data-ind'));\r\n            dd.el_list.style.display = 'none';\r\n            dd.open = false;\r\n    };\r\n    for(var ii=0; ii<this.el_list.children.length; ii++){\r\n        this.el_list.children[ii].setAttribute('data-ind', ii);\r\n        this.el_list.children[ii].addEventListener(\"click\", on_click); \r\n    }\r\n\r\n    return this;\r\n}\r\n\r\nDropDown.FakeEvent = function(){//static subclass\r\n    this.is_stopped = false;\r\n}\r\nDropDown.FakeEvent.prototype.stopImmediatePropagation = function(){\r\n    this.is_stopped = true;\r\n}\r\n\r\nDropDown.prototype.addEventListener = function(evt, func){\r\n    if(!(evt in this.event_callbacks))\r\n        this.event_callbacks[evt] = [];\r\n    this.event_callbacks[evt].push(func);\r\n}\r\n\r\nDropDown.prototype.trigger = function(evt, args){\r\n    var fe = new DropDown.FakeEvent();\r\n    if(evt in this.event_callbacks){\r\n        for(var ii = 0; ii<this.event_callbacks[evt].length; ii++)\r\n            this.event_callbacks[evt][ii].call(this, fe);\r\n        if(fe.is_stopped)\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\nDropDown.prototype.IndexOf = function(val){\r\n    return this.val_array.indexOf(val);\r\n}\r\n\r\nDropDown.prototype.GetVal = function(){\r\n    return this.val_array[this.ind];\r\n}\r\n\r\nDropDown.prototype.SetInd = function(ind,no_trigger){\r\n    ind = parseInt(ind)\r\n    if(ind === this.ind)\r\n        return;\r\n    this.el_list.children[this.ind].classList.remove(\"selected\");\r\n    this.el_collapsed.textContent = this.val_array[ind];\r\n    this.ind = ind;\r\n    this.el_list.children[ind].classList.add(\"selected\");\r\n    if(!no_trigger)\r\n        this.trigger(\"change\",{ind:ind,str:this.val_array[ind],isOpen: this.open});\r\n}\r\n\r\nDropDown.prototype.SetSelected = function(v){\r\n    if(v)\r\n        this.el.parentNode.classList.add(\"selected\");\r\n    else\r\n        this.el.parentNode.classList.remove(\"selected\");\r\n}\r\n","\"use strict\";\r\n\r\ndn.menu_id_to_caption = {\r\n'menu_print': 'print',\r\n'menu_sharing': 'sharing',\r\n'menu_save': 'save',\r\n'menu_history': 'history',\r\n'menu_file': 'current file',\r\n'menu_new': 'new',\r\n'menu_open': 'new/open',\r\n'menu_find': 'find/replace',\r\n'menu_goto': 'goto line',\r\n'menu_general_settings': 'general settings',\r\n'menu_shortcuts': 'shortcuts',\r\n'menu_drive': 'drive',\r\n'menu_help': 'about/help'};\r\n\r\n\r\ndn.shortcuts_list = [\r\n\"cut|Ctrl-X|Cmd-X\",    \r\n\"copy|Ctrl-C|Cmd-C\",\r\n\"paste|Ctrl-V|Command-V\",\r\n\"cycle clipboard|Cltr-[V then left or right arrow]|Command-[V then left or right arrow]\",\r\n\"select all|Ctrl-A|Command-A\",\r\n\"find|Ctrl(-Alt)-F\",\r\n\"replace|Ctrl-R\",\r\n\"go to line|Ctrl(-Alt)-L\",\r\n\"undo|Ctrl-Z|Command-Z\",\r\n\"redo|Ctrl-Shift-Z,Ctrl-Y|Command-Shift-Z,Command-Y\",\r\n\" | \",\r\n\"toggle widget|Esc\",\r\n\"save|Ctrl-S|Command-S\",\r\n\"print|Ctrl(-Alt)-P|Command-P\",\r\n\"file history|Ctrl-H|Command-H\",\r\n\"new|Ctrl(-Alt)-N\",\r\n\"open|Ctrl(-Alt)-O\",\r\n\"  | \",\r\n\"to upper case|Ctrl-U\",\r\n\"to lower case|Ctr-Shift-U\",\r\n\"modify selection|Shift-(Ctrl-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown, PageUp, End}|Shift-(Command-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown,End}\",\r\n\"copy lines down|Ctrl-Alt-Down|Command-Option-Down\",\r\n\"copy lines up|Ctrl-Alt-Up|Command-Option-Up\",\r\n\"center selection||Ctrl-L\",\r\n\"fold all|Alt-0|Option-0\",\r\n\"unfold all|Alt-Shift-0|Option-Shift-0\",\r\n\"go to end|Ctrl-End,Ctrl-Down|Command-End,Command-Down\",\r\n\"go to line end|Alt-Right,End|Command-Right,End,Ctrl-E\",\r\n\"go to line start|Alt-Left,Home|Command-Left,Home,Ctrl-A\",\r\n\"go to page down|PageDown|Option-PageDown,Ctrl-V\",\r\n\"go to page up|PageUp|Option-PageUp\",\r\n\"go to start|Ctrl-Home,Ctrl-Up|Command-Home,Command-Up\",\r\n\"go to word left|Ctrl-Left|Option-Left\",\r\n\"go to word right|Ctrl-Right|Option-Right\",\r\n\"indent|Tab\",\r\n\"outdent|Shift-Tab\",\r\n\"overwrite|Insert\",\r\n\"remove line|Ctrl-D|Command-D\",\r\n\"remove to line end||Ctrl-K\",\r\n\"remove to linestart||Option-Backspace\",\r\n\"remove word left||Alt-Backspace,Ctrl-Alt-Backspace\",\r\n\"remove word right||Alt-Delete\",\r\n\"split line||Ctrl-O\",\r\n\"toggle comment|Ctrl-7|Command-7\",\r\n\"transpose letters|Ctrl-T\"\r\n]\r\n\r\ndn.ext_to_mime_type = {\r\nhtml:\"text/html\",\r\nhtm:\"text/html\",\r\njs:\"text/javascript\",\r\npl:\"application/x-perl\",\r\nxml:\"text/xml\",\r\nc:\"text/x-csrc\",\r\ncpp:\"text/x-c++src\",\r\nh:\"text/x-chdr\",\r\njson:\"application/json\",\r\nphp:\"application/x-php\",\r\nsvg:\"text/html\",\r\ncss:\"text/css\",\r\njava:\"text/x-java\",\r\npy:\"text/x-python\",\r\nscala:\"scala\",\r\ntextile:\"textile\",\r\ntex:\"application/x-tex\",\r\nbib:\"application/x-tex\",\r\nrtf:\"application/rtf\",\r\nrtx:\"application/rtf\",\r\nsh:\"application/x-sh\",\r\nsql:\"text/x-sql\",\r\nas:\"text/x-actionscript\"\r\n//everything else is hopefully ok to be text/plain.\r\n}\r\n\r\ndn.tooltip_info = { //keys correspond to icon data-info attr, which will be the same as keys in SHORTCUTS_LIST\r\n    \"save\" : \"Save file contents.  \",\r\n    \"print\": \"Open print view in a new tab.  \",\r\n    \"sharing\": \"View and modify file's sharing status.\",\r\n    \"file history\": \"Explore the file history.  \",\r\n    \"drive\": \"Show this file in Google Drive.  \",\r\n    \"about\": \"Drive Notepad website.\",\r\n    \"shortcuts\": \"Keyboard shortcuts.\",\r\n    \"new\": \"Create new file in a new tab.  \",\r\n    \"open\": \"Launch open dialoag.  \",\r\n    \"settings_file\": \"Properties of the current file.\",\r\n    \"settings_general\": \"Your general Drive Notepad preferences.\",\r\n    \"title\": \"Click to edit the file's title.\",\r\n    \"description\": \"Click to edit the file's description.\"\r\n}\r\n\r\n// TODO: use keymaster rather than relying on this\r\nvar WHICH = {\r\nENTER: 13,\r\nESC: 27,\r\nUP: 38,\r\nDOWN: 40\r\n};\r\n\r\ndn.default_settings = {\r\next: 'txt',\r\nwordWrap: [true,null,null],\r\nwordWrapAt: 80,\r\nfontSize: 1,\r\nwidget_anchor: ['l',50,'t',10],\r\nshowGutterHistory: 1,\r\nlastDNVersionUsed: '',\r\nnewLineDefault: 'windows',\r\nhistoryRemovedIsExpanded: true,\r\nsoftTabN: 4,\r\ntabIsHard: 0,\r\nwidgetSub: 'general',\r\ntheme: \"chrome\",\r\npane: '',\r\npane_open: true,\r\nfind_regex: false,\r\nfind_whole_words: false,\r\nfind_case_sensitive: false,\r\nhelp_inner: 'main'\r\n}\r\n\r\ndn.default_custom_props = {\r\nnewline: \"detect\",\r\ntabs: \"detect\",\r\naceMode: \"detect\"\r\n};\r\n\r\ndn.impersonal_settings_keys = [\r\n\"wordWrap\",\r\n\"wordWrapAt\",\r\n\"fontSize\",\r\n\"widget_anchor\",\r\n\"showGutterHistory\",\r\n\"historyRemovedIsExpanded\",\r\n\"tabIsHard\",\r\n\"softTabN\",\r\n\"widgetSub\",\r\n\"theme\",\r\n\"pane\",\r\n\"pane_open\",\r\n\"find_regex\",\r\n\"find_whole_words\",\r\n\"find_case_sensitive\",\r\n\"help_inner\"\r\n];\r\n\r\ndn.drag_delay_ms = 400;\r\ndn.drag_shift_px = 40;\r\ndn.min_font_size = 0.3;\r\ndn.max_font_size = 5; \r\ndn.max_wrap_at = 200;\r\ndn.min_wrap_at = 20;\r\ndn.wrap_at_increment = 10;\r\ndn.max_soft_tab_n = 10;\r\ndn.min_soft_tab_n = 2;\r\ndn.detect_tabs_spaces_frac = 0.9;\r\ndn.detect_tabs_tabs_frac = 0.9;\r\ndn.detect_tabs_n_spaces_frac = 0.99;\r\ndn.detect_tabs_n_spaces_frac_for_default = 0.6;\r\ndn.font_size_increment = 0.15;\r\ndn.icon_mouse_over_ms = 300;\r\ndn.editor_refocus_time_ms = 500;\r\ndn.error_delay_ms = 5000;//5 seconds\r\ndn.find_history_add_delay = 2000; //ms\r\ndn.clipboard_info_delay = 500; //ms\r\ndn.clipboard_max_length = 20; //TODO: decide whether a large clipboard slows page loads and whether we can do anything about it.\r\ndn.find_max_results = 7; // must be odd\r\ndn.find_max_prefix_chars = 10;\r\ndn.find_max_suffix_chars = 60;","\"use strict\";\r\n\r\ndn.close_history = function(){\r\n    dn.file_history.$revisions_display.remove();\r\n    window.removeEventListener(\"resize\", dn.revisions_window_resize);\r\n    document.getElementById('the_editor').style.display = '';\r\n    dn.editor.resize();\r\n    dn.is_showing_history = false;\r\n}\r\ndn.revisions_window_resize = function(){\r\n    if(dn.file_history.canShowResizeError){\r\n        dn.show_error(\"The history explorer displays poorly if you resize the window while it is open. (This is a bug.)\");\r\n        dn.file_history.canShowResizeError = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n        setTimeout(function(){dn.file_history.canShowResizeError = true;},dn.error_delay_ms);\r\n    }    \r\n}\r\n\r\ndn.start_revisions_worker = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.show_error(\"This is a new file.  It doesn't have any history to explore.\")\r\n        return;\r\n    }\r\n    dn.is_showing_history = true;\r\n    \r\n    if(!dn.file_history){\r\n        dn.el.widget_content.innerHTML('afterend', \r\n            \"<div class='widget_box widget_revisions'>\" + \r\n            \"<div class='widget_box_title widget_revisions_title'>File History</div>\" +\r\n            \"<div class='revision_caption_at'></div>\" +\r\n            \"<div class='revision_timeline'></div>\" +\r\n            \"<div class='revision_caption_from'></div>\" +\r\n            \"<div>Removed lines: <div class='button inline_button ' id='expand_removed'>expand</div>\" + \r\n                    \"<div class='button inline_button ' id='collapse_removed'>collapse</div></div>\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"<div id='revisions_status'>Initialising...</div>\" + \r\n            \"Press Esc to return to editing.\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"Please note that the history viewing tool is missing some important features and those that have been implemented may include the odd bug.</div>\");\r\n        dn.el.widget_file_history = dn.el.widget_content.parentNode.getElementsByClassName('widget_revisions')[0];\r\n        dn.el.widget_file_history.style.display = 'none';\r\n        dn.file_history = {\r\n            $revisions_display: $(\"<div class='revisions_view'><ol></ol></div>\"),\r\n            $view: null, \r\n            $new_li: $(\"<li class='rev_line' v='-1'/>\"),\r\n            $new_tick:  $(\"<div class='revision_tick'/>\"),\r\n            needToRefindViewChildren: false, //this flag tracks when the $rev_lines_ is out of date relative to children of $view\r\n            $rev_lines_: [], // this is a single jQuery collection\r\n            needToFixHeights: $([]),            \r\n            $timeline: $d.find('.revision_timeline'),\r\n            $revisions_status: $d.find('#revisions_status'),\r\n            $revision_caption_from: $d.find('.revision_caption_from'),\r\n            $revision_caption_at: $d.find('.revision_caption_at'),\r\n            $expand_removed: $d.find('#expand_removed'),\r\n            $collapse_removed: $d.find('#collapse_removed'),\r\n            revisions: [], //array of objects with etag, isDownloaded, modifiedDate, $tick\r\n            revisionFromEtag: {},\r\n            at: null, //revision object\r\n            from: null, //revision object,\r\n            canShowResizeError: true, //used by Revisions_WindowResize\r\n            worker: new Worker(\"js/revisions_worker.js\")\r\n        };\r\n    \r\n        dn.file_history.$view = dn.file_history.$revisions_display.find('ol'); \r\n        dn.file_history.$expand_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',true)});\r\n        dn.file_history.$collapse_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',false)});\r\n        dn.revision_setis_expaned(dn.g_settings.get('historyRemovedIsExpanded'))\r\n\r\n        var w = dn.file_history.worker;\r\n        w.onmessage = dn.revision_worker_delivery;\r\n    }\r\n    dn.file_history.worker.postMessage({ fileId: dn.the_file.file_id, \r\n                                        token: gapi.auth.getToken().access_token,\r\n                                        init: true});\r\n    dn.file_history.$revisions_display.appendTo($('body'));\r\n    $(window).on(\"resize\",dn.revisions_window_resize);\r\n    dn.el.widget_file_history.style.display = '';\r\n    dn.file_history.$view.empty();\r\n    $('#the_editor').style.display = 'none';\r\n    return false;\r\n}\r\n\r\ndn.revision_setis_expaned = function(v){\r\n    var h = dn.file_history;\r\n    if(!h) return; //if we haven't yet initialised fileHistory stuff then ignore this for now, when we do initialise we will read and apply the g_settings value\r\n    \r\n    if(v){\r\n        h.$expand_removed.classList.add('selected')\r\n        h.$collapse_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"expanded\");\r\n    }else{\r\n        h.$collapse_removed.classList.add('selected')\r\n        h.$expand_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"collapsed\")\r\n    }\r\n}\r\ndn.revision_set_at = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.at = r;\r\n    if(!fromChangeEvent)\r\n        h.$at_range.value = r.ind;    \r\n    text_multi(h.$revision_caption_at,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.from && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                      fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.revision_set_from = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.from = r;\r\n    if(!fromChangeEvent)\r\n        h.$from_range.value = r.ind;\r\n    text_multi(h.$revision_caption_from,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.at && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                          fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.display_revision_timeline = function(newRevisions){\r\n    var h = dn.file_history;\r\n    var rs = h.revisions;\r\n    //TODO: update display based on newRevisions rather than starting from scratch\r\n    \r\n    h.$at_range = $(\"<input class='revision_at_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    h.$tick_box = $(\"<div class='revision_tick_box'/>\");\r\n    h.$from_range = $(\"<input class='revision_from_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    \r\n        \r\n    var attr = rs.map(function(t){ return { downloaded: t.isDownloaded || false }; });\r\n    var text = Array.apply(null, Array(attr.length)).map(function () { return \"\" });\r\n    var $ticks = h.$tick_box.insertClonedChildren(0,h.$new_tick,text,attr);\r\n    \r\n    for(var i=0;i<rs.length;i++){\r\n        rs[i].ind = i;\r\n        rs[i].$ = $ticks.eq(i);\r\n    }\r\n    \r\n    h.$timeline.empty().append(h.$at_range).append(h.$tick_box).append(h.$from_range);\r\n\r\n    h.$at_range.on(\"change\",function(){\r\n            dn.revision_set_at(dn.file_history.revisions[this.value],true);\r\n        })\r\n    h.$from_range.on(\"change\",function(){\r\n            dn.revision_set_from(dn.file_history.revisions[this.value],true);\r\n        })\r\n\r\n    dn.revision_set_from(rs.length > 1 ? rs[1] : rs[0],false,true);\r\n    dn.revision_set_at(rs[0],false,true);\r\n}\r\n\r\ndn.revision_worker_delivery = function(e){\r\n    if(!e.data)\r\n        return; //not sure if this is possible\r\n\r\n    if(e.data.debug)\r\n        console.log(e.data);\r\n        \r\n    var h = dn.file_history;\r\n    //TODO: probably ought to use a more sensivle message system with a string command switching thign...but this is ok for now\r\n    \r\n    if(e.data.status)\r\n        text_multi(h.$revisions_status, e.data.status);\r\n        \r\n    if(e.data.revisions){    \r\n        h.revisions = e.data.revisions;\r\n        e.data.revisions.forEach(function(r){ h.revisionFromEtag[r.etag] = r;});\r\n        dn.display_revision_timeline(e.data.revisions);\r\n        h.worker.postMessage({ showEtag: h.at.etag,\r\n                               fromEtag: h.from.etag }); \r\n    }\r\n    \r\n    if(e.data.revisionDownloaded){\r\n        var r = h.revisionFromEtag[e.data.revisionDownloaded];\r\n        r.$.attr('downloaded',true);\r\n        r.isDownloaded = true;\r\n    }\r\n    \r\n    if(e.data.revsionDiffed){\r\n        h.needToRefindViewChildren = true;\r\n        var r = h.revisionFromEtag[e.data.revsionDiffed];\r\n        r.$.attr('diffed',true);\r\n        r.isDiffed = true;\r\n        \r\n        var newStuff = e.data.newStuffForDom;\r\n        for(var i=0;i<newStuff.length;i++){\r\n            var lines = newStuff[i].lines.map(function(str){return str || \" \"});  \r\n                                            // \"|| space\" thing is a hack for auto height stuff\r\n            h.needToFixHeights = h.needToFixHeights.add(\r\n                            h.$view.insertClonedChildren(newStuff[i].at,h.$new_li,lines)    );            \r\n        }\r\n    }\r\n\r\n    \r\n    if(e.data.vals_ui8buffer){\r\n        \r\n        if(h.needToRefindViewChildren){\r\n            h.$rev_lines_ = h.$view.children();\r\n            h.needToRefindViewChildren = false;\r\n        }\r\n        var $rl_ = h.$rev_lines_;\r\n        \r\n        if(h.needToFixHeights.length){\r\n            text_multi(h.$revisions_status, \"Obtaining line height data...\");\r\n            h.needToFixHeights.fixHeightFromAuto();\r\n            h.needToFixHeights = $([]);\r\n            text_multi(h.$revisions_status, \"Selecting lines...\");\r\n        }\r\n        \r\n        var vals = new Uint8Array(e.data.vals_ui8buffer)\r\n        $rl_.setAttribute('v',function(i){return vals[i]});\r\n            \r\n        // We have to manually set the width of the numbers (our version of ace's gutter)\r\n        switch(e.data.digits){\r\n            case 0:\r\n            case 1:\r\n            case 2:\r\n                h.$view.setAttribute('digits','');\r\n                break;\r\n            case 3:\r\n                h.$view.setAttribute('digits','###');\r\n                break;\r\n            case 4:\r\n                h.$view.setAttribute('digits','####');\r\n                break;\r\n            default:\r\n                h.$view.setAttribute('digits','#####');\r\n        }\r\n    }\r\n    \r\n        \r\n}\r\n","\"use strict\";\r\n\r\n/*\r\nThe find focus/blur problem\r\n============================\r\n\r\nWe have to work quite hard to give the user a good focus/blur experience.  The hooks for all the\r\nbehaviour are spread across various files, but we list all the cases here and the desired outcomes.\r\n\r\nThe main principle is that we only show results in the widget & mark them\r\nin the editor when find_active is true.  And when this flag is true\r\nwe force the input to keep the focus, unless we have reason to let it go\r\nback to the editor.\r\n\r\nSetting find_active to false is fairly simple, and can be done with the\r\nfind_set_find_active_false() function.  Setting it to true is a bit more complciated:\r\nit may have previously been false, or it may have already been true, and if true the search\r\n may not even need to be re-run. All three cases are dealt with by \r\nthe find_set_find_active_true() function.\r\n\r\nHere is a list of all the relevant actions that have to be considered, we label each with T/F, indicating\r\nwhether find_active should be true or false after the action:\r\n\r\n(a)   T typing standard chars or backspace in input\r\n(b)   T typing up/down or (Enter/Shift-Enter) in input\r\n(c)   T clicking results in widget\r\n(d.1) T clicking search settings buttons when find_active is true\r\n(d.2) F clicking search settings buttons when find_active is false and search str is empty\r\n(d.3) T clicking search settings buttons when find_active is false and search str is non-empty\r\n(e.1) T using ctrl-f shortcut, possibly with find-pane already visible\r\n(e.2) T^ using ctrl-f shorctut, possibly with find-pane already visible, with text selected\r\n(f.1) T opening widget directly into find with Esc\r\n(f.2) F open widget directly into find by clicking widget\r\n(g)   T clicking, to select find pane, with widget already open\r\n(h)   F g_settings remotely opening widget into find\r\n(i)   F* pressing Esc with find_active true\r\n(j)   F* ressing Esc or clicking the widget with find_active false, but find_pane showing\r\n(k)   F pressing Tab with find_active true\r\n(l.1) F switching to another pane with find_active true\r\n(l.2) F switching to another pane with find_active false\r\n(m)   F clicking editor (when find_active is true)\r\n(n)   F g_settings remotely switch to another pane or close widget\r\n(o)   T clicking the input\r\n\r\n*for (j) and (i), we should close the widget as well as setting find_active to false.\r\n^ for (e.2) we need to make set the search string to the selection\r\n\r\nTwo important callees of find_set_find_active_false() are the handlers for:\r\n    g_settings.set('pane', <all_panes_except_find>) ...and...\r\n    g_settings.set('pane_open', false)\r\nThis covers a number of the actions in the list above.\r\n\r\n\r\n...and then we have to deal with replace input as well, but let's leave that for now!!\r\n...and maybe evetunally the realtime document changes.\r\n\r\n*/\r\n\r\ndn.find_results = [];\r\ndn.find_current_match_idx = -1;\r\ndn.find_markers = [];\r\ndn.find_marker_current = undefined;\r\ndn.find_str = \"\";\r\n\r\ndn.find_active = false; \r\n\r\ndn.find_set_find_active_false = function(){\r\n    if(!dn.find_active)\r\n        return;\r\n    dn.find_active = false;\r\n\r\n    // remove all markers\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    // reset widget display\r\n    dn.el.find_info.textContent = dn.find_str === \"\" ? \"type to search\" : \"search inactive\";\r\n    dn.el.find_results.innerHTML = \"\";\r\n\r\n    // forget last search\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n\r\n    // forget last selection in input (in preparation for next time it gets focus)\r\n    dn.el.find_input.setSelectionRange(dn.el.find_input.selectionEnd, dn.el.find_input.selectionEnd);\r\n\r\n    // restore focus to editor\r\n    dn.editor.setHighlightSelectedWord(true); // we had this on false during find\r\n    dn.focus_editor();\r\n\r\n\r\n    /*\r\n    clearTimeout(dn.blur_find_and_focus_editor_timer);\r\n    dn.blur_find_and_focus_editor_timer = 0;\r\n    if(flag===\"delay\"){\r\n        dn.blur_find_and_focus_editor_timer = setTimeout(dn.blur_find_and_focus_editor,10); //this gives the other input element time to cancel the closing if there is a blur-focus event when focus shifts\r\n        return; //note that we are assuming here that the blur event is triggered on the first element *before* the focus is triggered on the second element..if that isn't guaranteed to be true we'd need to check whether the second element already has the focus when the first element gets its blur event.\r\n    }\r\n    */\r\n\r\n}\r\n\r\ndn.find_set_find_active_true = function(select_match_idx){\r\n    /* There are three reasons this can be called:\r\n        1. dn.find_active was previously false, and we now need to do everything from scratch\r\n        2. dn.find_active was true, but the search stirng or settings have changed, so we\r\n           need to re-run the search (which is almost identical to 1).\r\n        3. find_active was true and we are just navigating through results rather than\r\n           changing the search.  To select this option rather than 2, pass the select_match_idx\r\n           as an argument. \r\n    */\r\n\r\n    if(!dn.find_active){\r\n        dn.find_active = true;\r\n        dn.AceSearch = dn.AceSearch || ace.require(\"./search\").Search;\r\n        dn.AceRange = dn.AceRange || ace.require(\"./range\").Range;\r\n        dn.editor.setHighlightSelectedWord(false);\r\n    }\r\n\r\n    if(select_match_idx === undefined)\r\n        dn.find_perform_search();\r\n    else\r\n        dn.find_select_result_idx(select_match_idx);\r\n\r\n    dn.el.find_input.focus();\r\n}\r\n\r\ndn.find_perform_search = function(){\r\n    // clear previous find (but leave selection for now)\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if(dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current)\r\n        dn.find_marker_current = undefined;\r\n    }\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n    dn.el.find_results.innerHTML = \"\";  \r\n    \r\n    var str = dn.find_str = dn.el.find_input.value; // we only store it to make it easier for key_down to check for true changes\r\n\r\n    // If requested, try and parse as regex. On failure display no results with message.\r\n    var use_reg_exp = dn.g_settings.get('find_regex');\r\n    if(use_reg_exp){\r\n        var re = undefined;\r\n        try {\r\n            re = new RegExp(str);\r\n        } catch(e) {\r\n            dn.el.find_info.textContent = escape_str(e.message); //TODO: could force first letter to lower case\r\n        }\r\n    }\r\n\r\n    if(use_reg_exp && re === undefined){\r\n        // failed regex, don't show any results\r\n        dn.editor.selection.clearSelection();\r\n\r\n    } else if(str == \"\"){\r\n        // empty string (including empty regex), dont show any results\r\n        dn.el.find_info.textContent = \"type to search. \" + dn.ctrl_key + \"-up/down for history.\";\r\n        dn.editor.selection.clearSelection();\r\n        \r\n    } else {\r\n        // valid regex or pure str search..\r\n\r\n        // This is the actual search\r\n        var search = new dn.AceSearch();\r\n        search.setOptions({\r\n            needle: use_reg_exp ? re : str,\r\n            wrap: true,\r\n            caseSensitive: dn.g_settings.get('find_case_sensitive'),\r\n            wholeWord: dn.g_settings.get('find_whole_words'),\r\n            regExp: use_reg_exp\r\n        });\r\n        var results = dn.find_results = search.findAll(session);\r\n\r\n        if(results.length === 0){\r\n            // No results to display, life is easy...\r\n            dn.el.find_info.textContent = \"no matches found.\";\r\n            dn.editor.selection.clearSelection();\r\n\r\n        }else{\r\n            // Right, we got some results ....\r\n\r\n            // Work out which result we should consider the current match.\r\n            var selected_range = session.getSelection().getRange();\r\n            for(var ii=0; ii<results.length; ii++) \r\n                if(results[ii].end.row > selected_range.start.row  || \r\n                    (results[ii].end.row == selected_range.start.row &&\r\n                     results[ii].end.column >= selected_range.start.column))\r\n                break;\r\n            var current_match_idx = (ii == results.length ? results.length-1 : ii);\r\n\r\n            // Add markers into the editor to show *all* the results\r\n            for(var ii=0; ii<results.length; ii++)\r\n                dn.find_markers.push(session.addMarker(results[ii], \"find_match_marker\", \"find_match_marker\", false));\r\n\r\n            // augment the results with their idx, this is useful for the subselection stuff\r\n            for(var ii=0; ii<results.length; ii++)\r\n                results[ii] = {range: results[ii], idx: ii};\r\n\r\n            // Render a subset of the results into the widget and mark & select the current match\r\n            dn.find_select_result_idx(current_match_idx);\r\n        }\r\n\r\n    }\r\n\r\n\r\n    //dn.find_str = str;\r\n    //if(dn.g_find_history && isNaN(dn.find_history_pointer)){\r\n    //    if(dn.find_history_add_timeout)\r\n    //        clearTimeout(dn.find_history_add_timeout);\r\n    //    if(str.length)\r\n    //        dn.find_history_add_timeout = setTimeout(function(){dn.add_to_find_history(str);},dn.find_history_add_delay)\r\n    //}\r\n}\r\n\r\ndn.find_select_result_idx = function(current_match_idx){\r\n    /* This is called within find_perform_search when a new search returns some results, it's also\r\n       called when we move through the results without changing the search.   */\r\n\r\n    // Get a small sub set of results to show in the widget.\r\n    // We carefully implement some wrapping logic, which is a bit fiddly.\r\n    dn.find_current_match_idx = current_match_idx;\r\n\r\n    var session = dn.editor.getSession();\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    var results = dn.find_results;\r\n    var results_sub = [];\r\n    \r\n    if(results.length <= dn.find_max_results){\r\n        results_sub = results;\r\n    }else{\r\n        var n = Math.floor(dn.find_max_results/2);\r\n        if(current_match_idx < n){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n));\r\n            results_sub = results_sub.concat(results.slice(0, current_match_idx));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n, current_match_idx));\r\n        }\r\n        results_sub.push(results[current_match_idx]); \r\n        if(current_match_idx + n >= results.length){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1));\r\n            results_sub = results_sub.concat(results.slice(0, n + 1 - (results.length - current_match_idx)));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1, current_match_idx + n + 1));\r\n        }\r\n    }\r\n\r\n    // Now lets build the html to show the subset of results in the widget\r\n    var html = \"\";\r\n    for(var ii=0; ii<results_sub.length; ii++){\r\n        var row = results_sub[ii].range.start.row;\r\n        var col = results_sub[ii].range.start.column;\r\n        var prefix_range = new dn.AceRange(row, Math.max(0, col-dn.find_max_prefix_chars), row, col);\r\n        var pre_ellipses = col > dn.find_max_prefix_chars; //TODO: deal with indent better\r\n        row = results_sub[ii].range.end.row;\r\n        col = results_sub[ii].range.end.column;\r\n        var suffix_range = new dn.AceRange(row, col, row, col+dn.find_max_suffix_chars);\r\n        html += \"<div class='find_result_item\" + (results_sub[ii].idx==current_match_idx? \" find_result_current\" : \"\") + \"'>\" +\r\n                    \"<div class='find_result_line_num'>\" + (row+1) + \"</div>\" +\r\n                    \"<div class='find_result_text'>\" +\r\n                        \"<div class='find_result_text_inner'>\" +\r\n                            (pre_ellipses ? \"&#8230;\" : \"\") + escape_str(session.getTextRange(prefix_range)) +\r\n                            \"<span class='find_result_match'>\" + escape_str(session.getTextRange(results_sub[ii].range)) + \"</span>\" +\r\n                            escape_str(session.getTextRange(suffix_range)) +\r\n                        \"</div>\" +\r\n                    \"</div>\" +\r\n                \"</div>\";\r\n    }\r\n    dn.el.find_results.innerHTML = html;\r\n    var els = dn.el.find_results.getElementsByClassName('find_result_item');\r\n    for(var ii=0; ii<els.length; ii++) if(results_sub[ii].idx !== current_match_idx)\r\n        els[ii].addEventListener('click', dn.find_result_click(results_sub[ii].idx));\r\n\r\n    if(results.length > dn.find_max_results)\r\n        dn.el.find_info.textContent = \"... and \" + (results.length - dn.find_max_results) + \" more matches\";\r\n    else\r\n        dn.el.find_info.textContent = \"\";\r\n\r\n    // do the special marker for the current selection and actually select it\r\n    dn.find_marker_current = session.addMarker(results[current_match_idx].range, \"find_current_match_marker\", \"find_current_match_marker\", false);\r\n    dn.editor.selection.setSelectionRange(results[current_match_idx].range, false);\r\n    dn.editor.renderer.scrollSelectionIntoView();\r\n}\r\n\r\n\r\ndn.find_blur_input = function(){\r\n    dn.find_set_find_active_false();\r\n}\r\n\r\ndn.find_settings_changed = function(){\r\n    // TODO: if the settings were changed remotely then we don't want to set find_active to true\r\n    if(dn.g_settings.get('pane') === 'pane_find' && dn.g_settings.get('pane_open') &&  \r\n        (dn.el.find_input.value || dn.find_active))\r\n        dn.find_set_find_active_true();\r\n}\r\n\r\ndn.find_result_click = function(ii){\r\n    return function(e){dn.find_set_find_active_true(ii);};\r\n}\r\n\r\ndn.find_input_focus = function(){\r\n    if(!dn.find_active) // we have to test to prevent recursion\r\n        dn.find_set_find_active_true();\r\n}\r\n\r\ndn.find_input_keydown = function(e){ \r\n    //we want keydown here so that we can get repeated firing with keydown (i think on most browsers)\r\n\r\n    if ((e.which == WHICH.ENTER && !e.shiftKey) || (!e.ctrlKey && e.which == WHICH.DOWN)){\r\n        //find next\r\n        dn.find_set_find_active_true(dn.find_current_match_idx + 1 < dn.find_results.length ? \r\n                                    dn.find_current_match_idx + 1 \r\n                                  : 0);\r\n        e.preventDefault();\r\n        return;\r\n    }else if((e.which == WHICH.ENTER && e.shiftKey) || (!e.ctrlKey && e.which == WHICH.UP)){\r\n        //find previous\r\n        dn.find_set_find_active_true(dn.find_current_match_idx - 1 < 0 ? \r\n                                    dn.find_results.length -1 \r\n                                  : dn.find_current_match_idx - 1);\r\n        e.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if(e.which == WHICH.ESC){\r\n        dn.find_set_find_active_false(); \r\n        dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n        e.preventDefault();\r\n        return;   \r\n    }\r\n    /*                                 \r\n    \r\n        //the normal togglewidget shortcut will kick in\r\n    }\r\n    if(e.ctrlKey && (e.which == WHICH.UP || e.which == WHICH.DOWN)){\r\n        if(isNaN(dn.find_history_pointer)){\r\n            dn.add_to_find_history(dn.find_str);  //when we begin delving into history\r\n            dn.find_history_pointer = dn.g_find_history.length-1;\r\n        }\r\n        dn.find_history_pointer += e.which == WHICH.DOWN? -1 : +1;\r\n        dn.find_history_pointer = dn.find_history_pointer < 0 ? 0 : dn.find_history_pointer;\r\n        dn.find_history_pointer = dn.find_history_pointer > dn.g_find_history.length-1 ? dn.g_find_history.length-1 : dn.find_history_pointer; \r\n        var newStr = dn.g_find_history.get(dn.find_history_pointer);\r\n        dn.el.find_input.value = newStr;\r\n        dn.do_find(newStr);\r\n        e.preventDefault();\r\n    }\r\n    */\r\n\r\n\r\n}\r\n\r\n\r\ndn.find_input_keyup = function(e){ \r\n    //we need keyup here in order that the val has the new character or new backspace\r\n    if(e.which == WHICH.ENTER || e.which == WHICH.ESC || e.which == WHICH.UP || e.which == WHICH.DOWN)\r\n        return; \r\n    if(dn.find_str == dn.el.find_input.value)\r\n        return;\r\n    //if(dn.el.find_input.value != dn.find_str)\r\n    //    dn.find_history_pointer = NaN;\r\n    dn.find_set_find_active_true()\r\n}\r\n\r\n\r\n/*\r\ndn.add_to_find_history = function(str){\r\n    clearTimeout(dn.find_history_add_timeout); // in case this was called directly\r\n    dn.find_history_add_timeout = 0;\r\n    if(!str.length || !isNaN(dn.find_history_pointer))\r\n        return;\r\n        \r\n        //TODO: there is an inconsistency here: the find is case-insensitive, but lastIndexOf is case sensitiv\r\n    if(dn.g_find_history.lastIndexOf(str) != -1)\r\n        dn.g_find_history.remove(dn.g_find_history.lastIndexOf(str)); //if the string was already in the list somewhere we remove the old item so that values are unique\r\n    //note that strictly speaking I think these operations should be done within a pair batching flags, but it doesn't really matter here.\r\n    dn.g_find_history.push(str); \r\n}\r\n\r\n\r\ndn.cancel_blur_find_and_focus_editor = function(){\r\n    clearTimeout(dn.blur_find_and_focus_editor_timer);\r\n    dn.blur_find_and_focus_editor_timer = 0;\r\n}\r\n*/\r\n\r\n\r\n/*    \r\ndn.find_input_focus = function(){\r\n    dn.cancel_blur_find_and_focus_editor();\r\n    dn.showing_find_results = true;\r\n    if(dn.showing_replace)\r\n        dn.el.replace_input.setAttribute(\"tabindex\", parseInt(dn.el.find_input.getAttribute(\"tabindex\"))+1); //we want to force the replace input to always be the next tab index\r\n    dn.do_find(dn.find_str);\r\n}\r\n\r\ndn.find_input_blur = function(){\r\n    if(dn.showing_replace)\r\n        dn.blur_find_and_focus_editor(\"delay\");\r\n    else\r\n        dn.blur_find_and_focus_editor();\r\n}\r\n*/\r\n\r\n/*\r\n\r\ndn.find_goto_keyup = function(e){\r\n    if(e.which == WHICH.ENTER || e.which == WHICH.ESC){\r\n        if(e.which == WHICH.ENTER) //if it's esc the normal ToggleWidget shortcut will kick in.\r\n            dn.el.widget_goto.style.display = 'none';\r\n       dn.focus_editor();\r\n        return;\r\n    }\r\n    if(this.value){\r\n        var line = parseInt(this.value, 10);\r\n        if(!isNaN(line))\r\n            dn.editor.gotoLine(line,0,true);\r\n    }\r\n}\r\n\r\n\r\ndn.find_replace_input_blur = function(){\r\n    dn.blur_find_and_focus_editor(\"delay\");\r\n}\r\n\r\ndn.find_replace_input_focus = function(){\r\n    dn.cancel_blur_find_and_focus_editor();\r\n    if(!dn.showing_find_results)\r\n        dn.do_find(dn.find_str);\r\n    //we want to force the find input to always be the next tab index\r\n    dn.el.find_input.setAttribute(\"tabindex\",parseInt(dn.el.replace_input.setAttribute(\"tabindex\"))+1); \r\n    if(dn.find_result_markers.length)\r\n        dn.el.find_replace_info.innerHTML = \"Found \" + dn.find_result_markers.length + \" occurances<br>\" +\r\n         \"Enter: replace current selection<br>Ctrl+Enter: replace all<br>Esc: hide the find/replace box<br>Tab: focus on find field\";\r\n    else\r\n        dn.el.find_replace_info.innerHTML = \"Nothing to replace.<br>Esc: hide the find/replace box<br>Tab: focus on find field\";\r\n}\r\n\r\ndn.find_replace_input_keydown = function(e){ \r\n    //we want keydown here so that we can get repeated firing whith keydown (i think on most browsers)\r\n    if(e.which == WHICH.ENTER){\r\n        if(!dn.find_result_markers.length)\r\n            return;\r\n        var n = e.ctrlKey ? dn.find_result_markers.length : 1;\r\n        if(e.ctrlKey)\r\n            dn.editor.replaceAll(dn.el.replace_input.value);\r\n        else\r\n            dn.editor.replace(dn.el.replace_input.value);\r\n        if(e.shiftKey)\r\n            dn.editor.findPrevious()\r\n        else\r\n            dn.editor.findNext();\r\n        dn.do_find(dn.find_str); \r\n        if(dn.find_result_markers.length){\r\n            dn.el.find_replace_info.innerHTML = \"Replaced \" + n + \" occurence\" + (n>1? \"s\" : \"\") + \". <br>\" +  dn.find_result_markers.length + \" occurances remain<br>\" +\r\n             \"Enter: replace current selection<br>Ctrl+Enter: replace all<br>Esc: hide the find/replace box<br>Tab: focus on find field\";\r\n        } else {\r\n            dn.el.find_replace_info.innerHTML = \"Replaced \" + (n>1 ? \"all \" + n + \" occurences\" : \"the 1 occurance\") +\r\n            \". <br> Nothing further to replace.<br>Esc: hide the find/replace box<br>Tab: focus on find field\";\r\n        }\r\n    }\r\n    if(e.which == WHICH.ESC){\r\n        dn.blur_find_and_focus_editor(); \r\n        //the normal togglewidget shortcut will kick in\r\n    }\r\n}\r\n*/\r\n\r\n\r\n\r\n\r\n/*\r\ndn.show_replace = function(){\r\n    dn.showing_replace = true;\r\n    dn.el.replace_form.style.display = '';\r\n    var sel = dn.editor.session.getTextRange(dn.editor.getSelectionRange());\r\n    dn.el.pane_find.style.display = '';\r\n    if(sel)\r\n        dn.el.find_input.value = sel;\r\n    dn.el.find_input.focus()\r\n    if(!sel)\r\n        dn.el.find_input.select();\r\n    return false;\r\n}\r\n*/\r\n\r\n\r\n/*\r\nA \"quick\", no sorry, a \"longish\" note:\r\nEach time DoFind runs it stores its str in dn.find_str for next time.\r\ndn.find_history_pointer is nan except when we are cycling through history. As soon \r\nas we change the search string we leave this history-cyclying mode.  Also, immediately before\r\nentering the history-cycling mode we store the current str at the top of the history so it's\r\navailable to come back to.\r\nA search is added to the history if it's not the empty string and has not been modified for \r\ndn.find_history_add_delay milliseconds.\r\nDealing with focus is a bit of a pain.  Basically either of the two input boxes may have it\r\nor a third party (such as he editor itself) may have it. We only want to show the markings\r\nwhen one of the two input boxes has the focus and not otherwise.  Also, while the inputs have the focus\r\nthey disable the editor's steal-back-the-focus timer, which normally ensures it doesn't loose the focus.\r\nSo we need to make sure that timer is reneabled when the focus is with neither of the two inputs.\r\nTo make this work, whenver one of the inputs loses focus (the \"blur\" event) it triggers a delayed\r\ncall to BlurFindAndFocusEditor, the fact that it is delayed allows the other input to cancel\r\nthe call if it is the thing recieving the focus, otherwise it will go ahead.\r\nThere are other complications too, but this is the bulk of it.\r\n*/\r\n","\"use strict\";\r\n\r\ndn.platform = (function(){\r\n    if(navigator.platform.indexOf(\"Win\") >-1)\r\n        return \"Windows\";\r\n    else if(navigator.platform.indexOf(\"Linux\") >-1)\r\n        return \"Linux\";\r\n    else if(navigator.platform.indexOf(\"Mac\")>-1)\r\n        return \"Mac\";\r\n        \r\n    return null;\r\n})();\r\n\r\ndn.create_pane_shortcuts = function(){\r\n//This is hardly the world's most efficient way of doing this....(but it probably doesn't matter)...\r\n\r\n    var arry = dn.shortcuts_list;\r\n    var dict = {};\r\n    var platform = dn.platform;\r\n\r\n    if(platform == \"Windows\" || platform == \"Linux\"){\r\n       for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts[1];\r\n        }\r\n    }else if(platform == \"Mac\"){\r\n        for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts.length > 2? parts[2] : parts[1];\r\n        }\r\n    }else{\r\n        //TODO: show something here, maybe let user switch, maybe have touch info for ipad & android.\r\n    }\r\n    \r\n    var html = [];\r\n    for(var action in dict)\r\n        html.push(\"<div class='shortcut_item'><div class='shortcut_action'>\" + \r\n                   action + \"</div><div class='shortcut_key'>\" + dict[action].replace(\",\",\"<br>\") +\r\n                   \"</div></div>\");\r\n    for(var action in dn.tooltip_info)if(action in dict)\r\n        dn.tooltip_info[action] += dict[action];\r\n\r\n    dn.el.pane_help_shortcuts.innerHTML =  [\r\n        \"<div class='widget_box_title shortcuts_title'>Keyboard Shortcuts \",\r\n             platform ? \"(\" + platform + \")\" : \"\" ,\r\n        \"</div>\",\r\n        \"<div class='shortcuts_header_action'>action</div><div class='shortcuts_header_key'>key</div>\",\r\n        \"<div class='shortcuts_list'>\",\r\n        html.join(''),\r\n        \"</div>\"].join('');\r\n\r\n};\r\n\r\ndn.esc_pressed = function(e){\r\n    var will_show_find = !dn.g_settings.get('pane_open') && dn.g_settings.get('pane') == 'pane_find';\r\n    if(will_show_find)\r\n        dn.find_set_find_active_true();\r\n    dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open')); // doing this after the find_active=true, tells the change handler not to put focus back to editor\r\n    if(will_show_find)\r\n        dn.el.find_input.focus(); // we have to do this explcitly because we ran find_active=true when the input was (possibly) hidden\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_shortcut_used = function(e){\r\n    var sel = dn.editor.session.getTextRange(dn.editor.getSelectionRange());\r\n    if(sel)\r\n        dn.el.find_input.value = sel;\r\n    dn.find_set_find_active_true();\r\n    dn.g_settings.set('pane', 'pane_find'); // doing this after the find_active=true, tells the change handler not to put focus back to editor\r\n    if(sel)\r\n        dn.el.find_input.select();\r\n    else\r\n        dn.el.find_input.focus(); // we have to do this explcitly because we ran find_active=true when the input was (possibly) hidden\r\n    e.preventDefault();\r\n}\r\n\r\ndn.make_keyboard_shortcuts = function(){\r\n    //perviously was using ace for handling these shorcuts because it neater (and efficient?) but it was\r\n    //annoying trying to ensure the editor always had focus, and not clear what to do when the editor wasn't showing.\r\n    \r\n    //we have to delete the default ace commands linked to the keys we care about\r\n    dn.editor.commands.removeCommands([\r\n        \"find\",\"findprevious\",\"findnext\",\"replace\",\"jumptomatching\",\"sortlines\",\"selecttomatching\",\"gotoline\"]);\r\n\r\n    //then add new commands on to the document using keymaster.js...\r\n    key('command+s, ctrl+s,  ctrl+alt+s,  command+alt+s', dn.save_content);\r\n    key('command+p, ctrl+p,  ctrl+alt+p,  command+alt+p', dn.do_print);\r\n    key('command+o, ctrl+o,  ctrl+alt+o,  command+alt+o', dn.do_open);\r\n    key('command+n, ctrl+n,  ctrl+alt+n,  command+alt+n', dn.do_new);\r\n    key('command+l, ctrl+l,  ctrl+alt+l,  command+alt+l', dn.show_go_to);\r\n    key('command+f, ctrl+f,  ctrl+alt+f,  command+alt+f', dn.find_shortcut_used); \r\n    key('command+r, ctrl+r,  ctrl+alt+r,  command+alt+r' + \r\n       ', command+g, ctrl+g,  ctrl+alt+g,  command+alt+g', dn.show_replace);\r\n    key('command+h, ctrl+h,  ctrl+alt+h,  command+alt+h', dn.start_revisions_worker);\r\n    key('esc', dn.esc_pressed);\r\n    key.filter = function(){return 1;}\r\n\r\n    // it seems like the clipboard history cycling only works the old way, i.e. using ace....\r\n    var HashHandler = require(\"ace/keyboard/hash_handler\").HashHandler\r\n    var extraKeyEvents = new HashHandler([\r\n        {bindKey: {win: \"Ctrl-Left\",mac: \"Command-Left\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Down\",mac: \"Command-Down\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Right\",mac:\"Command-Right\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right},\r\n        {bindKey: {win: \"Ctrl-Up\",mac:\"Command-Up\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right}\r\n    ]);\r\n    dn.editor.keyBinding.addKeyboardHandler(extraKeyEvents);\r\n\r\n    // Change \"ctrl\" to \"cmd\" if on Mac\r\n    dn.ctrl_key = \"crtl\"\r\n    if(dn.platform == 'Mac'){\r\n        dn.ctrl_key = 'cmd';\r\n        var els = dn.getElementsByClassName('ctrl_key');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].textContent = 'cmd'\r\n    }\r\n}\r\n","\"use strict\";\r\n// DRIVE NOTEPAD 2016\r\n// by DM\r\n\r\ndn.version_str = '2016a';\r\n\r\n// ############################\r\n// Constants and defaults, see alsp info.js\r\n// ############################\r\n\r\ndn.can_show_drag_drop_error = true;\r\ndn.is_showing_history = false;\r\n\r\ndn.status = {\r\n    // 0: get action in progress\r\n    // -1: failed\r\n    //  1: success\r\n    file_body: 0, \r\n    file_meta: 0, \r\n    file_sharing: 0, // after launching the sharing dialog this is set to -1\r\n    authentication: 0,\r\n    popup_active: 0, // 0 or 1, i.e. true or false\r\n    local_settings: 0,\r\n}\r\n\r\ndn.the_file = {\r\n    file_id: null,\r\n    folder_id: null,\r\n    title: null,\r\n    description: '',\r\n    ext: '',\r\n    loaded_mime_type: '',\r\n    new_line_detected: 'none', //'windows', 'unix','mixed', or 'none'\r\n    tab_detected: {val: 'none'},\r\n    is_pristine: true, //true while the document has no unsaved changes (set to true when we request the save not when we get confirmation, but if there is a save error it will be reverted to false).\r\n    mime_type: '',\r\n    is_saving: false,\r\n    data_to_save: {body: null, title: null, description: null}, //holds the values until confirmation of success for each\r\n    generation_to_save: {body: 0, title: 0, description: 0},//when saves return they check their this.description etc. against here and clear data_to_save if they match\r\n    is_read_only: false,\r\n    is_shared: false,\r\n    is_brand_new: false, // true from the point of creating a new document till the point we get confirmation of a successful save\r\n    is_reading_file_object: false, //this is used on drag and drop,\r\n    custom_props: {}, //these are the props potentially stored on the file using the custom properties API\r\n    custom_prop_exists: {}, //each of the custom props that actually exsits for the file will have an entry in this obj, with the key being the property and the value being true.\r\n    saving_title_count: 0 //tracks the number of active save request with just the title.  Whatever the resp, this number is decremented,\r\n};\r\ndn.change_line_history = [];\r\ndn.last_change = null;\r\ndn.change_line_classes =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_',8,5)\r\ndn.change_line_classes_rm =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_rm',8,5)\r\ndn.el = dn.el || {};\r\n\r\n/* ################################################################################################################\r\n\r\n    [Some Notes on settings in Drive Notepad]\r\n\r\n    There are two kinds of settings: per-user settings and per-file settings.\r\n    \r\n    The user settings are stored in dn.g_settings. When the page is loaded this is a fake Google Realtime model, \r\n    which uses a mixture of default values and values read from localStorage.  At some point after authenticating \r\n    the g_settings will become the true Google Realtime model. Whenever a value in g_settings is changed\r\n     dn.setting_changed is called with the appropriate paramaters, this is true right from when the page loads, \r\n     i.e. the first set of values trigger the SettingsChanged, but after that only modifications will trigger a change\r\n      (regardless of whether g_settings is the true model or not).  Use the .set() and .get() methods on the dn.g_settings.\r\n    \r\n    The per-file settings are stored in dn.the_file.custom_props.  When the page is loaded they are initialised with \r\n    default values.  Then, if we have opened an existing file, at some point they will be updated with the true values. \r\n     These settings are *not* a realtime model, rather they are Custom Properties (there's an API for it).  Again, as\r\n      with the per-user settings, whenever the file settings are changed they trigger a call to PropertyUpdated.  Note\r\n       that since this is not backed by a realtime model we won't get changes on the server push to the browser, only\r\n        local changes will be observed.  The per-file settings are shared across anyone who has read and/or write access \r\n        to the file in question. Note that if the default value is chosen the setting value is simply removed from the file.\r\n          Use the dn.set_property() function to set values and read values straight from the dn.the_file.custom_props object.\r\n    \r\n    For each key \"Something\" in customProps there is a function dn.apply_something_choice() which will read the per-user \r\n    and/or the per-file settings (as appropriate) and use the combined result to apply the chosen setting to the editor, \r\n    additionally the function will render the file settings tab and/or the general settings tab. As part of this function \r\n    there will likely be a call to dn.detect_something, which will run some fairly simple heuristic over the current file.\r\n      [TODO: may want to cache this, as it can end up getting called several times during loading and possibly elsewhere.] \r\n      [TODO: may want to have an ApplySomethingChoice for all settings not just those that are covered by customProps.]\r\n\r\n################################################################################################################## */\r\n\r\n\r\n// ############################\r\n// Auth stuff\r\n// ############################\r\n\r\ndn.authentication_done = function(auth_result){\r\n    dn.status.popup_active = 0;\r\n    if (!auth_result)\r\n        return dn.authentication_failed(null);\r\n    if(auth_result.error)\r\n        return dn.authentication_failed(auth_result.error);\r\n\r\n    dn.status.authentication = 1;\r\n    dn.show_status();\r\n\r\n    if(!dn.user_info)\r\n        dn.get_user_info();\r\n    if(dn.the_file.file_id &&  dn.status.file_meta != 1 || dn.status.file_body != 1)\r\n        dn.load_file();\r\n    dn.get_properties_from_cloud();\r\n\r\n    // Access token has been successfully retrieved, requests can be sent to the API\r\n    //TODO: make these redundant\r\n    gapi.load('drive-realtime', dn.get_settings_from_cloud());\r\n    gapi.load('drive-share', function(){\r\n        dn.el.share_dialog = new gapi.drive.share.ShareClient(dn.client_id);\r\n    });\r\n}\r\n\r\ndn.get_user_info = function(){\r\n   Promise.resolve(\r\n        gapi.client.request({\r\n            'path' : 'userinfo/v2/me?fields=name'\r\n        })).then(function(a){\r\n            dn.user_info = a.result;\r\n            dn.el.user_name.textContent = a.result.name;\r\n        }, function(err){\r\n            // TODO: could be auth problem\r\n            dn.show_error('Failed to get user info');\r\n            console.dir(err);\r\n        });\r\n}\r\n\r\ndn.authentication_failed = function(err){\r\n    dn.status.authorization = -1;\r\n    dn.status.popup_active = 0;\r\n    dn.show_status();\r\n    if(err)\r\n        dn.show_error(err.result.error.message);\r\n    else\r\n        dn.show_pane_permissions(); // No access token could be retrieved, force the authorization flow.\r\n}\r\n\r\ndn.reauth = function(callback){ \r\n    // TODO: as promise\r\n    dn.status.authentication = 0;\r\n    dn.show_status();\r\n    gapi.auth.authorize(dn.auth_map(true), function(){\r\n        dn.status.authentication = 1;\r\n        dn.show_status();\r\n        callback();\r\n    });\r\n}\r\n\r\ndn.launch_popup = function(){\r\n    dn.status.popup_active = 1;\r\n    dn.status.authorization = 0;\r\n    dn.show_status();    \r\n    Promise.resolve(\r\n        gapi.auth.authorize(dn.auth_map(false)))\r\n        .then(dn.authentication_done,\r\n              dn.authentication_failed);\r\n}\r\n\r\ndn.show_pane_permissions = function(){\r\n    dn.g_settings.set('pane', 'pane_permissions');\r\n    css_animation(dn.el.the_widget, 'shake', function(){}, dn.error_delay_ms);\r\n}\r\n\r\n\r\n// ############################\r\n// Sharing stuff\r\n// ############################\r\n\r\ndn.do_share = function(){\r\n    if(!dn.the_file.file_id){\r\n        dn.show_error(\"You cannot view/modify the sharing settings until you have saved the file.\")\r\n        return false;\r\n    }\r\n    dn.status.file_sharing = -1; //TODO: see SO question about no callback for share dialog...how are we supposed to know when it's closed and what happened?\r\n    dn.the_file.is_shared = 0;\r\n    dn.show_status();\r\n    dn.el.share_dialog.setItemIds([dn.the_file.file_id]);\r\n    dn.el.share_dialog.showSettingsDialog();\r\n    return false;\r\n}\r\n\r\n\r\n// ############################\r\n// Newline stuff\r\n// ############################\r\n\r\ndn.detect_new_line = function(str){\r\n    dn.the_file.new_line_detected = (function(){\r\n        //no special reason to use a self-executing function here, it's just lazy coding\r\n        var first_n = str.indexOf(\"\\n\");\r\n        if(first_n == -1)\r\n            return dn.show_newline_status(\"none\");\r\n    \r\n        var has_rn = str.indexOf(\"\\r\\n\") != -1;\r\n        var has_solo_n = str.match(/[^\\r]\\n/) ? true : false;\r\n        \r\n        if(has_rn && !has_solo_n)\r\n            return dn.show_newline_status(\"windows\");\r\n        if(has_solo_n && !has_rn)\r\n            return dn.show_newline_status(\"unix\")\r\n        \r\n        return dn.show_newline_status(\"mixed\");\r\n    })();    \r\n}\r\n\r\ndn.apply_newline_choice = function(str){\r\n        \r\n    var newlineDefault = dn.g_settings.get('newLineDefault');\r\n    \r\n    if(newlineDefault == \"windows\"){\r\n        dn.el.newline_menu_windows.classList.add('selected')\r\n        dn.el.newline_menu_unix.classList.remove('selected');\r\n    }else{//newlineDefault should be unix\r\n        dn.el.newline_menu_unix.classList.add('selected')\r\n        dn.el.newline_menu_windows.classList.remove('selected');\r\n    }             \r\n                \r\n   if(typeof str == \"string\")\r\n       dn.detect_new_line(str); //Note that it only makes sense to detect new line on downloaded content\r\n   \r\n   dn.show_newline_status(dn.the_file.new_line_detected); //if default changes after load or we have a new file we need this.\r\n   \r\n    dn.el.file_newline_detect.classList.remove('selected');\r\n    dn.el.file_newline_windows.classList.remove('selected');\r\n    dn.el.file_newline_unix.classList.remove('selected');\r\n   if(dn.the_file.custom_props.newline == \"detect\"){\r\n        if(dn.the_file.new_line_detected == \"windows\" || dn.the_file.new_line_detected == \"unix\")\r\n            dn.editor.session.setNewLineMode(dn.the_file.new_line_detected);\r\n        else\r\n            dn.editor.session.setNewLineMode(newlineDefault);    \r\n        dn.el.file_newline_detect.classList.add('selected');\r\n    }else{\r\n        dn.editor.session.setNewLineMode(dn.the_file.custom_props.newline);\r\n            if(dn.the_file.custom_props.newline == \"windows\")\r\n                dn.el.file_newline_windows.classList.add('selected');\r\n            else\r\n                dn.el.file_newline_unix.classList.add('selected');            \r\n    }    \r\n}\r\n\r\ndn.show_newline_status = function(statusStr){\r\n    var str;\r\n    switch(statusStr){\r\n        case 'none':\r\n            str =  \"no newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        case 'mixed':\r\n            str = \"mixture of newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        default:\r\n            str = \"detected \" + statusStr + \"-like newlines\";\r\n    }\r\n    \r\n    dn.el.file_newline_info.textContent = \"(\" + str +\")\";\r\n    \r\n    return statusStr;\r\n}\r\n\r\n\r\n// ############################\r\n// Open stuff\r\n// ############################\r\n\r\ndn.do_open = function(){\r\n    if(!dn.open_picker){\r\n        var view = new google.picker.View(google.picker.ViewId.DOCS);\r\n        dn.open_picker = new google.picker.PickerBuilder()\r\n        .enableFeature(google.picker.Feature.NAV_HIDDEN)\r\n        .setAppId(dn.client_id)\r\n        .setOAuthToken(gapi.auth.getToken().access_token)\r\n        .addView(view)\r\n        .setCallback(dn.picker_callback)\r\n        .build();\r\n    }\r\n    dn.open_picker.setVisible(true);\r\n    return false;\r\n}\r\n\r\ndn.picker_callback = function(data) {\r\n  if (data.action == google.picker.Action.PICKED) {\r\n    var fileId = data.docs[0].id;\r\n   dn.focus_editor();\r\n   // var url = window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0] + \"?state={\\\"action\\\":\\\"open\\\",\\\"ids\\\":[\\\"\" + fileId +\"\\\"]}\";\r\n    dn.el.opener_button_a.setAttribute('href', url);\r\n    dn.el.opener_button_b.setAttribute('href', url);\r\n    dn.g_settings.set('pane_open', false);\r\n    dn.el.opener_chooser.style.display = '';\r\n    css_animation(dn.el.the_widget, 'shake', function(){}, dn.error_delay_ms);\r\n  }else if(data.action == \"cancel\"){\r\n     dn.focus_editor();\r\n  } \r\n}\r\n\r\n\r\n// ############################\r\n// Widget stuff\r\n// ############################\r\n\r\ndn.show_help_inner = function(inner_pane){\r\n    // expects string 'shorcuts' or 'tips',  any other values shows main\r\n\r\n    dn.el.pane_help_shortcuts.style.display = 'none';\r\n    dn.el.pane_help_tips.style.display = 'none';\r\n    dn.el.pane_help_main.style.display = 'none';\r\n\r\n    dn.el.button_shortcuts.classList.remove('selected');\r\n    dn.el.button_tips.classList.remove('selected');\r\n    \r\n    if(inner_pane == 'tips'){\r\n        dn.el.pane_help_tips.style.display = '';\r\n        dn.el.button_tips.classList.add('selected');\r\n    } else if(inner_pane == 'shortcuts'){\r\n        dn.el.pane_help_shortcuts.style.display = '';\r\n        dn.el.button_shortcuts.classList.add('selected');\r\n    } else {\r\n        dn.el.pane_help_main.style.display = '';\r\n    }\r\n}\r\n\r\ndn.show_pane = function(el){\r\n    // el can be undefined/null to hide everything\r\n\r\n    for(var ii=0; ii < dn.el.widget_content.children.length; ii++)if(dn.el.widget_content.children[ii] !== el){\r\n        dn.el.widget_content.children[ii].style.display = 'none';\r\n        var el_icon = dn.menu_icon_from_pane_id[dn.el.widget_content.children[ii].id];\r\n        if(el_icon)\r\n            el_icon.classList.remove('icon_selected');\r\n    }\r\n\r\n    if(el){\r\n        el.style.display = '';\r\n        var el_icon = dn.menu_icon_from_pane_id[el.id];\r\n        if(el_icon)\r\n            el_icon.classList.add('icon_selected')\r\n        if(dn.status.local_settings == 1)\r\n            dn.g_settings.set('pane_open', true);\r\n    }else{\r\n       if(dn.status.local_settings == 1)   \r\n            dn.g_settings.set('pane_open', false);\r\n    }\r\n}\r\n\r\ndn.widget_mouse_down = function(e){\r\n    dn.widget_mouse_down_info = {\r\n            off_left: -e.clientX,\r\n            off_top: -e.clientY,\r\n            start_time: Date.now(),\r\n            is_dragging: e.button !== 0};\r\n    document.addEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.addEventListener('mouseup', dn.document_mouse_up_widget);\r\n}\r\n\r\ndn.document_mouse_move_widget = function(e){\r\n    var x = e.clientX+dn.widget_mouse_down_info.off_left;\r\n    var y = e.clientY+dn.widget_mouse_down_info.off_top;\r\n    if(!dn.widget_mouse_down_info.is_dragging){\r\n        dn.widget_mouse_down_info.is_dragging = (Date.now() - dn.widget_mouse_down_info.start_time > dn.drag_delay_ms)\r\n                                              || (x*x + y*y > dn.drag_shift_px * dn.drag_shift_px);\r\n    }\r\n    if(dn.widget_mouse_down_info.is_dragging)\r\n        translate(dn.el.the_widget, x, y);\r\n    e.stopPropagation();\r\n\r\n};\r\n\r\ndn.document_mouse_up_widget = function(e){\r\n    document.removeEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.removeEventListener('mouseup', dn.document_mouse_up_widget);\r\n\r\n    if(dn.widget_mouse_down_info.is_dragging){\r\n        var pos = dn.el.the_widget.getBoundingClientRect();\r\n        translate(dn.el.the_widget, 0, 0);\r\n    \r\n        //work out what widget_anchor should be\r\n        var widget_w = dn.el.the_widget.offsetWidth;\r\n        var widget_h = dn.el.the_widget.offsetHeight;\r\n        var window_w = window.innerWidth;\r\n        var window_h = window.innerHeight;\r\n        var anchor = []\r\n        if(pos.left < window_w - (pos.left + widget_w)){\r\n            anchor[0] = 'l'; //anchor left side by window width percentage\r\n            anchor[1] = Math.max(0,pos.left/window_w * 100);\r\n        }else{\r\n            anchor[0] = 'r'; //anchor right side by window width percentage\r\n            anchor[1] = Math.max(0,(window_w - (pos.left + widget_w))/window_w * 100);\r\n        }\r\n        if(pos.top < window_h - (pos.top+ widget_h)){\r\n            anchor[2] = 't'; //anchor top side by window height percentage\r\n            anchor[3] = Math.max(0,pos.top/window_h * 100);\r\n        }else{\r\n            anchor[2] = 'b'; //anchor bottom side by window height percentage\r\n            anchor[3] = Math.max(0,(window_h - (pos.top + widget_h))/window_h * 100);\r\n        }\r\n\r\n        if(dn.g_settings)\r\n            dn.g_settings.set(\"widget_anchor\",anchor); \r\n\r\n    }else{\r\n        dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n    }\r\n    dn.widget_mouse_down_info = undefined;\r\n};\r\n\r\ndn.widget_apply_anchor = function(anchor){\r\n    anchor = Array.isArray(anchor) ? anchor : dn.g_settings.get('widget_anchor');\r\n    var widget_w = dn.el.the_widget.offsetWidth;\r\n    var widget_h = dn.el.the_widget.offsetHeight;\r\n    var window_w = window.innerWidth;\r\n    var window_h = window.innerHeight;\r\n\r\n    if(anchor[0] == 'l'){\r\n        // horizontal position is anchored to a fixed percentage of window width on left of widget\r\n        if(window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = '0px'; //if the widget would overlap the right edge, then instead put it precisely on the right edge\r\n        }else{\r\n            dn.el.the_widget.style.left = anchor[1] + '%';\r\n            dn.el.the_widget.style.right = ''; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.add('flipped');\r\n        dn.el.widget_content.classList.add('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.add('flipped');\r\n\r\n    }else{\r\n        // horizontal position is anchored to a fixed percentage of window width on right of widget\r\n        if( window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = '0px';\r\n            dn.el.the_widget.style.right = ''; //if the widget would overlap the left edge, then instead put it precisely on the left edge\r\n        }else{\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = anchor[1] + '%'; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.remove('flipped');\r\n        dn.el.widget_content.classList.remove('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.remove('flipped');\r\n    }\r\n\r\n    if(anchor[2] == 't'){\r\n        // vertical position is anchored to a fixed percentage of window height on top of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = '0px';  \r\n        }else{\r\n            dn.el.the_widget.style.top = anchor[3] + '%';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }\r\n    }else{\r\n        // vertical position is anchored to a fixed percentage of window height on bottom of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = '0px';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }else{\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = anchor[3] + '%'; \r\n        }\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\ndn.open_close_widget = function(state){\r\n    // provide argument \"true\" to open widget, \"false\" to close\r\n    if(state){\r\n        dn.el.widget_menu.style.display = '';\r\n        dn.el.widget_content.style.display = '';\r\n    }else{\r\n        dn.el.widget_menu.style.display = 'none';\r\n        dn.el.widget_content.style.display = 'none';\r\n        dn.find_set_find_active_false();\r\n    }\r\n    if(!dn.find_active)\r\n        dn.focus_editor();\r\n    return false;\r\n}\r\n\r\ndn.show_status = function(){\r\n    // TODO: new file, drag-drop from disk, pristing/saving, modify props, readonly/sharing info\r\n    var s = ''\r\n    if(dn.status.authentication != 1){\r\n        // auth in progress or failed\r\n        if(dn.status.authorization == -1)\r\n            s = \"Authorization required...\";\r\n        else if(dn.status.popup_active)\r\n            s = \"Login/authenticate with popup...\";\r\n        else\r\n            s = \"Authenticating...\";\r\n    } else if (dn.the_file.file_id){\r\n        // a file is/will be loaded...\r\n        if (dn.status.file_meta === 1 && dn.status.file_body === 1){\r\n            s = dn.the_file.title;\r\n            var extra = [];\r\n            if(dn.the_file.is_read_only)\r\n                extra.push(\"read-only\");\r\n            if(dn.the_file.is_shared)\r\n                extra.push(\"shared\");\r\n            if(dn.status.file_sharing == -1)\r\n                extra.push(\"sharing status unknown\");\r\n            if(!dn.the_file.is_pristine)\r\n                extra.push(\"unsaved changes\");\r\n            if(extra.length)\r\n                s += \"\\n[\" + extra.join(', ') + \"]\"; \r\n        }else if(dn.status.file_meta === 0 && dn.status.file_body === 0)\r\n            s = \"Loading file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1 && dn.status.file_body === 0)\r\n            s = \"Loading \" + (dn.the_file.is_read_only? 'read-only ' : '' ) + \r\n                    \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_meta === 0 && dn.status.file_body === 1)\r\n            s = \"Loading metadata for file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1) // and -1\r\n            s = \"Failed to download \" + (dn.the_file.is_read_only? 'read-only ' : '' )\r\n                    +  \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_body === 1) // and -1\r\n            s = \"Failed to download metadata for file:\\n\" + dn.the_file.file_id;\r\n        else // both -1\r\n            s = \"Failed to load file:\\n\" + dn.the_file.file_id;\r\n    } else {\r\n        // no file to load\r\n        s = \"ex nihilo omnia...\";\r\n    }\r\n\r\n    text_multi(dn.el.widget_text, s, true);\r\n}\r\n\r\ndn.show_error = function(message){\r\n    console.log(message); //it's just useful to do this too\r\n    text_multi(dn.el.widget_error_text, message,true);\r\n    dn.el.widget_error.style.display = '';\r\n    css_animation(dn.el.the_widget, 'shake', function(){\r\n        dn.el.widget_error.style.display = 'none';\r\n    }, dn.error_delay_ms);\r\n};\r\n\r\ndn.set_drive_link_to_folder = function(){\r\n    var els = document.getElementsByClassName('link_drive');\r\n    var href = dn.the_file.folder_id ? \r\n                'https://drive.google.com/#folders/' + dn.the_file.folder_id \r\n                : 'https://drive.google.com';\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].href = href;\r\n}\r\n\r\n\r\n// ############################\r\n// Settings stuff\r\n// ############################\r\n\r\ndn.get_settings_from_cloud = function() {\r\n    return;\r\n  gapi.drive.realtime.loadAppDataDocument(\r\n  function(doc) {\r\n    var old_temp_g_settings = dn.g_settings;\r\n    dn.g_settings = doc.getModel().getRoot();\r\n    dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    if(!dn.g_clipboard){\r\n        dn.g_settings.set('clipboard', doc.getModel().createList());\r\n        dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    }\r\n    dn.g_find_history = dn.g_settings.get('findHistory');\r\n    if(!dn.g_find_history){\r\n        dn.g_settings.set('findHistory', doc.getModel().createList());\r\n        dn.g_find_history = dn.g_settings.get('findHistory');\r\n    }\r\n    \r\n    var existingKeys = dn.g_settings.keys();\r\n    dn.g_settings.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED, dn.settings_changed);\r\n    console.log('Applying settings from cloud...')\r\n    for(var s in dn.default_settings)\r\n        if(s in old_temp_g_settings.getKeeps())\r\n            dn.g_settings.set(s,old_temp_g_settings.get(s));\r\n        else if(existingKeys.indexOf(s) == -1)\r\n            dn.g_settings.set(s,dn.default_settings[s]);\r\n        else if(JSON.stringify(old_temp_g_settings.get(s)) !== JSON.stringify(dn.g_settings.get(s)))\r\n            dn.settings_changed({property:s, newValue:dn.g_settings.get(s)});// the gapi doesn't automatically trigger this on load\r\n    \r\n    //Check lastDNVersionUsed at this point - by default it's blank, but could also have an out-of-date value\r\n    if(dn.g_settings.get('lastDNVersionUsed') != dn.version_str){\r\n        dn.g_settings.set('help_inner', 'tips');\r\n        dn.g_settings.set('pane', 'pane_help');\r\n        dn.g_settings.set('lastDNVersionUsed', dn.version_str);\r\n    }\r\n  },\r\n  null,\r\n  function(resp){\r\n        console.log(\"g_settings error\");\r\n        console.dir(arguments);\r\n        if ((resp.type && resp.type == \"token_refresh_required\") || resp.error.code == 401) //not sure if it has an error.code field but it does seem to have a type field\r\n            dn.reauth(function(){console.log(\"reauthed triggered by g_settings\")}); //no real callback here, I think the realtime api somehow disovers that we're back in buisiness\r\n    })\r\n\r\n}\r\n\r\ndn.load_default_settings = function(){\r\n  //Lets show the user either the defualt settings or the \r\n  //ones last used on this browser (restricted to impersonal settings only)\r\n\r\n  dn.g_settings = (function(){ //mock realtime model to be used until the real model is initialised\r\n      var ob = {};\r\n      var keeps = {}\r\n      return {get: function(k){return ob[k]}, \r\n              set: function(k,v){ob[k] = v;\r\n                                 dn.settings_changed({property: k, newValue: v});\r\n                                 },\r\n              keep: function(k){keeps[k] = true},\r\n              getKeeps: function(){return keeps;}};\r\n                                 \r\n  })();\r\n\r\n  dn.status.local_settings = 0;\r\n  try{\r\n    console.log('Loading default/localStorage settings...');\r\n    for(var s in dn.default_settings)\r\n    if(dn.impersonal_settings_keys.indexOf(s) == -1 || !localStorage || !localStorage[\"g_settings_\" +s])\r\n        dn.g_settings.set(s,dn.default_settings[s]);\r\n    else\r\n        dn.g_settings.set(s,JSON.parse(localStorage[\"g_settings_\" + s]));\r\n  }catch(err){\r\n      if(localStorage) \r\n        localStorage.clear();\r\n      console.log(\"Failed to load defaults/localStorage settings.  Have cleared localStorage cache.\")\r\n  }\r\n  dn.status.local_settings = 1;\r\n}\r\n\r\ndn.settings_changed = function(e){\r\n    var new_value = e.newValue;\r\n    console.log(\"[user settings] \" + e.property +\": \" + new_value);\r\n    if(dn.impersonal_settings_keys.indexOf(e.property)>-1 && localStorage){\r\n        localStorage[\"g_settings_\" + e.property] = JSON.stringify(new_value);\r\n    }\r\n    try{\r\n        switch(e.property){\r\n            case \"widget_anchor\":\r\n                dn.widget_apply_anchor(new_value);\r\n                    break;\r\n            case \"theme\":\r\n                dn.editor.setTheme('ace/theme/' + new_value);\r\n                dn.theme_drop_down.SetInd(dn.theme_drop_down.IndexOf(new_value), true);\r\n                break;\r\n            case \"fontSize\":\r\n                var scrollLine = dn.get_scroll_line();\r\n                dn.el.font_size_text.textContent = new_value.toFixed(1);\r\n                dn.editor.setFontSize(new_value + 'em')    \r\n                dn.editor.scrollToLine(scrollLine);\r\n                break;\r\n            case \"wordWrap\":\r\n                var s = dn.editor.getSession();\r\n                var scrollLine = dn.get_scroll_line();\r\n                s.setUseWrapMode(new_value[0]);\r\n                s.setWrapLimitRange(new_value[1],new_value[2]);\r\n                 dn.editor.scrollToLine(scrollLine);\r\n                if(!new_value[0])\r\n                    dn.el.word_wrap_off.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_off.classList.remove('selected');\r\n                if(new_value[0] && !new_value[1])\r\n                    dn.el.word_wrap_edge.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_edge.classList.remove('selected');\r\n                if(new_value[0] && new_value[1])\r\n                    dn.el.word_wrap_at.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_at.classList.remove('selected');\r\n\r\n                break;\r\n            case \"wordWrapAt\":\r\n                dn.el.word_wrap_at_text.textContent = new_value;\r\n                var curWrap = dn.g_settings.get('wordWrap');\r\n                if(curWrap[1] && curWrap[1] != new_value)\r\n                    dn.g_settings.set('wordWrap',[1,new_value,new_value]);\r\n                dn.editor.setPrintMarginColumn(new_value);\r\n                break;\r\n            case \"showGutterHistory\":\r\n                var s = dn.editor.getSession(); \r\n                if(new_value){\r\n                    dn.el.gutter_history_show.classList.add('selected')\r\n                    dn.el.gutter_history_hide.classList.remove('selected');\r\n                }else{\r\n                    var h = dn.change_line_history;\r\n                    for(var i=0;i<h.length;i++)if(h[i])\r\n                        s.removeGutterDecoration(i,h[i]<0 ? dn.change_line_classes_rm[-h[i]] : dn.change_line_classes[h[i]]);\r\n                    dn.change_line_history = []; \r\n                    dn.el.gutter_history_hide.classList.add('selected')\r\n                    dn.el.gutter_history_show.classList.remove('selected');\r\n                }\r\n                break;\r\n            case \"newLineDefault\":\r\n                dn.apply_newline_choice();\r\n                break;\r\n            case \"historyRemovedIsExpanded\":\r\n                dn.revision_setis_expaned(new_value);\r\n                break;\r\n            case \"softTabN\":\r\n            case \"tabIsHard\":          \r\n                dn.apply_tab_choice(); \r\n                break;\r\n            case 'pane_open':\r\n                dn.open_close_widget(new_value)\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane_open');\r\n                break;\r\n            case 'pane':\r\n                dn.show_pane(document.getElementById(new_value));\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane');\r\n                if(new_value !== 'pane_find')\r\n                    dn.find_set_find_active_false();\r\n                if(new_value !== 'pane_help')\r\n                    dn.g_settings.set('help_inner', 'main');\r\n                break; \r\n            case 'help_inner':\r\n                dn.show_help_inner(new_value);\r\n                break;\r\n            case 'find_regex':\r\n                if(new_value)\r\n                    dn.el.find_button_regex.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_regex.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_whole_words':\r\n                if(new_value)\r\n                    dn.el.find_button_whole_words.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_whole_words.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_case_sensitive':\r\n                if(new_value)\r\n                    dn.el.find_button_case_sensitive.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_case_sensitive.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n        }\r\n    }catch(err){\r\n        console.log(\"Error while uptating new settings value.\")\r\n        console.dir(e);\r\n        console.dir(err);\r\n    }\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Font size stuff\r\n// ############################\r\n\r\ndn.font_size_decrement_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size -= dn.font_size_increment;\r\n    font_size = font_size  < dn.min_font_size ? dn.min_font_size: font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\ndn.font_size_increment_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size += dn.font_size_increment;\r\n    font_size = font_size  > dn.max_font_size ? dn.max_font_size:font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Tab stuff\r\n// ############################\r\n// Note that there is a whitespace extension for ace but it doesn't look that mature and we actually have slightly different requirements here.\r\n\r\ndn.detect_tab = function(str){    \r\n    dn.the_file.tab_detected = (function(){ //no need to use a self-executing function here, just lazy coding....\r\n        //This function returns an object with a field \"val\" that takes one of the folling values:\r\n        // none: no indents detected at all\r\n        // mixture: no strong bias in favour of spaces or tabs\r\n        // tab: defintely tabs\r\n        // spaces: definitely space. In this case extra fields are provied....\r\n        //   n: number of spaces\r\n        //   isDefault: true if the default nSpaces value was used as part of the decision making process\r\n        //   threshold: this takes one of three values:\r\n        //          strong: the largest n over threshold was used\r\n        //          weak: no n was over the strong threshold, but the default n was over the weak threshold\r\n        //          failed: no idea what n is, so just use default\r\n    \r\n        var lines = dn.editor.session.getLines(0, 1000);    \r\n        var indents = lines.map(function(str){\r\n                        return str.match(/^\\s*/)[0];\r\n                      });\r\n        indents = indents.filter(function(str){return str !== '';});\r\n        \r\n        if(!indents.length)\r\n            return dn.show_tab_status({val: \"none\"});\r\n            \r\n        //TODO: if first thousand lines happen to have few indents it may be worth checking further down.\r\n        \r\n        var stats = indents.reduce(function(stats,str){\r\n           if(str.indexOf('\\t') > -1)\r\n              if(str.indexOf(' ') > -1)\r\n                stats.nWithMixture++;\r\n              else\r\n                stats.nWithOnlyTabs++;\r\n           else\r\n               stats.spaceHist[str.length] = (stats.spaceHist[str.length] || 0) + 1;   \r\n            return stats;\r\n        },{nWithOnlyTabs: 0,spaceHist: [],nWithMixture: 0});\r\n            \r\n        stats.nSamp = indents.length;\r\n        stats.nWithOnlySpaces = stats.nSamp - stats.nWithMixture - stats.nWithOnlyTabs;\r\n        \r\n        console.dir(stats);\r\n            \r\n        if(stats.nWithOnlyTabs/stats.nSamp >= dn.detect_tabs_tabs_frac)\r\n            return dn.show_tab_status({val: \"tab\"});\r\n    \r\n        if(stats.nWithOnlySpaces/stats.nSamp < dn.detect_tabs_spaces_frac)\r\n            return dn.show_tab_status({val: \"mixture\"});\r\n    \r\n        stats.spaceModHist = [];\r\n        var s;\r\n        for(s=dn.min_soft_tab_n;s<=dn.max_soft_tab_n;s++){\r\n            var m = 0;    \r\n            for(var i=s;i<stats.spaceHist.length;i+=s)\r\n                m += stats.spaceHist[i] !== undefined ? stats.spaceHist[i] : 0;\r\n            stats.spaceModHist[s] = m;\r\n        }\r\n        \r\n        for(s=dn.max_soft_tab_n;s>=dn.min_soft_tab_n;s--)\r\n            if(stats.spaceModHist[s]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac)\r\n                break;\r\n                \r\n        if(s < dn.min_soft_tab_n){\r\n            // nothing was over threshold, but rather than give up lets use a weaker threshold on the default space count\r\n            var defaultNSpaces = dn.g_settings.get('softTabN');    \r\n            if(stats.spaceModHist[defaultNSpaces]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac_for_default)\r\n                return dn.show_tab_status({val: 'spaces', n: defaultNSpaces, isDefault: true, threshold: \"weak\"});\r\n            else\r\n                return dn.show_tab_status({val: \"spaces\", n: defaultNSpaces, isDefault: true, threshold: \"failed\"});\r\n        }else{\r\n            // s is the index of the last element in the spaceModHist array which is over threshold\r\n                return dn.show_tab_status({val: \"spaces\", n: s, isDefault: false, threshold: \"strong\"});\r\n        }\r\n    })();\r\n}\r\n\r\n\r\ndn.show_tab_status = function(d){\r\n    var str;\r\n    var defaultStr = \"\";\r\n    if(dn.g_settings.get(\"tabIsHard\"))\r\n        defaultStr = \"hard tabs\";\r\n    else\r\n        defaultStr = dn.g_settings.get(\"softTabN\") + \" spaces\";\r\n    \r\n    switch(d.val){\r\n        case 'none':\r\n            str = \"no indentations detected, default is \" + defaultStr;\r\n            break;\r\n        case 'mixture':\r\n            str = \"detected mixture of tabs, default is \" + defaultStr;\r\n            break;\r\n        case 'tab':\r\n            str = \"hard tab indentation detected\";\r\n            break;\r\n        case \"spaces\":\r\n            switch(d.threshold){\r\n                case 'strong':\r\n                    str = \"detected soft-tabs of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'weak':\r\n                    str = \"detected close match to default of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'failed':\r\n                    str = \"detected soft-tabs, assuming default \" + d.n + \" spaces\";\r\n                    break;\r\n            }\r\n    }\r\n    \r\n    dn.el.file_tab_info.textContent = \"(\" + str +\")\";\r\n    return d;\r\n}\r\n\r\ndn.apply_tab_choice = function(){\r\n    var defaultTabIsHard = dn.g_settings.get('tabIsHard');\r\n    var defaultSoftTabN = dn.g_settings.get('softTabN');               \r\n                \r\n    var d;\r\n    var isHard;\r\n    var nSpaces;\r\n    var isDetected;\r\n    \r\n    dn.detect_tab();   \r\n    if(dn.the_file.custom_props.tabs == \"detect\"){\r\n        d = dn.the_file.tab_detected;             \r\n        isDetected = true\r\n    }else{\r\n        try{\r\n            d = JSON.parse(dn.the_file.custom_props.tabs);\r\n        }catch(err){\r\n            d = {val: \"none\"};\r\n        }\r\n    }\r\n    switch(d.val){\r\n        case 'none':\r\n        case 'mixture':\r\n            isHard = defaultTabIsHard;\r\n            nSpaces = defaultSoftTabN;\r\n            break;\r\n        case 'tab':\r\n            isHard = true;\r\n            nSpaces = d.n || defaultSoftTabN;\r\n            break;\r\n        case 'spaces':\r\n            isHard = false;\r\n            nSpaces = d.n;\r\n    }\r\n    \r\n    \r\n    if(isHard){\r\n        dn.editor.session.setUseSoftTabs(false);\r\n    }else{\r\n        dn.editor.session.setUseSoftTabs(true);\r\n        dn.editor.session.setTabSize(nSpaces);\r\n    }\r\n    \r\n    dn.el.tab_soft_text.textContent = defaultSoftTabN;\r\n    if(defaultTabIsHard){\r\n        dn.el.tab_hard.classList.add('selected');\r\n        dn.el.tab_soft.classList.remove('selected');\r\n    }else{\r\n        dn.el.tab_soft.classList.add('selected');\r\n        dn.el.tab_hard.classList.remove('selected');\r\n    }\r\n    \r\n    \r\n    dn.el.file_tab_detect.classList.remove('selected');\r\n    dn.el.file_tab_hard.classList.remove('selected');\r\n    dn.el.file_tab_soft.classList.remove('selected');\r\n    if(isDetected){\r\n        dn.el.file_tab_detect.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }else{\r\n        if(d.val == \"tab\")\r\n            dn.el.file_tab_hard.classList.add('selected');\r\n        else\r\n            dn.el.file_tab_soft.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }     \r\n\r\n\r\n}\r\n\r\ndn.set_file_tabs_to_soft_or_hard = function(val,delta){\r\n    var f = dn.the_file;\r\n    var current = f.custom_props.tabs;\r\n    if(current == \"detect\"){\r\n        current = f.tab_detected;\r\n        if(current.val == 'none' || current.val == \"mixture\")\r\n            current = { val: dn.g_settings.get('tabIsHard') ? \"tab\" : \"spaces\",\r\n                        n: dn.g_settings.get('softTabN')};\r\n    }else{\r\n        try{\r\n            current = JSON.parse(current);\r\n        }catch(err){\r\n            console.log(\"JSON.parse failed in SetFileTabsToSoftOrHard with current=\" + current)\r\n            return;\r\n        }\r\n    }\r\n    var newT = {val: val, n: current.n + delta};\r\n    dn.set_property(\"tabs\",JSON.stringify(newT));\r\n}\r\n// ############################\r\n// Syntax stuff\r\n// ############################\r\n\r\ndn.show_syntax_status = function(d){\r\n    var str = \"detected \" + d.syntax + \" from file extension\";\r\n    //TODO: if we improve upon DetectSyntax will need to add stuff here\r\n    dn.el.file_ace_mode_info.textContent = \"(\" + str + \")\";\r\n    return d.syntax;\r\n}\r\ndn.detect_syntax = function(){\r\n    dn.the_file.syntax_detected = (function(){ //no need to use self-ex-func here, just laziness...\r\n        //TODO: improve upon this\r\n        var title = dn.the_file.title || \"untitled.txt\";\r\n        var mode  = require(\"ace/ext/modelist\").getModeForPath(title);\r\n        dn.the_file.syntax_detected = mode.caption;\r\n        dn.show_syntax_status({syntax: dn.the_file.syntax_detected});\r\n        return mode;\r\n    })();\r\n}\r\n\r\ndn.apply_syntax_choice = function(){\r\n    dn.detect_syntax();\r\n    if(dn.the_file.custom_props[\"aceMode\"] == \"detect\"){\r\n        dn.set_syntax(dn.the_file.syntax_detected);\r\n        dn.el.file_ace_mode_detect.classList.add('selected');\r\n        dn.syntax_drop_down.SetSelected(false);\r\n    }else{\r\n        dn.set_syntax(dn.the_file.custom_props[\"aceMode\"])\r\n        dn.el.file_ace_mode_detect.classList.remove('selected');\r\n        dn.syntax_drop_down.SetSelected(true);\r\n    }\r\n}\r\n\r\ndn.get_current_syntax_name = function(){\r\n    try{\r\n        var modesArray = require(\"ace/ext/modelist\").modesByName;\r\n        return modesArray[dn.editor.session.getMode().$id.split('/').pop()].caption\r\n    }catch(e){\r\n        console.log(\"ERROR in GetCurrentSyntaxName...\");\r\n        console.dir(e);\r\n        return \"Text\";\r\n    }  \r\n}\r\n\r\ndn.set_syntax = function(val){\r\n\r\n    var modesArray = require(\"ace/ext/modelist\").modes;\r\n    var mode;\r\n    var ind;\r\n    \r\n    if(typeof val == \"number\"){\r\n        //val is index into mdoes array\r\n        mode = modesArray[val].mode;\r\n        ind = val;\r\n    }else if(modesArray.indexOf(val) > -1){\r\n        //val is an element of the modelist array\r\n        mode = val.mode;\r\n        ind = modesArray.indexOf(val);\r\n    }else{\r\n        //val is caption of mode in modes array\r\n        for(ind=0;ind<modesArray.length;ind++)if(modesArray[ind].caption == val){\r\n            mode = modesArray[ind].mode;\r\n            break;\r\n        }    \r\n    }\r\n    \r\n    if(dn.syntax_drop_down)\r\n        dn.syntax_drop_down.SetInd(ind,true);\r\n    dn.editor.getSession().setMode(mode);\r\n}\r\n\r\ndn.create_theme_menu = function(){\r\n    var themes = require('ace/ext/themelist');\r\n    var theme_drop_down = new DropDown(Object.keys(themes.themesByName));\r\n    theme_drop_down.addEventListener(\"change\",function(){\r\n        dn.g_settings.set(\"theme\",theme_drop_down.GetVal());\r\n    })\r\n    theme_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return theme_drop_down;\r\n}\r\n\r\ndn.create_syntax_menu = function(){\r\n    var modes = require(\"ace/ext/modelist\").modes;\r\n    \r\n    var syntax_drop_down = new DropDown(modes.map(function(m){return m.caption;}));\r\n    \r\n    syntax_drop_down.addEventListener(\"click\", dn.read_only_bail);\r\n    \r\n    syntax_drop_down.addEventListener(\"click\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"change\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return syntax_drop_down;\r\n}\r\n\r\n// ############################\r\n// File details stuff\r\n// ############################\r\ndn.read_only_bail = function(e){\r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"The file is read-only, so you cannot change its properties.\");\r\n        e.stopImmediatePropagation();\r\n       dn.focus_editor();\r\n    }\r\n}\r\ndn.create_file_details_tool = function(){\r\n    var els = [dn.el.details_title_text,\r\n               dn.el.details_description_text,\r\n               dn.el.file_newline_detect,\r\n               dn.el.file_newline_windows,\r\n               dn.el.file_newline_unix,\r\n               dn.el.file_tab_detect,\r\n               dn.el.file_tab_soft,\r\n               dn.el.file_tab_hard,\r\n               dn.el.file_ace_mode_detect];\r\n    for(var ii=0; ii< els.length; ii++)\r\n        els[ii].addEventListener(\"click\",dn.read_only_bail); //If file is read only, ReadOnlyBail will prevent the click handlers below from running.\r\n        \r\n    //Title change stuff\r\n    dn.el.details_title_text.addEventListener('click', function(){                \r\n            dn.el.details_title_text.style.display = 'none';\r\n            dn.el.details_title_input.style.display = '';\r\n            dn.el.details_title_input.focus();\r\n            dn.el.details_title_input.select();\r\n    });\r\n    dn.el.details_title_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_title_input.style.display = 'none';\r\n            dn.el.details_title_text.style.display = '';\r\n            var new_val = dn.el.details_title_input.value;\r\n            if(new_val == dn.the_file.title)\r\n                return;\r\n            dn.the_file.title = new_val\r\n            dn.show_file_title(); //includes showStatus\r\n            dn.apply_syntax_choice();\r\n            dn.save_file_title();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_title_input.addEventListener('keyup', function(e){\r\n            if(e.which == WHICH.ENTER)\r\n                dn.el.details_title_input.trigger('blur');\r\n    });\r\n    dn.el.details_title_input.addEventListener('keydown', function(e){\r\n        if(e.which == WHICH.ESC){\r\n            dn.el.details_title_input.value = dn.the_file.title;\r\n            dn.el.details_title_input.trigger('blur');\r\n            dn.ignore_escape = true; //stops ToggleWidget\r\n        }\r\n    });\r\n\r\n    // File action buttons stuff\r\n    dn.el.button_save.addEventListener('click', dn.save_content);\r\n    dn.el.button_print.addEventListener('click', dn.do_print);\r\n    dn.el.button_share.addEventListener('click', dn.do_share);\r\n    dn.el.button_history.addEventListener('click', dn.start_revisions_worker);\r\n\r\n    // Description stuff\r\n    dn.el.details_description_text.addEventListener('click', function(){            \r\n            dn.el.details_description_text.style.display = 'none';\r\n            dn.el.details_description_input.style.display = '';\r\n            dn.el.details_description_input.focus();\r\n    });\r\n    dn.el.details_description_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_description_input.style.display = 'none';\r\n            dn.el.details_description_text.style.display = '';\r\n            var new_val = dn.el.details_description_input.value;\r\n            if(dn.the_file.description === new_val)\r\n                return;\r\n            dn.the_file.description = new_val;\r\n            dn.show_description();\r\n            dn.save_file_description();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_description_input.addEventListener('keydown',function(e){\r\n            if(e.which == WHICH.ESC){\r\n                dn.el.details_description_input.value = dn.the_file.description;\r\n                dn.el.details_description_input.trigger('blur');\r\n                dn.ignore_escape = true;\r\n            }\r\n    });\r\n        \r\n    // File custom props stuff\r\n    dn.el.file_newline_detect.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"detect\");\r\n        dn.focus_editor();      \r\n    });\r\n    dn.el.file_newline_windows.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"windows\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_newline_unix.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"unix\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_tab_detect.classList.add('selected');\r\n    dn.el.file_tab_detect.addEventListener('click', function(){\r\n        dn.set_property(\"tabs\",\"detect\");\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_tab_soft.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",0);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_dec').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",-1);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_inc').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",+1);\r\n       dn.focus_editor();\r\n    })\r\n    dn.el.file_tab_hard.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"tab\",0);\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_ace_mode_detect.addEventListener('click', function(){\r\n       dn.set_property(\"aceMode\",\"detect\"); \r\n    });\r\n}\r\n\r\ndn.save_file_description = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    \r\n    dn.save_file(dn.the_file.file_id, {description: dn.the_file.description}, undefined, \r\n                $.proxy(dn.save_done,{description: ++dn.the_file.generation_to_save.description}))\r\n    dn.show_status();\r\n    return;\r\n    \r\n}\r\n\r\ndn.save_file_title = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    //TODO: mime-type IMPORTANT!\r\n\r\n    dn.save_file(dn.the_file.file_id, {title: dn.the_file.title}, undefined, \r\n                $.proxy(dn.save_done,{title: ++dn.the_file.generation_to_save.title}))\r\n    dn.show_status();    \r\n}\r\n\r\ndn.show_file_title = function(){\r\n    dn.el.details_title_text.textContent = 'Title: ' + dn.the_file.title;\r\n    dn.el.details_title_input.value = dn.the_file.title;\r\n    document.title = (dn.the_file.is_pristine ? \"\" : \"*\") + dn.the_file.title;\r\n    dn.show_status();\r\n}\r\n\r\ndn.show_description = function(){\r\n    text_multi(dn.el.details_description_text, 'Description: ' + dn.the_file.description,true);\r\n    dn.el.details_description_input.value = dn.the_file.description;\r\n}\r\n\r\n// ############################\r\n// Save stuff\r\n// ############################\r\n\r\ndn.save_content = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return false;\r\n    }\r\n    \r\n    if(!dn.the_file.is_pristine){\r\n        dn.the_file.data_to_save.body = dn.editor.getSession().getValue();\r\n        dn.the_file.generation_to_save.body++;\r\n        dn.el.ace_content.setAttribute('saving',true);\r\n        dn.the_file.is_saving = true;\r\n        dn.the_file.is_pristine = true;\r\n    }\r\n    \r\n    dn.show_file_title(); //includes a showstatus calls\r\n    dn.do_save();\r\n    return false;\r\n}\r\n\r\ndn.do_save = function (){\r\n    \r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"Cannot save read-only file.\");\r\n        return false;\r\n    }\r\n    \r\n    if(!(dn.the_file.data_to_save.body || dn.the_file.data_to_save.title || dn.the_file.data_to_save.description)){\r\n        dn.show_error(\"No changes since last save.\");\r\n        return false;\r\n    }\r\n\r\n    var gens = {};\r\n    var body, meta;\r\n    if(dn.the_file.data_to_save.body){\r\n        body = dn.the_file.data_to_save.body;\r\n        gens.body = dn.the_file.generation_to_save.body;\r\n    }\r\n    if(dn.the_file.data_to_save.title || dn.the_file.data_to_save.description){\r\n        meta = {};\r\n        if(dn.the_file.data_to_save.title){\r\n            meta.title = dn.the_file.data_to_save.title;\r\n            gens.title = dn.the_file.generation_to_save.title;\r\n        }\r\n        if(dn.the_file.data_to_save.description){\r\n            meta.description = dn.the_file.data_to_save.description; \r\n            gens.description = dn.the_file.generation_to_save.description;\r\n        }\r\n    }\r\n    dn.save_file(dn.the_file.file_id, meta, body, $.proxy(dn.save_done,gens))\r\n    return false;\r\n}\r\n\r\ndn.save_done = function(resp){\r\n    if(resp.error){\r\n        if(resp.error.code == 401){\r\n            dn.reauth(dn.do_save); //will make use of dn.the_file.data_to_save and generation_to_save once auth is done.\r\n        }else{\r\n            var failures = []\r\n            if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n                failures.push(\"body\");\r\n                dn.the_file.is_saving = false;\r\n                dn.the_file.is_pristine = false;\r\n                dn.show_file_title();\r\n                dn.el.ace_content.removeAttribute('saving');\r\n                dn.the_file.data_to_save.body = null;\r\n            }\r\n            if(this.title && this.title == dn.the_file.generation_to_save.title)\r\n                failures.push(\"title\");\r\n            if(this.description && this.description == dn.the_file.generation_to_save.description)\r\n                failures.push(\"description\");\r\n            \r\n            if(failures.length){//it's possible that all parts of the save request have since been superceded, so we can ignore this failure\r\n                dn.show_error(\"Failed to save \" +  oxford_comma(failures) + \". Error #\" + resp.error.code + (resp.error.message? \"\\n\" + resp.error.message : \"\"));\r\n                console.dir(resp);\r\n            }            \r\n        }\r\n    }else{//success...\r\n        if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n            dn.the_file.is_saving = false;\r\n            dn.el.ace_content.removeAttribute('saving');\r\n            dn.the_file.ext = resp.fileExtension;\r\n            dn.g_settings.set('ext',resp.fileExtension);\r\n            dn.the_file.data_to_save.body = null;\r\n            \r\n            if(dn.the_file.is_brand_new)\r\n                dn.saved_new_file(resp); \r\n        }\r\n        if(this.title && this.title == dn.the_file.generation_to_save.title){\r\n            dn.the_file.data_to_save.title = null;\r\n        }\r\n        if(this.description && this.description == dn.the_file.generation_to_save.description){\r\n            dn.the_file.data_to_save.description = null;\r\n        }\r\n\r\n    }\r\n    dn.show_status();\r\n}\r\n\r\ndn.save_file = function (fileId, fileMetadata, fileText, callback) {\r\n    //if fileId is null then a new file is created (can set fileMetadata.parentNodes = [parentFolderId])\r\n    //fileMetadata or fileText can be null.\r\n    //See https://developers.google.com/drive/v2/reference/files/insert - Request Body for valid metaData.\r\n\r\n    //build a multipart message body\r\n    var boundary = dn.make_boundary();\r\n    var delimiter = \"\\r\\n--\" + boundary + \"\\r\\n\";\r\n    var close_delim = \"\\r\\n--\" + boundary + \"--\";\r\n\r\n    var messageBody = delimiter +\r\n                'Content-Type: application/json\\r\\n' +\r\n                '\\r\\n' + JSON.stringify(fileMetadata ? fileMetadata : {}); //note than in the multipart message upload you must provide some json metadata, even if it's empty.\r\n\r\n    if(fileText){ \r\n        messageBody += delimiter +\r\n                'Content-Type: application/octet-stream\\r\\n' +\r\n                'Content-Transfer-Encoding: base64\\r\\n' +\r\n                '\\r\\n' + btoa(unescape(encodeURIComponent(fileText))); //javascript strings are utf16 encoded, but btoa only accespts ASCII, somehow the two extra functions here smooth over this problem and produce the expected result at the server end.\r\n    }\r\n    messageBody += close_delim;\r\n\r\n    var request = gapi.client.request({\r\n        path: '/upload/drive/v2/files/' + (fileId ? fileId : \"\"),\r\n        method: (fileId? 'PUT' : 'POST'),\r\n        params: {'uploadType': 'multipart'},\r\n        headers: {'Content-Type': 'multipart/mixed; boundary=\"' + boundary + '\"'} ,\r\n        body:   messageBody}\r\n        );\r\n\r\n    request.execute(callback);\r\n}\r\n\r\ndn.make_boundary = function(){\r\n    //for MIME protocol, require a boundary that doesn't exist in the message content.\r\n    //we could check explicitly, but this is essentially guaranteed to be fine:\r\n    // e.g. \"13860126288389.206091766245663\"\r\n    return (new Date).getTime() + \"\" + Math.random()*10;\r\n}\r\n\r\n\r\n// ############################\r\n// Print stuff\r\n// ############################\r\n\r\ndn.do_print = function(){\r\n    var content = dn.editor.session.doc.getAllLines();\r\n    var html = Array(content.length);\r\n\r\n    for(var i=0; i<content.length;i++)\r\n        html[i] = \"<li><div class='printline'>\" + dn.line_tohtml(i) + '</div></li>';\r\n\r\n    var printWindow = window.open('','');\r\n    printWindow.document.writeln(\r\n            \"<html><head><title>\" + dn.the_file.title \r\n            + \"</title></head><style>\"\r\n            + ace.require('ace/theme/' + dn.g_settings.get('theme')).cssText + \"\\nbody{font-size:\"\r\n            + dn.g_settings.get('fontSize') *14 +\"px; white-space:pre-wrap;\" + \r\n            \"font-family:'Monaco','Menlo','Ubuntu Mono','Droid Sans Mono','Consolas',monospace;}\"\r\n            + \"\\nli{color:gray;}\\n.printline{color:black;}</style>\" + \r\n            \"<body class='ace-\"+ dn.g_settings.get('theme') +\"'><ol id='content'>\" + \r\n            html.join(\"\") +\r\n            \"</ol></body></html>\");\r\n    printWindow.print();\r\n    return false;\r\n}\r\n\r\ndn.line_tohtml = function (n){\r\n    var printLayer = Object.create(ace.require('ace/layer/text').Text.prototype); \r\n    var tokens  = dn.editor.getSession().getTokens(n);\r\n    var html = [];\r\n    var screenColumn = 0;\r\n    for (var i = 0; i < tokens.length; i++) {\r\n       var token = tokens[i];\r\n       var value = token.value.replace(/\\t/g,'   ');//TODO:deal with tabs properly\r\n       if(value)\r\n           printLayer.$renderToken(html, 0, token, value);\r\n    }\r\n    return html.join('').replace(/&#160;/g,' ');\r\n}\r\n\r\n\r\n// ############################\r\n// Clipboard stuff\r\n// ############################\r\n\r\ndn.document_clipboard_left = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index <= 0)\r\n            return true;\r\n        dn.clipboard_index--;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_right = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index >= dn.g_clipboard.length-1)\r\n            return true;\r\n\r\n        dn.clipboard_index++;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_keyup = function(e){\r\n    if(e.which == 17 || e.which == 91 || !e.ctrlKey){\r\n        $(document).off('keyup',dn.document_clipboard_keyup);\r\n        dn.clipboard_active = false;\r\n        dn.el.pane_clipboard.style.display = 'none';\r\n        if(dn.clipboard_info_timer){\r\n            clearTimeout(dn.clipboard_info_timer);\r\n            dn.clipboard_info_timer = null;\r\n        }\r\n    }\r\n}\r\n\r\ndn.on_paste = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    $(document).on('keyup',dn.document_clipboard_keyup);\r\n    dn.clipboard_active = true;\r\n        \r\n    dn.clipboard_index = dn.g_clipboard.lastIndexOf(text); \r\n    if(dn.clipboard_index == -1){ //it's possible the user copied some text from outside the DN, in which case we will add it to the clipboard now\r\n       dn.clipboard_index = dn.g_clipboard.push(text);\r\n       while(dn.g_clipboard.length >dn.clipboard_max_length) //same as on copy\r\n         dn.g_clipboard.remove(0);\r\n    }\r\n    if(dn.clipboard_info_timer)\r\n        clearTimeout(dn.clipboard_info_timer);\r\n\r\n    dn.clipboard_info_timer = setTimeout(function(){\r\n        dn.clipboard_info_timer = null;\r\n        dn.el.pane_clipboard.style.display = '';\r\n    },dn.clipboard_info_delay);\r\n}\r\n\r\ndn.on_copy = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    dn.g_clipboard.push(text);\r\n    while(dn.g_clipboard.length >dn.clipboard_max_length)\r\n        dn.g_clipboard.remove(0);\r\n}\r\n\r\ndn.create_clipboard_tool = function(){\r\n    dn.el.pane_clipboard = document.getElementById('pane_clipboard');\r\n    dn.el.button_clear_clipboard.addEventListener('click', function(){\r\n            dn.g_clipboard.clear();\r\n    });\r\n    dn.el.button_clear_find_replace.addEventListener('click', function(){\r\n            dn.g_find_history.clear();\r\n    });\r\n}\r\n\r\n\r\n// ############################\r\n// New file stuff\r\n// ############################\r\n\r\ndn.do_new = function(){\r\n    //TODO: this could actually just be a link, updated in settingschanged-ext\r\n    var base = window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0];\r\n    window.open(base + \"?state=\" + JSON.stringify({\r\n                action: \"create\",\r\n                folderId: dn.the_file.folder_id ? dn.the_file.folder_id : '',\r\n                ext: dn.g_settings.get('ext')}),\"_blank\");\r\n    return false;\r\n}\r\n\r\ndn.create_new_tool = function(){\r\n    dn.el.menu_new.addEventListener('click', dn.do_new);\r\n}\r\n\r\ndn.create_file = function(){\r\n    dn.apply_syntax_choice();\r\n    dn.the_file.is_brand_new = true;\r\n    dn.show_file_title();\r\n    dn.show_description();\r\n    dn.apply_newline_choice();\r\n    dn.apply_tab_choice();\r\n    dn.g_settings.set(\"pane\",\"pane_file\");  \r\n}\r\n\r\ndn.guess_mime_type = function(){\r\n    // we set the mimeType on new files, it's too complicated to try and guess it otherwise (at least for now)\r\n    if(dn.the_file.loaded_mime_type)\r\n        return dn.the_file.loaded_mime_type;\r\n    var plain = \"text/plain\";\r\n    var ext = dn.the_file.title.match(/\\.[0-9a-z]+$/i);\r\n\r\n    if(!ext)\r\n        return plain;\r\n    else\r\n        ext = ext[0].substr(1);\r\n    \r\n    return (ext in dn.ext_to_mime_type)? dn.ext_to_mime_type[ext] : plain;\r\n\r\n}\r\n\r\ndn.save_new_file = function(){\r\n    var f = dn.the_file;\r\n    if(f.is_saving){\r\n        dn.show_error(\"File is being created. Please wait.\");\r\n        return false;\r\n    }\r\n    var meta = {title: f.title, \r\n                description: f.description,\r\n                mimeType: dn.guess_mime_type()};\r\n    var parentId = f.folderId;\r\n    if(parentId) \r\n        meta.parentNodes =[{id:[parentId]}];\r\n    f.data_to_save.body = dn.editor.getSession().getValue();\r\n    f.data_to_save.title = meta.title;\r\n    f.data_to_save.description = meta.description;\r\n    var gens = {title: ++f.generation_to_save.title, description: ++f.generation_to_save.description,body: ++f.generation_to_save.body};\r\n    f.is_saving = true;\r\n    f.is_pristine = true;\r\n    dn.show_file_title();\r\n    dn.el.ace_content.setAttribute('saving', true);\r\n    dn.show_status();\r\n    dn.save_file(null, meta, f.data_to_save.body, $.proxy(dn.save_done,gens));\r\n}\r\n\r\ndn.saved_new_file = function(resp){\r\n    dn.the_file.is_brand_new = false;\r\n    dn.the_file.file_id = resp.id;\r\n    dn.the_file.is_shared = resp.shared;\r\n    dn.status.file_sharing = 1;\r\n    dn.the_file.ext = resp.fileExtension;\r\n    history.replaceState({},dn.the_file.title,\r\n            window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0] +\r\n                \"?state={\\\"action\\\":\\\"open\\\",\\\"ids\\\":[\\\"\" + dn.the_file.file_id + \"\\\"]}\");\r\n    dn.set_drive_link_to_folder();\r\n    dn.save_all_file_properties();\r\n}\r\n\r\n// ############################\r\n// Scrolling stuff\r\n// ############################\r\n\r\ndn.save_scroll_line = function(){\r\n    dn.patch_property(dn.the_file.file_id, \r\n                    \"ScrollToLine\",\r\n                    dn.get_scroll_line(),\r\n                    'PUBLIC',null);\r\n}\r\n\r\ndn.get_scroll_line = function(){\r\n    return  dn.editor.getSession().screenToDocumentPosition(dn.editor.renderer.getScrollTopRow(),0).row;\r\n}\r\n\r\n// ############################\r\n// Load stuff\r\n// ############################\r\n\r\n\r\ndn.load_file = function(flag){\r\n    //we assume that we only ever load one fileid per page load\r\n    var file_id = dn.the_file.file_id; \r\n\r\n    dn.show_status();\r\n\r\n    /*TODO dn.reauth */\r\n    \r\n    dn.status.file_meta = 0;\r\n    var promise_get_meta = Promise.resolve(\r\n        gapi.client.request({\r\n            'path': '/drive/v3/files/' + file_id,\r\n            'params':{'fields': 'name,mimeType,description,parents,capabilities,fileExtension,shared'}}))\r\n        .then(dn.load_file_got_meta_data, function(err){\r\n            dn.show_error(err.result.error.message);\r\n            dn.status.file_meta = -1;\r\n            dn.show_status();\r\n            throw err;\r\n        })\r\n\r\n    dn.status.file_body = 0;\r\n    var promise_get_body = Promise.resolve(\r\n        gapi.client.request({\r\n            'path': '/drive/v3/files/' + file_id,\r\n            'params':{'alt': 'media'}\r\n        }))            \r\n        .then(dn.load_file_got_file_body, function(err){\r\n            dn.show_error(err.result.error.message);\r\n            dn.status.file_body = -1;\r\n            dn.show_status();\r\n            throw err;\r\n        });\r\n\r\n    \r\n    dn.pr_the_file = Promise.all([promise_get_meta, promise_get_body])\r\n    .then(function(){ \r\n        //success\r\n    }, function(){\r\n        // failure\r\n        document.title = \"Drive Notepad\";\r\n        dn.g_settings.set('pane', 'pane_help');\r\n    })\r\n    \r\n}\r\n\r\ndn.load_file_got_meta_data = function(resp) {\r\n    if (resp.error)\r\n        throw Error(resp.error);\r\n    dn.the_file.title = resp.result.name;\r\n    dn.the_file.description = resp.result.description || '';\r\n    dn.show_description();\r\n    dn.the_file.ext = resp.result.fileExtension\r\n    dn.the_file.is_read_only = !resp.result.capabilities.canEdit;\r\n    dn.the_file.is_shared = resp.result.shared; \r\n    dn.the_file.loaded_mime_type = resp.result.mimeType;\r\n    if(resp.result.parents && resp.result.parents.length){\r\n        dn.the_file.folder_id = resp.result.parents[0];\r\n        dn.set_drive_link_to_folder();\r\n    }\r\n    dn.show_file_title(); //includes a showStatus call\r\n    dn.status.file_meta = 1;\r\n    dn.show_status();\r\n} \r\n\r\ndn.load_file_got_file_body = function(resp){\r\n    dn.show_status();\r\n    dn.setting_session_value = true;\r\n    dn.editor.session.setValue(resp.body);\r\n    dn.setting_session_value = false;\r\n    dn.apply_newline_choice(resp.body);\r\n    dn.apply_syntax_choice();\r\n    dn.apply_tab_choice(); \r\n    dn.status.file_body = 1;\r\n    dn.show_status();\r\n}\r\n\r\n\r\n// ############################\r\n// Change/history stuff\r\n// ############################\r\n\r\ndn.on_change = function(e){\r\n    //console.dir(e);\r\n\r\n    if(!e.start || !e.end || dn.setting_session_value)\r\n        return;\r\n        \r\n    if(dn.the_file.is_pristine){\r\n        dn.the_file.is_pristine = false;\r\n        dn.show_file_title();\r\n        dn.show_status();\r\n    }\r\n\r\n    if(!dn.g_settings.get('showGutterHistory'))\r\n        return;\r\n\r\n    var nClasses = dn.change_line_classes.length-1;\r\n    var h = dn.change_line_history;\r\n    var s = dn.editor.getSession(); \r\n\r\n    var start_row = e.start.row;\r\n    var end_row = e.end.row;\r\n\r\n    if(dn.last_change && dn.last_change.start_row == start_row && dn.last_change.end_row == end_row && start_row == end_row\r\n        && dn.last_change.action.indexOf(\"Text\") != -1 && e.action.indexOf(\"Text\") != -1){\r\n            //if this change and the last change were both on the same single lines with action (insert|remove)Text...\r\n\r\n            if(dn.last_change.action == e.action){\r\n                return; //same action as last time\r\n            }else if(e.action == \"removeText\"){ // new action is removeText, old action was insertText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                h[start_row] = -nClasses;\r\n                dn.last_change.action = \"removeText\";\r\n                return;\r\n            }else{// new action is isnertText, old action was removeText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                h[start_row] = nClasses;\r\n                dn.last_change.action = \"insertText\";\r\n                return;\r\n            }\r\n\r\n    }else{\r\n        //otherwise we have an acutal new change\r\n        dn.last_change = {start_row: start_row, end_row: end_row, action: e.action};\r\n    }\r\n\r\n    //remove all visible decorations and update the changeLineHistory values (we'll add in the new classes at the end)\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.removeGutterDecoration(i,h[i] < 0 ? \r\n                    dn.change_line_classes_rm[-h[i]++] : \r\n                    dn.change_line_classes[h[i]--]);\r\n\r\n    //Update the changeLineHistory relating to the current changed lines\r\n    if(e.action == \"removeLines\"){\r\n        h.splice(start_row, end_row - start_row + 1);        \r\n        h[start_row] = h[start_row+1] = -nClasses;\r\n    }else if(e.action === \"removeText\"){\r\n        h[start_row] = -nClasses;\r\n    }else{\r\n        var newLineCount = 0;\r\n        if(e.action == \"insertText\")\r\n            newLineCount = (e.text.match(/\\n/g) || []).length;\r\n        if(e.action == \"insertLines\")\r\n            newLineCount = e.lines.length;\r\n        h.splice.apply(h,[start_row,0].concat(Array(newLineCount)));\r\n\r\n        for(var i=start_row;i<=end_row;i++)\r\n            h[i] = nClasses;\r\n\r\n    }\r\n\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.addGutterDecoration(i,h[i]<0 ?\r\n                dn.change_line_classes_rm[-h[i]] :\r\n                dn.change_line_classes[h[i]]);\r\n} \r\n\r\ndn.query_unload = function(){\r\n    if(!dn.the_file.is_pristine)\r\n        return \"If you leave the page now you will loose the unsaved \" + (dn.the_file.is_brand_new ? \"new \" : \"changes to \") + \"file '\" + dn.the_file.title + \"'.\"\r\n}\r\n\r\n\r\n// ############################\r\n// Properties stuff\r\n// ############################\r\ndn.property_updated = function(propKey,new_val){\r\n    console.log(\"[file custom property]  \" + propKey + \": \" + new_val);\r\n    switch(propKey){\r\n        case \"newline\":\r\n            dn.apply_newline_choice();\r\n            break;\r\n        case \"tabs\":            \r\n            dn.apply_tab_choice();\r\n            break;\r\n        case \"aceMode\":\r\n            dn.apply_syntax_choice();\r\n            break;\r\n    }\r\n    \r\n}\r\n\r\ndn.load_default_properties = function(){\r\n    for(var k in dn.default_custom_props)\r\n        dn.set_property(k,dn.default_custom_props[k]);\r\n}\r\n\r\ndn.get_properties_from_cloud = function() {    \r\n    // TODO:\r\n    /*\r\n    gapi.client.drive.properties.list({\r\n    'fileId': dn.the_file.file_id\r\n    }).execute(dn.got_all_file_properties);*/\r\n}\r\n\r\ndn.got_all_file_properties = function(resp){\r\n    if(resp.items){\r\n        dn.the_file.custom_prop_exists = {};\r\n        for(var i=0;i<resp.items.length;i++){\r\n            dn.the_file.custom_props[resp.items[i].key] = resp.items[i].value;\r\n            dn.the_file.custom_prop_exists[resp.items[i].key] = true;\r\n            dn.property_updated(resp.items[i].key,resp.items[i].value);\r\n        }\r\n    }\r\n}\r\n\r\ndn.save_all_file_properties = function(){\r\n    //To be used after creating a file, in order to set any of the props which had been modified before saving it\r\n    for(var k in dn.the_file.custom_props)\r\n        dn.set_property(k,dn.the_file.custom_props[k]);    \r\n}\r\n\r\ndn.set_property = function(prop_name,new_val){\r\n\r\n    var oldVal = dn.the_file.custom_props[prop_name]; \r\n    dn.the_file.custom_props[prop_name] = new_val;\r\n    if(oldVal !== new_val)\r\n        dn.property_updated(prop_name,new_val);\r\n\r\n    if(!(gapi && gapi.drive && dn.the_file.file_id))\r\n        return;\r\n\r\n    var dummyCallback = function(){}; //TODO: may want to do some error handling or something\r\n    \r\n    if(dn.default_custom_props[prop_name] == new_val){ //note that this is true in particular when SetProperty is called within LoadDefaultProperties\r\n        if(dn.the_file.custom_prop_exists[prop_name]){\r\n             dn.the_file.custom_prop_exists[prop_name] = false;\r\n             gapi.client.drive.properties.delete({ //DELTE the property, which does exist, but is no longer required because the value has been set to the default\r\n                fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC'\r\n                }).execute(dummyCallback);\r\n        }\r\n        //if the property doesn't exist and it's just been set to the default then we don't need to do anything.\r\n    }else{            \r\n        if(dn.the_file.custom_prop_exists[prop_name] && oldVal !== new_val){\r\n            gapi.client.drive.properties.patch({ //PATCH the property, which already exists\r\n            fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC', resource: {'value': new_val}\r\n            }).execute(dummyCallback);\r\n        }else{\r\n            dn.the_file.custom_prop_exists[prop_name] = true; //INSERT the property, because it doesn't yet exist, we may be coming via dn.save_all_file_properties() above\r\n            gapi.client.drive.properties.insert({\r\n            'fileId': dn.the_file.file_id, 'resource': {key: prop_name, value: new_val, visibility: 'PUBLIC'}\r\n            }).execute(dummyCallback)\r\n        }\r\n    }\r\n}\r\n\r\n\r\n// ############################\r\n// Drag-drop stuff\r\n// ############################\r\n//TODO: this may have a few bugs since it's not been tested for a while\r\n\r\ndn.document_drag_over = function (evt) {\r\n    evt = evt.originalEvent;\r\n    evt.stopPropagation();\r\n    evt.preventDefault();\r\n    if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine)){\r\n        evt.dataTransfer.dropEffect = 'none';\r\n        if(dn.can_show_drag_drop_error){\r\n            dn.show_error(\"File drag-drop is only permitted when the Drive Notpad page is displaying a new and unmodified file.\")\r\n            dn.can_show_drag_drop_error = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n            setTimeout(function(){dn.can_show_drag_drop_error = true;},dn.error_delay_ms);\r\n        }\r\n        return;\r\n    }\r\n    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.\r\n}\r\n    \r\ndn.document_drop_file = function(evt){\r\n     if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine))\r\n        return;\r\n        \r\n   evt = evt.originalEvent;\r\n   evt.stopPropagation();\r\n   evt.preventDefault();\r\n   \r\n   var files = evt.dataTransfer.files;\r\n   if(files.length > 1){\r\n       dn.show_error(\"You cannot drag-drop multiple files onto the Drive Notepad page, only individual files.\")\r\n   }\r\n   var file = files[0];\r\n   dn.the_file.title = file.name;\r\n   dn.create_file();\r\n   dn.the_file.isReading_file_object = true;   \r\n   dn.show_status();\r\n   var r = new FileReader();\r\n   r.onload = dn.dropped_file_read;\r\n   r.readAsText(file);      \r\n}\r\n\r\ndn.dropped_file_read = function(e){\r\n    dn.the_file.isReading_file_object = false;\r\n    dn.editor.getSession().setValue(e.target.result);\r\n    // Note we don't encolse the above in a dn.setting_session_value = true block so the change event will fire and set pristine to false and ShowStatus etc.\r\n}\r\n\r\ndn.focus_editor = function(){\r\n   dn.editor.focus();\r\n}\r\n// ############################\r\n// Page ready stuff\r\n// ############################\r\n\r\n\r\ndn.document_ready = function(e){\r\n\r\n    // widget :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.the_widget = document.getElementById('the_widget');\r\n    dn.el.widget_text = document.getElementById('widget_text');\r\n    dn.el.widget_error_text = document.getElementById('widget_error_text');\r\n    dn.el.widget_error = document.getElementById('widget_error');\r\n    dn.el.widget_content = document.getElementById('widget_content');\r\n    dn.el.the_widget.addEventListener('mousedown', dn.widget_mouse_down);\r\n    translate(dn.el.the_widget, 0, 0);\r\n    dn.el.the_widget.style.display = '';\r\n    dn.el.widget_error.style.display = 'none';\r\n    dn.el.widget_content.addEventListener('mousedown', function(e){\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    });\r\n    var els = dn.el.widget_content.getElementsByTagName('input');\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].addEventListener('mousedown', stop_propagation); // prevents propagation to preventDefault, installed above.\r\n\r\n    // editor :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    var editor_el = document.getElementById('the_editor');\r\n    editor_el.innerHTML = '';\r\n    editor_el.addEventListener('contextmenu', function(e){\r\n        dn.show_error(\"See the list of keyboard shortcuts for copy/paste, select-all, and undo/redo.\")\r\n    });\r\n    dn.editor = ace.edit(\"the_editor\");\r\n    dn.editor.setHighlightSelectedWord(true);\r\n    dn.el.ace_content = document.getElementsByClassName('ace_content')[0];\r\n    dn.editor.on('focus', dn.find_set_find_active_false)\r\n    dn.editor.getSession().addEventListener(\"change\", dn.on_change);\r\n    dn.focus_editor();\r\n    dn.editor.on(\"paste\", dn.on_paste);\r\n    dn.editor.on(\"copy\", dn.on_copy);\r\n    dn.editor.setAnimatedScroll(true);\r\n    dn.editor.$blockScrolling = Infinity; // disables scrolling message\r\n    \r\n    // widget menu ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.widget_menu = document.getElementById('widget_menu');\r\n    dn.el.menu_open = document.getElementById('menu_open');\r\n    dn.el.menu_find = document.getElementById('menu_find');\r\n    dn.el.menu_help = document.getElementById('menu_help');\r\n    dn.el.menu_file = document.getElementById('menu_file');\r\n    dn.el.menu_general_settings = document.getElementById('menu_general_settings');\r\n    dn.el.widget_menu.addEventListener('mousedown', stop_propagation);\r\n    dn.menu_icon_from_pane_id = {}\r\n    var els = dn.el.widget_menu.getElementsByClassName('widget_menu_wrapper');\r\n    for(var ii=0; ii<els.length; ii++){\r\n        els[ii].addEventListener(\"mousedown\", prevent_default);\r\n        els[ii].title = dn.menu_id_to_caption[els[ii].id];\r\n        els[ii].innerHTML = \"<div class='widget_menu_icon' id='icon_\" + els[ii].id + \"'></div>\";\r\n        var el_icon = els[ii].getElementsByClassName('widget_menu_icon')[0];\r\n        dn.menu_icon_from_pane_id['pane_' + els[ii].id.substr(5)] = el_icon;\r\n    }\r\n\r\n     // pane file ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_file = document.getElementById('pane_file');\r\n    dn.el.details_title_input  = document.getElementById('details_file_title_input');\r\n    dn.el.details_title_text = document.getElementById('details_file_title_text');\r\n    dn.el.details_description_input  = document.getElementById('details_file_description_input');\r\n    dn.el.details_description_text = document.getElementById('details_file_description_text');    \r\n    dn.el.file_ace_mode_choose = document.getElementById('file_ace_mode_choose')\r\n    dn.el.file_ace_mode_detect = document.getElementById('file_ace_mode_detect');\r\n    dn.el.file_ace_mode_info = document.getElementById('file_ace_mode_info');\r\n    dn.el.file_newline_detect = document.getElementById('file_newline_detect');\r\n    dn.el.file_newline_windows = document.getElementById('file_newline_windows');\r\n    dn.el.file_newline_unix = document.getElementById('file_newline_unix');\r\n    dn.el.file_newline_info = document.getElementById('file_newline_info');\r\n    dn.el.file_tab_detect = document.getElementById('file_tab_detect');\r\n    dn.el.file_tab_hard = document.getElementById('file_tab_hard');\r\n    dn.el.file_tab_soft = document.getElementById('file_tab_soft');\r\n    dn.el.file_tab_soft_text = document.getElementById('file_tab_soft_text');\r\n    dn.el.file_tab_info = document.getElementById('file_tab_info');\r\n    dn.el.button_save = document.getElementById('button_save');\r\n    dn.el.button_print = document.getElementById('button_print');\r\n    dn.el.button_share = document.getElementById('button_share');\r\n    dn.el.button_history = document.getElementById('button_history');     \r\n    dn.syntax_drop_down = dn.create_syntax_menu();   // TODO: tidy up\r\n    dn.el.file_ace_mode_choose.appendChild(dn.syntax_drop_down.el);\r\n    dn.create_file_details_tool();\r\n    dn.el.menu_file.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_file');\r\n    })\r\n\r\n     // pane general settings :::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_general_settings = document.getElementById('pane_general_settings');\r\n    dn.el.theme_chooser = document.getElementById('theme_chooser')\r\n    dn.el.widget_sub_general_box = document.getElementById('sub_general_box')\r\n    dn.el.button_clear_clipboard = document.getElementById(\"button_clear_clipboard\");\r\n    dn.el.button_clear_find_replace = document.getElementById(\"button_clear_find_replace\");\r\n    dn.el.gutter_history_show = document.getElementById('gutter_history_show');\r\n    dn.el.gutter_history_hide = document.getElementById('gutter_history_hide');\r\n    dn.el.word_wrap_off = document.getElementById('word_wrap_off');\r\n    dn.el.word_wrap_at = document.getElementById('word_wrap_at');\r\n    dn.el.word_wrap_edge = document.getElementById('word_wrap_edge');\r\n    dn.el.font_size_decrement = document.getElementById('font_size_decrement');\r\n    dn.el.font_size_increment = document.getElementById('font_size_increment');\r\n    dn.el.font_size_text = document.getElementById('font_size_text');\r\n    dn.el.tab_hard = document.getElementById('tab_hard');\r\n    dn.el.tab_soft = document.getElementById('tab_soft');\r\n    dn.el.newline_menu_windows = document.getElementById('newline_menu_windows');\r\n    dn.el.newline_menu_unix = document.getElementById('newline_menu_unix');\r\n    dn.el.tab_soft_text = document.getElementById('tab_soft_text');\r\n    dn.el.tab_soft_dec = document.getElementById('tab_soft_dec');\r\n    dn.el.tab_soft_inc = document.getElementById('tab_soft_inc');\r\n    dn.el.word_wrap_at_text = document.getElementById('word_wrap_at_text');\r\n    dn.el.word_wrap_at_dec = document.getElementById('word_wrap_at_dec');\r\n    dn.el.word_wrap_at_inc = document.getElementById('word_wrap_at_inc');\r\n    dn.theme_drop_down = dn.create_theme_menu()  // TODO: tidy this up\r\n    dn.el.theme_chooser.appendChild(dn.theme_drop_down.el);\r\n    dn.el.newline_menu_windows.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'windows');\r\n    });\r\n    dn.el.newline_menu_unix.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'unix');\r\n    });\r\n    dn.el.tab_hard.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 1)\r\n    });\r\n    dn.el.tab_soft.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 0);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') - 1;\r\n        at = at < dn.min_soft_tab_n ? dn.min_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') + 1;\r\n        at = at > dn.max_soft_tab_n ? dn.max_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.font_size_decrement.addEventListener('click', dn.font_size_decrement_click);\r\n    dn.el.font_size_increment.addEventListener('click', dn.font_size_increment_click);    \r\n    dn.el.word_wrap_off.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[0,0,0])\r\n    });\r\n    dn.el.word_wrap_at.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt');\r\n        dn.g_settings.set('wordWrap',[1,at,at]);\r\n    });\r\n    dn.el.word_wrap_at_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') - dn.wrap_at_increment;\r\n        at = at < dn.min_wrap_at ? dn.min_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_at_inc.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') + dn.wrap_at_increment;\r\n        at = at > dn.max_wrap_at ? dn.max_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_edge.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[1,null,null])\r\n    });\r\n    dn.el.gutter_history_show.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',1);\r\n    });\r\n    dn.el.gutter_history_hide.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',0);\r\n    });\r\n    dn.create_clipboard_tool();\r\n    dn.el.menu_general_settings.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_general_settings');\r\n    })\r\n\r\n    // pane permissions :::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_permissions = document.getElementById('pane_permissions');\r\n    document.getElementById('button_auth').addEventListener('click', dn.launch_popup);\r\n\r\n    // pane help ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_help = document.getElementById('pane_help');\r\n    dn.el.user_name = document.getElementById('user_name');\r\n    dn.el.pane_help_shortcuts = document.getElementById('pane_help_shortcuts');\r\n    dn.el.pane_help_tips = document.getElementById('pane_help_tips');\r\n    dn.el.pane_help_main = document.getElementById('pane_help_main');\r\n    dn.el.button_shortcuts = document.getElementById('button_view_shortcuts');\r\n    dn.el.button_tips = document.getElementById('button_view_tips');\r\n    dn.el.button_shortcuts.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'shortcuts')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'shortcuts');\r\n    })\r\n    dn.el.button_tips.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'tips')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'tips');\r\n    })\r\n    dn.el.menu_help.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_help');\r\n    })\r\n    dn.create_pane_shortcuts();\r\n\r\n    // pane find ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::    \r\n    dn.el.pane_find = document.getElementById('pane_find');\r\n    dn.el.find_button_case_sensitive = document.getElementById('button_find_case_sensitive');\r\n    dn.el.find_button_whole_words = document.getElementById('button_find_whole_words');\r\n    dn.el.find_button_regex = document.getElementById('button_find_regex');\r\n    dn.el.find_input = document.getElementById('find_input');\r\n    dn.el.find_info = document.getElementById('find_info');\r\n    dn.el.find_results = document.getElementById('find_results');\r\n    dn.el.find_button_case_sensitive.addEventListener('click', function(){\r\n        dn.g_settings.set('find_case_sensitive', !dn.g_settings.get('find_case_sensitive'));\r\n    })\r\n    dn.el.find_button_whole_words.addEventListener('click', function(){\r\n        dn.g_settings.set('find_whole_words', !dn.g_settings.get('find_whole_words'));\r\n    })\r\n    dn.el.find_button_regex.addEventListener('click', function(){\r\n        dn.g_settings.set('find_regex', !dn.g_settings.get('find_regex'));\r\n    })\r\n    dn.el.menu_find.addEventListener('click', function(){\r\n        dn.find_set_find_active_true();\r\n        dn.g_settings.set('pane', 'pane_find');\r\n        dn.el.find_input.focus(); // we have to do this here because it was (possibly) hidden  when we called find_set_find_active_true\r\n    });\r\n    dn.el.find_input.addEventListener('keyup', dn.find_input_keyup);\r\n    dn.el.find_input.addEventListener('keydown', dn.find_input_keydown);\r\n    dn.el.find_input.addEventListener('blur', dn.find_input_blur);\r\n    dn.el.find_input.addEventListener('focus', dn.find_input_focus);\r\n\r\n    // pane open ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_open = document.getElementById('pane_open');\r\n    dn.el.opener_button_a = document.getElementById('opener_button_a');\r\n    dn.el.opener_button_b = document.getElementById('opener_button_b');\r\n    dn.el.menu_open.addEventListener('click', function(){    \r\n        dn.g_settings.set('pane', 'pane_open');\r\n    });\r\n    dn.el.opener_button_a.addEventListener('click', dn.do_open);\r\n    dn.el.opener_button_b.addEventListener('click', dn.do_open);\r\n\r\n    // :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.make_keyboard_shortcuts();\r\n    dn.load_default_settings();\r\n    dn.load_default_properties();    \r\n    document.addEventListener('contextmenu', prevent_default);\r\n    document.addEventListener('dragover', dn.document_drag_over);\r\n    document.addEventListener('drop', dn.document_drop_file);\r\n    window.addEventListener('resize', dn.widget_apply_anchor);\r\n    window.onbeforeunload = dn.query_unload;\r\n\r\n    //work out what caused the page to load\r\n    var params = window_location_to_params_object(); \r\n    if(params['state']){\r\n        var state = {};\r\n        try{\r\n            state = JSON.parse(params['state']);    \r\n        }catch(e){\r\n            dn.show_error(\"Bad URL params:\\n\" + params['state']);\r\n        }\r\n        if(state.action && state.action == \"open\" && state.ids && state.ids.length > 0){\r\n            dn.the_file.file_id = state.ids[0];\r\n        }else if(state.action && state.action == \"create\"){\r\n            dn.the_file.title = \"untitled.\" + (state.ext ? state.ext : dn.g_settings.get('ext'));\r\n            if(state.folderId)\r\n                dn.the_file.folder_id = state.folderId;\r\n            dn.create_file(); //will use the specified title and folderId\r\n        }\r\n    }else{\r\n        dn.the_file.title = \"untitled.\" + dn.g_settings.get('ext');\r\n        dn.create_file();\r\n    }\r\n\r\n    dn.pr_auth.then(dn.authentication_done); // authentication Promise-like defined inline at top of html head\r\n    dn.show_status(); \r\n}\r\n\r\n\r\nif (document.readyState != 'loading')\r\n    dn.document_ready();\r\nelse\r\n    document.addEventListener('DOMContentLoaded', dn.document_ready);\r\n\r\n\r\n"]}