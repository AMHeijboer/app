{"version":3,"sources":["node_modules/keymaster/keymaster.js","js/utils.js","js/drop_down.js","js/info.js","js/using_apis.js","js/save.js","js/revisions_main_thread.js","js/find_replace.js","js/print.js","js/keyboard.js","js/app.js"],"names":["global","k","_handlers","_mods",16,18,17,91,"_scope","_MODIFIERS","⇧","shift","⌥","alt","option","⌃","ctrl","control","⌘","command","_MAP","backspace","tab","clear","enter","return","esc","escape","space","left","up","right","down","del","delete","home","end","pageup","pagedown",",",".","/","`","-","=",";","'","[","]","\\","code","x","toUpperCase","charCodeAt","_downKeys","index","array","item","i","length","compareArray","a1","a2","modifierMap","updateModifierKey","event","dispatch","key","handler","modifiersMatch","scope","keyCode","push","assignKey","filter","call","this","getScope","mods","method","preventDefault","returnValue","stopPropagation","cancelBubble","clearModifier","splice","resetModifiers","keys","getKeys","undefined","split","getMods","shortcut","unbindKey","multipleKeys","j","obj","isPressed","getPressedKeyCodes","slice","tagName","target","srcElement","setScope","deleteScope","handlers","replace","mi","addEvent","object","addEventListener","attachEvent","window","document","previousKey","noConflict","unbind","module","exports","oxford_comma","arr","rotate","el","deg","style","transform","webkitTansform","mozTransform","translate","y","str","webkitTransform","text_multi","text","truncate_long_words","textContent","innerHTML","escape_str","css_animation","timers","els","cls","callback","delay","classList","remove","offsetTop","old_idx","indexOf","clearTimeout","setTimeout","add","stop_propagation","e","prevent_default","until_success","executor","on_error","Promise","success","rejection_handler","err","then","DropDown","val_array","map","val","join","el_list","createElement","className","tabindex","display","el_collapsed","appendChild","ind","event_callbacks","open","dd","document_mousedown","trigger","removeEventListener","parentNode","focus","scrollTop","children","on_click","SetInd","getAttribute","ii","setAttribute","FakeEvent","is_stopped","prototype","stopImmediatePropagation","evt","func","args","fe","IndexOf","GetVal","no_trigger","parseInt","title","isOpen","SetSelected","v","dn","menu_id_to_caption","menu_print","menu_sharing","menu_save","menu_history","menu_file","menu_new","menu_open","menu_find","menu_goto","menu_general_settings","menu_shortcuts","menu_drive","menu_help","shortcuts_list","ext_to_mime_type","html","htm","js","pl","xml","c","cpp","h","json","php","svg","css","java","py","scala","textile","tex","bib","rtf","rtx","sh","sql","as","tooltip_info","save","print","sharing","file history","drive","about","shortcuts","new","settings_file","settings_general","description","WHICH","ENTER","ESC","UP","DOWN","default_settings","ext","wordWrap","wordWrapAt","fontSize","widget_anchor","showGutterHistory","lastDNVersionUsed","newLineDefault","historyRemovedIsExpanded","softTabN","tabIsHard","widgetSub","theme","pane","pane_open","find_regex","find_whole_words","find_case_sensitive","help_inner","find_goto","find_replace","default_custom_props","newline","tabs","aceMode","impersonal_settings_keys","drag_delay_ms","drag_shift_px","min_font_size","max_font_size","max_wrap_at","min_wrap_at","wrap_at_increment","max_soft_tab_n","min_soft_tab_n","detect_tabs_spaces_frac","detect_tabs_tabs_frac","detect_tabs_n_spaces_frac","detect_tabs_n_spaces_frac_for_default","font_size_increment","icon_mouse_over_ms","editor_refocus_time_ms","error_delay_ms","find_history_add_delay","clipboard_info_delay","clipboard_max_length","find_max_results_half","find_max_prefix_chars","find_max_suffix_chars","is_auth_error","type","status","result","error","console","log","dir","handle_auth_error","authorization","popup_active","show_status","err_type","show_error","message","reauth_auto","toggle_permission","reauth_auto_delay_chain",0,1,500,1000,2500,5000,10000,60000,"reauth_auto_timer","reauth_auto_delay","gapi","auth","authorize","auth_map","pr_auth","resolve","bind","reject","reauth_manual","request_user_info","client","request","path","request_file_meta","file_meta","the_file","file_id","params","fields","request_file_body","file_body","make_multipart_boundary","Date","getTime","Math","random","request_save","parts","has_body","body","meta","properties","has_meta","syntax","is_multipart","headers","boundary","request_body","JSON","stringify","request_app_data_document","succ","fail","app_data_realtime_error","realtime_settings","realtime","loadAppDataDocument","request_screw_up_auth_counter","request_screw_up_auth","setToken","save_pending_requests","SaveTracker","local","remote","save_local_version_counter","save_server_state","save_local_state","Object","idx","save_body","save_title","save_other","SaveRequest","_parts","displaced_requests","hasOwnProperty","_is_settled","desired","_desired","_tracker","self","_pr","_throw_if_not_desired","_on_completion","catch","_on_error","_on_finally","res","version","correction","correction_need","close_history","file_history","$revisions_display","revisions_window_resize","getElementById","editor","resize","is_showing_history","canShowResizeError","start_revisions_worker","is_brand_new","widget_content","widget_file_history","getElementsByClassName","$","$view","$new_li","$new_tick","needToRefindViewChildren","$rev_lines_","needToFixHeights","$timeline","$d","find","$revisions_status","$revision_caption_from","$revision_caption_at","$expand_removed","$collapse_removed","revisions","revisionFromEtag","at","from","worker","Worker","g_settings","set","revision_setis_expaned","get","w","onmessage","revision_worker_delivery","postMessage","fileId","token","getToken","access_token","init","appendTo","on","empty","revision_set_at","r","fromChangeEvent","fromTimelineCreation","$at_range","value","modifiedDate","toLocaleDateString","month","day","year","toLocaleTimeString","hour","minute","showEtag","etag","fromEtag","revision_set_from","$from_range","display_revision_timeline","newRevisions","rs","$tick_box","attr","t","downloaded","isDownloaded","Array","apply","$ticks","insertClonedChildren","eq","append","data","debug","forEach","revisionDownloaded","revsionDiffed","isDiffed","newStuff","newStuffForDom","lines","vals_ui8buffer","$rl_","fixHeightFromAuto","vals","Uint8Array","digits","find_goto_changed","new_value","find_goto_wrapper","find_find_wrapper","button_goto","find_info","find_replace_wrapper","find_replace_changed","button_replace","find_inputs_have_focus","find_select_result_idx","find_current_match_idx","find_goto_input_has_focus","find_goto_input_focus","find_perform_goto","find_goto_input_blur","relatedTarget","focus_editor","validated_str","find_goto_input","num","gotoLine","navigateLineEnd","find_goto_input_keyup","find_goto_input_keydown","which","find_results","find_markers","find_marker_current","find_str","find_inputs_focus","currentTarget","find_input","tabIndex","find_replace_input","AceSearch","ace","require","Search","AceRange","Range","setHighlightSelectedWord","find_perform_search","find_inputs_blur","session","getSession","removeMarker","find_info_overflow","setSelectionRange","selectionEnd","find_build_options","use_reg_exp","sensitive","re","RegExp","needle","wrap","caseSensitive","wholeWord","regExp","search_options","selection","clearSelection","search","setOptions","results","findAll","selected_range","getSelection","getRange","row","start","column","current_match_idx","addMarker","range","results_sub","replace_is_showing","max_results","n_pre","n_post","concat","show_replace_buttons","col","prefix_range","max","pre_ellipses","suffix_range","getTextRange","find_result_click","find_replace_result_click","renderer","scrollSelectionIntoView","find_settings_changed","find_replace_result_idx","find_input_keyup","find_input_keydown","shiftKey","ctrlKey","find_replace_input_keydown","find_replace_all","options","replaceAll","find_replace_click","$search","$tryReplace","do_print","content","doc","getAllLines","line_to_html","printWindow","writeln","cssText","n","printLayer","create","Text","tokens","getTokens","screenColumn","$renderToken","platform","navigator","create_pane_shortcuts","arry","dict","action","pane_help_shortcuts","esc_pressed","find_shortcut_used","sel","getSelectionRange","select","find_goto_shortcut_used","show_replace_shortcut_used","make_keyboard_shortcuts","commands","removeCommands","do_save","do_open","do_new","HashHandler","extraKeyEvents","bindKey","win","mac","descr","exec","document_clipboard_left","document_clipboard_right","keyBinding","addKeyboardHandler","ctrl_key","version_str","can_show_drag_drop_error","file_sharing","authentication","local_settings","folder_id","loaded_mime_type","new_line_detected","tab_detected","is_pristine","mime_type","is_saving","data_to_save","generation_to_save","is_read_only","is_shared","is_reading_file_object","custom_props","custom_prop_exists","saving_title_count","change_line_history","last_change","change_line_classes","rootStr","trueN","factor","change_line_classes_rm","show_user_info","a","user_info","user_name","name","do_share","share_dialog","do_share_sub","load","share","ShareClient","client_id","setItemIds","setOAuthToken","showSettingsDialog","detect_new_line","first_n","show_newline_status","has_rn","has_solo_n","match","apply_newline_choice","newlineDefault","newline_menu_windows","newline_menu_unix","file_newline_detect","file_newline_windows","file_newline_unix","setNewLineMode","statusStr","file_newline_info","open_button_click","view","google","picker","View","ViewId","DOCS","open_picker","PickerBuilder","enableFeature","Feature","NAV_HIDDEN","setAppId","addView","setCallback","picker_callback","build","setVisible","Action","PICKED","docs","id","url","userId","url_user_id","ids","location","open_new_tab","close","show_help_inner","inner_pane","pane_help_tips","pane_help_main","button_shortcuts","button_tips","state","pane_permissions","permissions_showing","the_widget","show_pane","el_icon","menu_icon_from_pane_id","widget_mouse_down","widget_mouse_down_info","off_left","clientX","off_top","clientY","start_time","now","is_dragging","button","document_mouse_move_widget","document_mouse_up_widget","pos","getBoundingClientRect","widget_w","offsetWidth","widget_h","offsetHeight","window_w","innerWidth","window_h","innerHeight","anchor","top","widget_apply_anchor","isArray","widget_menu","bottom","toggle_widget","s","extra","widget_text","widget_pending","widget_error_text","widget_error","set_drive_link_to_folder","href","show_app_data_document","old_temp_g_settings","getModel","getRoot","g_clipboard","createList","g_find_history","existingKeys","EventType","VALUE_CHANGED","settings_changed","getKeeps","property","newValue","load_default_settings","ob","keeps","keep","localStorage","parse","setTheme","theme_drop_down","scrollLine","get_scroll_line","font_size_text","toFixed","setFontSize","scrollToLine","setUseWrapMode","setWrapLimitRange","word_wrap_off","word_wrap_edge","word_wrap_at","word_wrap_at_text","curWrap","setPrintMarginColumn","gutter_history_show","gutter_history_hide","removeGutterDecoration","apply_tab_choice","find_button_regex","find_button_whole_words","find_button_case_sensitive","font_size_decrement_click","font_size","font_size_increment_click","detect_tab","getLines","indents","show_tab_status","stats","reduce","nWithMixture","nWithOnlyTabs","spaceHist","nSamp","nWithOnlySpaces","spaceModHist","m","defaultNSpaces","isDefault","threshold","d","defaultStr","file_tab_info","defaultTabIsHard","defaultSoftTabN","isHard","nSpaces","isDetected","setUseSoftTabs","setTabSize","tab_soft_text","tab_hard","tab_soft","file_tab_detect","file_tab_hard","file_tab_soft","file_tab_soft_text","set_file_tabs_to_soft_or_hard","delta","f","current","newT","set_property","show_syntax_status","file_ace_mode_info","detect_syntax","mode","getModeForPath","syntax_detected","caption","apply_syntax_choice","set_syntax","file_ace_mode_detect","syntax_drop_down","modesArray","modes","setMode","create_theme_menu","themes","themesByName","create_syntax_menu","read_only_bail","create_file_details_tool","details_title_text","details_description_text","details_title_input","new_val","show_file_title","save_file_title","ignore_escape","button_save","button_print","button_share","button_history","details_description_input","show_description","save_file_description","save_new_file","save_file","proxy","save_done","getValue","clipboard_active","clipboard_index","undo","insert","document_clipboard_keyup","off","pane_clipboard","clipboard_info_timer","on_paste","lastIndexOf","on_copy","create_clipboard_tool","button_clear_clipboard","button_clear_find_replace","base","folderId","create_new_tool","create_file","guess_mime_type","plain","substr","mimeType","parentId","parentNodes","gens","saved_new_file","resp","shared","fileExtension","history","replaceState","save_all_file_properties","save_scroll_line","patch_property","screenToDocumentPosition","getScrollTopRow","show_file_meta","Error","capabilities","canEdit","parents","show_file_body","setting_session_value","setValue","on_change","nClasses","start_row","end_row","addGutterDecoration","newLineCount","query_unload","property_updated","propKey","load_default_properties","get_properties_from_cloud","got_all_file_properties","items","prop_name","oldVal","dummyCallback","propertyKey","visibility","execute","patch","resource","document_drag_over","originalEvent","dataTransfer","dropEffect","document_drop_file","files","file","isReading_file_object","FileReader","onload","dropped_file_read","readAsText","document_ready","getElementsByTagName","editor_el","edit","ace_content","setAnimatedScroll","$blockScrolling","Infinity","pane_file","file_ace_mode_choose","pane_general_settings","theme_chooser","widget_sub_general_box","font_size_decrement","tab_soft_dec","tab_soft_inc","word_wrap_at_dec","word_wrap_at_inc","pane_help","pane_find","button_find_replace_all","opener_button_a","onbeforeunload","window_location_to_params_object","on_success","pr_meta","pr_body","all","pr_realtime_loaded","readyState"],"mappings":"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","file":"all.build.js","sourcesContent":["//     keymaster.js\n//     (c) 2011-2013 Thomas Fuchs\n//     keymaster.js may be freely distributed under the MIT license.\n\n;(function(global){\n  var k,\n    _handlers = {},\n    _mods = { 16: false, 18: false, 17: false, 91: false },\n    _scope = 'all',\n    // modifier keys\n    _MODIFIERS = {\n      '⇧': 16, shift: 16,\n      '⌥': 18, alt: 18, option: 18,\n      '⌃': 17, ctrl: 17, control: 17,\n      '⌘': 91, command: 91\n    },\n    // special keys\n    _MAP = {\n      backspace: 8, tab: 9, clear: 12,\n      enter: 13, 'return': 13,\n      esc: 27, escape: 27, space: 32,\n      left: 37, up: 38,\n      right: 39, down: 40,\n      del: 46, 'delete': 46,\n      home: 36, end: 35,\n      pageup: 33, pagedown: 34,\n      ',': 188, '.': 190, '/': 191,\n      '`': 192, '-': 189, '=': 187,\n      ';': 186, '\\'': 222,\n      '[': 219, ']': 221, '\\\\': 220\n    },\n    code = function(x){\n      return _MAP[x] || x.toUpperCase().charCodeAt(0);\n    },\n    _downKeys = [];\n\n  for(k=1;k<20;k++) _MAP['f'+k] = 111+k;\n\n  // IE doesn't support Array#indexOf, so have a simple replacement\n  function index(array, item){\n    var i = array.length;\n    while(i--) if(array[i]===item) return i;\n    return -1;\n  }\n\n  // for comparing mods before unassignment\n  function compareArray(a1, a2) {\n    if (a1.length != a2.length) return false;\n    for (var i = 0; i < a1.length; i++) {\n        if (a1[i] !== a2[i]) return false;\n    }\n    return true;\n  }\n\n  var modifierMap = {\n      16:'shiftKey',\n      18:'altKey',\n      17:'ctrlKey',\n      91:'metaKey'\n  };\n  function updateModifierKey(event) {\n      for(k in _mods) _mods[k] = event[modifierMap[k]];\n  };\n\n  // handle keydown event\n  function dispatch(event) {\n    var key, handler, k, i, modifiersMatch, scope;\n    key = event.keyCode;\n\n    if (index(_downKeys, key) == -1) {\n        _downKeys.push(key);\n    }\n\n    // if a modifier key, set the key.<modifierkeyname> property to true and return\n    if(key == 93 || key == 224) key = 91; // right command on webkit, command on Gecko\n    if(key in _mods) {\n      _mods[key] = true;\n      // 'assignKey' from inside this closure is exported to window.key\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = true;\n      return;\n    }\n    updateModifierKey(event);\n\n    // see if we need to ignore the keypress (filter() can can be overridden)\n    // by default ignore key presses if a select, textarea, or input is focused\n    if(!assignKey.filter.call(this, event)) return;\n\n    // abort if no potentially matching shortcuts found\n    if (!(key in _handlers)) return;\n\n    scope = getScope();\n\n    // for each potential shortcut\n    for (i = 0; i < _handlers[key].length; i++) {\n      handler = _handlers[key][i];\n\n      // see if it's in the current scope\n      if(handler.scope == scope || handler.scope == 'all'){\n        // check if modifiers match if any\n        modifiersMatch = handler.mods.length > 0;\n        for(k in _mods)\n          if((!_mods[k] && index(handler.mods, +k) > -1) ||\n            (_mods[k] && index(handler.mods, +k) == -1)) modifiersMatch = false;\n        // call the handler and stop the event if neccessary\n        if((handler.mods.length == 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91]) || modifiersMatch){\n          if(handler.method(event, handler)===false){\n            if(event.preventDefault) event.preventDefault();\n              else event.returnValue = false;\n            if(event.stopPropagation) event.stopPropagation();\n            if(event.cancelBubble) event.cancelBubble = true;\n          }\n        }\n      }\n    }\n  };\n\n  // unset modifier keys on keyup\n  function clearModifier(event){\n    var key = event.keyCode, k,\n        i = index(_downKeys, key);\n\n    // remove key from _downKeys\n    if (i >= 0) {\n        _downKeys.splice(i, 1);\n    }\n\n    if(key == 93 || key == 224) key = 91;\n    if(key in _mods) {\n      _mods[key] = false;\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = false;\n    }\n  };\n\n  function resetModifiers() {\n    for(k in _mods) _mods[k] = false;\n    for(k in _MODIFIERS) assignKey[k] = false;\n  };\n\n  // parse and assign shortcut\n  function assignKey(key, scope, method){\n    var keys, mods;\n    keys = getKeys(key);\n    if (method === undefined) {\n      method = scope;\n      scope = 'all';\n    }\n\n    // for each shortcut\n    for (var i = 0; i < keys.length; i++) {\n      // set modifier keys if any\n      mods = [];\n      key = keys[i].split('+');\n      if (key.length > 1){\n        mods = getMods(key);\n        key = [key[key.length-1]];\n      }\n      // convert to keycode and...\n      key = key[0]\n      key = code(key);\n      // ...store handler\n      if (!(key in _handlers)) _handlers[key] = [];\n      _handlers[key].push({ shortcut: keys[i], scope: scope, method: method, key: keys[i], mods: mods });\n    }\n  };\n\n  // unbind all handlers for given key in current scope\n  function unbindKey(key, scope) {\n    var multipleKeys, keys,\n      mods = [],\n      i, j, obj;\n\n    multipleKeys = getKeys(key);\n\n    for (j = 0; j < multipleKeys.length; j++) {\n      keys = multipleKeys[j].split('+');\n\n      if (keys.length > 1) {\n        mods = getMods(keys);\n        key = keys[keys.length - 1];\n      }\n\n      key = code(key);\n\n      if (scope === undefined) {\n        scope = getScope();\n      }\n      if (!_handlers[key]) {\n        return;\n      }\n      for (i = 0; i < _handlers[key].length; i++) {\n        obj = _handlers[key][i];\n        // only clear handlers if correct scope and mods match\n        if (obj.scope === scope && compareArray(obj.mods, mods)) {\n          _handlers[key][i] = {};\n        }\n      }\n    }\n  };\n\n  // Returns true if the key with code 'keyCode' is currently down\n  // Converts strings into key codes.\n  function isPressed(keyCode) {\n      if (typeof(keyCode)=='string') {\n        keyCode = code(keyCode);\n      }\n      return index(_downKeys, keyCode) != -1;\n  }\n\n  function getPressedKeyCodes() {\n      return _downKeys.slice(0);\n  }\n\n  function filter(event){\n    var tagName = (event.target || event.srcElement).tagName;\n    // ignore keypressed in any elements that support keyboard data input\n    return !(tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA');\n  }\n\n  // initialize key.<modifier> to false\n  for(k in _MODIFIERS) assignKey[k] = false;\n\n  // set current scope (default 'all')\n  function setScope(scope){ _scope = scope || 'all' };\n  function getScope(){ return _scope || 'all' };\n\n  // delete all handlers for a given scope\n  function deleteScope(scope){\n    var key, handlers, i;\n\n    for (key in _handlers) {\n      handlers = _handlers[key];\n      for (i = 0; i < handlers.length; ) {\n        if (handlers[i].scope === scope) handlers.splice(i, 1);\n        else i++;\n      }\n    }\n  };\n\n  // abstract key logic for assign and unassign\n  function getKeys(key) {\n    var keys;\n    key = key.replace(/\\s/g, '');\n    keys = key.split(',');\n    if ((keys[keys.length - 1]) == '') {\n      keys[keys.length - 2] += ',';\n    }\n    return keys;\n  }\n\n  // abstract mods logic for assign and unassign\n  function getMods(key) {\n    var mods = key.slice(0, key.length - 1);\n    for (var mi = 0; mi < mods.length; mi++)\n    mods[mi] = _MODIFIERS[mods[mi]];\n    return mods;\n  }\n\n  // cross-browser events\n  function addEvent(object, event, method) {\n    if (object.addEventListener)\n      object.addEventListener(event, method, false);\n    else if(object.attachEvent)\n      object.attachEvent('on'+event, function(){ method(window.event) });\n  };\n\n  // set the handlers globally on document\n  addEvent(document, 'keydown', function(event) { dispatch(event) }); // Passing _scope to a callback to ensure it remains the same by execution. Fixes #48\n  addEvent(document, 'keyup', clearModifier);\n\n  // reset modifiers to false whenever the window is (re)focused.\n  addEvent(window, 'focus', resetModifiers);\n\n  // store previously defined key\n  var previousKey = global.key;\n\n  // restore previously defined key and return reference to our key object\n  function noConflict() {\n    var k = global.key;\n    global.key = previousKey;\n    return k;\n  }\n\n  // set window.key and window.key.set/get/deleteScope, and the default filter\n  global.key = assignKey;\n  global.key.setScope = setScope;\n  global.key.getScope = getScope;\n  global.key.deleteScope = deleteScope;\n  global.key.filter = filter;\n  global.key.isPressed = isPressed;\n  global.key.getPressedKeyCodes = getPressedKeyCodes;\n  global.key.noConflict = noConflict;\n  global.key.unbind = unbindKey;\n\n  if(typeof module !== 'undefined') module.exports = assignKey;\n\n})(this);\n","\"use strict\";\r\n\r\nvar oxford_comma = function(arr){\r\n    switch (arr.length){\r\n        case 1:\r\n            return arr[0];\r\n        case 2:\r\n            return arr[0] + \" and \" + arr[1];\r\n        case 3:\r\n            return arr[0] + \", \" + arr[1] + \", and \" + arr[2];\r\n    }\r\n}\r\n\r\nvar rotate = function(el, deg){\r\n    el.style.transform = \"rotate(\" + deg + 'deg)';\r\n    el.style.webkitTansform = \"rotate(\" + deg + 'deg)';\r\n    el.style.mozTransform = \"rotate(\" + deg + 'deg)';\r\n}\r\n\r\nvar translate = function(el, x, y){\r\n    var str = x==null ? \"\" : \"translate(\" + x + \"px,\" + y + \"px)\";\r\n    el.style.transform = str;\r\n    el.style.webkitTransform = str;\r\n    el.style.mozTransform = str;\r\n}\r\n\r\nvar text_multi = function(el, text, truncate_long_words){\r\n    if(truncate_long_words){\r\n        text = text.replace(/(\\S{25})\\S*/g,'$1...'); \r\n    }\r\n    el.textContent = text;  \r\n    el.innerHTML = el.innerHTML.replace(/\\n/g,'<br/>').replace(/\\t/g,'&nbsp;&nbsp;&nbsp; ');\r\n}\r\n\r\nvar escape_str = function(str){\r\n    // http://stackoverflow.com/a/18750001/2399799\r\n    return str.replace(/[\\u00A0-\\u9999<>\\&]/g, function(i) {\r\n        return '&#' + i.charCodeAt(0) + ';';\r\n    });\r\n}\r\n\r\nvar css_animation = (function(){\r\n    var timers = []; // we store timers and matching els so we can cancel if needed\r\n    var els = [];\r\n\r\n    return function(el, cls, callback, delay){\r\n        el.classList.remove(cls);\r\n        el.offsetTop; //forces class to be removed, so we can actually re-add it.\r\n        var old_idx = els.indexOf(el);\r\n        if(old_idx != -1){\r\n            clearTimeout(timers[old_idx]);\r\n            timers.splice(old_idx, 1);\r\n            els.splice(old_idx, 1);\r\n        }\r\n        els.push(el);\r\n        timers.push(setTimeout(callback, delay)); //this is better than trying to use the endtransition event\r\n        el.classList.add(cls);\r\n    }\r\n})();\r\n\r\nvar stop_propagation = function(e){\r\n    e.stopPropagation();\r\n}\r\n\r\nvar prevent_default = function(e){\r\n    e.preventDefault();  \r\n}\r\n\r\nfunction until_success(executor, on_error){\r\n    // This was confusing to write, so when I finished I turned it into a S.O. answer:\r\n    //      http://stackoverflow.com/a/35782428/2399799\r\n    return new Promise(function(success){\r\n        var rejection_handler = function(err){\r\n            on_error(err);\r\n            return new Promise(executor).then(success, rejection_handler);\r\n        }\r\n        return new Promise(executor).then(success, rejection_handler);\r\n    });\r\n}\r\n\r\n\r\n\r\n/* TODO: ...............................................................\r\n\r\n$.fn.fixHeightFromAuto = function(){\r\n    var heights = [];\r\n    var d = this.get();\r\n    for(var i=0;i<d.length;i++)\r\n        heights.push(getComputedStyle(d[i]).height);\r\n    \r\n    this.each(function(ind){this.style.height = heights[ind];});\r\n\r\n    return this;\r\n}\r\n\r\n$.fn.insertClonedChildren = function(index,$src,textArray,attrObjArrays){\r\n    //inserts new nodes before this.children(index)\r\n    //the new nodes are based on $src, with text set according to the elements of textArray\r\n    //attrObjArrays is an optional arrays of objects giving key names and values\r\n    \r\n    var src = $src.get(0);\r\n    var frag = document.createDocumentFragment();\r\n    \r\n    textArray.map(function(str,ind){\r\n                    var a = src.cloneNode(false); \r\n                    a.textContent = str;\r\n                    if(attrObjArrays)for(var attr in attrObjArrays[ind])\r\n                        a.setAttribute(attr,attrObjArrays[ind][attr]);\r\n                    frag.appendChild(a);\r\n                });\r\n    \r\n    var parent = this.get(0);\r\n    var new_$els = $(Array.prototype.slice.call(frag.children,0));\r\n    parent.insertBefore(frag,parent.children[index]);\r\n    \r\n    return new_$els;\r\n}\r\n\r\n*/","\"use strict\";\r\n\r\nvar DropDown = function(val_array){\r\n    //constructor, must use <new>\r\n    \r\n    var str = val_array.map(function(val){\r\n                    return \"<div class='dropdown_item' title='\" + escape_str(val) + \"'>\" + escape_str(val) + \"</div>\";\r\n                 }).join(\"\");\r\n    \r\n    this.val_array = val_array.slice(0); \r\n    this.el_list = document.createElement('div');\r\n    this.el_list.className ='dropdown_item_list';\r\n    this.el_list.tabindex =-1\r\n    this.el_list.style.display = 'none';\r\n    this.el_list.innerHTML = str;\r\n\r\n    this.el_collapsed = document.createElement('div');\r\n    this.el_collapsed.className = 'dropdown_collapsed';\r\n    \r\n    this.el = document.createElement('div');\r\n    this.el.className = 'dropdown';\r\n    this.el.appendChild(this.el_list)\r\n    this.el.appendChild(this.el_collapsed);\r\n    this.ind = 0;\r\n    this.el_collapsed.textContent = val_array[0];\r\n    this.event_callbacks = {}; //map of callback lists\r\n    this.open = false;\r\n    \r\n    var dd = this;\r\n\r\n    this.document_mousedown = function(e){\r\n        dd.el_list.style.display = 'none';\r\n        dd.open = false;\r\n        dd.trigger(\"blur\");\r\n        document.removeEventListener('mousedown', dd.document_mousedown);\r\n    }\r\n\r\n    this.el_collapsed.addEventListener('mousedown',function(){\r\n        if(!dd.trigger(\"click\"))\r\n            return;\r\n        dd.el.parentNode.classList.add(\"selected\");\r\n        dd.el_list.style.display = '';\r\n        this.open = true;\r\n        setTimeout(function(){\r\n            dd.el_list.focus();\r\n            dd.el_list.scrollTop = dd.el_list.children[dd.ind].offsetTop;\r\n            document.addEventListener('mousedown', dd.document_mousedown)\r\n        },1);\r\n    });\r\n    var on_click = function(e){\r\n            dd.SetInd(this.getAttribute('data-ind'));\r\n            dd.el_list.style.display = 'none';\r\n            dd.open = false;\r\n            e.stopPropagation();\r\n            document.removeEventListener('mousedown', dd.document_mousedown);\r\n    };\r\n    for(var ii=0; ii<this.el_list.children.length; ii++){\r\n        this.el_list.children[ii].setAttribute('data-ind', ii);\r\n        this.el_list.children[ii].addEventListener(\"click\", on_click); \r\n    }\r\n\r\n    return this;\r\n}\r\n\r\nDropDown.FakeEvent = function(){//static subclass\r\n    this.is_stopped = false;\r\n}\r\nDropDown.FakeEvent.prototype.stopImmediatePropagation = function(){\r\n    this.is_stopped = true;\r\n}\r\n\r\nDropDown.prototype.addEventListener = function(evt, func){\r\n    if(!(evt in this.event_callbacks))\r\n        this.event_callbacks[evt] = [];\r\n    this.event_callbacks[evt].push(func);\r\n}\r\n\r\nDropDown.prototype.trigger = function(evt, args){\r\n    var fe = new DropDown.FakeEvent();\r\n    if(evt in this.event_callbacks){\r\n        for(var ii = 0; ii<this.event_callbacks[evt].length; ii++)\r\n            this.event_callbacks[evt][ii].call(this, fe);\r\n        if(fe.is_stopped)\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\nDropDown.prototype.IndexOf = function(val){\r\n    return this.val_array.indexOf(val);\r\n}\r\n\r\nDropDown.prototype.GetVal = function(){\r\n    return this.val_array[this.ind];\r\n}\r\n\r\nDropDown.prototype.SetInd = function(ind,no_trigger){\r\n    ind = parseInt(ind)\r\n    if(ind === this.ind)\r\n        return;\r\n    this.el_list.children[this.ind].classList.remove(\"selected\");\r\n    this.el_collapsed.textContent = this.val_array[ind];\r\n    this.el_collapsed.title = escape_str(this.val_array[ind]);\r\n    this.ind = ind;\r\n    this.el_list.children[ind].classList.add(\"selected\");\r\n    if(!no_trigger)\r\n        this.trigger(\"change\",{ind:ind,str:this.val_array[ind],isOpen: this.open});\r\n}\r\n\r\nDropDown.prototype.SetSelected = function(v){\r\n    if(v)\r\n        this.el.parentNode.classList.add(\"selected\");\r\n    else\r\n        this.el.parentNode.classList.remove(\"selected\");\r\n}\r\n","\"use strict\";\r\n\r\ndn.menu_id_to_caption = {\r\n'menu_print': 'print',\r\n'menu_sharing': 'sharing',\r\n'menu_save': 'save',\r\n'menu_history': 'history',\r\n'menu_file': 'current file',\r\n'menu_new': 'new',\r\n'menu_open': 'new/open',\r\n'menu_find': 'find/replace',\r\n'menu_goto': 'goto line',\r\n'menu_general_settings': 'general settings',\r\n'menu_shortcuts': 'shortcuts',\r\n'menu_drive': 'drive',\r\n'menu_help': 'about/help'};\r\n\r\n\r\ndn.shortcuts_list = [\r\n\"cut|Ctrl-X|Cmd-X\",    \r\n\"copy|Ctrl-C|Cmd-C\",\r\n\"paste|Ctrl-V|Command-V\",\r\n\"cycle clipboard|Cltr-[V then left or right arrow]|Command-[V then left or right arrow]\",\r\n\"select all|Ctrl-A|Command-A\",\r\n\"find|Ctrl(-Alt)-F\",\r\n\"replace|Ctrl-R\",\r\n\"go to line|Ctrl(-Alt)-L\",\r\n\"undo|Ctrl-Z|Command-Z\",\r\n\"redo|Ctrl-Shift-Z,Ctrl-Y|Command-Shift-Z,Command-Y\",\r\n\" | \",\r\n\"toggle widget|Esc\",\r\n\"save|Ctrl-S|Command-S\",\r\n\"print|Ctrl(-Alt)-P|Command-P\",\r\n\"file history|Ctrl-H|Command-H\",\r\n\"new|Ctrl(-Alt)-N\",\r\n\"open|Ctrl(-Alt)-O\",\r\n\"  | \",\r\n\"to upper case|Ctrl-U\",\r\n\"to lower case|Ctr-Shift-U\",\r\n\"modify selection|Shift-(Ctrl-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown, PageUp, End}|Shift-(Command-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown,End}\",\r\n\"copy lines down|Ctrl-Alt-Down|Command-Option-Down\",\r\n\"copy lines up|Ctrl-Alt-Up|Command-Option-Up\",\r\n\"center selection||Ctrl-L\",\r\n\"fold all|Alt-0|Option-0\",\r\n\"unfold all|Alt-Shift-0|Option-Shift-0\",\r\n\"go to end|Ctrl-End,Ctrl-Down|Command-End,Command-Down\",\r\n\"go to line end|Alt-Right,End|Command-Right,End,Ctrl-E\",\r\n\"go to line start|Alt-Left,Home|Command-Left,Home,Ctrl-A\",\r\n\"go to page down|PageDown|Option-PageDown,Ctrl-V\",\r\n\"go to page up|PageUp|Option-PageUp\",\r\n\"go to start|Ctrl-Home,Ctrl-Up|Command-Home,Command-Up\",\r\n\"go to word left|Ctrl-Left|Option-Left\",\r\n\"go to word right|Ctrl-Right|Option-Right\",\r\n\"indent|Tab\",\r\n\"outdent|Shift-Tab\",\r\n\"overwrite|Insert\",\r\n\"remove line|Ctrl-D|Command-D\",\r\n\"remove to line end||Ctrl-K\",\r\n\"remove to linestart||Option-Backspace\",\r\n\"remove word left||Alt-Backspace,Ctrl-Alt-Backspace\",\r\n\"remove word right||Alt-Delete\",\r\n\"split line||Ctrl-O\",\r\n\"toggle comment|Ctrl-7|Command-7\",\r\n\"transpose letters|Ctrl-T\"\r\n]\r\n\r\ndn.ext_to_mime_type = {\r\nhtml:\"text/html\",\r\nhtm:\"text/html\",\r\njs:\"text/javascript\",\r\npl:\"application/x-perl\",\r\nxml:\"text/xml\",\r\nc:\"text/x-csrc\",\r\ncpp:\"text/x-c++src\",\r\nh:\"text/x-chdr\",\r\njson:\"application/json\",\r\nphp:\"application/x-php\",\r\nsvg:\"text/html\",\r\ncss:\"text/css\",\r\njava:\"text/x-java\",\r\npy:\"text/x-python\",\r\nscala:\"scala\",\r\ntextile:\"textile\",\r\ntex:\"application/x-tex\",\r\nbib:\"application/x-tex\",\r\nrtf:\"application/rtf\",\r\nrtx:\"application/rtf\",\r\nsh:\"application/x-sh\",\r\nsql:\"text/x-sql\",\r\nas:\"text/x-actionscript\"\r\n//everything else is hopefully ok to be text/plain.\r\n}\r\n\r\ndn.tooltip_info = { //keys correspond to icon data-info attr, which will be the same as keys in SHORTCUTS_LIST\r\n    \"save\" : \"Save file contents.  \",\r\n    \"print\": \"Open print view in a new tab.  \",\r\n    \"sharing\": \"View and modify file's sharing status.\",\r\n    \"file history\": \"Explore the file history.  \",\r\n    \"drive\": \"Show this file in Google Drive.  \",\r\n    \"about\": \"Drive Notepad website.\",\r\n    \"shortcuts\": \"Keyboard shortcuts.\",\r\n    \"new\": \"Create new file in a new tab.  \",\r\n    \"open\": \"Launch open dialoag.  \",\r\n    \"settings_file\": \"Properties of the current file.\",\r\n    \"settings_general\": \"Your general Drive Notepad preferences.\",\r\n    \"title\": \"Click to edit the file's title.\",\r\n    \"description\": \"Click to edit the file's description.\"\r\n}\r\n\r\n// TODO: use keymaster rather than relying on this\r\nvar WHICH = {\r\nENTER: 13,\r\nESC: 27,\r\nUP: 38,\r\nDOWN: 40\r\n};\r\n\r\ndn.default_settings = {\r\next: 'txt',\r\nwordWrap: [true,null,null],\r\nwordWrapAt: 80,\r\nfontSize: 1,\r\nwidget_anchor: ['l',50,'t',10],\r\nshowGutterHistory: 1,\r\nlastDNVersionUsed: '',\r\nnewLineDefault: 'windows',\r\nhistoryRemovedIsExpanded: true,\r\nsoftTabN: 4,\r\ntabIsHard: 0,\r\nwidgetSub: 'general',\r\ntheme: \"chrome\",\r\npane: '',\r\npane_open: true,\r\nfind_regex: false,\r\nfind_whole_words: false,\r\nfind_case_sensitive: false,\r\nhelp_inner: 'main',\r\nfind_goto: false,\r\nfind_replace: false\r\n}\r\n\r\ndn.default_custom_props = {\r\nnewline: \"detect\",\r\ntabs: \"detect\",\r\naceMode: \"detect\"\r\n};\r\n\r\ndn.impersonal_settings_keys = [\r\n\"wordWrap\",\r\n\"wordWrapAt\",\r\n\"fontSize\",\r\n\"widget_anchor\",\r\n\"showGutterHistory\",\r\n\"historyRemovedIsExpanded\",\r\n\"tabIsHard\",\r\n\"softTabN\",\r\n\"widgetSub\",\r\n\"theme\",\r\n\"pane\",\r\n\"pane_open\",\r\n\"find_regex\",\r\n\"find_whole_words\",\r\n\"find_case_sensitive\",\r\n\"help_inner\",\r\n\"find_goto\",\r\n\"find_replace\"\r\n];\r\n\r\ndn.drag_delay_ms = 400;\r\ndn.drag_shift_px = 40;\r\ndn.min_font_size = 0.3;\r\ndn.max_font_size = 5; \r\ndn.max_wrap_at = 200;\r\ndn.min_wrap_at = 20;\r\ndn.wrap_at_increment = 10;\r\ndn.max_soft_tab_n = 10;\r\ndn.min_soft_tab_n = 2;\r\ndn.detect_tabs_spaces_frac = 0.9;\r\ndn.detect_tabs_tabs_frac = 0.9;\r\ndn.detect_tabs_n_spaces_frac = 0.99;\r\ndn.detect_tabs_n_spaces_frac_for_default = 0.6;\r\ndn.font_size_increment = 0.15;\r\ndn.icon_mouse_over_ms = 300;\r\ndn.editor_refocus_time_ms = 500;\r\ndn.error_delay_ms = 5000;//5 seconds\r\ndn.find_history_add_delay = 2000; //ms\r\ndn.clipboard_info_delay = 500; //ms\r\ndn.clipboard_max_length = 20; //TODO: decide whether a large clipboard slows page loads and whether we can do anything about it.\r\ndn.find_max_results_half = 3; \r\ndn.find_max_prefix_chars = 10;\r\ndn.find_max_suffix_chars = 60;","\"use strict\";\r\n\r\n/*\r\n    Working with oauth2 APIs has its complexities, some of which\r\n    are dealt with by the google client library, but some of which\r\n    are exposed for us to deal with.\r\n\r\n    These functions do the majority of the fiddly stuff.  In particular,\r\n    the dn.request_* functions are designed to be used in a promise chain\r\n    within a until_success call. See the readme for additional explanation.\r\n\r\n    You can insert the request_screw_up_auth into a promise chain to check \r\n    how the chain handles unexpected invalidation.\r\n\r\n*/\r\n\r\ndn.is_auth_error = function(err){\r\n    // returns 0 for non-auth errors, 1 for auto refresh and 2 for manual refresh\r\n    if(!err)\r\n        return 2;\r\n    if(err.type && err.type === \"token_refresh_required\")\r\n        return 1;\r\n    if(err.status === 403 || err.status === 401)\r\n        return 1;\r\n    if(err.status === 404)\r\n        return 0;\r\n    if(err.result && err.result.error && err.result.code === -1)//network error\r\n        return 1;\r\n    console.log(\"WHAT IS THIS ERROR?....\")\r\n    console.dir(err);\r\n    return 0;\r\n}\r\n\r\ndn.handle_auth_error = function(err){\r\n    // this is the error handler for dn.pr_auth\r\n\r\n    dn.status.authorization = -1;\r\n    dn.status.popup_active = 0;\r\n    dn.show_status();\r\n    var err_type = dn.is_auth_error(err);\r\n\r\n    if(err_type === 0)\r\n        dn.show_error(err.result.error.message);\r\n    else if(err_type == 1)\r\n        dn.reauth_auto();\r\n    else{\r\n        // user has to click button to trigger reauth-manual\r\n        dn.toggle_permission(true);\r\n    }\r\n}\r\n\r\n\r\ndn.reauth_auto_delay_chain = {0: 1, 1:500, 500: 1000, 1000: 2500, 2500: 5000, 5000: 10000, 10000: 60000, 60000: 60000}\r\ndn.reauth_auto = function(){ \r\n    // with roughly-exponetial backoff...\r\n    if (!dn.reauth_auto_timer){\r\n        // 1ms, 500ms, 1s, 2s, 5s, 10s, 60s.\r\n        if(!dn.reauth_auto_delay)\r\n            dn.reauth_auto_delay = dn.reauth_auto_delay_chain[0];\r\n        else\r\n            dn.reauth_auto_delay = dn.reauth_auto_delay_chain[dn.reauth_auto_delay];\r\n        dn.status.authorization = 0;\r\n        dn.show_status();\r\n        console.log(\"issuing auto reauth with delay \" + dn.reauth_auto_delay + \"ms.\")\r\n        dn.reauth_auto_timer = setTimeout(function(){\r\n            dn.reauth_auto_timer = undefined;\r\n            console.log(\"and now running the auto reauth...\")\r\n            gapi.auth.authorize(dn.auth_map(true))\r\n                .then(dn.pr_auth.resolve.bind(dn.pr_auth),\r\n                      dn.pr_auth.reject.bind(dn.pr_auth));\r\n        }, dn.reauth_auto_delay)\r\n    } else {\r\n        console.log(\"auto reauth already due to be sent\")\r\n    }\r\n}\r\n\r\ndn.reauth_manual = function(){\r\n    // if this succeeds it will trigger dn.pr_auth.resolve, which will call \r\n    // any pending (and future) success callbacks.\r\n    dn.status.popup_active = 1;\r\n    dn.status.authorization = 0;\r\n    dn.show_status();    \r\n    gapi.auth.authorize(dn.auth_map(false))\r\n        .then(dn.pr_auth.resolve.bind(dn.pr_auth),\r\n              dn.pr_auth.reject.bind(dn.pr_auth));\r\n}\r\n\r\ndn.request_user_info = function(){\r\n    // returns thenable\r\n    return gapi.client.request({'path' : 'userinfo/v2/me?fields=name'})\r\n}\r\n\r\ndn.request_file_meta = function(){\r\n    // returns thenable\r\n    dn.status.file_meta = 0;\r\n    dn.show_status();\r\n    return gapi.client.request({\r\n        'path': '/drive/v3/files/' + dn.the_file.file_id,\r\n        'params':{'fields': 'name,mimeType,description,parents,capabilities,fileExtension,shared'}});\r\n}\r\n\r\ndn.request_file_body = function(){\r\n    // returns thenable\r\n    dn.status.file_body = 0;\r\n    dn.show_status();\r\n    return gapi.client.request({\r\n        'path': '/drive/v3/files/' + dn.the_file.file_id,\r\n        'params':{'alt': 'media'}});\r\n}\r\n\r\ndn.make_multipart_boundary = function(){\r\n    //for MIME protocol, require a boundary that doesn't exist in the message content.\r\n    //we could check explicitly, but this is essentially guaranteed to be fine:\r\n    // e.g. \"13860126288389.206091766245663\"\r\n    return (new Date).getTime() + \"\" + Math.random()*10;\r\n}\r\n\r\n\r\ndn.request_save = function(parts){\r\n    // this is a factory function for building a function-of-no-args-that-returns-a-thenable\r\n    // note the save process is complicated and should only be done via dn.save in save.js\r\n    var has_body = parts.body !== undefined;\r\n    var meta = {properties: {}};\r\n    var has_meta = false;\r\n    if(parts.title !== undefined){\r\n        has_meta = true;\r\n        meta['name'] = parts.title;\r\n    }\r\n    if(parts.description !== undefined){\r\n        has_meta = true;\r\n        meta['description'] = parts.description;\r\n    }\r\n    if(parts.syntax !== undefined){\r\n        has_meta = true;\r\n        meta.properties['aceMode'] = parts.syntax;\r\n    }\r\n    if(parts.newline !== undefined){\r\n        has_meta = true;\r\n        meta.properties['newline'] = parts.newline;\r\n    }\r\n    if(parts.tabs !== undefined){\r\n        has_meta = true;\r\n        meta.properties['tabs'] = parts.tabs;\r\n    }\r\n    var is_multipart = has_body && has_meta;\r\n    var params = {'fields': 'version'};\r\n    if(has_body)\r\n        params['uploadType'] = is_multipart ? 'multipart' : 'media';\r\n\r\n    var headers = {}\r\n    var boundary = dn.make_multipart_boundary();\r\n    if(is_multipart){\r\n        request_body = \"--\" + boundary\r\n                      + \"\\nContent-Type: application/json; charset=UTF-8\\n\" \r\n                      + JSON.stringify(meta) \r\n                      + \"\\n--\" + boundary\r\n                      + \"\\nContent-Type: text/plain\" // TODO: see if this matters, and if so get it right \r\n                      + parts.body\r\n                      + \"\\n--\" + boundary + \"--\" ;\r\n        headers['Content-Type'] = 'multipart/related; boundary=\"' + boundary+'\"';\r\n        // TODO: check if we need to add the content length ourselves\r\n        // Content-Length: number_of_bytes_in_entire_request_body\r\n    }else if(has_body){\r\n        request_body = parts.body;\r\n    } else {\r\n        request_body = JSON.stringify(meta);\r\n    }\r\n\r\n    return function(){\r\n        return gapi.client.request({\r\n                'path': (has_body ? '/upload' : '') + '/drive/v3/files/' + dn.the_file.file_id,\r\n                'method': 'PATCH',\r\n                'params' : params,\r\n                'headers' : headers,\r\n                'body' : request_body\r\n        });\r\n    }\r\n\r\n}\r\n\r\ndn.request_app_data_document = function(){\r\n    return new Promise(function(succ, fail){\r\n\r\n        // we want one error handler for loading, and one for subsequent errors, but the API doesn't\r\n        // distinguish between the two, so it's up to us to do so....\r\n        dn.app_data_realtime_error = function(err){\r\n            if(dn.status.realtime_settings < 1){\r\n                fail(err);\r\n            }else{\r\n                if(err.type === \"token_refresh_required\"){\r\n                    dn.pr_auth.reject(err);\r\n                } else {\r\n                    console.dir(err);\r\n                    dn.show_error(\"\" + err);\r\n                }\r\n            }\r\n        }\r\n\r\n        gapi.drive.realtime.loadAppDataDocument(succ, null, dn.app_data_realtime_error);\r\n        // the null argument is an omptional function for handling the initialization\r\n        // the first time the document is loaded;\r\n    });\r\n}\r\n\r\n\r\n//*\r\ndn.request_screw_up_auth_counter = 0;\r\ndn.request_screw_up_auth = function(){\r\n    if(++dn.request_screw_up_auth_counter < 10){\r\n        console.log(\"INVALIDATING TOKEN\")\r\n        gapi.auth.setToken(\"this_is_no_longer_valid\");\r\n    }\r\n    return true;\r\n}\r\n//*/","\"use strict\";\r\n\r\ndn.save_pending_requests = [];\r\n\r\ndn.SaveTracker = function(){\r\n    this.local = undefined;\r\n    this.remote = undefined;\r\n    return this;\r\n}\r\n\r\ndn.save_local_version_counter = 0;\r\n\r\n// this list tracks the state of the server, to the best of our knowledge,\r\n// i.e. based on all the respones we have recieved to date (we use the \r\n// server's \"version\" number to ensure we maintain the same chronology as the server).\r\ndn.save_server_state = {};\r\n\r\n// this is similar to the above but holds SaveRequest instances. Every time\r\n// we construct a new SaveRequest, we update this list.\r\ndn.save_local_state = { };\r\n\r\ndn.save = function(parts){\r\n    // this is the only method that should be called by other bits of the program\r\n\r\n    // update the status....\r\n    var keys = Object.keys(parts);\r\n    var idx = keys.indexOf('body');\r\n    if(idx >= 0){\r\n        dn.status.save_body = 0;\r\n        keys.splice(idx, 1);\r\n    }\r\n    idx = keys.indexOf('title');\r\n    if(idx >= 0){\r\n        dn.status.save_title = 0;\r\n        keys.splice(idx, 1);\r\n    }\r\n    if(keys.length > 0)\r\n        dn.status.save_other = 0;\r\n    dn.show_status();\r\n\r\n    // and construct the (complicated) request..\r\n    dn.save_pending_requests.push(new dn.SaveRequest(parts));\r\n}\r\n\r\ndn.SaveRequest = function(parts){\r\n    this._parts = parts\r\n\r\n    // update save_local_state \r\n    var displaced_requests = [];\r\n    for(var k in this._parts) if(this._parts.hasOwnProperty(k)){\r\n        if(dn.save_local_state[k] && !dn.save_local_state[k]._is_settled)\r\n            displaced_requests.push(dn.save_local_state[k]);\r\n        dn.save_local_state[k] = this;\r\n    }\r\n\r\n    // see if any of the displaced requests that are still pending, are no longer desired.\r\n    // We can't competely cancel pending requests, but we can make it known that they\r\n    // should stop trying so hard to complete.\r\n    for(var ii=0; ii< displaced_requests.length; ii++){\r\n        var desired = false; // if displaced_requests[ii] is responsible for any of save_local_state, then it is desired still \r\n        for(var k in dn.save_local_state) if(dn.save_local_state.hasOwnProperty(k))\r\n            if(dn.save_local_state[k] == displaced_requests[ii]){\r\n                desired = true;\r\n                break;\r\n            }\r\n        if(!desired)\r\n            displaced_requests[ii]._desired = false;\r\n    }\r\n\r\n\r\n    this._desired = true; // see above description and _throw_if_not_desired, to see how this is used\r\n    this._tracker = new dn.SaveTracker(); // hold local and remote version numbers\r\n    this._tracker.local = ++dn.save_local_version_counter;\r\n    this._is_settled = false;\r\n\r\n    var self = this;\r\n    this._pr = until_success(function(succ, fail){\r\n        return Promise.resolve(dn.pr_auth)\r\n                      .then(self._throw_if_not_desired.bind(self))\r\n                      .then(dn.request_save(self._parts))\r\n                      .then(self._on_completion.bind(self))\r\n                      .catch(self._on_error.bind(self))\r\n                      .then(succ, fail);\r\n    }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n    .then(self._on_finally.bind(self));\r\n    \r\n    return this;\r\n}\r\n\r\ndn.SaveRequest.prototype._throw_if_not_desired = function(){\r\n    if(!this._desired)\r\n        throw \"not desired\"; //caught by on_error, and turned into success\r\n    return true;\r\n}\r\n\r\ndn.SaveRequest.prototype._on_error = function(err){\r\n    if(dn.is_auth_error(err)) throw err; // will cause until_success to try again\r\n    return \"\" + err; //convert to success, and stop trying\r\n}\r\n\r\ndn.SaveRequest.prototype._on_completion = function(res){\r\n    this._tracker.remote = parseInt(res.result.version);\r\n    // update 0 or more entries in dn.save_server_state (see description above)\r\n    for(var k in this._parts) if(this._parts.hasOwnProperty(k)){\r\n        if(dn.save_server_state[k] === undefined)\r\n            dn.save_server_state[k] = new dn.SaveTracker();\r\n        if(dn.save_server_state[k].remote === undefined || this._tracker.remote > dn.save_server_state[k].remote){\r\n            dn.save_server_state[k].remote = this._tracker.remote;\r\n            dn.save_server_state[k].local = this._tracker.local;\r\n        }\r\n    }  \r\n    return true;    \r\n}\r\n\r\ndn.SaveRequest.prototype._on_finally = function(){\r\n    // called when the until_success deems that success has occured\r\n    // but that means the request was a legitimate failure, or canaceled,\r\n    // though at this point we don't care what happened exactly.\r\n\r\n    // remove from the list of pending requests\r\n    this._is_settled = true;\r\n    dn.save_pending_requests.splice(dn.save_pending_requests.indexOf(this), 1);\r\n\r\n    // if other requests are still pending, let them clean up any mess when they're done..\r\n    if(dn.save_pending_requests.length > 0)\r\n        return;\r\n\r\n    // dn.save_local_state holds the state we want the server to have, and \r\n    // dn.save_server_state holds the state the server ended up with \r\n    // (and remember there are no pending requests), so lets build a list\r\n    // of corrections to make to the server\r\n    var correction = {};\r\n    var correction_need = false;\r\n    for(var k in dn.save_local_state) if(dn.save_local_state.hasOwnProperty(k))\r\n        if(dn.save_server_state[k].local != dn.save_local_state[k]._tracker.local){\r\n            correction[k] = dn.save_local_state[k]._parts[k];\r\n            correction_need = true;\r\n        }\r\n\r\n    // and now we can make the request, if we need to..\r\n    dn.status.save_body = 1; // TODO: we could have set these to 1 at an earlier point\r\n    dn.status.save_title = 1;\r\n    dn.status.save_other = 1;\r\n    if (correction_need)\r\n        dn.save(correction); // this will set some of the status's to 0 and call show_status\r\n    else\r\n        dn.show_status();\r\n\r\n}\r\n\r\n\r\n\r\n\r\n","\"use strict\";\r\n\r\ndn.close_history = function(){\r\n    dn.file_history.$revisions_display.remove();\r\n    window.removeEventListener(\"resize\", dn.revisions_window_resize);\r\n    document.getElementById('the_editor').style.display = '';\r\n    dn.editor.resize();\r\n    dn.is_showing_history = false;\r\n}\r\ndn.revisions_window_resize = function(){\r\n    if(dn.file_history.canShowResizeError){\r\n        dn.show_error(\"The history explorer displays poorly if you resize the window while it is open. (This is a bug.)\");\r\n        dn.file_history.canShowResizeError = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n        setTimeout(function(){dn.file_history.canShowResizeError = true;},dn.error_delay_ms);\r\n    }    \r\n}\r\n\r\ndn.start_revisions_worker = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.show_error(\"This is a new file.  It doesn't have any history to explore.\")\r\n        return;\r\n    }\r\n    dn.is_showing_history = true;\r\n    \r\n    if(!dn.file_history){\r\n        dn.el.widget_content.innerHTML('afterend', \r\n            \"<div class='widget_box widget_revisions'>\" + \r\n            \"<div class='widget_box_title widget_revisions_title'>File History</div>\" +\r\n            \"<div class='revision_caption_at'></div>\" +\r\n            \"<div class='revision_timeline'></div>\" +\r\n            \"<div class='revision_caption_from'></div>\" +\r\n            \"<div>Removed lines: <div class='button inline_button ' id='expand_removed'>expand</div>\" + \r\n                    \"<div class='button inline_button ' id='collapse_removed'>collapse</div></div>\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"<div id='revisions_status'>Initialising...</div>\" + \r\n            \"Press Esc to return to editing.\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"Please note that the history viewing tool is missing some important features and those that have been implemented may include the odd bug.</div>\");\r\n        dn.el.widget_file_history = dn.el.widget_content.parentNode.getElementsByClassName('widget_revisions')[0];\r\n        dn.el.widget_file_history.style.display = 'none';\r\n        dn.file_history = {\r\n            $revisions_display: $(\"<div class='revisions_view'><ol></ol></div>\"),\r\n            $view: null, \r\n            $new_li: $(\"<li class='rev_line' v='-1'/>\"),\r\n            $new_tick:  $(\"<div class='revision_tick'/>\"),\r\n            needToRefindViewChildren: false, //this flag tracks when the $rev_lines_ is out of date relative to children of $view\r\n            $rev_lines_: [], // this is a single jQuery collection\r\n            needToFixHeights: $([]),            \r\n            $timeline: $d.find('.revision_timeline'),\r\n            $revisions_status: $d.find('#revisions_status'),\r\n            $revision_caption_from: $d.find('.revision_caption_from'),\r\n            $revision_caption_at: $d.find('.revision_caption_at'),\r\n            $expand_removed: $d.find('#expand_removed'),\r\n            $collapse_removed: $d.find('#collapse_removed'),\r\n            revisions: [], //array of objects with etag, isDownloaded, modifiedDate, $tick\r\n            revisionFromEtag: {},\r\n            at: null, //revision object\r\n            from: null, //revision object,\r\n            canShowResizeError: true, //used by Revisions_WindowResize\r\n            worker: new Worker(\"js/revisions_worker.js\")\r\n        };\r\n    \r\n        dn.file_history.$view = dn.file_history.$revisions_display.find('ol'); \r\n        dn.file_history.$expand_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',true)});\r\n        dn.file_history.$collapse_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',false)});\r\n        dn.revision_setis_expaned(dn.g_settings.get('historyRemovedIsExpanded'))\r\n\r\n        var w = dn.file_history.worker;\r\n        w.onmessage = dn.revision_worker_delivery;\r\n    }\r\n    dn.file_history.worker.postMessage({ fileId: dn.the_file.file_id, \r\n                                        token: gapi.auth.getToken().access_token,\r\n                                        init: true});\r\n    dn.file_history.$revisions_display.appendTo($('body'));\r\n    $(window).on(\"resize\",dn.revisions_window_resize);\r\n    dn.el.widget_file_history.style.display = '';\r\n    dn.file_history.$view.empty();\r\n    $('#the_editor').style.display = 'none';\r\n    return false;\r\n}\r\n\r\ndn.revision_setis_expaned = function(v){\r\n    var h = dn.file_history;\r\n    if(!h) return; //if we haven't yet initialised fileHistory stuff then ignore this for now, when we do initialise we will read and apply the g_settings value\r\n    \r\n    if(v){\r\n        h.$expand_removed.classList.add('selected')\r\n        h.$collapse_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"expanded\");\r\n    }else{\r\n        h.$collapse_removed.classList.add('selected')\r\n        h.$expand_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"collapsed\")\r\n    }\r\n}\r\ndn.revision_set_at = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.at = r;\r\n    if(!fromChangeEvent)\r\n        h.$at_range.value = r.ind;    \r\n    text_multi(h.$revision_caption_at,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.from && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                      fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.revision_set_from = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.from = r;\r\n    if(!fromChangeEvent)\r\n        h.$from_range.value = r.ind;\r\n    text_multi(h.$revision_caption_from,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.at && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                          fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.display_revision_timeline = function(newRevisions){\r\n    var h = dn.file_history;\r\n    var rs = h.revisions;\r\n    //TODO: update display based on newRevisions rather than starting from scratch\r\n    \r\n    h.$at_range = $(\"<input class='revision_at_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    h.$tick_box = $(\"<div class='revision_tick_box'/>\");\r\n    h.$from_range = $(\"<input class='revision_from_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    \r\n        \r\n    var attr = rs.map(function(t){ return { downloaded: t.isDownloaded || false }; });\r\n    var text = Array.apply(null, Array(attr.length)).map(function () { return \"\" });\r\n    var $ticks = h.$tick_box.insertClonedChildren(0,h.$new_tick,text,attr);\r\n    \r\n    for(var i=0;i<rs.length;i++){\r\n        rs[i].ind = i;\r\n        rs[i].$ = $ticks.eq(i);\r\n    }\r\n    \r\n    h.$timeline.empty().append(h.$at_range).append(h.$tick_box).append(h.$from_range);\r\n\r\n    h.$at_range.on(\"change\",function(){\r\n            dn.revision_set_at(dn.file_history.revisions[this.value],true);\r\n        })\r\n    h.$from_range.on(\"change\",function(){\r\n            dn.revision_set_from(dn.file_history.revisions[this.value],true);\r\n        })\r\n\r\n    dn.revision_set_from(rs.length > 1 ? rs[1] : rs[0],false,true);\r\n    dn.revision_set_at(rs[0],false,true);\r\n}\r\n\r\ndn.revision_worker_delivery = function(e){\r\n    if(!e.data)\r\n        return; //not sure if this is possible\r\n\r\n    if(e.data.debug)\r\n        console.log(e.data);\r\n        \r\n    var h = dn.file_history;\r\n    //TODO: probably ought to use a more sensivle message system with a string command switching thign...but this is ok for now\r\n    \r\n    if(e.data.status)\r\n        text_multi(h.$revisions_status, e.data.status);\r\n        \r\n    if(e.data.revisions){    \r\n        h.revisions = e.data.revisions;\r\n        e.data.revisions.forEach(function(r){ h.revisionFromEtag[r.etag] = r;});\r\n        dn.display_revision_timeline(e.data.revisions);\r\n        h.worker.postMessage({ showEtag: h.at.etag,\r\n                               fromEtag: h.from.etag }); \r\n    }\r\n    \r\n    if(e.data.revisionDownloaded){\r\n        var r = h.revisionFromEtag[e.data.revisionDownloaded];\r\n        r.$.attr('downloaded',true);\r\n        r.isDownloaded = true;\r\n    }\r\n    \r\n    if(e.data.revsionDiffed){\r\n        h.needToRefindViewChildren = true;\r\n        var r = h.revisionFromEtag[e.data.revsionDiffed];\r\n        r.$.attr('diffed',true);\r\n        r.isDiffed = true;\r\n        \r\n        var newStuff = e.data.newStuffForDom;\r\n        for(var i=0;i<newStuff.length;i++){\r\n            var lines = newStuff[i].lines.map(function(str){return str || \" \"});  \r\n                                            // \"|| space\" thing is a hack for auto height stuff\r\n            h.needToFixHeights = h.needToFixHeights.add(\r\n                            h.$view.insertClonedChildren(newStuff[i].at,h.$new_li,lines)    );            \r\n        }\r\n    }\r\n\r\n    \r\n    if(e.data.vals_ui8buffer){\r\n        \r\n        if(h.needToRefindViewChildren){\r\n            h.$rev_lines_ = h.$view.children();\r\n            h.needToRefindViewChildren = false;\r\n        }\r\n        var $rl_ = h.$rev_lines_;\r\n        \r\n        if(h.needToFixHeights.length){\r\n            text_multi(h.$revisions_status, \"Obtaining line height data...\");\r\n            h.needToFixHeights.fixHeightFromAuto();\r\n            h.needToFixHeights = $([]);\r\n            text_multi(h.$revisions_status, \"Selecting lines...\");\r\n        }\r\n        \r\n        var vals = new Uint8Array(e.data.vals_ui8buffer)\r\n        $rl_.setAttribute('v',function(i){return vals[i]});\r\n            \r\n        // We have to manually set the width of the numbers (our version of ace's gutter)\r\n        switch(e.data.digits){\r\n            case 0:\r\n            case 1:\r\n            case 2:\r\n                h.$view.setAttribute('digits','');\r\n                break;\r\n            case 3:\r\n                h.$view.setAttribute('digits','###');\r\n                break;\r\n            case 4:\r\n                h.$view.setAttribute('digits','####');\r\n                break;\r\n            default:\r\n                h.$view.setAttribute('digits','#####');\r\n        }\r\n    }\r\n    \r\n        \r\n}\r\n","\"use strict\";\r\n\r\n/*\r\nThe find focus/blur problem.  This took some thinking to sort out!!!\r\n\r\nIn the end it is now relatively neat and simple to get your head around.\r\n\r\ndn.g_settings.set('pane', 'pane_find') and dn.g_settings.set('pane_open', true)\r\ndo not mess with the focus themselves. Any code that uses that must explicitly\r\ndecide whether or not it wants to focus on the input for search/goto (a choice\r\nwhich is made based on the flag dn.g_settings.get('find_goto')).\r\n\r\nCalling  dn.g_settings.set('find_goto', bool), also does not mess with the focus, it\r\njust renders the inactive version of goto/search.\r\n\r\nWe basically have the same setup for goto and for search, with goto having a less\r\nmeaty implementation, so it's easier to start by looking at that.\r\n\r\nWhen the input gets the focus, the goto/search operation is performed, when the\r\ninput is blurred it sets the info text to \"inactive\".  If the blur events is moving the\r\nfocus to null, then at the end of the blur event we redirect the focus to the editor.\r\n\r\nIn keyboard.js there are special functions for producing exactly the right\r\nfocus behaviour when pressing Esc (with focus on the editor) and pressing \r\nCtrl-F/Crtl-L.  \r\n============================\r\n\r\nEvetunally we may have to deal with the realtime document changes.\r\n\r\n*/\r\n\r\ndn.find_goto_changed = function(new_value){\r\n    // This just toggles the display, it does not deal with focus/blur, which may happen afterwards\r\n    // as a consequence if the relevant inputs previously had the focus.\r\n\r\n    if(new_value){\r\n        dn.el.find_goto_wrapper.style.display = '';\r\n        dn.el.find_find_wrapper.style.display = 'none';\r\n        dn.el.button_goto.classList.add('selected');\r\n        dn.el.find_info.textContent = 'goto line inactive';\r\n        dn.el.find_replace_wrapper.style.display = 'none';\r\n    }else{\r\n        dn.el.find_goto_wrapper.style.display = 'none';\r\n        dn.el.find_find_wrapper.style.display = '';\r\n        dn.el.button_goto.classList.remove('selected');\r\n        dn.el.find_info.textContent = 'search inactive';\r\n        if (dn.g_settings.get('find_replace'))\r\n            dn.el.find_replace_wrapper.style.display = '';\r\n    }\r\n}\r\n\r\ndn.find_replace_changed = function(new_value){\r\n    if(new_value){\r\n        dn.el.button_replace.classList.add('selected');\r\n        if(!dn.g_settings.get('find_goto'))\r\n            dn.el.find_replace_wrapper.style.display = '';\r\n    }else{\r\n        dn.el.find_replace_wrapper.style.display = 'none';\r\n        dn.el.button_replace.classList.remove('selected');\r\n    }\r\n    if(dn.find_inputs_have_focus)\r\n        dn.find_select_result_idx(dn.find_current_match_idx);\r\n}\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// goto :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// the implementation of goto is simpler than for search, so we start with it...\r\n\r\ndn.find_goto_input_has_focus = false; // we don't actually need this, but we keep it for analogy with search\r\n\r\ndn.find_goto_input_focus = function(){\r\n    dn.find_goto_input_has_focus = true;\r\n    dn.el.find_info.textContent = \"type to goto line\";\r\n    dn.find_perform_goto();\r\n}\r\n\r\ndn.find_goto_input_blur = function(e){\r\n    dn.find_goto_input_has_focus = false;\r\n    dn.el.find_info.textContent = \"goto line inactive\"; \r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\ndn.find_perform_goto = function(){\r\n    // called by find_goto_input_focus and find_goto_keyup\r\n    var validated_str = dn.el.find_goto_input.value.replace(/[^\\d]/,'');\r\n    if (validated_str !== dn.el.find_goto_input.value)\r\n        dn.el.find_goto_input.value = validated_str;\r\n    if(validated_str === \"\")\r\n        return;\r\n    var num = parseInt(validated_str);\r\n    dn.editor.gotoLine(num);\r\n    dn.editor.navigateLineEnd();\r\n}\r\n\r\ndn.find_goto_input_keyup = dn.find_perform_goto; //alias\r\n\r\ndn.find_goto_input_keydown = function(e){\r\n    // keydown is fired repeatedly when key remains down\r\n    if(e.which == WHICH.DOWN){\r\n        dn.el.find_goto_input.value = parseInt(dn.el.find_goto_input.value.replace(/[^\\d]/,''))+1;\r\n        dn.find_perform_goto();\r\n        e.preventDefault();\r\n    }else if(e.which == WHICH.UP){\r\n        dn.el.find_goto_input.value = parseInt(dn.el.find_goto_input.value.replace(/[^\\d]/,''))-1;\r\n        dn.find_perform_goto();\r\n        e.preventDefault();\r\n    } else if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false);\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    }\r\n}\r\n\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// search :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n\r\ndn.find_inputs_have_focus = false; // either find itself or replace\r\ndn.find_results = [];\r\ndn.find_current_match_idx = -1;\r\ndn.find_markers = [];\r\ndn.find_marker_current = undefined;\r\ndn.find_str = \"\";\r\n\r\ndn.find_inputs_focus = function(e){\r\n    if(e.currentTarget == dn.el.find_input){\r\n        dn.el.find_input.tabIndex = 101;\r\n        dn.el.find_replace_input.tabIndex = 102;   \r\n    } else {\r\n        dn.el.find_input.tabIndex = 102;\r\n        dn.el.find_replace_input.tabIndex = 101;   \r\n    }\r\n    if(dn.find_inputs_have_focus)\r\n        return; // focus was transfered between replace/find inputs\r\n\r\n    dn.find_inputs_have_focus = true;\r\n    dn.AceSearch = dn.AceSearch || ace.require(\"./search\").Search;\r\n    dn.AceRange = dn.AceRange || ace.require(\"./range\").Range;\r\n    dn.editor.setHighlightSelectedWord(false);  \r\n    dn.find_perform_search();\r\n}\r\n\r\ndn.find_inputs_blur = function(e){\r\n    if(e.relatedTarget == dn.el.find_replace_input  || e.relatedTarget == dn.el.find_input)\r\n        return; // focus is transfering between replace/find inputs\r\n\r\n    dn.find_inputs_have_focus = false;\r\n\r\n    // remove all markers\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    // reset widget display\r\n    dn.el.find_info.textContent = \"search inactive\";\r\n    dn.el.find_results.innerHTML = \"\";\r\n    dn.el.find_info_overflow.textContent = \"\";\r\n\r\n    // forget last search\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n\r\n    // forget last selection in input (in preparation for next time it gets focus)\r\n    dn.el.find_input.setSelectionRange(dn.el.find_input.selectionEnd, dn.el.find_input.selectionEnd);\r\n\r\n     // we had this on false during find\r\n    dn.editor.setHighlightSelectedWord(true);\r\n\r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\ndn.find_build_options = function(){\r\n    var str = dn.el.find_input.value;\r\n    var use_reg_exp = dn.g_settings.get('find_regex');\r\n    var sensitive = dn.g_settings.get('find_case_sensitive');\r\n    if(use_reg_exp){\r\n        var re = undefined;\r\n        re = new RegExp(str, sensitive ? \"g\" : \"gi\"); //cam throw error\r\n    }\r\n    return {\r\n    needle: use_reg_exp ? re : str,\r\n    wrap: true,\r\n    caseSensitive: sensitive,\r\n    wholeWord: dn.g_settings.get('find_whole_words'),\r\n    regExp: use_reg_exp };\r\n}\r\n\r\ndn.find_perform_search = function(){\r\n    // called by find_input_focus, find_settings_changed, and on keyup in the input, when text has changed\r\n\r\n    // clear previous find (but leave selection for now)\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if(dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current)\r\n        dn.find_marker_current = undefined;\r\n    }\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n    dn.el.find_results.innerHTML = \"\";  \r\n    dn.el.find_info_overflow.textContent = \"\";\r\n    dn.el.find_info.textContent = \"\";\r\n    dn.find_str = dn.el.find_input.value; // we only store it to make it easier for key_down to check for true changes\r\n\r\n    var search_options = undefined;\r\n    try{\r\n        search_options = dn.find_build_options();\r\n    } catch (e){\r\n        dn.el.find_info.textContent = escape_str(e.message); //TODO: could force first letter to lower case\r\n    }\r\n\r\n    if(search_options === undefined){\r\n        // failed regex, don't show any results\r\n        dn.editor.selection.clearSelection();\r\n\r\n    } else if(dn.find_str == \"\"){\r\n        // empty string (including empty regex), dont show any results\r\n        dn.el.find_info.textContent = \"type to search. \" /*+ dn.ctrl_key + \"-up/down for history.\"*/;\r\n        dn.editor.selection.clearSelection();\r\n        \r\n    } else {\r\n        // valid regex or pure str search..\r\n\r\n        // This is the actual search\r\n        var search = new dn.AceSearch();\r\n        search.setOptions(search_options);\r\n        var results = dn.find_results = search.findAll(session);\r\n\r\n        if(results.length === 0){\r\n            // No results to display, life is easy...\r\n            dn.el.find_info.textContent = \"no matches found.\";\r\n            dn.el.find_info_overflow.textContent = \"\";\r\n            dn.editor.selection.clearSelection();\r\n\r\n        }else{\r\n            // Right, we got some results ....\r\n\r\n            // Work out which result we should consider the current match.\r\n            var selected_range = session.getSelection().getRange();\r\n            for(var ii=0; ii<results.length; ii++) \r\n                if(results[ii].end.row > selected_range.start.row  || \r\n                    (results[ii].end.row == selected_range.start.row &&\r\n                     results[ii].end.column >= selected_range.start.column))\r\n                break;\r\n            var current_match_idx = (ii == results.length ? results.length-1 : ii);\r\n\r\n            // Add markers into the editor to show *all* the results\r\n            for(var ii=0; ii<results.length; ii++)\r\n                dn.find_markers.push(session.addMarker(results[ii], \"find_match_marker\", \"find_match_marker\", false));\r\n\r\n            // augment the results with their idx, this is useful for the subselection stuff\r\n            for(var ii=0; ii<results.length; ii++)\r\n                results[ii] = {range: results[ii], idx: ii};\r\n\r\n            // Render a subset of the results into the widget and mark & select the current match\r\n            dn.find_select_result_idx(current_match_idx);\r\n        }\r\n    }\r\n\r\n}\r\n\r\ndn.find_select_result_idx = function(current_match_idx){\r\n    // This is called within find_perform_search when a new search returns some results\r\n    // it's also called when we move through the results without changing the search and\r\n    // when replace_changed is called when find input already has the focus.   */\r\n\r\n    // Get a small sub set of results to show in the widget.\r\n    // We carefully implement some wrapping logic, which is a bit fiddly.\r\n    dn.find_current_match_idx = current_match_idx;\r\n\r\n    var session = dn.editor.getSession();\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    var results = dn.find_results;\r\n    var results_sub = [];\r\n    \r\n    var replace_is_showing = dn.g_settings.get('find_replace');\r\n\r\n    var max_results = dn.find_max_results_half*2 + (replace_is_showing ? 0 : 1);\r\n\r\n    if(results.length <= max_results){\r\n        results_sub = results;\r\n    }else{\r\n        var n_pre = dn.find_max_results_half - (replace_is_showing ? 1 : 0);\r\n        var n_post = dn.find_max_results_half;\r\n        if(current_match_idx < n_pre){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n_pre));\r\n            results_sub = results_sub.concat(results.slice(0, current_match_idx));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n_pre, current_match_idx));\r\n        }\r\n        results_sub.push(results[current_match_idx]); \r\n        if(current_match_idx + n_post >= results.length){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1));\r\n            results_sub = results_sub.concat(results.slice(0, n_post + 1 - (results.length - current_match_idx)));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1, current_match_idx + n_post + 1));\r\n        }\r\n    }\r\n\r\n    // Now lets build the html to show the subset of results in the widget\r\n    var show_replace_buttons = dn.g_settings.get('find_replace');\r\n    var html = \"\";\r\n    for(var ii=0; ii<results_sub.length; ii++){\r\n        var row = results_sub[ii].range.start.row;\r\n        var col = results_sub[ii].range.start.column;\r\n        var prefix_range = new dn.AceRange(row, Math.max(0, col-dn.find_max_prefix_chars), row, col);\r\n        var pre_ellipses = col > dn.find_max_prefix_chars; //TODO: deal with indent better\r\n        row = results_sub[ii].range.end.row;\r\n        col = results_sub[ii].range.end.column;\r\n        var suffix_range = new dn.AceRange(row, col, row, col+dn.find_max_suffix_chars);\r\n        html += \"<div class='find_result_item\" + (results_sub[ii].idx==current_match_idx? \" find_result_current\" : \"\") + \"'>\" +\r\n                    \"<div class='find_result_line_num'>\" + (row+1) + \"</div>\" +\r\n                    \"<div class='find_result_text'>\" +\r\n                        \"<div class='find_result_text_inner'>\" +\r\n                            (pre_ellipses ? \"&#8230;\" : \"\") + escape_str(session.getTextRange(prefix_range)) +\r\n                            \"<span class='find_result_match'>\" + escape_str(session.getTextRange(results_sub[ii].range)) + \"</span>\" +\r\n                            escape_str(session.getTextRange(suffix_range)) +\r\n                        \"</div>\" +\r\n                    \"</div>\" +\r\n                    (show_replace_buttons ? \"<div class='button inline_button replace_single_result' title='replace'>r</div>\" : \"\") + \r\n                \"</div>\";\r\n    }\r\n    dn.el.find_results.innerHTML = html;\r\n    var els = dn.el.find_results.getElementsByClassName('find_result_item');\r\n    for(var ii=0; ii<els.length; ii++) if(results_sub[ii].idx !== current_match_idx)\r\n        els[ii].addEventListener('click', dn.find_result_click(results_sub[ii].idx));\r\n    if(show_replace_buttons){\r\n        var els = dn.el.find_results.getElementsByClassName('replace_single_result')\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].addEventListener('click', dn.find_replace_result_click(results_sub[ii].idx));\r\n    }\r\n\r\n    if(results.length > max_results)\r\n        dn.el.find_info_overflow.textContent = \"... and \" + (results.length - max_results) + \" more matches\";\r\n    else\r\n        dn.el.find_info_overflow.textContent = \"\";\r\n\r\n    // do the special marker for the current selection and actually select it\r\n    dn.find_marker_current = session.addMarker(results[current_match_idx].range, \"find_current_match_marker\", \"find_current_match_marker\", false);\r\n    dn.editor.selection.setSelectionRange(results[current_match_idx].range, false);\r\n    dn.editor.renderer.scrollSelectionIntoView();\r\n}\r\n\r\ndn.find_settings_changed = function(){\r\n    if(dn.find_inputs_have_focus || \r\n       (dn.g_settings.get('pane') === 'pane_find' && dn.g_settings.get('pane_open') &&  dn.el.find_input.value))\r\n        dn.find_perform_search();\r\n}\r\n\r\ndn.find_result_click = function(ii){\r\n    // this can only be called while find input has the focus\r\n    return function(e){dn.find_select_result_idx(ii);};\r\n}\r\n\r\ndn.find_replace_result_click = function(ii){\r\n    return function(e){\r\n        dn.find_replace_result_idx(ii);\r\n        e.stopPropagation(); // prevent selecting item\r\n    }\r\n}\r\n\r\ndn.find_input_keyup = function(e){ \r\n    //we need keyup here in order that the val has the new character or new backspace\r\n    if(e.which == WHICH.ENTER || e.which == WHICH.ESC || e.which == WHICH.UP || e.which == WHICH.DOWN)\r\n        return; \r\n    if(dn.find_str == dn.el.find_input.value)\r\n        return;\r\n    dn.find_perform_search()\r\n}\r\n\r\ndn.find_input_keydown = function(e){ \r\n    // we want keydown here so that we can get repeated firing with keydown (i think on most browsers)\r\n\r\n    if ((e.which == WHICH.ENTER && !e.shiftKey) || (!e.ctrlKey && e.which == WHICH.DOWN)){\r\n        //find next\r\n        dn.find_select_result_idx(dn.find_current_match_idx + 1 < dn.find_results.length ? \r\n                                    dn.find_current_match_idx + 1 \r\n                                  : 0);\r\n        e.preventDefault();\r\n        return;\r\n    }else if((e.which == WHICH.ENTER && e.shiftKey) || (!e.ctrlKey && e.which == WHICH.UP)){\r\n        //find previous\r\n        dn.find_select_result_idx(dn.find_current_match_idx - 1 < 0 ? \r\n                                    dn.find_results.length -1 \r\n                                  : dn.find_current_match_idx - 1);\r\n        e.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false); // this focuses on the editor, and blurs the find_input\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        return;   \r\n    }\r\n\r\n}\r\n\r\ndn.find_replace_input_keydown = function(e){\r\n    if(e.which == WHICH.ENTER){\r\n        if(e.ctrlKey || e.shiftKey)\r\n            dn.find_replace_all();\r\n        else\r\n            dn.find_replace_result_idx(dn.find_current_match_idx);\r\n        e.preventDefault();\r\n    }else{\r\n        dn.find_input_keydown(e); // up, down results and esc\r\n    }\r\n}\r\n\r\ndn.find_replace_all = function(e){\r\n    try{\r\n        var options = dn.find_build_options();\r\n    } catch (e) {\r\n        dn.show_error(e.message);\r\n        return;\r\n    }\r\n    dn.editor.replaceAll(dn.el.find_replace_input.value, options);\r\n    dn.focus_editor();\r\n}\r\n\r\ndn.find_replace_click = dn.find_replace_all; //alias\r\n\r\ndn.find_replace_result_idx = function(idx){\r\n    var range = dn.find_results[idx].range;\r\n    // we use undocumented ACE API to avoid messing around tryinng to force it to use the exact range we wanted\r\n    dn.editor.$search.set(dn.find_build_options()); //this is needed so that $tryReplace knows what to do with regex'es\r\n    dn.editor.$tryReplace(range, dn.el.find_replace_input.value) // returns true on success, but do we care?\r\n    dn.find_perform_search();\r\n}","\"use strict\";\r\n\r\ndn.do_print = function(){\r\n    var content = dn.editor.session.doc.getAllLines();\r\n    var html = Array(content.length);\r\n\r\n    for(var i=0; i<content.length;i++)\r\n        html[i] = \"<li><div class='printline'>\" + dn.line_to_html(i) + '</div></li>';\r\n\r\n    var printWindow = window.open('','');\r\n    printWindow.document.writeln(\r\n            \"<html><head><title>\" + dn.the_file.title \r\n            + \"</title></head><style>\"\r\n            + ace.require('ace/theme/' + dn.g_settings.get('theme')).cssText + \"\\nbody{font-size:\"\r\n            + dn.g_settings.get('fontSize') *14 +\"px; white-space:pre-wrap;\" + \r\n            \"font-family:'Monaco','Menlo','Ubuntu Mono','Droid Sans Mono','Consolas',monospace;}\"\r\n            + \"\\nli{color:gray;}\\n.printline{color:black;}</style>\" + \r\n            \"<body class='ace-\"+ dn.g_settings.get('theme').replace('_','-') +\"'><ol id='content'>\" + \r\n            html.join(\"\") +\r\n            \"</ol></body></html>\");\r\n    printWindow.print();\r\n    return false;\r\n}\r\n\r\ndn.line_to_html = function (n){\r\n    var printLayer = Object.create(ace.require('ace/layer/text').Text.prototype); \r\n    var tokens  = dn.editor.getSession().getTokens(n);\r\n    var html = [];\r\n    var screenColumn = 0;\r\n    for (var i = 0; i < tokens.length; i++) {\r\n       var token = tokens[i];\r\n       var value = token.value.replace(/\\t/g,'   ');//TODO:deal with tabs properly\r\n       if(value)\r\n           printLayer.$renderToken(html, 0, token, value);\r\n    }\r\n    return html.join('').replace(/&#160;/g,' ');\r\n}","\"use strict\";\r\n\r\ndn.platform = (function(){\r\n    if(navigator.platform.indexOf(\"Win\") >-1)\r\n        return \"Windows\";\r\n    else if(navigator.platform.indexOf(\"Linux\") >-1)\r\n        return \"Linux\";\r\n    else if(navigator.platform.indexOf(\"Mac\")>-1)\r\n        return \"Mac\";\r\n        \r\n    return null;\r\n})();\r\n\r\ndn.create_pane_shortcuts = function(){\r\n//This is hardly the world's most efficient way of doing this....(but it probably doesn't matter)...\r\n\r\n    var arry = dn.shortcuts_list;\r\n    var dict = {};\r\n    var platform = dn.platform;\r\n\r\n    if(platform == \"Windows\" || platform == \"Linux\"){\r\n       for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts[1];\r\n        }\r\n    }else if(platform == \"Mac\"){\r\n        for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts.length > 2? parts[2] : parts[1];\r\n        }\r\n    }else{\r\n        //TODO: show something here, maybe let user switch, maybe have touch info for ipad & android.\r\n    }\r\n    \r\n    var html = [];\r\n    for(var action in dict)\r\n        html.push(\"<div class='shortcut_item'><div class='shortcut_action'>\" + \r\n                   action + \"</div><div class='shortcut_key'>\" + dict[action].replace(\",\",\"<br>\") +\r\n                   \"</div></div>\");\r\n    for(var action in dn.tooltip_info)if(action in dict)\r\n        dn.tooltip_info[action] += dict[action];\r\n\r\n    dn.el.pane_help_shortcuts.innerHTML =  [\r\n        \"<div class='widget_box_title shortcuts_title'>Keyboard Shortcuts \",\r\n             platform ? \"(\" + platform + \")\" : \"\" ,\r\n        \"</div>\",\r\n        \"<div class='shortcuts_header_action'>action</div><div class='shortcuts_header_key'>key</div>\",\r\n        \"<div class='shortcuts_list'>\",\r\n        html.join(''),\r\n        \"</div>\"].join('');\r\n\r\n};\r\n\r\ndn.esc_pressed = function(e){\r\n    dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n\r\n    if(dn.g_settings.get('pane_open') && dn.g_settings.get('pane') == 'pane_find')\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_shortcut_used = function(e){\r\n    var sel = dn.editor.session.getTextRange(dn.editor.getSelectionRange());\r\n    dn.g_settings.set('find_goto', false);\r\n    dn.g_settings.set('pane', 'pane_find');\r\n    dn.g_settings.set('pane_open', true);\r\n    if(sel){\r\n        dn.el.find_input.value = sel;\r\n        dn.el.find_input.select();\r\n    }\r\n    dn.el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_goto_shortcut_used = function(e){\r\n    dn.g_settings.set('find_goto', true);\r\n    dn.g_settings.set('pane', 'pane_find'); // doing this after the find_active=true, tells the change handler not to put focus back to editor\r\n    dn.g_settings.set('pane_open', true);\r\n    dn.el.find_goto_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.show_replace_shortcut_used = function(e){\r\n    dn.g_settings.set('find_replace', true);\r\n    dn.find_shortcut_used(e);   \r\n}\r\n\r\ndn.make_keyboard_shortcuts = function(){\r\n    //perviously was using ace for handling these shorcuts because it neater (and efficient?) but it was\r\n    //annoying trying to ensure the editor always had focus, and not clear what to do when the editor wasn't showing.\r\n    \r\n    //we have to delete the default ace commands linked to the keys we care about\r\n    dn.editor.commands.removeCommands([\r\n        \"find\",\"findprevious\",\"findnext\",\"replace\",\"jumptomatching\",\"sortlines\",\"selecttomatching\",\"gotoline\"]);\r\n\r\n    //then add new commands on to the document using keymaster.js...\r\n    key('command+s, ctrl+s,  ctrl+alt+s,  command+alt+s', dn.do_save);\r\n    key('command+p, ctrl+p,  ctrl+alt+p,  command+alt+p', dn.do_print);\r\n    key('command+o, ctrl+o,  ctrl+alt+o,  command+alt+o', dn.do_open);\r\n    key('command+n, ctrl+n,  ctrl+alt+n,  command+alt+n', dn.do_new);\r\n    key('command+l, ctrl+l,  ctrl+alt+l,  command+alt+l', dn.find_goto_shortcut_used);\r\n    key('command+f, ctrl+f,  ctrl+alt+f,  command+alt+f', dn.find_shortcut_used); \r\n    key('command+r, ctrl+r,  ctrl+alt+r,  command+alt+r' + \r\n       ', command+g, ctrl+g,  ctrl+alt+g,  command+alt+g', dn.show_replace_shortcut_used);\r\n    key('command+h, ctrl+h,  ctrl+alt+h,  command+alt+h', dn.start_revisions_worker);\r\n    key('esc', dn.esc_pressed);\r\n    key.filter = function(){return 1;}\r\n\r\n    // it seems like the clipboard history cycling only works the old way, i.e. using ace....\r\n    var HashHandler = require(\"ace/keyboard/hash_handler\").HashHandler\r\n    var extraKeyEvents = new HashHandler([\r\n        {bindKey: {win: \"Ctrl-Left\",mac: \"Command-Left\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Down\",mac: \"Command-Down\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Right\",mac:\"Command-Right\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right},\r\n        {bindKey: {win: \"Ctrl-Up\",mac:\"Command-Up\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right}\r\n    ]);\r\n    dn.editor.keyBinding.addKeyboardHandler(extraKeyEvents);\r\n\r\n    // Change \"ctrl\" to \"cmd\" if on Mac\r\n    dn.ctrl_key = \"crtl\"\r\n    if(dn.platform == 'Mac'){\r\n        dn.ctrl_key = 'cmd';\r\n        var els = dn.getElementsByClassName('ctrl_key');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].textContent = 'cmd'\r\n    }\r\n}\r\n","\"use strict\";\r\n// DRIVE NOTEPAD 2016\r\n// by DM\r\n\r\ndn.version_str = '2016a';\r\n\r\n// ############################\r\n// Constants and defaults, see alsp info.js\r\n// ############################\r\n\r\ndn.can_show_drag_drop_error = true;\r\ndn.is_showing_history = false;\r\n\r\ndn.status = {\r\n    // 0: get action in progress\r\n    // -1: failed\r\n    //  1: success\r\n    file_body: 0, //for getting, not saving\r\n    file_meta: 0, //for getting, not saving\r\n    file_sharing: 0, // after launching the sharing dialog this is set to -1\r\n    authentication: 0,\r\n    popup_active: 0, // 0 or 1, i.e. true or false\r\n    local_settings: 0,\r\n    realtime_settings: 0,\r\n\r\n    // 1: success/no save active, \r\n    // 0: in progress\r\n    // -1: failure, and abandonded further attempts (never used)\r\n    save_body: 1, \r\n    save_title: 1,\r\n    save_other: 1\r\n}\r\n\r\ndn.the_file = {\r\n    file_id: null,\r\n    folder_id: null,\r\n    title: null,\r\n    description: '',\r\n    ext: '',\r\n    loaded_mime_type: '',\r\n    new_line_detected: 'none', //'windows', 'unix','mixed', or 'none'\r\n    tab_detected: {val: 'none'},\r\n    is_pristine: true, //true while the document has no unsaved changes (set to true when we request the save not when we get confirmation, but if there is a save error it will be reverted to false).\r\n    mime_type: '',\r\n    is_saving: false,\r\n    data_to_save: {body: null, title: null, description: null}, //holds the values until confirmation of success for each\r\n    generation_to_save: {body: 0, title: 0, description: 0},//when saves return they check their this.description etc. against here and clear data_to_save if they match\r\n    is_read_only: false,\r\n    is_shared: false,\r\n    is_brand_new: false, // true from the point of creating a new document till the point we get confirmation of a successful save\r\n    is_reading_file_object: false, //this is used on drag and drop,\r\n    custom_props: {}, //these are the props potentially stored on the file using the custom properties API\r\n    custom_prop_exists: {}, //each of the custom props that actually exsits for the file will have an entry in this obj, with the key being the property and the value being true.\r\n    saving_title_count: 0 //tracks the number of active save request with just the title.  Whatever the resp, this number is decremented,\r\n};\r\ndn.change_line_history = [];\r\ndn.last_change = null;\r\ndn.change_line_classes =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_',8,5)\r\ndn.change_line_classes_rm =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_rm',8,5)\r\ndn.el = dn.el || {};\r\n\r\n/* ################################################################################################################\r\n\r\n    [Some Notes on settings in Drive Notepad]\r\n\r\n    There are two kinds of settings: per-user settings and per-file settings.\r\n    \r\n    The user settings are stored in dn.g_settings. When the page is loaded this is a fake Google Realtime model, \r\n    which uses a mixture of default values and values read from localStorage.  At some point after authenticating \r\n    the g_settings will become the true Google Realtime model. Whenever a value in g_settings is changed\r\n     dn.setting_changed is called with the appropriate paramaters, this is true right from when the page loads, \r\n     i.e. the first set of values trigger the SettingsChanged, but after that only modifications will trigger a change\r\n      (regardless of whether g_settings is the true model or not).  Use the .set() and .get() methods on the dn.g_settings.\r\n    \r\n    The per-file settings are stored in dn.the_file.custom_props.  When the page is loaded they are initialised with \r\n    default values.  Then, if we have opened an existing file, at some point they will be updated with the true values. \r\n     These settings are *not* a realtime model, rather they are Custom Properties (there's an API for it).  Again, as\r\n      with the per-user settings, whenever the file settings are changed they trigger a call to PropertyUpdated.  Note\r\n       that since this is not backed by a realtime model we won't get changes on the server push to the browser, only\r\n        local changes will be observed.  The per-file settings are shared across anyone who has read and/or write access \r\n        to the file in question. Note that if the default value is chosen the setting value is simply removed from the file.\r\n          Use the dn.set_property() function to set values and read values straight from the dn.the_file.custom_props object.\r\n    \r\n    For each key \"Something\" in customProps there is a function dn.apply_something_choice() which will read the per-user \r\n    and/or the per-file settings (as appropriate) and use the combined result to apply the chosen setting to the editor, \r\n    additionally the function will render the file settings tab and/or the general settings tab. As part of this function \r\n    there will likely be a call to dn.detect_something, which will run some fairly simple heuristic over the current file.\r\n      [TODO: may want to cache this, as it can end up getting called several times during loading and possibly elsewhere.] \r\n      [TODO: may want to have an ApplySomethingChoice for all settings not just those that are covered by customProps.]\r\n\r\n################################################################################################################## */\r\n\r\n\r\ndn.show_user_info = function(a){\r\n    dn.user_info = a.result;\r\n    dn.el.user_name.textContent = a.result.name;\r\n}\r\n\r\n// ############################\r\n// Sharing stuff\r\n// ############################\r\n\r\ndn.do_share = function(){\r\n    if(!dn.the_file.file_id){\r\n        dn.show_error(\"You cannot view/modify the sharing settings until you have saved the file.\")\r\n        return false;\r\n    }\r\n    dn.status.file_sharing = -1; //TODO: see SO question about no callback for share dialog...how are we supposed to know when it's closed and what happened?\r\n    dn.the_file.is_shared = 0;\r\n    dn.show_status();\r\n\r\n    if(dn.el.share_dialog){\r\n        dn.do_share_sub();\r\n    } else {\r\n        gapi.load('drive-share', function(){\r\n            dn.el.share_dialog = new gapi.drive.share.ShareClient(dn.client_id);\r\n            dn.do_share_sub();\r\n        });\r\n    }\r\n\r\n}\r\n\r\ndn.do_share_sub = function(){\r\n    dn.el.share_dialog.setItemIds([dn.the_file.file_id]);\r\n    dn.el.share_dialog.setOAuthToken(gapi.auth.getToken().access_token);\r\n    dn.el.share_dialog.showSettingsDialog();\r\n}\r\n\r\n// ############################\r\n// Newline stuff\r\n// ############################\r\n\r\ndn.detect_new_line = function(str){\r\n    var first_n = str.indexOf(\"\\n\");\r\n    if(first_n == -1)\r\n        return dn.show_newline_status(\"none\");\r\n\r\n    var has_rn = str.indexOf(\"\\r\\n\") != -1;\r\n    var has_solo_n = str.match(/[^\\r]\\n/) ? true : false;\r\n    \r\n    if(has_rn && !has_solo_n)\r\n        return  dn.the_file.new_line_detected = dn.show_newline_status(\"windows\");\r\n    if(has_solo_n && !has_rn)\r\n        return  dn.the_file.new_line_detected = dn.show_newline_status(\"unix\")\r\n    \r\n    return  dn.the_file.new_line_detected = dn.show_newline_status(\"mixed\");\r\n}\r\n\r\ndn.apply_newline_choice = function(str){\r\n    var newlineDefault = dn.g_settings.get('newLineDefault');\r\n    \r\n    if(newlineDefault == \"windows\"){\r\n        dn.el.newline_menu_windows.classList.add('selected')\r\n        dn.el.newline_menu_unix.classList.remove('selected');\r\n    }else{//newlineDefault should be unix\r\n        dn.el.newline_menu_unix.classList.add('selected')\r\n        dn.el.newline_menu_windows.classList.remove('selected');\r\n    }             \r\n                \r\n   if(typeof str == \"string\")\r\n       dn.detect_new_line(str); //Note that it only makes sense to detect new line on downloaded content\r\n   \r\n   dn.show_newline_status(dn.the_file.new_line_detected); //if default changes after load or we have a new file we need this.\r\n   \r\n    dn.el.file_newline_detect.classList.remove('selected');\r\n    dn.el.file_newline_windows.classList.remove('selected');\r\n    dn.el.file_newline_unix.classList.remove('selected');\r\n   if(dn.the_file.custom_props.newline == \"detect\"){\r\n        if(dn.the_file.new_line_detected == \"windows\" || dn.the_file.new_line_detected == \"unix\")\r\n            dn.editor.session.setNewLineMode(dn.the_file.new_line_detected);\r\n        else\r\n            dn.editor.session.setNewLineMode(newlineDefault);    \r\n        dn.el.file_newline_detect.classList.add('selected');\r\n    }else{\r\n        dn.editor.session.setNewLineMode(dn.the_file.custom_props.newline);\r\n            if(dn.the_file.custom_props.newline == \"windows\")\r\n                dn.el.file_newline_windows.classList.add('selected');\r\n            else\r\n                dn.el.file_newline_unix.classList.add('selected');            \r\n    }    \r\n}\r\n\r\ndn.show_newline_status = function(statusStr){\r\n    var str;\r\n    switch(statusStr){\r\n        case 'none':\r\n            str =  \"no newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        case 'mixed':\r\n            str = \"mixture of newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        default:\r\n            str = \"detected \" + statusStr + \"-like newlines\";\r\n    }\r\n    \r\n    dn.el.file_newline_info.textContent = \"(\" + str +\")\";\r\n    \r\n    return statusStr;\r\n}\r\n\r\n\r\n// ############################\r\n// Open stuff\r\n// ############################\r\n\r\ndn.open_button_click = function(){\r\n    gapi.load('picker', function(){\r\n        var view = new google.picker.View(google.picker.ViewId.DOCS);\r\n        try{\r\n            if(!dn.open_picker){\r\n                dn.open_picker = new google.picker.PickerBuilder()\r\n                .enableFeature(google.picker.Feature.NAV_HIDDEN)\r\n                .setAppId(dn.client_id) /* the drive scope requires explicit permission to open each file, and by providing the client_id here you get it for the chosen file */\r\n                .setOAuthToken(gapi.auth.getToken().access_token) /* this gives permission to open the picker..you can do it wtihout a user-specific access_token, but we have one so lets use it */\r\n                .addView(view)\r\n                .setCallback(dn.picker_callback)\r\n                .build();        \r\n                if(!dn.open_picker)\r\n                    throw \"could not build picker\";\r\n            }\r\n            dn.open_picker.setVisible(true);\r\n        } catch (e){\r\n            dn.show_error(\"\" + e);\r\n        }\r\n    });\r\n\r\n}\r\n\r\ndn.picker_callback = function(data) {\r\n    if (data.action == google.picker.Action.PICKED) {\r\n        var file_id = data.docs[0].id;\r\n        var url = \"?state=\" + JSON.stringify({\r\n            action: \"open\",\r\n            userId: dn.url_user_id,\r\n            ids: [file_id]\r\n        });\r\n        window.location = url;\r\n    }else if(data.action == \"cancel\"){\r\n        if(dn.open_new_tab)\r\n            dn.open_new_tab.close();\r\n        dn.focus_editor();\r\n    }\r\n    dn.open_new_tab = undefined;\r\n}\r\n\r\n\r\n// ############################\r\n// Widget stuff\r\n// ############################\r\n\r\ndn.show_help_inner = function(inner_pane){\r\n    // expects string 'shorcuts' or 'tips',  any other values shows main\r\n\r\n    dn.el.pane_help_shortcuts.style.display = 'none';\r\n    dn.el.pane_help_tips.style.display = 'none';\r\n    dn.el.pane_help_main.style.display = 'none';\r\n\r\n    dn.el.button_shortcuts.classList.remove('selected');\r\n    dn.el.button_tips.classList.remove('selected');\r\n    \r\n    if(inner_pane == 'tips'){\r\n        dn.el.pane_help_tips.style.display = '';\r\n        dn.el.button_tips.classList.add('selected');\r\n    } else if(inner_pane == 'shortcuts'){\r\n        dn.el.pane_help_shortcuts.style.display = '';\r\n        dn.el.button_shortcuts.classList.add('selected');\r\n    } else {\r\n        dn.el.pane_help_main.style.display = '';\r\n    }\r\n}\r\n\r\ndn.toggle_permission = function(state){\r\n    var el = dn.el.pane_permissions;\r\n    if(state){\r\n        if(!dn.status.permissions_showing){\r\n            dn.status.permissions_showing = 1;\r\n            el.style.display = '';\r\n            dn.g_settings.set('pane', 'pane_help');\r\n            dn.g_settings.set('pane_open', true);\r\n            css_animation(dn.el.the_widget, 'shake', function(){}, dn.error_delay_ms);\r\n        }\r\n    } else {\r\n        dn.status.permissions_showing = 0;\r\n        el.style.display = 'none';\r\n    }\r\n}\r\n\r\ndn.show_pane = function(id){\r\n    if(id === \"pane_permissions\")\r\n        return dn.toggle_permission(true);\r\n\r\n    var el = document.getElementById(id);\r\n\r\n    // el can be undefined/null to hide everything\r\n    for(var ii=0; ii < dn.el.widget_content.children.length; ii++)\r\n        if(dn.el.widget_content.children[ii] !== el && dn.el.widget_content.children[ii] !== dn.el.pane_permissions){\r\n            dn.el.widget_content.children[ii].style.display = 'none';\r\n            var el_icon = dn.menu_icon_from_pane_id[dn.el.widget_content.children[ii].id];\r\n            if(el_icon)\r\n                el_icon.classList.remove('icon_selected');\r\n    }\r\n\r\n    if(el){\r\n        el.style.display = '';\r\n        var el_icon = dn.menu_icon_from_pane_id[el.id];\r\n        if(el_icon)\r\n            el_icon.classList.add('icon_selected')\r\n    }else{\r\n        dn.g_settings.set('pane_open', false);\r\n    }\r\n}\r\n\r\ndn.widget_mouse_down = function(e){\r\n    dn.widget_mouse_down_info = {\r\n            off_left: -e.clientX,\r\n            off_top: -e.clientY,\r\n            start_time: Date.now(),\r\n            is_dragging: e.button !== 0};\r\n    document.addEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.addEventListener('mouseup', dn.document_mouse_up_widget);\r\n}\r\n\r\ndn.document_mouse_move_widget = function(e){\r\n    var x = e.clientX+dn.widget_mouse_down_info.off_left;\r\n    var y = e.clientY+dn.widget_mouse_down_info.off_top;\r\n    if(!dn.widget_mouse_down_info.is_dragging){\r\n        dn.widget_mouse_down_info.is_dragging = (Date.now() - dn.widget_mouse_down_info.start_time > dn.drag_delay_ms)\r\n                                              || (x*x + y*y > dn.drag_shift_px * dn.drag_shift_px);\r\n    }\r\n    if(dn.widget_mouse_down_info.is_dragging)\r\n        translate(dn.el.the_widget, x, y);\r\n    e.stopPropagation();\r\n\r\n};\r\n\r\ndn.document_mouse_up_widget = function(e){\r\n    document.removeEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.removeEventListener('mouseup', dn.document_mouse_up_widget);\r\n\r\n    if(dn.widget_mouse_down_info.is_dragging){\r\n        var pos = dn.el.the_widget.getBoundingClientRect();\r\n        translate(dn.el.the_widget, 0, 0);\r\n    \r\n        //work out what widget_anchor should be\r\n        var widget_w = dn.el.the_widget.offsetWidth;\r\n        var widget_h = dn.el.the_widget.offsetHeight;\r\n        var window_w = window.innerWidth;\r\n        var window_h = window.innerHeight;\r\n        var anchor = []\r\n        if(pos.left < window_w - (pos.left + widget_w)){\r\n            anchor[0] = 'l'; //anchor left side by window width percentage\r\n            anchor[1] = Math.max(0,pos.left/window_w * 100);\r\n        }else{\r\n            anchor[0] = 'r'; //anchor right side by window width percentage\r\n            anchor[1] = Math.max(0,(window_w - (pos.left + widget_w))/window_w * 100);\r\n        }\r\n        if(pos.top < window_h - (pos.top+ widget_h)){\r\n            anchor[2] = 't'; //anchor top side by window height percentage\r\n            anchor[3] = Math.max(0,pos.top/window_h * 100);\r\n        }else{\r\n            anchor[2] = 'b'; //anchor bottom side by window height percentage\r\n            anchor[3] = Math.max(0,(window_h - (pos.top + widget_h))/window_h * 100);\r\n        }\r\n\r\n        if(dn.g_settings)\r\n            dn.g_settings.set(\"widget_anchor\",anchor); \r\n\r\n    }else{\r\n        dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n    }\r\n    dn.widget_mouse_down_info = undefined;\r\n};\r\n\r\ndn.widget_apply_anchor = function(anchor){\r\n    anchor = Array.isArray(anchor) ? anchor : dn.g_settings.get('widget_anchor');\r\n    var widget_w = dn.el.the_widget.offsetWidth;\r\n    var widget_h = dn.el.the_widget.offsetHeight;\r\n    var window_w = window.innerWidth;\r\n    var window_h = window.innerHeight;\r\n\r\n    if(anchor[0] == 'l'){\r\n        // horizontal position is anchored to a fixed percentage of window width on left of widget\r\n        if(window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = '0px'; //if the widget would overlap the right edge, then instead put it precisely on the right edge\r\n        }else{\r\n            dn.el.the_widget.style.left = anchor[1] + '%';\r\n            dn.el.the_widget.style.right = ''; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.add('flipped');\r\n        dn.el.widget_content.classList.add('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.add('flipped');\r\n\r\n    }else{\r\n        // horizontal position is anchored to a fixed percentage of window width on right of widget\r\n        if( window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = '0px';\r\n            dn.el.the_widget.style.right = ''; //if the widget would overlap the left edge, then instead put it precisely on the left edge\r\n        }else{\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = anchor[1] + '%'; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.remove('flipped');\r\n        dn.el.widget_content.classList.remove('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.remove('flipped');\r\n    }\r\n\r\n    if(anchor[2] == 't'){\r\n        // vertical position is anchored to a fixed percentage of window height on top of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = '0px';  \r\n        }else{\r\n            dn.el.the_widget.style.top = anchor[3] + '%';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }\r\n    }else{\r\n        // vertical position is anchored to a fixed percentage of window height on bottom of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = '0px';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }else{\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = anchor[3] + '%'; \r\n        }\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\ndn.toggle_widget = function(state){\r\n    // provide argument \"true\" to open widget, \"false\" to close\r\n    if(state){\r\n        dn.el.widget_menu.style.display = '';\r\n        dn.el.widget_content.style.display = '';\r\n    }else{\r\n        dn.el.widget_menu.style.display = 'none';\r\n        dn.el.widget_content.style.display = 'none';\r\n    }\r\n}\r\n\r\ndn.show_status = function(){\r\n    // TODO: new file, drag-drop from disk\r\n    var s = ''\r\n\r\n    if (dn.the_file.file_id){\r\n        // a file is/will be loaded...\r\n        if (dn.status.file_meta === 1 && dn.status.file_body === 1){\r\n            s = dn.the_file.title;\r\n            var extra = [];\r\n            if(dn.the_file.is_read_only)\r\n                extra.push(\"read-only\");\r\n            if(dn.the_file.is_shared)\r\n                extra.push(\"shared\");\r\n            if(dn.status.file_sharing == -1)\r\n                extra.push(\"sharing status unknown\");\r\n            if(!dn.the_file.is_pristine)\r\n                extra.push(\"unsaved changes\");\r\n            if(dn.status.save_body == 0){\r\n                extra.push(\"saving document\"); // this means that *at least* the body is being saved, possibly more\r\n            } else {\r\n                if(dn.status.save_title == 0)\r\n                    extra.push(\"updating title\");\r\n                if(dn.status.save_other == 0)\r\n                    extra.push(\"updating file properties\")\r\n            } \r\n            if(extra.length)\r\n                s += \"\\n[\" + extra.join(', ') + \"]\"; \r\n        }else if(dn.status.file_meta === 0 && dn.status.file_body === 0)\r\n            s = \"Loading file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1 && dn.status.file_body === 0)\r\n            s = \"Loading \" + (dn.the_file.is_read_only? 'read-only ' : '' ) + \r\n                    \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_meta === 0 && dn.status.file_body === 1)\r\n            s = \"Loading metadata for file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1) // and -1\r\n            s = \"Failed to download \" + (dn.the_file.is_read_only? 'read-only ' : '' )\r\n                    +  \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_body === 1) // and -1\r\n            s = \"Failed to download metadata for file:\\n\" + dn.the_file.file_id;\r\n        else // both -1\r\n            s = \"Failed to load file:\\n\" + dn.the_file.file_id;\r\n    } else {\r\n        // no file to load\r\n        s = \"ex nihilo omnia...\";\r\n    }\r\n\r\n    if(dn.status.authentication != 1){\r\n        // auth in progress or failed\r\n        if (s)\r\n            s += \"\\n\";\r\n        if(dn.status.authorization == -1)\r\n            s += \"Authorization required...\";\r\n        else if(dn.status.popup_active)\r\n            s += \"Login/authenticate with popup...\";\r\n        else\r\n            s += \"Authenticating...\";\r\n    }\r\n\r\n    text_multi(dn.el.widget_text, s, true);\r\n\r\n    if(dn.status.save_body == 0 || dn.status.save_title == 0 || dn.status.save_other == 0)\r\n        dn.el.widget_pending.style.display = '';\r\n    else\r\n        dn.el.widget_pending.style.display = 'none';\r\n}\r\n\r\ndn.show_error = function(message){\r\n    console.log(message); //it's just useful to do this too\r\n    text_multi(dn.el.widget_error_text, message,true);\r\n    dn.el.widget_error.style.display = '';\r\n    css_animation(dn.el.the_widget, 'shake', function(){\r\n        dn.el.widget_error.style.display = 'none';\r\n    }, dn.error_delay_ms);\r\n};\r\n\r\ndn.set_drive_link_to_folder = function(){\r\n    var els = document.getElementsByClassName('link_drive');\r\n    var href = dn.the_file.folder_id ? \r\n                'https://drive.google.com/#folders/' + dn.the_file.folder_id \r\n                : 'https://drive.google.com';\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].href = href;\r\n}\r\n\r\n\r\n// ############################\r\n// Settings stuff\r\n// ############################\r\n\r\n\r\ndn.show_app_data_document = function(doc){\r\n\r\n    var old_temp_g_settings = dn.g_settings;\r\n    dn.g_settings = doc.getModel().getRoot();\r\n    dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    if(!dn.g_clipboard){\r\n        dn.g_settings.set('clipboard', doc.getModel().createList());\r\n        dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    }\r\n    dn.g_find_history = dn.g_settings.get('findHistory');\r\n    if(!dn.g_find_history){\r\n        dn.g_settings.set('findHistory', doc.getModel().createList());\r\n        dn.g_find_history = dn.g_settings.get('findHistory');\r\n    }\r\n    \r\n    var existingKeys = dn.g_settings.keys();\r\n    dn.g_settings.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED, dn.settings_changed);\r\n    console.log('Applying settings from cloud...')\r\n    for(var s in dn.default_settings)\r\n        if(s in old_temp_g_settings.getKeeps())\r\n            dn.g_settings.set(s,old_temp_g_settings.get(s));\r\n        else if(existingKeys.indexOf(s) == -1)\r\n            dn.g_settings.set(s,dn.default_settings[s]);\r\n        else if(JSON.stringify(old_temp_g_settings.get(s)) !== JSON.stringify(dn.g_settings.get(s)))\r\n            dn.settings_changed({property:s, newValue:dn.g_settings.get(s)});// the gapi doesn't automatically trigger this on load\r\n    \r\n    //Check lastDNVersionUsed at this point - by default it's blank, but could also have an out-of-date value\r\n    if(dn.g_settings.get('lastDNVersionUsed') != dn.version_str){\r\n        dn.g_settings.set('help_inner', 'tips');\r\n        dn.g_settings.set('pane', 'pane_help');\r\n        dn.g_settings.set('pane_open', 'true');\r\n        dn.g_settings.set('lastDNVersionUsed', dn.version_str);\r\n    }\r\n\r\n    dn.status.realtime_settings = 1;\r\n}\r\n\r\n\r\n\r\n\r\ndn.load_default_settings = function(){\r\n  //Lets show the user either the defualt settings or the \r\n  //ones last used on this browser (restricted to impersonal settings only)\r\n\r\n  dn.g_settings = (function(){ //mock realtime model to be used until the real model is initialised\r\n      var ob = {};\r\n      var keeps = {}\r\n      return {get: function(k){return ob[k]}, \r\n              set: function(k,v){\r\n                if(ob[k] === v)\r\n                    return;\r\n                ob[k] = v;\r\n                dn.settings_changed({property: k, newValue: v});\r\n                },\r\n              keep: function(k){keeps[k] = true},\r\n              getKeeps: function(){return keeps;}};\r\n                                 \r\n  })();\r\n\r\n  dn.status.local_settings = 0;\r\n  try{\r\n    console.log('Loading default/localStorage settings...');\r\n    for(var s in dn.default_settings)\r\n    if(dn.impersonal_settings_keys.indexOf(s) == -1 || !localStorage || !localStorage[\"g_settings_\" +s])\r\n        dn.g_settings.set(s,dn.default_settings[s]);\r\n    else\r\n        dn.g_settings.set(s,JSON.parse(localStorage[\"g_settings_\" + s]));\r\n  }catch(err){\r\n      if(localStorage) \r\n        localStorage.clear();\r\n      console.log(\"Failed to load defaults/localStorage settings.  Have cleared localStorage cache.\")\r\n  }\r\n  dn.status.local_settings = 1;\r\n}\r\n\r\ndn.settings_changed = function(e){\r\n    var new_value = e.newValue;\r\n    console.log(\"[user settings] \" + e.property +\": \" + new_value);\r\n    if(dn.impersonal_settings_keys.indexOf(e.property)>-1 && localStorage){\r\n        localStorage[\"g_settings_\" + e.property] = JSON.stringify(new_value);\r\n    }\r\n    try{\r\n        switch(e.property){\r\n            case \"widget_anchor\":\r\n                dn.widget_apply_anchor(new_value);\r\n                    break;\r\n            case \"theme\":\r\n                dn.editor.setTheme('ace/theme/' + new_value);\r\n                dn.theme_drop_down.SetInd(dn.theme_drop_down.IndexOf(new_value), true);\r\n                break;\r\n            case \"fontSize\":\r\n                var scrollLine = dn.get_scroll_line();\r\n                dn.el.font_size_text.textContent = new_value.toFixed(1);\r\n                dn.editor.setFontSize(new_value + 'em')    \r\n                dn.editor.scrollToLine(scrollLine);\r\n                break;\r\n            case \"wordWrap\":\r\n                var s = dn.editor.getSession();\r\n                var scrollLine = dn.get_scroll_line();\r\n                s.setUseWrapMode(new_value[0]);\r\n                s.setWrapLimitRange(new_value[1],new_value[2]);\r\n                 dn.editor.scrollToLine(scrollLine);\r\n                if(!new_value[0])\r\n                    dn.el.word_wrap_off.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_off.classList.remove('selected');\r\n                if(new_value[0] && !new_value[1])\r\n                    dn.el.word_wrap_edge.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_edge.classList.remove('selected');\r\n                if(new_value[0] && new_value[1])\r\n                    dn.el.word_wrap_at.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_at.classList.remove('selected');\r\n\r\n                break;\r\n            case \"wordWrapAt\":\r\n                dn.el.word_wrap_at_text.textContent = new_value;\r\n                var curWrap = dn.g_settings.get('wordWrap');\r\n                if(curWrap[1] && curWrap[1] != new_value)\r\n                    dn.g_settings.set('wordWrap',[1,new_value,new_value]);\r\n                dn.editor.setPrintMarginColumn(new_value);\r\n                break;\r\n            case \"showGutterHistory\":\r\n                var s = dn.editor.getSession(); \r\n                if(new_value){\r\n                    dn.el.gutter_history_show.classList.add('selected')\r\n                    dn.el.gutter_history_hide.classList.remove('selected');\r\n                }else{\r\n                    var h = dn.change_line_history;\r\n                    for(var i=0;i<h.length;i++)if(h[i])\r\n                        s.removeGutterDecoration(i,h[i]<0 ? dn.change_line_classes_rm[-h[i]] : dn.change_line_classes[h[i]]);\r\n                    dn.change_line_history = []; \r\n                    dn.el.gutter_history_hide.classList.add('selected')\r\n                    dn.el.gutter_history_show.classList.remove('selected');\r\n                }\r\n                break;\r\n            case \"newLineDefault\":\r\n                dn.apply_newline_choice();\r\n                break;\r\n            case \"historyRemovedIsExpanded\":\r\n                dn.revision_setis_expaned(new_value);\r\n                break;\r\n            case \"softTabN\":\r\n            case \"tabIsHard\":          \r\n                dn.apply_tab_choice(); \r\n                break;\r\n            case 'pane_open':\r\n                dn.toggle_widget(new_value)\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane_open');\r\n                break;\r\n            case 'pane':\r\n                dn.show_pane(new_value);\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane');\r\n                if(new_value !== 'pane_help')\r\n                    dn.g_settings.set('help_inner', 'main');\r\n                break; \r\n            case 'help_inner':\r\n                dn.show_help_inner(new_value);\r\n                break;\r\n            case 'find_regex':\r\n                if(new_value)\r\n                    dn.el.find_button_regex.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_regex.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_whole_words':\r\n                if(new_value)\r\n                    dn.el.find_button_whole_words.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_whole_words.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_case_sensitive':\r\n                if(new_value)\r\n                    dn.el.find_button_case_sensitive.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_case_sensitive.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_replace':\r\n                dn.find_replace_changed(new_value);\r\n                break;\r\n            case 'find_goto':\r\n                dn.find_goto_changed(new_value);\r\n                break;\r\n        }\r\n    }catch(err){\r\n        console.log(\"Error while uptating new settings value.\")\r\n        console.dir(e);\r\n        console.dir(err);\r\n    }\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Font size stuff\r\n// ############################\r\n\r\ndn.font_size_decrement_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size -= dn.font_size_increment;\r\n    font_size = font_size  < dn.min_font_size ? dn.min_font_size: font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\ndn.font_size_increment_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size += dn.font_size_increment;\r\n    font_size = font_size  > dn.max_font_size ? dn.max_font_size:font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Tab stuff\r\n// ############################\r\n// Note that there is a whitespace extension for ace but it doesn't look that mature and we actually have slightly different requirements here.\r\n\r\ndn.detect_tab = function(str){    \r\n    dn.the_file.tab_detected = (function(){ //no need to use a self-executing function here, just lazy coding....\r\n        //This function returns an object with a field \"val\" that takes one of the folling values:\r\n        // none: no indents detected at all\r\n        // mixture: no strong bias in favour of spaces or tabs\r\n        // tab: defintely tabs\r\n        // spaces: definitely space. In this case extra fields are provied....\r\n        //   n: number of spaces\r\n        //   isDefault: true if the default nSpaces value was used as part of the decision making process\r\n        //   threshold: this takes one of three values:\r\n        //          strong: the largest n over threshold was used\r\n        //          weak: no n was over the strong threshold, but the default n was over the weak threshold\r\n        //          failed: no idea what n is, so just use default\r\n    \r\n        var lines = dn.editor.session.getLines(0, 1000);    \r\n        var indents = lines.map(function(str){\r\n                        return str.match(/^\\s*/)[0];\r\n                      });\r\n        indents = indents.filter(function(str){return str !== '';});\r\n        \r\n        if(!indents.length)\r\n            return dn.show_tab_status({val: \"none\"});\r\n            \r\n        //TODO: if first thousand lines happen to have few indents it may be worth checking further down.\r\n        \r\n        var stats = indents.reduce(function(stats,str){\r\n           if(str.indexOf('\\t') > -1)\r\n              if(str.indexOf(' ') > -1)\r\n                stats.nWithMixture++;\r\n              else\r\n                stats.nWithOnlyTabs++;\r\n           else\r\n               stats.spaceHist[str.length] = (stats.spaceHist[str.length] || 0) + 1;   \r\n            return stats;\r\n        },{nWithOnlyTabs: 0,spaceHist: [],nWithMixture: 0});\r\n            \r\n        stats.nSamp = indents.length;\r\n        stats.nWithOnlySpaces = stats.nSamp - stats.nWithMixture - stats.nWithOnlyTabs;\r\n        \r\n        console.dir(stats);\r\n            \r\n        if(stats.nWithOnlyTabs/stats.nSamp >= dn.detect_tabs_tabs_frac)\r\n            return dn.show_tab_status({val: \"tab\"});\r\n    \r\n        if(stats.nWithOnlySpaces/stats.nSamp < dn.detect_tabs_spaces_frac)\r\n            return dn.show_tab_status({val: \"mixture\"});\r\n    \r\n        stats.spaceModHist = [];\r\n        var s;\r\n        for(s=dn.min_soft_tab_n;s<=dn.max_soft_tab_n;s++){\r\n            var m = 0;    \r\n            for(var i=s;i<stats.spaceHist.length;i+=s)\r\n                m += stats.spaceHist[i] !== undefined ? stats.spaceHist[i] : 0;\r\n            stats.spaceModHist[s] = m;\r\n        }\r\n        \r\n        for(s=dn.max_soft_tab_n;s>=dn.min_soft_tab_n;s--)\r\n            if(stats.spaceModHist[s]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac)\r\n                break;\r\n                \r\n        if(s < dn.min_soft_tab_n){\r\n            // nothing was over threshold, but rather than give up lets use a weaker threshold on the default space count\r\n            var defaultNSpaces = dn.g_settings.get('softTabN');    \r\n            if(stats.spaceModHist[defaultNSpaces]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac_for_default)\r\n                return dn.show_tab_status({val: 'spaces', n: defaultNSpaces, isDefault: true, threshold: \"weak\"});\r\n            else\r\n                return dn.show_tab_status({val: \"spaces\", n: defaultNSpaces, isDefault: true, threshold: \"failed\"});\r\n        }else{\r\n            // s is the index of the last element in the spaceModHist array which is over threshold\r\n                return dn.show_tab_status({val: \"spaces\", n: s, isDefault: false, threshold: \"strong\"});\r\n        }\r\n    })();\r\n}\r\n\r\n\r\ndn.show_tab_status = function(d){\r\n    var str;\r\n    var defaultStr = \"\";\r\n    if(dn.g_settings.get(\"tabIsHard\"))\r\n        defaultStr = \"hard tabs\";\r\n    else\r\n        defaultStr = dn.g_settings.get(\"softTabN\") + \" spaces\";\r\n    \r\n    switch(d.val){\r\n        case 'none':\r\n            str = \"no indentations detected, default is \" + defaultStr;\r\n            break;\r\n        case 'mixture':\r\n            str = \"detected mixture of tabs, default is \" + defaultStr;\r\n            break;\r\n        case 'tab':\r\n            str = \"hard tab indentation detected\";\r\n            break;\r\n        case \"spaces\":\r\n            switch(d.threshold){\r\n                case 'strong':\r\n                    str = \"detected soft-tabs of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'weak':\r\n                    str = \"detected close match to default of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'failed':\r\n                    str = \"detected soft-tabs, assuming default \" + d.n + \" spaces\";\r\n                    break;\r\n            }\r\n    }\r\n    \r\n    dn.el.file_tab_info.textContent = \"(\" + str +\")\";\r\n    return d;\r\n}\r\n\r\ndn.apply_tab_choice = function(){\r\n    var defaultTabIsHard = dn.g_settings.get('tabIsHard');\r\n    var defaultSoftTabN = dn.g_settings.get('softTabN');               \r\n                \r\n    var d;\r\n    var isHard;\r\n    var nSpaces;\r\n    var isDetected;\r\n    \r\n    dn.detect_tab();   \r\n    if(dn.the_file.custom_props.tabs == \"detect\"){\r\n        d = dn.the_file.tab_detected;             \r\n        isDetected = true\r\n    }else{\r\n        try{\r\n            d = JSON.parse(dn.the_file.custom_props.tabs);\r\n        }catch(err){\r\n            d = {val: \"none\"};\r\n        }\r\n    }\r\n    switch(d.val){\r\n        case 'none':\r\n        case 'mixture':\r\n            isHard = defaultTabIsHard;\r\n            nSpaces = defaultSoftTabN;\r\n            break;\r\n        case 'tab':\r\n            isHard = true;\r\n            nSpaces = d.n || defaultSoftTabN;\r\n            break;\r\n        case 'spaces':\r\n            isHard = false;\r\n            nSpaces = d.n;\r\n    }\r\n    \r\n    \r\n    if(isHard){\r\n        dn.editor.session.setUseSoftTabs(false);\r\n    }else{\r\n        dn.editor.session.setUseSoftTabs(true);\r\n        dn.editor.session.setTabSize(nSpaces);\r\n    }\r\n    \r\n    dn.el.tab_soft_text.textContent = defaultSoftTabN;\r\n    if(defaultTabIsHard){\r\n        dn.el.tab_hard.classList.add('selected');\r\n        dn.el.tab_soft.classList.remove('selected');\r\n    }else{\r\n        dn.el.tab_soft.classList.add('selected');\r\n        dn.el.tab_hard.classList.remove('selected');\r\n    }\r\n    \r\n    \r\n    dn.el.file_tab_detect.classList.remove('selected');\r\n    dn.el.file_tab_hard.classList.remove('selected');\r\n    dn.el.file_tab_soft.classList.remove('selected');\r\n    if(isDetected){\r\n        dn.el.file_tab_detect.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }else{\r\n        if(d.val == \"tab\")\r\n            dn.el.file_tab_hard.classList.add('selected');\r\n        else\r\n            dn.el.file_tab_soft.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }     \r\n\r\n\r\n}\r\n\r\ndn.set_file_tabs_to_soft_or_hard = function(val,delta){\r\n    var f = dn.the_file;\r\n    var current = f.custom_props.tabs;\r\n    if(current == \"detect\"){\r\n        current = f.tab_detected;\r\n        if(current.val == 'none' || current.val == \"mixture\")\r\n            current = { val: dn.g_settings.get('tabIsHard') ? \"tab\" : \"spaces\",\r\n                        n: dn.g_settings.get('softTabN')};\r\n    }else{\r\n        try{\r\n            current = JSON.parse(current);\r\n        }catch(err){\r\n            console.log(\"JSON.parse failed in SetFileTabsToSoftOrHard with current=\" + current)\r\n            return;\r\n        }\r\n    }\r\n    var newT = {val: val, n: current.n + delta};\r\n    dn.set_property(\"tabs\",JSON.stringify(newT));\r\n}\r\n// ############################\r\n// Syntax stuff\r\n// ############################\r\n\r\ndn.show_syntax_status = function(d){\r\n    var str = \"detected \" + d.syntax + \" from file extension\";\r\n    //TODO: if we improve upon DetectSyntax will need to add stuff here\r\n    dn.el.file_ace_mode_info.textContent = \"(\" + str + \")\";\r\n    return d.syntax;\r\n}\r\ndn.detect_syntax = function(){\r\n    //TODO: improve upon this\r\n    var title = dn.the_file.title || \"untitled.txt\";\r\n    var mode  = require(\"ace/ext/modelist\").getModeForPath(title);\r\n    dn.the_file.syntax_detected = mode.caption;\r\n    dn.show_syntax_status({syntax: dn.the_file.syntax_detected});\r\n    dn.the_file.syntax_detected = mode;\r\n}\r\n\r\ndn.apply_syntax_choice = function(){\r\n    dn.detect_syntax();\r\n    if(dn.the_file.custom_props[\"aceMode\"] == \"detect\"){\r\n        dn.set_syntax(dn.the_file.syntax_detected);\r\n        dn.el.file_ace_mode_detect.classList.add('selected');\r\n        dn.syntax_drop_down.SetSelected(false);\r\n    }else{\r\n        dn.set_syntax(dn.the_file.custom_props[\"aceMode\"])\r\n        dn.el.file_ace_mode_detect.classList.remove('selected');\r\n        dn.syntax_drop_down.SetSelected(true);\r\n    }\r\n}\r\n\r\ndn.set_syntax = function(val){\r\n    var modesArray = require(\"ace/ext/modelist\").modes;\r\n    var mode;\r\n    var ind;\r\n    \r\n    if(typeof val == \"number\"){\r\n        //val is index into mdoes array\r\n        mode = modesArray[val].mode;\r\n        ind = val;\r\n    }else if(modesArray.indexOf(val) > -1){\r\n        //val is an element of the modelist array\r\n        mode = val.mode;\r\n        ind = modesArray.indexOf(val);\r\n    }else{\r\n        //val is caption of mode in modes array\r\n        for(ind=0;ind<modesArray.length;ind++)if(modesArray[ind].caption == val){\r\n            mode = modesArray[ind].mode;\r\n            break;\r\n        }    \r\n    }\r\n    \r\n    if(dn.syntax_drop_down)\r\n        dn.syntax_drop_down.SetInd(ind,true);\r\n    dn.editor.getSession().setMode(mode);\r\n}\r\n\r\ndn.create_theme_menu = function(){\r\n    var themes = require('ace/ext/themelist');\r\n    var theme_drop_down = new DropDown(Object.keys(themes.themesByName));\r\n    theme_drop_down.addEventListener(\"change\",function(){\r\n        dn.g_settings.set(\"theme\",theme_drop_down.GetVal());\r\n    })\r\n    theme_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return theme_drop_down;\r\n}\r\n\r\ndn.create_syntax_menu = function(){\r\n    var modes = require(\"ace/ext/modelist\").modes;\r\n    \r\n    var syntax_drop_down = new DropDown(modes.map(function(m){return m.caption;}));\r\n    \r\n    syntax_drop_down.addEventListener(\"click\", dn.read_only_bail);\r\n    \r\n    syntax_drop_down.addEventListener(\"click\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"change\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return syntax_drop_down;\r\n}\r\n\r\n// ############################\r\n// File details stuff\r\n// ############################\r\ndn.read_only_bail = function(e){\r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"The file is read-only, so you cannot change its properties.\");\r\n        e.stopImmediatePropagation();\r\n       dn.focus_editor();\r\n    }\r\n}\r\ndn.create_file_details_tool = function(){\r\n    var els = [dn.el.details_title_text,\r\n               dn.el.details_description_text,\r\n               dn.el.file_newline_detect,\r\n               dn.el.file_newline_windows,\r\n               dn.el.file_newline_unix,\r\n               dn.el.file_tab_detect,\r\n               dn.el.file_tab_soft,\r\n               dn.el.file_tab_hard,\r\n               dn.el.file_ace_mode_detect];\r\n    for(var ii=0; ii< els.length; ii++)\r\n        els[ii].addEventListener(\"click\",dn.read_only_bail); //If file is read only, ReadOnlyBail will prevent the click handlers below from running.\r\n        \r\n    //Title change stuff\r\n    dn.el.details_title_text.addEventListener('click', function(){                \r\n            dn.el.details_title_text.style.display = 'none';\r\n            dn.el.details_title_input.style.display = '';\r\n            dn.el.details_title_input.focus();\r\n            dn.el.details_title_input.select();\r\n    });\r\n    dn.el.details_title_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_title_input.style.display = 'none';\r\n            dn.el.details_title_text.style.display = '';\r\n            var new_val = dn.el.details_title_input.value;\r\n            if(new_val == dn.the_file.title)\r\n                return;\r\n            dn.the_file.title = new_val\r\n            dn.show_file_title(); //includes showStatus\r\n            dn.apply_syntax_choice();\r\n            dn.save_file_title();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_title_input.addEventListener('keyup', function(e){\r\n            if(e.which == WHICH.ENTER)\r\n                dn.el.details_title_input.trigger('blur');\r\n    });\r\n    dn.el.details_title_input.addEventListener('keydown', function(e){\r\n        if(e.which == WHICH.ESC){\r\n            dn.el.details_title_input.value = dn.the_file.title;\r\n            dn.el.details_title_input.trigger('blur');\r\n            dn.ignore_escape = true; //stops ToggleWidget\r\n        }\r\n    });\r\n\r\n    // File action buttons stuff\r\n    dn.el.button_save.addEventListener('click', dn.do_save);\r\n    dn.el.button_print.addEventListener('click', dn.do_print);\r\n    dn.el.button_share.addEventListener('click', dn.do_share);\r\n    dn.el.button_history.addEventListener('click', dn.start_revisions_worker);\r\n\r\n    // Description stuff\r\n    dn.el.details_description_text.addEventListener('click', function(){            \r\n            dn.el.details_description_text.style.display = 'none';\r\n            dn.el.details_description_input.style.display = '';\r\n            dn.el.details_description_input.focus();\r\n    });\r\n    dn.el.details_description_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_description_input.style.display = 'none';\r\n            dn.el.details_description_text.style.display = '';\r\n            var new_val = dn.el.details_description_input.value;\r\n            if(dn.the_file.description === new_val)\r\n                return;\r\n            dn.the_file.description = new_val;\r\n            dn.show_description();\r\n            dn.save_file_description();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_description_input.addEventListener('keydown',function(e){\r\n            if(e.which == WHICH.ESC){\r\n                dn.el.details_description_input.value = dn.the_file.description;\r\n                dn.el.details_description_input.trigger('blur');\r\n                dn.ignore_escape = true;\r\n            }\r\n    });\r\n        \r\n    // File custom props stuff\r\n    dn.el.file_newline_detect.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"detect\");\r\n        dn.focus_editor();      \r\n    });\r\n    dn.el.file_newline_windows.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"windows\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_newline_unix.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"unix\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_tab_detect.classList.add('selected');\r\n    dn.el.file_tab_detect.addEventListener('click', function(){\r\n        dn.set_property(\"tabs\",\"detect\");\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_tab_soft.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",0);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_dec').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",-1);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_inc').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",+1);\r\n       dn.focus_editor();\r\n    })\r\n    dn.el.file_tab_hard.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"tab\",0);\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_ace_mode_detect.addEventListener('click', function(){\r\n       dn.set_property(\"aceMode\",\"detect\"); \r\n    });\r\n}\r\n\r\ndn.save_file_description = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    \r\n    dn.save_file(dn.the_file.file_id, {description: dn.the_file.description}, undefined, \r\n                $.proxy(dn.save_done,{description: ++dn.the_file.generation_to_save.description}))\r\n    dn.show_status();\r\n    return;\r\n    \r\n}\r\n\r\ndn.save_file_title = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    //TODO: mime-type IMPORTANT!\r\n\r\n    dn.save_file(dn.the_file.file_id, {title: dn.the_file.title}, undefined, \r\n                $.proxy(dn.save_done,{title: ++dn.the_file.generation_to_save.title}))\r\n    dn.show_status();    \r\n}\r\n\r\ndn.show_file_title = function(){\r\n    dn.el.details_title_text.textContent = 'Title: ' + dn.the_file.title;\r\n    dn.el.details_title_input.value = dn.the_file.title;\r\n    document.title = (dn.the_file.is_pristine ? \"\" : \"*\") + dn.the_file.title;\r\n    dn.show_status();\r\n}\r\n\r\ndn.show_description = function(){\r\n    text_multi(dn.el.details_description_text, 'Description: ' + dn.the_file.description,true);\r\n    dn.el.details_description_input.value = dn.the_file.description;\r\n}\r\n\r\n// ############################\r\n// Save stuff\r\n// ############################\r\n\r\n\r\n/*\r\ndn.save_content = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return false;\r\n    }\r\n    \r\n    if(!dn.the_file.is_pristine){\r\n        dn.the_file.data_to_save.body = dn.editor.getSession().getValue();\r\n        dn.the_file.generation_to_save.body++;\r\n        dn.el.widget_pending.style.display = '';\r\n        dn.the_file.is_saving = true;\r\n        dn.the_file.is_pristine = true;\r\n    }\r\n    \r\n    dn.show_file_title(); //includes a showstatus calls\r\n    dn.do_save();\r\n    return false;\r\n}*/\r\n\r\ndn.do_save = function (e){\r\n    e.preventDefault(); //needed for when called as shortcut\r\n\r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"Cannot save read-only file.\");\r\n        return;\r\n    }\r\n\r\n    dn.save({body: dn.editor.getSession().getValue()});\r\n\r\n    /*\r\n    if(!(dn.the_file.data_to_save.body || dn.the_file.data_to_save.title || dn.the_file.data_to_save.description)){\r\n        dn.show_error(\"No changes since last save.\");\r\n        return false;\r\n    }\r\n\r\n    var gens = {};\r\n    var body, meta;\r\n    if(dn.the_file.data_to_save.body){\r\n        body = dn.the_file.data_to_save.body;\r\n        gens.body = dn.the_file.generation_to_save.body;\r\n    }\r\n    if(dn.the_file.data_to_save.title || dn.the_file.data_to_save.description){\r\n        meta = {};\r\n        if(dn.the_file.data_to_save.title){\r\n            meta.title = dn.the_file.data_to_save.title;\r\n            gens.title = dn.the_file.generation_to_save.title;\r\n        }\r\n        if(dn.the_file.data_to_save.description){\r\n            meta.description = dn.the_file.data_to_save.description; \r\n            gens.description = dn.the_file.generation_to_save.description;\r\n        }\r\n    }\r\n    dn.save_file(dn.the_file.file_id, meta, body, $.proxy(dn.save_done,gens))\r\n    */\r\n}\r\n/*\r\ndn.save_done = function(resp){\r\n    if(resp.error){\r\n        if(resp.error.code == 401){\r\n            dn.reauth_auto(dn.do_save); //will make use of dn.the_file.data_to_save and generation_to_save once auth is done.\r\n        }else{\r\n            var failures = []\r\n            if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n                failures.push(\"body\");\r\n                dn.the_file.is_saving = false;\r\n                dn.the_file.is_pristine = false;\r\n                dn.show_file_title();\r\n                dn.el.widget_pending.style.display = 'none';\r\n                dn.the_file.data_to_save.body = null;\r\n            }\r\n            if(this.title && this.title == dn.the_file.generation_to_save.title)\r\n                failures.push(\"title\");\r\n            if(this.description && this.description == dn.the_file.generation_to_save.description)\r\n                failures.push(\"description\");\r\n            \r\n            if(failures.length){//it's possible that all parts of the save request have since been superceded, so we can ignore this failure\r\n                dn.show_error(\"Failed to save \" +  oxford_comma(failures) + \". Error #\" + resp.error.code + (resp.error.message? \"\\n\" + resp.error.message : \"\"));\r\n                console.dir(resp);\r\n            }            \r\n        }\r\n    }else{//success...\r\n        if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n            dn.the_file.is_saving = false;\r\n            dn.el.widget_pending.style.display = 'none';\r\n            dn.the_file.ext = resp.fileExtension;\r\n            dn.g_settings.set('ext',resp.fileExtension);\r\n            dn.the_file.data_to_save.body = null;\r\n            \r\n            if(dn.the_file.is_brand_new)\r\n                dn.saved_new_file(resp); \r\n        }\r\n        if(this.title && this.title == dn.the_file.generation_to_save.title){\r\n            dn.the_file.data_to_save.title = null;\r\n        }\r\n        if(this.description && this.description == dn.the_file.generation_to_save.description){\r\n            dn.the_file.data_to_save.description = null;\r\n        }\r\n\r\n    }\r\n    dn.show_status();\r\n}\r\n\r\ndn.save_file = function (fileId, fileMetadata, fileText, callback) {\r\n    //if fileId is null then a new file is created (can set fileMetadata.parentNodes = [parentFolderId])\r\n    //fileMetadata or fileText can be null.\r\n    //See https://developers.google.com/drive/v2/reference/files/insert - Request Body for valid metaData.\r\n\r\n    //build a multipart message body\r\n    var boundary = dn.make_boundary();\r\n    var delimiter = \"\\r\\n--\" + boundary + \"\\r\\n\";\r\n    var close_delim = \"\\r\\n--\" + boundary + \"--\";\r\n\r\n    var messageBody = delimiter +\r\n                'Content-Type: application/json\\r\\n' +\r\n                '\\r\\n' + JSON.stringify(fileMetadata ? fileMetadata : {}); //note than in the multipart message upload you must provide some json metadata, even if it's empty.\r\n\r\n    if(fileText){ \r\n        messageBody += delimiter +\r\n                'Content-Type: application/octet-stream\\r\\n' +\r\n                'Content-Transfer-Encoding: base64\\r\\n' +\r\n                '\\r\\n' + btoa(unescape(encodeURIComponent(fileText))); //javascript strings are utf16 encoded, but btoa only accespts ASCII, somehow the two extra functions here smooth over this problem and produce the expected result at the server end.\r\n    }\r\n    messageBody += close_delim;\r\n\r\n    var request = gapi.client.request({\r\n        path: '/upload/drive/v2/files/' + (fileId ? fileId : \"\"),\r\n        method: (fileId? 'PUT' : 'POST'),\r\n        params: {'uploadType': 'multipart'},\r\n        headers: {'Content-Type': 'multipart/mixed; boundary=\"' + boundary + '\"'} ,\r\n        body:   messageBody}\r\n        );\r\n\r\n    request.execute(callback);\r\n}\r\n\r\n*/\r\n// ############################\r\n// Clipboard stuff\r\n// ############################\r\n\r\ndn.document_clipboard_left = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index <= 0)\r\n            return true;\r\n        dn.clipboard_index--;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_right = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index >= dn.g_clipboard.length-1)\r\n            return true;\r\n\r\n        dn.clipboard_index++;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_keyup = function(e){\r\n    if(e.which == 17 || e.which == 91 || !e.ctrlKey){\r\n        $(document).off('keyup',dn.document_clipboard_keyup);\r\n        dn.clipboard_active = false;\r\n        dn.el.pane_clipboard.style.display = 'none';\r\n        if(dn.clipboard_info_timer){\r\n            clearTimeout(dn.clipboard_info_timer);\r\n            dn.clipboard_info_timer = null;\r\n        }\r\n    }\r\n}\r\n\r\ndn.on_paste = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    $(document).on('keyup',dn.document_clipboard_keyup);\r\n    dn.clipboard_active = true;\r\n        \r\n    dn.clipboard_index = dn.g_clipboard.lastIndexOf(text); \r\n    if(dn.clipboard_index == -1){ //it's possible the user copied some text from outside the DN, in which case we will add it to the clipboard now\r\n       dn.clipboard_index = dn.g_clipboard.push(text);\r\n       while(dn.g_clipboard.length >dn.clipboard_max_length) //same as on copy\r\n         dn.g_clipboard.remove(0);\r\n    }\r\n    if(dn.clipboard_info_timer)\r\n        clearTimeout(dn.clipboard_info_timer);\r\n\r\n    dn.clipboard_info_timer = setTimeout(function(){\r\n        dn.clipboard_info_timer = null;\r\n        dn.el.pane_clipboard.style.display = '';\r\n    },dn.clipboard_info_delay);\r\n}\r\n\r\ndn.on_copy = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    dn.g_clipboard.push(text);\r\n    while(dn.g_clipboard.length >dn.clipboard_max_length)\r\n        dn.g_clipboard.remove(0);\r\n}\r\n\r\ndn.create_clipboard_tool = function(){\r\n    dn.el.pane_clipboard = document.getElementById('pane_clipboard');\r\n    dn.el.button_clear_clipboard.addEventListener('click', function(){\r\n            dn.g_clipboard.clear();\r\n    });\r\n    dn.el.button_clear_find_replace.addEventListener('click', function(){\r\n            dn.g_find_history.clear();\r\n    });\r\n}\r\n\r\n\r\n// ############################\r\n// New file stuff\r\n// ############################\r\n\r\ndn.do_new = function(){\r\n    //TODO: this could actually just be a link, updated in settingschanged-ext\r\n    var base = window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0];\r\n    window.open(base + \"?state=\" + JSON.stringify({\r\n                action: \"create\",\r\n                folderId: dn.the_file.folder_id ? dn.the_file.folder_id : '',\r\n                ext: dn.g_settings.get('ext')}),\"_blank\");\r\n    return false;\r\n}\r\n\r\ndn.create_new_tool = function(){\r\n    dn.el.menu_new.addEventListener('click', dn.do_new);\r\n}\r\n\r\ndn.create_file = function(){\r\n    dn.apply_syntax_choice();\r\n    dn.the_file.is_brand_new = true;\r\n    dn.show_file_title();\r\n    dn.show_description();\r\n    dn.apply_newline_choice();\r\n    dn.apply_tab_choice();\r\n    dn.g_settings.set(\"pane\",\"pane_file\");  \r\n}\r\n\r\ndn.guess_mime_type = function(){\r\n    // we set the mimeType on new files, it's too complicated to try and guess it otherwise (at least for now)\r\n    if(dn.the_file.loaded_mime_type)\r\n        return dn.the_file.loaded_mime_type;\r\n    var plain = \"text/plain\";\r\n    var ext = dn.the_file.title.match(/\\.[0-9a-z]+$/i);\r\n\r\n    if(!ext)\r\n        return plain;\r\n    else\r\n        ext = ext[0].substr(1);\r\n    \r\n    return (ext in dn.ext_to_mime_type)? dn.ext_to_mime_type[ext] : plain;\r\n\r\n}\r\n\r\ndn.save_new_file = function(){\r\n    var f = dn.the_file;\r\n    if(f.is_saving){\r\n        dn.show_error(\"File is being created. Please wait.\");\r\n        return false;\r\n    }\r\n    var meta = {title: f.title, \r\n                description: f.description,\r\n                mimeType: dn.guess_mime_type()};\r\n    var parentId = f.folderId;\r\n    if(parentId) \r\n        meta.parentNodes =[{id:[parentId]}];\r\n    f.data_to_save.body = dn.editor.getSession().getValue();\r\n    f.data_to_save.title = meta.title;\r\n    f.data_to_save.description = meta.description;\r\n    var gens = {title: ++f.generation_to_save.title, description: ++f.generation_to_save.description,body: ++f.generation_to_save.body};\r\n    f.is_saving = true;\r\n    f.is_pristine = true;\r\n    dn.show_file_title();\r\n    dn.el.widget_pending.style.display = '';\r\n    dn.show_status();\r\n    dn.save_file(null, meta, f.data_to_save.body, $.proxy(dn.save_done,gens));\r\n}\r\n\r\ndn.saved_new_file = function(resp){\r\n    dn.the_file.is_brand_new = false;\r\n    dn.the_file.file_id = resp.id;\r\n    dn.the_file.is_shared = resp.shared;\r\n    dn.status.file_sharing = 1;\r\n    dn.the_file.ext = resp.fileExtension;\r\n    history.replaceState({},dn.the_file.title,\r\n            window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0] +\r\n                \"?state={\\\"action\\\":\\\"open\\\",\\\"ids\\\":[\\\"\" + dn.the_file.file_id + \"\\\"]}\");\r\n    dn.set_drive_link_to_folder();\r\n    dn.save_all_file_properties();\r\n}\r\n\r\n// ############################\r\n// Scrolling stuff\r\n// ############################\r\n\r\ndn.save_scroll_line = function(){\r\n    dn.patch_property(dn.the_file.file_id, \r\n                    \"ScrollToLine\",\r\n                    dn.get_scroll_line(),\r\n                    'PUBLIC',null);\r\n}\r\n\r\ndn.get_scroll_line = function(){\r\n    return  dn.editor.getSession().screenToDocumentPosition(dn.editor.renderer.getScrollTopRow(),0).row;\r\n}\r\n\r\n// ############################\r\n// Load stuff\r\n// ############################\r\n\r\n\r\n\r\ndn.show_file_meta = function(resp) {\r\n    if (resp.error)\r\n        throw Error(resp.error);\r\n    dn.the_file.title = resp.result.name;\r\n    dn.the_file.description = resp.result.description || '';\r\n    dn.show_description();\r\n    dn.the_file.ext = resp.result.fileExtension\r\n    dn.the_file.is_read_only = !resp.result.capabilities.canEdit;\r\n    dn.the_file.is_shared = resp.result.shared; \r\n    dn.the_file.loaded_mime_type = resp.result.mimeType;\r\n    if(resp.result.parents && resp.result.parents.length){\r\n        dn.the_file.folder_id = resp.result.parents[0];\r\n        dn.set_drive_link_to_folder();\r\n    }\r\n    dn.show_file_title(); //includes a showStatus call\r\n    dn.status.file_meta = 1;\r\n    dn.show_status();\r\n} \r\n\r\ndn.show_file_body = function(resp){\r\n    dn.setting_session_value = true;\r\n    dn.editor.session.setValue(resp.body);\r\n    dn.setting_session_value = false;\r\n    dn.apply_newline_choice(resp.body);\r\n    dn.apply_syntax_choice();\r\n    dn.apply_tab_choice(); \r\n    dn.status.file_body = 1;\r\n    dn.show_status();\r\n}\r\n\r\n\r\n// ############################\r\n// Change/history stuff\r\n// ############################\r\n\r\ndn.on_change = function(e){\r\n    //console.dir(e);\r\n\r\n    if(!e.start || !e.end || dn.setting_session_value)\r\n        return;\r\n        \r\n    if(dn.the_file.is_pristine){\r\n        dn.the_file.is_pristine = false;\r\n        dn.show_file_title();\r\n        dn.show_status();\r\n    }\r\n\r\n    if(!dn.g_settings.get('showGutterHistory'))\r\n        return;\r\n\r\n    var nClasses = dn.change_line_classes.length-1;\r\n    var h = dn.change_line_history;\r\n    var s = dn.editor.getSession(); \r\n\r\n    var start_row = e.start.row;\r\n    var end_row = e.end.row;\r\n\r\n    if(dn.last_change && dn.last_change.start_row == start_row && dn.last_change.end_row == end_row && start_row == end_row\r\n        && dn.last_change.action.indexOf(\"Text\") != -1 && e.action.indexOf(\"Text\") != -1){\r\n            //if this change and the last change were both on the same single lines with action (insert|remove)Text...\r\n\r\n            if(dn.last_change.action == e.action){\r\n                return; //same action as last time\r\n            }else if(e.action == \"removeText\"){ // new action is removeText, old action was insertText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                h[start_row] = -nClasses;\r\n                dn.last_change.action = \"removeText\";\r\n                return;\r\n            }else{// new action is isnertText, old action was removeText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                h[start_row] = nClasses;\r\n                dn.last_change.action = \"insertText\";\r\n                return;\r\n            }\r\n\r\n    }else{\r\n        //otherwise we have an acutal new change\r\n        dn.last_change = {start_row: start_row, end_row: end_row, action: e.action};\r\n    }\r\n\r\n    //remove all visible decorations and update the changeLineHistory values (we'll add in the new classes at the end)\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.removeGutterDecoration(i,h[i] < 0 ? \r\n                    dn.change_line_classes_rm[-h[i]++] : \r\n                    dn.change_line_classes[h[i]--]);\r\n\r\n    //Update the changeLineHistory relating to the current changed lines\r\n    if(e.action == \"removeLines\"){\r\n        h.splice(start_row, end_row - start_row + 1);        \r\n        h[start_row] = h[start_row+1] = -nClasses;\r\n    }else if(e.action === \"removeText\"){\r\n        h[start_row] = -nClasses;\r\n    }else{\r\n        var newLineCount = 0;\r\n        if(e.action == \"insertText\")\r\n            newLineCount = (e.text.match(/\\n/g) || []).length;\r\n        if(e.action == \"insertLines\")\r\n            newLineCount = e.lines.length;\r\n        h.splice.apply(h,[start_row,0].concat(Array(newLineCount)));\r\n\r\n        for(var i=start_row;i<=end_row;i++)\r\n            h[i] = nClasses;\r\n\r\n    }\r\n\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.addGutterDecoration(i,h[i]<0 ?\r\n                dn.change_line_classes_rm[-h[i]] :\r\n                dn.change_line_classes[h[i]]);\r\n} \r\n\r\ndn.query_unload = function(){\r\n    if(!dn.the_file.is_pristine)\r\n        return \"If you leave the page now you will loose the unsaved \" + (dn.the_file.is_brand_new ? \"new \" : \"changes to \") + \"file '\" + dn.the_file.title + \"'.\"\r\n}\r\n\r\n\r\n// ############################\r\n// Properties stuff\r\n// ############################\r\ndn.property_updated = function(propKey,new_val){\r\n    console.log(\"[file custom property]  \" + propKey + \": \" + new_val);\r\n    switch(propKey){\r\n        case \"newline\":\r\n            dn.apply_newline_choice();\r\n            break;\r\n        case \"tabs\":            \r\n            dn.apply_tab_choice();\r\n            break;\r\n        case \"aceMode\":\r\n            dn.apply_syntax_choice();\r\n            break;\r\n    }\r\n    \r\n}\r\n\r\ndn.load_default_properties = function(){\r\n    for(var k in dn.default_custom_props)\r\n        dn.set_property(k,dn.default_custom_props[k]);\r\n}\r\n\r\ndn.get_properties_from_cloud = function() {    \r\n    // TODO:\r\n    /*\r\n    gapi.client.drive.properties.list({\r\n    'fileId': dn.the_file.file_id\r\n    }).execute(dn.got_all_file_properties);*/\r\n}\r\n\r\ndn.got_all_file_properties = function(resp){\r\n    if(resp.items){\r\n        dn.the_file.custom_prop_exists = {};\r\n        for(var i=0;i<resp.items.length;i++){\r\n            dn.the_file.custom_props[resp.items[i].key] = resp.items[i].value;\r\n            dn.the_file.custom_prop_exists[resp.items[i].key] = true;\r\n            dn.property_updated(resp.items[i].key,resp.items[i].value);\r\n        }\r\n    }\r\n}\r\n\r\ndn.save_all_file_properties = function(){\r\n    //To be used after creating a file, in order to set any of the props which had been modified before saving it\r\n    for(var k in dn.the_file.custom_props)\r\n        dn.set_property(k,dn.the_file.custom_props[k]);    \r\n}\r\n\r\ndn.set_property = function(prop_name,new_val){\r\n\r\n    var oldVal = dn.the_file.custom_props[prop_name]; \r\n    dn.the_file.custom_props[prop_name] = new_val;\r\n    if(oldVal !== new_val)\r\n        dn.property_updated(prop_name,new_val);\r\n\r\n    if(!(gapi && gapi.drive && dn.the_file.file_id))\r\n        return;\r\n\r\n    var dummyCallback = function(){}; //TODO: may want to do some error handling or something\r\n    \r\n    if(dn.default_custom_props[prop_name] == new_val){ //note that this is true in particular when SetProperty is called within LoadDefaultProperties\r\n        if(dn.the_file.custom_prop_exists[prop_name]){\r\n             dn.the_file.custom_prop_exists[prop_name] = false;\r\n             gapi.client.drive.properties.delete({ //DELTE the property, which does exist, but is no longer required because the value has been set to the default\r\n                fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC'\r\n                }).execute(dummyCallback);\r\n        }\r\n        //if the property doesn't exist and it's just been set to the default then we don't need to do anything.\r\n    }else{            \r\n        if(dn.the_file.custom_prop_exists[prop_name] && oldVal !== new_val){\r\n            gapi.client.drive.properties.patch({ //PATCH the property, which already exists\r\n            fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC', resource: {'value': new_val}\r\n            }).execute(dummyCallback);\r\n        }else{\r\n            dn.the_file.custom_prop_exists[prop_name] = true; //INSERT the property, because it doesn't yet exist, we may be coming via dn.save_all_file_properties() above\r\n            gapi.client.drive.properties.insert({\r\n            'fileId': dn.the_file.file_id, 'resource': {key: prop_name, value: new_val, visibility: 'PUBLIC'}\r\n            }).execute(dummyCallback)\r\n        }\r\n    }\r\n}\r\n\r\n\r\n// ############################\r\n// Drag-drop stuff\r\n// ############################\r\n//TODO: this may have a few bugs since it's not been tested for a while\r\n\r\ndn.document_drag_over = function (evt) {\r\n    evt = evt.originalEvent;\r\n    evt.stopPropagation();\r\n    evt.preventDefault();\r\n    if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine)){\r\n        evt.dataTransfer.dropEffect = 'none';\r\n        if(dn.can_show_drag_drop_error){\r\n            dn.show_error(\"File drag-drop is only permitted when the Drive Notpad page is displaying a new and unmodified file.\")\r\n            dn.can_show_drag_drop_error = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n            setTimeout(function(){dn.can_show_drag_drop_error = true;},dn.error_delay_ms);\r\n        }\r\n        return;\r\n    }\r\n    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.\r\n}\r\n    \r\ndn.document_drop_file = function(evt){\r\n     if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine))\r\n        return;\r\n        \r\n   evt = evt.originalEvent;\r\n   evt.stopPropagation();\r\n   evt.preventDefault();\r\n   \r\n   var files = evt.dataTransfer.files;\r\n   if(files.length > 1){\r\n       dn.show_error(\"You cannot drag-drop multiple files onto the Drive Notepad page, only individual files.\")\r\n   }\r\n   var file = files[0];\r\n   dn.the_file.title = file.name;\r\n   dn.create_file();\r\n   dn.the_file.isReading_file_object = true;   \r\n   dn.show_status();\r\n   var r = new FileReader();\r\n   r.onload = dn.dropped_file_read;\r\n   r.readAsText(file);      \r\n}\r\n\r\ndn.dropped_file_read = function(e){\r\n    dn.the_file.isReading_file_object = false;\r\n    dn.editor.getSession().setValue(e.target.result);\r\n    // Note we don't encolse the above in a dn.setting_session_value = true block so the change event will fire and set pristine to false and ShowStatus etc.\r\n}\r\n\r\n// ############################\r\n// Page ready stuff\r\n// ############################\r\n\r\n\r\n\r\ndn.document_ready = function(e){\r\n\r\n    // widget :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.the_widget = document.getElementById('the_widget');\r\n    dn.el.widget_text = document.getElementById('widget_text');\r\n    dn.el.widget_error_text = document.getElementById('widget_error_text');\r\n    dn.el.widget_error = document.getElementById('widget_error');\r\n    dn.el.widget_content = document.getElementById('widget_content');\r\n    dn.el.widget_pending = document.getElementById('widget_pending');\r\n    dn.el.the_widget.addEventListener('mousedown', dn.widget_mouse_down);\r\n    translate(dn.el.the_widget, 0, 0);\r\n    dn.el.the_widget.style.display = '';\r\n    dn.el.widget_error.style.display = 'none';\r\n    dn.el.widget_content.addEventListener('mousedown', function(e){\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    });\r\n    var els = dn.el.widget_content.getElementsByTagName('input');\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].addEventListener('mousedown', stop_propagation); // prevents propagation to preventDefault, installed above.\r\n\r\n    // editor :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    var editor_el = document.getElementById('the_editor');\r\n    editor_el.innerHTML = '';\r\n    editor_el.addEventListener('contextmenu', function(e){\r\n        dn.show_error(\"See the list of keyboard shortcuts for copy/paste, select-all, and undo/redo.\")\r\n    });\r\n    dn.editor = ace.edit(\"the_editor\");\r\n    dn.editor.setHighlightSelectedWord(true);\r\n    dn.el.ace_content = document.getElementsByClassName('ace_content')[0];\r\n    dn.editor.getSession().addEventListener(\"change\", dn.on_change);\r\n    dn.focus_editor = dn.editor.focus.bind(dn.editor);\r\n    dn.focus_editor();\r\n    dn.editor.on(\"paste\", dn.on_paste);\r\n    dn.editor.on(\"copy\", dn.on_copy);\r\n    dn.editor.setAnimatedScroll(true);\r\n    dn.editor.$blockScrolling = Infinity; // disables scrolling message\r\n    \r\n    // widget menu ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.widget_menu = document.getElementById('widget_menu');\r\n    dn.el.menu_open = document.getElementById('menu_open');\r\n    dn.el.menu_find = document.getElementById('menu_find');\r\n    dn.el.menu_help = document.getElementById('menu_help');\r\n    dn.el.menu_file = document.getElementById('menu_file');\r\n    dn.el.menu_general_settings = document.getElementById('menu_general_settings');\r\n    dn.el.widget_menu.addEventListener('mousedown', stop_propagation);\r\n    dn.menu_icon_from_pane_id = {}\r\n    var els = dn.el.widget_menu.getElementsByClassName('widget_menu_icon');\r\n    for(var ii=0; ii<els.length; ii++){\r\n        els[ii].addEventListener(\"mousedown\", prevent_default);\r\n        els[ii].title = dn.menu_id_to_caption[els[ii].id];\r\n        dn.menu_icon_from_pane_id['pane_' + els[ii].id.substr(5)] = els[ii];\r\n    }\r\n\r\n     // pane file ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_file = document.getElementById('pane_file');\r\n    dn.el.details_title_input  = document.getElementById('details_file_title_input');\r\n    dn.el.details_title_text = document.getElementById('details_file_title_text');\r\n    dn.el.details_description_input  = document.getElementById('details_file_description_input');\r\n    dn.el.details_description_text = document.getElementById('details_file_description_text');    \r\n    dn.el.file_ace_mode_choose = document.getElementById('file_ace_mode_choose')\r\n    dn.el.file_ace_mode_detect = document.getElementById('file_ace_mode_detect');\r\n    dn.el.file_ace_mode_info = document.getElementById('file_ace_mode_info');\r\n    dn.el.file_newline_detect = document.getElementById('file_newline_detect');\r\n    dn.el.file_newline_windows = document.getElementById('file_newline_windows');\r\n    dn.el.file_newline_unix = document.getElementById('file_newline_unix');\r\n    dn.el.file_newline_info = document.getElementById('file_newline_info');\r\n    dn.el.file_tab_detect = document.getElementById('file_tab_detect');\r\n    dn.el.file_tab_hard = document.getElementById('file_tab_hard');\r\n    dn.el.file_tab_soft = document.getElementById('file_tab_soft');\r\n    dn.el.file_tab_soft_text = document.getElementById('file_tab_soft_text');\r\n    dn.el.file_tab_info = document.getElementById('file_tab_info');\r\n    dn.el.button_save = document.getElementById('button_save');\r\n    dn.el.button_print = document.getElementById('button_print');\r\n    dn.el.button_share = document.getElementById('button_share');\r\n    dn.el.button_history = document.getElementById('button_history');     \r\n    dn.syntax_drop_down = dn.create_syntax_menu();   // TODO: tidy up\r\n    dn.el.file_ace_mode_choose.appendChild(dn.syntax_drop_down.el);\r\n    dn.create_file_details_tool();\r\n    dn.el.menu_file.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_file');\r\n    })\r\n\r\n     // pane general settings :::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_general_settings = document.getElementById('pane_general_settings');\r\n    dn.el.theme_chooser = document.getElementById('theme_chooser')\r\n    dn.el.widget_sub_general_box = document.getElementById('sub_general_box')\r\n    dn.el.button_clear_clipboard = document.getElementById(\"button_clear_clipboard\");\r\n    dn.el.button_clear_find_replace = document.getElementById(\"button_clear_find_replace\");\r\n    dn.el.gutter_history_show = document.getElementById('gutter_history_show');\r\n    dn.el.gutter_history_hide = document.getElementById('gutter_history_hide');\r\n    dn.el.word_wrap_off = document.getElementById('word_wrap_off');\r\n    dn.el.word_wrap_at = document.getElementById('word_wrap_at');\r\n    dn.el.word_wrap_edge = document.getElementById('word_wrap_edge');\r\n    dn.el.font_size_decrement = document.getElementById('font_size_decrement');\r\n    dn.el.font_size_increment = document.getElementById('font_size_increment');\r\n    dn.el.font_size_text = document.getElementById('font_size_text');\r\n    dn.el.tab_hard = document.getElementById('tab_hard');\r\n    dn.el.tab_soft = document.getElementById('tab_soft');\r\n    dn.el.newline_menu_windows = document.getElementById('newline_menu_windows');\r\n    dn.el.newline_menu_unix = document.getElementById('newline_menu_unix');\r\n    dn.el.tab_soft_text = document.getElementById('tab_soft_text');\r\n    dn.el.tab_soft_dec = document.getElementById('tab_soft_dec');\r\n    dn.el.tab_soft_inc = document.getElementById('tab_soft_inc');\r\n    dn.el.word_wrap_at_text = document.getElementById('word_wrap_at_text');\r\n    dn.el.word_wrap_at_dec = document.getElementById('word_wrap_at_dec');\r\n    dn.el.word_wrap_at_inc = document.getElementById('word_wrap_at_inc');\r\n    dn.theme_drop_down = dn.create_theme_menu()  // TODO: tidy this up\r\n    dn.el.theme_chooser.appendChild(dn.theme_drop_down.el);\r\n    dn.el.newline_menu_windows.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'windows');\r\n    });\r\n    dn.el.newline_menu_unix.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'unix');\r\n    });\r\n    dn.el.tab_hard.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 1)\r\n    });\r\n    dn.el.tab_soft.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 0);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') - 1;\r\n        at = at < dn.min_soft_tab_n ? dn.min_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') + 1;\r\n        at = at > dn.max_soft_tab_n ? dn.max_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.font_size_decrement.addEventListener('click', dn.font_size_decrement_click);\r\n    dn.el.font_size_increment.addEventListener('click', dn.font_size_increment_click);    \r\n    dn.el.word_wrap_off.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[0,0,0])\r\n    });\r\n    dn.el.word_wrap_at.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt');\r\n        dn.g_settings.set('wordWrap',[1,at,at]);\r\n    });\r\n    dn.el.word_wrap_at_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') - dn.wrap_at_increment;\r\n        at = at < dn.min_wrap_at ? dn.min_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_at_inc.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') + dn.wrap_at_increment;\r\n        at = at > dn.max_wrap_at ? dn.max_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_edge.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[1,null,null])\r\n    });\r\n    dn.el.gutter_history_show.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',1);\r\n    });\r\n    dn.el.gutter_history_hide.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',0);\r\n    });\r\n    dn.create_clipboard_tool();\r\n    dn.el.menu_general_settings.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_general_settings');\r\n    })\r\n\r\n    // pane permissions :::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_permissions = document.getElementById('pane_permissions');\r\n    document.getElementById('button_auth').addEventListener('click', dn.reauth_manual);\r\n\r\n    // pane help ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_help = document.getElementById('pane_help');\r\n    dn.el.user_name = document.getElementById('user_name');\r\n    dn.el.pane_help_shortcuts = document.getElementById('pane_help_shortcuts');\r\n    dn.el.pane_help_tips = document.getElementById('pane_help_tips');\r\n    dn.el.pane_help_main = document.getElementById('pane_help_main');\r\n    dn.el.button_shortcuts = document.getElementById('button_view_shortcuts');\r\n    dn.el.button_tips = document.getElementById('button_view_tips');\r\n    dn.el.button_shortcuts.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'shortcuts')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'shortcuts');\r\n    })\r\n    dn.el.button_tips.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'tips')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'tips');\r\n    })\r\n    dn.el.menu_help.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_help');\r\n    })\r\n    dn.create_pane_shortcuts();\r\n\r\n    // pane find ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::    \r\n    dn.el.pane_find = document.getElementById('pane_find');\r\n    dn.el.find_button_case_sensitive = document.getElementById('button_find_case_sensitive');\r\n    dn.el.find_button_whole_words = document.getElementById('button_find_whole_words');\r\n    dn.el.find_button_regex = document.getElementById('button_find_regex');\r\n    dn.el.find_input = document.getElementById('find_input');\r\n    dn.el.find_goto_input = document.getElementById('goto_input');\r\n    dn.el.find_replace_input = document.getElementById('find_replace_input');\r\n    dn.el.find_info = document.getElementById('find_info');\r\n    dn.el.find_results = document.getElementById('find_results');\r\n    dn.el.find_info_overflow = document.getElementById('find_info_overflow');\r\n    dn.el.button_goto = document.getElementById('button_goto');\r\n    dn.el.button_replace = document.getElementById('button_replace');\r\n    dn.el.find_goto_wrapper = document.getElementById('find_goto_wrapper');\r\n    dn.el.find_find_wrapper = document.getElementById('find_find_wrapper');\r\n    dn.el.find_replace_wrapper = document.getElementById('find_replace_wrapper');\r\n    dn.el.button_find_replace_all = document.getElementById('button_find_replace_all');\r\n    dn.el.find_button_case_sensitive.addEventListener('click', function(){\r\n        dn.g_settings.set('find_case_sensitive', !dn.g_settings.get('find_case_sensitive'));\r\n    })\r\n    dn.el.find_button_whole_words.addEventListener('click', function(){\r\n        dn.g_settings.set('find_whole_words', !dn.g_settings.get('find_whole_words'));\r\n    })\r\n    dn.el.find_button_regex.addEventListener('click', function(){\r\n        dn.g_settings.set('find_regex', !dn.g_settings.get('find_regex'));\r\n    })\r\n    dn.el.menu_find.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_find');\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    });\r\n    dn.el.find_goto_input.addEventListener('keydown', dn.find_goto_input_keydown);\r\n    dn.el.find_goto_input.addEventListener('keyup', dn.find_goto_input_keyup);\r\n    dn.el.find_goto_input.addEventListener('blur', dn.find_goto_input_blur);\r\n    dn.el.find_goto_input.addEventListener('focus', dn.find_goto_input_focus);\r\n    dn.el.find_input.addEventListener('keyup', dn.find_input_keyup);\r\n    dn.el.find_input.addEventListener('keydown', dn.find_input_keydown);\r\n    dn.el.find_input.addEventListener('blur', dn.find_inputs_blur);\r\n    dn.el.find_input.addEventListener('focus', dn.find_inputs_focus);\r\n    dn.el.find_replace_input.addEventListener('blur', dn.find_inputs_blur);\r\n    dn.el.find_replace_input.addEventListener('focus', dn.find_inputs_focus);\r\n    dn.el.find_replace_input.addEventListener('keydown', dn.find_replace_input_keydown);\r\n    dn.el.button_find_replace_all.addEventListener('click', dn.find_replace_click);\r\n    dn.el.button_replace.addEventListener('click', function(){\r\n        dn.g_settings.set('find_replace', !dn.g_settings.get('find_replace'));\r\n        dn.g_settings.set('find_goto', false);\r\n        dn.el.find_input.focus();\r\n    })\r\n    dn.el.button_goto.addEventListener('click', function(){\r\n        dn.g_settings.set('find_goto', !dn.g_settings.get('find_goto'));\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    })\r\n\r\n    // pane open ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_open = document.getElementById('pane_open');\r\n    dn.el.opener_button_a = document.getElementById('opener_button_a');\r\n    dn.el.menu_open.addEventListener('click', function(){    \r\n        dn.g_settings.set('pane', 'pane_open');\r\n    });\r\n    dn.el.opener_button_a.addEventListener('click', dn.open_button_click);\r\n\r\n    // :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.make_keyboard_shortcuts();\r\n    dn.load_default_settings();\r\n    dn.load_default_properties();    \r\n    document.addEventListener('contextmenu', prevent_default);\r\n    document.addEventListener('dragover', dn.document_drag_over);\r\n    document.addEventListener('drop', dn.document_drop_file);\r\n    window.addEventListener('resize', dn.widget_apply_anchor);\r\n    window.onbeforeunload = dn.query_unload;\r\n\r\n    //work out what caused the page to load\r\n    var params = window_location_to_params_object(); \r\n    if(params['state']){\r\n        var state = {};\r\n        try{\r\n            state = JSON.parse(params['state']);    \r\n        }catch(e){\r\n            dn.show_error(\"Bad URL params:\\n\" + params['state']);\r\n        }\r\n        if(state.action && state.action == \"open\" && state.ids && state.ids.length > 0){\r\n            dn.the_file.file_id = state.ids[0];\r\n        }else if(state.action && state.action == \"create\"){\r\n            dn.the_file.title = \"untitled.\" + (state.ext ? state.ext : dn.g_settings.get('ext'));\r\n            if(state.folderId)\r\n                dn.the_file.folder_id = state.folderId;\r\n            dn.create_file(); //will use the specified title and folderId\r\n        }\r\n    }else{\r\n        dn.the_file.title = \"untitled.\" + dn.g_settings.get('ext');\r\n        dn.create_file();\r\n    }\r\n\r\n    dn.show_status(); \r\n\r\n    // The auth promise can be rejected and resolved multiple times during the lifetime of the app.\r\n    // These two handlers will always be called for those events.\r\n    dn.pr_auth.on_error(dn.handle_auth_error); \r\n    dn.pr_auth.on_success(function(){\r\n        // reset some things, could be no-ops...\r\n        dn.reauth_auto_delay = 0;\r\n        dn.toggle_permission(false);\r\n        dn.status.popup_active = 0;\r\n\r\n        // and show the good news...\r\n        dn.status.authentication = 1;\r\n        dn.show_status(); \r\n    })\r\n\r\n    // get user info...\r\n    until_success(function(succ, fail){\r\n        Promise.resolve(dn.pr_auth)\r\n               .then(dn.request_user_info)\r\n               .then(dn.show_user_info)\r\n               .then(succ, fail);\r\n    }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n    .then(function(){\r\n        console.log('succeeded getting user info.')\r\n    })\r\n\r\n    if(dn.the_file.file_id){\r\n\r\n        // meta data...\r\n        var pr_meta = until_success(function(succ, fail){\r\n            Promise.resolve(dn.pr_auth)\r\n                   .then(dn.request_file_meta)\r\n                   .then(dn.show_file_meta)\r\n                   .catch(function(err){\r\n                        if(dn.is_auth_error(err)) throw err; // auth error, until_success will handle it\r\n                        // meta-data specific error, which we will rebrand as a \"success\"\r\n                        dn.show_error(err.result.error.message);\r\n                        dn.status.file_meta = -1;\r\n                        dn.show_status();\r\n                        return 'bad_meta'\r\n                   }).then(succ, fail);\r\n        }, dn.pr_auth.reject.bind(dn.pr_auth));\r\n\r\n        // body...\r\n        var pr_body = until_success(function(succ, fail){\r\n            Promise.resolve(dn.pr_auth)\r\n                   .then(dn.request_file_body)\r\n                   .then(dn.show_file_body)\r\n                    .catch(function(err){\r\n                        if(dn.is_auth_error(err)) throw err; // auth error, until_success will handle it\r\n                        // body specific error, which we will rebrand as a \"success\"\r\n                        dn.show_error(err.result.error.message);\r\n                        dn.status.file_body = -1;\r\n                        dn.show_status();\r\n                        return 'bad_body'\r\n                   }).then(succ, fail);\r\n        }, dn.pr_auth.reject.bind(dn.pr_auth));\r\n\r\n        // load meta data and body...\r\n        Promise.all([pr_meta, pr_body])\r\n            .then(function(vals){\r\n                if(vals[0] == 'bad_meta' || vals[1] == 'bad_body')\r\n                    throw \"did not load file\"\r\n                return true;\r\n            }).then(function(){\r\n                console.log(\"succeeded loading file body and metadata.\")\r\n            }, function(){\r\n                document.title = \"Drive Notepad\";\r\n                dn.g_settings.set('pane', 'pane_help');\r\n                dn.g_settings.set('pane_open', true);\r\n            });\r\n    }\r\n    \r\n    // load settings...\r\n    until_success(function(succ, fail){ \r\n        Promise.all([dn.pr_auth, dn.pr_realtime_loaded])\r\n               .then(dn.request_app_data_document)\r\n               .then(dn.show_app_data_document)\r\n               .then(succ, fail)\r\n    }, dn.pr_auth.reject.bind(dn.pr_auth))\r\n    .then(function(){\r\n        console.log('succeeded loading settings');\r\n    });\r\n    \r\n    \r\n}\r\n\r\n\r\nif (document.readyState != 'loading')\r\n    dn.document_ready();\r\nelse\r\n    document.addEventListener('DOMContentLoaded', dn.document_ready);\r\n\r\n\r\n    "]}