{"version":3,"sources":["node_modules/keymaster/keymaster.js","js/utils.js","js/drop_down.js","js/info.js","js/revisions_main_thread.js","js/find_replace.js","js/keyboard.js","js/app.js"],"names":["global","k","_handlers","_mods",16,18,17,91,"_scope","_MODIFIERS","⇧","shift","⌥","alt","option","⌃","ctrl","control","⌘","command","_MAP","backspace","tab","clear","enter","return","esc","escape","space","left","up","right","down","del","delete","home","end","pageup","pagedown",",",".","/","`","-","=",";","'","[","]","\\","code","x","toUpperCase","charCodeAt","_downKeys","index","array","item","i","length","compareArray","a1","a2","modifierMap","updateModifierKey","event","dispatch","key","handler","modifiersMatch","scope","keyCode","push","assignKey","filter","call","this","getScope","mods","method","preventDefault","returnValue","stopPropagation","cancelBubble","clearModifier","splice","resetModifiers","keys","getKeys","undefined","split","getMods","shortcut","unbindKey","multipleKeys","j","obj","isPressed","getPressedKeyCodes","slice","tagName","target","srcElement","setScope","deleteScope","handlers","replace","mi","addEvent","object","addEventListener","attachEvent","window","document","previousKey","noConflict","unbind","module","exports","oxford_comma","arr","rotate","el","deg","style","transform","webkitTansform","mozTransform","translate","y","str","webkitTransform","text_multi","text","truncate_long_words","textContent","innerHTML","escape_str","css_animation","timers","els","cls","callback","delay","classList","remove","offsetTop","old_idx","indexOf","clearTimeout","setTimeout","add","stop_propagation","e","prevent_default","DropDown","val_array","map","val","join","el_list","createElement","className","tabindex","display","el_collapsed","appendChild","ind","event_callbacks","open","dd","document_mousedown","trigger","removeEventListener","parentNode","focus","scrollTop","children","on_click","SetInd","getAttribute","ii","setAttribute","FakeEvent","is_stopped","prototype","stopImmediatePropagation","evt","func","args","fe","IndexOf","GetVal","no_trigger","parseInt","title","isOpen","SetSelected","v","dn","menu_id_to_caption","menu_print","menu_sharing","menu_save","menu_history","menu_file","menu_new","menu_open","menu_find","menu_goto","menu_general_settings","menu_shortcuts","menu_drive","menu_help","shortcuts_list","ext_to_mime_type","html","htm","js","pl","xml","c","cpp","h","json","php","svg","css","java","py","scala","textile","tex","bib","rtf","rtx","sh","sql","as","tooltip_info","save","print","sharing","file history","drive","about","shortcuts","new","settings_file","settings_general","description","WHICH","ENTER","ESC","UP","DOWN","default_settings","ext","wordWrap","wordWrapAt","fontSize","widget_anchor","showGutterHistory","lastDNVersionUsed","newLineDefault","historyRemovedIsExpanded","softTabN","tabIsHard","widgetSub","theme","pane","pane_open","find_regex","find_whole_words","find_case_sensitive","help_inner","find_goto","find_replace","default_custom_props","newline","tabs","aceMode","impersonal_settings_keys","drag_delay_ms","drag_shift_px","min_font_size","max_font_size","max_wrap_at","min_wrap_at","wrap_at_increment","max_soft_tab_n","min_soft_tab_n","detect_tabs_spaces_frac","detect_tabs_tabs_frac","detect_tabs_n_spaces_frac","detect_tabs_n_spaces_frac_for_default","font_size_increment","icon_mouse_over_ms","editor_refocus_time_ms","error_delay_ms","find_history_add_delay","clipboard_info_delay","clipboard_max_length","find_max_results_half","find_max_prefix_chars","find_max_suffix_chars","close_history","file_history","$revisions_display","revisions_window_resize","getElementById","editor","resize","is_showing_history","canShowResizeError","show_error","start_revisions_worker","the_file","is_brand_new","widget_content","widget_file_history","getElementsByClassName","$","$view","$new_li","$new_tick","needToRefindViewChildren","$rev_lines_","needToFixHeights","$timeline","$d","find","$revisions_status","$revision_caption_from","$revision_caption_at","$expand_removed","$collapse_removed","revisions","revisionFromEtag","at","from","worker","Worker","g_settings","set","revision_setis_expaned","get","w","onmessage","revision_worker_delivery","postMessage","fileId","file_id","token","gapi","auth","getToken","access_token","init","appendTo","on","empty","revision_set_at","r","fromChangeEvent","fromTimelineCreation","$at_range","value","modifiedDate","toLocaleDateString","month","day","year","toLocaleTimeString","hour","minute","showEtag","etag","fromEtag","revision_set_from","$from_range","display_revision_timeline","newRevisions","rs","$tick_box","attr","t","downloaded","isDownloaded","Array","apply","$ticks","insertClonedChildren","eq","append","data","debug","console","log","status","forEach","revisionDownloaded","revsionDiffed","isDiffed","newStuff","newStuffForDom","lines","vals_ui8buffer","$rl_","fixHeightFromAuto","vals","Uint8Array","digits","find_goto_changed","new_value","find_goto_wrapper","find_find_wrapper","button_goto","find_info","find_replace_wrapper","find_replace_changed","button_replace","find_inputs_have_focus","find_select_result_idx","find_current_match_idx","find_goto_input_has_focus","find_goto_input_focus","find_perform_goto","find_goto_input_blur","relatedTarget","focus_editor","validated_str","find_goto_input","num","gotoLine","navigateLineEnd","find_goto_input_keyup","find_goto_input_keydown","which","find_results","find_markers","find_marker_current","find_str","find_inputs_focus","currentTarget","find_input","tabIndex","find_replace_input","AceSearch","ace","require","Search","AceRange","Range","setHighlightSelectedWord","find_perform_search","find_inputs_blur","session","getSession","removeMarker","find_info_overflow","setSelectionRange","selectionEnd","find_build_options","use_reg_exp","sensitive","re","RegExp","needle","wrap","caseSensitive","wholeWord","regExp","search_options","message","selection","clearSelection","search","setOptions","results","findAll","selected_range","getSelection","getRange","row","start","column","current_match_idx","addMarker","range","idx","results_sub","replace_is_showing","max_results","n_pre","n_post","concat","show_replace_buttons","col","prefix_range","Math","max","pre_ellipses","suffix_range","getTextRange","find_result_click","find_replace_result_click","renderer","scrollSelectionIntoView","find_settings_changed","find_replace_result_idx","find_input_keyup","find_input_keydown","shiftKey","ctrlKey","find_replace_input_keydown","find_replace_all","options","replaceAll","find_replace_click","$search","$tryReplace","platform","navigator","create_pane_shortcuts","arry","dict","parts","action","pane_help_shortcuts","esc_pressed","find_shortcut_used","sel","getSelectionRange","select","find_goto_shortcut_used","show_replace_shortcut_used","make_keyboard_shortcuts","commands","removeCommands","save_content","do_print","do_open","do_new","HashHandler","extraKeyEvents","bindKey","win","mac","descr","exec","document_clipboard_left","document_clipboard_right","keyBinding","addKeyboardHandler","ctrl_key","version_str","can_show_drag_drop_error","file_body","file_meta","file_sharing","authentication","popup_active","local_settings","folder_id","loaded_mime_type","new_line_detected","tab_detected","is_pristine","mime_type","is_saving","data_to_save","body","generation_to_save","is_read_only","is_shared","is_reading_file_object","custom_props","custom_prop_exists","saving_title_count","change_line_history","last_change","change_line_classes","rootStr","trueN","factor","change_line_classes_rm","authentication_done","auth_result","authentication_failed","error","show_status","user_info","get_user_info","load_file","get_properties_from_cloud","load","get_settings_from_cloud","Promise","resolve","client","request","path","then","a","result","user_name","name","err","dir","authorization","show_pane_permissions","reauth","authorize","auth_map","launch_popup","the_widget","do_share","share_dialog","do_share_sub","share","ShareClient","client_id","setItemIds","setOAuthToken","showSettingsDialog","detect_new_line","first_n","show_newline_status","has_rn","has_solo_n","match","apply_newline_choice","newlineDefault","newline_menu_windows","newline_menu_unix","file_newline_detect","file_newline_windows","file_newline_unix","setNewLineMode","statusStr","file_newline_info","new_window_content","open_button_click","view","google","picker","View","ViewId","DOCS","open_picker","PickerBuilder","enableFeature","Feature","NAV_HIDDEN","setAppId","addView","setCallback","picker_callback","build","setVisible","Action","PICKED","docs","id","url","JSON","stringify","userId","url_user_id","ids","location","open_new_tab","close","show_help_inner","inner_pane","pane_help_tips","pane_help_main","button_shortcuts","button_tips","show_pane","el_icon","menu_icon_from_pane_id","widget_mouse_down","widget_mouse_down_info","off_left","clientX","off_top","clientY","start_time","Date","now","is_dragging","button","document_mouse_move_widget","document_mouse_up_widget","pos","getBoundingClientRect","widget_w","offsetWidth","widget_h","offsetHeight","window_w","innerWidth","window_h","innerHeight","anchor","top","widget_apply_anchor","isArray","widget_menu","bottom","toggle_widget","state","s","extra","widget_text","widget_error_text","widget_error","set_drive_link_to_folder","href","realtime","loadAppDataDocument","doc","old_temp_g_settings","getModel","getRoot","g_clipboard","createList","g_find_history","existingKeys","EventType","VALUE_CHANGED","settings_changed","getKeeps","property","newValue","resp","arguments","type","load_default_settings","ob","keeps","keep","localStorage","parse","setTheme","theme_drop_down","scrollLine","get_scroll_line","font_size_text","toFixed","setFontSize","scrollToLine","setUseWrapMode","setWrapLimitRange","word_wrap_off","word_wrap_edge","word_wrap_at","word_wrap_at_text","curWrap","setPrintMarginColumn","gutter_history_show","gutter_history_hide","removeGutterDecoration","apply_tab_choice","find_button_regex","find_button_whole_words","find_button_case_sensitive","font_size_decrement_click","font_size","font_size_increment_click","detect_tab","getLines","indents","show_tab_status","stats","reduce","nWithMixture","nWithOnlyTabs","spaceHist","nSamp","nWithOnlySpaces","spaceModHist","m","defaultNSpaces","n","isDefault","threshold","d","defaultStr","file_tab_info","defaultTabIsHard","defaultSoftTabN","isHard","nSpaces","isDetected","setUseSoftTabs","setTabSize","tab_soft_text","tab_hard","tab_soft","file_tab_detect","file_tab_hard","file_tab_soft","file_tab_soft_text","set_file_tabs_to_soft_or_hard","delta","f","current","newT","set_property","show_syntax_status","syntax","file_ace_mode_info","detect_syntax","syntax_detected","mode","getModeForPath","caption","apply_syntax_choice","set_syntax","file_ace_mode_detect","syntax_drop_down","get_current_syntax_name","modesArray","modesByName","getMode","$id","pop","modes","setMode","create_theme_menu","themes","Object","themesByName","create_syntax_menu","read_only_bail","create_file_details_tool","details_title_text","details_description_text","details_title_input","new_val","show_file_title","save_file_title","ignore_escape","button_save","button_print","button_share","button_history","details_description_input","show_description","save_file_description","save_new_file","save_file","proxy","save_done","getValue","widget_pending","do_save","gens","meta","failures","fileExtension","saved_new_file","fileMetadata","fileText","boundary","make_boundary","delimiter","close_delim","messageBody","btoa","unescape","encodeURIComponent","params","uploadType","headers","Content-Type","execute","getTime","random","content","getAllLines","line_to_html","printWindow","writeln","cssText","printLayer","create","Text","tokens","getTokens","screenColumn","$renderToken","clipboard_active","clipboard_index","undo","insert","document_clipboard_keyup","off","pane_clipboard","clipboard_info_timer","on_paste","lastIndexOf","on_copy","create_clipboard_tool","button_clear_clipboard","button_clear_find_replace","base","folderId","create_new_tool","create_file","guess_mime_type","plain","substr","mimeType","parentId","parentNodes","shared","history","replaceState","save_all_file_properties","save_scroll_line","patch_property","screenToDocumentPosition","getScrollTopRow","flag","promise_get_meta","fields","load_file_got_meta_data","promise_get_body","load_file_got_file_body","pr_the_file","all","Error","capabilities","canEdit","parents","setting_session_value","setValue","on_change","nClasses","start_row","end_row","addGutterDecoration","newLineCount","query_unload","property_updated","propKey","load_default_properties","got_all_file_properties","items","prop_name","oldVal","dummyCallback","properties","propertyKey","visibility","patch","resource","document_drag_over","originalEvent","dataTransfer","dropEffect","document_drop_file","files","file","isReading_file_object","FileReader","onload","dropped_file_read","readAsText","document_ready","getElementsByTagName","editor_el","edit","ace_content","setAnimatedScroll","$blockScrolling","Infinity","pane_file","file_ace_mode_choose","pane_general_settings","theme_chooser","widget_sub_general_box","font_size_decrement","tab_soft_dec","tab_soft_inc","word_wrap_at_dec","word_wrap_at_inc","pane_permissions","pane_help","pane_find","button_find_replace_all","opener_button_a","onbeforeunload","window_location_to_params_object","pr_auth","readyState"],"mappings":"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,OAAO,YChH5C,aAEAsD,IAAGC,oBACHC,WAAc,QACdC,aAAgB,UAChBC,UAAa,OACbC,aAAgB,UAChBC,UAAa,eACbC,SAAY,MACZC,UAAa,WACbC,UAAa,eACbC,UAAa,YACbC,sBAAyB,mBACzBC,eAAkB,YAClBC,WAAc,QACdC,UAAa,aAGbd,IAAGe,gBACH,mBACA,oBACA,yBACA,yFACA,8BACA,oBACA,iBACA,0BACA,wBACA,qDACA,MACA,oBACA,wBACA,+BACA,gCACA,mBACA,oBACA,OACA,uBACA,4BACA,yKACA,oDACA,8CACA,2BACA,0BACA,wCACA,wDACA,wDACA,0DACA,kDACA,qCACA,wDACA,wCACA,2CACA,aACA,oBACA,mBACA,+BACA,6BACA,wCACA,qDACA,gCACA,qBACA,kCACA,2BAGAf,IAAGgB,kBACHC,KAAK,YACLC,IAAI,YACJC,GAAG,kBACHC,GAAG,qBACHC,IAAI,WACJC,EAAE,cACFC,IAAI,gBACJC,EAAE,cACFC,KAAK,mBACLC,IAAI,oBACJC,IAAI,YACJC,IAAI,WACJC,KAAK,cACLC,GAAG,gBACHC,MAAM,QACNC,QAAQ,UACRC,IAAI,oBACJC,IAAI,oBACJC,IAAI,kBACJC,IAAI,kBACJC,GAAG,mBACHC,IAAI,aACJC,GAAG,sBAIHvC,IAAGwC,cACCC,KAAS,wBACTC,MAAS,kCACTC,QAAW,yCACXC,eAAgB,8BAChBC,MAAS,oCACTC,MAAS,yBACTC,UAAa,sBACbC,MAAO,kCACP9E,KAAQ,yBACR+E,cAAiB,kCACjBC,iBAAoB,0CACpBtD,MAAS,kCACTuD,YAAe,wCAInB,IAAIC,QACJC,MAAO,GACPC,IAAK,GACLC,GAAI,GACJC,KAAM,GAGNxD,IAAGyD,kBACHC,IAAK,MACLC,UAAW,KAAK,KAAK,MACrBC,WAAY,GACZC,SAAU,EACVC,eAAgB,IAAI,GAAG,IAAI,IAC3BC,kBAAmB,EACnBC,kBAAmB,GACnBC,eAAgB,UAChBC,yBAA0B,KAC1BC,SAAU,EACVC,UAAW,EACXC,UAAW,UACXC,MAAO,SACPC,KAAM,GACNC,UAAW,KACXC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","file":"all.build.js","sourcesContent":["//     keymaster.js\n//     (c) 2011-2013 Thomas Fuchs\n//     keymaster.js may be freely distributed under the MIT license.\n\n;(function(global){\n  var k,\n    _handlers = {},\n    _mods = { 16: false, 18: false, 17: false, 91: false },\n    _scope = 'all',\n    // modifier keys\n    _MODIFIERS = {\n      '⇧': 16, shift: 16,\n      '⌥': 18, alt: 18, option: 18,\n      '⌃': 17, ctrl: 17, control: 17,\n      '⌘': 91, command: 91\n    },\n    // special keys\n    _MAP = {\n      backspace: 8, tab: 9, clear: 12,\n      enter: 13, 'return': 13,\n      esc: 27, escape: 27, space: 32,\n      left: 37, up: 38,\n      right: 39, down: 40,\n      del: 46, 'delete': 46,\n      home: 36, end: 35,\n      pageup: 33, pagedown: 34,\n      ',': 188, '.': 190, '/': 191,\n      '`': 192, '-': 189, '=': 187,\n      ';': 186, '\\'': 222,\n      '[': 219, ']': 221, '\\\\': 220\n    },\n    code = function(x){\n      return _MAP[x] || x.toUpperCase().charCodeAt(0);\n    },\n    _downKeys = [];\n\n  for(k=1;k<20;k++) _MAP['f'+k] = 111+k;\n\n  // IE doesn't support Array#indexOf, so have a simple replacement\n  function index(array, item){\n    var i = array.length;\n    while(i--) if(array[i]===item) return i;\n    return -1;\n  }\n\n  // for comparing mods before unassignment\n  function compareArray(a1, a2) {\n    if (a1.length != a2.length) return false;\n    for (var i = 0; i < a1.length; i++) {\n        if (a1[i] !== a2[i]) return false;\n    }\n    return true;\n  }\n\n  var modifierMap = {\n      16:'shiftKey',\n      18:'altKey',\n      17:'ctrlKey',\n      91:'metaKey'\n  };\n  function updateModifierKey(event) {\n      for(k in _mods) _mods[k] = event[modifierMap[k]];\n  };\n\n  // handle keydown event\n  function dispatch(event) {\n    var key, handler, k, i, modifiersMatch, scope;\n    key = event.keyCode;\n\n    if (index(_downKeys, key) == -1) {\n        _downKeys.push(key);\n    }\n\n    // if a modifier key, set the key.<modifierkeyname> property to true and return\n    if(key == 93 || key == 224) key = 91; // right command on webkit, command on Gecko\n    if(key in _mods) {\n      _mods[key] = true;\n      // 'assignKey' from inside this closure is exported to window.key\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = true;\n      return;\n    }\n    updateModifierKey(event);\n\n    // see if we need to ignore the keypress (filter() can can be overridden)\n    // by default ignore key presses if a select, textarea, or input is focused\n    if(!assignKey.filter.call(this, event)) return;\n\n    // abort if no potentially matching shortcuts found\n    if (!(key in _handlers)) return;\n\n    scope = getScope();\n\n    // for each potential shortcut\n    for (i = 0; i < _handlers[key].length; i++) {\n      handler = _handlers[key][i];\n\n      // see if it's in the current scope\n      if(handler.scope == scope || handler.scope == 'all'){\n        // check if modifiers match if any\n        modifiersMatch = handler.mods.length > 0;\n        for(k in _mods)\n          if((!_mods[k] && index(handler.mods, +k) > -1) ||\n            (_mods[k] && index(handler.mods, +k) == -1)) modifiersMatch = false;\n        // call the handler and stop the event if neccessary\n        if((handler.mods.length == 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91]) || modifiersMatch){\n          if(handler.method(event, handler)===false){\n            if(event.preventDefault) event.preventDefault();\n              else event.returnValue = false;\n            if(event.stopPropagation) event.stopPropagation();\n            if(event.cancelBubble) event.cancelBubble = true;\n          }\n        }\n      }\n    }\n  };\n\n  // unset modifier keys on keyup\n  function clearModifier(event){\n    var key = event.keyCode, k,\n        i = index(_downKeys, key);\n\n    // remove key from _downKeys\n    if (i >= 0) {\n        _downKeys.splice(i, 1);\n    }\n\n    if(key == 93 || key == 224) key = 91;\n    if(key in _mods) {\n      _mods[key] = false;\n      for(k in _MODIFIERS) if(_MODIFIERS[k] == key) assignKey[k] = false;\n    }\n  };\n\n  function resetModifiers() {\n    for(k in _mods) _mods[k] = false;\n    for(k in _MODIFIERS) assignKey[k] = false;\n  };\n\n  // parse and assign shortcut\n  function assignKey(key, scope, method){\n    var keys, mods;\n    keys = getKeys(key);\n    if (method === undefined) {\n      method = scope;\n      scope = 'all';\n    }\n\n    // for each shortcut\n    for (var i = 0; i < keys.length; i++) {\n      // set modifier keys if any\n      mods = [];\n      key = keys[i].split('+');\n      if (key.length > 1){\n        mods = getMods(key);\n        key = [key[key.length-1]];\n      }\n      // convert to keycode and...\n      key = key[0]\n      key = code(key);\n      // ...store handler\n      if (!(key in _handlers)) _handlers[key] = [];\n      _handlers[key].push({ shortcut: keys[i], scope: scope, method: method, key: keys[i], mods: mods });\n    }\n  };\n\n  // unbind all handlers for given key in current scope\n  function unbindKey(key, scope) {\n    var multipleKeys, keys,\n      mods = [],\n      i, j, obj;\n\n    multipleKeys = getKeys(key);\n\n    for (j = 0; j < multipleKeys.length; j++) {\n      keys = multipleKeys[j].split('+');\n\n      if (keys.length > 1) {\n        mods = getMods(keys);\n        key = keys[keys.length - 1];\n      }\n\n      key = code(key);\n\n      if (scope === undefined) {\n        scope = getScope();\n      }\n      if (!_handlers[key]) {\n        return;\n      }\n      for (i = 0; i < _handlers[key].length; i++) {\n        obj = _handlers[key][i];\n        // only clear handlers if correct scope and mods match\n        if (obj.scope === scope && compareArray(obj.mods, mods)) {\n          _handlers[key][i] = {};\n        }\n      }\n    }\n  };\n\n  // Returns true if the key with code 'keyCode' is currently down\n  // Converts strings into key codes.\n  function isPressed(keyCode) {\n      if (typeof(keyCode)=='string') {\n        keyCode = code(keyCode);\n      }\n      return index(_downKeys, keyCode) != -1;\n  }\n\n  function getPressedKeyCodes() {\n      return _downKeys.slice(0);\n  }\n\n  function filter(event){\n    var tagName = (event.target || event.srcElement).tagName;\n    // ignore keypressed in any elements that support keyboard data input\n    return !(tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA');\n  }\n\n  // initialize key.<modifier> to false\n  for(k in _MODIFIERS) assignKey[k] = false;\n\n  // set current scope (default 'all')\n  function setScope(scope){ _scope = scope || 'all' };\n  function getScope(){ return _scope || 'all' };\n\n  // delete all handlers for a given scope\n  function deleteScope(scope){\n    var key, handlers, i;\n\n    for (key in _handlers) {\n      handlers = _handlers[key];\n      for (i = 0; i < handlers.length; ) {\n        if (handlers[i].scope === scope) handlers.splice(i, 1);\n        else i++;\n      }\n    }\n  };\n\n  // abstract key logic for assign and unassign\n  function getKeys(key) {\n    var keys;\n    key = key.replace(/\\s/g, '');\n    keys = key.split(',');\n    if ((keys[keys.length - 1]) == '') {\n      keys[keys.length - 2] += ',';\n    }\n    return keys;\n  }\n\n  // abstract mods logic for assign and unassign\n  function getMods(key) {\n    var mods = key.slice(0, key.length - 1);\n    for (var mi = 0; mi < mods.length; mi++)\n    mods[mi] = _MODIFIERS[mods[mi]];\n    return mods;\n  }\n\n  // cross-browser events\n  function addEvent(object, event, method) {\n    if (object.addEventListener)\n      object.addEventListener(event, method, false);\n    else if(object.attachEvent)\n      object.attachEvent('on'+event, function(){ method(window.event) });\n  };\n\n  // set the handlers globally on document\n  addEvent(document, 'keydown', function(event) { dispatch(event) }); // Passing _scope to a callback to ensure it remains the same by execution. Fixes #48\n  addEvent(document, 'keyup', clearModifier);\n\n  // reset modifiers to false whenever the window is (re)focused.\n  addEvent(window, 'focus', resetModifiers);\n\n  // store previously defined key\n  var previousKey = global.key;\n\n  // restore previously defined key and return reference to our key object\n  function noConflict() {\n    var k = global.key;\n    global.key = previousKey;\n    return k;\n  }\n\n  // set window.key and window.key.set/get/deleteScope, and the default filter\n  global.key = assignKey;\n  global.key.setScope = setScope;\n  global.key.getScope = getScope;\n  global.key.deleteScope = deleteScope;\n  global.key.filter = filter;\n  global.key.isPressed = isPressed;\n  global.key.getPressedKeyCodes = getPressedKeyCodes;\n  global.key.noConflict = noConflict;\n  global.key.unbind = unbindKey;\n\n  if(typeof module !== 'undefined') module.exports = assignKey;\n\n})(this);\n","\"use strict\";\r\n\r\nvar oxford_comma = function(arr){\r\n    switch (arr.length){\r\n        case 1:\r\n            return arr[0];\r\n        case 2:\r\n            return arr[0] + \" and \" + arr[1];\r\n        case 3:\r\n            return arr[0] + \", \" + arr[1] + \", and \" + arr[2];\r\n    }\r\n}\r\n\r\nvar rotate = function(el, deg){\r\n    el.style.transform = \"rotate(\" + deg + 'deg)';\r\n    el.style.webkitTansform = \"rotate(\" + deg + 'deg)';\r\n    el.style.mozTransform = \"rotate(\" + deg + 'deg)';\r\n}\r\n\r\nvar translate = function(el, x, y){\r\n    var str = x==null ? \"\" : \"translate(\" + x + \"px,\" + y + \"px)\";\r\n    el.style.transform = str;\r\n    el.style.webkitTransform = str;\r\n    el.style.mozTransform = str;\r\n}\r\n\r\nvar text_multi = function(el, text, truncate_long_words){\r\n    if(truncate_long_words){\r\n        text = text.replace(/(\\S{25})\\S*/g,'$1...'); \r\n    }\r\n    el.textContent = text;  \r\n    el.innerHTML = el.innerHTML.replace(/\\n/g,'<br/>').replace(/\\t/g,'&nbsp;&nbsp;&nbsp; ');\r\n}\r\n\r\nvar escape_str = function(str){\r\n    // http://stackoverflow.com/a/18750001/2399799\r\n    return str.replace(/[\\u00A0-\\u9999<>\\&]/g, function(i) {\r\n        return '&#' + i.charCodeAt(0) + ';';\r\n    });\r\n}\r\n\r\nvar css_animation = (function(){\r\n    var timers = []; // we store timers and matching els so we can cancel if needed\r\n    var els = [];\r\n\r\n    return function(el, cls, callback, delay){\r\n        el.classList.remove(cls);\r\n        el.offsetTop; //forces class to be removed, so we can actually re-add it.\r\n        var old_idx = els.indexOf(el);\r\n        if(old_idx != -1){\r\n            clearTimeout(timers[old_idx]);\r\n            timers.splice(old_idx, 1);\r\n            els.splice(old_idx, 1);\r\n        }\r\n        els.push(el);\r\n        timers.push(setTimeout(callback, delay)); //this is better than trying to use the endtransition event\r\n        el.classList.add(cls);\r\n    }\r\n})();\r\n\r\nvar stop_propagation = function(e){\r\n    e.stopPropagation();\r\n}\r\n\r\nvar prevent_default = function(e){\r\n    e.preventDefault();  \r\n}\r\n\r\n/* TODO: ...............................................................\r\n\r\n$.fn.fixHeightFromAuto = function(){\r\n    var heights = [];\r\n    var d = this.get();\r\n    for(var i=0;i<d.length;i++)\r\n        heights.push(getComputedStyle(d[i]).height);\r\n    \r\n    this.each(function(ind){this.style.height = heights[ind];});\r\n\r\n    return this;\r\n}\r\n\r\n$.fn.insertClonedChildren = function(index,$src,textArray,attrObjArrays){\r\n    //inserts new nodes before this.children(index)\r\n    //the new nodes are based on $src, with text set according to the elements of textArray\r\n    //attrObjArrays is an optional arrays of objects giving key names and values\r\n    \r\n    var src = $src.get(0);\r\n    var frag = document.createDocumentFragment();\r\n    \r\n    textArray.map(function(str,ind){\r\n                    var a = src.cloneNode(false); \r\n                    a.textContent = str;\r\n                    if(attrObjArrays)for(var attr in attrObjArrays[ind])\r\n                        a.setAttribute(attr,attrObjArrays[ind][attr]);\r\n                    frag.appendChild(a);\r\n                });\r\n    \r\n    var parent = this.get(0);\r\n    var new_$els = $(Array.prototype.slice.call(frag.children,0));\r\n    parent.insertBefore(frag,parent.children[index]);\r\n    \r\n    return new_$els;\r\n}\r\n\r\n*/","\"use strict\";\r\n\r\nvar DropDown = function(val_array){\r\n    //constructor, must use <new>\r\n    \r\n    var str = val_array.map(function(val){\r\n                    return \"<div class='dropdown_item' title='\" + escape_str(val) + \"'>\" + escape_str(val) + \"</div>\";\r\n                 }).join(\"\");\r\n    \r\n    this.val_array = val_array.slice(0); \r\n    this.el_list = document.createElement('div');\r\n    this.el_list.className ='dropdown_item_list';\r\n    this.el_list.tabindex =-1\r\n    this.el_list.style.display = 'none';\r\n    this.el_list.innerHTML = str;\r\n\r\n    this.el_collapsed = document.createElement('div');\r\n    this.el_collapsed.className = 'dropdown_collapsed';\r\n    \r\n    this.el = document.createElement('div');\r\n    this.el.className = 'dropdown';\r\n    this.el.appendChild(this.el_list)\r\n    this.el.appendChild(this.el_collapsed);\r\n    this.ind = 0;\r\n    this.el_collapsed.textContent = val_array[0];\r\n    this.event_callbacks = {}; //map of callback lists\r\n    this.open = false;\r\n    \r\n    var dd = this;\r\n\r\n    this.document_mousedown = function(e){\r\n        dd.el_list.style.display = 'none';\r\n        dd.open = false;\r\n        dd.trigger(\"blur\");\r\n        document.removeEventListener('mousedown', dd.document_mousedown);\r\n    }\r\n\r\n    this.el_collapsed.addEventListener('mousedown',function(){\r\n        if(!dd.trigger(\"click\"))\r\n            return;\r\n        dd.el.parentNode.classList.add(\"selected\");\r\n        dd.el_list.style.display = '';\r\n        this.open = true;\r\n        setTimeout(function(){\r\n            dd.el_list.focus();\r\n            dd.el_list.scrollTop = dd.el_list.children[dd.ind].offsetTop;\r\n            document.addEventListener('mousedown', dd.document_mousedown)\r\n        },1);\r\n    });\r\n    var on_click = function(e){\r\n            dd.SetInd(this.getAttribute('data-ind'));\r\n            dd.el_list.style.display = 'none';\r\n            dd.open = false;\r\n            e.stopPropagation();\r\n            document.removeEventListener('mousedown', dd.document_mousedown);\r\n    };\r\n    for(var ii=0; ii<this.el_list.children.length; ii++){\r\n        this.el_list.children[ii].setAttribute('data-ind', ii);\r\n        this.el_list.children[ii].addEventListener(\"click\", on_click); \r\n    }\r\n\r\n    return this;\r\n}\r\n\r\nDropDown.FakeEvent = function(){//static subclass\r\n    this.is_stopped = false;\r\n}\r\nDropDown.FakeEvent.prototype.stopImmediatePropagation = function(){\r\n    this.is_stopped = true;\r\n}\r\n\r\nDropDown.prototype.addEventListener = function(evt, func){\r\n    if(!(evt in this.event_callbacks))\r\n        this.event_callbacks[evt] = [];\r\n    this.event_callbacks[evt].push(func);\r\n}\r\n\r\nDropDown.prototype.trigger = function(evt, args){\r\n    var fe = new DropDown.FakeEvent();\r\n    if(evt in this.event_callbacks){\r\n        for(var ii = 0; ii<this.event_callbacks[evt].length; ii++)\r\n            this.event_callbacks[evt][ii].call(this, fe);\r\n        if(fe.is_stopped)\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\nDropDown.prototype.IndexOf = function(val){\r\n    return this.val_array.indexOf(val);\r\n}\r\n\r\nDropDown.prototype.GetVal = function(){\r\n    return this.val_array[this.ind];\r\n}\r\n\r\nDropDown.prototype.SetInd = function(ind,no_trigger){\r\n    ind = parseInt(ind)\r\n    if(ind === this.ind)\r\n        return;\r\n    this.el_list.children[this.ind].classList.remove(\"selected\");\r\n    this.el_collapsed.textContent = this.val_array[ind];\r\n    this.el_collapsed.title = escape_str(this.val_array[ind]);\r\n    this.ind = ind;\r\n    this.el_list.children[ind].classList.add(\"selected\");\r\n    if(!no_trigger)\r\n        this.trigger(\"change\",{ind:ind,str:this.val_array[ind],isOpen: this.open});\r\n}\r\n\r\nDropDown.prototype.SetSelected = function(v){\r\n    if(v)\r\n        this.el.parentNode.classList.add(\"selected\");\r\n    else\r\n        this.el.parentNode.classList.remove(\"selected\");\r\n}\r\n","\"use strict\";\r\n\r\ndn.menu_id_to_caption = {\r\n'menu_print': 'print',\r\n'menu_sharing': 'sharing',\r\n'menu_save': 'save',\r\n'menu_history': 'history',\r\n'menu_file': 'current file',\r\n'menu_new': 'new',\r\n'menu_open': 'new/open',\r\n'menu_find': 'find/replace',\r\n'menu_goto': 'goto line',\r\n'menu_general_settings': 'general settings',\r\n'menu_shortcuts': 'shortcuts',\r\n'menu_drive': 'drive',\r\n'menu_help': 'about/help'};\r\n\r\n\r\ndn.shortcuts_list = [\r\n\"cut|Ctrl-X|Cmd-X\",    \r\n\"copy|Ctrl-C|Cmd-C\",\r\n\"paste|Ctrl-V|Command-V\",\r\n\"cycle clipboard|Cltr-[V then left or right arrow]|Command-[V then left or right arrow]\",\r\n\"select all|Ctrl-A|Command-A\",\r\n\"find|Ctrl(-Alt)-F\",\r\n\"replace|Ctrl-R\",\r\n\"go to line|Ctrl(-Alt)-L\",\r\n\"undo|Ctrl-Z|Command-Z\",\r\n\"redo|Ctrl-Shift-Z,Ctrl-Y|Command-Shift-Z,Command-Y\",\r\n\" | \",\r\n\"toggle widget|Esc\",\r\n\"save|Ctrl-S|Command-S\",\r\n\"print|Ctrl(-Alt)-P|Command-P\",\r\n\"file history|Ctrl-H|Command-H\",\r\n\"new|Ctrl(-Alt)-N\",\r\n\"open|Ctrl(-Alt)-O\",\r\n\"  | \",\r\n\"to upper case|Ctrl-U\",\r\n\"to lower case|Ctr-Shift-U\",\r\n\"modify selection|Shift-(Ctrl-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown, PageUp, End}|Shift-(Command-)(Alt-) {Down, Up, Left, Right, End, Home, PageDown,End}\",\r\n\"copy lines down|Ctrl-Alt-Down|Command-Option-Down\",\r\n\"copy lines up|Ctrl-Alt-Up|Command-Option-Up\",\r\n\"center selection||Ctrl-L\",\r\n\"fold all|Alt-0|Option-0\",\r\n\"unfold all|Alt-Shift-0|Option-Shift-0\",\r\n\"go to end|Ctrl-End,Ctrl-Down|Command-End,Command-Down\",\r\n\"go to line end|Alt-Right,End|Command-Right,End,Ctrl-E\",\r\n\"go to line start|Alt-Left,Home|Command-Left,Home,Ctrl-A\",\r\n\"go to page down|PageDown|Option-PageDown,Ctrl-V\",\r\n\"go to page up|PageUp|Option-PageUp\",\r\n\"go to start|Ctrl-Home,Ctrl-Up|Command-Home,Command-Up\",\r\n\"go to word left|Ctrl-Left|Option-Left\",\r\n\"go to word right|Ctrl-Right|Option-Right\",\r\n\"indent|Tab\",\r\n\"outdent|Shift-Tab\",\r\n\"overwrite|Insert\",\r\n\"remove line|Ctrl-D|Command-D\",\r\n\"remove to line end||Ctrl-K\",\r\n\"remove to linestart||Option-Backspace\",\r\n\"remove word left||Alt-Backspace,Ctrl-Alt-Backspace\",\r\n\"remove word right||Alt-Delete\",\r\n\"split line||Ctrl-O\",\r\n\"toggle comment|Ctrl-7|Command-7\",\r\n\"transpose letters|Ctrl-T\"\r\n]\r\n\r\ndn.ext_to_mime_type = {\r\nhtml:\"text/html\",\r\nhtm:\"text/html\",\r\njs:\"text/javascript\",\r\npl:\"application/x-perl\",\r\nxml:\"text/xml\",\r\nc:\"text/x-csrc\",\r\ncpp:\"text/x-c++src\",\r\nh:\"text/x-chdr\",\r\njson:\"application/json\",\r\nphp:\"application/x-php\",\r\nsvg:\"text/html\",\r\ncss:\"text/css\",\r\njava:\"text/x-java\",\r\npy:\"text/x-python\",\r\nscala:\"scala\",\r\ntextile:\"textile\",\r\ntex:\"application/x-tex\",\r\nbib:\"application/x-tex\",\r\nrtf:\"application/rtf\",\r\nrtx:\"application/rtf\",\r\nsh:\"application/x-sh\",\r\nsql:\"text/x-sql\",\r\nas:\"text/x-actionscript\"\r\n//everything else is hopefully ok to be text/plain.\r\n}\r\n\r\ndn.tooltip_info = { //keys correspond to icon data-info attr, which will be the same as keys in SHORTCUTS_LIST\r\n    \"save\" : \"Save file contents.  \",\r\n    \"print\": \"Open print view in a new tab.  \",\r\n    \"sharing\": \"View and modify file's sharing status.\",\r\n    \"file history\": \"Explore the file history.  \",\r\n    \"drive\": \"Show this file in Google Drive.  \",\r\n    \"about\": \"Drive Notepad website.\",\r\n    \"shortcuts\": \"Keyboard shortcuts.\",\r\n    \"new\": \"Create new file in a new tab.  \",\r\n    \"open\": \"Launch open dialoag.  \",\r\n    \"settings_file\": \"Properties of the current file.\",\r\n    \"settings_general\": \"Your general Drive Notepad preferences.\",\r\n    \"title\": \"Click to edit the file's title.\",\r\n    \"description\": \"Click to edit the file's description.\"\r\n}\r\n\r\n// TODO: use keymaster rather than relying on this\r\nvar WHICH = {\r\nENTER: 13,\r\nESC: 27,\r\nUP: 38,\r\nDOWN: 40\r\n};\r\n\r\ndn.default_settings = {\r\next: 'txt',\r\nwordWrap: [true,null,null],\r\nwordWrapAt: 80,\r\nfontSize: 1,\r\nwidget_anchor: ['l',50,'t',10],\r\nshowGutterHistory: 1,\r\nlastDNVersionUsed: '',\r\nnewLineDefault: 'windows',\r\nhistoryRemovedIsExpanded: true,\r\nsoftTabN: 4,\r\ntabIsHard: 0,\r\nwidgetSub: 'general',\r\ntheme: \"chrome\",\r\npane: '',\r\npane_open: true,\r\nfind_regex: false,\r\nfind_whole_words: false,\r\nfind_case_sensitive: false,\r\nhelp_inner: 'main',\r\nfind_goto: false,\r\nfind_replace: false\r\n}\r\n\r\ndn.default_custom_props = {\r\nnewline: \"detect\",\r\ntabs: \"detect\",\r\naceMode: \"detect\"\r\n};\r\n\r\ndn.impersonal_settings_keys = [\r\n\"wordWrap\",\r\n\"wordWrapAt\",\r\n\"fontSize\",\r\n\"widget_anchor\",\r\n\"showGutterHistory\",\r\n\"historyRemovedIsExpanded\",\r\n\"tabIsHard\",\r\n\"softTabN\",\r\n\"widgetSub\",\r\n\"theme\",\r\n\"pane\",\r\n\"pane_open\",\r\n\"find_regex\",\r\n\"find_whole_words\",\r\n\"find_case_sensitive\",\r\n\"help_inner\",\r\n\"find_goto\",\r\n\"find_replace\"\r\n];\r\n\r\ndn.drag_delay_ms = 400;\r\ndn.drag_shift_px = 40;\r\ndn.min_font_size = 0.3;\r\ndn.max_font_size = 5; \r\ndn.max_wrap_at = 200;\r\ndn.min_wrap_at = 20;\r\ndn.wrap_at_increment = 10;\r\ndn.max_soft_tab_n = 10;\r\ndn.min_soft_tab_n = 2;\r\ndn.detect_tabs_spaces_frac = 0.9;\r\ndn.detect_tabs_tabs_frac = 0.9;\r\ndn.detect_tabs_n_spaces_frac = 0.99;\r\ndn.detect_tabs_n_spaces_frac_for_default = 0.6;\r\ndn.font_size_increment = 0.15;\r\ndn.icon_mouse_over_ms = 300;\r\ndn.editor_refocus_time_ms = 500;\r\ndn.error_delay_ms = 5000;//5 seconds\r\ndn.find_history_add_delay = 2000; //ms\r\ndn.clipboard_info_delay = 500; //ms\r\ndn.clipboard_max_length = 20; //TODO: decide whether a large clipboard slows page loads and whether we can do anything about it.\r\ndn.find_max_results_half = 3; \r\ndn.find_max_prefix_chars = 10;\r\ndn.find_max_suffix_chars = 60;","\"use strict\";\r\n\r\ndn.close_history = function(){\r\n    dn.file_history.$revisions_display.remove();\r\n    window.removeEventListener(\"resize\", dn.revisions_window_resize);\r\n    document.getElementById('the_editor').style.display = '';\r\n    dn.editor.resize();\r\n    dn.is_showing_history = false;\r\n}\r\ndn.revisions_window_resize = function(){\r\n    if(dn.file_history.canShowResizeError){\r\n        dn.show_error(\"The history explorer displays poorly if you resize the window while it is open. (This is a bug.)\");\r\n        dn.file_history.canShowResizeError = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n        setTimeout(function(){dn.file_history.canShowResizeError = true;},dn.error_delay_ms);\r\n    }    \r\n}\r\n\r\ndn.start_revisions_worker = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.show_error(\"This is a new file.  It doesn't have any history to explore.\")\r\n        return;\r\n    }\r\n    dn.is_showing_history = true;\r\n    \r\n    if(!dn.file_history){\r\n        dn.el.widget_content.innerHTML('afterend', \r\n            \"<div class='widget_box widget_revisions'>\" + \r\n            \"<div class='widget_box_title widget_revisions_title'>File History</div>\" +\r\n            \"<div class='revision_caption_at'></div>\" +\r\n            \"<div class='revision_timeline'></div>\" +\r\n            \"<div class='revision_caption_from'></div>\" +\r\n            \"<div>Removed lines: <div class='button inline_button ' id='expand_removed'>expand</div>\" + \r\n                    \"<div class='button inline_button ' id='collapse_removed'>collapse</div></div>\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"<div id='revisions_status'>Initialising...</div>\" + \r\n            \"Press Esc to return to editing.\" +\r\n            \"<br><div class='widget_divider'></div>\" + \r\n            \"Please note that the history viewing tool is missing some important features and those that have been implemented may include the odd bug.</div>\");\r\n        dn.el.widget_file_history = dn.el.widget_content.parentNode.getElementsByClassName('widget_revisions')[0];\r\n        dn.el.widget_file_history.style.display = 'none';\r\n        dn.file_history = {\r\n            $revisions_display: $(\"<div class='revisions_view'><ol></ol></div>\"),\r\n            $view: null, \r\n            $new_li: $(\"<li class='rev_line' v='-1'/>\"),\r\n            $new_tick:  $(\"<div class='revision_tick'/>\"),\r\n            needToRefindViewChildren: false, //this flag tracks when the $rev_lines_ is out of date relative to children of $view\r\n            $rev_lines_: [], // this is a single jQuery collection\r\n            needToFixHeights: $([]),            \r\n            $timeline: $d.find('.revision_timeline'),\r\n            $revisions_status: $d.find('#revisions_status'),\r\n            $revision_caption_from: $d.find('.revision_caption_from'),\r\n            $revision_caption_at: $d.find('.revision_caption_at'),\r\n            $expand_removed: $d.find('#expand_removed'),\r\n            $collapse_removed: $d.find('#collapse_removed'),\r\n            revisions: [], //array of objects with etag, isDownloaded, modifiedDate, $tick\r\n            revisionFromEtag: {},\r\n            at: null, //revision object\r\n            from: null, //revision object,\r\n            canShowResizeError: true, //used by Revisions_WindowResize\r\n            worker: new Worker(\"js/revisions_worker.js\")\r\n        };\r\n    \r\n        dn.file_history.$view = dn.file_history.$revisions_display.find('ol'); \r\n        dn.file_history.$expand_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',true)});\r\n        dn.file_history.$collapse_removed.addEventListener('click', function(){dn.g_settings.set('historyRemovedIsExpanded',false)});\r\n        dn.revision_setis_expaned(dn.g_settings.get('historyRemovedIsExpanded'))\r\n\r\n        var w = dn.file_history.worker;\r\n        w.onmessage = dn.revision_worker_delivery;\r\n    }\r\n    dn.file_history.worker.postMessage({ fileId: dn.the_file.file_id, \r\n                                        token: gapi.auth.getToken().access_token,\r\n                                        init: true});\r\n    dn.file_history.$revisions_display.appendTo($('body'));\r\n    $(window).on(\"resize\",dn.revisions_window_resize);\r\n    dn.el.widget_file_history.style.display = '';\r\n    dn.file_history.$view.empty();\r\n    $('#the_editor').style.display = 'none';\r\n    return false;\r\n}\r\n\r\ndn.revision_setis_expaned = function(v){\r\n    var h = dn.file_history;\r\n    if(!h) return; //if we haven't yet initialised fileHistory stuff then ignore this for now, when we do initialise we will read and apply the g_settings value\r\n    \r\n    if(v){\r\n        h.$expand_removed.classList.add('selected')\r\n        h.$collapse_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"expanded\");\r\n    }else{\r\n        h.$collapse_removed.classList.add('selected')\r\n        h.$expand_removed.classList.remove('selected');\r\n        h.$view.setAttribute(\"removed\",\"collapsed\")\r\n    }\r\n}\r\ndn.revision_set_at = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.at = r;\r\n    if(!fromChangeEvent)\r\n        h.$at_range.value = r.ind;    \r\n    text_multi(h.$revision_caption_at,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.from && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                      fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.revision_set_from = function(r,fromChangeEvent,fromTimelineCreation){\r\n    var h = dn.file_history;\r\n    h.from = r;\r\n    if(!fromChangeEvent)\r\n        h.$from_range.value = r.ind;\r\n    text_multi(h.$revision_caption_from,\r\n            r.modifiedDate.toLocaleDateString({},{month:\"short\",day:\"numeric\",year: \"numeric\"}) + \"\\n\" +\r\n            r.modifiedDate.toLocaleTimeString({},{hour: \"numeric\",minute: \"numeric\"})\r\n        )\r\n    \r\n    if(h.at && !fromTimelineCreation)\r\n        h.worker.postMessage({showEtag: h.at.etag,\r\n                          fromEtag: h.from.etag  });\r\n}\r\n\r\ndn.display_revision_timeline = function(newRevisions){\r\n    var h = dn.file_history;\r\n    var rs = h.revisions;\r\n    //TODO: update display based on newRevisions rather than starting from scratch\r\n    \r\n    h.$at_range = $(\"<input class='revision_at_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    h.$tick_box = $(\"<div class='revision_tick_box'/>\");\r\n    h.$from_range = $(\"<input class='revision_from_range' type='range' min='0' max='\" + (rs.length-1) + \"'/>\");\r\n    \r\n        \r\n    var attr = rs.map(function(t){ return { downloaded: t.isDownloaded || false }; });\r\n    var text = Array.apply(null, Array(attr.length)).map(function () { return \"\" });\r\n    var $ticks = h.$tick_box.insertClonedChildren(0,h.$new_tick,text,attr);\r\n    \r\n    for(var i=0;i<rs.length;i++){\r\n        rs[i].ind = i;\r\n        rs[i].$ = $ticks.eq(i);\r\n    }\r\n    \r\n    h.$timeline.empty().append(h.$at_range).append(h.$tick_box).append(h.$from_range);\r\n\r\n    h.$at_range.on(\"change\",function(){\r\n            dn.revision_set_at(dn.file_history.revisions[this.value],true);\r\n        })\r\n    h.$from_range.on(\"change\",function(){\r\n            dn.revision_set_from(dn.file_history.revisions[this.value],true);\r\n        })\r\n\r\n    dn.revision_set_from(rs.length > 1 ? rs[1] : rs[0],false,true);\r\n    dn.revision_set_at(rs[0],false,true);\r\n}\r\n\r\ndn.revision_worker_delivery = function(e){\r\n    if(!e.data)\r\n        return; //not sure if this is possible\r\n\r\n    if(e.data.debug)\r\n        console.log(e.data);\r\n        \r\n    var h = dn.file_history;\r\n    //TODO: probably ought to use a more sensivle message system with a string command switching thign...but this is ok for now\r\n    \r\n    if(e.data.status)\r\n        text_multi(h.$revisions_status, e.data.status);\r\n        \r\n    if(e.data.revisions){    \r\n        h.revisions = e.data.revisions;\r\n        e.data.revisions.forEach(function(r){ h.revisionFromEtag[r.etag] = r;});\r\n        dn.display_revision_timeline(e.data.revisions);\r\n        h.worker.postMessage({ showEtag: h.at.etag,\r\n                               fromEtag: h.from.etag }); \r\n    }\r\n    \r\n    if(e.data.revisionDownloaded){\r\n        var r = h.revisionFromEtag[e.data.revisionDownloaded];\r\n        r.$.attr('downloaded',true);\r\n        r.isDownloaded = true;\r\n    }\r\n    \r\n    if(e.data.revsionDiffed){\r\n        h.needToRefindViewChildren = true;\r\n        var r = h.revisionFromEtag[e.data.revsionDiffed];\r\n        r.$.attr('diffed',true);\r\n        r.isDiffed = true;\r\n        \r\n        var newStuff = e.data.newStuffForDom;\r\n        for(var i=0;i<newStuff.length;i++){\r\n            var lines = newStuff[i].lines.map(function(str){return str || \" \"});  \r\n                                            // \"|| space\" thing is a hack for auto height stuff\r\n            h.needToFixHeights = h.needToFixHeights.add(\r\n                            h.$view.insertClonedChildren(newStuff[i].at,h.$new_li,lines)    );            \r\n        }\r\n    }\r\n\r\n    \r\n    if(e.data.vals_ui8buffer){\r\n        \r\n        if(h.needToRefindViewChildren){\r\n            h.$rev_lines_ = h.$view.children();\r\n            h.needToRefindViewChildren = false;\r\n        }\r\n        var $rl_ = h.$rev_lines_;\r\n        \r\n        if(h.needToFixHeights.length){\r\n            text_multi(h.$revisions_status, \"Obtaining line height data...\");\r\n            h.needToFixHeights.fixHeightFromAuto();\r\n            h.needToFixHeights = $([]);\r\n            text_multi(h.$revisions_status, \"Selecting lines...\");\r\n        }\r\n        \r\n        var vals = new Uint8Array(e.data.vals_ui8buffer)\r\n        $rl_.setAttribute('v',function(i){return vals[i]});\r\n            \r\n        // We have to manually set the width of the numbers (our version of ace's gutter)\r\n        switch(e.data.digits){\r\n            case 0:\r\n            case 1:\r\n            case 2:\r\n                h.$view.setAttribute('digits','');\r\n                break;\r\n            case 3:\r\n                h.$view.setAttribute('digits','###');\r\n                break;\r\n            case 4:\r\n                h.$view.setAttribute('digits','####');\r\n                break;\r\n            default:\r\n                h.$view.setAttribute('digits','#####');\r\n        }\r\n    }\r\n    \r\n        \r\n}\r\n","\"use strict\";\r\n\r\n/*\r\nThe find focus/blur problem.  This took some thinking to sort out!!!\r\n\r\nIn the end it is now relatively neat and simple to get your head around.\r\n\r\ndn.g_settings.set('pane', 'pane_find') and dn.g_settings.set('pane_open', true)\r\ndo not mess with the focus themselves. Any code that uses that must explicitly\r\ndecide whether or not it wants to focus on the input for search/goto (a choice\r\nwhich is made based on the flag dn.g_settings.get('find_goto')).\r\n\r\nCalling  dn.g_settings.set('find_goto', bool), also does not mess with the focus, it\r\njust renders the inactive version of goto/search.\r\n\r\nWe basically have the same setup for goto and for search, with goto having a less\r\nmeaty implementation, so it's easier to start by looking at that.\r\n\r\nWhen the input gets the focus, the goto/search operation is performed, when the\r\ninput is blurred it sets the info text to \"inactive\".  If the blur events is moving the\r\nfocus to null, then at the end of the blur event we redirect the focus to the editor.\r\n\r\nIn keyboard.js there are special functions for producing exactly the right\r\nfocus behaviour when pressing Esc (with focus on the editor) and pressing \r\nCtrl-F/Crtl-L.  \r\n============================\r\n\r\nEvetunally we may have to deal with the realtime document changes.\r\n\r\n*/\r\n\r\ndn.find_goto_changed = function(new_value){\r\n    // This just toggles the display, it does not deal with focus/blur, which may happen afterwards\r\n    // as a consequence if the relevant inputs previously had the focus.\r\n\r\n    if(new_value){\r\n        dn.el.find_goto_wrapper.style.display = '';\r\n        dn.el.find_find_wrapper.style.display = 'none';\r\n        dn.el.button_goto.classList.add('selected');\r\n        dn.el.find_info.textContent = 'goto line inactive';\r\n        dn.el.find_replace_wrapper.style.display = 'none';\r\n    }else{\r\n        dn.el.find_goto_wrapper.style.display = 'none';\r\n        dn.el.find_find_wrapper.style.display = '';\r\n        dn.el.button_goto.classList.remove('selected');\r\n        dn.el.find_info.textContent = 'search inactive';\r\n        if (dn.g_settings.get('find_replace'))\r\n            dn.el.find_replace_wrapper.style.display = '';\r\n    }\r\n}\r\n\r\ndn.find_replace_changed = function(new_value){\r\n    if(new_value){\r\n        dn.el.button_replace.classList.add('selected');\r\n        if(!dn.g_settings.get('find_goto'))\r\n            dn.el.find_replace_wrapper.style.display = '';\r\n    }else{\r\n        dn.el.find_replace_wrapper.style.display = 'none';\r\n        dn.el.button_replace.classList.remove('selected');\r\n    }\r\n    if(dn.find_inputs_have_focus)\r\n        dn.find_select_result_idx(dn.find_current_match_idx);\r\n}\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// goto :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// the implementation of goto is simpler than for search, so we start with it...\r\n\r\ndn.find_goto_input_has_focus = false; // we don't actually need this, but we keep it for analogy with search\r\n\r\ndn.find_goto_input_focus = function(){\r\n    dn.find_goto_input_has_focus = true;\r\n    dn.el.find_info.textContent = \"type to goto line\";\r\n    dn.find_perform_goto();\r\n}\r\n\r\ndn.find_goto_input_blur = function(e){\r\n    dn.find_goto_input_has_focus = false;\r\n    dn.el.find_info.textContent = \"goto line inactive\"; \r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\ndn.find_perform_goto = function(){\r\n    // called by find_goto_input_focus and find_goto_keyup\r\n    var validated_str = dn.el.find_goto_input.value.replace(/[^\\d]/,'');\r\n    if (validated_str !== dn.el.find_goto_input.value)\r\n        dn.el.find_goto_input.value = validated_str;\r\n    if(validated_str === \"\")\r\n        return;\r\n    var num = parseInt(validated_str);\r\n    dn.editor.gotoLine(num);\r\n    dn.editor.navigateLineEnd();\r\n}\r\n\r\ndn.find_goto_input_keyup = dn.find_perform_goto; //alias\r\n\r\ndn.find_goto_input_keydown = function(e){\r\n    // keydown is fired repeatedly when key remains down\r\n    if(e.which == WHICH.DOWN){\r\n        dn.el.find_goto_input.value = parseInt(dn.el.find_goto_input.value.replace(/[^\\d]/,''))+1;\r\n        dn.find_perform_goto();\r\n        e.preventDefault();\r\n    }else if(e.which == WHICH.UP){\r\n        dn.el.find_goto_input.value = parseInt(dn.el.find_goto_input.value.replace(/[^\\d]/,''))-1;\r\n        dn.find_perform_goto();\r\n        e.preventDefault();\r\n    } else if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false);\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    }\r\n}\r\n\r\n\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// search :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n\r\ndn.find_inputs_have_focus = false; // either find itself or replace\r\ndn.find_results = [];\r\ndn.find_current_match_idx = -1;\r\ndn.find_markers = [];\r\ndn.find_marker_current = undefined;\r\ndn.find_str = \"\";\r\n\r\ndn.find_inputs_focus = function(e){\r\n    if(e.currentTarget == dn.el.find_input){\r\n        dn.el.find_input.tabIndex = 101;\r\n        dn.el.find_replace_input.tabIndex = 102;   \r\n    } else {\r\n        dn.el.find_input.tabIndex = 102;\r\n        dn.el.find_replace_input.tabIndex = 101;   \r\n    }\r\n    if(dn.find_inputs_have_focus)\r\n        return; // focus was transfered between replace/find inputs\r\n\r\n    dn.find_inputs_have_focus = true;\r\n    dn.AceSearch = dn.AceSearch || ace.require(\"./search\").Search;\r\n    dn.AceRange = dn.AceRange || ace.require(\"./range\").Range;\r\n    dn.editor.setHighlightSelectedWord(false);  \r\n    dn.find_perform_search();\r\n}\r\n\r\ndn.find_inputs_blur = function(e){\r\n    if(e.relatedTarget == dn.el.find_replace_input  || e.relatedTarget == dn.el.find_input)\r\n        return; // focus is transfering between replace/find inputs\r\n\r\n    dn.find_inputs_have_focus = false;\r\n\r\n    // remove all markers\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    // reset widget display\r\n    dn.el.find_info.textContent = \"search inactive\";\r\n    dn.el.find_results.innerHTML = \"\";\r\n    dn.el.find_info_overflow.textContent = \"\";\r\n\r\n    // forget last search\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n\r\n    // forget last selection in input (in preparation for next time it gets focus)\r\n    dn.el.find_input.setSelectionRange(dn.el.find_input.selectionEnd, dn.el.find_input.selectionEnd);\r\n\r\n     // we had this on false during find\r\n    dn.editor.setHighlightSelectedWord(true);\r\n\r\n    if(!e.relatedTarget)\r\n        dn.focus_editor();\r\n}\r\n\r\ndn.find_build_options = function(){\r\n    var str = dn.el.find_input.value;\r\n    var use_reg_exp = dn.g_settings.get('find_regex');\r\n    var sensitive = dn.g_settings.get('find_case_sensitive');\r\n    if(use_reg_exp){\r\n        var re = undefined;\r\n        re = new RegExp(str, sensitive ? \"g\" : \"gi\"); //cam throw error\r\n    }\r\n    return {\r\n    needle: use_reg_exp ? re : str,\r\n    wrap: true,\r\n    caseSensitive: sensitive,\r\n    wholeWord: dn.g_settings.get('find_whole_words'),\r\n    regExp: use_reg_exp };\r\n}\r\n\r\ndn.find_perform_search = function(){\r\n    // called by find_input_focus, find_settings_changed, and on keyup in the input, when text has changed\r\n\r\n    // clear previous find (but leave selection for now)\r\n    var session = dn.editor.getSession();   \r\n    for(var ii=0; ii<dn.find_markers.length; ii++)\r\n        session.removeMarker(dn.find_markers[ii]);\r\n    if(dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current)\r\n        dn.find_marker_current = undefined;\r\n    }\r\n    dn.find_markers = [];\r\n    dn.find_results = [];\r\n    dn.find_current_match_idx = -1;\r\n    dn.el.find_results.innerHTML = \"\";  \r\n    dn.el.find_info_overflow.textContent = \"\";\r\n    dn.el.find_info.textContent = \"\";\r\n    dn.find_str = dn.el.find_input.value; // we only store it to make it easier for key_down to check for true changes\r\n\r\n    var search_options = undefined;\r\n    try{\r\n        search_options = dn.find_build_options();\r\n    } catch (e){\r\n        dn.el.find_info.textContent = escape_str(e.message); //TODO: could force first letter to lower case\r\n    }\r\n\r\n    if(search_options === undefined){\r\n        // failed regex, don't show any results\r\n        dn.editor.selection.clearSelection();\r\n\r\n    } else if(dn.find_str == \"\"){\r\n        // empty string (including empty regex), dont show any results\r\n        dn.el.find_info.textContent = \"type to search. \" /*+ dn.ctrl_key + \"-up/down for history.\"*/;\r\n        dn.editor.selection.clearSelection();\r\n        \r\n    } else {\r\n        // valid regex or pure str search..\r\n\r\n        // This is the actual search\r\n        var search = new dn.AceSearch();\r\n        search.setOptions(search_options);\r\n        var results = dn.find_results = search.findAll(session);\r\n\r\n        if(results.length === 0){\r\n            // No results to display, life is easy...\r\n            dn.el.find_info.textContent = \"no matches found.\";\r\n            dn.el.find_info_overflow.textContent = \"\";\r\n            dn.editor.selection.clearSelection();\r\n\r\n        }else{\r\n            // Right, we got some results ....\r\n\r\n            // Work out which result we should consider the current match.\r\n            var selected_range = session.getSelection().getRange();\r\n            for(var ii=0; ii<results.length; ii++) \r\n                if(results[ii].end.row > selected_range.start.row  || \r\n                    (results[ii].end.row == selected_range.start.row &&\r\n                     results[ii].end.column >= selected_range.start.column))\r\n                break;\r\n            var current_match_idx = (ii == results.length ? results.length-1 : ii);\r\n\r\n            // Add markers into the editor to show *all* the results\r\n            for(var ii=0; ii<results.length; ii++)\r\n                dn.find_markers.push(session.addMarker(results[ii], \"find_match_marker\", \"find_match_marker\", false));\r\n\r\n            // augment the results with their idx, this is useful for the subselection stuff\r\n            for(var ii=0; ii<results.length; ii++)\r\n                results[ii] = {range: results[ii], idx: ii};\r\n\r\n            // Render a subset of the results into the widget and mark & select the current match\r\n            dn.find_select_result_idx(current_match_idx);\r\n        }\r\n    }\r\n\r\n}\r\n\r\ndn.find_select_result_idx = function(current_match_idx){\r\n    // This is called within find_perform_search when a new search returns some results\r\n    // it's also called when we move through the results without changing the search and\r\n    // when replace_changed is called when find input already has the focus.   */\r\n\r\n    // Get a small sub set of results to show in the widget.\r\n    // We carefully implement some wrapping logic, which is a bit fiddly.\r\n    dn.find_current_match_idx = current_match_idx;\r\n\r\n    var session = dn.editor.getSession();\r\n    if (dn.find_marker_current !== undefined){\r\n        session.removeMarker(dn.find_marker_current);\r\n        dn.find_marker_current = undefined;\r\n    }\r\n\r\n    var results = dn.find_results;\r\n    var results_sub = [];\r\n    \r\n    var replace_is_showing = dn.g_settings.get('find_replace');\r\n\r\n    var max_results = dn.find_max_results_half*2 + (replace_is_showing ? 0 : 1);\r\n\r\n    if(results.length <= max_results){\r\n        results_sub = results;\r\n    }else{\r\n        var n_pre = dn.find_max_results_half - (replace_is_showing ? 1 : 0);\r\n        var n_post = dn.find_max_results_half;\r\n        if(current_match_idx < n_pre){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n_pre));\r\n            results_sub = results_sub.concat(results.slice(0, current_match_idx));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx - n_pre, current_match_idx));\r\n        }\r\n        results_sub.push(results[current_match_idx]); \r\n        if(current_match_idx + n_post >= results.length){\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1));\r\n            results_sub = results_sub.concat(results.slice(0, n_post + 1 - (results.length - current_match_idx)));\r\n        } else {\r\n            results_sub = results_sub.concat(results.slice(current_match_idx + 1, current_match_idx + n_post + 1));\r\n        }\r\n    }\r\n\r\n    // Now lets build the html to show the subset of results in the widget\r\n    var show_replace_buttons = dn.g_settings.get('find_replace');\r\n    var html = \"\";\r\n    for(var ii=0; ii<results_sub.length; ii++){\r\n        var row = results_sub[ii].range.start.row;\r\n        var col = results_sub[ii].range.start.column;\r\n        var prefix_range = new dn.AceRange(row, Math.max(0, col-dn.find_max_prefix_chars), row, col);\r\n        var pre_ellipses = col > dn.find_max_prefix_chars; //TODO: deal with indent better\r\n        row = results_sub[ii].range.end.row;\r\n        col = results_sub[ii].range.end.column;\r\n        var suffix_range = new dn.AceRange(row, col, row, col+dn.find_max_suffix_chars);\r\n        html += \"<div class='find_result_item\" + (results_sub[ii].idx==current_match_idx? \" find_result_current\" : \"\") + \"'>\" +\r\n                    \"<div class='find_result_line_num'>\" + (row+1) + \"</div>\" +\r\n                    \"<div class='find_result_text'>\" +\r\n                        \"<div class='find_result_text_inner'>\" +\r\n                            (pre_ellipses ? \"&#8230;\" : \"\") + escape_str(session.getTextRange(prefix_range)) +\r\n                            \"<span class='find_result_match'>\" + escape_str(session.getTextRange(results_sub[ii].range)) + \"</span>\" +\r\n                            escape_str(session.getTextRange(suffix_range)) +\r\n                        \"</div>\" +\r\n                    \"</div>\" +\r\n                    (show_replace_buttons ? \"<div class='button inline_button replace_single_result' title='replace'>r</div>\" : \"\") + \r\n                \"</div>\";\r\n    }\r\n    dn.el.find_results.innerHTML = html;\r\n    var els = dn.el.find_results.getElementsByClassName('find_result_item');\r\n    for(var ii=0; ii<els.length; ii++) if(results_sub[ii].idx !== current_match_idx)\r\n        els[ii].addEventListener('click', dn.find_result_click(results_sub[ii].idx));\r\n    if(show_replace_buttons){\r\n        var els = dn.el.find_results.getElementsByClassName('replace_single_result')\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].addEventListener('click', dn.find_replace_result_click(results_sub[ii].idx));\r\n    }\r\n\r\n    if(results.length > max_results)\r\n        dn.el.find_info_overflow.textContent = \"... and \" + (results.length - max_results) + \" more matches\";\r\n    else\r\n        dn.el.find_info_overflow.textContent = \"\";\r\n\r\n    // do the special marker for the current selection and actually select it\r\n    dn.find_marker_current = session.addMarker(results[current_match_idx].range, \"find_current_match_marker\", \"find_current_match_marker\", false);\r\n    dn.editor.selection.setSelectionRange(results[current_match_idx].range, false);\r\n    dn.editor.renderer.scrollSelectionIntoView();\r\n}\r\n\r\ndn.find_settings_changed = function(){\r\n    if(dn.find_inputs_have_focus || \r\n       (dn.g_settings.get('pane') === 'pane_find' && dn.g_settings.get('pane_open') &&  dn.el.find_input.value))\r\n        dn.find_perform_search();\r\n}\r\n\r\ndn.find_result_click = function(ii){\r\n    // this can only be called while find input has the focus\r\n    return function(e){dn.find_select_result_idx(ii);};\r\n}\r\n\r\ndn.find_replace_result_click = function(ii){\r\n    return function(e){\r\n        dn.find_replace_result_idx(ii);\r\n        e.stopPropagation(); // prevent selecting item\r\n    }\r\n}\r\n\r\ndn.find_input_keyup = function(e){ \r\n    //we need keyup here in order that the val has the new character or new backspace\r\n    if(e.which == WHICH.ENTER || e.which == WHICH.ESC || e.which == WHICH.UP || e.which == WHICH.DOWN)\r\n        return; \r\n    if(dn.find_str == dn.el.find_input.value)\r\n        return;\r\n    dn.find_perform_search()\r\n}\r\n\r\ndn.find_input_keydown = function(e){ \r\n    // we want keydown here so that we can get repeated firing with keydown (i think on most browsers)\r\n\r\n    if ((e.which == WHICH.ENTER && !e.shiftKey) || (!e.ctrlKey && e.which == WHICH.DOWN)){\r\n        //find next\r\n        dn.find_select_result_idx(dn.find_current_match_idx + 1 < dn.find_results.length ? \r\n                                    dn.find_current_match_idx + 1 \r\n                                  : 0);\r\n        e.preventDefault();\r\n        return;\r\n    }else if((e.which == WHICH.ENTER && e.shiftKey) || (!e.ctrlKey && e.which == WHICH.UP)){\r\n        //find previous\r\n        dn.find_select_result_idx(dn.find_current_match_idx - 1 < 0 ? \r\n                                    dn.find_results.length -1 \r\n                                  : dn.find_current_match_idx - 1);\r\n        e.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if(e.which == WHICH.ESC){\r\n        dn.g_settings.set('pane_open', false); // this focuses on the editor, and blurs the find_input\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        return;   \r\n    }\r\n\r\n}\r\n\r\ndn.find_replace_input_keydown = function(e){\r\n    if(e.which == WHICH.ENTER){\r\n        if(e.ctrlKey || e.shiftKey)\r\n            dn.find_replace_all();\r\n        else\r\n            dn.find_replace_result_idx(dn.find_current_match_idx);\r\n        e.preventDefault();\r\n    }else{\r\n        dn.find_input_keydown(e); // up, down results and esc\r\n    }\r\n}\r\n\r\ndn.find_replace_all = function(e){\r\n    try{\r\n        var options = dn.find_build_options();\r\n    } catch (e) {\r\n        dn.show_error(e.message);\r\n        return;\r\n    }\r\n    dn.editor.replaceAll(dn.el.find_replace_input.value, options);\r\n    dn.focus_editor();\r\n}\r\n\r\ndn.find_replace_click = dn.find_replace_all; //alias\r\n\r\ndn.find_replace_result_idx = function(idx){\r\n    var range = dn.find_results[idx].range;\r\n    // we use undocumented ACE API to avoid messing around tryinng to force it to use the exact range we wanted\r\n    dn.editor.$search.set(dn.find_build_options()); //this is needed so that $tryReplace knows what to do with regex'es\r\n    dn.editor.$tryReplace(range, dn.el.find_replace_input.value) // returns true on success, but do we care?\r\n    dn.find_perform_search();\r\n}","\"use strict\";\r\n\r\ndn.platform = (function(){\r\n    if(navigator.platform.indexOf(\"Win\") >-1)\r\n        return \"Windows\";\r\n    else if(navigator.platform.indexOf(\"Linux\") >-1)\r\n        return \"Linux\";\r\n    else if(navigator.platform.indexOf(\"Mac\")>-1)\r\n        return \"Mac\";\r\n        \r\n    return null;\r\n})();\r\n\r\ndn.create_pane_shortcuts = function(){\r\n//This is hardly the world's most efficient way of doing this....(but it probably doesn't matter)...\r\n\r\n    var arry = dn.shortcuts_list;\r\n    var dict = {};\r\n    var platform = dn.platform;\r\n\r\n    if(platform == \"Windows\" || platform == \"Linux\"){\r\n       for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts[1];\r\n        }\r\n    }else if(platform == \"Mac\"){\r\n        for(var i=0;i<arry.length;i++){\r\n            var parts = arry[i].split(\"|\");\r\n            if(parts[1].length)\r\n                dict[parts[0]] = parts.length > 2? parts[2] : parts[1];\r\n        }\r\n    }else{\r\n        //TODO: show something here, maybe let user switch, maybe have touch info for ipad & android.\r\n    }\r\n    \r\n    var html = [];\r\n    for(var action in dict)\r\n        html.push(\"<div class='shortcut_item'><div class='shortcut_action'>\" + \r\n                   action + \"</div><div class='shortcut_key'>\" + dict[action].replace(\",\",\"<br>\") +\r\n                   \"</div></div>\");\r\n    for(var action in dn.tooltip_info)if(action in dict)\r\n        dn.tooltip_info[action] += dict[action];\r\n\r\n    dn.el.pane_help_shortcuts.innerHTML =  [\r\n        \"<div class='widget_box_title shortcuts_title'>Keyboard Shortcuts \",\r\n             platform ? \"(\" + platform + \")\" : \"\" ,\r\n        \"</div>\",\r\n        \"<div class='shortcuts_header_action'>action</div><div class='shortcuts_header_key'>key</div>\",\r\n        \"<div class='shortcuts_list'>\",\r\n        html.join(''),\r\n        \"</div>\"].join('');\r\n\r\n};\r\n\r\ndn.esc_pressed = function(e){\r\n    dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n\r\n    if(dn.g_settings.get('pane_open') && dn.g_settings.get('pane') == 'pane_find')\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_shortcut_used = function(e){\r\n    var sel = dn.editor.session.getTextRange(dn.editor.getSelectionRange());\r\n    dn.g_settings.set('find_goto', false);\r\n    dn.g_settings.set('pane', 'pane_find');\r\n    dn.g_settings.set('pane_open', true);\r\n    if(sel){\r\n        dn.el.find_input.value = sel;\r\n        dn.el.find_input.select();\r\n    }\r\n    dn.el.find_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.find_goto_shortcut_used = function(e){\r\n    dn.g_settings.set('find_goto', true);\r\n    dn.g_settings.set('pane', 'pane_find'); // doing this after the find_active=true, tells the change handler not to put focus back to editor\r\n    dn.g_settings.set('pane_open', true);\r\n    dn.el.find_goto_input.focus();\r\n    e.preventDefault();\r\n}\r\n\r\ndn.show_replace_shortcut_used = function(e){\r\n    dn.g_settings.set('find_replace', true);\r\n    dn.find_shortcut_used(e);   \r\n}\r\n\r\ndn.make_keyboard_shortcuts = function(){\r\n    //perviously was using ace for handling these shorcuts because it neater (and efficient?) but it was\r\n    //annoying trying to ensure the editor always had focus, and not clear what to do when the editor wasn't showing.\r\n    \r\n    //we have to delete the default ace commands linked to the keys we care about\r\n    dn.editor.commands.removeCommands([\r\n        \"find\",\"findprevious\",\"findnext\",\"replace\",\"jumptomatching\",\"sortlines\",\"selecttomatching\",\"gotoline\"]);\r\n\r\n    //then add new commands on to the document using keymaster.js...\r\n    key('command+s, ctrl+s,  ctrl+alt+s,  command+alt+s', dn.save_content);\r\n    key('command+p, ctrl+p,  ctrl+alt+p,  command+alt+p', dn.do_print);\r\n    key('command+o, ctrl+o,  ctrl+alt+o,  command+alt+o', dn.do_open);\r\n    key('command+n, ctrl+n,  ctrl+alt+n,  command+alt+n', dn.do_new);\r\n    key('command+l, ctrl+l,  ctrl+alt+l,  command+alt+l', dn.find_goto_shortcut_used);\r\n    key('command+f, ctrl+f,  ctrl+alt+f,  command+alt+f', dn.find_shortcut_used); \r\n    key('command+r, ctrl+r,  ctrl+alt+r,  command+alt+r' + \r\n       ', command+g, ctrl+g,  ctrl+alt+g,  command+alt+g', dn.show_replace_shortcut_used);\r\n    key('command+h, ctrl+h,  ctrl+alt+h,  command+alt+h', dn.start_revisions_worker);\r\n    key('esc', dn.esc_pressed);\r\n    key.filter = function(){return 1;}\r\n\r\n    // it seems like the clipboard history cycling only works the old way, i.e. using ace....\r\n    var HashHandler = require(\"ace/keyboard/hash_handler\").HashHandler\r\n    var extraKeyEvents = new HashHandler([\r\n        {bindKey: {win: \"Ctrl-Left\",mac: \"Command-Left\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Down\",mac: \"Command-Down\"}, descr: \"Clipboard cyle back on paste\", exec: dn.document_clipboard_left},\r\n        {bindKey: {win: \"Ctrl-Right\",mac:\"Command-Right\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right},\r\n        {bindKey: {win: \"Ctrl-Up\",mac:\"Command-Up\"}, descr: \"Clipboard cyle forward on paste\", exec: dn.document_clipboard_right}\r\n    ]);\r\n    dn.editor.keyBinding.addKeyboardHandler(extraKeyEvents);\r\n\r\n    // Change \"ctrl\" to \"cmd\" if on Mac\r\n    dn.ctrl_key = \"crtl\"\r\n    if(dn.platform == 'Mac'){\r\n        dn.ctrl_key = 'cmd';\r\n        var els = dn.getElementsByClassName('ctrl_key');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].textContent = 'cmd'\r\n    }\r\n}\r\n","\"use strict\";\r\n// DRIVE NOTEPAD 2016\r\n// by DM\r\n\r\ndn.version_str = '2016a';\r\n\r\n// ############################\r\n// Constants and defaults, see alsp info.js\r\n// ############################\r\n\r\ndn.can_show_drag_drop_error = true;\r\ndn.is_showing_history = false;\r\n\r\ndn.status = {\r\n    // 0: get action in progress\r\n    // -1: failed\r\n    //  1: success\r\n    file_body: 0, \r\n    file_meta: 0, \r\n    file_sharing: 0, // after launching the sharing dialog this is set to -1\r\n    authentication: 0,\r\n    popup_active: 0, // 0 or 1, i.e. true or false\r\n    local_settings: 0,\r\n}\r\n\r\ndn.the_file = {\r\n    file_id: null,\r\n    folder_id: null,\r\n    title: null,\r\n    description: '',\r\n    ext: '',\r\n    loaded_mime_type: '',\r\n    new_line_detected: 'none', //'windows', 'unix','mixed', or 'none'\r\n    tab_detected: {val: 'none'},\r\n    is_pristine: true, //true while the document has no unsaved changes (set to true when we request the save not when we get confirmation, but if there is a save error it will be reverted to false).\r\n    mime_type: '',\r\n    is_saving: false,\r\n    data_to_save: {body: null, title: null, description: null}, //holds the values until confirmation of success for each\r\n    generation_to_save: {body: 0, title: 0, description: 0},//when saves return they check their this.description etc. against here and clear data_to_save if they match\r\n    is_read_only: false,\r\n    is_shared: false,\r\n    is_brand_new: false, // true from the point of creating a new document till the point we get confirmation of a successful save\r\n    is_reading_file_object: false, //this is used on drag and drop,\r\n    custom_props: {}, //these are the props potentially stored on the file using the custom properties API\r\n    custom_prop_exists: {}, //each of the custom props that actually exsits for the file will have an entry in this obj, with the key being the property and the value being true.\r\n    saving_title_count: 0 //tracks the number of active save request with just the title.  Whatever the resp, this number is decremented,\r\n};\r\ndn.change_line_history = [];\r\ndn.last_change = null;\r\ndn.change_line_classes =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_',8,5)\r\ndn.change_line_classes_rm =(function(rootStr,trueN,factor){\r\n    var x = [''];\r\n    for(var i=trueN;i;i--)for(var k=0;k<factor;k++)\r\n        x.push(rootStr + i);\r\n    return x;\r\n})('recent_line_rm',8,5)\r\ndn.el = dn.el || {};\r\n\r\n/* ################################################################################################################\r\n\r\n    [Some Notes on settings in Drive Notepad]\r\n\r\n    There are two kinds of settings: per-user settings and per-file settings.\r\n    \r\n    The user settings are stored in dn.g_settings. When the page is loaded this is a fake Google Realtime model, \r\n    which uses a mixture of default values and values read from localStorage.  At some point after authenticating \r\n    the g_settings will become the true Google Realtime model. Whenever a value in g_settings is changed\r\n     dn.setting_changed is called with the appropriate paramaters, this is true right from when the page loads, \r\n     i.e. the first set of values trigger the SettingsChanged, but after that only modifications will trigger a change\r\n      (regardless of whether g_settings is the true model or not).  Use the .set() and .get() methods on the dn.g_settings.\r\n    \r\n    The per-file settings are stored in dn.the_file.custom_props.  When the page is loaded they are initialised with \r\n    default values.  Then, if we have opened an existing file, at some point they will be updated with the true values. \r\n     These settings are *not* a realtime model, rather they are Custom Properties (there's an API for it).  Again, as\r\n      with the per-user settings, whenever the file settings are changed they trigger a call to PropertyUpdated.  Note\r\n       that since this is not backed by a realtime model we won't get changes on the server push to the browser, only\r\n        local changes will be observed.  The per-file settings are shared across anyone who has read and/or write access \r\n        to the file in question. Note that if the default value is chosen the setting value is simply removed from the file.\r\n          Use the dn.set_property() function to set values and read values straight from the dn.the_file.custom_props object.\r\n    \r\n    For each key \"Something\" in customProps there is a function dn.apply_something_choice() which will read the per-user \r\n    and/or the per-file settings (as appropriate) and use the combined result to apply the chosen setting to the editor, \r\n    additionally the function will render the file settings tab and/or the general settings tab. As part of this function \r\n    there will likely be a call to dn.detect_something, which will run some fairly simple heuristic over the current file.\r\n      [TODO: may want to cache this, as it can end up getting called several times during loading and possibly elsewhere.] \r\n      [TODO: may want to have an ApplySomethingChoice for all settings not just those that are covered by customProps.]\r\n\r\n################################################################################################################## */\r\n\r\n\r\n// ############################\r\n// Auth stuff\r\n// ############################\r\n\r\ndn.authentication_done = function(auth_result){\r\n    dn.status.popup_active = 0;\r\n    if (!auth_result)\r\n        return dn.authentication_failed(null);\r\n    if(auth_result.error)\r\n        return dn.authentication_failed(auth_result.error);\r\n\r\n    dn.status.authentication = 1;\r\n    dn.show_status();\r\n\r\n    if(!dn.user_info)\r\n        dn.get_user_info();\r\n    if(dn.the_file.file_id &&  dn.status.file_meta != 1 || dn.status.file_body != 1)\r\n        dn.load_file();\r\n    dn.get_properties_from_cloud();\r\n\r\n    // Access token has been successfully retrieved, requests can be sent to the API\r\n    //TODO: make these redundant\r\n    gapi.load('drive-realtime', dn.get_settings_from_cloud); // TODO: this can be loaded before auth is  done I think, but have to wait for auth before doing anything\r\n}\r\n\r\ndn.get_user_info = function(){\r\n   Promise.resolve(\r\n        gapi.client.request({\r\n            'path' : 'userinfo/v2/me?fields=name'\r\n        })).then(function(a){\r\n            dn.user_info = a.result;\r\n            dn.el.user_name.textContent = a.result.name;\r\n        }, function(err){\r\n            // TODO: could be auth problem\r\n            dn.show_error('Failed to get user info');\r\n            console.dir(err);\r\n        });\r\n}\r\n\r\ndn.authentication_failed = function(err){\r\n    dn.status.authorization = -1;\r\n    dn.status.popup_active = 0;\r\n    dn.show_status();\r\n    if(err)\r\n        dn.show_error(err.result.error.message);\r\n    else\r\n        dn.show_pane_permissions(); // No access token could be retrieved, force the authorization flow.\r\n}\r\n\r\ndn.reauth = function(callback){ \r\n    // TODO: as promise\r\n    dn.status.authentication = 0;\r\n    dn.show_status();\r\n    gapi.auth.authorize(dn.auth_map(true), function(){\r\n        dn.status.authentication = 1;\r\n        dn.show_status();\r\n        callback();\r\n    });\r\n}\r\n\r\ndn.launch_popup = function(){\r\n    dn.status.popup_active = 1;\r\n    dn.status.authorization = 0;\r\n    dn.show_status();    \r\n    Promise.resolve(\r\n        gapi.auth.authorize(dn.auth_map(false)))\r\n        .then(dn.authentication_done,\r\n              dn.authentication_failed);\r\n}\r\n\r\ndn.show_pane_permissions = function(){\r\n    dn.g_settings.set('pane', 'pane_permissions');\r\n    dn.g_settings.set('pane_open', 'true')\r\n    css_animation(dn.el.the_widget, 'shake', function(){}, dn.error_delay_ms);\r\n}\r\n\r\n\r\n// ############################\r\n// Sharing stuff\r\n// ############################\r\n\r\ndn.do_share = function(){\r\n    if(!dn.the_file.file_id){\r\n        dn.show_error(\"You cannot view/modify the sharing settings until you have saved the file.\")\r\n        return false;\r\n    }\r\n    dn.status.file_sharing = -1; //TODO: see SO question about no callback for share dialog...how are we supposed to know when it's closed and what happened?\r\n    dn.the_file.is_shared = 0;\r\n    dn.show_status();\r\n\r\n    if(dn.el.share_dialog){\r\n        dn.do_share_sub();\r\n    } else {\r\n        gapi.load('drive-share', function(){\r\n            dn.el.share_dialog = new gapi.drive.share.ShareClient(dn.client_id);\r\n            dn.do_share_sub();\r\n        });\r\n    }\r\n\r\n}\r\n\r\ndn.do_share_sub = function(){\r\n    dn.el.share_dialog.setItemIds([dn.the_file.file_id]);\r\n    dn.el.share_dialog.setOAuthToken(gapi.auth.getToken().access_token);\r\n    dn.el.share_dialog.showSettingsDialog();\r\n}\r\n\r\n// ############################\r\n// Newline stuff\r\n// ############################\r\n\r\ndn.detect_new_line = function(str){\r\n    dn.the_file.new_line_detected = (function(){\r\n        //no special reason to use a self-executing function here, it's just lazy coding\r\n        var first_n = str.indexOf(\"\\n\");\r\n        if(first_n == -1)\r\n            return dn.show_newline_status(\"none\");\r\n    \r\n        var has_rn = str.indexOf(\"\\r\\n\") != -1;\r\n        var has_solo_n = str.match(/[^\\r]\\n/) ? true : false;\r\n        \r\n        if(has_rn && !has_solo_n)\r\n            return dn.show_newline_status(\"windows\");\r\n        if(has_solo_n && !has_rn)\r\n            return dn.show_newline_status(\"unix\")\r\n        \r\n        return dn.show_newline_status(\"mixed\");\r\n    })();    \r\n}\r\n\r\ndn.apply_newline_choice = function(str){\r\n        \r\n    var newlineDefault = dn.g_settings.get('newLineDefault');\r\n    \r\n    if(newlineDefault == \"windows\"){\r\n        dn.el.newline_menu_windows.classList.add('selected')\r\n        dn.el.newline_menu_unix.classList.remove('selected');\r\n    }else{//newlineDefault should be unix\r\n        dn.el.newline_menu_unix.classList.add('selected')\r\n        dn.el.newline_menu_windows.classList.remove('selected');\r\n    }             \r\n                \r\n   if(typeof str == \"string\")\r\n       dn.detect_new_line(str); //Note that it only makes sense to detect new line on downloaded content\r\n   \r\n   dn.show_newline_status(dn.the_file.new_line_detected); //if default changes after load or we have a new file we need this.\r\n   \r\n    dn.el.file_newline_detect.classList.remove('selected');\r\n    dn.el.file_newline_windows.classList.remove('selected');\r\n    dn.el.file_newline_unix.classList.remove('selected');\r\n   if(dn.the_file.custom_props.newline == \"detect\"){\r\n        if(dn.the_file.new_line_detected == \"windows\" || dn.the_file.new_line_detected == \"unix\")\r\n            dn.editor.session.setNewLineMode(dn.the_file.new_line_detected);\r\n        else\r\n            dn.editor.session.setNewLineMode(newlineDefault);    \r\n        dn.el.file_newline_detect.classList.add('selected');\r\n    }else{\r\n        dn.editor.session.setNewLineMode(dn.the_file.custom_props.newline);\r\n            if(dn.the_file.custom_props.newline == \"windows\")\r\n                dn.el.file_newline_windows.classList.add('selected');\r\n            else\r\n                dn.el.file_newline_unix.classList.add('selected');            \r\n    }    \r\n}\r\n\r\ndn.show_newline_status = function(statusStr){\r\n    var str;\r\n    switch(statusStr){\r\n        case 'none':\r\n            str =  \"no newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        case 'mixed':\r\n            str = \"mixture of newlines detected, default is \" + dn.g_settings.get(\"newLineDefault\") + \"-like\";\r\n            break;\r\n        default:\r\n            str = \"detected \" + statusStr + \"-like newlines\";\r\n    }\r\n    \r\n    dn.el.file_newline_info.textContent = \"(\" + str +\")\";\r\n    \r\n    return statusStr;\r\n}\r\n\r\n\r\n// ############################\r\n// Open stuff\r\n// ############################\r\n\r\ndn.new_window_content = \"<html><head><script>\"\r\ndn.open_button_click = function(){\r\n    gapi.load('picker', function(){\r\n        var view = new google.picker.View(google.picker.ViewId.DOCS);\r\n        try{\r\n            if(!dn.open_picker){\r\n                dn.open_picker = new google.picker.PickerBuilder()\r\n                .enableFeature(google.picker.Feature.NAV_HIDDEN)\r\n                .setAppId(dn.client_id) /* the drive scope requires explicit permission to open each file, and by providing the client_id here you get it for the chosen file */\r\n                .setOAuthToken(gapi.auth.getToken().access_token) /* this gives permission to open the picker..you can do it wtihout a user-specific access_token, but we have one so lets use it */\r\n                .addView(view)\r\n                .setCallback(dn.picker_callback)\r\n                .build();        \r\n                if(!dn.open_picker)\r\n                    throw \"could not build picker\";\r\n            }\r\n            dn.open_picker.setVisible(true);\r\n        } catch (e){\r\n            dn.show_error(\"\" + e);\r\n        }\r\n    });\r\n\r\n}\r\n\r\ndn.picker_callback = function(data) {\r\n    if (data.action == google.picker.Action.PICKED) {\r\n        var file_id = data.docs[0].id;\r\n        var url = \"?state=\" + JSON.stringify({\r\n            action: \"open\",\r\n            userId: dn.url_user_id,\r\n            ids: [file_id]\r\n        });\r\n        window.location = url;\r\n    }else if(data.action == \"cancel\"){\r\n        if(dn.open_new_tab)\r\n            dn.open_new_tab.close();\r\n        dn.focus_editor();\r\n    }\r\n    dn.open_new_tab = undefined;\r\n}\r\n\r\n\r\n// ############################\r\n// Widget stuff\r\n// ############################\r\n\r\ndn.show_help_inner = function(inner_pane){\r\n    // expects string 'shorcuts' or 'tips',  any other values shows main\r\n\r\n    dn.el.pane_help_shortcuts.style.display = 'none';\r\n    dn.el.pane_help_tips.style.display = 'none';\r\n    dn.el.pane_help_main.style.display = 'none';\r\n\r\n    dn.el.button_shortcuts.classList.remove('selected');\r\n    dn.el.button_tips.classList.remove('selected');\r\n    \r\n    if(inner_pane == 'tips'){\r\n        dn.el.pane_help_tips.style.display = '';\r\n        dn.el.button_tips.classList.add('selected');\r\n    } else if(inner_pane == 'shortcuts'){\r\n        dn.el.pane_help_shortcuts.style.display = '';\r\n        dn.el.button_shortcuts.classList.add('selected');\r\n    } else {\r\n        dn.el.pane_help_main.style.display = '';\r\n    }\r\n}\r\n\r\ndn.show_pane = function(id){\r\n    var el = document.getElementById(id);\r\n\r\n    // el can be undefined/null to hide everything\r\n    for(var ii=0; ii < dn.el.widget_content.children.length; ii++)if(dn.el.widget_content.children[ii] !== el){\r\n        dn.el.widget_content.children[ii].style.display = 'none';\r\n        var el_icon = dn.menu_icon_from_pane_id[dn.el.widget_content.children[ii].id];\r\n        if(el_icon)\r\n            el_icon.classList.remove('icon_selected');\r\n    }\r\n\r\n    if(el){\r\n        el.style.display = '';\r\n        var el_icon = dn.menu_icon_from_pane_id[el.id];\r\n        if(el_icon)\r\n            el_icon.classList.add('icon_selected')\r\n    }else{\r\n        dn.g_settings.set('pane_open', false);\r\n    }\r\n}\r\n\r\ndn.widget_mouse_down = function(e){\r\n    dn.widget_mouse_down_info = {\r\n            off_left: -e.clientX,\r\n            off_top: -e.clientY,\r\n            start_time: Date.now(),\r\n            is_dragging: e.button !== 0};\r\n    document.addEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.addEventListener('mouseup', dn.document_mouse_up_widget);\r\n}\r\n\r\ndn.document_mouse_move_widget = function(e){\r\n    var x = e.clientX+dn.widget_mouse_down_info.off_left;\r\n    var y = e.clientY+dn.widget_mouse_down_info.off_top;\r\n    if(!dn.widget_mouse_down_info.is_dragging){\r\n        dn.widget_mouse_down_info.is_dragging = (Date.now() - dn.widget_mouse_down_info.start_time > dn.drag_delay_ms)\r\n                                              || (x*x + y*y > dn.drag_shift_px * dn.drag_shift_px);\r\n    }\r\n    if(dn.widget_mouse_down_info.is_dragging)\r\n        translate(dn.el.the_widget, x, y);\r\n    e.stopPropagation();\r\n\r\n};\r\n\r\ndn.document_mouse_up_widget = function(e){\r\n    document.removeEventListener('mousemove', dn.document_mouse_move_widget);\r\n    document.removeEventListener('mouseup', dn.document_mouse_up_widget);\r\n\r\n    if(dn.widget_mouse_down_info.is_dragging){\r\n        var pos = dn.el.the_widget.getBoundingClientRect();\r\n        translate(dn.el.the_widget, 0, 0);\r\n    \r\n        //work out what widget_anchor should be\r\n        var widget_w = dn.el.the_widget.offsetWidth;\r\n        var widget_h = dn.el.the_widget.offsetHeight;\r\n        var window_w = window.innerWidth;\r\n        var window_h = window.innerHeight;\r\n        var anchor = []\r\n        if(pos.left < window_w - (pos.left + widget_w)){\r\n            anchor[0] = 'l'; //anchor left side by window width percentage\r\n            anchor[1] = Math.max(0,pos.left/window_w * 100);\r\n        }else{\r\n            anchor[0] = 'r'; //anchor right side by window width percentage\r\n            anchor[1] = Math.max(0,(window_w - (pos.left + widget_w))/window_w * 100);\r\n        }\r\n        if(pos.top < window_h - (pos.top+ widget_h)){\r\n            anchor[2] = 't'; //anchor top side by window height percentage\r\n            anchor[3] = Math.max(0,pos.top/window_h * 100);\r\n        }else{\r\n            anchor[2] = 'b'; //anchor bottom side by window height percentage\r\n            anchor[3] = Math.max(0,(window_h - (pos.top + widget_h))/window_h * 100);\r\n        }\r\n\r\n        if(dn.g_settings)\r\n            dn.g_settings.set(\"widget_anchor\",anchor); \r\n\r\n    }else{\r\n        dn.g_settings.set('pane_open', !dn.g_settings.get('pane_open'));\r\n    }\r\n    dn.widget_mouse_down_info = undefined;\r\n};\r\n\r\ndn.widget_apply_anchor = function(anchor){\r\n    anchor = Array.isArray(anchor) ? anchor : dn.g_settings.get('widget_anchor');\r\n    var widget_w = dn.el.the_widget.offsetWidth;\r\n    var widget_h = dn.el.the_widget.offsetHeight;\r\n    var window_w = window.innerWidth;\r\n    var window_h = window.innerHeight;\r\n\r\n    if(anchor[0] == 'l'){\r\n        // horizontal position is anchored to a fixed percentage of window width on left of widget\r\n        if(window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = '0px'; //if the widget would overlap the right edge, then instead put it precisely on the right edge\r\n        }else{\r\n            dn.el.the_widget.style.left = anchor[1] + '%';\r\n            dn.el.the_widget.style.right = ''; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.add('flipped');\r\n        dn.el.widget_content.classList.add('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.add('flipped');\r\n\r\n    }else{\r\n        // horizontal position is anchored to a fixed percentage of window width on right of widget\r\n        if( window_w * anchor[1]/100 + widget_w > window_w){\r\n            dn.el.the_widget.style.left = '0px';\r\n            dn.el.the_widget.style.right = ''; //if the widget would overlap the left edge, then instead put it precisely on the left edge\r\n        }else{\r\n            dn.el.the_widget.style.left = 'inherit';\r\n            dn.el.the_widget.style.right = anchor[1] + '%'; //use the anchor exactly\r\n        }\r\n\r\n        // set toolbar position\r\n        dn.el.widget_menu.classList.remove('flipped');\r\n        dn.el.widget_content.classList.remove('flipped');\r\n        var els = document.getElementsByClassName('widget_menu_icon');\r\n        for(var ii=0; ii<els.length; ii++)\r\n            els[ii].classList.remove('flipped');\r\n    }\r\n\r\n    if(anchor[2] == 't'){\r\n        // vertical position is anchored to a fixed percentage of window height on top of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = '0px';  \r\n        }else{\r\n            dn.el.the_widget.style.top = anchor[3] + '%';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }\r\n    }else{\r\n        // vertical position is anchored to a fixed percentage of window height on bottom of widget\r\n        if(window_h * anchor[3]/100 + widget_h > window_h){\r\n            dn.el.the_widget.style.top = '0px';\r\n            dn.el.the_widget.style.bottom = ''; \r\n        }else{\r\n            dn.el.the_widget.style.top = 'inherit';\r\n            dn.el.the_widget.style.bottom = anchor[3] + '%'; \r\n        }\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\ndn.toggle_widget = function(state){\r\n    // provide argument \"true\" to open widget, \"false\" to close\r\n    if(state){\r\n        dn.el.widget_menu.style.display = '';\r\n        dn.el.widget_content.style.display = '';\r\n    }else{\r\n        dn.el.widget_menu.style.display = 'none';\r\n        dn.el.widget_content.style.display = 'none';\r\n    }\r\n}\r\n\r\ndn.show_status = function(){\r\n    // TODO: new file, drag-drop from disk, pristing/saving, modify props, readonly/sharing info\r\n    var s = ''\r\n    if(dn.status.authentication != 1){\r\n        // auth in progress or failed\r\n        if(dn.status.authorization == -1)\r\n            s = \"Authorization required...\";\r\n        else if(dn.status.popup_active)\r\n            s = \"Login/authenticate with popup...\";\r\n        else\r\n            s = \"Authenticating...\";\r\n    } else if (dn.the_file.file_id){\r\n        // a file is/will be loaded...\r\n        if (dn.status.file_meta === 1 && dn.status.file_body === 1){\r\n            s = dn.the_file.title;\r\n            var extra = [];\r\n            if(dn.the_file.is_read_only)\r\n                extra.push(\"read-only\");\r\n            if(dn.the_file.is_shared)\r\n                extra.push(\"shared\");\r\n            if(dn.status.file_sharing == -1)\r\n                extra.push(\"sharing status unknown\");\r\n            if(!dn.the_file.is_pristine)\r\n                extra.push(\"unsaved changes\");\r\n            if(extra.length)\r\n                s += \"\\n[\" + extra.join(', ') + \"]\"; \r\n        }else if(dn.status.file_meta === 0 && dn.status.file_body === 0)\r\n            s = \"Loading file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1 && dn.status.file_body === 0)\r\n            s = \"Loading \" + (dn.the_file.is_read_only? 'read-only ' : '' ) + \r\n                    \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_meta === 0 && dn.status.file_body === 1)\r\n            s = \"Loading metadata for file:\\n\" + dn.the_file.file_id;\r\n        else if(dn.status.file_meta === 1) // and -1\r\n            s = \"Failed to download \" + (dn.the_file.is_read_only? 'read-only ' : '' )\r\n                    +  \"file:\\n\" + dn.the_file.title;\r\n        else if(dn.status.file_body === 1) // and -1\r\n            s = \"Failed to download metadata for file:\\n\" + dn.the_file.file_id;\r\n        else // both -1\r\n            s = \"Failed to load file:\\n\" + dn.the_file.file_id;\r\n    } else {\r\n        // no file to load\r\n        s = \"ex nihilo omnia...\";\r\n    }\r\n\r\n    text_multi(dn.el.widget_text, s, true);\r\n}\r\n\r\ndn.show_error = function(message){\r\n    console.log(message); //it's just useful to do this too\r\n    text_multi(dn.el.widget_error_text, message,true);\r\n    dn.el.widget_error.style.display = '';\r\n    css_animation(dn.el.the_widget, 'shake', function(){\r\n        dn.el.widget_error.style.display = 'none';\r\n    }, dn.error_delay_ms);\r\n};\r\n\r\ndn.set_drive_link_to_folder = function(){\r\n    var els = document.getElementsByClassName('link_drive');\r\n    var href = dn.the_file.folder_id ? \r\n                'https://drive.google.com/#folders/' + dn.the_file.folder_id \r\n                : 'https://drive.google.com';\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].href = href;\r\n}\r\n\r\n\r\n// ############################\r\n// Settings stuff\r\n// ############################\r\n\r\ndn.get_settings_from_cloud = function() {\r\n  gapi.drive.realtime.loadAppDataDocument(\r\n  function(doc) {\r\n    var old_temp_g_settings = dn.g_settings;\r\n    dn.g_settings = doc.getModel().getRoot();\r\n    dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    if(!dn.g_clipboard){\r\n        dn.g_settings.set('clipboard', doc.getModel().createList());\r\n        dn.g_clipboard = dn.g_settings.get('clipboard');\r\n    }\r\n    dn.g_find_history = dn.g_settings.get('findHistory');\r\n    if(!dn.g_find_history){\r\n        dn.g_settings.set('findHistory', doc.getModel().createList());\r\n        dn.g_find_history = dn.g_settings.get('findHistory');\r\n    }\r\n    \r\n    var existingKeys = dn.g_settings.keys();\r\n    dn.g_settings.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED, dn.settings_changed);\r\n    console.log('Applying settings from cloud...')\r\n    for(var s in dn.default_settings)\r\n        if(s in old_temp_g_settings.getKeeps())\r\n            dn.g_settings.set(s,old_temp_g_settings.get(s));\r\n        else if(existingKeys.indexOf(s) == -1)\r\n            dn.g_settings.set(s,dn.default_settings[s]);\r\n        else if(JSON.stringify(old_temp_g_settings.get(s)) !== JSON.stringify(dn.g_settings.get(s)))\r\n            dn.settings_changed({property:s, newValue:dn.g_settings.get(s)});// the gapi doesn't automatically trigger this on load\r\n    \r\n    //Check lastDNVersionUsed at this point - by default it's blank, but could also have an out-of-date value\r\n    if(dn.g_settings.get('lastDNVersionUsed') != dn.version_str){\r\n        dn.g_settings.set('help_inner', 'tips');\r\n        dn.g_settings.set('pane', 'pane_help');\r\n        dn.g_settings.set('pane_open', 'true');\r\n        dn.g_settings.set('lastDNVersionUsed', dn.version_str);\r\n    }\r\n  },\r\n  null,\r\n  function(resp){\r\n        console.log(\"g_settings error\");\r\n        console.dir(arguments);\r\n        if ((resp.type && resp.type == \"token_refresh_required\") || resp.error.code == 401) //not sure if it has an error.code field but it does seem to have a type field\r\n            dn.reauth(function(){console.log(\"reauthed triggered by g_settings\")}); //no real callback here, I think the realtime api somehow disovers that we're back in buisiness\r\n    })\r\n\r\n}\r\n\r\ndn.load_default_settings = function(){\r\n  //Lets show the user either the defualt settings or the \r\n  //ones last used on this browser (restricted to impersonal settings only)\r\n\r\n  dn.g_settings = (function(){ //mock realtime model to be used until the real model is initialised\r\n      var ob = {};\r\n      var keeps = {}\r\n      return {get: function(k){return ob[k]}, \r\n              set: function(k,v){\r\n                if(ob[k] === v)\r\n                    return;\r\n                ob[k] = v;\r\n                dn.settings_changed({property: k, newValue: v});\r\n                },\r\n              keep: function(k){keeps[k] = true},\r\n              getKeeps: function(){return keeps;}};\r\n                                 \r\n  })();\r\n\r\n  dn.status.local_settings = 0;\r\n  try{\r\n    console.log('Loading default/localStorage settings...');\r\n    for(var s in dn.default_settings)\r\n    if(dn.impersonal_settings_keys.indexOf(s) == -1 || !localStorage || !localStorage[\"g_settings_\" +s])\r\n        dn.g_settings.set(s,dn.default_settings[s]);\r\n    else\r\n        dn.g_settings.set(s,JSON.parse(localStorage[\"g_settings_\" + s]));\r\n  }catch(err){\r\n      if(localStorage) \r\n        localStorage.clear();\r\n      console.log(\"Failed to load defaults/localStorage settings.  Have cleared localStorage cache.\")\r\n  }\r\n  dn.status.local_settings = 1;\r\n}\r\n\r\ndn.settings_changed = function(e){\r\n    var new_value = e.newValue;\r\n    console.log(\"[user settings] \" + e.property +\": \" + new_value);\r\n    if(dn.impersonal_settings_keys.indexOf(e.property)>-1 && localStorage){\r\n        localStorage[\"g_settings_\" + e.property] = JSON.stringify(new_value);\r\n    }\r\n    try{\r\n        switch(e.property){\r\n            case \"widget_anchor\":\r\n                dn.widget_apply_anchor(new_value);\r\n                    break;\r\n            case \"theme\":\r\n                dn.editor.setTheme('ace/theme/' + new_value);\r\n                dn.theme_drop_down.SetInd(dn.theme_drop_down.IndexOf(new_value), true);\r\n                break;\r\n            case \"fontSize\":\r\n                var scrollLine = dn.get_scroll_line();\r\n                dn.el.font_size_text.textContent = new_value.toFixed(1);\r\n                dn.editor.setFontSize(new_value + 'em')    \r\n                dn.editor.scrollToLine(scrollLine);\r\n                break;\r\n            case \"wordWrap\":\r\n                var s = dn.editor.getSession();\r\n                var scrollLine = dn.get_scroll_line();\r\n                s.setUseWrapMode(new_value[0]);\r\n                s.setWrapLimitRange(new_value[1],new_value[2]);\r\n                 dn.editor.scrollToLine(scrollLine);\r\n                if(!new_value[0])\r\n                    dn.el.word_wrap_off.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_off.classList.remove('selected');\r\n                if(new_value[0] && !new_value[1])\r\n                    dn.el.word_wrap_edge.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_edge.classList.remove('selected');\r\n                if(new_value[0] && new_value[1])\r\n                    dn.el.word_wrap_at.classList.add('selected');\r\n                else\r\n                    dn.el.word_wrap_at.classList.remove('selected');\r\n\r\n                break;\r\n            case \"wordWrapAt\":\r\n                dn.el.word_wrap_at_text.textContent = new_value;\r\n                var curWrap = dn.g_settings.get('wordWrap');\r\n                if(curWrap[1] && curWrap[1] != new_value)\r\n                    dn.g_settings.set('wordWrap',[1,new_value,new_value]);\r\n                dn.editor.setPrintMarginColumn(new_value);\r\n                break;\r\n            case \"showGutterHistory\":\r\n                var s = dn.editor.getSession(); \r\n                if(new_value){\r\n                    dn.el.gutter_history_show.classList.add('selected')\r\n                    dn.el.gutter_history_hide.classList.remove('selected');\r\n                }else{\r\n                    var h = dn.change_line_history;\r\n                    for(var i=0;i<h.length;i++)if(h[i])\r\n                        s.removeGutterDecoration(i,h[i]<0 ? dn.change_line_classes_rm[-h[i]] : dn.change_line_classes[h[i]]);\r\n                    dn.change_line_history = []; \r\n                    dn.el.gutter_history_hide.classList.add('selected')\r\n                    dn.el.gutter_history_show.classList.remove('selected');\r\n                }\r\n                break;\r\n            case \"newLineDefault\":\r\n                dn.apply_newline_choice();\r\n                break;\r\n            case \"historyRemovedIsExpanded\":\r\n                dn.revision_setis_expaned(new_value);\r\n                break;\r\n            case \"softTabN\":\r\n            case \"tabIsHard\":          \r\n                dn.apply_tab_choice(); \r\n                break;\r\n            case 'pane_open':\r\n                dn.toggle_widget(new_value)\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane_open');\r\n                break;\r\n            case 'pane':\r\n                dn.show_pane(new_value);\r\n                if(dn.g_settings.keep)\r\n                    dn.g_settings.keep('pane');\r\n                if(new_value !== 'pane_help')\r\n                    dn.g_settings.set('help_inner', 'main');\r\n                break; \r\n            case 'help_inner':\r\n                dn.show_help_inner(new_value);\r\n                break;\r\n            case 'find_regex':\r\n                if(new_value)\r\n                    dn.el.find_button_regex.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_regex.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_whole_words':\r\n                if(new_value)\r\n                    dn.el.find_button_whole_words.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_whole_words.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_case_sensitive':\r\n                if(new_value)\r\n                    dn.el.find_button_case_sensitive.classList.add('selected');\r\n                else\r\n                    dn.el.find_button_case_sensitive.classList.remove('selected');\r\n                dn.find_settings_changed();\r\n                break;\r\n            case 'find_replace':\r\n                dn.find_replace_changed(new_value);\r\n                break;\r\n            case 'find_goto':\r\n                dn.find_goto_changed(new_value);\r\n                break;\r\n        }\r\n    }catch(err){\r\n        console.log(\"Error while uptating new settings value.\")\r\n        console.dir(e);\r\n        console.dir(err);\r\n    }\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Font size stuff\r\n// ############################\r\n\r\ndn.font_size_decrement_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size -= dn.font_size_increment;\r\n    font_size = font_size  < dn.min_font_size ? dn.min_font_size: font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\ndn.font_size_increment_click = function(){\r\n    var font_size = dn.g_settings.get('fontSize');\r\n    font_size += dn.font_size_increment;\r\n    font_size = font_size  > dn.max_font_size ? dn.max_font_size:font_size;\r\n    dn.g_settings.set('fontSize', font_size);\r\n}\r\n\r\n\r\n\r\n// ############################\r\n// Tab stuff\r\n// ############################\r\n// Note that there is a whitespace extension for ace but it doesn't look that mature and we actually have slightly different requirements here.\r\n\r\ndn.detect_tab = function(str){    \r\n    dn.the_file.tab_detected = (function(){ //no need to use a self-executing function here, just lazy coding....\r\n        //This function returns an object with a field \"val\" that takes one of the folling values:\r\n        // none: no indents detected at all\r\n        // mixture: no strong bias in favour of spaces or tabs\r\n        // tab: defintely tabs\r\n        // spaces: definitely space. In this case extra fields are provied....\r\n        //   n: number of spaces\r\n        //   isDefault: true if the default nSpaces value was used as part of the decision making process\r\n        //   threshold: this takes one of three values:\r\n        //          strong: the largest n over threshold was used\r\n        //          weak: no n was over the strong threshold, but the default n was over the weak threshold\r\n        //          failed: no idea what n is, so just use default\r\n    \r\n        var lines = dn.editor.session.getLines(0, 1000);    \r\n        var indents = lines.map(function(str){\r\n                        return str.match(/^\\s*/)[0];\r\n                      });\r\n        indents = indents.filter(function(str){return str !== '';});\r\n        \r\n        if(!indents.length)\r\n            return dn.show_tab_status({val: \"none\"});\r\n            \r\n        //TODO: if first thousand lines happen to have few indents it may be worth checking further down.\r\n        \r\n        var stats = indents.reduce(function(stats,str){\r\n           if(str.indexOf('\\t') > -1)\r\n              if(str.indexOf(' ') > -1)\r\n                stats.nWithMixture++;\r\n              else\r\n                stats.nWithOnlyTabs++;\r\n           else\r\n               stats.spaceHist[str.length] = (stats.spaceHist[str.length] || 0) + 1;   \r\n            return stats;\r\n        },{nWithOnlyTabs: 0,spaceHist: [],nWithMixture: 0});\r\n            \r\n        stats.nSamp = indents.length;\r\n        stats.nWithOnlySpaces = stats.nSamp - stats.nWithMixture - stats.nWithOnlyTabs;\r\n        \r\n        console.dir(stats);\r\n            \r\n        if(stats.nWithOnlyTabs/stats.nSamp >= dn.detect_tabs_tabs_frac)\r\n            return dn.show_tab_status({val: \"tab\"});\r\n    \r\n        if(stats.nWithOnlySpaces/stats.nSamp < dn.detect_tabs_spaces_frac)\r\n            return dn.show_tab_status({val: \"mixture\"});\r\n    \r\n        stats.spaceModHist = [];\r\n        var s;\r\n        for(s=dn.min_soft_tab_n;s<=dn.max_soft_tab_n;s++){\r\n            var m = 0;    \r\n            for(var i=s;i<stats.spaceHist.length;i+=s)\r\n                m += stats.spaceHist[i] !== undefined ? stats.spaceHist[i] : 0;\r\n            stats.spaceModHist[s] = m;\r\n        }\r\n        \r\n        for(s=dn.max_soft_tab_n;s>=dn.min_soft_tab_n;s--)\r\n            if(stats.spaceModHist[s]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac)\r\n                break;\r\n                \r\n        if(s < dn.min_soft_tab_n){\r\n            // nothing was over threshold, but rather than give up lets use a weaker threshold on the default space count\r\n            var defaultNSpaces = dn.g_settings.get('softTabN');    \r\n            if(stats.spaceModHist[defaultNSpaces]/stats.nWithOnlySpaces > dn.detect_tabs_n_spaces_frac_for_default)\r\n                return dn.show_tab_status({val: 'spaces', n: defaultNSpaces, isDefault: true, threshold: \"weak\"});\r\n            else\r\n                return dn.show_tab_status({val: \"spaces\", n: defaultNSpaces, isDefault: true, threshold: \"failed\"});\r\n        }else{\r\n            // s is the index of the last element in the spaceModHist array which is over threshold\r\n                return dn.show_tab_status({val: \"spaces\", n: s, isDefault: false, threshold: \"strong\"});\r\n        }\r\n    })();\r\n}\r\n\r\n\r\ndn.show_tab_status = function(d){\r\n    var str;\r\n    var defaultStr = \"\";\r\n    if(dn.g_settings.get(\"tabIsHard\"))\r\n        defaultStr = \"hard tabs\";\r\n    else\r\n        defaultStr = dn.g_settings.get(\"softTabN\") + \" spaces\";\r\n    \r\n    switch(d.val){\r\n        case 'none':\r\n            str = \"no indentations detected, default is \" + defaultStr;\r\n            break;\r\n        case 'mixture':\r\n            str = \"detected mixture of tabs, default is \" + defaultStr;\r\n            break;\r\n        case 'tab':\r\n            str = \"hard tab indentation detected\";\r\n            break;\r\n        case \"spaces\":\r\n            switch(d.threshold){\r\n                case 'strong':\r\n                    str = \"detected soft-tabs of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'weak':\r\n                    str = \"detected close match to default of \" + d.n + \" spaces\";\r\n                    break;\r\n                case 'failed':\r\n                    str = \"detected soft-tabs, assuming default \" + d.n + \" spaces\";\r\n                    break;\r\n            }\r\n    }\r\n    \r\n    dn.el.file_tab_info.textContent = \"(\" + str +\")\";\r\n    return d;\r\n}\r\n\r\ndn.apply_tab_choice = function(){\r\n    var defaultTabIsHard = dn.g_settings.get('tabIsHard');\r\n    var defaultSoftTabN = dn.g_settings.get('softTabN');               \r\n                \r\n    var d;\r\n    var isHard;\r\n    var nSpaces;\r\n    var isDetected;\r\n    \r\n    dn.detect_tab();   \r\n    if(dn.the_file.custom_props.tabs == \"detect\"){\r\n        d = dn.the_file.tab_detected;             \r\n        isDetected = true\r\n    }else{\r\n        try{\r\n            d = JSON.parse(dn.the_file.custom_props.tabs);\r\n        }catch(err){\r\n            d = {val: \"none\"};\r\n        }\r\n    }\r\n    switch(d.val){\r\n        case 'none':\r\n        case 'mixture':\r\n            isHard = defaultTabIsHard;\r\n            nSpaces = defaultSoftTabN;\r\n            break;\r\n        case 'tab':\r\n            isHard = true;\r\n            nSpaces = d.n || defaultSoftTabN;\r\n            break;\r\n        case 'spaces':\r\n            isHard = false;\r\n            nSpaces = d.n;\r\n    }\r\n    \r\n    \r\n    if(isHard){\r\n        dn.editor.session.setUseSoftTabs(false);\r\n    }else{\r\n        dn.editor.session.setUseSoftTabs(true);\r\n        dn.editor.session.setTabSize(nSpaces);\r\n    }\r\n    \r\n    dn.el.tab_soft_text.textContent = defaultSoftTabN;\r\n    if(defaultTabIsHard){\r\n        dn.el.tab_hard.classList.add('selected');\r\n        dn.el.tab_soft.classList.remove('selected');\r\n    }else{\r\n        dn.el.tab_soft.classList.add('selected');\r\n        dn.el.tab_hard.classList.remove('selected');\r\n    }\r\n    \r\n    \r\n    dn.el.file_tab_detect.classList.remove('selected');\r\n    dn.el.file_tab_hard.classList.remove('selected');\r\n    dn.el.file_tab_soft.classList.remove('selected');\r\n    if(isDetected){\r\n        dn.el.file_tab_detect.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }else{\r\n        if(d.val == \"tab\")\r\n            dn.el.file_tab_hard.classList.add('selected');\r\n        else\r\n            dn.el.file_tab_soft.classList.add('selected');\r\n        dn.el.file_tab_soft_text.textContent = nSpaces;\r\n    }     \r\n\r\n\r\n}\r\n\r\ndn.set_file_tabs_to_soft_or_hard = function(val,delta){\r\n    var f = dn.the_file;\r\n    var current = f.custom_props.tabs;\r\n    if(current == \"detect\"){\r\n        current = f.tab_detected;\r\n        if(current.val == 'none' || current.val == \"mixture\")\r\n            current = { val: dn.g_settings.get('tabIsHard') ? \"tab\" : \"spaces\",\r\n                        n: dn.g_settings.get('softTabN')};\r\n    }else{\r\n        try{\r\n            current = JSON.parse(current);\r\n        }catch(err){\r\n            console.log(\"JSON.parse failed in SetFileTabsToSoftOrHard with current=\" + current)\r\n            return;\r\n        }\r\n    }\r\n    var newT = {val: val, n: current.n + delta};\r\n    dn.set_property(\"tabs\",JSON.stringify(newT));\r\n}\r\n// ############################\r\n// Syntax stuff\r\n// ############################\r\n\r\ndn.show_syntax_status = function(d){\r\n    var str = \"detected \" + d.syntax + \" from file extension\";\r\n    //TODO: if we improve upon DetectSyntax will need to add stuff here\r\n    dn.el.file_ace_mode_info.textContent = \"(\" + str + \")\";\r\n    return d.syntax;\r\n}\r\ndn.detect_syntax = function(){\r\n    dn.the_file.syntax_detected = (function(){ //no need to use self-ex-func here, just laziness...\r\n        //TODO: improve upon this\r\n        var title = dn.the_file.title || \"untitled.txt\";\r\n        var mode  = require(\"ace/ext/modelist\").getModeForPath(title);\r\n        dn.the_file.syntax_detected = mode.caption;\r\n        dn.show_syntax_status({syntax: dn.the_file.syntax_detected});\r\n        return mode;\r\n    })();\r\n}\r\n\r\ndn.apply_syntax_choice = function(){\r\n    dn.detect_syntax();\r\n    if(dn.the_file.custom_props[\"aceMode\"] == \"detect\"){\r\n        dn.set_syntax(dn.the_file.syntax_detected);\r\n        dn.el.file_ace_mode_detect.classList.add('selected');\r\n        dn.syntax_drop_down.SetSelected(false);\r\n    }else{\r\n        dn.set_syntax(dn.the_file.custom_props[\"aceMode\"])\r\n        dn.el.file_ace_mode_detect.classList.remove('selected');\r\n        dn.syntax_drop_down.SetSelected(true);\r\n    }\r\n}\r\n\r\ndn.get_current_syntax_name = function(){\r\n    try{\r\n        var modesArray = require(\"ace/ext/modelist\").modesByName;\r\n        return modesArray[dn.editor.session.getMode().$id.split('/').pop()].caption\r\n    }catch(e){\r\n        console.log(\"ERROR in GetCurrentSyntaxName...\");\r\n        console.dir(e);\r\n        return \"Text\";\r\n    }  \r\n}\r\n\r\ndn.set_syntax = function(val){\r\n\r\n    var modesArray = require(\"ace/ext/modelist\").modes;\r\n    var mode;\r\n    var ind;\r\n    \r\n    if(typeof val == \"number\"){\r\n        //val is index into mdoes array\r\n        mode = modesArray[val].mode;\r\n        ind = val;\r\n    }else if(modesArray.indexOf(val) > -1){\r\n        //val is an element of the modelist array\r\n        mode = val.mode;\r\n        ind = modesArray.indexOf(val);\r\n    }else{\r\n        //val is caption of mode in modes array\r\n        for(ind=0;ind<modesArray.length;ind++)if(modesArray[ind].caption == val){\r\n            mode = modesArray[ind].mode;\r\n            break;\r\n        }    \r\n    }\r\n    \r\n    if(dn.syntax_drop_down)\r\n        dn.syntax_drop_down.SetInd(ind,true);\r\n    dn.editor.getSession().setMode(mode);\r\n}\r\n\r\ndn.create_theme_menu = function(){\r\n    var themes = require('ace/ext/themelist');\r\n    var theme_drop_down = new DropDown(Object.keys(themes.themesByName));\r\n    theme_drop_down.addEventListener(\"change\",function(){\r\n        dn.g_settings.set(\"theme\",theme_drop_down.GetVal());\r\n    })\r\n    theme_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return theme_drop_down;\r\n}\r\n\r\ndn.create_syntax_menu = function(){\r\n    var modes = require(\"ace/ext/modelist\").modes;\r\n    \r\n    var syntax_drop_down = new DropDown(modes.map(function(m){return m.caption;}));\r\n    \r\n    syntax_drop_down.addEventListener(\"click\", dn.read_only_bail);\r\n    \r\n    syntax_drop_down.addEventListener(\"click\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"change\",function(){\r\n        dn.set_property(\"aceMode\",syntax_drop_down.GetVal());\r\n    })\r\n    syntax_drop_down.addEventListener(\"blur\",function(){\r\n       dn.focus_editor();\r\n    })\r\n    return syntax_drop_down;\r\n}\r\n\r\n// ############################\r\n// File details stuff\r\n// ############################\r\ndn.read_only_bail = function(e){\r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"The file is read-only, so you cannot change its properties.\");\r\n        e.stopImmediatePropagation();\r\n       dn.focus_editor();\r\n    }\r\n}\r\ndn.create_file_details_tool = function(){\r\n    var els = [dn.el.details_title_text,\r\n               dn.el.details_description_text,\r\n               dn.el.file_newline_detect,\r\n               dn.el.file_newline_windows,\r\n               dn.el.file_newline_unix,\r\n               dn.el.file_tab_detect,\r\n               dn.el.file_tab_soft,\r\n               dn.el.file_tab_hard,\r\n               dn.el.file_ace_mode_detect];\r\n    for(var ii=0; ii< els.length; ii++)\r\n        els[ii].addEventListener(\"click\",dn.read_only_bail); //If file is read only, ReadOnlyBail will prevent the click handlers below from running.\r\n        \r\n    //Title change stuff\r\n    dn.el.details_title_text.addEventListener('click', function(){                \r\n            dn.el.details_title_text.style.display = 'none';\r\n            dn.el.details_title_input.style.display = '';\r\n            dn.el.details_title_input.focus();\r\n            dn.el.details_title_input.select();\r\n    });\r\n    dn.el.details_title_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_title_input.style.display = 'none';\r\n            dn.el.details_title_text.style.display = '';\r\n            var new_val = dn.el.details_title_input.value;\r\n            if(new_val == dn.the_file.title)\r\n                return;\r\n            dn.the_file.title = new_val\r\n            dn.show_file_title(); //includes showStatus\r\n            dn.apply_syntax_choice();\r\n            dn.save_file_title();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_title_input.addEventListener('keyup', function(e){\r\n            if(e.which == WHICH.ENTER)\r\n                dn.el.details_title_input.trigger('blur');\r\n    });\r\n    dn.el.details_title_input.addEventListener('keydown', function(e){\r\n        if(e.which == WHICH.ESC){\r\n            dn.el.details_title_input.value = dn.the_file.title;\r\n            dn.el.details_title_input.trigger('blur');\r\n            dn.ignore_escape = true; //stops ToggleWidget\r\n        }\r\n    });\r\n\r\n    // File action buttons stuff\r\n    dn.el.button_save.addEventListener('click', dn.save_content);\r\n    dn.el.button_print.addEventListener('click', dn.do_print);\r\n    dn.el.button_share.addEventListener('click', dn.do_share);\r\n    dn.el.button_history.addEventListener('click', dn.start_revisions_worker);\r\n\r\n    // Description stuff\r\n    dn.el.details_description_text.addEventListener('click', function(){            \r\n            dn.el.details_description_text.style.display = 'none';\r\n            dn.el.details_description_input.style.display = '';\r\n            dn.el.details_description_input.focus();\r\n    });\r\n    dn.el.details_description_input.addEventListener(\"blur\", function(){\r\n            dn.el.details_description_input.style.display = 'none';\r\n            dn.el.details_description_text.style.display = '';\r\n            var new_val = dn.el.details_description_input.value;\r\n            if(dn.the_file.description === new_val)\r\n                return;\r\n            dn.the_file.description = new_val;\r\n            dn.show_description();\r\n            dn.save_file_description();\r\n           dn.focus_editor();\r\n    });\r\n    dn.el.details_description_input.addEventListener('keydown',function(e){\r\n            if(e.which == WHICH.ESC){\r\n                dn.el.details_description_input.value = dn.the_file.description;\r\n                dn.el.details_description_input.trigger('blur');\r\n                dn.ignore_escape = true;\r\n            }\r\n    });\r\n        \r\n    // File custom props stuff\r\n    dn.el.file_newline_detect.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"detect\");\r\n        dn.focus_editor();      \r\n    });\r\n    dn.el.file_newline_windows.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"windows\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_newline_unix.addEventListener('click', function(){\r\n         dn.set_property(\"newline\",\"unix\");\r\n        dn.focus_editor();\r\n        });\r\n    dn.el.file_tab_detect.classList.add('selected');\r\n    dn.el.file_tab_detect.addEventListener('click', function(){\r\n        dn.set_property(\"tabs\",\"detect\");\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_tab_soft.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",0);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_dec').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",-1);\r\n       dn.focus_editor();\r\n    });\r\n    document.getElementById('file_tab_soft_inc').addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"spaces\",+1);\r\n       dn.focus_editor();\r\n    })\r\n    dn.el.file_tab_hard.addEventListener('click', function(){\r\n        dn.set_file_tabs_to_soft_or_hard(\"tab\",0);\r\n       dn.focus_editor();\r\n    });\r\n    dn.el.file_ace_mode_detect.addEventListener('click', function(){\r\n       dn.set_property(\"aceMode\",\"detect\"); \r\n    });\r\n}\r\n\r\ndn.save_file_description = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    \r\n    dn.save_file(dn.the_file.file_id, {description: dn.the_file.description}, undefined, \r\n                $.proxy(dn.save_done,{description: ++dn.the_file.generation_to_save.description}))\r\n    dn.show_status();\r\n    return;\r\n    \r\n}\r\n\r\ndn.save_file_title = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return;\r\n    }\r\n    //TODO: mime-type IMPORTANT!\r\n\r\n    dn.save_file(dn.the_file.file_id, {title: dn.the_file.title}, undefined, \r\n                $.proxy(dn.save_done,{title: ++dn.the_file.generation_to_save.title}))\r\n    dn.show_status();    \r\n}\r\n\r\ndn.show_file_title = function(){\r\n    dn.el.details_title_text.textContent = 'Title: ' + dn.the_file.title;\r\n    dn.el.details_title_input.value = dn.the_file.title;\r\n    document.title = (dn.the_file.is_pristine ? \"\" : \"*\") + dn.the_file.title;\r\n    dn.show_status();\r\n}\r\n\r\ndn.show_description = function(){\r\n    text_multi(dn.el.details_description_text, 'Description: ' + dn.the_file.description,true);\r\n    dn.el.details_description_input.value = dn.the_file.description;\r\n}\r\n\r\n// ############################\r\n// Save stuff\r\n// ############################\r\n\r\ndn.save_content = function(){\r\n    if(dn.the_file.is_brand_new){\r\n        dn.save_new_file(); \r\n        return false;\r\n    }\r\n    \r\n    if(!dn.the_file.is_pristine){\r\n        dn.the_file.data_to_save.body = dn.editor.getSession().getValue();\r\n        dn.the_file.generation_to_save.body++;\r\n        dn.el.widget_pending.style.display = '';\r\n        dn.the_file.is_saving = true;\r\n        dn.the_file.is_pristine = true;\r\n    }\r\n    \r\n    dn.show_file_title(); //includes a showstatus calls\r\n    dn.do_save();\r\n    return false;\r\n}\r\n\r\ndn.do_save = function (){\r\n    \r\n    if(dn.the_file.is_read_only){\r\n        dn.show_error(\"Cannot save read-only file.\");\r\n        return false;\r\n    }\r\n    \r\n    if(!(dn.the_file.data_to_save.body || dn.the_file.data_to_save.title || dn.the_file.data_to_save.description)){\r\n        dn.show_error(\"No changes since last save.\");\r\n        return false;\r\n    }\r\n\r\n    var gens = {};\r\n    var body, meta;\r\n    if(dn.the_file.data_to_save.body){\r\n        body = dn.the_file.data_to_save.body;\r\n        gens.body = dn.the_file.generation_to_save.body;\r\n    }\r\n    if(dn.the_file.data_to_save.title || dn.the_file.data_to_save.description){\r\n        meta = {};\r\n        if(dn.the_file.data_to_save.title){\r\n            meta.title = dn.the_file.data_to_save.title;\r\n            gens.title = dn.the_file.generation_to_save.title;\r\n        }\r\n        if(dn.the_file.data_to_save.description){\r\n            meta.description = dn.the_file.data_to_save.description; \r\n            gens.description = dn.the_file.generation_to_save.description;\r\n        }\r\n    }\r\n    dn.save_file(dn.the_file.file_id, meta, body, $.proxy(dn.save_done,gens))\r\n    return false;\r\n}\r\n\r\ndn.save_done = function(resp){\r\n    if(resp.error){\r\n        if(resp.error.code == 401){\r\n            dn.reauth(dn.do_save); //will make use of dn.the_file.data_to_save and generation_to_save once auth is done.\r\n        }else{\r\n            var failures = []\r\n            if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n                failures.push(\"body\");\r\n                dn.the_file.is_saving = false;\r\n                dn.the_file.is_pristine = false;\r\n                dn.show_file_title();\r\n                dn.el.widget_pending.style.display = 'none';\r\n                dn.the_file.data_to_save.body = null;\r\n            }\r\n            if(this.title && this.title == dn.the_file.generation_to_save.title)\r\n                failures.push(\"title\");\r\n            if(this.description && this.description == dn.the_file.generation_to_save.description)\r\n                failures.push(\"description\");\r\n            \r\n            if(failures.length){//it's possible that all parts of the save request have since been superceded, so we can ignore this failure\r\n                dn.show_error(\"Failed to save \" +  oxford_comma(failures) + \". Error #\" + resp.error.code + (resp.error.message? \"\\n\" + resp.error.message : \"\"));\r\n                console.dir(resp);\r\n            }            \r\n        }\r\n    }else{//success...\r\n        if(this.body && this.body == dn.the_file.generation_to_save.body){\r\n            dn.the_file.is_saving = false;\r\n            dn.el.widget_pending.style.display = 'none';\r\n            dn.the_file.ext = resp.fileExtension;\r\n            dn.g_settings.set('ext',resp.fileExtension);\r\n            dn.the_file.data_to_save.body = null;\r\n            \r\n            if(dn.the_file.is_brand_new)\r\n                dn.saved_new_file(resp); \r\n        }\r\n        if(this.title && this.title == dn.the_file.generation_to_save.title){\r\n            dn.the_file.data_to_save.title = null;\r\n        }\r\n        if(this.description && this.description == dn.the_file.generation_to_save.description){\r\n            dn.the_file.data_to_save.description = null;\r\n        }\r\n\r\n    }\r\n    dn.show_status();\r\n}\r\n\r\ndn.save_file = function (fileId, fileMetadata, fileText, callback) {\r\n    //if fileId is null then a new file is created (can set fileMetadata.parentNodes = [parentFolderId])\r\n    //fileMetadata or fileText can be null.\r\n    //See https://developers.google.com/drive/v2/reference/files/insert - Request Body for valid metaData.\r\n\r\n    //build a multipart message body\r\n    var boundary = dn.make_boundary();\r\n    var delimiter = \"\\r\\n--\" + boundary + \"\\r\\n\";\r\n    var close_delim = \"\\r\\n--\" + boundary + \"--\";\r\n\r\n    var messageBody = delimiter +\r\n                'Content-Type: application/json\\r\\n' +\r\n                '\\r\\n' + JSON.stringify(fileMetadata ? fileMetadata : {}); //note than in the multipart message upload you must provide some json metadata, even if it's empty.\r\n\r\n    if(fileText){ \r\n        messageBody += delimiter +\r\n                'Content-Type: application/octet-stream\\r\\n' +\r\n                'Content-Transfer-Encoding: base64\\r\\n' +\r\n                '\\r\\n' + btoa(unescape(encodeURIComponent(fileText))); //javascript strings are utf16 encoded, but btoa only accespts ASCII, somehow the two extra functions here smooth over this problem and produce the expected result at the server end.\r\n    }\r\n    messageBody += close_delim;\r\n\r\n    var request = gapi.client.request({\r\n        path: '/upload/drive/v2/files/' + (fileId ? fileId : \"\"),\r\n        method: (fileId? 'PUT' : 'POST'),\r\n        params: {'uploadType': 'multipart'},\r\n        headers: {'Content-Type': 'multipart/mixed; boundary=\"' + boundary + '\"'} ,\r\n        body:   messageBody}\r\n        );\r\n\r\n    request.execute(callback);\r\n}\r\n\r\ndn.make_boundary = function(){\r\n    //for MIME protocol, require a boundary that doesn't exist in the message content.\r\n    //we could check explicitly, but this is essentially guaranteed to be fine:\r\n    // e.g. \"13860126288389.206091766245663\"\r\n    return (new Date).getTime() + \"\" + Math.random()*10;\r\n}\r\n\r\n\r\n// ############################\r\n// Print stuff\r\n// ############################\r\n\r\ndn.do_print = function(){\r\n    var content = dn.editor.session.doc.getAllLines();\r\n    var html = Array(content.length);\r\n\r\n    for(var i=0; i<content.length;i++)\r\n        html[i] = \"<li><div class='printline'>\" + dn.line_to_html(i) + '</div></li>';\r\n\r\n    var printWindow = window.open('','');\r\n    printWindow.document.writeln(\r\n            \"<html><head><title>\" + dn.the_file.title \r\n            + \"</title></head><style>\"\r\n            + ace.require('ace/theme/' + dn.g_settings.get('theme')).cssText + \"\\nbody{font-size:\"\r\n            + dn.g_settings.get('fontSize') *14 +\"px; white-space:pre-wrap;\" + \r\n            \"font-family:'Monaco','Menlo','Ubuntu Mono','Droid Sans Mono','Consolas',monospace;}\"\r\n            + \"\\nli{color:gray;}\\n.printline{color:black;}</style>\" + \r\n            \"<body class='ace-\"+ dn.g_settings.get('theme').replace('_','-') +\"'><ol id='content'>\" + \r\n            html.join(\"\") +\r\n            \"</ol></body></html>\");\r\n    printWindow.print();\r\n    return false;\r\n}\r\n\r\ndn.line_to_html = function (n){\r\n    var printLayer = Object.create(ace.require('ace/layer/text').Text.prototype); \r\n    var tokens  = dn.editor.getSession().getTokens(n);\r\n    var html = [];\r\n    var screenColumn = 0;\r\n    for (var i = 0; i < tokens.length; i++) {\r\n       var token = tokens[i];\r\n       var value = token.value.replace(/\\t/g,'   ');//TODO:deal with tabs properly\r\n       if(value)\r\n           printLayer.$renderToken(html, 0, token, value);\r\n    }\r\n    return html.join('').replace(/&#160;/g,' ');\r\n}\r\n\r\n\r\n// ############################\r\n// Clipboard stuff\r\n// ############################\r\n\r\ndn.document_clipboard_left = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index <= 0)\r\n            return true;\r\n        dn.clipboard_index--;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_right = function(){\r\n        if(!dn.clipboard_active)\r\n            return false;\r\n\r\n        if( dn.clipboard_index >= dn.g_clipboard.length-1)\r\n            return true;\r\n\r\n        dn.clipboard_index++;\r\n        dn.editor.undo();\r\n        dn.editor.insert(dn.g_clipboard.get(dn.clipboard_index));\r\n        return true;\r\n}\r\n\r\ndn.document_clipboard_keyup = function(e){\r\n    if(e.which == 17 || e.which == 91 || !e.ctrlKey){\r\n        $(document).off('keyup',dn.document_clipboard_keyup);\r\n        dn.clipboard_active = false;\r\n        dn.el.pane_clipboard.style.display = 'none';\r\n        if(dn.clipboard_info_timer){\r\n            clearTimeout(dn.clipboard_info_timer);\r\n            dn.clipboard_info_timer = null;\r\n        }\r\n    }\r\n}\r\n\r\ndn.on_paste = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    $(document).on('keyup',dn.document_clipboard_keyup);\r\n    dn.clipboard_active = true;\r\n        \r\n    dn.clipboard_index = dn.g_clipboard.lastIndexOf(text); \r\n    if(dn.clipboard_index == -1){ //it's possible the user copied some text from outside the DN, in which case we will add it to the clipboard now\r\n       dn.clipboard_index = dn.g_clipboard.push(text);\r\n       while(dn.g_clipboard.length >dn.clipboard_max_length) //same as on copy\r\n         dn.g_clipboard.remove(0);\r\n    }\r\n    if(dn.clipboard_info_timer)\r\n        clearTimeout(dn.clipboard_info_timer);\r\n\r\n    dn.clipboard_info_timer = setTimeout(function(){\r\n        dn.clipboard_info_timer = null;\r\n        dn.el.pane_clipboard.style.display = '';\r\n    },dn.clipboard_info_delay);\r\n}\r\n\r\ndn.on_copy = function(text){\r\n    if (dn.g_clipboard === undefined)\r\n        return;\r\n    \r\n    dn.g_clipboard.push(text);\r\n    while(dn.g_clipboard.length >dn.clipboard_max_length)\r\n        dn.g_clipboard.remove(0);\r\n}\r\n\r\ndn.create_clipboard_tool = function(){\r\n    dn.el.pane_clipboard = document.getElementById('pane_clipboard');\r\n    dn.el.button_clear_clipboard.addEventListener('click', function(){\r\n            dn.g_clipboard.clear();\r\n    });\r\n    dn.el.button_clear_find_replace.addEventListener('click', function(){\r\n            dn.g_find_history.clear();\r\n    });\r\n}\r\n\r\n\r\n// ############################\r\n// New file stuff\r\n// ############################\r\n\r\ndn.do_new = function(){\r\n    //TODO: this could actually just be a link, updated in settingschanged-ext\r\n    var base = window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0];\r\n    window.open(base + \"?state=\" + JSON.stringify({\r\n                action: \"create\",\r\n                folderId: dn.the_file.folder_id ? dn.the_file.folder_id : '',\r\n                ext: dn.g_settings.get('ext')}),\"_blank\");\r\n    return false;\r\n}\r\n\r\ndn.create_new_tool = function(){\r\n    dn.el.menu_new.addEventListener('click', dn.do_new);\r\n}\r\n\r\ndn.create_file = function(){\r\n    dn.apply_syntax_choice();\r\n    dn.the_file.is_brand_new = true;\r\n    dn.show_file_title();\r\n    dn.show_description();\r\n    dn.apply_newline_choice();\r\n    dn.apply_tab_choice();\r\n    dn.g_settings.set(\"pane\",\"pane_file\");  \r\n}\r\n\r\ndn.guess_mime_type = function(){\r\n    // we set the mimeType on new files, it's too complicated to try and guess it otherwise (at least for now)\r\n    if(dn.the_file.loaded_mime_type)\r\n        return dn.the_file.loaded_mime_type;\r\n    var plain = \"text/plain\";\r\n    var ext = dn.the_file.title.match(/\\.[0-9a-z]+$/i);\r\n\r\n    if(!ext)\r\n        return plain;\r\n    else\r\n        ext = ext[0].substr(1);\r\n    \r\n    return (ext in dn.ext_to_mime_type)? dn.ext_to_mime_type[ext] : plain;\r\n\r\n}\r\n\r\ndn.save_new_file = function(){\r\n    var f = dn.the_file;\r\n    if(f.is_saving){\r\n        dn.show_error(\"File is being created. Please wait.\");\r\n        return false;\r\n    }\r\n    var meta = {title: f.title, \r\n                description: f.description,\r\n                mimeType: dn.guess_mime_type()};\r\n    var parentId = f.folderId;\r\n    if(parentId) \r\n        meta.parentNodes =[{id:[parentId]}];\r\n    f.data_to_save.body = dn.editor.getSession().getValue();\r\n    f.data_to_save.title = meta.title;\r\n    f.data_to_save.description = meta.description;\r\n    var gens = {title: ++f.generation_to_save.title, description: ++f.generation_to_save.description,body: ++f.generation_to_save.body};\r\n    f.is_saving = true;\r\n    f.is_pristine = true;\r\n    dn.show_file_title();\r\n    dn.el.widget_pending.style.display = '';\r\n    dn.show_status();\r\n    dn.save_file(null, meta, f.data_to_save.body, $.proxy(dn.save_done,gens));\r\n}\r\n\r\ndn.saved_new_file = function(resp){\r\n    dn.the_file.is_brand_new = false;\r\n    dn.the_file.file_id = resp.id;\r\n    dn.the_file.is_shared = resp.shared;\r\n    dn.status.file_sharing = 1;\r\n    dn.the_file.ext = resp.fileExtension;\r\n    history.replaceState({},dn.the_file.title,\r\n            window.location.href.match(/^https?:\\/\\/[\\w-.]*\\/\\w*/)[0] +\r\n                \"?state={\\\"action\\\":\\\"open\\\",\\\"ids\\\":[\\\"\" + dn.the_file.file_id + \"\\\"]}\");\r\n    dn.set_drive_link_to_folder();\r\n    dn.save_all_file_properties();\r\n}\r\n\r\n// ############################\r\n// Scrolling stuff\r\n// ############################\r\n\r\ndn.save_scroll_line = function(){\r\n    dn.patch_property(dn.the_file.file_id, \r\n                    \"ScrollToLine\",\r\n                    dn.get_scroll_line(),\r\n                    'PUBLIC',null);\r\n}\r\n\r\ndn.get_scroll_line = function(){\r\n    return  dn.editor.getSession().screenToDocumentPosition(dn.editor.renderer.getScrollTopRow(),0).row;\r\n}\r\n\r\n// ############################\r\n// Load stuff\r\n// ############################\r\n\r\n\r\ndn.load_file = function(flag){\r\n    //we assume that we only ever load one fileid per page load\r\n    var file_id = dn.the_file.file_id; \r\n\r\n    dn.show_status();\r\n\r\n    /*TODO dn.reauth */\r\n    \r\n    dn.status.file_meta = 0;\r\n    var promise_get_meta = Promise.resolve(\r\n        gapi.client.request({\r\n            'path': '/drive/v3/files/' + file_id,\r\n            'params':{'fields': 'name,mimeType,description,parents,capabilities,fileExtension,shared'}}))\r\n        .then(dn.load_file_got_meta_data, function(err){\r\n            dn.show_error(err.result.error.message);\r\n            dn.status.file_meta = -1;\r\n            dn.show_status();\r\n            throw err;\r\n        })\r\n\r\n    dn.status.file_body = 0;\r\n    var promise_get_body = Promise.resolve(\r\n        gapi.client.request({\r\n            'path': '/drive/v3/files/' + file_id,\r\n            'params':{'alt': 'media'}\r\n        }))            \r\n        .then(dn.load_file_got_file_body, function(err){\r\n            dn.show_error(err.result.error.message);\r\n            dn.status.file_body = -1;\r\n            dn.show_status();\r\n            throw err;\r\n        });\r\n\r\n    \r\n    dn.pr_the_file = Promise.all([promise_get_meta, promise_get_body])\r\n    .then(function(){ \r\n        //success\r\n    }, function(){\r\n        // failure\r\n        document.title = \"Drive Notepad\";\r\n        dn.g_settings.set('pane', 'pane_help');\r\n        dn.g_settings.set('pane_open', true);\r\n        \r\n    })\r\n    \r\n}\r\n\r\ndn.load_file_got_meta_data = function(resp) {\r\n    if (resp.error)\r\n        throw Error(resp.error);\r\n    dn.the_file.title = resp.result.name;\r\n    dn.the_file.description = resp.result.description || '';\r\n    dn.show_description();\r\n    dn.the_file.ext = resp.result.fileExtension\r\n    dn.the_file.is_read_only = !resp.result.capabilities.canEdit;\r\n    dn.the_file.is_shared = resp.result.shared; \r\n    dn.the_file.loaded_mime_type = resp.result.mimeType;\r\n    if(resp.result.parents && resp.result.parents.length){\r\n        dn.the_file.folder_id = resp.result.parents[0];\r\n        dn.set_drive_link_to_folder();\r\n    }\r\n    dn.show_file_title(); //includes a showStatus call\r\n    dn.status.file_meta = 1;\r\n    dn.show_status();\r\n} \r\n\r\ndn.load_file_got_file_body = function(resp){\r\n    dn.show_status();\r\n    dn.setting_session_value = true;\r\n    dn.editor.session.setValue(resp.body);\r\n    dn.setting_session_value = false;\r\n    dn.apply_newline_choice(resp.body);\r\n    dn.apply_syntax_choice();\r\n    dn.apply_tab_choice(); \r\n    dn.status.file_body = 1;\r\n    dn.show_status();\r\n}\r\n\r\n\r\n// ############################\r\n// Change/history stuff\r\n// ############################\r\n\r\ndn.on_change = function(e){\r\n    //console.dir(e);\r\n\r\n    if(!e.start || !e.end || dn.setting_session_value)\r\n        return;\r\n        \r\n    if(dn.the_file.is_pristine){\r\n        dn.the_file.is_pristine = false;\r\n        dn.show_file_title();\r\n        dn.show_status();\r\n    }\r\n\r\n    if(!dn.g_settings.get('showGutterHistory'))\r\n        return;\r\n\r\n    var nClasses = dn.change_line_classes.length-1;\r\n    var h = dn.change_line_history;\r\n    var s = dn.editor.getSession(); \r\n\r\n    var start_row = e.start.row;\r\n    var end_row = e.end.row;\r\n\r\n    if(dn.last_change && dn.last_change.start_row == start_row && dn.last_change.end_row == end_row && start_row == end_row\r\n        && dn.last_change.action.indexOf(\"Text\") != -1 && e.action.indexOf(\"Text\") != -1){\r\n            //if this change and the last change were both on the same single lines with action (insert|remove)Text...\r\n\r\n            if(dn.last_change.action == e.action){\r\n                return; //same action as last time\r\n            }else if(e.action == \"removeText\"){ // new action is removeText, old action was insertText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                h[start_row] = -nClasses;\r\n                dn.last_change.action = \"removeText\";\r\n                return;\r\n            }else{// new action is isnertText, old action was removeText\r\n                s.removeGutterDecoration(start_row,dn.change_line_classes_rm[nClasses]);\r\n                s.addGutterDecoration(start_row,dn.change_line_classes[nClasses]);\r\n                h[start_row] = nClasses;\r\n                dn.last_change.action = \"insertText\";\r\n                return;\r\n            }\r\n\r\n    }else{\r\n        //otherwise we have an acutal new change\r\n        dn.last_change = {start_row: start_row, end_row: end_row, action: e.action};\r\n    }\r\n\r\n    //remove all visible decorations and update the changeLineHistory values (we'll add in the new classes at the end)\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.removeGutterDecoration(i,h[i] < 0 ? \r\n                    dn.change_line_classes_rm[-h[i]++] : \r\n                    dn.change_line_classes[h[i]--]);\r\n\r\n    //Update the changeLineHistory relating to the current changed lines\r\n    if(e.action == \"removeLines\"){\r\n        h.splice(start_row, end_row - start_row + 1);        \r\n        h[start_row] = h[start_row+1] = -nClasses;\r\n    }else if(e.action === \"removeText\"){\r\n        h[start_row] = -nClasses;\r\n    }else{\r\n        var newLineCount = 0;\r\n        if(e.action == \"insertText\")\r\n            newLineCount = (e.text.match(/\\n/g) || []).length;\r\n        if(e.action == \"insertLines\")\r\n            newLineCount = e.lines.length;\r\n        h.splice.apply(h,[start_row,0].concat(Array(newLineCount)));\r\n\r\n        for(var i=start_row;i<=end_row;i++)\r\n            h[i] = nClasses;\r\n\r\n    }\r\n\r\n    for(var i=0;i<h.length;i++)if(h[i])\r\n        s.addGutterDecoration(i,h[i]<0 ?\r\n                dn.change_line_classes_rm[-h[i]] :\r\n                dn.change_line_classes[h[i]]);\r\n} \r\n\r\ndn.query_unload = function(){\r\n    if(!dn.the_file.is_pristine)\r\n        return \"If you leave the page now you will loose the unsaved \" + (dn.the_file.is_brand_new ? \"new \" : \"changes to \") + \"file '\" + dn.the_file.title + \"'.\"\r\n}\r\n\r\n\r\n// ############################\r\n// Properties stuff\r\n// ############################\r\ndn.property_updated = function(propKey,new_val){\r\n    console.log(\"[file custom property]  \" + propKey + \": \" + new_val);\r\n    switch(propKey){\r\n        case \"newline\":\r\n            dn.apply_newline_choice();\r\n            break;\r\n        case \"tabs\":            \r\n            dn.apply_tab_choice();\r\n            break;\r\n        case \"aceMode\":\r\n            dn.apply_syntax_choice();\r\n            break;\r\n    }\r\n    \r\n}\r\n\r\ndn.load_default_properties = function(){\r\n    for(var k in dn.default_custom_props)\r\n        dn.set_property(k,dn.default_custom_props[k]);\r\n}\r\n\r\ndn.get_properties_from_cloud = function() {    \r\n    // TODO:\r\n    /*\r\n    gapi.client.drive.properties.list({\r\n    'fileId': dn.the_file.file_id\r\n    }).execute(dn.got_all_file_properties);*/\r\n}\r\n\r\ndn.got_all_file_properties = function(resp){\r\n    if(resp.items){\r\n        dn.the_file.custom_prop_exists = {};\r\n        for(var i=0;i<resp.items.length;i++){\r\n            dn.the_file.custom_props[resp.items[i].key] = resp.items[i].value;\r\n            dn.the_file.custom_prop_exists[resp.items[i].key] = true;\r\n            dn.property_updated(resp.items[i].key,resp.items[i].value);\r\n        }\r\n    }\r\n}\r\n\r\ndn.save_all_file_properties = function(){\r\n    //To be used after creating a file, in order to set any of the props which had been modified before saving it\r\n    for(var k in dn.the_file.custom_props)\r\n        dn.set_property(k,dn.the_file.custom_props[k]);    \r\n}\r\n\r\ndn.set_property = function(prop_name,new_val){\r\n\r\n    var oldVal = dn.the_file.custom_props[prop_name]; \r\n    dn.the_file.custom_props[prop_name] = new_val;\r\n    if(oldVal !== new_val)\r\n        dn.property_updated(prop_name,new_val);\r\n\r\n    if(!(gapi && gapi.drive && dn.the_file.file_id))\r\n        return;\r\n\r\n    var dummyCallback = function(){}; //TODO: may want to do some error handling or something\r\n    \r\n    if(dn.default_custom_props[prop_name] == new_val){ //note that this is true in particular when SetProperty is called within LoadDefaultProperties\r\n        if(dn.the_file.custom_prop_exists[prop_name]){\r\n             dn.the_file.custom_prop_exists[prop_name] = false;\r\n             gapi.client.drive.properties.delete({ //DELTE the property, which does exist, but is no longer required because the value has been set to the default\r\n                fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC'\r\n                }).execute(dummyCallback);\r\n        }\r\n        //if the property doesn't exist and it's just been set to the default then we don't need to do anything.\r\n    }else{            \r\n        if(dn.the_file.custom_prop_exists[prop_name] && oldVal !== new_val){\r\n            gapi.client.drive.properties.patch({ //PATCH the property, which already exists\r\n            fileId: dn.the_file.file_id, propertyKey: prop_name, visibility: 'PUBLIC', resource: {'value': new_val}\r\n            }).execute(dummyCallback);\r\n        }else{\r\n            dn.the_file.custom_prop_exists[prop_name] = true; //INSERT the property, because it doesn't yet exist, we may be coming via dn.save_all_file_properties() above\r\n            gapi.client.drive.properties.insert({\r\n            'fileId': dn.the_file.file_id, 'resource': {key: prop_name, value: new_val, visibility: 'PUBLIC'}\r\n            }).execute(dummyCallback)\r\n        }\r\n    }\r\n}\r\n\r\n\r\n// ############################\r\n// Drag-drop stuff\r\n// ############################\r\n//TODO: this may have a few bugs since it's not been tested for a while\r\n\r\ndn.document_drag_over = function (evt) {\r\n    evt = evt.originalEvent;\r\n    evt.stopPropagation();\r\n    evt.preventDefault();\r\n    if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine)){\r\n        evt.dataTransfer.dropEffect = 'none';\r\n        if(dn.can_show_drag_drop_error){\r\n            dn.show_error(\"File drag-drop is only permitted when the Drive Notpad page is displaying a new and unmodified file.\")\r\n            dn.can_show_drag_drop_error = false; //wait at least ERROR_DELAY_MS until displaying the error again\r\n            setTimeout(function(){dn.can_show_drag_drop_error = true;},dn.error_delay_ms);\r\n        }\r\n        return;\r\n    }\r\n    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.\r\n}\r\n    \r\ndn.document_drop_file = function(evt){\r\n     if(!(dn.the_file.is_brand_new && dn.the_file.is_pristine))\r\n        return;\r\n        \r\n   evt = evt.originalEvent;\r\n   evt.stopPropagation();\r\n   evt.preventDefault();\r\n   \r\n   var files = evt.dataTransfer.files;\r\n   if(files.length > 1){\r\n       dn.show_error(\"You cannot drag-drop multiple files onto the Drive Notepad page, only individual files.\")\r\n   }\r\n   var file = files[0];\r\n   dn.the_file.title = file.name;\r\n   dn.create_file();\r\n   dn.the_file.isReading_file_object = true;   \r\n   dn.show_status();\r\n   var r = new FileReader();\r\n   r.onload = dn.dropped_file_read;\r\n   r.readAsText(file);      \r\n}\r\n\r\ndn.dropped_file_read = function(e){\r\n    dn.the_file.isReading_file_object = false;\r\n    dn.editor.getSession().setValue(e.target.result);\r\n    // Note we don't encolse the above in a dn.setting_session_value = true block so the change event will fire and set pristine to false and ShowStatus etc.\r\n}\r\n\r\ndn.focus_editor = function(){\r\n   dn.editor.focus();\r\n}\r\n// ############################\r\n// Page ready stuff\r\n// ############################\r\n\r\n\r\ndn.document_ready = function(e){\r\n\r\n    // widget :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.the_widget = document.getElementById('the_widget');\r\n    dn.el.widget_text = document.getElementById('widget_text');\r\n    dn.el.widget_error_text = document.getElementById('widget_error_text');\r\n    dn.el.widget_error = document.getElementById('widget_error');\r\n    dn.el.widget_content = document.getElementById('widget_content');\r\n    dn.el.widget_pending = document.getElementById('widget_pending');\r\n    dn.el.the_widget.addEventListener('mousedown', dn.widget_mouse_down);\r\n    translate(dn.el.the_widget, 0, 0);\r\n    dn.el.the_widget.style.display = '';\r\n    dn.el.widget_error.style.display = 'none';\r\n    dn.el.widget_content.addEventListener('mousedown', function(e){\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    });\r\n    var els = dn.el.widget_content.getElementsByTagName('input');\r\n    for(var ii=0; ii<els.length; ii++)\r\n        els[ii].addEventListener('mousedown', stop_propagation); // prevents propagation to preventDefault, installed above.\r\n\r\n    // editor :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    var editor_el = document.getElementById('the_editor');\r\n    editor_el.innerHTML = '';\r\n    editor_el.addEventListener('contextmenu', function(e){\r\n        dn.show_error(\"See the list of keyboard shortcuts for copy/paste, select-all, and undo/redo.\")\r\n    });\r\n    dn.editor = ace.edit(\"the_editor\");\r\n    dn.editor.setHighlightSelectedWord(true);\r\n    dn.el.ace_content = document.getElementsByClassName('ace_content')[0];\r\n    dn.editor.getSession().addEventListener(\"change\", dn.on_change);\r\n    dn.focus_editor();\r\n    dn.editor.on(\"paste\", dn.on_paste);\r\n    dn.editor.on(\"copy\", dn.on_copy);\r\n    dn.editor.setAnimatedScroll(true);\r\n    dn.editor.$blockScrolling = Infinity; // disables scrolling message\r\n    \r\n    // widget menu ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.widget_menu = document.getElementById('widget_menu');\r\n    dn.el.menu_open = document.getElementById('menu_open');\r\n    dn.el.menu_find = document.getElementById('menu_find');\r\n    dn.el.menu_help = document.getElementById('menu_help');\r\n    dn.el.menu_file = document.getElementById('menu_file');\r\n    dn.el.menu_general_settings = document.getElementById('menu_general_settings');\r\n    dn.el.widget_menu.addEventListener('mousedown', stop_propagation);\r\n    dn.menu_icon_from_pane_id = {}\r\n    var els = dn.el.widget_menu.getElementsByClassName('widget_menu_wrapper');\r\n    for(var ii=0; ii<els.length; ii++){\r\n        els[ii].addEventListener(\"mousedown\", prevent_default);\r\n        els[ii].title = dn.menu_id_to_caption[els[ii].id];\r\n        els[ii].innerHTML = \"<div class='widget_menu_icon' id='icon_\" + els[ii].id + \"'></div>\";\r\n        var el_icon = els[ii].getElementsByClassName('widget_menu_icon')[0];\r\n        dn.menu_icon_from_pane_id['pane_' + els[ii].id.substr(5)] = el_icon;\r\n    }\r\n\r\n     // pane file ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_file = document.getElementById('pane_file');\r\n    dn.el.details_title_input  = document.getElementById('details_file_title_input');\r\n    dn.el.details_title_text = document.getElementById('details_file_title_text');\r\n    dn.el.details_description_input  = document.getElementById('details_file_description_input');\r\n    dn.el.details_description_text = document.getElementById('details_file_description_text');    \r\n    dn.el.file_ace_mode_choose = document.getElementById('file_ace_mode_choose')\r\n    dn.el.file_ace_mode_detect = document.getElementById('file_ace_mode_detect');\r\n    dn.el.file_ace_mode_info = document.getElementById('file_ace_mode_info');\r\n    dn.el.file_newline_detect = document.getElementById('file_newline_detect');\r\n    dn.el.file_newline_windows = document.getElementById('file_newline_windows');\r\n    dn.el.file_newline_unix = document.getElementById('file_newline_unix');\r\n    dn.el.file_newline_info = document.getElementById('file_newline_info');\r\n    dn.el.file_tab_detect = document.getElementById('file_tab_detect');\r\n    dn.el.file_tab_hard = document.getElementById('file_tab_hard');\r\n    dn.el.file_tab_soft = document.getElementById('file_tab_soft');\r\n    dn.el.file_tab_soft_text = document.getElementById('file_tab_soft_text');\r\n    dn.el.file_tab_info = document.getElementById('file_tab_info');\r\n    dn.el.button_save = document.getElementById('button_save');\r\n    dn.el.button_print = document.getElementById('button_print');\r\n    dn.el.button_share = document.getElementById('button_share');\r\n    dn.el.button_history = document.getElementById('button_history');     \r\n    dn.syntax_drop_down = dn.create_syntax_menu();   // TODO: tidy up\r\n    dn.el.file_ace_mode_choose.appendChild(dn.syntax_drop_down.el);\r\n    dn.create_file_details_tool();\r\n    dn.el.menu_file.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_file');\r\n    })\r\n\r\n     // pane general settings :::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_general_settings = document.getElementById('pane_general_settings');\r\n    dn.el.theme_chooser = document.getElementById('theme_chooser')\r\n    dn.el.widget_sub_general_box = document.getElementById('sub_general_box')\r\n    dn.el.button_clear_clipboard = document.getElementById(\"button_clear_clipboard\");\r\n    dn.el.button_clear_find_replace = document.getElementById(\"button_clear_find_replace\");\r\n    dn.el.gutter_history_show = document.getElementById('gutter_history_show');\r\n    dn.el.gutter_history_hide = document.getElementById('gutter_history_hide');\r\n    dn.el.word_wrap_off = document.getElementById('word_wrap_off');\r\n    dn.el.word_wrap_at = document.getElementById('word_wrap_at');\r\n    dn.el.word_wrap_edge = document.getElementById('word_wrap_edge');\r\n    dn.el.font_size_decrement = document.getElementById('font_size_decrement');\r\n    dn.el.font_size_increment = document.getElementById('font_size_increment');\r\n    dn.el.font_size_text = document.getElementById('font_size_text');\r\n    dn.el.tab_hard = document.getElementById('tab_hard');\r\n    dn.el.tab_soft = document.getElementById('tab_soft');\r\n    dn.el.newline_menu_windows = document.getElementById('newline_menu_windows');\r\n    dn.el.newline_menu_unix = document.getElementById('newline_menu_unix');\r\n    dn.el.tab_soft_text = document.getElementById('tab_soft_text');\r\n    dn.el.tab_soft_dec = document.getElementById('tab_soft_dec');\r\n    dn.el.tab_soft_inc = document.getElementById('tab_soft_inc');\r\n    dn.el.word_wrap_at_text = document.getElementById('word_wrap_at_text');\r\n    dn.el.word_wrap_at_dec = document.getElementById('word_wrap_at_dec');\r\n    dn.el.word_wrap_at_inc = document.getElementById('word_wrap_at_inc');\r\n    dn.theme_drop_down = dn.create_theme_menu()  // TODO: tidy this up\r\n    dn.el.theme_chooser.appendChild(dn.theme_drop_down.el);\r\n    dn.el.newline_menu_windows.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'windows');\r\n    });\r\n    dn.el.newline_menu_unix.addEventListener('click', function(){\r\n        dn.g_settings.set('newLineDefault', 'unix');\r\n    });\r\n    dn.el.tab_hard.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 1)\r\n    });\r\n    dn.el.tab_soft.addEventListener('click', function(){\r\n        dn.g_settings.set('tabIsHard', 0);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') - 1;\r\n        at = at < dn.min_soft_tab_n ? dn.min_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.tab_soft_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('softTabN') + 1;\r\n        at = at > dn.max_soft_tab_n ? dn.max_soft_tab_n : at;\r\n        dn.g_settings.set('softTabN',at);\r\n    });\r\n    dn.el.font_size_decrement.addEventListener('click', dn.font_size_decrement_click);\r\n    dn.el.font_size_increment.addEventListener('click', dn.font_size_increment_click);    \r\n    dn.el.word_wrap_off.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[0,0,0])\r\n    });\r\n    dn.el.word_wrap_at.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt');\r\n        dn.g_settings.set('wordWrap',[1,at,at]);\r\n    });\r\n    dn.el.word_wrap_at_dec.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') - dn.wrap_at_increment;\r\n        at = at < dn.min_wrap_at ? dn.min_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_at_inc.addEventListener('click', function(){\r\n        var at = dn.g_settings.get('wordWrapAt') + dn.wrap_at_increment;\r\n        at = at > dn.max_wrap_at ? dn.max_wrap_at : at;\r\n        dn.g_settings.set('wordWrapAt',at);\r\n    });\r\n    dn.el.word_wrap_edge.addEventListener('click', function(){\r\n        dn.g_settings.set('wordWrap',[1,null,null])\r\n    });\r\n    dn.el.gutter_history_show.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',1);\r\n    });\r\n    dn.el.gutter_history_hide.addEventListener('click', function(){\r\n        dn.g_settings.set('showGutterHistory',0);\r\n    });\r\n    dn.create_clipboard_tool();\r\n    dn.el.menu_general_settings.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_general_settings');\r\n    })\r\n\r\n    // pane permissions :::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_permissions = document.getElementById('pane_permissions');\r\n    document.getElementById('button_auth').addEventListener('click', dn.launch_popup);\r\n\r\n    // pane help ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_help = document.getElementById('pane_help');\r\n    dn.el.user_name = document.getElementById('user_name');\r\n    dn.el.pane_help_shortcuts = document.getElementById('pane_help_shortcuts');\r\n    dn.el.pane_help_tips = document.getElementById('pane_help_tips');\r\n    dn.el.pane_help_main = document.getElementById('pane_help_main');\r\n    dn.el.button_shortcuts = document.getElementById('button_view_shortcuts');\r\n    dn.el.button_tips = document.getElementById('button_view_tips');\r\n    dn.el.button_shortcuts.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'shortcuts')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'shortcuts');\r\n    })\r\n    dn.el.button_tips.addEventListener('click', function(){\r\n        if(dn.g_settings.get('help_inner') === 'tips')\r\n            dn.g_settings.set('help_inner', 'main');\r\n        else\r\n            dn.g_settings.set('help_inner', 'tips');\r\n    })\r\n    dn.el.menu_help.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_help');\r\n    })\r\n    dn.create_pane_shortcuts();\r\n\r\n    // pane find ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::    \r\n    dn.el.pane_find = document.getElementById('pane_find');\r\n    dn.el.find_button_case_sensitive = document.getElementById('button_find_case_sensitive');\r\n    dn.el.find_button_whole_words = document.getElementById('button_find_whole_words');\r\n    dn.el.find_button_regex = document.getElementById('button_find_regex');\r\n    dn.el.find_input = document.getElementById('find_input');\r\n    dn.el.find_goto_input = document.getElementById('goto_input');\r\n    dn.el.find_replace_input = document.getElementById('find_replace_input');\r\n    dn.el.find_info = document.getElementById('find_info');\r\n    dn.el.find_results = document.getElementById('find_results');\r\n    dn.el.find_info_overflow = document.getElementById('find_info_overflow');\r\n    dn.el.button_goto = document.getElementById('button_goto');\r\n    dn.el.button_replace = document.getElementById('button_replace');\r\n    dn.el.find_goto_wrapper = document.getElementById('find_goto_wrapper');\r\n    dn.el.find_find_wrapper = document.getElementById('find_find_wrapper');\r\n    dn.el.find_replace_wrapper = document.getElementById('find_replace_wrapper');\r\n    dn.el.button_find_replace_all = document.getElementById('button_find_replace_all');\r\n    dn.el.find_button_case_sensitive.addEventListener('click', function(){\r\n        dn.g_settings.set('find_case_sensitive', !dn.g_settings.get('find_case_sensitive'));\r\n    })\r\n    dn.el.find_button_whole_words.addEventListener('click', function(){\r\n        dn.g_settings.set('find_whole_words', !dn.g_settings.get('find_whole_words'));\r\n    })\r\n    dn.el.find_button_regex.addEventListener('click', function(){\r\n        dn.g_settings.set('find_regex', !dn.g_settings.get('find_regex'));\r\n    })\r\n    dn.el.menu_find.addEventListener('click', function(){\r\n        dn.g_settings.set('pane', 'pane_find');\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    });\r\n    dn.el.find_goto_input.addEventListener('keydown', dn.find_goto_input_keydown);\r\n    dn.el.find_goto_input.addEventListener('keyup', dn.find_goto_input_keyup);\r\n    dn.el.find_goto_input.addEventListener('blur', dn.find_goto_input_blur);\r\n    dn.el.find_goto_input.addEventListener('focus', dn.find_goto_input_focus);\r\n    dn.el.find_input.addEventListener('keyup', dn.find_input_keyup);\r\n    dn.el.find_input.addEventListener('keydown', dn.find_input_keydown);\r\n    dn.el.find_input.addEventListener('blur', dn.find_inputs_blur);\r\n    dn.el.find_input.addEventListener('focus', dn.find_inputs_focus);\r\n    dn.el.find_replace_input.addEventListener('blur', dn.find_inputs_blur);\r\n    dn.el.find_replace_input.addEventListener('focus', dn.find_inputs_focus);\r\n    dn.el.find_replace_input.addEventListener('keydown', dn.find_replace_input_keydown);\r\n    dn.el.button_find_replace_all.addEventListener('click', dn.find_replace_click);\r\n    dn.el.button_replace.addEventListener('click', function(){\r\n        dn.g_settings.set('find_replace', !dn.g_settings.get('find_replace'));\r\n        dn.g_settings.set('find_goto', false);\r\n        dn.el.find_input.focus();\r\n    })\r\n    dn.el.button_goto.addEventListener('click', function(){\r\n        dn.g_settings.set('find_goto', !dn.g_settings.get('find_goto'));\r\n        if(dn.g_settings.get('find_goto'))\r\n            dn.el.find_goto_input.focus();\r\n        else\r\n            dn.el.find_input.focus();\r\n    })\r\n\r\n    // pane open ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.el.pane_open = document.getElementById('pane_open');\r\n    dn.el.opener_button_a = document.getElementById('opener_button_a');\r\n    dn.el.menu_open.addEventListener('click', function(){    \r\n        dn.g_settings.set('pane', 'pane_open');\r\n    });\r\n    dn.el.opener_button_a.addEventListener('click', dn.open_button_click);\r\n\r\n    // :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\r\n    dn.make_keyboard_shortcuts();\r\n    dn.load_default_settings();\r\n    dn.load_default_properties();    \r\n    document.addEventListener('contextmenu', prevent_default);\r\n    document.addEventListener('dragover', dn.document_drag_over);\r\n    document.addEventListener('drop', dn.document_drop_file);\r\n    window.addEventListener('resize', dn.widget_apply_anchor);\r\n    window.onbeforeunload = dn.query_unload;\r\n\r\n    //work out what caused the page to load\r\n    var params = window_location_to_params_object(); \r\n    if(params['state']){\r\n        var state = {};\r\n        try{\r\n            state = JSON.parse(params['state']);    \r\n        }catch(e){\r\n            dn.show_error(\"Bad URL params:\\n\" + params['state']);\r\n        }\r\n        if(state.action && state.action == \"open\" && state.ids && state.ids.length > 0){\r\n            dn.the_file.file_id = state.ids[0];\r\n        }else if(state.action && state.action == \"create\"){\r\n            dn.the_file.title = \"untitled.\" + (state.ext ? state.ext : dn.g_settings.get('ext'));\r\n            if(state.folderId)\r\n                dn.the_file.folder_id = state.folderId;\r\n            dn.create_file(); //will use the specified title and folderId\r\n        }\r\n    }else{\r\n        dn.the_file.title = \"untitled.\" + dn.g_settings.get('ext');\r\n        dn.create_file();\r\n    }\r\n\r\n    dn.pr_auth.then(dn.authentication_done); // authentication Promise-like defined inline at top of html head\r\n    dn.show_status(); \r\n}\r\n\r\n\r\nif (document.readyState != 'loading')\r\n    dn.document_ready();\r\nelse\r\n    document.addEventListener('DOMContentLoaded', dn.document_ready);\r\n\r\n\r\n"]}